cscope 15 $HOME/github/google/ngx_google -q 0000007887 0002827669
	@/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_filter_module.c

9 
	~"ngx_h‰p_googË_utž.h
"

10 
	~"ngx_h‰p_googË_šjeù.h
"

11 
	~"ngx_h‰p_googË_»que¡.h
"

12 
	~"ngx_h‰p_googË_»¥Ú£.h
"

13 
	~"ngx_h‰p_googË_fž‹r_moduË.h
"

16 
ngx_h‰p_googË_fž‹r
(
ngx_cÚf_t
 * 
cf
, 
ngx_commªd_t
 * 
cmd
, * 
cÚf
);

19 
ngx_h‰p_googË_fž‹r_Ïnguage
(
ngx_cÚf_t
 * 
cf
, 
ngx_commªd_t
 * 
cmd
, * 
cÚf
);

22 
ngx_h‰p_googË_fž‹r_ü—‹_maš_cÚf
(
ngx_cÚf_t
 * 
cf
);

25 
ngx_h‰p_googË_fž‹r_ü—‹_loc_cÚf
(
ngx_cÚf_t
* 
cf
);

28 
ngx_h‰p_googË_fž‹r_m”ge_loc_cÚf
(
ngx_cÚf_t
 * 
cf
, * 
·»Á
,

29 * 
chžd
);

31 
ngx_št_t


32 
ngx_h‰p_googË_fž‹r_´e_cÚfig
(
ngx_cÚf_t
 * 
cf
);

34 
ngx_št_t


35 
ngx_h‰p_googË_fž‹r_po¡_cÚfig
(
ngx_cÚf_t
 * 
cf
);

37 
ngx_št_t


38 
ngx_h‰p_googË_fž‹r_googË_v¬
(
ngx_h‰p_»que¡_t
 * 
r
,

39 
ngx_h‰p_v¬ŸbË_v®ue_t
 * 
v
,

40 
ušŒ_t
 
d©a
);

42 
ngx_št_t


43 
ngx_h‰p_googË_fž‹r_googË_ho¡_v¬
(
ngx_h‰p_»que¡_t
 * 
r
,

44 
ngx_h‰p_v¬ŸbË_v®ue_t
 * 
v
,

45 
ušŒ_t
 
d©a
);

47 
ngx_št_t


48 
ngx_h‰p_googË_fž‹r_googË_schema_v¬
(
ngx_h‰p_»que¡_t
 * 
r
,

49 
ngx_h‰p_v¬ŸbË_v®ue_t
 * 
v
,

50 
ušŒ_t
 
d©a
);

52 
ngx_št_t


53 
ngx_h‰p_googË_fž‹r_googË_schema_»v”£_v¬
(
ngx_h‰p_»que¡_t
 * 
r
,

54 
ngx_h‰p_v¬ŸbË_v®ue_t
 * 
v
,

55 
ušŒ_t
 
d©a
);

57 
ngx_commªd_t


58 
	gngx_h‰p_googË_fž‹r_commªds
[] = {

60 
ngx_¡ršg
("google"),

61 
NGX_HTTP_LOC_CONF
 | 
NGX_CONF_TAKE1
,

62 
ngx_h‰p_googË_fž‹r
,

63 
NGX_HTTP_LOC_CONF_OFFSET
,

64 
off£tof
(
ngx_h‰p_googË_loc_cÚf_t
, 
’abË
),

65 
NULL


68 
ngx_¡ršg
("google_scholar"),

69 
NGX_HTTP_LOC_CONF
 | 
NGX_CONF_TAKE1
,

70 
ngx_cÚf_£t_æag_¦Ù
,

71 
NGX_HTTP_LOC_CONF_OFFSET
,

72 
off£tof
(
ngx_h‰p_googË_loc_cÚf_t
, 
schÞ¬
),

73 
NULL


76 
ngx_¡ršg
("google_language"),

77 
NGX_HTTP_LOC_CONF
 | 
NGX_CONF_TAKE1
,

78 
ngx_h‰p_googË_fž‹r_Ïnguage
,

79 
NGX_HTTP_LOC_CONF_OFFSET
,

80 
off£tof
(
ngx_h‰p_googË_loc_cÚf_t
, 
Ïnguage
),

81 
NULL


84 
ngx_¡ršg
("google_ssl_off"),

85 
NGX_HTTP_LOC_CONF
 | 
NGX_CONF_1MORE
,

86 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

87 
NGX_HTTP_LOC_CONF_OFFSET
,

88 
off£tof
(
ngx_h‰p_googË_loc_cÚf_t
, 
s¦off
),

89 
NULL


92 
ngx_¡ršg
("google_robots_allow"),

93 
NGX_HTTP_LOC_CONF
 | 
NGX_CONF_TAKE1
,

94 
ngx_cÚf_£t_æag_¦Ù
,

95 
NGX_HTTP_LOC_CONF_OFFSET
,

96 
off£tof
(
ngx_h‰p_googË_loc_cÚf_t
, 
robÙs
),

97 
NULL


99 
ngx_nuÎ_commªd


102 
ngx_h‰p_moduË_t


103 
	gngx_h‰p_googË_fž‹r_moduË_ùx
 = {

104 
ngx_h‰p_googË_fž‹r_´e_cÚfig
,

105 
ngx_h‰p_googË_fž‹r_po¡_cÚfig
,

106 
ngx_h‰p_googË_fž‹r_ü—‹_maš_cÚf
,

107 
NULL
,

108 
NULL
,

109 
NULL
,

110 
ngx_h‰p_googË_fž‹r_ü—‹_loc_cÚf
,

111 
ngx_h‰p_googË_fž‹r_m”ge_loc_cÚf
,

114 
ngx_moduË_t


115 
	gngx_h‰p_googË_fž‹r_moduË
 = {

116 
NGX_MODULE_V1
,

117 &
ngx_h‰p_googË_fž‹r_moduË_ùx
,

118 
ngx_h‰p_googË_fž‹r_commªds
,

119 
NGX_HTTP_MODULE
,

120 
NULL
,

121 
NULL
,

122 
NULL
,

123 
NULL
,

124 
NULL
,

125 
NULL
,

126 
NULL
,

127 
NGX_MODULE_V1_PADDING


130 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_googË_v¬s
[] = {

131 { 
ngx_¡ršg
("google"),

132 
NULL
, 
ngx_h‰p_googË_fž‹r_googË_v¬
,

134 
NGX_HTTP_VAR_CHANGEABLE
 | 
NGX_HTTP_VAR_NOCACHEABLE
 | 
NGX_HTTP_VAR_NOHASH
,

136 { 
ngx_¡ršg
("google_host"),

137 
NULL
, 
ngx_h‰p_googË_fž‹r_googË_ho¡_v¬
,

139 
NGX_HTTP_VAR_CHANGEABLE
 | 
NGX_HTTP_VAR_NOCACHEABLE
 | 
NGX_HTTP_VAR_NOHASH
,

141 { 
ngx_¡ršg
("google_schema"),

142 
NULL
, 
ngx_h‰p_googË_fž‹r_googË_schema_v¬
,

144 
NGX_HTTP_VAR_CHANGEABLE
 | 
NGX_HTTP_VAR_NOCACHEABLE
 | 
NGX_HTTP_VAR_NOHASH
,

146 { 
ngx_¡ršg
("google_schema_reverse"),

147 
NULL
, 
ngx_h‰p_googË_fž‹r_googË_schema_»v”£_v¬
,

149 
NGX_HTTP_VAR_CHANGEABLE
 | 
NGX_HTTP_VAR_NOCACHEABLE
 | 
NGX_HTTP_VAR_NOHASH
,

151 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

154 
ngx_¡r_t
 
	gngx_h‰p_googË_Ïnguage
[] = {

155 
ngx_¡ršg
("ar"),

156 
ngx_¡ršg
("bg"),

157 
ngx_¡ršg
("ca"),

158 
ngx_¡ršg
("zh-CN"),

159 
ngx_¡ršg
("zh-TW"),

160 
ngx_¡ršg
("hr"),

161 
ngx_¡ršg
("cs"),

162 
ngx_¡ršg
("da"),

163 
ngx_¡ršg
("nl"),

164 
ngx_¡ršg
("en"),

165 
ngx_¡ršg
("tl"),

166 
ngx_¡ršg
("fi"),

167 
ngx_¡ršg
("fr"),

168 
ngx_¡ršg
("de"),

169 
ngx_¡ršg
("el"),

170 
ngx_¡ršg
("iw"),

171 
ngx_¡ršg
("hi"),

172 
ngx_¡ršg
("hu"),

173 
ngx_¡ršg
("id"),

174 
ngx_¡ršg
("it"),

175 
ngx_¡ršg
("ja"),

176 
ngx_¡ršg
("ko"),

177 
ngx_¡ršg
("lv"),

178 
ngx_¡ršg
("lt"),

179 
ngx_¡ršg
("no"),

180 
ngx_¡ršg
("fa"),

181 
ngx_¡ršg
("pl"),

182 
ngx_¡ršg
("pt-BR"),

183 
ngx_¡ršg
("pt-PT"),

184 
ngx_¡ršg
("ro"),

185 
ngx_¡ršg
("ru"),

186 
ngx_¡ršg
("sr"),

187 
ngx_¡ršg
("sk"),

188 
ngx_¡ršg
("sl"),

189 
ngx_¡ršg
("es"),

190 
ngx_¡ršg
("sv"),

191 
ngx_¡ršg
("th"),

192 
ngx_¡ršg
("tr"),

193 
ngx_¡ršg
("uk"),

194 
ngx_¡ršg
("vi"),

195 
ngx_nuÎ_¡ršg


199 
	$ngx_h‰p_googË_fž‹r
(
ngx_cÚf_t
 * 
cf
, 
ngx_commªd_t
 * 
cmd
, * 
cÚf
)

201 ià(
	`ngx_cÚf_£t_æag_¦Ù
(
cf
, 
cmd
, 
cÚf
)è 
NGX_CONF_ERROR
;

203 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
 = 
cÚf
;

204 ià(
glcf
->
’abË
 !ð1è 
NGX_CONF_OK
;

206 
ngx_h‰p_googË_maš_cÚf_t
 * 
gmcf
;

207 
gmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_googË_fž‹r_moduË
);

208 
gmcf
->
’abË
 = 1;

210 ià(
	`ngx_h‰p_googË_šjeù_subs
 (
cf
)è 
NGX_CONF_ERROR
;

211 ià(
	`ngx_h‰p_googË_šjeù_´oxy
(
cf
)è 
NGX_CONF_ERROR
;

213  
NGX_CONF_OK
;

214 
	}
}

217 
	$ngx_h‰p_googË_fž‹r_Ïnguage
(
ngx_cÚf_t
 * 
cf
, 
ngx_commªd_t
 * 
cmd
, * 
cÚf
)

219 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
 = 
cÚf
;

221 
ngx_¡r_t
 * 
v
 = (Ògx_¡r_ˆ*)
cf
->
¬gs
->
–ts
) + 1;

222 
ngx_¡r_t
 * 
def
 = 
ngx_h‰p_googË_Ïnguage
;

224 ; 
def
->
Ën
; def++) {

225 ià(
v
->
Ën
 !ð
def
->len) ;

226 ià(
	`ngx_¡ºcmp
(
v
->
d©a
, 
def
->d©a, def->
Ën
)) ;

227 
glcf
->
Ïnguage
 = *
v
;

230 ià(!
glcf
->
Ïnguage
.
Ën
)  "language‚ot support";

233  
NGX_CONF_OK
;

234 
	}
}

237 
	$ngx_h‰p_googË_fž‹r_ü—‹_maš_cÚf
(
ngx_cÚf_t
 * 
cf
)

239 
ngx_h‰p_googË_maš_cÚf_t
 *
cÚf
;

241 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_googË_maš_cÚf_t
));

242 ià(
cÚf
 =ð
NULL
)  NULL;

244  
cÚf
;

245 
	}
}

248 
	$ngx_h‰p_googË_fž‹r_ü—‹_loc_cÚf
(
ngx_cÚf_t
 * 
cf
)

250 
ngx_h‰p_googË_loc_cÚf_t
 *
cÚf
;

252 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_googË_loc_cÚf_t
));

253 ià(
cÚf
 =ð
NULL
)  NULL;

255 
cÚf
->
robÙs
 = 
NGX_CONF_UNSET
;

256 
cÚf
->
’abË
 = 
NGX_CONF_UNSET
;

257 
cÚf
->
schÞ¬
 = 
NGX_CONF_UNSET
;

258 
cÚf
->
s¦off
 = 
NGX_CONF_UNSET_PTR
;

260  
cÚf
;

261 
	}
}

264 
	$ngx_h‰p_googË_fž‹r_m”ge_loc_cÚf
(
ngx_cÚf_t
 * 
cf
, * 
·»Á
,

265 * 
chžd
)

267 
ngx_h‰p_googË_loc_cÚf_t
 * 
´ev
 = 
·»Á
;

268 
ngx_h‰p_googË_loc_cÚf_t
 * 
cÚf
 = 
chžd
;

270 
	`ngx_cÚf_m”ge_v®ue
 (
cÚf
->
robÙs
, 
´ev
->robÙs, 
NGX_CONF_UNSET
);

271 
	`ngx_cÚf_m”ge_v®ue
 (
cÚf
->
’abË
, 
´ev
->’abË, 
NGX_CONF_UNSET
);

272 
	`ngx_cÚf_m”ge_v®ue
 (
cÚf
->
schÞ¬
, 
´ev
->schÞ¬, 
NGX_CONF_UNSET
);

273 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
s¦off
, 
´ev
->s¦off, 
NGX_CONF_UNSET_PTR
);

274 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
Ïnguage
, 
´ev
->language, "zh-CN");

276  
NGX_CONF_OK
;

277 
	}
}

279 
ngx_št_t


280 
	$ngx_h‰p_googË_fž‹r_´e_cÚfig
(
ngx_cÚf_t
 * 
cf
)

282 
ngx_h‰p_v¬ŸbË_t
 * 
v¬
, * 
v
;

284 
v
 = 
ngx_h‰p_googË_v¬s
; v->
Çme
.
Ën
; v++)

286 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

287 ià(
v¬
 =ð
NULL
) {

288  
NGX_ERROR
;

291 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

292 
v¬
->
d©a
 = 
v
->data;

295  
NGX_OK
;

296 
	}
}

298 
ngx_št_t


299 
	$ngx_h‰p_googË_fž‹r_po¡_cÚfig
(
ngx_cÚf_t
 * 
cf
)

301 
ngx_h‰p_googË_maš_cÚf_t
 * 
gmcf
;

303 
gmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_googË_fž‹r_moduË
);

304 ià(!
gmcf
->
’abË
è 
NGX_OK
;

306 
ngx_h‰p_cÜe_maš_cÚf_t
 * 
cmcf
;

307 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

309 
ngx_h‰p_hªdËr_±
 * 
h
;

310 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_REWRITE_PHASE
].
hªdËrs
);

311 *
h
 = 
ngx_h‰p_googË_»que¡_hªdËr
;

314 
gmcf
->
Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

315 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_googË_»¥Ú£_h—d”_fž‹r
;

318 
gmcf
->
Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

319 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_googË_»¥Ú£_body_fž‹r
;

321  
NGX_OK
;

322 
	}
}

324 
ngx_št_t


325 
	$ngx_h‰p_googË_fž‹r_googË_v¬
(
ngx_h‰p_»que¡_t
 * 
r
,

326 
ngx_h‰p_v¬ŸbË_v®ue_t
 * 
v
, 
ušŒ_t
 
d©a
)

328 
ngx_h‰p_googË_ùx_t
 * 
ùx
;

329 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

331 ià(
ùx
 =ð
NULL
) {

332 
v
->
nÙ_found
 = 1;

333  
NGX_OK
;

336 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
;

337 
glcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

339 
ngx_št_t
 
s¦
 = 1;

341 ià(
glcf
->
s¦off
 !ð
NGX_CONF_UNSET_PTR
) {

343 
ngx_ušt_t
 
i
;

344 
ngx_¡r_t
 * 
hd
 = 
glcf
->
s¦off
->
–ts
, * 
domaš
;

346 
i
 = 0; i < 
glcf
->
s¦off
->
ÃÉs
; i++) {

347 
domaš
 = 
hd
 + 
i
;

348 ià(
ùx
->
·ss
->
Ën
 !ð
domaš
->len) ;

349 ià(
	`ngx_¡ºcmp
(
ùx
->
·ss
->
d©a
, 
domaš
->d©a, domaš->
Ën
)) ;

350 
s¦
 = 0; ;

354 #ià! (
NGX_HTTP_SSL
)

355 
s¦
 = 0;

358 
v
->
Ën
 = 7 + ()
ùx
->
·ss
->len;

359 ià(
s¦
è
v
->
Ën
++;

361 
v
->
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, v->
Ën
);

362 
	`ngx_¢´štf
(
v
->
d©a
, v->
Ën
, "%s%V", 
s¦
 ? "h‰ps://" : "h‰p://", 
ùx
->
·ss
);

364  
NGX_OK
;

365 
	}
}

367 
ngx_št_t


368 
	$ngx_h‰p_googË_fž‹r_googË_ho¡_v¬
(
ngx_h‰p_»que¡_t
 * 
r
,

369 
ngx_h‰p_v¬ŸbË_v®ue_t
 * 
v
,

370 
ušŒ_t
 
d©a
)

372 
ngx_h‰p_googË_ùx_t
 * 
ùx
;

373 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

375 ià(
ùx
 =ð
NULL
) {

376 
v
->
nÙ_found
 = 1;

377  
NGX_OK
;

380 
v
->
Ën
 = ()
ùx
->
ho¡
->len;

381 
v
->
d©a
 = 
ùx
->
ho¡
->data;

383  
NGX_OK
;

384 
	}
}

386 
ngx_št_t


387 
	$ngx_h‰p_googË_fž‹r_googË_schema_v¬
(
ngx_h‰p_»que¡_t
 * 
r
,

388 
ngx_h‰p_v¬ŸbË_v®ue_t
 * 
v
,

389 
ušŒ_t
 
d©a
)

391 
ngx_h‰p_googË_ùx_t
 * 
ùx
;

392 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

394 ià(
ùx
 =ð
NULL
) {

395 
v
->
nÙ_found
 = 1;

396  
NGX_OK
;

399 
v
->
Ën
 = 5;

400 
v
->
d©a
 = (
u_ch¬
 *)"https";

402 ià(!
ùx
->
s¦
è
v
->
Ën
--;

404  
NGX_OK
;

405 
	}
}

407 
ngx_št_t


408 
	$ngx_h‰p_googË_fž‹r_googË_schema_»v”£_v¬
(
ngx_h‰p_»que¡_t
 * 
r
,

409 
ngx_h‰p_v¬ŸbË_v®ue_t
 * 
v
,

410 
ušŒ_t
 
d©a
)

412 
ngx_h‰p_googË_ùx_t
 * 
ùx
;

413 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

415 ià(
ùx
 =ð
NULL
) {

416 
v
->
nÙ_found
 = 1;

417  
NGX_OK
;

420 
v
->
Ën
 = 5;

421 
v
->
d©a
 = (
u_ch¬
 *)"https";

423 ià(
ùx
->
s¦
è
v
->
Ën
--;

425  
NGX_OK
;

426 
	}
}

	@/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_inject.c

9 
	~"ngx_h‰p_googË_šjeù.h
"

11 
ngx_moduË_t
 
ngx_h‰p_´oxy_moduË
;

12 
ngx_moduË_t
 
ngx_h‰p_subs_fž‹r_moduË
;

15 
	$ngx_h‰p_googË_šjût_¬gs
(
ngx_cÚf_t
 * 
cf
,

16 
ngx_¬¿y_t
 ** 
¬gs
,

17 cÚ¡ * 
v
)

19 
ngx_¡r_t
 * 
p
;

20 ià(!*
¬gs
è*¬g ð
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 8, (
ngx_¡r_t
));

21 ià(!*
¬gs
è 
NGX_CONF_ERROR
;

23 
p
 = 
	`ngx_¬¿y_push
(*
¬gs
);

24 ià(!
p
è 
NGX_CONF_ERROR
;

26 
p
->
d©a
 = (
u_ch¬
 *)
v
;

27 
p
->
Ën
 = 
	`¡¾’
(
v
);

29  
NGX_CONF_OK
;

30 
	}
}

33 
	$ngx_h‰p_googË_šjeù
(
ngx_cÚf_t
 * 
cf
,

34 
ngx_moduË_t
 * 
md
,

35 * 
lcf
,

36 cÚ¡ * 
k
,

37 cÚ¡ 
n
,

38 
va_li¡
 
­
)

40 
ngx_¬¿y_t
 * 
sw­
 = 
cf
->
¬gs
;

41 
cf
->
¬gs
 = 
NULL
;

44 ià(
	`ngx_h‰p_googË_šjût_¬gs
(
cf
, &cf->
¬gs
, 
k
)) {

45 
cf
->
¬gs
 = 
sw­
;

46  
NGX_CONF_ERROR
;

49 
i
;

50 cÚ¡ * 
¬g
;

51 
i
 = 0; i < 
n
; i++) {

52 
¬g
 = 
	`va_¬g
(
­
, const *);

53 ià(
	`ngx_h‰p_googË_šjût_¬gs
(
cf
, &cf->
¬gs
, 
¬g
)) {

54 
cf
->
¬gs
 = 
sw­
;

55  
NGX_CONF_ERROR
;

59 
ngx_commªd_t
 * 
cmd
;

60 
cmd
 = 
md
->
commªds
; cmd->
Çme
.
Ën
; cmd++) {

61 ià(!
cmd
->
Çme
.
Ën
) ;

62 ià(
	`ngx_¡rÿ£cmp
(
cmd
->
Çme
.
d©a
, (
u_ch¬
 *)
k
)) ;

63 
cmd
->
	`£t
(
cf
, cmd, 
lcf
);

66 
cf
->
¬gs
 = 
sw­
;

68  
NGX_CONF_OK
;

69 
	}
}

72 
	$ngx_h‰p_googË_šjeù_subs_¬gs
(
ngx_cÚf_t
 * 
cf
,

73 cÚ¡ * 
cmd
,

74 cÚ¡ 
n
,

77 
va_li¡
 
­
;

78 
	`va_¡¬t
(
­
, 
n
);

80 * 
¦cf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_subs_fž‹r_moduË
);

81 * 
rc
;

82 
rc
 = 
	`ngx_h‰p_googË_šjeù
(
cf
, &
ngx_h‰p_subs_fž‹r_moduË
, 
¦cf
, 
cmd
, 
n
, 
­
);

84 
	`va_’d
(
­
);

85  
rc
;

86 
	}
}

89 
	$ngx_h‰p_googË_šjeù_subs_domaš
(
ngx_cÚf_t
 * 
cf
)

91 ià(
	`ngx_h‰p_googË_šjeù_subs_¬gs
(
cf
,

95  
NGX_CONF_ERROR
;

97  
NGX_CONF_OK
;

98 
	}
}

101 
	$ngx_h‰p_googË_šjeù_´oxy_¬gs
(
ngx_cÚf_t
 * 
cf
,

102 cÚ¡ * 
cmd
,

103 cÚ¡ 
n
,

106 
va_li¡
 
­
;

107 
	`va_¡¬t
(
­
, 
n
);

109 * 
¶cf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_´oxy_moduË
);

110 * 
rc
;

111 
rc
 = 
	`ngx_h‰p_googË_šjeù
(
cf
, &
ngx_h‰p_´oxy_moduË
, 
¶cf
, 
cmd
, 
n
, 
­
);

113 
	`va_’d
(
­
);

114  
rc
;

115 
	}
}

118 
	$ngx_h‰p_googË_šjeù_subs
(
ngx_cÚf_t
 * 
cf
)

122 ià(
	`ngx_h‰p_googË_šjeù_subs_¬gs
(
cf
,

127 ià(
	`ngx_h‰p_googË_šjeù_subs_¬gs
(
cf
,

134 ià(
	`ngx_h‰p_googË_šjeù_subs_¬gs
(
cf
,

141 ià(
	`ngx_h‰p_googË_šjeù_subs_¬gs
(
cf
,

148 ià(
	`ngx_h‰p_googË_šjeù_subs_¬gs
(
cf
,

155 ià(
	`ngx_h‰p_googË_šjeù_subs_¬gs
(
cf
,

162 ià(
	`ngx_h‰p_googË_šjeù_subs_domaš
(
cf
)) ;

164  
NGX_CONF_OK
;

166  
NGX_CONF_ERROR
;

168 
	}
}

171 
	$ngx_h‰p_googË_šjeù_´oxy
(
ngx_cÚf_t
 * 
cf
)

175 ià(
	`ngx_h‰p_googË_šjeù_´oxy_¬gs
(
cf
,

181 ià(
	`ngx_h‰p_googË_šjeù_´oxy_¬gs
(
cf
,

186 ià(
	`ngx_h‰p_googË_šjeù_´oxy_¬gs
(
cf
,

191 ià(
	`ngx_h‰p_googË_šjeù_´oxy_¬gs
(
cf
,

197 ià(
	`ngx_h‰p_googË_šjeù_´oxy_¬gs
(
cf
,

203 ià(
	`ngx_h‰p_googË_šjeù_´oxy_¬gs
(
cf
,

209  
NGX_CONF_OK
;

211  
NGX_CONF_ERROR
;

212 
	}
}

	@/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_request.c

9 
	~"ngx_h‰p_googË_utž.h
"

10 
	~"ngx_h‰p_googË_»que¡.h
"

12 
ngx_h‰p_googË_ùx_t
 *

13 
	$ngx_h‰p_googË_ü—‹_ùx
(
ngx_h‰p_»que¡_t
 * 
r
)

15 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
;

16 
glcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

18 
ngx_h‰p_googË_ùx_t
 * 
ùx
;

19 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_googË_ùx_t
));

21 ià(!
ùx
è 
NULL
;

22 
ùx
->
ho¡
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_¡r_t
));

23 ià(!
ùx
->
ho¡
è 
NULL
;

24 
ùx
->
cÚf
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_¡r_t
));

25 ià(!
ùx
->
cÚf
è 
NULL
;

26 
ùx
->
·ss
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_¡r_t
));

27 ià(!
ùx
->
·ss
è 
NULL
;

28 
ùx
->
¬g
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_¡r_t
));

29 ià(!
ùx
->
¬g
è 
NULL
;

30 
ùx
->
domaš
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_¡r_t
));

31 ià(!
ùx
->
domaš
è 
NULL
;

34 
	`ngx_¡r_£t
(
ùx
->
cÚf
, "PREF");

36 
ùx
->
uri
 = &
r
->
uÅ¬£d_uri
;

37 
ùx
->
ho¡
 = &
r
->
h—d”s_š
.ho¡->
v®ue
;

38 
ùx
->
Ïng
 = &
glcf
->
Ïnguage
;

39 
ùx
->
ty³
 = 
ngx_h‰p_googË_ty³_maš
;

41 
ngx_¡r_t
 
domaš
 = *
ùx
->
ho¡
;

43 
u_ch¬
 * 
Ï¡
 = 
domaš
.
d©a
 + domaš.
Ën
, * 
fšd
;

44 ià((
fšd
 = 
	`ngx_¡¾chr
(
domaš
.
d©a
, 
Ï¡
, ':'))) {

45 
domaš
.
Ën
 = 
fšd
 - domaš.
d©a
;

48 
ùx
->
domaš
->
Ën
 = domain.len + 1;

49 
ùx
->
domaš
->
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, ctx->domaš->
Ën
);

50 ià(!
ùx
->
domaš
->
d©a
è 
NULL
;

52 
	`ngx_¢´štf
(
ùx
->
domaš
->
d©a
, ctx->domaš->
Ën
, ".%V", &domain);

54 ià(
	`ngx_š‘_addr
(
domaš
.
d©a
, domaš.
Ën
è!ð
INADDR_NONE
) {

55 
ùx
->
domaš
->
d©a
++;

56 
ùx
->
domaš
->
Ën
 --;

60 ià(!
ùx
->
Ïng
->
Ën
) {

61 
	`ngx_¡r_£t
(
ùx
->
Ïng
, "zh-CN");

64 
ùx
->
robÙs
 = (ùx->
uri
->
Ën
 == 11 &&

65 !
	`ngx_¡ºcmp
(
ùx
->
uri
->
d©a
, "/robots.txt", 11));

67 #ià(
NGX_HTTP_SSL
)

68 
ngx_h‰p_s¦_¤v_cÚf_t
 * 
sscf
;

69 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_s¦_moduË
);

70 ià(
sscf
->
’abË
 || 
r
->
h‰p_cÚÃùiÚ
->
addr_cÚf
->
s¦
è
ùx
->ssl = 1;

73  
ùx
;

74 
	}
}

76 
ngx_št_t


77 
	$ngx_h‰p_googË_»que¡_·r£_cook›_gz
(
ngx_h‰p_»que¡_t
 * 
r
,

78 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

80 
ngx_ušt_t
 
i
;

81 
ngx_keyv®_t
 * 
kv
, * 
hd
 = 
ùx
->
cook›s
->
–ts
;

83 
i
 = 0; i < 
ùx
->
cook›s
->
ÃÉs
; i++) {

84 
kv
 = 
hd
 + 
i
;

85 ià(
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, (
u_ch¬
 *)"GZ", 2)) ;

86 
	`ngx_¡r_£t
(&
kv
->
v®ue
, "Z=0");

90  
NGX_OK
;

91 
	}
}

93 
ngx_št_t


94 
	$ngx_h‰p_googË_»que¡_·r£_cook›_cÚf
(
ngx_h‰p_»que¡_t
 * 
r
,

95 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

97 
ngx_ušt_t
 
i
;

98 
ngx_keyv®_t
 * 
kv
, * 
hd
 = 
ùx
->
cook›s
->
–ts
;

100 
i
 = 0; i < 
ùx
->
cook›s
->
ÃÉs
; i++)

102 
kv
 = 
hd
 + 
i
;

103 ià(
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, 
ùx
->
cÚf
->d©a, ctx->cÚf->
Ën
)) ;

105 
u_ch¬
 * 
Ï¡
 = 
kv
->
v®ue
.
d©a
 + kv->v®ue.
Ën
;

106 ià(
	`ngx_¡¾ÿ£¡º
(
kv
->
v®ue
.
d©a
, 
Ï¡
, (
u_ch¬
 *)"CR=", 2)è
ùx
->
nü
 = 1;

110  
NGX_OK
;

111 
	}
}

113 
ngx_št_t


114 
	$ngx_h‰p_googË_»que¡_·r£_»dœeù
(
ngx_h‰p_»que¡_t
 * 
r
,

115 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

117 
ùx
->
uri
->
d©a
 += 2;

118 
ùx
->
uri
->
Ën
 -= 2;

120 
u_ch¬
 * 
Ï¡
 = 
ùx
->
uri
->
d©a
 + ctx->uri->
Ën
;

121 
u_ch¬
 * 
¦ash
 = 
	`ngx_¡¾chr
(
ùx
->
uri
->
d©a
, 
Ï¡
, '/');

123 
ùx
->
·ss
->
d©a
 = ctx->
uri
->data;

124 
ùx
->
·ss
->
Ën
 = ctx->
uri
->len;

126 ià(
¦ash
) {

127 
ùx
->
uri
->
d©a
 = 
¦ash
;

128 
ùx
->
uri
->
Ën
 = 
Ï¡
 - 
¦ash
;

129 
ùx
->
·ss
->
Ën
 = 
¦ash
 - ctx->·ss->
d©a
;

132  
NGX_OK
;

133 
	}
}

135 
ngx_št_t


136 
	$ngx_h‰p_googË_»que¡_·r£_schÞ¬
(
ngx_h‰p_»que¡_t
 * 
r
,

137 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

139 ià(
	`ngx_h‰p_googË_»que¡_·r£_cook›_cÚf
(
r
, 
ùx
)è 
NGX_ERROR
;

141 ià(
ùx
->
uri
->
Ën
 =ð12 && ctx->
¬gs
 && ctx->¬gs->
ÃÉs
) {

143 
u_ch¬
 * 
»ãr
 = 
ùx
->
uri
->
d©a
 + 9;

145 ià(!
	`ngx_¡ºcmp
(
»ãr
, "bib", 3) ||

146 !
	`ngx_¡ºcmp
(
»ãr
, "enw", 3) ||

147 !
	`ngx_¡ºcmp
(
»ãr
, "ris", 3) ||

148 !
	`ngx_¡ºcmp
(
»ãr
, "rfw", 3))

150 
ngx_ušt_t
 
i
;

151 
ngx_keyv®_t
 * 
kv
, * 
hd
 = 
ùx
->
¬gs
->
–ts
;

153 
i
 = 0; i < 
ùx
->
¬gs
->
ÃÉs
; i++)

155 
kv
 = 
hd
 + 
i
;

156 ià(!
kv
->
key
.
Ën
 || *kv->key.
d©a
 != 'q') ;

158 
u_ch¬
 * 
Ï¡
 = 
kv
->
v®ue
.
d©a
 + kv->v®ue.
Ën
;

159 
u_ch¬
 * 
fšd
 = 
	`ngx_¡¾ÿ£¡º
(
kv
->
v®ue
.
d©a
, 
Ï¡
,

160 
ùx
->
ho¡
->
d©a
, ctx->ho¡->
Ën
 - 1);

162 ià(!
fšd
) ;

163 
kv
->
v®ue
.
Ën
 = 
fšd
 - kv->v®ue.
d©a
;

165 
ngx_¡r_t
 
nv®
;

166 
nv®
.
Ën
 = 
kv
->
v®ue
.len + ("scholar.google.com");

167 
nv®
.
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
,‚v®.
Ën
);

169 ià(!
nv®
.
d©a
è 
NGX_ERROR
;

170 
	`ngx_¢´štf
(
nv®
.
d©a
,‚v®.
Ën
, "%VschÞ¬.googË.com/", &
kv
->
v®ue
);

171 
kv
->
v®ue
 = 
nv®
;

178 ià(!
	`ngx_¡ºÿ£cmp
(
ùx
->
uri
->
d©a
, (
u_ch¬
 *)"/schhp", 6) ||

179 !
ùx
->
¬gs
->
ÃÉs
)

181 
	`ngx_¡r_£t
(
ùx
->
uri
, "/");

184 ià(!
	`ngx_¡ºÿ£cmp
(
ùx
->
uri
->
d©a
, (
u_ch¬
 *)"/scholar", 8))

186 
ngx_¡r_t
 
uri
 = *
ùx
->uri;

189 
uri
.
d©a
 += 8;

190 
uri
.
Ën
 -= 8;

192 
ngx_ušt_t
 
i
, 
¡r
 = 1;

193 
ngx_keyv®_t
 * 
kv
, * 
hd
 = 
ùx
->
¬gs
->
–ts
;

196 
i
 = 0; i < 
ùx
->
¬gs
->
ÃÉs
; i++)

198 
kv
 = 
hd
 + 
i
;

199 ià(!
kv
->
key
.
Ën
) ;

200 ià(
kv
->
key
.
Ën
 =ð1 && *kv->key.
d©a
 == 'q')

202 
¡r
 = 0; ;

204 ià(
kv
->
key
.
Ën
 =ð5 && !
	`ngx_¡ºÿ£cmp
(kv->key.
d©a
,

205 (
u_ch¬
 *)"cites", 5))

207 
¡r
 = 0; ;

209 ià(
kv
->
key
.
Ën
 =ð7 && !
	`ngx_¡ºÿ£cmp
(kv->key.
d©a
,

210 (
u_ch¬
 *)"cluster", 7))

212 
¡r
 = 0; ;

217 ià(
uri
.
Ën
è*uri.
d©a
) {

219 : 
¡r
 = 0; ;

222 ià(
¡r
è*
ùx
->
uri
 = uri;

226 ià(!
ùx
->
nü
 && ctx->
uri
->
Ën
 == 1) {

227 
	`ngx_¡r_£t
(
ùx
->
uri
, "/ncr");

230 
	`ngx_¡r_£t
(
ùx
->
·ss
, "scholar.google.com");

232  
NGX_OK
;

233 
	}
}

235 
ngx_št_t


236 
	$ngx_h‰p_googË_»que¡_·r£_v”ify
(
ngx_h‰p_»que¡_t
 * 
r
,

237 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

239 
ùx
->
·ss
->
Ën
 = ("ipvX.google.com") - 1;

240 
ùx
->
·ss
->
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, ctx->·ss->
Ën
);

242 
	`ngx_¢´štf
(
ùx
->
·ss
->
d©a
, ctx->·ss->
Ën
,

243 "v%c.googË.com", 
ùx
->
uri
->
d©a
[4]);

245 
ùx
->
uri
->
d©a
 += 5;

246 
ùx
->
uri
->
Ën
 -= 5;

248  
NGX_OK
;

249 
	}
}

251 
ngx_št_t


252 
	$ngx_h‰p_googË_»que¡_·r£_maš
(
ngx_h‰p_»que¡_t
 * 
r
,

253 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

255 
	`ngx_¡r_£t
(
ùx
->
·ss
, "www.google.com");

257 ià(
	`ngx_h‰p_googË_»que¡_·r£_cook›_gz
 (
r
, 
ùx
)è 
NGX_ERROR
;

258 ià(
ùx
->
robÙs
è 
NGX_OK
;

259 ià(
	`ngx_h‰p_googË_»que¡_·r£_cook›_cÚf
(
r
, 
ùx
)è 
NGX_ERROR
;

261 ià(
ùx
->
nü
è 
NGX_OK
;

263 ià((
ùx
->
uri
->
Ën
 =ð1 && *ùx->uri->
d©a
 == '/') ||

264 (
ùx
->
uri
->
Ën
 == 6 &&

265 !
	`ngx_¡ºÿ£cmp
(
ùx
->
uri
->
d©a
, (
u_ch¬
 *)"/webhp", 6)))

267 
	`ngx_¡r_£t
(
ùx
->
uri
, "/ncr");

270  
NGX_OK
;

271 
	}
}

273 
ngx_št_t


274 
	$ngx_h‰p_googË_»que¡_·r£_ho¡
(
ngx_h‰p_»que¡_t
 * 
r
,

275 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

277 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
;

278 
glcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

281 ià(
ùx
->
uri
->
Ën
 > 2 && !
	`ngx_¡ºcmp
(ùx->uri->
d©a
, "/!", 2))

283 
ùx
->
ty³
 = 
ngx_h‰p_googË_ty³_»dœeù
;

284 ià(
	`ngx_h‰p_googË_»que¡_·r£_»dœeù
(
r
, 
ùx
)è 
NGX_ERROR
;

288 ià(
glcf
->
schÞ¬
 == 1 &&

289 
ùx
->
uri
->
Ën
 > 7 &&

290 (!
	`ngx_¡ºÿ£cmp
(
ùx
->
uri
->
d©a
, (
u_ch¬
 *)"/scholar", 8) ||

291 !
	`ngx_¡ºÿ£cmp
(
ùx
->
uri
->
d©a
, (
u_ch¬
 *)"/schhp", 6)))

293 
ùx
->
ty³
 = 
ngx_h‰p_googË_ty³_schÞ¬
;

295 
	`ngx_¡r_£t
(
ùx
->
cÚf
, "GSP");

296 ià(
	`ngx_h‰p_googË_»que¡_·r£_schÞ¬
(
r
, 
ùx
)è 
NGX_ERROR
;

300 ià(
ùx
->
uri
->
Ën
 > 4 &&

301 (!
	`ngx_¡ºÿ£cmp
(
ùx
->
uri
->
d©a
, (
u_ch¬
 *)"/ipv4", 5) ||

302 !
	`ngx_¡ºÿ£cmp
(
ùx
->
uri
->
d©a
, (
u_ch¬
 *)"/ipv6", 5)))

304 
ùx
->
ty³
 = 
ngx_h‰p_googË_ty³_v”ify
;

305 ià(
	`ngx_h‰p_googË_»que¡_·r£_v”ify
(
r
, 
ùx
)è 
NGX_ERROR
;

309 ià(
ùx
->
ty³
 =ð
ngx_h‰p_googË_ty³_maš
)

311 ià(
	`ngx_h‰p_googË_»que¡_·r£_maš
(
r
, 
ùx
)è 
NGX_ERROR
;

314  
NGX_OK
;

315 
	}
}

317 
ngx_št_t


318 
	$ngx_h‰p_googË_»que¡_·r£r
(
ngx_h‰p_»que¡_t
 * 
r
,

319 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

322 
u_ch¬
 * 
Ï¡
 = 
r
->
uÅ¬£d_uri
.
d©a
 +„->uÅ¬£d_uri.
Ën
;

323 
ùx
->
¬g
->
d©a
 = 
	`ngx_¡¾chr
(ùx->
uri
->d©a, 
Ï¡
, '?');

326 ià(
ùx
->
¬g
->
d©a
) {

327 
ùx
->
¬g
->
Ën
 = 
Ï¡
 - ++ùx->¬g->
d©a
;

328 
ùx
->
uri
->
Ën
 -ðùx->
¬g
->len + 1;

332 ià(
ùx
->
¬g
->
Ën
) {

333 
ùx
->
¬gs
 = 
	`ngx_h‰p_googË_ex¶ode_kv
(
r
, ctx->
¬g
, "&");

335 
ùx
->
¬gs
 = 
	`ngx_¬¿y_ü—‹
(
r
->
poÞ
, 4, (
ngx_keyv®_t
));

337 ià(!
ùx
->
¬gs
è 
NGX_ERROR
;

340 ià(
r
->
h—d”s_š
.
cook›s
.
ÃÉs
) {

341 
ngx_bË_–t_t
 ** 
ck
 = 
r
->
h—d”s_š
.
cook›s
.
–ts
;

342 
ùx
->
cook›s
 = 
	`ngx_h‰p_googË_ex¶ode_kv
(
r
, &(*
ck
)->
v®ue
, ";");

344 
ùx
->
cook›s
 = 
	`ngx_¬¿y_ü—‹
(
r
->
poÞ
, 4, (
ngx_keyv®_t
));

346 ià(!
ùx
->
cook›s
è 
NGX_ERROR
;

349 ià(
	`ngx_h‰p_googË_»que¡_·r£_ho¡
(
r
, 
ùx
)è 
NGX_ERROR
;

352 
ngx_ušt_t
 
i
, 
aþ
 = 0;

353 
ngx_li¡_·¹_t
 * 
±
 = &
r
->
h—d”s_š
.
h—d”s
.
·¹
;

354 
ngx_bË_–t_t
 * 
hd
 = 
±
->
–ts
, * 
tb
;

356 
i
 = 0; ; i++)

358 ià(
i
 >ð
±
->
ÃÉs
) {

360 ià(
±
->
Ãxt
 =ð
NULL
) ;

362 
±
 =…t->
Ãxt
;

363 
hd
 = 
±
->
–ts
;

364 
i
 = 0;

367 
tb
 = 
hd
 + 
i
;

368 ià(!
	`ngx_¡ºÿ£cmp
(
tb
->
key
.
d©a
, (
u_ch¬
 *)"Accept-Language", 15)) {

369 
aþ
 = 1; 
tb
->
v®ue
 = *
ùx
->
Ïng
;

373 ià(!
aþ
) {

374 
tb
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_š
.
h—d”s
);

375 ià(!
tb
è 
NGX_ERROR
;

377 
	`ngx_¡r_£t
(&
tb
->
key
, "Accept-Language");

378 
tb
->
v®ue
 = *
ùx
->
Ïng
;

379 
tb
->
hash
 = 
	`ngx_hash_key_lc
Ñb->
key
.
d©a
,b->key.
Ën
);

382  
NGX_OK
;

383 
	}
}

385 
ngx_št_t


386 
	$ngx_h‰p_googË_»que¡_g’”©”
(
ngx_h‰p_»que¡_t
 * 
r
,

387 
ngx_h‰p_googË_ùx_t
 * 
ùx
)

389 
ngx_ušt_t
 
i
;

390 
ngx_bË_–t_t
 * 
tb
;

391 
ngx_bË_–t_t
 ** 
±r
;

393 
ngx_¡r_t
 * 
cook›
 = 
	`ngx_h‰p_googË_im¶ode_kv
(
r
, 
ùx
->
cook›s
, "; ");

394 ià(!
cook›
è 
NGX_ERROR
;

396 ià(!
r
->
h—d”s_š
.
cook›s
.
ÃÉs
)

398 
tb
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_š
.
h—d”s
);

399 ià(!
tb
è 
NGX_ERROR
;

401 
	`ngx_¡r_£t
(&
tb
->
key
, "Cookie");

402 
tb
->
v®ue
 = *
cook›
;

403 
tb
->
hash
 = 
	`ngx_hash_key_lc
Ñb->
key
.
d©a
,b->key.
Ën
);

407 
±r
 = 
r
->
h—d”s_š
.
cook›s
.
–ts
;

408 
i
 = 0; i < 
r
->
h—d”s_š
.
cook›s
.
ÃÉs
; i++) {

409 
±r
[
i
]->
v®ue
 = *
cook›
;

414 
ngx_¡r_t
 * 
¬g
 = 
	`ngx_h‰p_googË_im¶ode_kv
(
r
, 
ùx
->
¬gs
, "&");

415 ià(!
¬g
è 
NGX_ERROR
;

416 
ùx
->
¬g
 =‡rg;

418 ià(!
ùx
->
¬g
->
Ën
)

420 
r
->
uÅ¬£d_uri
 = *
ùx
->
uri
;

424 
ngx_¡r_t
 
uri
;

425 
uri
.
Ën
 = 
ùx
->uri->ËÀ+ 1 + ctx->
¬g
->len;

426 
uri
.
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, uri.
Ën
);

428 ià(!
uri
.
d©a
è 
NGX_ERROR
;

429 
	`ngx_¢´štf
(
uri
.
d©a
, uri.
Ën
, "%V?%V", 
ùx
->uri, ctx->
¬g
);

431 
r
->
uÅ¬£d_uri
 = 
uri
;

434  
NGX_OK
;

435 
	}
}

437 
ngx_št_t


438 
	$ngx_h‰p_googË_»que¡_hªdËr
(
ngx_h‰p_»que¡_t
 * 
r
)

440 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
;

441 
glcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

442 ià(
glcf
->
’abË
 !ð1è 
NGX_DECLINED
;

444 
ngx_h‰p_googË_ùx_t
 * 
ùx
;

445 
ùx
 = 
	`ngx_h‰p_googË_ü—‹_ùx
(
r
);

447 ià(!
ùx
è 
NGX_ERROR
;

448 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_googË_fž‹r_moduË
);

450 ià(
	`ngx_h‰p_googË_»que¡_·r£r
 (
r
, 
ùx
)è 
NGX_ERROR
;

451 ià(
	`ngx_h‰p_googË_»que¡_g’”©”
(
r
, 
ùx
)è 
NGX_ERROR
;

453  
NGX_DECLINED
;

454 
	}
}

	@/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_response.c

9 
	~"ngx_h‰p_googË_utž.h
"

10 
	~"ngx_h‰p_googË_»¥Ú£.h
"

12 
ngx_št_t


13 
	$ngx_h‰p_googË_»¥Ú£_h—d”_loÿtiÚ
(
ngx_h‰p_»que¡_t
 * 
r
,

14 
ngx_h‰p_googË_ùx_t
 * 
ùx
,

15 
ngx_¡r_t
 * 
v
)

17 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
;

18 
glcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

20 
u_ch¬
 * 
Ï¡
 = 
v
->
d©a
 + v->
Ën
;

21 
ngx_ušt_t
 
add
 = 0;

23 ià(!
	`ngx_¡ºÿ£cmp
(
v
->
d©a
, (
u_ch¬
 *)"http://", 7)) {

24 
add
 = 7;

25 } ià(!
	`ngx_¡ºÿ£cmp
(
v
->
d©a
, (
u_ch¬
 *)"https://", 8)) {

26 
add
 = 8;

28  
NGX_OK
;

31 
ngx_¡r_t
 
ho¡
;

32 
ho¡
.
d©a
 = 
v
->d©¨+ 
add
;

33 
ho¡
.
Ën
 = 
Ï¡
 - ho¡.
d©a
;

35 
ngx_¡r_t
 
uri
;

36 
uri
.
d©a
 = 
	`ngx_¡¾chr
(
ho¡
.d©a, 
Ï¡
, '/');

37 ià(
uri
.
d©a
) {

38 
uri
 .
Ën
 = 
Ï¡
 - uri.
d©a
;

39 
ho¡
.
Ën
 = 
uri
.
d©a
 - host.data;

41 
uri
.
Ën
 = 0;

44 ià(!
	`ngx_¡¾ÿ£¡º
(
ho¡
.
d©a
, ho¡.d©¨+ ho¡.
Ën
,

45 (
u_ch¬
 *)"google", 6 - 1))

49  
NGX_OK
;

52 ià(!
	`ngx_¡ºÿ£cmp
(
ho¡
.
d©a
, (
u_ch¬
 *)"ipv", 3)) {

53 
ngx_¡r_t
 
nuri
;

54 
nuri
.
Ën
 = 
uri
.len + 5;

55 
nuri
.
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
,‚uri.
Ën
);

56 ià(!
nuri
.
d©a
è 
NGX_ERROR
;

57 
	`ngx_¢´štf
(
nuri
.
d©a
,‚uri.
Ën
, "/v%c%V", 
ho¡
.d©a[3], &
uri
);

58 
uri
 = 
nuri
;

59 } ià(
glcf
->
schÞ¬
 == 1 &&

60 !
	`ngx_¡ºÿ£cmp
(
ho¡
.
d©a
, (
u_ch¬
 *)"scholar", 7))

62 ià(
uri
.
Ën
 &&

63 
	`ngx_¡ºÿ£cmp
(
uri
.
d©a
, (
u_ch¬
 *)"/scholar", 8))

65 
ngx_¡r_t
 
nuri
;

66 
nuri
.
Ën
 = 
uri
.len + 8;

67 
nuri
.
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
,‚uri.
Ën
);

68 ià(!
nuri
.
d©a
è 
NGX_ERROR
;

69 
	`ngx_¢´štf
(
nuri
.
d©a
,‚uri.
Ën
, "/schÞ¬%V", &
uri
);

70 
uri
 = 
nuri
;

74 
ngx_¡r_t
 
nv
;

75 
nv
.
Ën
 = (
ùx
->
s¦
 ? 8 : 7è+ ctx->
ho¡
->ËÀ+ 
uri
.len;

76 
nv
.
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
,‚v.
Ën
);

78 ià(!
nv
.
d©a
è 
NGX_ERROR
;

80 
	`ngx_¢´štf
(
nv
.
d©a
,‚v.
Ën
, "%s%V%V",

81 
ùx
->
s¦
 ? "https://" : "http://",

82 
ùx
->
ho¡
, &
uri
);

83 *
v
 = 
nv
;

85  
NGX_OK
;

86 
	}
}

89 
ngx_št_t


90 
	$ngx_h‰p_googË_»¥Ú£_h—d”_£t_cook›_exem±
(
ngx_h‰p_»que¡_t
 * 
r
,

91 
ngx_h‰p_googË_ùx_t
 * 
ùx
,

92 
ngx_¬¿y_t
 * 
kvs
)

94 
ngx_uid_t
 
i
;

95 
ngx_keyv®_t
 * 
kv
, * 
hd
 = 
kvs
->
–ts
;

97 
i
 = 0; i < 
kvs
->
ÃÉs
; i++) {

98 
kv
 = 
hd
 + 
i
;

100 ià(!
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, (
u_ch¬
 *)"GOOGLE_ABUSE_EXEMPTION", 22)) {

101 ià(!
kv
->
v®ue
.
Ën
) {

102 
kvs
->
ÃÉs
 = 0;

103  
NGX_OK
;

107 ià(!
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, (
u_ch¬
 *)"expires", 7)) {

108 
	`ngx_¡r_£t
(&
kv
->
v®ue
, "Fri, 01-Jan-2016 00:00:00 GMT");

112  
NGX_OK
;

113 
	}
}

115 
ngx_št_t


116 
	$ngx_h‰p_googË_»¥Ú£_h—d”_sÜt_cook›_cÚf
(cÚ¡ * 
a
, cÚ¡ * 
b
)

118 cÚ¡ 
ngx_keyv®_t
 * 
kva
 = 
a
, * 
kvb
 = 
b
;

119 ià(
kva
->
key
.
Ën
 < 
kvb
->key.len)  1;

120 ià(
kva
->
key
.
Ën
 > 
kvb
->key.len)  -1;

122 
	}
}

124 
ngx_št_t


125 
	$ngx_h‰p_googË_»¥Ú£_h—d”_£t_cook›_cÚf
(
ngx_h‰p_»que¡_t
 * 
r
,

126 
ngx_h‰p_googË_ùx_t
 * 
ùx
,

127 
ngx_¡r_t
 * 
v
)

129 ià(
ùx
->
ty³
 !ð
ngx_h‰p_googË_ty³_maš
 &&

130 
ùx
->
ty³
 !ð
ngx_h‰p_googË_ty³_schÞ¬
è 
NGX_OK
;

131 ià(
ùx
->
nü
è 
NGX_OK
;

133 
ngx_ušt_t
 
i
;

134 
ngx_¬¿y_t
 * 
kvs
 = 
	`ngx_h‰p_googË_ex¶ode_kv
(
r
, 
v
, ":");

135 ià(!
kvs
è 
NGX_ERROR
;

137 
ngx_št_t
 
nw
 = 0;

138 
ngx_keyv®_t
 * 
kv
, * 
hd
;

140 
hd
 = 
kvs
->
–ts
;

141 
i
 = 0; i < 
kvs
->
ÃÉs
; i++) {

142 
kv
 = 
hd
 + 
i
;

143 ià(!
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, (
u_ch¬
 *)"LD", 2)) {

144 ià(
ùx
->
Ïng
->
Ën
è
kv
->
v®ue
 = *ctx->lang;

146 
	`ngx_¡r_£t
(&
kv
->
v®ue
, "zh-CN");

149 ià(!
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, (
u_ch¬
 *)"NW", 2)è
nw
 = 1;

152 ià(!
nw
) {

153 
kv
 = 
	`ngx_¬¿y_push
(
kvs
);

154 ià(!
kv
è 
NGX_ERROR
;

155 
	`ngx_¡r_£t
(&
kv
->
key
, "NW");

156 
	`ngx_¡r_£t
(&
kv
->
v®ue
, "1");

160 
	`ngx_sÜt
(
kvs
->
–ts
, kvs->
ÃÉs
, (
ngx_keyv®_t
),

161 
ngx_h‰p_googË_»¥Ú£_h—d”_sÜt_cook›_cÚf
);

163 
ngx_¡r_t
 * 
nv
 = 
	`ngx_h‰p_googË_im¶ode_kv
(
r
, 
kvs
, ":");

164 ià(!
nv
è 
NGX_ERROR
;

166 *
v
 = *
nv
;

168  
NGX_OK
;

169 
	}
}

171 
ngx_št_t


172 
	$ngx_h‰p_googË_»¥Ú£_h—d”_£t_cook›
(
ngx_h‰p_»que¡_t
 * 
r
,

173 
ngx_h‰p_googË_ùx_t
 * 
ùx
,

174 
ngx_bË_–t_t
 * 
tb
)

176 
ngx_¬¿y_t
 * 
kvs
 = 
	`ngx_h‰p_googË_ex¶ode_kv
(
r
, &
tb
->
v®ue
, ";");

177 ià(!
kvs
è 
NGX_ERROR
;

179 
ngx_ušt_t
 
i
;

180 
ngx_keyv®_t
 * 
kv
, * 
hd
 = 
kvs
->
–ts
;

182 
i
 = 0; i < 
kvs
->
ÃÉs
; i++)

184 
kv
 = 
hd
 + 
i
;

186 ià(!
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, 
ùx
->
cÚf
->d©a, ctx->cÚf->
Ën
))

188 ià(
	`ngx_h‰p_googË_»¥Ú£_h—d”_£t_cook›_cÚf
(
r
, 
ùx
, &
kv
->
v®ue
)) {

189  
NGX_ERROR
;

193 ià(!
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, (
u_ch¬
 *)"GOOGLE_ABUSE_EXEMPTION", 22))

195 ià(
	`ngx_h‰p_googË_»¥Ú£_h—d”_£t_cook›_exem±
(
r
, 
ùx
, 
kvs
)) {

196  
NGX_ERROR
;

200 ià(!
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, (
u_ch¬
 *)"domain", 6))

202 
kv
->
v®ue
 = *
ùx
->
domaš
;

205 ià(!
	`ngx_¡ºÿ£cmp
(
kv
->
key
.
d©a
, (
u_ch¬
 *)"path", 4)) {

206 
	`ngx_¡r_£t
(&
kv
->
v®ue
, "/");

211 ià(!
kvs
->
ÃÉs
) {

212 
tb
->
hash
 = 0;  
NGX_OK
;

215 
ngx_¡r_t
 * 
£t_cook›
 = 
	`ngx_h‰p_googË_im¶ode_kv
(
r
, 
kvs
, "; ");

216 ià(!
£t_cook›
è 
NGX_ERROR
;

219 
tb
->
v®ue
 = *
£t_cook›
;

221  
NGX_OK
;

222 
	}
}

224 
ngx_št_t


225 
	$ngx_h‰p_googË_»¥Ú£_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 * 
r
)

227 
ngx_h‰p_googË_maš_cÚf_t
 * 
gmcf
;

228 
gmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

230 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
;

231 
glcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

232 ià(
glcf
->
’abË
 !ð1è 
gmcf
->
	`Ãxt_h—d”_fž‹r
(
r
);

234 
ngx_h‰p_googË_ùx_t
 * 
ùx
;

235 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

237 
ngx_ušt_t
 
i
;

238 
ngx_li¡_·¹_t
 * 
±
 = &
r
->
h—d”s_out
.
h—d”s
.
·¹
;

239 
ngx_bË_–t_t
 * 
hd
 = 
±
->
–ts
, * 
tb
;

241 
i
 = 0; ; i++)

243 ià(
i
 >ð
±
->
ÃÉs
) {

245 ià(
±
->
Ãxt
 =ð
NULL
) ;

247 
±
 =…t->
Ãxt
;

248 
hd
 = 
±
->
–ts
;

249 
i
 = 0;

252 
tb
 = 
hd
 + 
i
;

254 ià(!
	`ngx_¡ºÿ£cmp
(
tb
->
key
.
d©a
, (
u_ch¬
 *)"Location", 8)) {

255 ià(
	`ngx_h‰p_googË_»¥Ú£_h—d”_loÿtiÚ
(
r
, 
ùx
, &
tb
->
v®ue
)) {

256  
NGX_ERROR
;

260 ià(!
	`ngx_¡ºÿ£cmp
(
tb
->
key
.
d©a
, (
u_ch¬
 *)"Set-Cookie", 10)) {

261 ià(
	`ngx_h‰p_googË_»¥Ú£_h—d”_£t_cook›
(
r
, 
ùx
, 
tb
)) {

262  
NGX_ERROR
;

267 
tb
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

268 ià(!
tb
è 
NGX_ERROR
;

271 
	`ngx_¡r_£t
(&
tb
->
key
, "Server");

272 
tb
->
hash
 = 1;

273 
tb
->
v®ue
.
Ën
 = 
ùx
->
ho¡
->len;

274 
tb
->
v®ue
.
Ën
 +ð(
NGX_HTTP_GOOGLE_FILTER_MODULE_VERSION
);

275 
tb
->
v®ue
.
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
,b->v®ue.
Ën
);

277 
	`ngx_¢´štf
(
tb
->
v®ue
.
d©a
,b->v®ue.
Ën
,

278 "%V/" 
NGX_HTTP_GOOGLE_FILTER_MODULE_VERSION
,

279 
ùx
->
ho¡
);

282 
r
->
h—d”s_out
.
£rv”
 = 
tb
;

284  
gmcf
->
	`Ãxt_h—d”_fž‹r
(
r
);

285 
	}
}

287 
ngx_št_t


288 
	$ngx_h‰p_googË_»¥Ú£_body_fž‹r
(
ngx_h‰p_»que¡_t
 * 
r
, 
ngx_chaš_t
 * 
š
)

290 
ngx_h‰p_googË_maš_cÚf_t
 * 
gmcf
;

291 
gmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

293 
ngx_h‰p_googË_loc_cÚf_t
 * 
glcf
;

294 
glcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

295 ià(
glcf
->
’abË
 !ð1è 
gmcf
->
	`Ãxt_body_fž‹r
(
r
, 
š
);

297 
ngx_h‰p_googË_ùx_t
 * 
ùx
;

298 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_googË_fž‹r_moduË
);

300 ià(!
ùx
->
robÙs
è 
gmcf
->
	`Ãxt_body_fž‹r
(
r
, 
š
);

301 ià(
glcf
->
robÙs
 =ð1è 
gmcf
->
	`Ãxt_body_fž‹r
(
r
, 
š
);

303 
ngx_chaš_t
 
out
;

304 
	`ngx_memz”o
(&
out
, (
ngx_chaš_t
));

306 
ngx_¡r_t
 
‹xt
;

307 
	`ngx_¡r_£t
(&
‹xt
, "U£r-ag’t: *" 
CRLF


308 "Di§Îow: /" 
CRLF
);

310 
out
.
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
‹xt
.
Ën
);

311 ià(!
out
.
buf
è 
NGX_ERROR
;

312 
out
.
buf
->
Ï¡_buf
 = 1;

314 
out
.
buf
->
Ï¡
 = 
	`ngx_cÝy
(out.buf->Ï¡, 
‹xt
.
d©a
,ext.
Ën
);

315  
gmcf
->
	`Ãxt_body_fž‹r
(
r
, &
out
);

316 
	}
}

	@/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_util.c

9 
	~"ngx_h‰p_googË_utž.h
"

11 
ngx_¡r_t


12 
	$ngx_h‰p_googË_Œim
(* 
¡r
, 
size_t
 
Ën
)

14 
ngx_¡r_t
 
v
;

15 
v
.
d©a
 = (
u_ch¬
 *)
¡r
;

16 
v
.
Ën
 =†en;

18 ià(!
v
.
d©a
 || !v.
Ën
)  v;

19 
v
.
Ën
 > 0 && v.
d©a
[0] == ' ') { v.len--; v.data++; }

20 
v
.
Ën
 > 0 && v.
d©a
[v.len - 1] == ' ') { v.len--; }

21  
v
;

22 
	}
}

24 
ngx_¬¿y_t
 *

25 
	$ngx_h‰p_googË_ex¶ode
(
ngx_h‰p_»que¡_t
 * 
r
,

26 
ngx_¡r_t
 * 
v
, cÚ¡ * 
de
)

28 
ngx_¡r_t
 * 
s
;

29 
ngx_¬¿y_t
 * 
ss
 = 
	`ngx_¬¿y_ü—‹
(
r
->
poÞ
, 4, (
ngx_keyv®_t
));

30 ià(!
ss
è 
NULL
;

32 * 
dup
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, 
v
->
Ën
 + 1);

33 ià(!
dup
è 
NULL
;

34 
	`memýy
(
dup
, 
v
->
d©a
, v->
Ën
);

36 * 
pch
, * 
brkt
; 
size_t
 
Ën
;

37 
pch
 = 
	`¡¹ok_r
(
dup
, 
de
, &
brkt
);

38 ; 
pch
;…ch = 
	`¡¹ok_r
(
NULL
, 
de
, &
brkt
))

40 ià(!(
Ën
 = 
	`¡¾’
(
pch
))) ;

41 
s
 = 
	`ngx_¬¿y_push
(
ss
);

42 ià(!
s
è 
NULL
;

43 *
s
 = 
	`ngx_h‰p_googË_Œim
(
pch
, 
	`¡¾’
(pch));

46  
ss
;

47 
	}
}

49 
ngx_¡r_t
 *

50 
	$ngx_h‰p_googË_im¶ode
(
ngx_h‰p_»que¡_t
 * 
r
,

51 
ngx_¬¿y_t
 * 
a
,

52 cÚ¡ * 
de
)

54 
u_ch¬
 * 
buf
;

55 
size_t
 
Ën
 = 0, 
d–’
 = 
	`¡¾’
(
de
);

57 
ngx_ušt_t
 
i
;

58 
ngx_¡r_t
 * 
s
, * 
hd
 = 
a
->
–ts
, * 
¡r
;

60 
i
 = 0; i < 
a
->
ÃÉs
; i++) {

61 
s
 = 
hd
 + 
i
;

62 
Ën
 +ð
s
->ËÀ+ 
d–’
;

65 
¡r
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_¡r_t
));

66 ià(!
¡r
è 
NULL
;

68 
buf
 = 
¡r
->
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, 
Ën
);

69 ià(!
buf
è 
NULL
;

71 
i
 = 0; i < 
a
->
ÃÉs
; i++) {

72 
s
 = 
hd
 + 
i
;

73 ià(
buf
 > 
¡r
->
d©a
èbuàð
	`ngx_cÝy
(buf, 
de
, 
d–’
);

74 
buf
 = 
	`ngx_cÝy
(buf, 
s
->
d©a
, s->
Ën
);

77 
¡r
->
Ën
 = 
buf
 - sŒ->
d©a
;

78  
¡r
;

79 
	}
}

81 
ngx_¬¿y_t
 *

82 
	$ngx_h‰p_googË_ex¶ode_kv
(
ngx_h‰p_»que¡_t
 * 
r
,

83 
ngx_¡r_t
 * 
v
, cÚ¡ * 
de
)

85 
ngx_keyv®_t
 * 
kv
, 
tkv
;

86 
ngx_¬¿y_t
 * 
kvs
 = 
	`ngx_¬¿y_ü—‹
(
r
->
poÞ
, 4, (
ngx_keyv®_t
));

87 ià(!
kvs
è 
NULL
;

89 * 
dup
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, 
v
->
Ën
 + 1);

90 ià(!
dup
è 
NULL
;

91 
	`memýy
(
dup
, 
v
->
d©a
, v->
Ën
);

93 * 
pch
, * 
£p
, * 
brkt
;

94 
pch
 = 
	`¡¹ok_r
(
dup
, 
de
, &
brkt
);

96 ; 
pch
;…ch = 
	`¡¹ok_r
(
NULL
, 
de
, &
brkt
))

98 
£p
 = 
	`¡rchr
(
pch
, '=');

99 ià(!
£p
) ;

100 *
£p
++ = '\0';

101 
tkv
.
key
 = 
	`ngx_h‰p_googË_Œim
(
pch
, 
	`¡¾’
(pch));

102 
tkv
.
v®ue
 = 
	`ngx_h‰p_googË_Œim
(
£p
, 
	`¡¾’
(sep));

103 ià(!
tkv
.
key
.
Ën
) ;

104 
kv
 = 
	`ngx_¬¿y_push
(
kvs
);

105 ià(!
kv
è 
NULL
;

106 *
kv
 = 
tkv
;

109  
kvs
;

110 
	}
}

112 
ngx_¡r_t
 *

113 
	$ngx_h‰p_googË_im¶ode_kv
(
ngx_h‰p_»que¡_t
 * 
r
,

114 
ngx_¬¿y_t
 * 
a
,

115 cÚ¡ * 
de
)

117 
u_ch¬
 * 
buf
;

118 
size_t
 
Ën
 = 0, 
d–’
 = 
	`¡¾’
(
de
);

120 
ngx_ušt_t
 
i
;

121 
ngx_¡r_t
 * 
¡r
;

122 
ngx_keyv®_t
 * 
kv
, * 
hd
 = 
a
->
–ts
;

124 
i
 = 0; i < 
a
->
ÃÉs
; i++) {

125 
kv
 = 
hd
 + 
i
;

126 
Ën
 +ð
kv
->
key
.ËÀ+ 1 + kv->
v®ue
.ËÀ+ 
d–’
;

129 
¡r
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_¡r_t
));

130 ià(!
¡r
è 
NULL
;

132 
buf
 = 
¡r
->
d©a
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, 
Ën
);

133 ià(!
buf
è 
NULL
;

135 
i
 = 0; i < 
a
->
ÃÉs
; i++) {

136 
kv
 = 
hd
 + 
i
;

137 ià(
buf
 > 
¡r
->
d©a
èbuàð
	`ngx_cÝy
(buf, 
de
, 
d–’
);

138 
buf
 = 
	`ngx_cÝy
(buf, 
kv
->
key
.
d©a
, kv->key.
Ën
);

139 *
buf
++ = '=';

140 
buf
 = 
	`ngx_cÝy
(buf, 
kv
->
v®ue
.
d©a
, kv->v®ue.
Ën
);

143 
¡r
->
Ën
 = 
buf
 - sŒ->
d©a
;

144  
¡r
;

145 
	}
}

147 
ngx_št_t


148 
	$ngx_h‰p_googË_debug
(
ngx_poÞ_t
 * 
poÞ
, cÚ¡ * 
fmt
, ...)

150 
u_ch¬
 * 
buf
;

151 
ngx_ušt_t
 
Ën
 = 4096;

153 
buf
 = 
	`ngx_pÿÎoc
(
poÞ
, 
Ën
 + 1);

154 ià(!
buf
) {

155  
	`årštf
(
¡d”r
, "ngx_pÿÎoc(%luèçžed\n", ()
Ën
);

158 
va_li¡
 
¬gs
;

159 
	`va_¡¬t
(
¬gs
, 
fmt
);

160 
	`ngx_v¢´štf
(
buf
, 
Ën
, 
fmt
, 
¬gs
);

161 
	`va_’d
(
¬gs
);

163  
	`årštf
(
¡dout
, "%s", 
buf
);

164 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/nginx.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngšx.h
>

13 
ngx_št_t
 
ngx_add_šh”™ed_sock‘s
(
ngx_cyþe_t
 *
cyþe
);

14 
ngx_št_t
 
ngx_g‘_ÝtiÚs
(
¬gc
, *cÚ¡ *
¬gv
);

15 
ngx_št_t
 
ngx_´oûss_ÝtiÚs
(
ngx_cyþe_t
 *
cyþe
);

16 
ngx_št_t
 
ngx_§ve_¬gv
(
ngx_cyþe_t
 *
cyþe
, 
¬gc
, *cÚ¡ *
¬gv
);

17 *
ngx_cÜe_moduË_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

18 *
ngx_cÜe_moduË_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

19 *
ngx_£t_u£r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

20 *
ngx_£t_’v
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

21 *
ngx_£t_´iÜ™y
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

22 *
ngx_£t_ýu_affš™y
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

23 *
cÚf
);

24 *
ngx_£t_wÜk”_´oûs£s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

25 *
cÚf
);

28 
ngx_cÚf_’um_t
 
	gngx_debug_pošts
[] = {

29 { 
ngx_¡ršg
("¡Ý"), 
NGX_DEBUG_POINTS_STOP
 },

30 { 
ngx_¡ršg
("abÜt"), 
NGX_DEBUG_POINTS_ABORT
 },

31 { 
ngx_nuÎ_¡ršg
, 0 }

35 
ngx_commªd_t
 
	gngx_cÜe_commªds
[] = {

37 { 
ngx_¡ršg
("daemon"),

38 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_FLAG
,

39 
ngx_cÚf_£t_æag_¦Ù
,

41 
off£tof
(
ngx_cÜe_cÚf_t
, 
d«mÚ
),

42 
NULL
 },

44 { 
ngx_¡ršg
("master_process"),

45 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_FLAG
,

46 
ngx_cÚf_£t_æag_¦Ù
,

48 
off£tof
(
ngx_cÜe_cÚf_t
, 
ma¡”
),

49 
NULL
 },

51 { 
ngx_¡ršg
("timer_resolution"),

52 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

53 
ngx_cÚf_£t_m£c_¦Ù
,

55 
off£tof
(
ngx_cÜe_cÚf_t
, 
tim”_»sÞutiÚ
),

56 
NULL
 },

58 { 
ngx_¡ršg
("pid"),

59 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

60 
ngx_cÚf_£t_¡r_¦Ù
,

62 
off£tof
(
ngx_cÜe_cÚf_t
, 
pid
),

63 
NULL
 },

65 { 
ngx_¡ršg
("lock_file"),

66 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

67 
ngx_cÚf_£t_¡r_¦Ù
,

69 
off£tof
(
ngx_cÜe_cÚf_t
, 
lock_fže
),

70 
NULL
 },

72 { 
ngx_¡ršg
("worker_processes"),

73 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

74 
ngx_£t_wÜk”_´oûs£s
,

77 
NULL
 },

79 { 
ngx_¡ršg
("debug_points"),

80 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

81 
ngx_cÚf_£t_’um_¦Ù
,

83 
off£tof
(
ngx_cÜe_cÚf_t
, 
debug_pošts
),

84 &
ngx_debug_pošts
 },

86 { 
ngx_¡ršg
("user"),

87 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE12
,

88 
ngx_£t_u£r
,

91 
NULL
 },

93 { 
ngx_¡ršg
("worker_priority"),

94 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

95 
ngx_£t_´iÜ™y
,

98 
NULL
 },

100 { 
ngx_¡ršg
("worker_cpu_affinity"),

101 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_1MORE
,

102 
ngx_£t_ýu_affš™y
,

105 
NULL
 },

107 { 
ngx_¡ršg
("worker_rlimit_nofile"),

108 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

109 
ngx_cÚf_£t_num_¦Ù
,

111 
off£tof
(
ngx_cÜe_cÚf_t
, 
¾im™_nofže
),

112 
NULL
 },

114 { 
ngx_¡ršg
("worker_rlimit_core"),

115 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

116 
ngx_cÚf_£t_off_¦Ù
,

118 
off£tof
(
ngx_cÜe_cÚf_t
, 
¾im™_cÜe
),

119 
NULL
 },

121 { 
ngx_¡ršg
("worker_rlimit_sigpending"),

122 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

123 
ngx_cÚf_£t_num_¦Ù
,

125 
off£tof
(
ngx_cÜe_cÚf_t
, 
¾im™_sig³ndšg
),

126 
NULL
 },

128 { 
ngx_¡ršg
("working_directory"),

129 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

130 
ngx_cÚf_£t_¡r_¦Ù
,

132 
off£tof
(
ngx_cÜe_cÚf_t
, 
wÜkšg_dœeùÜy
),

133 
NULL
 },

135 { 
ngx_¡ršg
("env"),

136 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

137 
ngx_£t_’v
,

140 
NULL
 },

142 #ià(
NGX_THREADS
)

144 { 
ngx_¡ršg
("worker_threads"),

145 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

146 
ngx_cÚf_£t_num_¦Ù
,

148 
off£tof
(
ngx_cÜe_cÚf_t
, 
wÜk”_th»ads
),

149 
NULL
 },

151 { 
ngx_¡ršg
("thread_stack_size"),

152 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

153 
ngx_cÚf_£t_size_¦Ù
,

155 
off£tof
(
ngx_cÜe_cÚf_t
, 
th»ad_¡ack_size
),

156 
NULL
 },

160 
ngx_nuÎ_commªd


164 
ngx_cÜe_moduË_t
 
	gngx_cÜe_moduË_ùx
 = {

165 
ngx_¡ršg
("core"),

166 
ngx_cÜe_moduË_ü—‹_cÚf
,

167 
ngx_cÜe_moduË_š™_cÚf


171 
ngx_moduË_t
 
	gngx_cÜe_moduË
 = {

172 
NGX_MODULE_V1
,

173 &
ngx_cÜe_moduË_ùx
,

174 
ngx_cÜe_commªds
,

175 
NGX_CORE_MODULE
,

176 
NULL
,

177 
NULL
,

178 
NULL
,

179 
NULL
,

180 
NULL
,

181 
NULL
,

182 
NULL
,

183 
NGX_MODULE_V1_PADDING


187 
ngx_ušt_t
 
	gngx_max_moduË
;

189 
ngx_ušt_t
 
	gngx_show_h–p
;

190 
ngx_ušt_t
 
	gngx_show_v”siÚ
;

191 
ngx_ušt_t
 
	gngx_show_cÚfigu»
;

192 
u_ch¬
 *
	gngx_´efix
;

193 
u_ch¬
 *
	gngx_cÚf_fže
;

194 
u_ch¬
 *
	gngx_cÚf_·¿ms
;

195 *
	gngx_sigÇl
;

198 **
	gngx_os_’vœÚ
;

201 
ngx_cdeþ


202 
	$maš
(
¬gc
, *cÚ¡ *
¬gv
)

204 
ngx_št_t
 
i
;

205 
ngx_log_t
 *
log
;

206 
ngx_cyþe_t
 *
cyþe
, 
š™_cyþe
;

207 
ngx_cÜe_cÚf_t
 *
ccf
;

209 
	`ngx_debug_š™
();

211 ià(
	`ngx_¡»¼Ü_š™
(è!ð
NGX_OK
) {

215 ià(
	`ngx_g‘_ÝtiÚs
(
¬gc
, 
¬gv
è!ð
NGX_OK
) {

219 ià(
ngx_show_v”siÚ
) {

220 
	`ngx_wr™e_¡d”r
("ngšx v”siÚ: " 
NGINX_VER_BUILD
 
NGX_LINEFEED
);

222 ià(
ngx_show_h–p
) {

223 
	`ngx_wr™e_¡d”r
(

225 "[-°´efix] [-g dœeùives]" 
NGX_LINEFEED


226 
NGX_LINEFEED


227 "O±iÚs:" 
NGX_LINEFEED


228 " -?,-h :hi h–p" 
NGX_LINEFEED


229 " -v : show v”siÚ‡ndƒx™" 
NGX_LINEFEED


231 
NGX_LINEFEED


232 " -ˆ :e¡ cÚfigu¿tiÚ‡ndƒx™" 
NGX_LINEFEED


234 "duršg cÚfigu¿tiÚe¡šg" 
NGX_LINEFEED


236 "¡Ý, qu™,„eÝ’,„–ßd" 
NGX_LINEFEED


237 #ifdeà
NGX_PREFIX


239 
NGX_PREFIX
 ")" 
NGX_LINEFEED


241 " -°´efix : s‘…»fix…©h (deçuÉ: NONE)" 
NGX_LINEFEED


244 
NGX_CONF_PATH
 ")" 
NGX_LINEFEED


246 "fže" 
NGX_LINEFEED
 NGX_LINEFEED

250 ià(
ngx_show_cÚfigu»
) {

251 
	`ngx_wr™e_¡d”r
(

252 #ifdeà
NGX_COMPILER


253 "bužˆby " 
NGX_COMPILER
 
NGX_LINEFEED


255 #ià(
NGX_SSL
)

256 #ifdeà
SSL_CTRL_SET_TLSEXT_HOSTNAME


257 "TLS SNI suµÜˆ’abËd" 
NGX_LINEFEED


259 "TLS SNI suµÜˆdi§bËd" 
NGX_LINEFEED


262 "cÚfigu»‡rgum’ts:" 
NGX_CONFIGURE
 
NGX_LINEFEED
);

265 ià(!
ngx_‹¡_cÚfig
) {

270  
ngx_max_sock‘s
 = -1;

272 
	`ngx_time_š™
();

274 #ià(
NGX_PCRE
)

275 
	`ngx_»gex_š™
();

278 
ngx_pid
 = 
	`ngx_g‘pid
();

280 
log
 = 
	`ngx_log_š™
(
ngx_´efix
);

281 ià(
log
 =ð
NULL
) {

286 #ià(
NGX_OPENSSL
)

287 
	`ngx_s¦_š™
(
log
);

295 
	`ngx_memz”o
(&
š™_cyþe
, (
ngx_cyþe_t
));

296 
š™_cyþe
.
log
 =†og;

297 
ngx_cyþe
 = &
š™_cyþe
;

299 
š™_cyþe
.
poÞ
 = 
	`ngx_ü—‹_poÞ
(1024, 
log
);

300 ià(
š™_cyþe
.
poÞ
 =ð
NULL
) {

304 ià(
	`ngx_§ve_¬gv
(&
š™_cyþe
, 
¬gc
, 
¬gv
è!ð
NGX_OK
) {

308 ià(
	`ngx_´oûss_ÝtiÚs
(&
š™_cyþe
è!ð
NGX_OK
) {

312 ià(
	`ngx_os_š™
(
log
è!ð
NGX_OK
) {

320 ià(
	`ngx_üc32_bË_š™
(è!ð
NGX_OK
) {

324 ià(
	`ngx_add_šh”™ed_sock‘s
(&
š™_cyþe
è!ð
NGX_OK
) {

328 
ngx_max_moduË
 = 0;

329 
i
 = 0; 
ngx_moduËs
[i]; i++) {

330 
ngx_moduËs
[
i
]->
šdex
 = 
ngx_max_moduË
++;

333 
cyþe
 = 
	`ngx_š™_cyþe
(&
š™_cyþe
);

334 ià(
cyþe
 =ð
NULL
) {

335 ià(
ngx_‹¡_cÚfig
) {

336 
	`ngx_log_¡d”r
(0, "configuration file %sest failed",

337 
š™_cyþe
.
cÚf_fže
.
d©a
);

343 ià(
ngx_‹¡_cÚfig
) {

344 ià(!
ngx_qu›t_mode
) {

345 
	`ngx_log_¡d”r
(0, "configuration file %sest is successful",

346 
cyþe
->
cÚf_fže
.
d©a
);

352 ià(
ngx_sigÇl
) {

353  
	`ngx_sigÇl_´oûss
(
cyþe
, 
ngx_sigÇl
);

356 
	`ngx_os_¡©us
(
cyþe
->
log
);

358 
ngx_cyþe
 = 
cyþe
;

360 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

362 ià(
ccf
->
ma¡”
 && 
ngx_´oûss
 =ð
NGX_PROCESS_SINGLE
) {

363 
ngx_´oûss
 = 
NGX_PROCESS_MASTER
;

366 #ià!(
NGX_WIN32
)

368 ià(
	`ngx_š™_sigÇls
(
cyþe
->
log
è!ð
NGX_OK
) {

372 ià(!
ngx_šh”™ed
 && 
ccf
->
d«mÚ
) {

373 ià(
	`ngx_d«mÚ
(
cyþe
->
log
è!ð
NGX_OK
) {

377 
ngx_d«mÚized
 = 1;

380 ià(
ngx_šh”™ed
) {

381 
ngx_d«mÚized
 = 1;

386 ià(
	`ngx_ü—‹_pidfže
(&
ccf
->
pid
, 
cyþe
->
log
è!ð
NGX_OK
) {

390 ià(
	`ngx_log_»dœeù_¡d”r
(
cyþe
è!ð
NGX_OK
) {

394 ià(
log
->
fže
->
fd
 !ð
ngx_¡d”r
) {

395 ià(
	`ngx_þo£_fže
(
log
->
fže
->
fd
è=ð
NGX_FILE_ERROR
) {

396 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

397 
ngx_þo£_fže_n
 " built-in†og failed");

401 
ngx_u£_¡d”r
 = 0;

403 ià(
ngx_´oûss
 =ð
NGX_PROCESS_SINGLE
) {

404 
	`ngx_sšgË_´oûss_cyþe
(
cyþe
);

407 
	`ngx_ma¡”_´oûss_cyþe
(
cyþe
);

411 
	}
}

414 
ngx_št_t


415 
	$ngx_add_šh”™ed_sock‘s
(
ngx_cyþe_t
 *
cyþe
)

417 
u_ch¬
 *
p
, *
v
, *
šh”™ed
;

418 
ngx_št_t
 
s
;

419 
ngx_li¡’šg_t
 *
ls
;

421 
šh”™ed
 = (
u_ch¬
 *è
	`g‘’v
(
NGINX_VAR
);

423 ià(
šh”™ed
 =ð
NULL
) {

424  
NGX_OK
;

427 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0,

428 "usšg inh”™ed sock‘ äom \"%s\"", 
šh”™ed
);

430 ià(
	`ngx_¬¿y_š™
(&
cyþe
->
li¡’šg
, cyþe->
poÞ
, 10,

431 (
ngx_li¡’šg_t
))

432 !ð
NGX_OK
)

434  
NGX_ERROR
;

437 
p
 = 
šh”™ed
, 
v
 =…; *p;…++) {

438 ià(*
p
 == ':' || *p == ';') {

439 
s
 = 
	`ngx_©oi
(
v
, 
p
 - v);

440 ià(
s
 =ð
NGX_ERROR
) {

441 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

442 "šv®id sock‘‚umb” \"%s\" iÀ" 
NGINX_VAR


444 " oàthv¬ŸbË", 
v
);

448 
v
 = 
p
 + 1;

450 
ls
 = 
	`ngx_¬¿y_push
(&
cyþe
->
li¡’šg
);

451 ià(
ls
 =ð
NULL
) {

452  
NGX_ERROR
;

455 
	`ngx_memz”o
(
ls
, (
ngx_li¡’šg_t
));

457 
ls
->
fd
 = (
ngx_sock‘_t
è
s
;

461 
ngx_šh”™ed
 = 1;

463  
	`ngx_£t_šh”™ed_sock‘s
(
cyþe
);

464 
	}
}

468 
	$ngx_£t_’vœÚm’t
(
ngx_cyþe_t
 *
cyþe
, 
ngx_ušt_t
 *
Ï¡
)

470 **
p
, **
’v
;

471 
ngx_¡r_t
 *
v¬
;

472 
ngx_ušt_t
 
i
, 
n
;

473 
ngx_cÜe_cÚf_t
 *
ccf
;

475 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

477 ià(
Ï¡
 =ð
NULL
 && 
ccf
->
’vœÚm’t
) {

478  
ccf
->
’vœÚm’t
;

481 
v¬
 = 
ccf
->
’v
.
–ts
;

483 
i
 = 0; i < 
ccf
->
’v
.
ÃÉs
; i++) {

484 ià(
	`ngx_¡rcmp
(
v¬
[
i
].
d©a
, "TZ") == 0

485 || 
	`ngx_¡ºcmp
(
v¬
[
i
].
d©a
, "TZ=", 3) == 0)

487 
tz_found
;

491 
v¬
 = 
	`ngx_¬¿y_push
(&
ccf
->
’v
);

492 ià(
v¬
 =ð
NULL
) {

493  
NULL
;

496 
v¬
->
Ën
 = 2;

497 
v¬
->
d©a
 = (
u_ch¬
 *) "TZ";

499 
v¬
 = 
ccf
->
’v
.
–ts
;

501 
tz_found
:

503 
n
 = 0;

505 
i
 = 0; i < 
ccf
->
’v
.
ÃÉs
; i++) {

507 ià(
v¬
[
i
].
d©a
[v¬[i].
Ën
] == '=') {

508 
n
++;

512 
p
 = 
ngx_os_’vœÚ
; *p;…++) {

514 ià(
	`ngx_¡ºcmp
(*
p
, 
v¬
[
i
].
d©a
, v¬[i].
Ën
) == 0

515 && (*
p
)[
v¬
[
i
].
Ën
] == '=')

517 
n
++;

523 ià(
Ï¡
) {

524 
’v
 = 
	`ngx_®loc
((*
Ï¡
 + 
n
 + 1è* (*), 
cyþe
->
log
);

525 *
Ï¡
 = 
n
;

528 
’v
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, (
n
 + 1) * (*));

531 ià(
’v
 =ð
NULL
) {

532  
NULL
;

535 
n
 = 0;

537 
i
 = 0; i < 
ccf
->
’v
.
ÃÉs
; i++) {

539 ià(
v¬
[
i
].
d©a
[v¬[i].
Ën
] == '=') {

540 
’v
[
n
++] = (*è
v¬
[
i
].
d©a
;

544 
p
 = 
ngx_os_’vœÚ
; *p;…++) {

546 ià(
	`ngx_¡ºcmp
(*
p
, 
v¬
[
i
].
d©a
, v¬[i].
Ën
) == 0

547 && (*
p
)[
v¬
[
i
].
Ën
] == '=')

549 
’v
[
n
++] = *
p
;

555 
’v
[
n
] = 
NULL
;

557 ià(
Ï¡
 =ð
NULL
) {

558 
ccf
->
’vœÚm’t
 = 
’v
;

559 
’vœÚ
 = 
’v
;

562  
’v
;

563 
	}
}

566 
ngx_pid_t


567 
	$ngx_exec_Ãw_bš¬y
(
ngx_cyþe_t
 *
cyþe
, *cÚ¡ *
¬gv
)

569 **
’v
, *
v¬
;

570 
u_ch¬
 *
p
;

571 
ngx_ušt_t
 
i
, 
n
;

572 
ngx_pid_t
 
pid
;

573 
ngx_exec_ùx_t
 
ùx
;

574 
ngx_cÜe_cÚf_t
 *
ccf
;

575 
ngx_li¡’šg_t
 *
ls
;

577 
	`ngx_memz”o
(&
ùx
, (
ngx_exec_ùx_t
));

579 
ùx
.
·th
 = 
¬gv
[0];

580 
ùx
.
Çme
 = "new binary…rocess";

581 
ùx
.
¬gv
 =‡rgv;

583 
n
 = 2;

584 
’v
 = 
	`ngx_£t_’vœÚm’t
(
cyþe
, &
n
);

585 ià(
’v
 =ð
NULL
) {

586  
NGX_INVALID_PID
;

589 
v¬
 = 
	`ngx_®loc
((
NGINX_VAR
)

590 + 
cyþe
->
li¡’šg
.
ÃÉs
 * (
NGX_INT32_LEN
 + 1) + 2,

591 
cyþe
->
log
);

592 ià(
v¬
 =ð
NULL
) {

593 
	`ngx_ä“
(
’v
);

594  
NGX_INVALID_PID
;

597 
p
 = 
	`ngx_ýymem
(
v¬
, 
NGINX_VAR
 "=", (NGINX_VAR));

599 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

600 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

601 
p
 = 
	`ngx_¥rštf
Õ, "%ud;", 
ls
[
i
].
fd
);

604 *
p
 = '\0';

606 
’v
[
n
++] = 
v¬
;

608 #ià(
NGX_SETPROCTITLE_USES_ENV
)

612 
’v
[
n
++] = "SPARE=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

620 
’v
[
n
] = 
NULL
;

622 #ià(
NGX_DEBUG
)

624 **
e
;

625 
e
 = 
’v
; *e;ƒ++) {

626 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0, "’v: %s", *
e
);

631 
ùx
.
’vp
 = (*cÚ¡ *è
’v
;

633 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

635 ià(
	`ngx_»Çme_fže
(
ccf
->
pid
.
d©a
, ccf->
Þdpid
.d©aè=ð
NGX_FILE_ERROR
) {

636 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

637 
ngx_»Çme_fže_n
 " %so %s failed "

639 
ccf
->
pid
.
d©a
, ccf->
Þdpid
.d©a, 
¬gv
[0]);

641 
	`ngx_ä“
(
’v
);

642 
	`ngx_ä“
(
v¬
);

644  
NGX_INVALID_PID
;

647 
pid
 = 
	`ngx_execu‹
(
cyþe
, &
ùx
);

649 ià(
pid
 =ð
NGX_INVALID_PID
) {

650 ià(
	`ngx_»Çme_fže
(
ccf
->
Þdpid
.
d©a
, ccf->
pid
.data)

651 =ð
NGX_FILE_ERROR
)

653 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

654 
ngx_»Çme_fže_n
 " %s backo %s failed‡fter "

656 
ccf
->
Þdpid
.
d©a
, ccf->
pid
.d©a, 
¬gv
[0]);

660 
	`ngx_ä“
(
’v
);

661 
	`ngx_ä“
(
v¬
);

663  
pid
;

664 
	}
}

667 
ngx_št_t


668 
	$ngx_g‘_ÝtiÚs
(
¬gc
, *cÚ¡ *
¬gv
)

670 
u_ch¬
 *
p
;

671 
ngx_št_t
 
i
;

673 
i
 = 1; i < 
¬gc
; i++) {

675 
p
 = (
u_ch¬
 *è
¬gv
[
i
];

677 ià(*
p
++ != '-') {

678 
	`ngx_log_¡d”r
(0, "šv®id o±iÚ: \"%s\"", 
¬gv
[
i
]);

679  
NGX_ERROR
;

682 *
p
) {

684 *
p
++) {

688 
ngx_show_v”siÚ
 = 1;

689 
ngx_show_h–p
 = 1;

693 
ngx_show_v”siÚ
 = 1;

697 
ngx_show_v”siÚ
 = 1;

698 
ngx_show_cÚfigu»
 = 1;

702 
ngx_‹¡_cÚfig
 = 1;

706 
ngx_qu›t_mode
 = 1;

710 ià(*
p
) {

711 
ngx_´efix
 = 
p
;

712 
Ãxt
;

715 ià(
¬gv
[++
i
]) {

716 
ngx_´efix
 = (
u_ch¬
 *è
¬gv
[
i
];

717 
Ãxt
;

720 
	`ngx_log_¡d”r
(0, "option \"-p\"„equires directory‚ame");

721  
NGX_ERROR
;

724 ià(*
p
) {

725 
ngx_cÚf_fže
 = 
p
;

726 
Ãxt
;

729 ià(
¬gv
[++
i
]) {

730 
ngx_cÚf_fže
 = (
u_ch¬
 *è
¬gv
[
i
];

731 
Ãxt
;

734 
	`ngx_log_¡d”r
(0, "option \"-c\"„equires file‚ame");

735  
NGX_ERROR
;

738 ià(*
p
) {

739 
ngx_cÚf_·¿ms
 = 
p
;

740 
Ãxt
;

743 ià(
¬gv
[++
i
]) {

744 
ngx_cÚf_·¿ms
 = (
u_ch¬
 *è
¬gv
[
i
];

745 
Ãxt
;

748 
	`ngx_log_¡d”r
(0, "option \"-g\"„equires…arameter");

749  
NGX_ERROR
;

752 ià(*
p
) {

753 
ngx_sigÇl
 = (*è
p
;

755 } ià(
¬gv
[++
i
]) {

756 
ngx_sigÇl
 = 
¬gv
[
i
];

759 
	`ngx_log_¡d”r
(0, "option \"-s\"„equires…arameter");

760  
NGX_ERROR
;

763 ià(
	`ngx_¡rcmp
(
ngx_sigÇl
, "stop") == 0

764 || 
	`ngx_¡rcmp
(
ngx_sigÇl
, "quit") == 0

765 || 
	`ngx_¡rcmp
(
ngx_sigÇl
, "reopen") == 0

766 || 
	`ngx_¡rcmp
(
ngx_sigÇl
, "reload") == 0)

768 
ngx_´oûss
 = 
NGX_PROCESS_SIGNALLER
;

769 
Ãxt
;

772 
	`ngx_log_¡d”r
(0, "šv®id o±iÚ: \"- %s\"", 
ngx_sigÇl
);

773  
NGX_ERROR
;

776 
	`ngx_log_¡d”r
(0, "šv®id o±iÚ: \"%c\"", *(
p
 - 1));

777  
NGX_ERROR
;

781 
Ãxt
:

786  
NGX_OK
;

787 
	}
}

790 
ngx_št_t


791 
	$ngx_§ve_¬gv
(
ngx_cyþe_t
 *
cyþe
, 
¬gc
, *cÚ¡ *
¬gv
)

793 #ià(
NGX_FREEBSD
)

795 
ngx_os_¬gv
 = (**è
¬gv
;

796 
ngx_¬gc
 = 
¬gc
;

797 
ngx_¬gv
 = (**è
¬gv
;

800 
size_t
 
Ën
;

801 
ngx_št_t
 
i
;

803 
ngx_os_¬gv
 = (**è
¬gv
;

804 
ngx_¬gc
 = 
¬gc
;

806 
ngx_¬gv
 = 
	`ngx_®loc
((
¬gc
 + 1è* (*), 
cyþe
->
log
);

807 ià(
ngx_¬gv
 =ð
NULL
) {

808  
NGX_ERROR
;

811 
i
 = 0; i < 
¬gc
; i++) {

812 
Ën
 = 
	`ngx_¡¾’
(
¬gv
[
i
]) + 1;

814 
ngx_¬gv
[
i
] = 
	`ngx_®loc
(
Ën
, 
cyþe
->
log
);

815 ià(
ngx_¬gv
[
i
] =ð
NULL
) {

816  
NGX_ERROR
;

819 (è
	`ngx_ýy¡º
((
u_ch¬
 *è
ngx_¬gv
[
i
], (u_ch¬ *è
¬gv
[i], 
Ën
);

822 
ngx_¬gv
[
i
] = 
NULL
;

826 
ngx_os_’vœÚ
 = 
’vœÚ
;

828  
NGX_OK
;

829 
	}
}

832 
ngx_št_t


833 
	$ngx_´oûss_ÝtiÚs
(
ngx_cyþe_t
 *
cyþe
)

835 
u_ch¬
 *
p
;

836 
size_t
 
Ën
;

838 ià(
ngx_´efix
) {

839 
Ën
 = 
	`ngx_¡¾’
(
ngx_´efix
);

840 
p
 = 
ngx_´efix
;

842 ià(
Ën
 && !
	`ngx_·th_£·¿tÜ
(
p
[len - 1])) {

843 
p
 = 
	`ngx_²®loc
(
cyþe
->
poÞ
, 
Ën
 + 1);

844 ià(
p
 =ð
NULL
) {

845  
NGX_ERROR
;

848 
	`ngx_memýy
(
p
, 
ngx_´efix
, 
Ën
);

849 
p
[
Ën
++] = '/';

852 
cyþe
->
cÚf_´efix
.
Ën
 =†en;

853 
cyþe
->
cÚf_´efix
.
d©a
 = 
p
;

854 
cyþe
->
´efix
.
Ën
 =†en;

855 
cyþe
->
´efix
.
d©a
 = 
p
;

859 #iâdeà
NGX_PREFIX


861 
p
 = 
	`ngx_²®loc
(
cyþe
->
poÞ
, 
NGX_MAX_PATH
);

862 ià(
p
 =ð
NULL
) {

863  
NGX_ERROR
;

866 ià(
	`ngx_g‘cwd
(
p
, 
NGX_MAX_PATH
) == 0) {

867 
	`ngx_log_¡d”r
(
ngx_”ºo
, "[em”g]: " 
ngx_g‘cwd_n
 " failed");

868  
NGX_ERROR
;

871 
Ën
 = 
	`ngx_¡¾’
(
p
);

873 
p
[
Ën
++] = '/';

875 
cyþe
->
cÚf_´efix
.
Ën
 =†en;

876 
cyþe
->
cÚf_´efix
.
d©a
 = 
p
;

877 
cyþe
->
´efix
.
Ën
 =†en;

878 
cyþe
->
´efix
.
d©a
 = 
p
;

882 #ifdeà
NGX_CONF_PREFIX


883 
	`ngx_¡r_£t
(&
cyþe
->
cÚf_´efix
, 
NGX_CONF_PREFIX
);

885 
	`ngx_¡r_£t
(&
cyþe
->
cÚf_´efix
, 
NGX_PREFIX
);

887 
	`ngx_¡r_£t
(&
cyþe
->
´efix
, 
NGX_PREFIX
);

892 ià(
ngx_cÚf_fže
) {

893 
cyþe
->
cÚf_fže
.
Ën
 = 
	`ngx_¡¾’
(
ngx_cÚf_fže
);

894 
cyþe
->
cÚf_fže
.
d©a
 = 
ngx_cÚf_fže
;

897 
	`ngx_¡r_£t
(&
cyþe
->
cÚf_fže
, 
NGX_CONF_PATH
);

900 ià(
	`ngx_cÚf_fuÎ_Çme
(
cyþe
, &cyþe->
cÚf_fže
, 0è!ð
NGX_OK
) {

901  
NGX_ERROR
;

904 
p
 = 
cyþe
->
cÚf_fže
.
d©a
 + cyþe->cÚf_fže.
Ën
 - 1;

905 
p
 > 
cyþe
->
cÚf_fže
.
d©a
;

906 
p
--)

908 ià(
	`ngx_·th_£·¿tÜ
(*
p
)) {

909 
cyþe
->
cÚf_´efix
.
Ën
 = 
p
 - 
ngx_cyþe
->
cÚf_fže
.
d©a
 + 1;

910 
cyþe
->
cÚf_´efix
.
d©a
 = 
ngx_cyþe
->
cÚf_fže
.data;

915 ià(
ngx_cÚf_·¿ms
) {

916 
cyþe
->
cÚf_·¿m
.
Ën
 = 
	`ngx_¡¾’
(
ngx_cÚf_·¿ms
);

917 
cyþe
->
cÚf_·¿m
.
d©a
 = 
ngx_cÚf_·¿ms
;

920 ià(
ngx_‹¡_cÚfig
) {

921 
cyþe
->
log
->
log_Ëv–
 = 
NGX_LOG_INFO
;

924  
NGX_OK
;

925 
	}
}

929 
	$ngx_cÜe_moduË_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

931 
ngx_cÜe_cÚf_t
 *
ccf
;

933 
ccf
 = 
	`ngx_pÿÎoc
(
cyþe
->
poÞ
, (
ngx_cÜe_cÚf_t
));

934 ià(
ccf
 =ð
NULL
) {

935  
NULL
;

948 
ccf
->
d«mÚ
 = 
NGX_CONF_UNSET
;

949 
ccf
->
ma¡”
 = 
NGX_CONF_UNSET
;

950 
ccf
->
tim”_»sÞutiÚ
 = 
NGX_CONF_UNSET_MSEC
;

952 
ccf
->
wÜk”_´oûs£s
 = 
NGX_CONF_UNSET
;

953 
ccf
->
debug_pošts
 = 
NGX_CONF_UNSET
;

955 
ccf
->
¾im™_nofže
 = 
NGX_CONF_UNSET
;

956 
ccf
->
¾im™_cÜe
 = 
NGX_CONF_UNSET
;

957 
ccf
->
¾im™_sig³ndšg
 = 
NGX_CONF_UNSET
;

959 
ccf
->
u£r
 = (
ngx_uid_t
è
NGX_CONF_UNSET_UINT
;

960 
ccf
->
group
 = (
ngx_gid_t
è
NGX_CONF_UNSET_UINT
;

962 #ià(
NGX_THREADS
)

963 
ccf
->
wÜk”_th»ads
 = 
NGX_CONF_UNSET
;

964 
ccf
->
th»ad_¡ack_size
 = 
NGX_CONF_UNSET_SIZE
;

967 ià(
	`ngx_¬¿y_š™
(&
ccf
->
’v
, 
cyþe
->
poÞ
, 1, (
ngx_¡r_t
))

968 !ð
NGX_OK
)

970  
NULL
;

973  
ccf
;

974 
	}
}

978 
	$ngx_cÜe_moduË_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

980 
ngx_cÜe_cÚf_t
 *
ccf
 = 
cÚf
;

982 
	`ngx_cÚf_š™_v®ue
(
ccf
->
d«mÚ
, 1);

983 
	`ngx_cÚf_š™_v®ue
(
ccf
->
ma¡”
, 1);

984 
	`ngx_cÚf_š™_m£c_v®ue
(
ccf
->
tim”_»sÞutiÚ
, 0);

986 
	`ngx_cÚf_š™_v®ue
(
ccf
->
wÜk”_´oûs£s
, 1);

987 
	`ngx_cÚf_š™_v®ue
(
ccf
->
debug_pošts
, 0);

989 #ià(
NGX_HAVE_CPU_AFFINITY
)

991 ià(
ccf
->
ýu_affš™y_n


992 && 
ccf
->
ýu_affš™y_n
 != 1

993 && 
ccf
->
ýu_affš™y_n
 !ð(
ngx_ušt_t
èccf->
wÜk”_´oûs£s
)

995 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
cyþe
->
log
, 0,

1003 #ià(
NGX_THREADS
)

1005 
	`ngx_cÚf_š™_v®ue
(
ccf
->
wÜk”_th»ads
, 0);

1006 
ngx_th»ads_n
 = 
ccf
->
wÜk”_th»ads
;

1007 
	`ngx_cÚf_š™_size_v®ue
(
ccf
->
th»ad_¡ack_size
, 2 * 1024 * 1024);

1012 ià(
ccf
->
pid
.
Ën
 == 0) {

1013 
	`ngx_¡r_£t
(&
ccf
->
pid
, 
NGX_PID_PATH
);

1016 ià(
	`ngx_cÚf_fuÎ_Çme
(
cyþe
, &
ccf
->
pid
, 0è!ð
NGX_OK
) {

1017  
NGX_CONF_ERROR
;

1020 
ccf
->
Þdpid
.
Ën
 = ccf->
pid
.ËÀ+ (
NGX_OLDPID_EXT
);

1022 
ccf
->
Þdpid
.
d©a
 = 
	`ngx_²®loc
(
cyþe
->
poÞ
, ccf->Þdpid.
Ën
);

1023 ià(
ccf
->
Þdpid
.
d©a
 =ð
NULL
) {

1024  
NGX_CONF_ERROR
;

1027 
	`ngx_memýy
(
	`ngx_ýymem
(
ccf
->
Þdpid
.
d©a
, ccf->
pid
.d©a, ccf->pid.
Ën
),

1028 
NGX_OLDPID_EXT
, (NGX_OLDPID_EXT));

1031 #ià!(
NGX_WIN32
)

1033 ià(
ccf
->
u£r
 =ð(
uid_t
è
NGX_CONF_UNSET_UINT
 && 
	`g‘euid
() == 0) {

1034 
group
 *
g½
;

1035 
·sswd
 *
pwd
;

1037 
	`ngx_£t_”ºo
(0);

1038 
pwd
 = 
	`g‘pwÇm
(
NGX_USER
);

1039 ià(
pwd
 =ð
NULL
) {

1040 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1041 "g‘pwÇm(\"" 
NGX_USER
 "\") failed");

1042  
NGX_CONF_ERROR
;

1045 
ccf
->
u£ºame
 = 
NGX_USER
;

1046 
ccf
->
u£r
 = 
pwd
->
pw_uid
;

1048 
	`ngx_£t_”ºo
(0);

1049 
g½
 = 
	`g‘gºam
(
NGX_GROUP
);

1050 ià(
g½
 =ð
NULL
) {

1051 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1052 "g‘gºam(\"" 
NGX_GROUP
 "\") failed");

1053  
NGX_CONF_ERROR
;

1056 
ccf
->
group
 = 
g½
->
gr_gid
;

1060 ià(
ccf
->
lock_fže
.
Ën
 == 0) {

1061 
	`ngx_¡r_£t
(&
ccf
->
lock_fže
, 
NGX_LOCK_PATH
);

1064 ià(
	`ngx_cÚf_fuÎ_Çme
(
cyþe
, &
ccf
->
lock_fže
, 0è!ð
NGX_OK
) {

1065  
NGX_CONF_ERROR
;

1069 
ngx_¡r_t
 
lock_fže
;

1071 
lock_fže
 = 
cyþe
->
Þd_cyþe
->lock_file;

1073 ià(
lock_fže
.
Ën
) {

1074 
lock_fže
.
Ën
--;

1076 ià(
ccf
->
lock_fže
.
Ën
 !=†ock_file.len

1077 || 
	`ngx_¡ºcmp
(
ccf
->
lock_fže
.
d©a
,†ock_fže.d©a,†ock_fže.
Ën
)

1080 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

1084 
cyþe
->
lock_fže
.
Ën
 =†ock_file.len + 1;

1085 
lock_fže
.
Ën
 += (".accept");

1087 
cyþe
->
lock_fže
.
d©a
 = 
	`ngx_p¡rdup
(cyþe->
poÞ
, &lock_file);

1088 ià(
cyþe
->
lock_fže
.
d©a
 =ð
NULL
) {

1089  
NGX_CONF_ERROR
;

1093 
cyþe
->
lock_fže
.
Ën
 = 
ccf
->lock_file.len + 1;

1094 
cyþe
->
lock_fže
.
d©a
 = 
	`ngx_²®loc
(cyþe->
poÞ
,

1095 
ccf
->
lock_fže
.
Ën
 + (".accept"));

1096 ià(
cyþe
->
lock_fže
.
d©a
 =ð
NULL
) {

1097  
NGX_CONF_ERROR
;

1100 
	`ngx_memýy
(
	`ngx_ýymem
(
cyþe
->
lock_fže
.
d©a
, 
ccf
->lock_file.data,

1101 
ccf
->
lock_fže
.
Ën
),

1108  
NGX_CONF_OK
;

1109 
	}
}

1113 
	$ngx_£t_u£r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1115 #ià(
NGX_WIN32
)

1117 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1120  
NGX_CONF_OK
;

1124 
ngx_cÜe_cÚf_t
 *
ccf
 = 
cÚf
;

1126 *
group
;

1127 
·sswd
 *
pwd
;

1128 
group
 *
g½
;

1129 
ngx_¡r_t
 *
v®ue
;

1131 ià(
ccf
->
u£r
 !ð(
uid_t
è
NGX_CONF_UNSET_UINT
) {

1135 ià(
	`g‘euid
() != 0) {

1136 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1140  
NGX_CONF_OK
;

1143 
v®ue
 = (
ngx_¡r_t
 *è
cf
->
¬gs
->
–ts
;

1145 
ccf
->
u£ºame
 = (*è
v®ue
[1].
d©a
;

1147 
	`ngx_£t_”ºo
(0);

1148 
pwd
 = 
	`g‘pwÇm
((cÚ¡ *è
v®ue
[1].
d©a
);

1149 ià(
pwd
 =ð
NULL
) {

1150 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 
ngx_”ºo
,

1151 "g‘pwÇm(\"%s\"èçžed", 
v®ue
[1].
d©a
);

1152  
NGX_CONF_ERROR
;

1155 
ccf
->
u£r
 = 
pwd
->
pw_uid
;

1157 
group
 = (*è((
cf
->
¬gs
->
ÃÉs
 =ð2è? 
v®ue
[1].
d©a
 : value[2].data);

1159 
	`ngx_£t_”ºo
(0);

1160 
g½
 = 
	`g‘gºam
(
group
);

1161 ià(
g½
 =ð
NULL
) {

1162 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 
ngx_”ºo
,

1163 "g‘gºam(\"%s\"èçžed", 
group
);

1164  
NGX_CONF_ERROR
;

1167 
ccf
->
group
 = 
g½
->
gr_gid
;

1169  
NGX_CONF_OK
;

1172 
	}
}

1176 
	$ngx_£t_’v
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1178 
ngx_cÜe_cÚf_t
 *
ccf
 = 
cÚf
;

1180 
ngx_¡r_t
 *
v®ue
, *
v¬
;

1181 
ngx_ušt_t
 
i
;

1183 
v¬
 = 
	`ngx_¬¿y_push
(&
ccf
->
’v
);

1184 ià(
v¬
 =ð
NULL
) {

1185  
NGX_CONF_ERROR
;

1188 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1189 *
v¬
 = 
v®ue
[1];

1191 
i
 = 0; i < 
v®ue
[1].
Ën
; i++) {

1193 ià(
v®ue
[1].
d©a
[
i
] == '=') {

1195 
v¬
->
Ën
 = 
i
;

1197  
NGX_CONF_OK
;

1201  
NGX_CONF_OK
;

1202 
	}
}

1206 
	$ngx_£t_´iÜ™y
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1208 
ngx_cÜe_cÚf_t
 *
ccf
 = 
cÚf
;

1210 
ngx_¡r_t
 *
v®ue
;

1211 
ngx_ušt_t
 
n
, 
mšus
;

1213 ià(
ccf
->
´iÜ™y
 != 0) {

1217 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1219 ià(
v®ue
[1].
d©a
[0] == '-') {

1220 
n
 = 1;

1221 
mšus
 = 1;

1223 } ià(
v®ue
[1].
d©a
[0] == '+') {

1224 
n
 = 1;

1225 
mšus
 = 0;

1228 
n
 = 0;

1229 
mšus
 = 0;

1232 
ccf
->
´iÜ™y
 = 
	`ngx_©oi
(&
v®ue
[1].
d©a
[
n
], v®ue[1].
Ën
 -‚);

1233 ià(
ccf
->
´iÜ™y
 =ð
NGX_ERROR
) {

1237 ià(
mšus
) {

1238 
ccf
->
´iÜ™y
 = -ccf->priority;

1241  
NGX_CONF_OK
;

1242 
	}
}

1246 
	$ngx_£t_ýu_affš™y
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1248 #ià(
NGX_HAVE_CPU_AFFINITY
)

1249 
ngx_cÜe_cÚf_t
 *
ccf
 = 
cÚf
;

1251 
u_ch¬
 
ch
;

1252 
ušt64_t
 *
mask
;

1253 
ngx_¡r_t
 *
v®ue
;

1254 
ngx_ušt_t
 
i
, 
n
;

1256 ià(
ccf
->
ýu_affš™y
) {

1260 
mask
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (cf->
¬gs
->
ÃÉs
 - 1è* (
ušt64_t
));

1261 ià(
mask
 =ð
NULL
) {

1262  
NGX_CONF_ERROR
;

1265 
ccf
->
ýu_affš™y_n
 = 
cf
->
¬gs
->
ÃÉs
 - 1;

1266 
ccf
->
ýu_affš™y
 = 
mask
;

1268 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1270 
n
 = 1;‚ < 
cf
->
¬gs
->
ÃÉs
;‚++) {

1272 ià(
v®ue
[
n
].
Ën
 > 64) {

1273 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1275  
NGX_CONF_ERROR
;

1278 
mask
[
n
 - 1] = 0;

1280 
i
 = 0; i < 
v®ue
[
n
].
Ën
; i++) {

1282 
ch
 = 
v®ue
[
n
].
d©a
[
i
];

1284 ià(
ch
 == ' ') {

1288 
mask
[
n
 - 1] <<= 1;

1290 ià(
ch
 == '0') {

1294 ià(
ch
 == '1') {

1295 
mask
[
n
 - 1] |= 1;

1299 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1301 
ch
);

1302  
NGX_CONF_ERROR
;

1308 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1313  
NGX_CONF_OK
;

1314 
	}
}

1317 
ušt64_t


1318 
	$ngx_g‘_ýu_affš™y
(
ngx_ušt_t
 
n
)

1320 
ngx_cÜe_cÚf_t
 *
ccf
;

1322 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
ngx_cyþe
->
cÚf_ùx
,

1323 
ngx_cÜe_moduË
);

1325 ià(
ccf
->
ýu_affš™y
 =ð
NULL
) {

1329 ià(
ccf
->
ýu_affš™y_n
 > 
n
) {

1330  
ccf
->
ýu_affš™y
[
n
];

1333  
ccf
->
ýu_affš™y
[ccf->
ýu_affš™y_n
 - 1];

1334 
	}
}

1338 
	$ngx_£t_wÜk”_´oûs£s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1340 
ngx_¡r_t
 *
v®ue
;

1341 
ngx_cÜe_cÚf_t
 *
ccf
;

1343 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
cÚf
;

1345 ià(
ccf
->
wÜk”_´oûs£s
 !ð
NGX_CONF_UNSET
) {

1349 
v®ue
 = (
ngx_¡r_t
 *è
cf
->
¬gs
->
–ts
;

1351 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "auto") == 0) {

1352 
ccf
->
wÜk”_´oûs£s
 = 
ngx_nýu
;

1353  
NGX_CONF_OK
;

1356 
ccf
->
wÜk”_´oûs£s
 = 
	`ngx_©oi
(
v®ue
[1].
d©a
, v®ue[1].
Ën
);

1358 ià(
ccf
->
wÜk”_´oûs£s
 =ð
NGX_ERROR
) {

1362  
NGX_CONF_OK
;

1363 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_array.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_¬¿y_t
 *

13 
	$ngx_¬¿y_ü—‹
(
ngx_poÞ_t
 *
p
, 
ngx_ušt_t
 
n
, 
size_t
 
size
)

15 
ngx_¬¿y_t
 *
a
;

17 
a
 = 
	`ngx_·Îoc
(
p
, (
ngx_¬¿y_t
));

18 ià(
a
 =ð
NULL
) {

19  
NULL
;

22 ià(
	`ngx_¬¿y_š™
(
a
, 
p
, 
n
, 
size
è!ð
NGX_OK
) {

23  
NULL
;

26  
a
;

27 
	}
}

31 
	$ngx_¬¿y_de¡roy
(
ngx_¬¿y_t
 *
a
)

33 
ngx_poÞ_t
 *
p
;

35 
p
 = 
a
->
poÞ
;

37 ià((
u_ch¬
 *è
a
->
–ts
 +‡->
size
 *‡->
ÇÎoc
 =ð
p
->
d
.
Ï¡
) {

38 
p
->
d
.
Ï¡
 -ð
a
->
size
 *‡->
ÇÎoc
;

41 ià((
u_ch¬
 *è
a
 + (
ngx_¬¿y_t
è=ð
p
->
d
.
Ï¡
) {

42 
p
->
d
.
Ï¡
 = (
u_ch¬
 *è
a
;

44 
	}
}

48 
	$ngx_¬¿y_push
(
ngx_¬¿y_t
 *
a
)

50 *
–t
, *
Ãw
;

51 
size_t
 
size
;

52 
ngx_poÞ_t
 *
p
;

54 ià(
a
->
ÃÉs
 =ða->
ÇÎoc
) {

58 
size
 = 
a
->siz*‡->
ÇÎoc
;

60 
p
 = 
a
->
poÞ
;

62 ià((
u_ch¬
 *è
a
->
–ts
 + 
size
 =ð
p
->
d
.
Ï¡


63 && 
p
->
d
.
Ï¡
 + 
a
->
size
 <ðp->d.
’d
)

70 
p
->
d
.
Ï¡
 +ð
a
->
size
;

71 
a
->
ÇÎoc
++;

76 
Ãw
 = 
	`ngx_·Îoc
(
p
, 2 * 
size
);

77 ià(
Ãw
 =ð
NULL
) {

78  
NULL
;

81 
	`ngx_memýy
(
Ãw
, 
a
->
–ts
, 
size
);

82 
a
->
–ts
 = 
Ãw
;

83 
a
->
ÇÎoc
 *= 2;

87 
–t
 = (
u_ch¬
 *è
a
->
–ts
 +‡->
size
 *‡->
ÃÉs
;

88 
a
->
ÃÉs
++;

90  
–t
;

91 
	}
}

95 
	$ngx_¬¿y_push_n
(
ngx_¬¿y_t
 *
a
, 
ngx_ušt_t
 
n
)

97 *
–t
, *
Ãw
;

98 
size_t
 
size
;

99 
ngx_ušt_t
 
ÇÎoc
;

100 
ngx_poÞ_t
 *
p
;

102 
size
 = 
n
 * 
a
->size;

104 ià(
a
->
ÃÉs
 + 
n
 >‡->
ÇÎoc
) {

108 
p
 = 
a
->
poÞ
;

110 ià((
u_ch¬
 *è
a
->
–ts
 +‡->
size
 *‡->
ÇÎoc
 =ð
p
->
d
.
Ï¡


111 && 
p
->
d
.
Ï¡
 + 
size
 <ðp->d.
’d
)

118 
p
->
d
.
Ï¡
 +ð
size
;

119 
a
->
ÇÎoc
 +ð
n
;

124 
ÇÎoc
 = 2 * ((
n
 >ð
a
->nalloc) ?‚ :‡->nalloc);

126 
Ãw
 = 
	`ngx_·Îoc
(
p
, 
ÇÎoc
 * 
a
->
size
);

127 ià(
Ãw
 =ð
NULL
) {

128  
NULL
;

131 
	`ngx_memýy
(
Ãw
, 
a
->
–ts
,‡->
ÃÉs
 *‡->
size
);

132 
a
->
–ts
 = 
Ãw
;

133 
a
->
ÇÎoc
 =‚alloc;

137 
–t
 = (
u_ch¬
 *è
a
->
–ts
 +‡->
size
 *‡->
ÃÉs
;

138 
a
->
ÃÉs
 +ð
n
;

140  
–t
;

141 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_buf.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_buf_t
 *

13 
	$ngx_ü—‹_‹mp_buf
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
)

15 
ngx_buf_t
 *
b
;

17 
b
 = 
	`ngx_ÿÎoc_buf
(
poÞ
);

18 ià(
b
 =ð
NULL
) {

19  
NULL
;

22 
b
->
¡¬t
 = 
	`ngx_·Îoc
(
poÞ
, 
size
);

23 ià(
b
->
¡¬t
 =ð
NULL
) {

24  
NULL
;

38 
b
->
pos
 = b->
¡¬t
;

39 
b
->
Ï¡
 = b->
¡¬t
;

40 
b
->
’d
 = b->
Ï¡
 + 
size
;

41 
b
->
‹mpÜ¬y
 = 1;

43  
b
;

44 
	}
}

47 
ngx_chaš_t
 *

48 
	$ngx_®loc_chaš_lšk
(
ngx_poÞ_t
 *
poÞ
)

50 
ngx_chaš_t
 *
þ
;

52 
þ
 = 
poÞ
->
chaš
;

54 ià(
þ
) {

55 
poÞ
->
chaš
 = 
þ
->
Ãxt
;

56  
þ
;

59 
þ
 = 
	`ngx_·Îoc
(
poÞ
, (
ngx_chaš_t
));

60 ià(
þ
 =ð
NULL
) {

61  
NULL
;

64  
þ
;

65 
	}
}

68 
ngx_chaš_t
 *

69 
	$ngx_ü—‹_chaš_of_bufs
(
ngx_poÞ_t
 *
poÞ
, 
ngx_bufs_t
 *
bufs
)

71 
u_ch¬
 *
p
;

72 
ngx_št_t
 
i
;

73 
ngx_buf_t
 *
b
;

74 
ngx_chaš_t
 *
chaš
, *
þ
, **
Î
;

76 
p
 = 
	`ngx_·Îoc
(
poÞ
, 
bufs
->
num
 * bufs->
size
);

77 ià(
p
 =ð
NULL
) {

78  
NULL
;

81 
Î
 = &
chaš
;

83 
i
 = 0; i < 
bufs
->
num
; i++) {

85 
b
 = 
	`ngx_ÿÎoc_buf
(
poÞ
);

86 ià(
b
 =ð
NULL
) {

87  
NULL
;

102 
b
->
pos
 = 
p
;

103 
b
->
Ï¡
 = 
p
;

104 
b
->
‹mpÜ¬y
 = 1;

106 
b
->
¡¬t
 = 
p
;

107 
p
 +ð
bufs
->
size
;

108 
b
->
’d
 = 
p
;

110 
þ
 = 
	`ngx_®loc_chaš_lšk
(
poÞ
);

111 ià(
þ
 =ð
NULL
) {

112  
NULL
;

115 
þ
->
buf
 = 
b
;

116 *
Î
 = 
þ
;

117 
Î
 = &
þ
->
Ãxt
;

120 *
Î
 = 
NULL
;

122  
chaš
;

123 
	}
}

126 
ngx_št_t


127 
	$ngx_chaš_add_cÝy
(
ngx_poÞ_t
 *
poÞ
, 
ngx_chaš_t
 **
chaš
,‚gx_chaš_ˆ*
š
)

129 
ngx_chaš_t
 *
þ
, **
Î
;

131 
Î
 = 
chaš
;

133 
þ
 = *
chaš
; cl; cÈðþ->
Ãxt
) {

134 
Î
 = &
þ
->
Ãxt
;

137 
š
) {

138 
þ
 = 
	`ngx_®loc_chaš_lšk
(
poÞ
);

139 ià(
þ
 =ð
NULL
) {

140  
NGX_ERROR
;

143 
þ
->
buf
 = 
š
->buf;

144 *
Î
 = 
þ
;

145 
Î
 = &
þ
->
Ãxt
;

146 
š
 = in->
Ãxt
;

149 *
Î
 = 
NULL
;

151  
NGX_OK
;

152 
	}
}

155 
ngx_chaš_t
 *

156 
	$ngx_chaš_g‘_ä“_buf
(
ngx_poÞ_t
 *
p
, 
ngx_chaš_t
 **
ä“
)

158 
ngx_chaš_t
 *
þ
;

160 ià(*
ä“
) {

161 
þ
 = *
ä“
;

162 *
ä“
 = 
þ
->
Ãxt
;

163 
þ
->
Ãxt
 = 
NULL
;

164  
þ
;

167 
þ
 = 
	`ngx_®loc_chaš_lšk
(
p
);

168 ià(
þ
 =ð
NULL
) {

169  
NULL
;

172 
þ
->
buf
 = 
	`ngx_ÿÎoc_buf
(
p
);

173 ià(
þ
->
buf
 =ð
NULL
) {

174  
NULL
;

177 
þ
->
Ãxt
 = 
NULL
;

179  
þ
;

180 
	}
}

184 
	$ngx_chaš_upd©e_chašs
(
ngx_poÞ_t
 *
p
, 
ngx_chaš_t
 **
ä“
,‚gx_chaš_ˆ**
busy
,

185 
ngx_chaš_t
 **
out
, 
ngx_buf_g_t
 
g
)

187 
ngx_chaš_t
 *
þ
;

189 ià(*
busy
 =ð
NULL
) {

190 *
busy
 = *
out
;

193 
þ
 = *
busy
; cl->
Ãxt
; cl = cl->next) { }

195 
þ
->
Ãxt
 = *
out
;

198 *
out
 = 
NULL
;

200 *
busy
) {

201 
þ
 = *
busy
;

203 ià(
	`ngx_buf_size
(
þ
->
buf
) != 0) {

207 ià(
þ
->
buf
->
g
 !=ag) {

208 *
busy
 = 
þ
->
Ãxt
;

209 
	`ngx_ä“_chaš
(
p
, 
þ
);

213 
þ
->
buf
->
pos
 = cl->buf->
¡¬t
;

214 
þ
->
buf
->
Ï¡
 = cl->buf->
¡¬t
;

216 *
busy
 = 
þ
->
Ãxt
;

217 
þ
->
Ãxt
 = *
ä“
;

218 *
ä“
 = 
þ
;

220 
	}
}

223 
off_t


224 
	$ngx_chaš_cßËsû_fže
(
ngx_chaš_t
 **
š
, 
off_t
 
lim™
)

226 
off_t
 
tÙ®
, 
size
, 
®igÃd
, 
å»v
;

227 
ngx_fd_t
 
fd
;

228 
ngx_chaš_t
 *
þ
;

230 
tÙ®
 = 0;

232 
þ
 = *
š
;

233 
fd
 = 
þ
->
buf
->
fže
->fd;

236 
size
 = 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
;

238 ià(
size
 > 
lim™
 - 
tÙ®
) {

239 
size
 = 
lim™
 - 
tÙ®
;

241 
®igÃd
 = (
þ
->
buf
->
fže_pos
 + 
size
 + 
ngx_·gesize
 - 1)

242 & ~((
off_t
è
ngx_·gesize
 - 1);

244 ià(
®igÃd
 <ð
þ
->
buf
->
fže_Ï¡
) {

245 
size
 = 
®igÃd
 - 
þ
->
buf
->
fže_pos
;

249 
tÙ®
 +ð
size
;

250 
å»v
 = 
þ
->
buf
->
fže_pos
 + 
size
;

251 
þ
 = cl->
Ãxt
;

253 } 
þ


254 && 
þ
->
buf
->
š_fže


255 && 
tÙ®
 < 
lim™


256 && 
fd
 =ð
þ
->
buf
->
fže
->fd

257 && 
å»v
 =ð
þ
->
buf
->
fže_pos
);

259 *
š
 = 
þ
;

261  
tÙ®
;

262 
	}
}

265 
ngx_chaš_t
 *

266 
	$ngx_chaš_upd©e_£Á
(
ngx_chaš_t
 *
š
, 
off_t
 
£Á
)

268 
off_t
 
size
;

270  ; 
š
; iÀðš->
Ãxt
) {

272 ià(
	`ngx_buf_¥ecŸl
(
š
->
buf
)) {

276 ià(
£Á
 == 0) {

280 
size
 = 
	`ngx_buf_size
(
š
->
buf
);

282 ià(
£Á
 >ð
size
) {

283 
£Á
 -ð
size
;

285 ià(
	`ngx_buf_š_memÜy
(
š
->
buf
)) {

286 
š
->
buf
->
pos
 = in->buf->
Ï¡
;

289 ià(
š
->
buf
->
š_fže
) {

290 
š
->
buf
->
fže_pos
 = in->buf->
fže_Ï¡
;

296 ià(
	`ngx_buf_š_memÜy
(
š
->
buf
)) {

297 
š
->
buf
->
pos
 +ð(
size_t
è
£Á
;

300 ià(
š
->
buf
->
š_fže
) {

301 
š
->
buf
->
fže_pos
 +ð
£Á
;

307  
š
;

308 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_conf_file.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

11 
	#NGX_CONF_BUFFER
 4096

	)

13 
ngx_št_t
 
ngx_cÚf_hªdËr
(
ngx_cÚf_t
 *
cf
,‚gx_št_ˆ
Ï¡
);

14 
ngx_št_t
 
ngx_cÚf_»ad_tok’
(
ngx_cÚf_t
 *
cf
);

15 
ngx_cÚf_æush_fžes
(
ngx_cyþe_t
 *
cyþe
);

18 
ngx_commªd_t
 
	gngx_cÚf_commªds
[] = {

20 { 
ngx_¡ršg
("include"),

21 
NGX_ANY_CONF
|
NGX_CONF_TAKE1
,

22 
ngx_cÚf_šþude
,

25 
NULL
 },

27 
ngx_nuÎ_commªd


31 
ngx_moduË_t
 
	gngx_cÚf_moduË
 = {

32 
NGX_MODULE_V1
,

33 
NULL
,

34 
ngx_cÚf_commªds
,

35 
NGX_CONF_MODULE
,

36 
NULL
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
NULL
,

41 
ngx_cÚf_æush_fžes
,

42 
NULL
,

43 
NGX_MODULE_V1_PADDING


49 
ngx_ušt_t
 
	g¬gum’t_numb”
[] = {

50 
NGX_CONF_NOARGS
,

51 
NGX_CONF_TAKE1
,

52 
NGX_CONF_TAKE2
,

53 
NGX_CONF_TAKE3
,

54 
NGX_CONF_TAKE4
,

55 
NGX_CONF_TAKE5
,

56 
NGX_CONF_TAKE6
,

57 
NGX_CONF_TAKE7


62 
	$ngx_cÚf_·¿m
(
ngx_cÚf_t
 *
cf
)

64 *
rv
;

65 
ngx_¡r_t
 *
·¿m
;

66 
ngx_buf_t
 
b
;

67 
ngx_cÚf_fže_t
 
cÚf_fže
;

69 
·¿m
 = &
cf
->
cyþe
->
cÚf_·¿m
;

71 ià(
·¿m
->
Ën
 == 0) {

72  
NGX_CONF_OK
;

75 
	`ngx_memz”o
(&
cÚf_fže
, (
ngx_cÚf_fže_t
));

77 
	`ngx_memz”o
(&
b
, (
ngx_buf_t
));

79 
b
.
¡¬t
 = 
·¿m
->
d©a
;

80 
b
.
pos
 = 
·¿m
->
d©a
;

81 
b
.
Ï¡
 = 
·¿m
->
d©a
 +…¬am->
Ën
;

82 
b
.
’d
 = b.
Ï¡
;

83 
b
.
‹mpÜ¬y
 = 1;

85 
cÚf_fže
.
fže
.
fd
 = 
NGX_INVALID_FILE
;

86 
cÚf_fže
.
fže
.
Çme
.
d©a
 = 
NULL
;

87 
cÚf_fže
.
lše
 = 0;

89 
cf
->
cÚf_fže
 = &conf_file;

90 
cf
->
cÚf_fže
->
bufãr
 = &
b
;

92 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

94 
cf
->
cÚf_fže
 = 
NULL
;

96  
rv
;

97 
	}
}

101 
	$ngx_cÚf_·r£
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
fž’ame
)

103 *
rv
;

104 
ngx_fd_t
 
fd
;

105 
ngx_št_t
 
rc
;

106 
ngx_buf_t
 
buf
;

107 
ngx_cÚf_fže_t
 *
´ev
, 
cÚf_fže
;

109 
·r£_fže
 = 0,

110 
·r£_block
,

111 
·r£_·¿m


112 } 
ty³
;

114 #ià(
NGX_SUPPRESS_WARN
)

115 
fd
 = 
NGX_INVALID_FILE
;

116 
´ev
 = 
NULL
;

119 ià(
fž’ame
) {

123 
fd
 = 
	`ngx_Ý’_fže
(
fž’ame
->
d©a
, 
NGX_FILE_RDONLY
, 
NGX_FILE_OPEN
, 0);

124 ià(
fd
 =ð
NGX_INVALID_FILE
) {

125 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 
ngx_”ºo
,

126 
ngx_Ý’_fže_n
 " \"%s\" failed",

127 
fž’ame
->
d©a
);

128  
NGX_CONF_ERROR
;

131 
´ev
 = 
cf
->
cÚf_fže
;

133 
cf
->
cÚf_fže
 = &conf_file;

135 ià(
	`ngx_fd_šfo
(
fd
, &
cf
->
cÚf_fže
->
fže
.
šfo
è=ð
NGX_FILE_ERROR
) {

136 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 
ngx_”ºo
,

137 
ngx_fd_šfo_n
 " \"%s\" fažed", 
fž’ame
->
d©a
);

140 
cf
->
cÚf_fže
->
bufãr
 = &
buf
;

142 
buf
.
¡¬t
 = 
	`ngx_®loc
(
NGX_CONF_BUFFER
, 
cf
->
log
);

143 ià(
buf
.
¡¬t
 =ð
NULL
) {

144 
çžed
;

147 
buf
.
pos
 = buf.
¡¬t
;

148 
buf
.
Ï¡
 = buf.
¡¬t
;

149 
buf
.
’d
 = buf.
Ï¡
 + 
NGX_CONF_BUFFER
;

150 
buf
.
‹mpÜ¬y
 = 1;

152 
cf
->
cÚf_fže
->
fže
.
fd
 = fd;

153 
cf
->
cÚf_fže
->
fže
.
Çme
.
Ën
 = 
fž’ame
->len;

154 
cf
->
cÚf_fže
->
fže
.
Çme
.
d©a
 = 
fž’ame
->data;

155 
cf
->
cÚf_fže
->
fže
.
off£t
 = 0;

156 
cf
->
cÚf_fže
->
fže
.
log
 = cf->log;

157 
cf
->
cÚf_fže
->
lše
 = 1;

159 
ty³
 = 
·r£_fže
;

161 } ià(
cf
->
cÚf_fže
->
fže
.
fd
 !ð
NGX_INVALID_FILE
) {

163 
ty³
 = 
·r£_block
;

166 
ty³
 = 
·r£_·¿m
;

171 
rc
 = 
	`ngx_cÚf_»ad_tok’
(
cf
);

183 ià(
rc
 =ð
NGX_ERROR
) {

184 
dÚe
;

187 ià(
rc
 =ð
NGX_CONF_BLOCK_DONE
) {

189 ià(
ty³
 !ð
·r£_block
) {

190 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "unexpected \"}\"");

191 
çžed
;

194 
dÚe
;

197 ià(
rc
 =ð
NGX_CONF_FILE_DONE
) {

199 ià(
ty³
 =ð
·r£_block
) {

200 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

202 
çžed
;

205 
dÚe
;

208 ià(
rc
 =ð
NGX_CONF_BLOCK_START
) {

210 ià(
ty³
 =ð
·r£_·¿m
) {

211 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

214 
çžed
;

220 ià(
cf
->
hªdËr
) {

227 ià(
rc
 =ð
NGX_CONF_BLOCK_START
) {

228 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "unexpected \"{\"");

229 
çžed
;

232 
rv
 = (*
cf
->
hªdËr
)(cf, 
NULL
, cf->
hªdËr_cÚf
);

233 ià(
rv
 =ð
NGX_CONF_OK
) {

237 ià(
rv
 =ð
NGX_CONF_ERROR
) {

238 
çžed
;

241 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, 
rv
);

243 
çžed
;

247 
rc
 = 
	`ngx_cÚf_hªdËr
(
cf
,„c);

249 ià(
rc
 =ð
NGX_ERROR
) {

250 
çžed
;

254 
çžed
:

256 
rc
 = 
NGX_ERROR
;

258 
dÚe
:

260 ià(
fž’ame
) {

261 ià(
cf
->
cÚf_fže
->
bufãr
->
¡¬t
) {

262 
	`ngx_ä“
(
cf
->
cÚf_fže
->
bufãr
->
¡¬t
);

265 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

266 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

267 
ngx_þo£_fže_n
 " %s failed",

268 
fž’ame
->
d©a
);

269 
rc
 = 
NGX_ERROR
;

272 
cf
->
cÚf_fže
 = 
´ev
;

275 ià(
rc
 =ð
NGX_ERROR
) {

276  
NGX_CONF_ERROR
;

279  
NGX_CONF_OK
;

280 
	}
}

283 
ngx_št_t


284 
	$ngx_cÚf_hªdËr
(
ngx_cÚf_t
 *
cf
, 
ngx_št_t
 
Ï¡
)

286 *
rv
;

287 *
cÚf
, **
cÚå
;

288 
ngx_ušt_t
 
i
, 
found
;

289 
ngx_¡r_t
 *
Çme
;

290 
ngx_commªd_t
 *
cmd
;

292 
Çme
 = 
cf
->
¬gs
->
–ts
;

294 
found
 = 0;

296 
i
 = 0; 
ngx_moduËs
[i]; i++) {

298 
cmd
 = 
ngx_moduËs
[
i
]->
commªds
;

299 ià(
cmd
 =ð
NULL
) {

303  ; 
cmd
->
Çme
.
Ën
; cmd++) {

305 ià(
Çme
->
Ën
 !ð
cmd
->name.len) {

309 ià(
	`ngx_¡rcmp
(
Çme
->
d©a
, 
cmd
->name.data) != 0) {

313 
found
 = 1;

315 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_CONF_MODULE


316 && 
ngx_moduËs
[
i
]->
ty³
 !ð
cf
->
moduË_ty³
)

323 ià(!(
cmd
->
ty³
 & 
cf
->
cmd_ty³
)) {

327 ià(!(
cmd
->
ty³
 & 
NGX_CONF_BLOCK
è&& 
Ï¡
 !ð
NGX_OK
) {

328 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

330 
Çme
->
d©a
);

331  
NGX_ERROR
;

334 ià((
cmd
->
ty³
 & 
NGX_CONF_BLOCK
è&& 
Ï¡
 !ð
NGX_CONF_BLOCK_START
) {

335 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

337 
Çme
->
d©a
);

338  
NGX_ERROR
;

343 ià(!(
cmd
->
ty³
 & 
NGX_CONF_ANY
)) {

345 ià(
cmd
->
ty³
 & 
NGX_CONF_FLAG
) {

347 ià(
cf
->
¬gs
->
ÃÉs
 != 2) {

348 
šv®id
;

351 } ià(
cmd
->
ty³
 & 
NGX_CONF_1MORE
) {

353 ià(
cf
->
¬gs
->
ÃÉs
 < 2) {

354 
šv®id
;

357 } ià(
cmd
->
ty³
 & 
NGX_CONF_2MORE
) {

359 ià(
cf
->
¬gs
->
ÃÉs
 < 3) {

360 
šv®id
;

363 } ià(
cf
->
¬gs
->
ÃÉs
 > 
NGX_CONF_MAX_ARGS
) {

365 
šv®id
;

367 } ià(!(
cmd
->
ty³
 & 
¬gum’t_numb”
[
cf
->
¬gs
->
ÃÉs
 - 1]))

369 
šv®id
;

375 
cÚf
 = 
NULL
;

377 ià(
cmd
->
ty³
 & 
NGX_DIRECT_CONF
) {

378 
cÚf
 = ((**è
cf
->
ùx
)[
ngx_moduËs
[
i
]->
šdex
];

380 } ià(
cmd
->
ty³
 & 
NGX_MAIN_CONF
) {

381 
cÚf
 = &(((**è
cf
->
ùx
)[
ngx_moduËs
[
i
]->
šdex
]);

383 } ià(
cf
->
ùx
) {

384 
cÚå
 = *(**è((*è
cf
->
ùx
 + 
cmd
->
cÚf
);

386 ià(
cÚå
) {

387 
cÚf
 = 
cÚå
[
ngx_moduËs
[
i
]->
ùx_šdex
];

391 
rv
 = 
cmd
->
	`£t
(
cf
, cmd, 
cÚf
);

393 ià(
rv
 =ð
NGX_CONF_OK
) {

394  
NGX_OK
;

397 ià(
rv
 =ð
NGX_CONF_ERROR
) {

398  
NGX_ERROR
;

401 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

402 "\"%s\" dœeùiv%s", 
Çme
->
d©a
, 
rv
);

404  
NGX_ERROR
;

408 ià(
found
) {

409 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

410 "\"%s\" dœeùivi nÙ‡Îowed h”e", 
Çme
->
d©a
);

412  
NGX_ERROR
;

415 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

416 "unknowÀdœeùiv\"%s\"", 
Çme
->
d©a
);

418  
NGX_ERROR
;

420 
šv®id
:

422 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

424 
Çme
->
d©a
);

426  
NGX_ERROR
;

427 
	}
}

430 
ngx_št_t


431 
	$ngx_cÚf_»ad_tok’
(
ngx_cÚf_t
 *
cf
)

433 
u_ch¬
 *
¡¬t
, 
ch
, *
¤c
, *
d¡
;

434 
off_t
 
fže_size
;

435 
size_t
 
Ën
;

436 
ssize_t
 
n
, 
size
;

437 
ngx_ušt_t
 
found
, 
Ãed_¥aû
, 
Ï¡_¥aû
, 
sh¬p_comm’t
, 
v¬ŸbË
;

438 
ngx_ušt_t
 
quÙed
, 
s_quÙed
, 
d_quÙed
, 
¡¬t_lše
;

439 
ngx_¡r_t
 *
wÜd
;

440 
ngx_buf_t
 *
b
;

442 
found
 = 0;

443 
Ãed_¥aû
 = 0;

444 
Ï¡_¥aû
 = 1;

445 
sh¬p_comm’t
 = 0;

446 
v¬ŸbË
 = 0;

447 
quÙed
 = 0;

448 
s_quÙed
 = 0;

449 
d_quÙed
 = 0;

451 
cf
->
¬gs
->
ÃÉs
 = 0;

452 
b
 = 
cf
->
cÚf_fže
->
bufãr
;

453 
¡¬t
 = 
b
->
pos
;

454 
¡¬t_lše
 = 
cf
->
cÚf_fže
->
lše
;

456 
fže_size
 = 
	`ngx_fže_size
(&
cf
->
cÚf_fže
->
fže
.
šfo
);

460 ià(
b
->
pos
 >ðb->
Ï¡
) {

462 ià(
cf
->
cÚf_fže
->
fže
.
off£t
 >ð
fže_size
) {

464 ià(
cf
->
¬gs
->
ÃÉs
 > 0 || !
Ï¡_¥aû
) {

466 ià(
cf
->
cÚf_fže
->
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

467 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

470  
NGX_ERROR
;

473 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

476  
NGX_ERROR
;

479  
NGX_CONF_FILE_DONE
;

482 
Ën
 = 
b
->
pos
 - 
¡¬t
;

484 ià(
Ën
 =ð
NGX_CONF_BUFFER
) {

485 
cf
->
cÚf_fže
->
lše
 = 
¡¬t_lše
;

487 ià(
d_quÙed
) {

488 
ch
 = '"';

490 } ià(
s_quÙed
) {

491 
ch
 = '\'';

494 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

496 10, 
¡¬t
);

497  
NGX_ERROR
;

500 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

502 "missšg”mš©šg \"%c\" ch¬aù”", 
ch
);

503  
NGX_ERROR
;

506 ià(
Ën
) {

507 
	`ngx_memmove
(
b
->
¡¬t
, s¹, 
Ën
);

510 
size
 = (
ssize_t
è(
fže_size
 - 
cf
->
cÚf_fže
->
fže
.
off£t
);

512 ià(
size
 > 
b
->
’d
 - (b->
¡¬t
 + 
Ën
)) {

513 
size
 = 
b
->
’d
 - (b->
¡¬t
 + 
Ën
);

516 
n
 = 
	`ngx_»ad_fže
(&
cf
->
cÚf_fže
->
fže
, 
b
->
¡¬t
 + 
Ën
, 
size
,

517 
cf
->
cÚf_fže
->
fže
.
off£t
);

519 ià(
n
 =ð
NGX_ERROR
) {

520  
NGX_ERROR
;

523 ià(
n
 !ð
size
) {

524 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

525 
ngx_»ad_fže_n
 "„eturned "

527 
n
, 
size
);

528  
NGX_ERROR
;

531 
b
->
pos
 = b->
¡¬t
 + 
Ën
;

532 
b
->
Ï¡
 = b->
pos
 + 
n
;

533 
¡¬t
 = 
b
->start;

536 
ch
 = *
b
->
pos
++;

538 ià(
ch
 =ð
LF
) {

539 
cf
->
cÚf_fže
->
lše
++;

541 ià(
sh¬p_comm’t
) {

542 
sh¬p_comm’t
 = 0;

546 ià(
sh¬p_comm’t
) {

550 ià(
quÙed
) {

551 
quÙed
 = 0;

555 ià(
Ãed_¥aû
) {

556 ià(
ch
 =ð' ' || ch =ð'\t' || ch =ð
CR
 || ch =ð
LF
) {

557 
Ï¡_¥aû
 = 1;

558 
Ãed_¥aû
 = 0;

562 ià(
ch
 == ';') {

563  
NGX_OK
;

566 ià(
ch
 == '{') {

567  
NGX_CONF_BLOCK_START
;

570 ià(
ch
 == ')') {

571 
Ï¡_¥aû
 = 1;

572 
Ãed_¥aû
 = 0;

575 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

576 "uÃx³ùed \"%c\"", 
ch
);

577  
NGX_ERROR
;

581 ià(
Ï¡_¥aû
) {

582 ià(
ch
 =ð' ' || ch =ð'\t' || ch =ð
CR
 || ch =ð
LF
) {

586 
¡¬t
 = 
b
->
pos
 - 1;

587 
¡¬t_lše
 = 
cf
->
cÚf_fže
->
lše
;

589 
ch
) {

593 ià(
cf
->
¬gs
->
ÃÉs
 == 0) {

594 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

595 "uÃx³ùed \"%c\"", 
ch
);

596  
NGX_ERROR
;

599 ià(
ch
 == '{') {

600  
NGX_CONF_BLOCK_START
;

603  
NGX_OK
;

606 ià(
cf
->
¬gs
->
ÃÉs
 != 0) {

607 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

609  
NGX_ERROR
;

612  
NGX_CONF_BLOCK_DONE
;

615 
sh¬p_comm’t
 = 1;

619 
quÙed
 = 1;

620 
Ï¡_¥aû
 = 0;

624 
¡¬t
++;

625 
d_quÙed
 = 1;

626 
Ï¡_¥aû
 = 0;

630 
¡¬t
++;

631 
s_quÙed
 = 1;

632 
Ï¡_¥aû
 = 0;

636 
Ï¡_¥aû
 = 0;

640 ià(
ch
 =ð'{' && 
v¬ŸbË
) {

644 
v¬ŸbË
 = 0;

646 ià(
ch
 == '\\') {

647 
quÙed
 = 1;

651 ià(
ch
 == '$') {

652 
v¬ŸbË
 = 1;

656 ià(
d_quÙed
) {

657 ià(
ch
 == '"') {

658 
d_quÙed
 = 0;

659 
Ãed_¥aû
 = 1;

660 
found
 = 1;

663 } ià(
s_quÙed
) {

664 ià(
ch
 == '\'') {

665 
s_quÙed
 = 0;

666 
Ãed_¥aû
 = 1;

667 
found
 = 1;

670 } ià(
ch
 =ð' ' || ch =ð'\t' || ch =ð
CR
 || ch =ð
LF


671 || 
ch
 == ';' || ch == '{')

673 
Ï¡_¥aû
 = 1;

674 
found
 = 1;

677 ià(
found
) {

678 
wÜd
 = 
	`ngx_¬¿y_push
(
cf
->
¬gs
);

679 ià(
wÜd
 =ð
NULL
) {

680  
NGX_ERROR
;

683 
wÜd
->
d©a
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
b
->
pos
 - 
¡¬t
 + 1);

684 ià(
wÜd
->
d©a
 =ð
NULL
) {

685  
NGX_ERROR
;

688 
d¡
 = 
wÜd
->
d©a
, 
¤c
 = 
¡¬t
, 
Ën
 = 0;

689 
¤c
 < 
b
->
pos
 - 1;

690 
Ën
++)

692 ià(*
¤c
 == '\\') {

693 
¤c
[1]) {

697 
¤c
++;

701 *
d¡
++ = '\t';

702 
¤c
 += 2;

706 *
d¡
++ = '\r';

707 
¤c
 += 2;

711 *
d¡
++ = '\n';

712 
¤c
 += 2;

717 *
d¡
++ = *
¤c
++;

719 *
d¡
 = '\0';

720 
wÜd
->
Ën
 =†en;

722 ià(
ch
 == ';') {

723  
NGX_OK
;

726 ià(
ch
 == '{') {

727  
NGX_CONF_BLOCK_START
;

730 
found
 = 0;

734 
	}
}

738 
	$ngx_cÚf_šþude
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

740 *
rv
;

741 
ngx_št_t
 
n
;

742 
ngx_¡r_t
 *
v®ue
, 
fže
, 
Çme
;

743 
ngx_glob_t
 
gl
;

745 
v®ue
 = 
cf
->
¬gs
->
–ts
;

746 
fže
 = 
v®ue
[1];

748 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cf
->
log
, 0, "šþud%s", 
fže
.
d©a
);

750 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
fže
, 1è!ð
NGX_OK
) {

751  
NGX_CONF_ERROR
;

754 ià(
	`¡½brk
((*è
fže
.
d©a
, "*?["è=ð
NULL
) {

756 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cf
->
log
, 0, "šþud%s", 
fže
.
d©a
);

758  
	`ngx_cÚf_·r£
(
cf
, &
fže
);

761 
	`ngx_memz”o
(&
gl
, (
ngx_glob_t
));

763 
gl
.
·‰”n
 = 
fže
.
d©a
;

764 
gl
.
log
 = 
cf
->log;

765 
gl
.
‹¡
 = 1;

767 ià(
	`ngx_Ý’_glob
(&
gl
è!ð
NGX_OK
) {

768 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 
ngx_”ºo
,

769 
ngx_Ý’_glob_n
 " \"%s\" fažed", 
fže
.
d©a
);

770  
NGX_CONF_ERROR
;

773 
rv
 = 
NGX_CONF_OK
;

776 
n
 = 
	`ngx_»ad_glob
(&
gl
, &
Çme
);

778 ià(
n
 !ð
NGX_OK
) {

782 
fže
.
Ën
 = 
Çme
.len++;

783 
fže
.
d©a
 = 
	`ngx_p¡rdup
(
cf
->
poÞ
, &
Çme
);

784 ià(
fže
.
d©a
 =ð
NULL
) {

785  
NGX_CONF_ERROR
;

788 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cf
->
log
, 0, "šþud%s", 
fže
.
d©a
);

790 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, &
fže
);

792 ià(
rv
 !ð
NGX_CONF_OK
) {

797 
	`ngx_þo£_glob
(&
gl
);

799  
rv
;

800 
	}
}

803 
ngx_št_t


804 
	$ngx_cÚf_fuÎ_Çme
(
ngx_cyþe_t
 *
cyþe
, 
ngx_¡r_t
 *
Çme
, 
ngx_ušt_t
 
cÚf_´efix
)

806 
ngx_¡r_t
 *
´efix
;

808 
´efix
 = 
cÚf_´efix
 ? &
cyþe
->conf_prefix : &cycle->prefix;

810  
	`ngx_g‘_fuÎ_Çme
(
cyþe
->
poÞ
, 
´efix
, 
Çme
);

811 
	}
}

814 
ngx_Ý’_fže_t
 *

815 
	$ngx_cÚf_Ý’_fže
(
ngx_cyþe_t
 *
cyþe
, 
ngx_¡r_t
 *
Çme
)

817 
ngx_¡r_t
 
fuÎ
;

818 
ngx_ušt_t
 
i
;

819 
ngx_li¡_·¹_t
 *
·¹
;

820 
ngx_Ý’_fže_t
 *
fže
;

822 #ià(
NGX_SUPPRESS_WARN
)

823 
	`ngx_¡r_nuÎ
(&
fuÎ
);

826 ià(
Çme
->
Ën
) {

827 
fuÎ
 = *
Çme
;

829 ià(
	`ngx_cÚf_fuÎ_Çme
(
cyþe
, &
fuÎ
, 0è!ð
NGX_OK
) {

830  
NULL
;

833 
·¹
 = &
cyþe
->
Ý’_fžes
.part;

834 
fže
 = 
·¹
->
–ts
;

836 
i
 = 0; ; i++) {

838 ià(
i
 >ð
·¹
->
ÃÉs
) {

839 ià(
·¹
->
Ãxt
 =ð
NULL
) {

842 
·¹
 =…¬t->
Ãxt
;

843 
fže
 = 
·¹
->
–ts
;

844 
i
 = 0;

847 ià(
fuÎ
.
Ën
 !ð
fže
[
i
].
Çme
.len) {

851 ià(
	`ngx_¡rcmp
(
fuÎ
.
d©a
, 
fže
[
i
].
Çme
.data) == 0) {

852  &
fže
[
i
];

857 
fže
 = 
	`ngx_li¡_push
(&
cyþe
->
Ý’_fžes
);

858 ià(
fže
 =ð
NULL
) {

859  
NULL
;

862 ià(
Çme
->
Ën
) {

863 
fže
->
fd
 = 
NGX_INVALID_FILE
;

864 
fže
->
Çme
 = 
fuÎ
;

867 
fže
->
fd
 = 
ngx_¡d”r
;

868 
fže
->
Çme
 = *name;

871 
fže
->
æush
 = 
NULL
;

872 
fže
->
d©a
 = 
NULL
;

874  
fže
;

875 
	}
}

879 
	$ngx_cÚf_æush_fžes
(
ngx_cyþe_t
 *
cyþe
)

881 
ngx_ušt_t
 
i
;

882 
ngx_li¡_·¹_t
 *
·¹
;

883 
ngx_Ý’_fže_t
 *
fže
;

885 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0, "flush files");

887 
·¹
 = &
cyþe
->
Ý’_fžes
.part;

888 
fže
 = 
·¹
->
–ts
;

890 
i
 = 0; ; i++) {

892 ià(
i
 >ð
·¹
->
ÃÉs
) {

893 ià(
·¹
->
Ãxt
 =ð
NULL
) {

896 
·¹
 =…¬t->
Ãxt
;

897 
fže
 = 
·¹
->
–ts
;

898 
i
 = 0;

901 ià(
fže
[
i
].
æush
) {

902 
fže
[
i
].
	`æush
(&fže[i], 
cyþe
->
log
);

905 
	}
}

908 
ngx_cdeþ


909 
	$ngx_cÚf_log_”rÜ
(
ngx_ušt_t
 
Ëv–
, 
ngx_cÚf_t
 *
cf
, 
ngx_”r_t
 
”r
,

910 cÚ¡ *
fmt
, ...)

912 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
], *
p
, *
Ï¡
;

913 
va_li¡
 
¬gs
;

915 
Ï¡
 = 
”r¡r
 + 
NGX_MAX_CONF_ERRSTR
;

917 
	`va_¡¬t
(
¬gs
, 
fmt
);

918 
p
 = 
	`ngx_v¦´štf
(
”r¡r
, 
Ï¡
, 
fmt
, 
¬gs
);

919 
	`va_’d
(
¬gs
);

921 ià(
”r
) {

922 
p
 = 
	`ngx_log_”ºo
Õ, 
Ï¡
, 
”r
);

925 ià(
cf
->
cÚf_fže
 =ð
NULL
) {

926 
	`ngx_log_”rÜ
(
Ëv–
, 
cf
->
log
, 0, "%*s", 
p
 - 
”r¡r
,ƒrrstr);

930 ià(
cf
->
cÚf_fže
->
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

931 
	`ngx_log_”rÜ
(
Ëv–
, 
cf
->
log
, 0, "%*s in command†ine",

932 
p
 - 
”r¡r
,ƒrrstr);

936 
	`ngx_log_”rÜ
(
Ëv–
, 
cf
->
log
, 0, "%*s in %s:%ui",

937 
p
 - 
”r¡r
,ƒrrstr,

938 
cf
->
cÚf_fže
->
fže
.
Çme
.
d©a
, cf->cÚf_fže->
lše
);

939 
	}
}

943 
	$ngx_cÚf_£t_æag_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

945 *
p
 = 
cÚf
;

947 
ngx_¡r_t
 *
v®ue
;

948 
ngx_æag_t
 *
å
;

949 
ngx_cÚf_po¡_t
 *
po¡
;

951 
å
 = (
ngx_æag_t
 *è(
p
 + 
cmd
->
off£t
);

953 ià(*
å
 !ð
NGX_CONF_UNSET
) {

957 
v®ue
 = 
cf
->
¬gs
->
–ts
;

959 ià(
	`ngx_¡rÿ£cmp
(
v®ue
[1].
d©a
, (
u_ch¬
 *) "on") == 0) {

960 *
å
 = 1;

962 } ià(
	`ngx_¡rÿ£cmp
(
v®ue
[1].
d©a
, (
u_ch¬
 *) "off") == 0) {

963 *
å
 = 0;

966 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

969 
v®ue
[1].
d©a
, 
cmd
->
Çme
.data);

970  
NGX_CONF_ERROR
;

973 ià(
cmd
->
po¡
) {

974 
po¡
 = 
cmd
->post;

975  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
å
);

978  
NGX_CONF_OK
;

979 
	}
}

983 
	$ngx_cÚf_£t_¡r_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

985 *
p
 = 
cÚf
;

987 
ngx_¡r_t
 *
f›ld
, *
v®ue
;

988 
ngx_cÚf_po¡_t
 *
po¡
;

990 
f›ld
 = (
ngx_¡r_t
 *è(
p
 + 
cmd
->
off£t
);

992 ià(
f›ld
->
d©a
) {

996 
v®ue
 = 
cf
->
¬gs
->
–ts
;

998 *
f›ld
 = 
v®ue
[1];

1000 ià(
cmd
->
po¡
) {

1001 
po¡
 = 
cmd
->post;

1002  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
f›ld
);

1005  
NGX_CONF_OK
;

1006 
	}
}

1010 
	$ngx_cÚf_£t_¡r_¬¿y_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1012 *
p
 = 
cÚf
;

1014 
ngx_¡r_t
 *
v®ue
, *
s
;

1015 
ngx_¬¿y_t
 **
a
;

1016 
ngx_cÚf_po¡_t
 *
po¡
;

1018 
a
 = (
ngx_¬¿y_t
 **è(
p
 + 
cmd
->
off£t
);

1020 ià(*
a
 =ð
NGX_CONF_UNSET_PTR
) {

1021 *
a
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4, (
ngx_¡r_t
));

1022 ià(*
a
 =ð
NULL
) {

1023  
NGX_CONF_ERROR
;

1027 
s
 = 
	`ngx_¬¿y_push
(*
a
);

1028 ià(
s
 =ð
NULL
) {

1029  
NGX_CONF_ERROR
;

1032 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1034 *
s
 = 
v®ue
[1];

1036 ià(
cmd
->
po¡
) {

1037 
po¡
 = 
cmd
->post;

1038  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
s
);

1041  
NGX_CONF_OK
;

1042 
	}
}

1046 
	$ngx_cÚf_£t_keyv®_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1048 *
p
 = 
cÚf
;

1050 
ngx_¡r_t
 *
v®ue
;

1051 
ngx_¬¿y_t
 **
a
;

1052 
ngx_keyv®_t
 *
kv
;

1053 
ngx_cÚf_po¡_t
 *
po¡
;

1055 
a
 = (
ngx_¬¿y_t
 **è(
p
 + 
cmd
->
off£t
);

1057 ià(*
a
 =ð
NULL
) {

1058 *
a
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4, (
ngx_keyv®_t
));

1059 ià(*
a
 =ð
NULL
) {

1060  
NGX_CONF_ERROR
;

1064 
kv
 = 
	`ngx_¬¿y_push
(*
a
);

1065 ià(
kv
 =ð
NULL
) {

1066  
NGX_CONF_ERROR
;

1069 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1071 
kv
->
key
 = 
v®ue
[1];

1072 
kv
->
v®ue
 = value[2];

1074 ià(
cmd
->
po¡
) {

1075 
po¡
 = 
cmd
->post;

1076  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
kv
);

1079  
NGX_CONF_OK
;

1080 
	}
}

1084 
	$ngx_cÚf_£t_num_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1086 *
p
 = 
cÚf
;

1088 
ngx_št_t
 *
Å
;

1089 
ngx_¡r_t
 *
v®ue
;

1090 
ngx_cÚf_po¡_t
 *
po¡
;

1093 
Å
 = (
ngx_št_t
 *è(
p
 + 
cmd
->
off£t
);

1095 ià(*
Å
 !ð
NGX_CONF_UNSET
) {

1099 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1100 *
Å
 = 
	`ngx_©oi
(
v®ue
[1].
d©a
, v®ue[1].
Ën
);

1101 ià(*
Å
 =ð
NGX_ERROR
) {

1105 ià(
cmd
->
po¡
) {

1106 
po¡
 = 
cmd
->post;

1107  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
Å
);

1110  
NGX_CONF_OK
;

1111 
	}
}

1115 
	$ngx_cÚf_£t_size_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1117 *
p
 = 
cÚf
;

1119 
size_t
 *
¥
;

1120 
ngx_¡r_t
 *
v®ue
;

1121 
ngx_cÚf_po¡_t
 *
po¡
;

1124 
¥
 = (
size_t
 *è(
p
 + 
cmd
->
off£t
);

1125 ià(*
¥
 !ð
NGX_CONF_UNSET_SIZE
) {

1129 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1131 *
¥
 = 
	`ngx_·r£_size
(&
v®ue
[1]);

1132 ià(*
¥
 =ð(
size_t
è
NGX_ERROR
) {

1136 ià(
cmd
->
po¡
) {

1137 
po¡
 = 
cmd
->post;

1138  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
¥
);

1141  
NGX_CONF_OK
;

1142 
	}
}

1146 
	$ngx_cÚf_£t_off_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1148 *
p
 = 
cÚf
;

1150 
off_t
 *
Ý
;

1151 
ngx_¡r_t
 *
v®ue
;

1152 
ngx_cÚf_po¡_t
 *
po¡
;

1155 
Ý
 = (
off_t
 *è(
p
 + 
cmd
->
off£t
);

1156 ià(*
Ý
 !ð
NGX_CONF_UNSET
) {

1160 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1162 *
Ý
 = 
	`ngx_·r£_off£t
(&
v®ue
[1]);

1163 ià(*
Ý
 =ð(
off_t
è
NGX_ERROR
) {

1167 ià(
cmd
->
po¡
) {

1168 
po¡
 = 
cmd
->post;

1169  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
Ý
);

1172  
NGX_CONF_OK
;

1173 
	}
}

1177 
	$ngx_cÚf_£t_m£c_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1179 *
p
 = 
cÚf
;

1181 
ngx_m£c_t
 *
m¥
;

1182 
ngx_¡r_t
 *
v®ue
;

1183 
ngx_cÚf_po¡_t
 *
po¡
;

1186 
m¥
 = (
ngx_m£c_t
 *è(
p
 + 
cmd
->
off£t
);

1187 ià(*
m¥
 !ð
NGX_CONF_UNSET_MSEC
) {

1191 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1193 *
m¥
 = 
	`ngx_·r£_time
(&
v®ue
[1], 0);

1194 ià(*
m¥
 =ð(
ngx_m£c_t
è
NGX_ERROR
) {

1198 ià(
cmd
->
po¡
) {

1199 
po¡
 = 
cmd
->post;

1200  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
m¥
);

1203  
NGX_CONF_OK
;

1204 
	}
}

1208 
	$ngx_cÚf_£t_£c_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1210 *
p
 = 
cÚf
;

1212 
time_t
 *
¥
;

1213 
ngx_¡r_t
 *
v®ue
;

1214 
ngx_cÚf_po¡_t
 *
po¡
;

1217 
¥
 = (
time_t
 *è(
p
 + 
cmd
->
off£t
);

1218 ià(*
¥
 !ð
NGX_CONF_UNSET
) {

1222 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1224 *
¥
 = 
	`ngx_·r£_time
(&
v®ue
[1], 1);

1225 ià(*
¥
 =ð(
time_t
è
NGX_ERROR
) {

1229 ià(
cmd
->
po¡
) {

1230 
po¡
 = 
cmd
->post;

1231  
po¡
->
	`po¡_hªdËr
(
cf
,…o¡, 
¥
);

1234  
NGX_CONF_OK
;

1235 
	}
}

1239 
	$ngx_cÚf_£t_bufs_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1241 *
p
 = 
cÚf
;

1243 
ngx_¡r_t
 *
v®ue
;

1244 
ngx_bufs_t
 *
bufs
;

1247 
bufs
 = (
ngx_bufs_t
 *è(
p
 + 
cmd
->
off£t
);

1248 ià(
bufs
->
num
) {

1252 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1254 
bufs
->
num
 = 
	`ngx_©oi
(
v®ue
[1].
d©a
, v®ue[1].
Ën
);

1255 ià(
bufs
->
num
 =ð
NGX_ERROR
 || bufs->num == 0) {

1259 
bufs
->
size
 = 
	`ngx_·r£_size
(&
v®ue
[2]);

1260 ià(
bufs
->
size
 =ð(
size_t
è
NGX_ERROR
 || bufs->size == 0) {

1264  
NGX_CONF_OK
;

1265 
	}
}

1269 
	$ngx_cÚf_£t_’um_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1271 *
p
 = 
cÚf
;

1273 
ngx_ušt_t
 *
Å
, 
i
;

1274 
ngx_¡r_t
 *
v®ue
;

1275 
ngx_cÚf_’um_t
 *
e
;

1277 
Å
 = (
ngx_ušt_t
 *è(
p
 + 
cmd
->
off£t
);

1279 ià(*
Å
 !ð
NGX_CONF_UNSET_UINT
) {

1283 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1284 
e
 = 
cmd
->
po¡
;

1286 
i
 = 0; 
e
[i].
Çme
.
Ën
 != 0; i++) {

1287 ià(
e
[
i
].
Çme
.
Ën
 !ð
v®ue
[1].len

1288 || 
	`ngx_¡rÿ£cmp
(
e
[
i
].
Çme
.
d©a
, 
v®ue
[1].data) != 0)

1293 *
Å
 = 
e
[
i
].
v®ue
;

1295  
NGX_CONF_OK
;

1298 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1299 "šv®id v®u\"%s\"", 
v®ue
[1].
d©a
);

1301  
NGX_CONF_ERROR
;

1302 
	}
}

1306 
	$ngx_cÚf_£t_b™mask_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1308 *
p
 = 
cÚf
;

1310 
ngx_ušt_t
 *
Å
, 
i
, 
m
;

1311 
ngx_¡r_t
 *
v®ue
;

1312 
ngx_cÚf_b™mask_t
 *
mask
;

1315 
Å
 = (
ngx_ušt_t
 *è(
p
 + 
cmd
->
off£t
);

1316 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1317 
mask
 = 
cmd
->
po¡
;

1319 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

1320 
m
 = 0; 
mask
[m].
Çme
.
Ën
 != 0; m++) {

1322 ià(
mask
[
m
].
Çme
.
Ën
 !ð
v®ue
[
i
].len

1323 || 
	`ngx_¡rÿ£cmp
(
mask
[
m
].
Çme
.
d©a
, 
v®ue
[
i
].data) != 0)

1328 ià(*
Å
 & 
mask
[
m
].mask) {

1329 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1330 "du¶iÿ‹ v®u\"%s\"", 
v®ue
[
i
].
d©a
);

1333 *
Å
 |ð
mask
[
m
].mask;

1339 ià(
mask
[
m
].
Çme
.
Ën
 == 0) {

1340 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1341 "šv®id v®u\"%s\"", 
v®ue
[
i
].
d©a
);

1343  
NGX_CONF_ERROR
;

1347  
NGX_CONF_OK
;

1348 
	}
}

1354 
	$ngx_cÚf_unsuµÜ‹d
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1357 
	}
}

1363 
	$ngx_cÚf_d•»ÿ‹d
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

1365 
ngx_cÚf_d•»ÿ‹d_t
 *
d
 = 
po¡
;

1367 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1370 
d
->
Þd_Çme
, d->
Ãw_Çme
);

1372  
NGX_CONF_OK
;

1373 
	}
}

1377 
	$ngx_cÚf_check_num_bounds
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

1379 
ngx_cÚf_num_bounds_t
 *
bounds
 = 
po¡
;

1380 
ngx_št_t
 *
Å
 = 
d©a
;

1382 ià(
bounds
->
high
 == -1) {

1383 ià(*
Å
 >ð
bounds
->
low
) {

1384  
NGX_CONF_OK
;

1387 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1389 
bounds
->
low
);

1391  
NGX_CONF_ERROR
;

1394 ià(*
Å
 >ð
bounds
->
low
 && *Å <ðbounds->
high
) {

1395  
NGX_CONF_OK
;

1398 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1400 
bounds
->
low
, bounds->
high
);

1402  
NGX_CONF_ERROR
;

1403 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_connection.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_os_io_t
 
	gngx_io
;

16 
ngx_d¿š_cÚÃùiÚs
();

19 
ngx_li¡’šg_t
 *

20 
	$ngx_ü—‹_li¡’šg
(
ngx_cÚf_t
 *
cf
, *
sockaddr
, 
sockËn_t
 
sockËn
)

22 
size_t
 
Ën
;

23 
ngx_li¡’šg_t
 *
ls
;

24 
sockaddr
 *
§
;

25 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

27 
ls
 = 
	`ngx_¬¿y_push
(&
cf
->
cyþe
->
li¡’šg
);

28 ià(
ls
 =ð
NULL
) {

29  
NULL
;

32 
	`ngx_memz”o
(
ls
, (
ngx_li¡’šg_t
));

34 
§
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, 
sockËn
);

35 ià(
§
 =ð
NULL
) {

36  
NULL
;

39 
	`ngx_memýy
(
§
, 
sockaddr
, 
sockËn
);

41 
ls
->
sockaddr
 = 
§
;

42 
ls
->
sockËn
 = socklen;

44 
Ën
 = 
	`ngx_sock_ÁÝ
(
§
, 
sockËn
, 
‹xt
, 
NGX_SOCKADDR_STRLEN
, 1);

45 
ls
->
addr_‹xt
.
Ën
 =†en;

47 
ls
->
sockaddr
->
§_çmžy
) {

48 #ià(
NGX_HAVE_INET6
)

49 
AF_INET6
:

50 
ls
->
addr_‹xt_max_Ën
 = 
NGX_INET6_ADDRSTRLEN
;

53 #ià(
NGX_HAVE_UNIX_DOMAIN
)

54 
AF_UNIX
:

55 
ls
->
addr_‹xt_max_Ën
 = 
NGX_UNIX_ADDRSTRLEN
;

56 
Ën
++;

59 
AF_INET
:

60 
ls
->
addr_‹xt_max_Ën
 = 
NGX_INET_ADDRSTRLEN
;

63 
ls
->
addr_‹xt_max_Ën
 = 
NGX_SOCKADDR_STRLEN
;

67 
ls
->
addr_‹xt
.
d©a
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
Ën
);

68 ià(
ls
->
addr_‹xt
.
d©a
 =ð
NULL
) {

69  
NULL
;

72 
	`ngx_memýy
(
ls
->
addr_‹xt
.
d©a
, 
‹xt
, 
Ën
);

74 
ls
->
fd
 = (
ngx_sock‘_t
) -1;

75 
ls
->
ty³
 = 
SOCK_STREAM
;

77 
ls
->
backlog
 = 
NGX_LISTEN_BACKLOG
;

78 
ls
->
rcvbuf
 = -1;

79 
ls
->
¢dbuf
 = -1;

81 #ià(
NGX_HAVE_SETFIB
)

82 
ls
->
£tfib
 = -1;

85 #ià(
NGX_HAVE_TCP_FASTOPEN
)

86 
ls
->
ç¡Ý’
 = -1;

89  
ls
;

90 
	}
}

93 
ngx_št_t


94 
	$ngx_£t_šh”™ed_sock‘s
(
ngx_cyþe_t
 *
cyþe
)

96 
size_t
 
Ën
;

97 
ngx_ušt_t
 
i
;

98 
ngx_li¡’šg_t
 *
ls
;

99 
sockËn_t
 
Þ’
;

100 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 || 
NGX_HAVE_TCP_FASTOPEN
)

101 
ngx_”r_t
 
”r
;

103 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
SO_ACCEPTFILTER
)

104 
acû±_fž‹r_¬g
 
af
;

106 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
TCP_DEFER_ACCEPT
)

107 
timeout
;

110 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

111 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

113 
ls
[
i
].
sockaddr
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, 
NGX_SOCKADDRLEN
);

114 ià(
ls
[
i
].
sockaddr
 =ð
NULL
) {

115  
NGX_ERROR
;

118 
ls
[
i
].
sockËn
 = 
NGX_SOCKADDRLEN
;

119 ià(
	`g‘sockÇme
(
ls
[
i
].
fd
,†s[i].
sockaddr
, &ls[i].
sockËn
) == -1) {

120 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

122 "sock‘ #%d fažed", 
ls
[
i
].
fd
);

123 
ls
[
i
].
ignÜe
 = 1;

127 
ls
[
i
].
sockaddr
->
§_çmžy
) {

129 #ià(
NGX_HAVE_INET6
)

130 
AF_INET6
:

131 
ls
[
i
].
addr_‹xt_max_Ën
 = 
NGX_INET6_ADDRSTRLEN
;

132 
Ën
 = 
NGX_INET6_ADDRSTRLEN
 + ("[]:65535") - 1;

136 #ià(
NGX_HAVE_UNIX_DOMAIN
)

137 
AF_UNIX
:

138 
ls
[
i
].
addr_‹xt_max_Ën
 = 
NGX_UNIX_ADDRSTRLEN
;

139 
Ën
 = 
NGX_UNIX_ADDRSTRLEN
;

143 
AF_INET
:

144 
ls
[
i
].
addr_‹xt_max_Ën
 = 
NGX_INET_ADDRSTRLEN
;

145 
Ën
 = 
NGX_INET_ADDRSTRLEN
 + (":65535") - 1;

149 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

151 "ª unsuµÜ‹d…rÙocÞ famžy", 
ls
[
i
].
fd
);

152 
ls
[
i
].
ignÜe
 = 1;

156 
ls
[
i
].
addr_‹xt
.
d©a
 = 
	`ngx_²®loc
(
cyþe
->
poÞ
, 
Ën
);

157 ià(
ls
[
i
].
addr_‹xt
.
d©a
 =ð
NULL
) {

158  
NGX_ERROR
;

161 
Ën
 = 
	`ngx_sock_ÁÝ
(
ls
[
i
].
sockaddr
,†s[i].
sockËn
,

162 
ls
[
i
].
addr_‹xt
.
d©a
, 
Ën
, 1);

163 ià(
Ën
 == 0) {

164  
NGX_ERROR
;

167 
ls
[
i
].
addr_‹xt
.
Ën
 =†en;

169 
ls
[
i
].
backlog
 = 
NGX_LISTEN_BACKLOG
;

171 
Þ’
 = ();

173 ià(
	`g‘sockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*è&ls[i].
rcvbuf
,

174 &
Þ’
)

177 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

179 &
ls
[
i
].
addr_‹xt
);

181 
ls
[
i
].
rcvbuf
 = -1;

184 
Þ’
 = ();

186 ià(
	`g‘sockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*è&ls[i].
¢dbuf
,

187 &
Þ’
)

190 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

192 &
ls
[
i
].
addr_‹xt
);

194 
ls
[
i
].
¢dbuf
 = -1;

200 #ià(
NGX_HAVE_SETFIB
)

202 
Þ’
 = ();

204 ià(
	`g‘sockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_SETFIB
,

205 (*è&
ls
[
i
].
£tfib
, &
Þ’
)

208 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

210 &
ls
[
i
].
addr_‹xt
);

212 
ls
[
i
].
£tfib
 = -1;

218 #ià(
NGX_HAVE_TCP_FASTOPEN
)

220 
Þ’
 = ();

222 ià(
	`g‘sockÝt
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_FASTOPEN
,

223 (*è&
ls
[
i
].
ç¡Ý’
, &
Þ’
)

226 
”r
 = 
ngx_sock‘_”ºo
;

228 ià(
”r
 !ð
NGX_EOPNOTSUPP
 &&ƒ¼ !ð
NGX_ENOPROTOOPT
) {

229 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 
”r
,

231 &
ls
[
i
].
addr_‹xt
);

234 
ls
[
i
].
ç¡Ý’
 = -1;

239 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
SO_ACCEPTFILTER
)

241 
	`ngx_memz”o
(&
af
, (
acû±_fž‹r_¬g
));

242 
Þ’
 = (
acû±_fž‹r_¬g
);

244 ià(
	`g‘sockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_ACCEPTFILTER
, &
af
, &
Þ’
)

247 
”r
 = 
ngx_sock‘_”ºo
;

249 ià(
”r
 =ð
NGX_EINVAL
) {

253 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 
”r
,

255 &
ls
[
i
].
addr_‹xt
);

259 ià(
Þ’
 < (
acû±_fž‹r_¬g
è|| 
af
.
af_Çme
[0] == '\0') {

263 
ls
[
i
].
acû±_fž‹r
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, 16);

264 ià(
ls
[
i
].
acû±_fž‹r
 =ð
NULL
) {

265  
NGX_ERROR
;

268 (è
	`ngx_ýy¡º
((
u_ch¬
 *è
ls
[
i
].
acû±_fž‹r
,

269 (
u_ch¬
 *è
af
.
af_Çme
, 16);

272 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
TCP_DEFER_ACCEPT
)

274 
timeout
 = 0;

275 
Þ’
 = ();

277 ià(
	`g‘sockÝt
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_DEFER_ACCEPT
, &
timeout
, &
Þ’
)

280 
”r
 = 
ngx_sock‘_”ºo
;

282 ià(
”r
 =ð
NGX_EOPNOTSUPP
) {

286 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 
”r
,

288 &
ls
[
i
].
addr_‹xt
);

292 ià(
Þ’
 < (è|| 
timeout
 == 0) {

296 
ls
[
i
].
deã¼ed_acû±
 = 1;

300  
NGX_OK
;

301 
	}
}

304 
ngx_št_t


305 
	$ngx_Ý’_li¡’šg_sock‘s
(
ngx_cyþe_t
 *
cyþe
)

307 
»u£addr
;

308 
ngx_ušt_t
 
i
, 
Œ›s
, 
çžed
;

309 
ngx_”r_t
 
”r
;

310 
ngx_log_t
 *
log
;

311 
ngx_sock‘_t
 
s
;

312 
ngx_li¡’šg_t
 *
ls
;

314 
»u£addr
 = 1;

315 #ià(
NGX_SUPPRESS_WARN
)

316 
çžed
 = 0;

319 
log
 = 
cyþe
->log;

323 
Œ›s
 = 5;ries;ries--) {

324 
çžed
 = 0;

328 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

329 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

331 ià(
ls
[
i
].
ignÜe
) {

335 ià(
ls
[
i
].
fd
 !ð(
ngx_sock‘_t
) -1) {

339 ià(
ls
[
i
].
šh”™ed
) {

348 
s
 = 
	`ngx_sock‘
(
ls
[
i
].
sockaddr
->
§_çmžy
,†s[i].
ty³
, 0);

350 ià(
s
 =ð(
ngx_sock‘_t
) -1) {

351 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

352 
ngx_sock‘_n
 " %V fažed", &
ls
[
i
].
addr_‹xt
);

353  
NGX_ERROR
;

356 ià(
	`£tsockÝt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

357 (cÚ¡ *è&
»u£addr
, ())

360 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

362 &
ls
[
i
].
addr_‹xt
);

364 ià(
	`ngx_þo£_sock‘
(
s
) == -1) {

365 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

366 
ngx_þo£_sock‘_n
 " %V failed",

367 &
ls
[
i
].
addr_‹xt
);

370  
NGX_ERROR
;

373 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

375 ià(
ls
[
i
].
sockaddr
->
§_çmžy
 =ð
AF_INET6
) {

376 
v6Úly
;

378 
v6Úly
 = 
ls
[
i
].ipv6only;

380 ià(
	`£tsockÝt
(
s
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
,

381 (cÚ¡ *è&
v6Úly
, ())

384 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

386 &
ls
[
i
].
addr_‹xt
);

392 ià(!(
ngx_ev’t_æags
 & 
NGX_USE_AIO_EVENT
)) {

393 ià(
	`ngx_nÚblockšg
(
s
) == -1) {

394 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

395 
ngx_nÚblockšg_n
 " %V failed",

396 &
ls
[
i
].
addr_‹xt
);

398 ià(
	`ngx_þo£_sock‘
(
s
) == -1) {

399 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

400 
ngx_þo£_sock‘_n
 " %V failed",

401 &
ls
[
i
].
addr_‹xt
);

404  
NGX_ERROR
;

408 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

409 "bšd(è%V #%d ", &
ls
[
i
].
addr_‹xt
, 
s
);

411 ià(
	`bšd
(
s
, 
ls
[
i
].
sockaddr
,†s[i].
sockËn
) == -1) {

412 
”r
 = 
ngx_sock‘_”ºo
;

414 ià(
”r
 !ð
NGX_EADDRINUSE
 || !
ngx_‹¡_cÚfig
) {

415 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
”r
,

416 "bšd(ètØ%V fažed", &
ls
[
i
].
addr_‹xt
);

419 ià(
	`ngx_þo£_sock‘
(
s
) == -1) {

420 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

421 
ngx_þo£_sock‘_n
 " %V failed",

422 &
ls
[
i
].
addr_‹xt
);

425 ià(
”r
 !ð
NGX_EADDRINUSE
) {

426  
NGX_ERROR
;

429 ià(!
ngx_‹¡_cÚfig
) {

430 
çžed
 = 1;

436 #ià(
NGX_HAVE_UNIX_DOMAIN
)

438 ià(
ls
[
i
].
sockaddr
->
§_çmžy
 =ð
AF_UNIX
) {

439 
mode_t
 
mode
;

440 
u_ch¬
 *
Çme
;

442 
Çme
 = 
ls
[
i
].
addr_‹xt
.
d©a
 + ("unix:") - 1;

443 
mode
 = (
S_IRUSR
|
S_IWUSR
|
S_IRGRP
|
S_IWGRP
|
S_IROTH
|
S_IWOTH
);

445 ià(
	`chmod
((*è
Çme
, 
mode
) == -1) {

446 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

447 "chmod(è\"%s\" fažed", 
Çme
);

450 ià(
ngx_‹¡_cÚfig
) {

451 ià(
	`ngx_d–‘e_fže
(
Çme
è=ð
NGX_FILE_ERROR
) {

452 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

453 
ngx_d–‘e_fže_n
 " % çžed", 
Çme
);

459 ià(
	`li¡’
(
s
, 
ls
[
i
].
backlog
) == -1) {

460 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

462 &
ls
[
i
].
addr_‹xt
,†s[i].
backlog
);

464 ià(
	`ngx_þo£_sock‘
(
s
) == -1) {

465 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

466 
ngx_þo£_sock‘_n
 " %V failed",

467 &
ls
[
i
].
addr_‹xt
);

470  
NGX_ERROR
;

473 
ls
[
i
].
li¡’
 = 1;

475 
ls
[
i
].
fd
 = 
s
;

478 ià(!
çžed
) {

484 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0,

487 
	`ngx_m¦“p
(500);

490 ià(
çžed
) {

491 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 0, "still could‚ot bind()");

492  
NGX_ERROR
;

495  
NGX_OK
;

496 
	}
}

500 
	$ngx_cÚfigu»_li¡’šg_sock‘s
(
ngx_cyþe_t
 *
cyþe
)

502 
v®ue
;

503 
ngx_ušt_t
 
i
;

504 
ngx_li¡’šg_t
 *
ls
;

506 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
SO_ACCEPTFILTER
)

507 
acû±_fž‹r_¬g
 
af
;

510 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

511 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

513 
ls
[
i
].
log
 = *ls[i].
logp
;

515 ià(
ls
[
i
].
rcvbuf
 != -1) {

516 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
,

517 (cÚ¡ *è&
ls
[
i
].
rcvbuf
, ())

520 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

522 
ls
[
i
].
rcvbuf
, &ls[i].
addr_‹xt
);

526 ià(
ls
[
i
].
¢dbuf
 != -1) {

527 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
,

528 (cÚ¡ *è&
ls
[
i
].
¢dbuf
, ())

531 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

533 
ls
[
i
].
¢dbuf
, &ls[i].
addr_‹xt
);

537 ià(
ls
[
i
].
k“·live
) {

538 
v®ue
 = (
ls
[
i
].
k“·live
 == 1) ? 1 : 0;

540 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
,

541 (cÚ¡ *è&
v®ue
, ())

544 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

546 
v®ue
, &
ls
[
i
].
addr_‹xt
);

550 #ià(
NGX_HAVE_KEEPALIVE_TUNABLE
)

552 ià(
ls
[
i
].
k“pidË
) {

553 
v®ue
 = 
ls
[
i
].
k“pidË
;

555 #ià(
NGX_KEEPALIVE_FACTOR
)

556 
v®ue
 *ð
NGX_KEEPALIVE_FACTOR
;

559 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_KEEPIDLE
,

560 (cÚ¡ *è&
v®ue
, ())

563 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

565 
v®ue
, &
ls
[
i
].
addr_‹xt
);

569 ià(
ls
[
i
].
k“pštvl
) {

570 
v®ue
 = 
ls
[
i
].
k“pštvl
;

572 #ià(
NGX_KEEPALIVE_FACTOR
)

573 
v®ue
 *ð
NGX_KEEPALIVE_FACTOR
;

576 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_KEEPINTVL
,

577 (cÚ¡ *è&
v®ue
, ())

580 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

582 
v®ue
, &
ls
[
i
].
addr_‹xt
);

586 ià(
ls
[
i
].
k“pút
) {

587 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_KEEPCNT
,

588 (cÚ¡ *è&
ls
[
i
].
k“pút
, ())

591 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

593 
ls
[
i
].
k“pút
, &ls[i].
addr_‹xt
);

599 #ià(
NGX_HAVE_SETFIB
)

600 ià(
ls
[
i
].
£tfib
 != -1) {

601 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_SETFIB
,

602 (cÚ¡ *è&
ls
[
i
].
£tfib
, ())

605 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

607 
ls
[
i
].
£tfib
, &ls[i].
addr_‹xt
);

612 #ià(
NGX_HAVE_TCP_FASTOPEN
)

613 ià(
ls
[
i
].
ç¡Ý’
 != -1) {

614 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_FASTOPEN
,

615 (cÚ¡ *è&
ls
[
i
].
ç¡Ý’
, ())

618 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

620 
ls
[
i
].
ç¡Ý’
, &ls[i].
addr_‹xt
);

627 
tý_nod–ay
 = 1;

629 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

630 (cÚ¡ *è&
tý_nod–ay
, ())

633 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

635 &
ls
[
i
].
addr_‹xt
);

640 ià(
ls
[
i
].
li¡’
) {

644 ià(
	`li¡’
(
ls
[
i
].
fd
,†s[i].
backlog
) == -1) {

645 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

647 &
ls
[
i
].
addr_‹xt
,†s[i].
backlog
);

656 #ià(
NGX_HAVE_DEFERRED_ACCEPT
)

658 #ifdeà
SO_ACCEPTFILTER


660 ià(
ls
[
i
].
d–‘e_deã¼ed
) {

661 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_ACCEPTFILTER
, 
NULL
, 0)

664 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

667 &
ls
[
i
].
addr_‹xt
);

669 ià(
ls
[
i
].
acû±_fž‹r
) {

670 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

673 
ls
[
i
].
acû±_fž‹r
, &ls[i].
addr_‹xt
);

679 
ls
[
i
].
deã¼ed_acû±
 = 0;

682 ià(
ls
[
i
].
add_deã¼ed
) {

683 
	`ngx_memz”o
(&
af
, (
acû±_fž‹r_¬g
));

684 (è
	`ngx_ýy¡º
((
u_ch¬
 *è
af
.
af_Çme
,

685 (
u_ch¬
 *è
ls
[
i
].
acû±_fž‹r
, 16);

687 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_ACCEPTFILTER
,

688 &
af
, (
acû±_fž‹r_¬g
))

691 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

694 
ls
[
i
].
acû±_fž‹r
, &ls[i].
addr_‹xt
);

698 
ls
[
i
].
deã¼ed_acû±
 = 1;

703 #ifdeà
TCP_DEFER_ACCEPT


705 ià(
ls
[
i
].
add_deã¼ed
 ||†s[i].
d–‘e_deã¼ed
) {

707 ià(
ls
[
i
].
add_deã¼ed
) {

714 
v®ue
 = 1;

717 
v®ue
 = 0;

720 ià(
	`£tsockÝt
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_DEFER_ACCEPT
,

721 &
v®ue
, ())

724 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

727 
v®ue
, &
ls
[
i
].
addr_‹xt
);

733 ià(
ls
[
i
].
add_deã¼ed
) {

734 
ls
[
i
].
deã¼ed_acû±
 = 1;

743 
	}
}

747 
	$ngx_þo£_li¡’šg_sock‘s
(
ngx_cyþe_t
 *
cyþe
)

749 
ngx_ušt_t
 
i
;

750 
ngx_li¡’šg_t
 *
ls
;

751 
ngx_cÚÃùiÚ_t
 *
c
;

753 ià(
ngx_ev’t_æags
 & 
NGX_USE_IOCP_EVENT
) {

757 
ngx_acû±_mu‹x_h–d
 = 0;

758 
ngx_u£_acû±_mu‹x
 = 0;

760 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

761 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

763 
c
 = 
ls
[
i
].
cÚÃùiÚ
;

765 ià(
c
) {

766 ià(
c
->
»ad
->
aùive
) {

767 ià(
ngx_ev’t_æags
 & 
NGX_USE_RTSIG_EVENT
) {

768 
	`ngx_d–_cÚn
(
c
, 
NGX_CLOSE_EVENT
);

770 } ià(
ngx_ev’t_æags
 & 
NGX_USE_EPOLL_EVENT
) {

778 
	`ngx_d–_ev’t
(
c
->
»ad
, 
NGX_READ_EVENT
, 0);

781 
	`ngx_d–_ev’t
(
c
->
»ad
, 
NGX_READ_EVENT
, 
NGX_CLOSE_EVENT
);

785 
	`ngx_ä“_cÚÃùiÚ
(
c
);

787 
c
->
fd
 = (
ngx_sock‘_t
) -1;

790 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

791 "þo£†i¡’šg %V #%d ", &
ls
[
i
].
addr_‹xt
,†s[i].
fd
);

793 ià(
	`ngx_þo£_sock‘
(
ls
[
i
].
fd
) == -1) {

794 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

795 
ngx_þo£_sock‘_n
 " %V fažed", &
ls
[
i
].
addr_‹xt
);

798 #ià(
NGX_HAVE_UNIX_DOMAIN
)

800 ià(
ls
[
i
].
sockaddr
->
§_çmžy
 =ð
AF_UNIX


801 && 
ngx_´oûss
 <ð
NGX_PROCESS_MASTER


802 && 
ngx_Ãw_bš¬y
 == 0)

804 
u_ch¬
 *
Çme
 = 
ls
[
i
].
addr_‹xt
.
d©a
 + ("unix:") - 1;

806 ià(
	`ngx_d–‘e_fže
(
Çme
è=ð
NGX_FILE_ERROR
) {

807 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

808 
ngx_d–‘e_fže_n
 " % çžed", 
Çme
);

814 
ls
[
i
].
fd
 = (
ngx_sock‘_t
) -1;

817 
cyþe
->
li¡’šg
.
ÃÉs
 = 0;

818 
	}
}

821 
ngx_cÚÃùiÚ_t
 *

822 
	$ngx_g‘_cÚÃùiÚ
(
ngx_sock‘_t
 
s
, 
ngx_log_t
 *
log
)

824 
ngx_ušt_t
 
š¡ªû
;

825 
ngx_ev’t_t
 *
»v
, *
wev
;

826 
ngx_cÚÃùiÚ_t
 *
c
;

830 ià(
ngx_cyþe
->
fžes
 && (
ngx_ušt_t
è
s
 >ðngx_cyþe->
fžes_n
) {

831 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

834 
s
, 
ngx_cyþe
->
fžes_n
);

835  
NULL
;

840 
c
 = 
ngx_cyþe
->
ä“_cÚÃùiÚs
;

842 ià(
c
 =ð
NULL
) {

843 
	`ngx_d¿š_cÚÃùiÚs
();

844 
c
 = 
ngx_cyþe
->
ä“_cÚÃùiÚs
;

847 ià(
c
 =ð
NULL
) {

848 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

850 
ngx_cyþe
->
cÚÃùiÚ_n
);

854  
NULL
;

857 
ngx_cyþe
->
ä“_cÚÃùiÚs
 = 
c
->
d©a
;

858 
ngx_cyþe
->
ä“_cÚÃùiÚ_n
--;

862 ià(
ngx_cyþe
->
fžes
) {

863 
ngx_cyþe
->
fžes
[
s
] = 
c
;

866 
»v
 = 
c
->
»ad
;

867 
wev
 = 
c
->
wr™e
;

869 
	`ngx_memz”o
(
c
, (
ngx_cÚÃùiÚ_t
));

871 
c
->
»ad
 = 
»v
;

872 
c
->
wr™e
 = 
wev
;

873 
c
->
fd
 = 
s
;

874 
c
->
log
 =†og;

876 
š¡ªû
 = 
»v
->instance;

878 
	`ngx_memz”o
(
»v
, (
ngx_ev’t_t
));

879 
	`ngx_memz”o
(
wev
, (
ngx_ev’t_t
));

881 
»v
->
š¡ªû
 = !instance;

882 
wev
->
š¡ªû
 = !instance;

884 
»v
->
šdex
 = 
NGX_INVALID_INDEX
;

885 
wev
->
šdex
 = 
NGX_INVALID_INDEX
;

887 
»v
->
d©a
 = 
c
;

888 
wev
->
d©a
 = 
c
;

890 
wev
->
wr™e
 = 1;

892  
c
;

893 
	}
}

897 
	$ngx_ä“_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

901 
c
->
d©a
 = 
ngx_cyþe
->
ä“_cÚÃùiÚs
;

902 
ngx_cyþe
->
ä“_cÚÃùiÚs
 = 
c
;

903 
ngx_cyþe
->
ä“_cÚÃùiÚ_n
++;

907 ià(
ngx_cyþe
->
fžes
) {

908 
ngx_cyþe
->
fžes
[
c
->
fd
] = 
NULL
;

910 
	}
}

914 
	$ngx_þo£_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

916 
ngx_”r_t
 
”r
;

917 
ngx_ušt_t
 
log_”rÜ
, 
Ëv–
;

918 
ngx_sock‘_t
 
fd
;

920 ià(
c
->
fd
 =ð(
ngx_sock‘_t
) -1) {

921 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "connection‡lready closed");

925 ià(
c
->
»ad
->
tim”_£t
) {

926 
	`ngx_d–_tim”
(
c
->
»ad
);

929 ià(
c
->
wr™e
->
tim”_£t
) {

930 
	`ngx_d–_tim”
(
c
->
wr™e
);

933 ià(
ngx_d–_cÚn
) {

934 
	`ngx_d–_cÚn
(
c
, 
NGX_CLOSE_EVENT
);

937 ià(
c
->
»ad
->
aùive
 || c->»ad->
di§bËd
) {

938 
	`ngx_d–_ev’t
(
c
->
»ad
, 
NGX_READ_EVENT
, 
NGX_CLOSE_EVENT
);

941 ià(
c
->
wr™e
->
aùive
 || c->wr™e->
di§bËd
) {

942 
	`ngx_d–_ev’t
(
c
->
wr™e
, 
NGX_WRITE_EVENT
, 
NGX_CLOSE_EVENT
);

946 #ià(
NGX_THREADS
)

954 
	`ngx_uÆock
(&
c
->
lock
);

958 ià(
c
->
»ad
->
po¡ed
) {

959 
	`ngx_d–‘e_po¡ed_ev’t
(
c
->
»ad
);

962 ià(
c
->
wr™e
->
po¡ed
) {

963 
	`ngx_d–‘e_po¡ed_ev’t
(
c
->
wr™e
);

966 
c
->
»ad
->
þo£d
 = 1;

967 
c
->
wr™e
->
þo£d
 = 1;

969 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 0);

971 
log_”rÜ
 = 
c
->log_error;

973 
	`ngx_ä“_cÚÃùiÚ
(
c
);

975 
fd
 = 
c
->fd;

976 
c
->
fd
 = (
ngx_sock‘_t
) -1;

978 ià(
	`ngx_þo£_sock‘
(
fd
) == -1) {

980 
”r
 = 
ngx_sock‘_”ºo
;

982 ià(
”r
 =ð
NGX_ECONNRESET
 ||ƒ¼ =ð
NGX_ENOTCONN
) {

984 
log_”rÜ
) {

986 
NGX_ERROR_INFO
:

987 
Ëv–
 = 
NGX_LOG_INFO
;

990 
NGX_ERROR_ERR
:

991 
Ëv–
 = 
NGX_LOG_ERR
;

995 
Ëv–
 = 
NGX_LOG_CRIT
;

999 
Ëv–
 = 
NGX_LOG_CRIT
;

1004 
	`ngx_log_”rÜ
(
Ëv–
, 
ngx_cyþe
->
log
, 
”r
,

1005 
ngx_þo£_sock‘_n
 " %d fažed", 
fd
);

1007 
	}
}

1011 
	$ngx_»u§bË_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
»u§bË
)

1013 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

1014 "»u§bË cÚÃùiÚ: %ui", 
»u§bË
);

1016 ià(
c
->
»u§bË
) {

1017 
	`ngx_queue_»move
(&
c
->
queue
);

1019 #ià(
NGX_STAT_STUB
)

1020 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_wa™šg
, -1);

1024 
c
->
»u§bË
 =„eusable;

1026 ià(
»u§bË
) {

1029 
	`ngx_queue_š£¹_h—d
(

1030 (
ngx_queue_t
 *è&
ngx_cyþe
->
»u§bË_cÚÃùiÚs_queue
, &
c
->
queue
);

1032 #ià(
NGX_STAT_STUB
)

1033 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_wa™šg
, 1);

1036 
	}
}

1040 
	$ngx_d¿š_cÚÃùiÚs
()

1042 
ngx_št_t
 
i
;

1043 
ngx_queue_t
 *
q
;

1044 
ngx_cÚÃùiÚ_t
 *
c
;

1046 
i
 = 0; i < 32; i++) {

1047 ià(
	`ngx_queue_em±y
(&
ngx_cyþe
->
»u§bË_cÚÃùiÚs_queue
)) {

1051 
q
 = 
	`ngx_queue_Ï¡
(&
ngx_cyþe
->
»u§bË_cÚÃùiÚs_queue
);

1052 
c
 = 
	`ngx_queue_d©a
(
q
, 
ngx_cÚÃùiÚ_t
, 
queue
);

1054 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

1057 
c
->
þo£
 = 1;

1058 
c
->
»ad
->
	`hªdËr
(c->read);

1060 
	}
}

1063 
ngx_št_t


1064 
	$ngx_cÚÃùiÚ_loÿl_sockaddr
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_¡r_t
 *
s
,

1065 
ngx_ušt_t
 
pÜt
)

1067 
sockËn_t
 
Ën
;

1068 
ngx_ušt_t
 
addr
;

1069 
u_ch¬
 
§
[
NGX_SOCKADDRLEN
];

1070 
sockaddr_š
 *
sš
;

1071 #ià(
NGX_HAVE_INET6
)

1072 
ngx_ušt_t
 
i
;

1073 
sockaddr_š6
 *
sš6
;

1076 ià(
c
->
loÿl_sockËn
 == 0) {

1077  
NGX_ERROR
;

1080 
c
->
loÿl_sockaddr
->
§_çmžy
) {

1082 #ià(
NGX_HAVE_INET6
)

1083 
AF_INET6
:

1084 
sš6
 = (
sockaddr_š6
 *è
c
->
loÿl_sockaddr
;

1086 
addr
 = 0, 
i
 = 0;‡ddr == 0 && i < 16; i++) {

1087 
addr
 |ð
sš6
->
sš6_addr
.
s6_addr
[
i
];

1093 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1094 
AF_UNIX
:

1095 
addr
 = 1;

1100 
sš
 = (
sockaddr_š
 *è
c
->
loÿl_sockaddr
;

1101 
addr
 = 
sš
->
sš_addr
.
s_addr
;

1105 ià(
addr
 == 0) {

1107 
Ën
 = 
NGX_SOCKADDRLEN
;

1109 ià(
	`g‘sockÇme
(
c
->
fd
, (
sockaddr
 *è&
§
, &
Ën
) == -1) {

1110 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
, "getsockname() failed");

1111  
NGX_ERROR
;

1114 
c
->
loÿl_sockaddr
 = 
	`ngx_·Îoc
(c->
poÞ
, 
Ën
);

1115 ià(
c
->
loÿl_sockaddr
 =ð
NULL
) {

1116  
NGX_ERROR
;

1119 
	`ngx_memýy
(
c
->
loÿl_sockaddr
, &
§
, 
Ën
);

1121 
c
->
loÿl_sockËn
 = 
Ën
;

1124 ià(
s
 =ð
NULL
) {

1125  
NGX_OK
;

1128 
s
->
Ën
 = 
	`ngx_sock_ÁÝ
(
c
->
loÿl_sockaddr
, c->
loÿl_sockËn
,

1129 
s
->
d©a
, s->
Ën
, 
pÜt
);

1131  
NGX_OK
;

1132 
	}
}

1135 
ngx_št_t


1136 
	$ngx_cÚÃùiÚ_”rÜ
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_”r_t
 
”r
, *
‹xt
)

1138 
ngx_ušt_t
 
Ëv–
;

1142 ià((
”r
 =ð
NGX_ECONNRESET


1143 #ià(
NGX_WIN32
)

1144 || 
”r
 =ð
NGX_ECONNABORTED


1146 è&& 
c
->
log_”rÜ
 =ð
NGX_ERROR_IGNORE_ECONNRESET
)

1151 #ià(
NGX_SOLARIS
)

1152 ià(
”r
 =ð
NGX_EINVAL
 && 
c
->
log_”rÜ
 =ð
NGX_ERROR_IGNORE_EINVAL
) {

1157 ià(
”r
 == 0

1158 || 
”r
 =ð
NGX_ECONNRESET


1159 #ià(
NGX_WIN32
)

1160 || 
”r
 =ð
NGX_ECONNABORTED


1162 || 
”r
 =ð
NGX_EPIPE


1164 || 
”r
 =ð
NGX_ENOTCONN


1165 || 
”r
 =ð
NGX_ETIMEDOUT


1166 || 
”r
 =ð
NGX_ECONNREFUSED


1167 || 
”r
 =ð
NGX_ENETDOWN


1168 || 
”r
 =ð
NGX_ENETUNREACH


1169 || 
”r
 =ð
NGX_EHOSTDOWN


1170 || 
”r
 =ð
NGX_EHOSTUNREACH
)

1172 
c
->
log_”rÜ
) {

1174 
NGX_ERROR_IGNORE_EINVAL
:

1175 
NGX_ERROR_IGNORE_ECONNRESET
:

1176 
NGX_ERROR_INFO
:

1177 
Ëv–
 = 
NGX_LOG_INFO
;

1181 
Ëv–
 = 
NGX_LOG_ERR
;

1185 
Ëv–
 = 
NGX_LOG_ALERT
;

1188 
	`ngx_log_”rÜ
(
Ëv–
, 
c
->
log
, 
”r
, 
‹xt
);

1190  
NGX_ERROR
;

1191 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_cpuinfo.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 #ià(Ð
__i386__
 || 
__amd64__
 ) && ( 
__GNUC__
 || 
__INTEL_COMPILER
 ))

15 
ngx_šlše
 
ngx_ýuid
(
ušt32_t
 
i
, ušt32_ˆ*
buf
);

18 #iàÐ
__i386__
 )

20 
ngx_šlše
 

21 
	$ngx_ýuid
(
ušt32_t
 
i
, ušt32_ˆ*
buf
)

30 
	`__asm__
 (

42 : : "a" (
i
), "D" (
buf
) : "ecx", "edx", "esi", "memory" );

43 
	}
}

49 
ngx_šlše
 

50 
	$ngx_ýuid
(
ušt32_t
 
i
, ušt32_ˆ*
buf
)

52 
ušt32_t
 
—x
, 
ebx
, 
ecx
, 
edx
;

54 
	`__asm__
 (

58 : "÷" (
—x
), "=b" (
ebx
), "=c" (
ecx
), "=d" (
edx
è: "a" (
i
) );

60 
buf
[0] = 
—x
;

61 
buf
[1] = 
ebx
;

62 
buf
[2] = 
edx
;

63 
buf
[3] = 
ecx
;

64 
	}
}

73 
	$ngx_ýušfo
()

75 
u_ch¬
 *
v’dÜ
;

76 
ušt32_t
 
vbuf
[5], 
ýu
[4], 
mod–
;

78 
vbuf
[0] = 0;

79 
vbuf
[1] = 0;

80 
vbuf
[2] = 0;

81 
vbuf
[3] = 0;

82 
vbuf
[4] = 0;

84 
	`ngx_ýuid
(0, 
vbuf
);

86 
v’dÜ
 = (
u_ch¬
 *è&
vbuf
[1];

88 ià(
vbuf
[0] == 0) {

92 
	`ngx_ýuid
(1, 
ýu
);

94 ià(
	`ngx_¡rcmp
(
v’dÜ
, "GenuineIntel") == 0) {

96 (
ýu
[0] & 0xf00) >> 8) {

100 
ngx_ÿch–še_size
 = 32;

105 
ngx_ÿch–še_size
 = 32;

107 
mod–
 = ((
ýu
[0] & 0xf0000) >> 8) | (cpu[0] & 0xf0);

109 ià(
mod–
 >= 0xd0) {

111 
ngx_ÿch–še_size
 = 64;

121 
ngx_ÿch–še_size
 = 128;

125 } ià(
	`ngx_¡rcmp
(
v’dÜ
, "AuthenticAMD") == 0) {

126 
ngx_ÿch–še_size
 = 64;

128 
	}
}

134 
	$ngx_ýušfo
()

136 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_crc32.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

26 
ušt32_t
 
	gngx_üc32_bË16
[] = {

34 
ušt32_t
 
	gngx_üc32_bË256
[] = {

102 
ušt32_t
 *
	gngx_üc32_bË_shÜt
 = 
ngx_üc32_bË16
;

105 
ngx_št_t


106 
	$ngx_üc32_bË_š™
()

108 *
p
;

110 ià(((
ušŒ_t
è
ngx_üc32_bË_shÜt


111 & ~((
ušŒ_t
è
ngx_ÿch–še_size
 - 1))

112 =ð(
ušŒ_t
è
ngx_üc32_bË_shÜt
)

114  
NGX_OK
;

117 
p
 = 
	`ngx_®loc
(16 * (
ušt32_t
è+ 
ngx_ÿch–še_size
, 
ngx_cyþe
->
log
);

118 ià(
p
 =ð
NULL
) {

119  
NGX_ERROR
;

122 
p
 = 
	`ngx_®ign_±r
Õ, 
ngx_ÿch–še_size
);

124 
	`ngx_memýy
(
p
, 
ngx_üc32_bË16
, 16 * (
ušt32_t
));

126 
ngx_üc32_bË_shÜt
 = 
p
;

128  
NGX_OK
;

129 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_crypt.c

7 
	~<ngx_cÚfig.h
>

8 
	~<ngx_cÜe.h
>

9 
	~<ngx_üy±.h
>

10 
	~<ngx_md5.h
>

11 #ià(
NGX_HAVE_SHA1
)

12 
	~<ngx_sha1.h
>

16 #ià(
NGX_CRYPT
)

18 
ngx_št_t
 
ngx_üy±_­r1
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
,

19 
u_ch¬
 **
’üy±ed
);

20 
ngx_št_t
 
ngx_üy±_¶aš
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
,

21 
u_ch¬
 **
’üy±ed
);

23 #ià(
NGX_HAVE_SHA1
)

25 
ngx_št_t
 
ngx_üy±_ssha
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
,

26 
u_ch¬
 **
’üy±ed
);

27 
ngx_št_t
 
ngx_üy±_sha
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
,

28 
u_ch¬
 **
’üy±ed
);

33 
u_ch¬
 *
ngx_üy±_to64
(u_ch¬ *
p
, 
ušt32_t
 
v
, 
size_t
 
n
);

36 
ngx_št_t


37 
	$ngx_üy±
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
, u_ch¬ **
’üy±ed
)

39 ià(
	`ngx_¡ºcmp
(
§É
, "$apr1$", ("$apr1$") - 1) == 0) {

40  
	`ngx_üy±_­r1
(
poÞ
, 
key
, 
§É
, 
’üy±ed
);

42 } ià(
	`ngx_¡ºcmp
(
§É
, "{PLAIN}", ("{PLAIN}") - 1) == 0) {

43  
	`ngx_üy±_¶aš
(
poÞ
, 
key
, 
§É
, 
’üy±ed
);

45 #ià(
NGX_HAVE_SHA1
)

46 } ià(
	`ngx_¡ºcmp
(
§É
, "{SSHA}", ("{SSHA}") - 1) == 0) {

47  
	`ngx_üy±_ssha
(
poÞ
, 
key
, 
§É
, 
’üy±ed
);

49 } ià(
	`ngx_¡ºcmp
(
§É
, "{SHA}", ("{SHA}") - 1) == 0) {

50  
	`ngx_üy±_sha
(
poÞ
, 
key
, 
§É
, 
’üy±ed
);

56  
	`ngx_libc_üy±
(
poÞ
, 
key
, 
§É
, 
’üy±ed
);

57 
	}
}

60 
ngx_št_t


61 
	$ngx_üy±_­r1
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
, u_ch¬ **
’üy±ed
)

63 
ngx_št_t
 
n
;

64 
ngx_ušt_t
 
i
;

65 
u_ch¬
 *
p
, *
Ï¡
, 
fš®
[16];

66 
size_t
 
§ÉËn
, 
keyËn
;

67 
ngx_md5_t
 
md5
, 
ùx1
;

71 
keyËn
 = 
	`ngx_¡¾’
(
key
);

75 
§É
 += ("$apr1$") - 1;

76 
Ï¡
 = 
§É
 + 8;

77 
p
 = 
§É
; *°&& *°!ð'$' &&… < 
Ï¡
;…++) { }

78 
§ÉËn
 = 
p
 - 
§É
;

82 
	`ngx_md5_š™
(&
md5
);

83 
	`ngx_md5_upd©e
(&
md5
, 
key
, 
keyËn
);

84 
	`ngx_md5_upd©e
(&
md5
, (
u_ch¬
 *) "$apr1$", ("$apr1$") - 1);

85 
	`ngx_md5_upd©e
(&
md5
, 
§É
, 
§ÉËn
);

87 
	`ngx_md5_š™
(&
ùx1
);

88 
	`ngx_md5_upd©e
(&
ùx1
, 
key
, 
keyËn
);

89 
	`ngx_md5_upd©e
(&
ùx1
, 
§É
, 
§ÉËn
);

90 
	`ngx_md5_upd©e
(&
ùx1
, 
key
, 
keyËn
);

91 
	`ngx_md5_fš®
(
fš®
, &
ùx1
);

93 
n
 = 
keyËn
;‚ > 0;‚ -= 16) {

94 
	`ngx_md5_upd©e
(&
md5
, 
fš®
, 
n
 > 16 ? 16 :‚);

97 
	`ngx_memz”o
(
fš®
, (final));

99 
i
 = 
keyËn
; i; i >>= 1) {

100 ià(
i
 & 1) {

101 
	`ngx_md5_upd©e
(&
md5
, 
fš®
, 1);

104 
	`ngx_md5_upd©e
(&
md5
, 
key
, 1);

108 
	`ngx_md5_fš®
(
fš®
, &
md5
);

110 
i
 = 0; i < 1000; i++) {

111 
	`ngx_md5_š™
(&
ùx1
);

113 ià(
i
 & 1) {

114 
	`ngx_md5_upd©e
(&
ùx1
, 
key
, 
keyËn
);

117 
	`ngx_md5_upd©e
(&
ùx1
, 
fš®
, 16);

120 ià(
i
 % 3) {

121 
	`ngx_md5_upd©e
(&
ùx1
, 
§É
, 
§ÉËn
);

124 ià(
i
 % 7) {

125 
	`ngx_md5_upd©e
(&
ùx1
, 
key
, 
keyËn
);

128 ià(
i
 & 1) {

129 
	`ngx_md5_upd©e
(&
ùx1
, 
fš®
, 16);

132 
	`ngx_md5_upd©e
(&
ùx1
, 
key
, 
keyËn
);

135 
	`ngx_md5_fš®
(
fš®
, &
ùx1
);

140 *
’üy±ed
 = 
	`ngx_²®loc
(
poÞ
, ("$­r1$"è- 1 + 
§ÉËn
 + 1 + 22 + 1);

141 ià(*
’üy±ed
 =ð
NULL
) {

142  
NGX_ERROR
;

145 
p
 = 
	`ngx_ýymem
(*
’üy±ed
, "$apr1$", ("$apr1$") - 1);

146 
p
 = 
	`ngx_cÝy
Õ, 
§É
, 
§ÉËn
);

147 *
p
++ = '$';

149 
p
 = 
	`ngx_üy±_to64
Õ, (
fš®
[ 0]<<16) | (final[ 6]<<8) | final[12], 4);

150 
p
 = 
	`ngx_üy±_to64
Õ, (
fš®
[ 1]<<16) | (final[ 7]<<8) | final[13], 4);

151 
p
 = 
	`ngx_üy±_to64
Õ, (
fš®
[ 2]<<16) | (final[ 8]<<8) | final[14], 4);

152 
p
 = 
	`ngx_üy±_to64
Õ, (
fš®
[ 3]<<16) | (final[ 9]<<8) | final[15], 4);

153 
p
 = 
	`ngx_üy±_to64
Õ, (
fš®
[ 4]<<16) | (final[10]<<8) | final[ 5], 4);

154 
p
 = 
	`ngx_üy±_to64
Õ, 
fš®
[11], 2);

155 *
p
 = '\0';

157  
NGX_OK
;

158 
	}
}

161 
u_ch¬
 *

162 
	$ngx_üy±_to64
(
u_ch¬
 *
p
, 
ušt32_t
 
v
, 
size_t
 
n
)

164 
u_ch¬
 
™ß64
[] =

167 
n
--) {

168 *
p
++ = 
™ß64
[
v
 & 0x3f];

169 
v
 >>= 6;

172  
p
;

173 
	}
}

176 
ngx_št_t


177 
	$ngx_üy±_¶aš
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
, u_ch¬ **
’üy±ed
)

179 
size_t
 
Ën
;

180 
u_ch¬
 *
p
;

182 
Ën
 = 
	`ngx_¡¾’
(
key
);

184 *
’üy±ed
 = 
	`ngx_²®loc
(
poÞ
, ("{PLAIN}"è- 1 + 
Ën
 + 1);

185 ià(*
’üy±ed
 =ð
NULL
) {

186  
NGX_ERROR
;

189 
p
 = 
	`ngx_ýymem
(*
’üy±ed
, "{PLAIN}", ("{PLAIN}") - 1);

190 
	`ngx_memýy
(
p
, 
key
, 
Ën
 + 1);

192  
NGX_OK
;

193 
	}
}

196 #ià(
NGX_HAVE_SHA1
)

198 
ngx_št_t


199 
	$ngx_üy±_ssha
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
, u_ch¬ **
’üy±ed
)

201 
size_t
 
Ën
;

202 
ngx_št_t
 
rc
;

203 
ngx_¡r_t
 
’coded
, 
decoded
;

204 
ngx_sha1_t
 
sha1
;

210 
’coded
.
d©a
 = 
§É
 + ("{SSHA}") - 1;

211 
’coded
.
Ën
 = 
	`ngx_¡¾’
Óncoded.
d©a
);

213 
Ën
 = 
	`ngx_max
(
	`ngx_ba£64_decoded_Ëngth
(
’coded
.len), 20);

215 
decoded
.
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

216 ià(
decoded
.
d©a
 =ð
NULL
) {

217  
NGX_ERROR
;

220 
rc
 = 
	`ngx_decode_ba£64
(&
decoded
, &
’coded
);

222 ià(
rc
 !ð
NGX_OK
 || 
decoded
.
Ën
 < 20) {

223 
decoded
.
Ën
 = 20;

228 
	`ngx_sha1_š™
(&
sha1
);

229 
	`ngx_sha1_upd©e
(&
sha1
, 
key
, 
	`ngx_¡¾’
(key));

230 
	`ngx_sha1_upd©e
(&
sha1
, 
decoded
.
d©a
 + 20, decoded.
Ën
 - 20);

231 
	`ngx_sha1_fš®
(
decoded
.
d©a
, &
sha1
);

235 
Ën
 = ("{SSHA}"è- 1 + 
	`ngx_ba£64_’coded_Ëngth
(
decoded
.len) + 1;

237 *
’üy±ed
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

238 ià(*
’üy±ed
 =ð
NULL
) {

239  
NGX_ERROR
;

242 
’coded
.
d©a
 = 
	`ngx_ýymem
(*
’üy±ed
, "{SSHA}", ("{SSHA}") - 1);

243 
	`ngx_’code_ba£64
(&
’coded
, &
decoded
);

244 
’coded
.
d©a
[’coded.
Ën
] = '\0';

246  
NGX_OK
;

247 
	}
}

250 
ngx_št_t


251 
	$ngx_üy±_sha
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
, u_ch¬ **
’üy±ed
)

253 
size_t
 
Ën
;

254 
ngx_¡r_t
 
’coded
, 
decoded
;

255 
ngx_sha1_t
 
sha1
;

256 
u_ch¬
 
dige¡
[20];

260 
decoded
.
Ën
 = (
dige¡
);

261 
decoded
.
d©a
 = 
dige¡
;

263 
	`ngx_sha1_š™
(&
sha1
);

264 
	`ngx_sha1_upd©e
(&
sha1
, 
key
, 
	`ngx_¡¾’
(key));

265 
	`ngx_sha1_fš®
(
dige¡
, &
sha1
);

267 
Ën
 = ("{SHA}"è- 1 + 
	`ngx_ba£64_’coded_Ëngth
(
decoded
.len) + 1;

269 *
’üy±ed
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

270 ià(*
’üy±ed
 =ð
NULL
) {

271  
NGX_ERROR
;

274 
’coded
.
d©a
 = 
	`ngx_ýymem
(*
’üy±ed
, "{SHA}", ("{SHA}") - 1);

275 
	`ngx_’code_ba£64
(&
’coded
, &
decoded
);

276 
’coded
.
d©a
[’coded.
Ën
] = '\0';

278  
NGX_OK
;

279 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_cycle.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_de¡roy_cyþe_poÞs
(
ngx_cÚf_t
 *
cÚf
);

14 
ngx_št_t
 
ngx_š™_zÚe_poÞ
(
ngx_cyþe_t
 *
cyþe
,

15 
ngx_shm_zÚe_t
 *
shm_zÚe
);

16 
ngx_št_t
 
ngx_‹¡_lockfže
(
u_ch¬
 *
fže
, 
ngx_log_t
 *
log
);

17 
ngx_þ—n_Þd_cyþes
(
ngx_ev’t_t
 *
ev
);

20 vÞ©ž
ngx_cyþe_t
 *
	gngx_cyþe
;

21 
ngx_¬¿y_t
 
	gngx_Þd_cyþes
;

23 
ngx_poÞ_t
 *
	gngx_‹mp_poÞ
;

24 
ngx_ev’t_t
 
	gngx_þ—Ãr_ev’t
;

26 
ngx_ušt_t
 
	gngx_‹¡_cÚfig
;

27 
ngx_ušt_t
 
	gngx_qu›t_mode
;

29 #ià(
NGX_THREADS
)

30 
ngx_Žs_key_t
 
	gngx_cÜe_Žs_key
;

35 
ngx_cÚÃùiÚ_t
 
	gdumb
;

39 
ngx_cyþe_t
 *

40 
	$ngx_š™_cyþe
(
ngx_cyþe_t
 *
Þd_cyþe
)

42 *
rv
;

43 **
£nv
, **
’v
;

44 
ngx_ušt_t
 
i
, 
n
;

45 
ngx_log_t
 *
log
;

46 
ngx_time_t
 *

;

47 
ngx_cÚf_t
 
cÚf
;

48 
ngx_poÞ_t
 *
poÞ
;

49 
ngx_cyþe_t
 *
cyþe
, **
Þd
;

50 
ngx_shm_zÚe_t
 *
shm_zÚe
, *
oshm_zÚe
;

51 
ngx_li¡_·¹_t
 *
·¹
, *
Ý¬t
;

52 
ngx_Ý’_fže_t
 *
fže
;

53 
ngx_li¡’šg_t
 *
ls
, *
Æs
;

54 
ngx_cÜe_cÚf_t
 *
ccf
, *
Þd_ccf
;

55 
ngx_cÜe_moduË_t
 *
moduË
;

56 
ho¡Çme
[
NGX_MAXHOSTNAMELEN
];

58 
	`ngx_timezÚe_upd©e
();

62 

 = 
	`ngx_timeofday
();

63 

->
£c
 = 0;

65 
	`ngx_time_upd©e
();

68 
log
 = 
Þd_cyþe
->log;

70 
poÞ
 = 
	`ngx_ü—‹_poÞ
(
NGX_CYCLE_POOL_SIZE
, 
log
);

71 ià(
poÞ
 =ð
NULL
) {

72  
NULL
;

74 
poÞ
->
log
 =†og;

76 
cyþe
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_cyþe_t
));

77 ià(
cyþe
 =ð
NULL
) {

78 
	`ngx_de¡roy_poÞ
(
poÞ
);

79  
NULL
;

82 
cyþe
->
poÞ
 =…ool;

83 
cyþe
->
log
 =†og;

84 
cyþe
->
Þd_cyþe
 = old_cycle;

86 
cyþe
->
cÚf_´efix
.
Ën
 = 
Þd_cyþe
->conf_prefix.len;

87 
cyþe
->
cÚf_´efix
.
d©a
 = 
	`ngx_p¡rdup
(
poÞ
, &
Þd_cyþe
->conf_prefix);

88 ià(
cyþe
->
cÚf_´efix
.
d©a
 =ð
NULL
) {

89 
	`ngx_de¡roy_poÞ
(
poÞ
);

90  
NULL
;

93 
cyþe
->
´efix
.
Ën
 = 
Þd_cyþe
->prefix.len;

94 
cyþe
->
´efix
.
d©a
 = 
	`ngx_p¡rdup
(
poÞ
, &
Þd_cyþe
->prefix);

95 ià(
cyþe
->
´efix
.
d©a
 =ð
NULL
) {

96 
	`ngx_de¡roy_poÞ
(
poÞ
);

97  
NULL
;

100 
cyþe
->
cÚf_fže
.
Ën
 = 
Þd_cyþe
->conf_file.len;

101 
cyþe
->
cÚf_fže
.
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
Þd_cyþe
->cÚf_fže.
Ën
 + 1);

102 ià(
cyþe
->
cÚf_fže
.
d©a
 =ð
NULL
) {

103 
	`ngx_de¡roy_poÞ
(
poÞ
);

104  
NULL
;

106 
	`ngx_ýy¡º
(
cyþe
->
cÚf_fže
.
d©a
, 
Þd_cyþe
->conf_file.data,

107 
Þd_cyþe
->
cÚf_fže
.
Ën
 + 1);

109 
cyþe
->
cÚf_·¿m
.
Ën
 = 
Þd_cyþe
->conf_param.len;

110 
cyþe
->
cÚf_·¿m
.
d©a
 = 
	`ngx_p¡rdup
(
poÞ
, &
Þd_cyþe
->conf_param);

111 ià(
cyþe
->
cÚf_·¿m
.
d©a
 =ð
NULL
) {

112 
	`ngx_de¡roy_poÞ
(
poÞ
);

113  
NULL
;

117 
n
 = 
Þd_cyþe
->
·ths
.
ÃÉs
 ? old_cycle->paths.nelts : 10;

119 
cyþe
->
·ths
.
–ts
 = 
	`ngx_pÿÎoc
(
poÞ
, 
n
 * (
ngx_·th_t
 *));

120 ià(
cyþe
->
·ths
.
–ts
 =ð
NULL
) {

121 
	`ngx_de¡roy_poÞ
(
poÞ
);

122  
NULL
;

125 
cyþe
->
·ths
.
ÃÉs
 = 0;

126 
cyþe
->
·ths
.
size
 = (
ngx_·th_t
 *);

127 
cyþe
->
·ths
.
ÇÎoc
 = 
n
;

128 
cyþe
->
·ths
.
poÞ
 =…ool;

131 ià(
Þd_cyþe
->
Ý’_fžes
.
·¹
.
ÃÉs
) {

132 
n
 = 
Þd_cyþe
->
Ý’_fžes
.
·¹
.
ÃÉs
;

133 
·¹
 = 
Þd_cyþe
->
Ý’_fžes
.·¹.
Ãxt
;…art;…art =…art->next) {

134 
n
 +ð
·¹
->
ÃÉs
;

138 
n
 = 20;

141 ià(
	`ngx_li¡_š™
(&
cyþe
->
Ý’_fžes
, 
poÞ
, 
n
, (
ngx_Ý’_fže_t
))

142 !ð
NGX_OK
)

144 
	`ngx_de¡roy_poÞ
(
poÞ
);

145  
NULL
;

149 ià(
Þd_cyþe
->
sh¬ed_memÜy
.
·¹
.
ÃÉs
) {

150 
n
 = 
Þd_cyþe
->
sh¬ed_memÜy
.
·¹
.
ÃÉs
;

151 
·¹
 = 
Þd_cyþe
->
sh¬ed_memÜy
.·¹.
Ãxt
;…art;…art =…art->next)

153 
n
 +ð
·¹
->
ÃÉs
;

157 
n
 = 1;

160 ià(
	`ngx_li¡_š™
(&
cyþe
->
sh¬ed_memÜy
, 
poÞ
, 
n
, (
ngx_shm_zÚe_t
))

161 !ð
NGX_OK
)

163 
	`ngx_de¡roy_poÞ
(
poÞ
);

164  
NULL
;

167 
n
 = 
Þd_cyþe
->
li¡’šg
.
ÃÉs
 ? old_cycle->listening.nelts : 10;

169 
cyþe
->
li¡’šg
.
–ts
 = 
	`ngx_pÿÎoc
(
poÞ
, 
n
 * (
ngx_li¡’šg_t
));

170 ià(
cyþe
->
li¡’šg
.
–ts
 =ð
NULL
) {

171 
	`ngx_de¡roy_poÞ
(
poÞ
);

172  
NULL
;

175 
cyþe
->
li¡’šg
.
ÃÉs
 = 0;

176 
cyþe
->
li¡’šg
.
size
 = (
ngx_li¡’šg_t
);

177 
cyþe
->
li¡’šg
.
ÇÎoc
 = 
n
;

178 
cyþe
->
li¡’šg
.
poÞ
 =…ool;

181 
	`ngx_queue_š™
(&
cyþe
->
»u§bË_cÚÃùiÚs_queue
);

184 
cyþe
->
cÚf_ùx
 = 
	`ngx_pÿÎoc
(
poÞ
, 
ngx_max_moduË
 * (*));

185 ià(
cyþe
->
cÚf_ùx
 =ð
NULL
) {

186 
	`ngx_de¡roy_poÞ
(
poÞ
);

187  
NULL
;

191 ià(
	`g‘ho¡Çme
(
ho¡Çme
, 
NGX_MAXHOSTNAMELEN
) == -1) {

192 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
, "gethostname() failed");

193 
	`ngx_de¡roy_poÞ
(
poÞ
);

194  
NULL
;

199 
ho¡Çme
[
NGX_MAXHOSTNAMELEN
 - 1] = '\0';

200 
cyþe
->
ho¡Çme
.
Ën
 = 
	`ngx_¡¾’
(hostname);

202 
cyþe
->
ho¡Çme
.
d©a
 = 
	`ngx_²®loc
(
poÞ
, cyþe->ho¡Çme.
Ën
);

203 ià(
cyþe
->
ho¡Çme
.
d©a
 =ð
NULL
) {

204 
	`ngx_de¡roy_poÞ
(
poÞ
);

205  
NULL
;

208 
	`ngx_¡¾ow
(
cyþe
->
ho¡Çme
.
d©a
, (
u_ch¬
 *èho¡Çme, cyþe->ho¡Çme.
Ën
);

211 
i
 = 0; 
ngx_moduËs
[i]; i++) {

212 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_CORE_MODULE
) {

216 
moduË
 = 
ngx_moduËs
[
i
]->
ùx
;

218 ià(
moduË
->
ü—‹_cÚf
) {

219 
rv
 = 
moduË
->
	`ü—‹_cÚf
(
cyþe
);

220 ià(
rv
 =ð
NULL
) {

221 
	`ngx_de¡roy_poÞ
(
poÞ
);

222  
NULL
;

224 
cyþe
->
cÚf_ùx
[
ngx_moduËs
[
i
]->
šdex
] = 
rv
;

229 
£nv
 = 
’vœÚ
;

232 
	`ngx_memz”o
(&
cÚf
, (
ngx_cÚf_t
));

234 
cÚf
.
¬gs
 = 
	`ngx_¬¿y_ü—‹
(
poÞ
, 10, (
ngx_¡r_t
));

235 ià(
cÚf
.
¬gs
 =ð
NULL
) {

236 
	`ngx_de¡roy_poÞ
(
poÞ
);

237  
NULL
;

240 
cÚf
.
‹mp_poÞ
 = 
	`ngx_ü—‹_poÞ
(
NGX_CYCLE_POOL_SIZE
, 
log
);

241 ià(
cÚf
.
‹mp_poÞ
 =ð
NULL
) {

242 
	`ngx_de¡roy_poÞ
(
poÞ
);

243  
NULL
;

247 
cÚf
.
ùx
 = 
cyþe
->
cÚf_ùx
;

248 
cÚf
.
cyþe
 = cycle;

249 
cÚf
.
poÞ
 =…ool;

250 
cÚf
.
log
 =†og;

251 
cÚf
.
moduË_ty³
 = 
NGX_CORE_MODULE
;

252 
cÚf
.
cmd_ty³
 = 
NGX_MAIN_CONF
;

255 
log
->
log_Ëv–
 = 
NGX_LOG_DEBUG_ALL
;

258 ià(
	`ngx_cÚf_·¿m
(&
cÚf
è!ð
NGX_CONF_OK
) {

259 
’vœÚ
 = 
£nv
;

260 
	`ngx_de¡roy_cyþe_poÞs
(&
cÚf
);

261  
NULL
;

264 ià(
	`ngx_cÚf_·r£
(&
cÚf
, &
cyþe
->
cÚf_fže
è!ð
NGX_CONF_OK
) {

265 
’vœÚ
 = 
£nv
;

266 
	`ngx_de¡roy_cyþe_poÞs
(&
cÚf
);

267  
NULL
;

270 ià(
ngx_‹¡_cÚfig
 && !
ngx_qu›t_mode
) {

271 
	`ngx_log_¡d”r
(0, "the configuration file %s syntax is ok",

272 
cyþe
->
cÚf_fže
.
d©a
);

275 
i
 = 0; 
ngx_moduËs
[i]; i++) {

276 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_CORE_MODULE
) {

280 
moduË
 = 
ngx_moduËs
[
i
]->
ùx
;

282 ià(
moduË
->
š™_cÚf
) {

283 ià(
moduË
->
	`š™_cÚf
(
cyþe
, cyþe->
cÚf_ùx
[
ngx_moduËs
[
i
]->
šdex
])

284 =ð
NGX_CONF_ERROR
)

286 
’vœÚ
 = 
£nv
;

287 
	`ngx_de¡roy_cyþe_poÞs
(&
cÚf
);

288  
NULL
;

293 ià(
ngx_´oûss
 =ð
NGX_PROCESS_SIGNALLER
) {

294  
cyþe
;

297 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

299 ià(
ngx_‹¡_cÚfig
) {

301 ià(
	`ngx_ü—‹_pidfže
(&
ccf
->
pid
, 
log
è!ð
NGX_OK
) {

302 
çžed
;

305 } ià(!
	`ngx_is_š™_cyþe
(
Þd_cyþe
)) {

312 
Þd_ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
Þd_cyþe
->
cÚf_ùx
,

313 
ngx_cÜe_moduË
);

314 ià(
ccf
->
pid
.
Ën
 !ð
Þd_ccf
->pid.len

315 || 
	`ngx_¡rcmp
(
ccf
->
pid
.
d©a
, 
Þd_ccf
->pid.data) != 0)

319 ià(
	`ngx_ü—‹_pidfže
(&
ccf
->
pid
, 
log
è!ð
NGX_OK
) {

320 
çžed
;

323 
	`ngx_d–‘e_pidfže
(
Þd_cyþe
);

328 ià(
	`ngx_‹¡_lockfže
(
cyþe
->
lock_fže
.
d©a
, 
log
è!ð
NGX_OK
) {

329 
çžed
;

333 ià(
	`ngx_ü—‹_·ths
(
cyþe
, 
ccf
->
u£r
è!ð
NGX_OK
) {

334 
çžed
;

338 ià(
	`ngx_log_Ý’_deçuÉ
(
cyþe
è!ð
NGX_OK
) {

339 
çžed
;

344 
·¹
 = &
cyþe
->
Ý’_fžes
.part;

345 
fže
 = 
·¹
->
–ts
;

347 
i
 = 0; ; i++) {

349 ià(
i
 >ð
·¹
->
ÃÉs
) {

350 ià(
·¹
->
Ãxt
 =ð
NULL
) {

353 
·¹
 =…¬t->
Ãxt
;

354 
fže
 = 
·¹
->
–ts
;

355 
i
 = 0;

358 ià(
fže
[
i
].
Çme
.
Ën
 == 0) {

362 
fže
[
i
].
fd
 = 
	`ngx_Ý’_fže
(fže[i].
Çme
.
d©a
,

363 
NGX_FILE_APPEND
,

364 
NGX_FILE_CREATE_OR_OPEN
,

365 
NGX_FILE_DEFAULT_ACCESS
);

367 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

369 &
fže
[
i
], fže[i].
fd
, fže[i].
Çme
.
d©a
);

371 ià(
fže
[
i
].
fd
 =ð
NGX_INVALID_FILE
) {

372 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

373 
ngx_Ý’_fže_n
 " \"%s\" failed",

374 
fže
[
i
].
Çme
.
d©a
);

375 
çžed
;

378 #ià!(
NGX_WIN32
)

379 ià(
	`fúŽ
(
fže
[
i
].
fd
, 
F_SETFD
, 
FD_CLOEXEC
) == -1) {

380 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

382 
fže
[
i
].
Çme
.
d©a
);

383 
çžed
;

388 
cyþe
->
log
 = &cyþe->
Ãw_log
;

389 
poÞ
->
log
 = &
cyþe
->
Ãw_log
;

394 
·¹
 = &
cyþe
->
sh¬ed_memÜy
.part;

395 
shm_zÚe
 = 
·¹
->
–ts
;

397 
i
 = 0; ; i++) {

399 ià(
i
 >ð
·¹
->
ÃÉs
) {

400 ià(
·¹
->
Ãxt
 =ð
NULL
) {

403 
·¹
 =…¬t->
Ãxt
;

404 
shm_zÚe
 = 
·¹
->
–ts
;

405 
i
 = 0;

408 ià(
shm_zÚe
[
i
].
shm
.
size
 == 0) {

409 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 0,

411 &
shm_zÚe
[
i
].
shm
.
Çme
);

412 
çžed
;

415 
shm_zÚe
[
i
].
shm
.
log
 = 
cyþe
->log;

417 
Ý¬t
 = &
Þd_cyþe
->
sh¬ed_memÜy
.
·¹
;

418 
oshm_zÚe
 = 
Ý¬t
->
–ts
;

420 
n
 = 0; ;‚++) {

422 ià(
n
 >ð
Ý¬t
->
ÃÉs
) {

423 ià(
Ý¬t
->
Ãxt
 =ð
NULL
) {

426 
Ý¬t
 = o·¹->
Ãxt
;

427 
oshm_zÚe
 = 
Ý¬t
->
–ts
;

428 
n
 = 0;

431 ià(
shm_zÚe
[
i
].
shm
.
Çme
.
Ën
 !ð
oshm_zÚe
[
n
].shm.name.len) {

435 ià(
	`ngx_¡ºcmp
(
shm_zÚe
[
i
].
shm
.
Çme
.
d©a
,

436 
oshm_zÚe
[
n
].
shm
.
Çme
.
d©a
,

437 
shm_zÚe
[
i
].
shm
.
Çme
.
Ën
)

443 ià(
shm_zÚe
[
i
].
g
 =ð
oshm_zÚe
[
n
].tag

444 && 
shm_zÚe
[
i
].
shm
.
size
 =ð
oshm_zÚe
[
n
].shm.size)

446 
shm_zÚe
[
i
].
shm
.
addr
 = 
oshm_zÚe
[
n
].shm.addr;

448 ià(
shm_zÚe
[
i
].
	`š™
(&shm_zÚe[i], 
oshm_zÚe
[
n
].
d©a
)

449 !ð
NGX_OK
)

451 
çžed
;

454 
shm_zÚe_found
;

457 
	`ngx_shm_ä“
(&
oshm_zÚe
[
n
].
shm
);

462 ià(
	`ngx_shm_®loc
(&
shm_zÚe
[
i
].
shm
è!ð
NGX_OK
) {

463 
çžed
;

466 ià(
	`ngx_š™_zÚe_poÞ
(
cyþe
, &
shm_zÚe
[
i
]è!ð
NGX_OK
) {

467 
çžed
;

470 ià(
shm_zÚe
[
i
].
	`š™
(&shm_zÚe[i], 
NULL
è!ð
NGX_OK
) {

471 
çžed
;

474 
shm_zÚe_found
:

482 ià(
Þd_cyþe
->
li¡’šg
.
ÃÉs
) {

483 
ls
 = 
Þd_cyþe
->
li¡’šg
.
–ts
;

484 
i
 = 0; i < 
Þd_cyþe
->
li¡’šg
.
ÃÉs
; i++) {

485 
ls
[
i
].
»maš
 = 0;

488 
Æs
 = 
cyþe
->
li¡’šg
.
–ts
;

489 
n
 = 0;‚ < 
cyþe
->
li¡’šg
.
ÃÉs
;‚++) {

491 
i
 = 0; i < 
Þd_cyþe
->
li¡’šg
.
ÃÉs
; i++) {

492 ià(
ls
[
i
].
ignÜe
) {

496 ià(
	`ngx_cmp_sockaddr
(
Æs
[
n
].
sockaddr
,‚ls[n].
sockËn
,

497 
ls
[
i
].
sockaddr
,†s[i].
sockËn
, 1)

498 =ð
NGX_OK
)

500 
Æs
[
n
].
fd
 = 
ls
[
i
].fd;

501 
Æs
[
n
].
´evious
 = &
ls
[
i
];

502 
ls
[
i
].
»maš
 = 1;

504 ià(
ls
[
i
].
backlog
 !ð
Æs
[
n
].backlog) {

505 
Æs
[
n
].
li¡’
 = 1;

508 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
SO_ACCEPTFILTER
)

514 
Æs
[
n
].
deã¼ed_acû±
 = 
ls
[
i
].deferred_accept;

516 ià(
ls
[
i
].
acû±_fž‹r
 && 
Æs
[
n
].accept_filter) {

517 ià(
	`ngx_¡rcmp
(
ls
[
i
].
acû±_fž‹r
,

518 
Æs
[
n
].
acû±_fž‹r
)

521 
Æs
[
n
].
d–‘e_deã¼ed
 = 1;

522 
Æs
[
n
].
add_deã¼ed
 = 1;

525 } ià(
ls
[
i
].
acû±_fž‹r
) {

526 
Æs
[
n
].
d–‘e_deã¼ed
 = 1;

528 } ià(
Æs
[
n
].
acû±_fž‹r
) {

529 
Æs
[
n
].
add_deã¼ed
 = 1;

533 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
TCP_DEFER_ACCEPT
)

535 ià(
ls
[
i
].
deã¼ed_acû±
 && !
Æs
[
n
].deferred_accept) {

536 
Æs
[
n
].
d–‘e_deã¼ed
 = 1;

538 } ià(
ls
[
i
].
deã¼ed_acû±
 !ð
Æs
[
n
].deferred_accept)

540 
Æs
[
n
].
add_deã¼ed
 = 1;

547 ià(
Æs
[
n
].
fd
 =ð(
ngx_sock‘_t
) -1) {

548 
Æs
[
n
].
Ý’
 = 1;

549 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
SO_ACCEPTFILTER
)

550 ià(
Æs
[
n
].
acû±_fž‹r
) {

551 
Æs
[
n
].
add_deã¼ed
 = 1;

554 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
TCP_DEFER_ACCEPT
)

555 ià(
Æs
[
n
].
deã¼ed_acû±
) {

556 
Æs
[
n
].
add_deã¼ed
 = 1;

563 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

564 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

565 
ls
[
i
].
Ý’
 = 1;

566 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
SO_ACCEPTFILTER
)

567 ià(
ls
[
i
].
acû±_fž‹r
) {

568 
ls
[
i
].
add_deã¼ed
 = 1;

571 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
TCP_DEFER_ACCEPT
)

572 ià(
ls
[
i
].
deã¼ed_acû±
) {

573 
ls
[
i
].
add_deã¼ed
 = 1;

579 ià(
	`ngx_Ý’_li¡’šg_sock‘s
(
cyþe
è!ð
NGX_OK
) {

580 
çžed
;

583 ià(!
ngx_‹¡_cÚfig
) {

584 
	`ngx_cÚfigu»_li¡’šg_sock‘s
(
cyþe
);

590 ià(!
ngx_u£_¡d”r
) {

591 (è
	`ngx_log_»dœeù_¡d”r
(
cyþe
);

594 
poÞ
->
log
 = 
cyþe
->log;

596 
i
 = 0; 
ngx_moduËs
[i]; i++) {

597 ià(
ngx_moduËs
[
i
]->
š™_moduË
) {

598 ià(
ngx_moduËs
[
i
]->
	`š™_moduË
(
cyþe
è!ð
NGX_OK
) {

600 
	`ex™
(1);

610 
Ý¬t
 = &
Þd_cyþe
->
sh¬ed_memÜy
.
·¹
;

611 
oshm_zÚe
 = 
Ý¬t
->
–ts
;

613 
i
 = 0; ; i++) {

615 ià(
i
 >ð
Ý¬t
->
ÃÉs
) {

616 ià(
Ý¬t
->
Ãxt
 =ð
NULL
) {

617 
Þd_shm_zÚe_dÚe
;

619 
Ý¬t
 = o·¹->
Ãxt
;

620 
oshm_zÚe
 = 
Ý¬t
->
–ts
;

621 
i
 = 0;

624 
·¹
 = &
cyþe
->
sh¬ed_memÜy
.part;

625 
shm_zÚe
 = 
·¹
->
–ts
;

627 
n
 = 0; ;‚++) {

629 ià(
n
 >ð
·¹
->
ÃÉs
) {

630 ià(
·¹
->
Ãxt
 =ð
NULL
) {

633 
·¹
 =…¬t->
Ãxt
;

634 
shm_zÚe
 = 
·¹
->
–ts
;

635 
n
 = 0;

638 ià(
oshm_zÚe
[
i
].
shm
.
Çme
.
Ën
 =ð
shm_zÚe
[
n
].shm.name.len

639 && 
	`ngx_¡ºcmp
(
oshm_zÚe
[
i
].
shm
.
Çme
.
d©a
,

640 
shm_zÚe
[
n
].
shm
.
Çme
.
d©a
,

641 
oshm_zÚe
[
i
].
shm
.
Çme
.
Ën
)

644 
live_shm_zÚe
;

648 
	`ngx_shm_ä“
(&
oshm_zÚe
[
i
].
shm
);

650 
live_shm_zÚe
:

655 
Þd_shm_zÚe_dÚe
:

660 
ls
 = 
Þd_cyþe
->
li¡’šg
.
–ts
;

661 
i
 = 0; i < 
Þd_cyþe
->
li¡’šg
.
ÃÉs
; i++) {

663 ià(
ls
[
i
].
»maš
 ||†s[i].
fd
 =ð(
ngx_sock‘_t
) -1) {

667 ià(
	`ngx_þo£_sock‘
(
ls
[
i
].
fd
) == -1) {

668 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

669 
ngx_þo£_sock‘_n
 "†istening socket on %V failed",

670 &
ls
[
i
].
addr_‹xt
);

673 #ià(
NGX_HAVE_UNIX_DOMAIN
)

675 ià(
ls
[
i
].
sockaddr
->
§_çmžy
 =ð
AF_UNIX
) {

676 
u_ch¬
 *
Çme
;

678 
Çme
 = 
ls
[
i
].
addr_‹xt
.
d©a
 + ("unix:") - 1;

680 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
cyþe
->
log
, 0,

681 "d–‘šg sock‘ %s", 
Çme
);

683 ià(
	`ngx_d–‘e_fže
(
Çme
è=ð
NGX_FILE_ERROR
) {

684 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

685 
ngx_d–‘e_fže_n
 " % çžed", 
Çme
);

695 
·¹
 = &
Þd_cyþe
->
Ý’_fžes
.part;

696 
fže
 = 
·¹
->
–ts
;

698 
i
 = 0; ; i++) {

700 ià(
i
 >ð
·¹
->
ÃÉs
) {

701 ià(
·¹
->
Ãxt
 =ð
NULL
) {

704 
·¹
 =…¬t->
Ãxt
;

705 
fže
 = 
·¹
->
–ts
;

706 
i
 = 0;

709 ià(
fže
[
i
].
fd
 =ð
NGX_INVALID_FILE
 || fže[i].fd =ð
ngx_¡d”r
) {

713 ià(
	`ngx_þo£_fže
(
fže
[
i
].
fd
è=ð
NGX_FILE_ERROR
) {

714 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

715 
ngx_þo£_fže_n
 " \"%s\" failed",

716 
fže
[
i
].
Çme
.
d©a
);

720 
	`ngx_de¡roy_poÞ
(
cÚf
.
‹mp_poÞ
);

722 ià(
ngx_´oûss
 =ð
NGX_PROCESS_MASTER
 || 
	`ngx_is_š™_cyþe
(
Þd_cyþe
)) {

730 
’v
 = 
’vœÚ
;

731 
’vœÚ
 = 
£nv
;

733 
	`ngx_de¡roy_poÞ
(
Þd_cyþe
->
poÞ
);

734 
cyþe
->
Þd_cyþe
 = 
NULL
;

736 
’vœÚ
 = 
’v
;

738  
cyþe
;

742 ià(
ngx_‹mp_poÞ
 =ð
NULL
) {

743 
ngx_‹mp_poÞ
 = 
	`ngx_ü—‹_poÞ
(128, 
cyþe
->
log
);

744 ià(
ngx_‹mp_poÞ
 =ð
NULL
) {

745 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

747 
	`ex™
(1);

750 
n
 = 10;

751 
ngx_Þd_cyþes
.
–ts
 = 
	`ngx_pÿÎoc
(
ngx_‹mp_poÞ
,

752 
n
 * (
ngx_cyþe_t
 *));

753 ià(
ngx_Þd_cyþes
.
–ts
 =ð
NULL
) {

754 
	`ex™
(1);

756 
ngx_Þd_cyþes
.
ÃÉs
 = 0;

757 
ngx_Þd_cyþes
.
size
 = (
ngx_cyþe_t
 *);

758 
ngx_Þd_cyþes
.
ÇÎoc
 = 
n
;

759 
ngx_Þd_cyþes
.
poÞ
 = 
ngx_‹mp_poÞ
;

761 
ngx_þ—Ãr_ev’t
.
hªdËr
 = 
ngx_þ—n_Þd_cyþes
;

762 
ngx_þ—Ãr_ev’t
.
log
 = 
cyþe
->log;

763 
ngx_þ—Ãr_ev’t
.
d©a
 = &
dumb
;

764 
dumb
.
fd
 = (
ngx_sock‘_t
) -1;

767 
ngx_‹mp_poÞ
->
log
 = 
cyþe
->log;

769 
Þd
 = 
	`ngx_¬¿y_push
(&
ngx_Þd_cyþes
);

770 ià(
Þd
 =ð
NULL
) {

771 
	`ex™
(1);

773 *
Þd
 = 
Þd_cyþe
;

775 ià(!
ngx_þ—Ãr_ev’t
.
tim”_£t
) {

776 
	`ngx_add_tim”
(&
ngx_þ—Ãr_ev’t
, 30000);

777 
ngx_þ—Ãr_ev’t
.
tim”_£t
 = 1;

780  
cyþe
;

783 
çžed
:

785 ià(!
	`ngx_is_š™_cyþe
(
Þd_cyþe
)) {

786 
Þd_ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
Þd_cyþe
->
cÚf_ùx
,

787 
ngx_cÜe_moduË
);

788 ià(
Þd_ccf
->
’vœÚm’t
) {

789 
’vœÚ
 = 
Þd_ccf
->
’vœÚm’t
;

795 
·¹
 = &
cyþe
->
Ý’_fžes
.part;

796 
fže
 = 
·¹
->
–ts
;

798 
i
 = 0; ; i++) {

800 ià(
i
 >ð
·¹
->
ÃÉs
) {

801 ià(
·¹
->
Ãxt
 =ð
NULL
) {

804 
·¹
 =…¬t->
Ãxt
;

805 
fže
 = 
·¹
->
–ts
;

806 
i
 = 0;

809 ià(
fže
[
i
].
fd
 =ð
NGX_INVALID_FILE
 || fže[i].fd =ð
ngx_¡d”r
) {

813 ià(
	`ngx_þo£_fže
(
fže
[
i
].
fd
è=ð
NGX_FILE_ERROR
) {

814 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

815 
ngx_þo£_fže_n
 " \"%s\" failed",

816 
fže
[
i
].
Çme
.
d©a
);

820 ià(
ngx_‹¡_cÚfig
) {

821 
	`ngx_de¡roy_cyþe_poÞs
(&
cÚf
);

822  
NULL
;

825 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

826 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

827 ià(
ls
[
i
].
fd
 =ð(
ngx_sock‘_t
è-1 || !ls[i].
Ý’
) {

831 ià(
	`ngx_þo£_sock‘
(
ls
[
i
].
fd
) == -1) {

832 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_sock‘_”ºo
,

833 
ngx_þo£_sock‘_n
 " %V failed",

834 &
ls
[
i
].
addr_‹xt
);

838 
	`ngx_de¡roy_cyþe_poÞs
(&
cÚf
);

840  
NULL
;

841 
	}
}

845 
	$ngx_de¡roy_cyþe_poÞs
(
ngx_cÚf_t
 *
cÚf
)

847 
	`ngx_de¡roy_poÞ
(
cÚf
->
‹mp_poÞ
);

848 
	`ngx_de¡roy_poÞ
(
cÚf
->
poÞ
);

849 
	}
}

852 
ngx_št_t


853 
	$ngx_š™_zÚe_poÞ
(
ngx_cyþe_t
 *
cyþe
, 
ngx_shm_zÚe_t
 *
zn
)

855 
u_ch¬
 *
fže
;

856 
ngx_¦ab_poÞ_t
 *
¥
;

858 
¥
 = (
ngx_¦ab_poÞ_t
 *è
zn
->
shm
.
addr
;

860 ià(
zn
->
shm
.
exi¡s
) {

862 ià(
¥
 =ð¥->
addr
) {

863  
NGX_OK
;

866 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

868 &
zn
->
shm
.
Çme
, 
¥
->
addr
, sp);

869  
NGX_ERROR
;

872 
¥
->
’d
 = 
zn
->
shm
.
addr
 + zn->shm.
size
;

873 
¥
->
mš_shiá
 = 3;

874 
¥
->
addr
 = 
zn
->
shm
.addr;

876 #ià(
NGX_HAVE_ATOMIC_OPS
)

878 
fže
 = 
NULL
;

882 
fže
 = 
	`ngx_²®loc
(
cyþe
->
poÞ
, cyþe->
lock_fže
.
Ën
 + 
zn
->
shm
.
Çme
.len);

883 ià(
fže
 =ð
NULL
) {

884  
NGX_ERROR
;

887 (è
	`ngx_¥rštf
(
fže
, "%V%V%Z", &
cyþe
->
lock_fže
, &
zn
->
shm
.
Çme
);

891 ià(
	`ngx_shmtx_ü—‹
(&
¥
->
mu‹x
, &¥->
lock
, 
fže
è!ð
NGX_OK
) {

892  
NGX_ERROR
;

895 
	`ngx_¦ab_š™
(
¥
);

897  
NGX_OK
;

898 
	}
}

901 
ngx_št_t


902 
	$ngx_ü—‹_pidfže
(
ngx_¡r_t
 *
Çme
, 
ngx_log_t
 *
log
)

904 
size_t
 
Ën
;

905 
ngx_ušt_t
 
ü—‹
;

906 
ngx_fže_t
 
fže
;

907 
u_ch¬
 
pid
[
NGX_INT64_LEN
 + 2];

909 ià(
ngx_´oûss
 > 
NGX_PROCESS_MASTER
) {

910  
NGX_OK
;

913 
	`ngx_memz”o
(&
fže
, (
ngx_fže_t
));

915 
fže
.
Çme
 = *name;

916 
fže
.
log
 =†og;

918 
ü—‹
 = 
ngx_‹¡_cÚfig
 ? 
NGX_FILE_CREATE_OR_OPEN
 : 
NGX_FILE_TRUNCATE
;

920 
fže
.
fd
 = 
	`ngx_Ý’_fže
(fže.
Çme
.
d©a
, 
NGX_FILE_RDWR
,

921 
ü—‹
, 
NGX_FILE_DEFAULT_ACCESS
);

923 ià(
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

924 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

925 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
fže
.
Çme
.
d©a
);

926  
NGX_ERROR
;

929 ià(!
ngx_‹¡_cÚfig
) {

930 
Ën
 = 
	`ngx_¢´štf
(
pid
, 
NGX_INT64_LEN
 + 2, "%P%N", 
ngx_pid
) -…id;

932 ià(
	`ngx_wr™e_fže
(&
fže
, 
pid
, 
Ën
, 0è=ð
NGX_ERROR
) {

933  
NGX_ERROR
;

937 ià(
	`ngx_þo£_fže
(
fže
.
fd
è=ð
NGX_FILE_ERROR
) {

938 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

939 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fže
.
Çme
.
d©a
);

942  
NGX_OK
;

943 
	}
}

947 
	$ngx_d–‘e_pidfže
(
ngx_cyþe_t
 *
cyþe
)

949 
u_ch¬
 *
Çme
;

950 
ngx_cÜe_cÚf_t
 *
ccf
;

952 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

954 
Çme
 = 
ngx_Ãw_bš¬y
 ? 
ccf
->
Þdpid
.
d©a
 : ccf->
pid
.data;

956 ià(
	`ngx_d–‘e_fže
(
Çme
è=ð
NGX_FILE_ERROR
) {

957 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

958 
ngx_d–‘e_fže_n
 " \"%s\" fažed", 
Çme
);

960 
	}
}

963 
ngx_št_t


964 
	$ngx_sigÇl_´oûss
(
ngx_cyþe_t
 *
cyþe
, *
sig
)

966 
ssize_t
 
n
;

967 
ngx_št_t
 
pid
;

968 
ngx_fže_t
 
fže
;

969 
ngx_cÜe_cÚf_t
 *
ccf
;

970 
u_ch¬
 
buf
[
NGX_INT64_LEN
 + 2];

972 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "signal…rocess started");

974 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

976 
	`ngx_memz”o
(&
fže
, (
ngx_fže_t
));

978 
fže
.
Çme
 = 
ccf
->
pid
;

979 
fže
.
log
 = 
cyþe
->log;

981 
fže
.
fd
 = 
	`ngx_Ý’_fže
(fže.
Çme
.
d©a
, 
NGX_FILE_RDONLY
,

982 
NGX_FILE_OPEN
, 
NGX_FILE_DEFAULT_ACCESS
);

984 ià(
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

985 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
cyþe
->
log
, 
ngx_”ºo
,

986 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
fže
.
Çme
.
d©a
);

990 
n
 = 
	`ngx_»ad_fže
(&
fže
, 
buf
, 
NGX_INT64_LEN
 + 2, 0);

992 ià(
	`ngx_þo£_fže
(
fže
.
fd
è=ð
NGX_FILE_ERROR
) {

993 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

994 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fže
.
Çme
.
d©a
);

997 ià(
n
 =ð
NGX_ERROR
) {

1001 
n
-- && (
buf
[n] =ð
CR
 || buf[n] =ð
LF
)) { }

1003 
pid
 = 
	`ngx_©oi
(
buf
, ++
n
);

1005 ià(
pid
 =ð
NGX_ERROR
) {

1006 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
cyþe
->
log
, 0,

1008 
n
, 
buf
, 
fže
.
Çme
.
d©a
);

1012  
	`ngx_os_sigÇl_´oûss
(
cyþe
, 
sig
, 
pid
);

1014 
	}
}

1017 
ngx_št_t


1018 
	$ngx_‹¡_lockfže
(
u_ch¬
 *
fže
, 
ngx_log_t
 *
log
)

1020 #ià!(
NGX_HAVE_ATOMIC_OPS
)

1021 
ngx_fd_t
 
fd
;

1023 
fd
 = 
	`ngx_Ý’_fže
(
fže
, 
NGX_FILE_RDWR
, 
NGX_FILE_CREATE_OR_OPEN
,

1024 
NGX_FILE_DEFAULT_ACCESS
);

1026 ià(
fd
 =ð
NGX_INVALID_FILE
) {

1027 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

1028 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
fže
);

1029  
NGX_ERROR
;

1032 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

1033 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

1034 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fže
);

1037 ià(
	`ngx_d–‘e_fže
(
fže
è=ð
NGX_FILE_ERROR
) {

1038 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

1039 
ngx_d–‘e_fže_n
 " \"%s\" fažed", 
fže
);

1044  
NGX_OK
;

1045 
	}
}

1049 
	$ngx_»Ý’_fžes
(
ngx_cyþe_t
 *
cyþe
, 
ngx_uid_t
 
u£r
)

1051 
ngx_fd_t
 
fd
;

1052 
ngx_ušt_t
 
i
;

1053 
ngx_li¡_·¹_t
 *
·¹
;

1054 
ngx_Ý’_fže_t
 *
fže
;

1056 
·¹
 = &
cyþe
->
Ý’_fžes
.part;

1057 
fže
 = 
·¹
->
–ts
;

1059 
i
 = 0; ; i++) {

1061 ià(
i
 >ð
·¹
->
ÃÉs
) {

1062 ià(
·¹
->
Ãxt
 =ð
NULL
) {

1065 
·¹
 =…¬t->
Ãxt
;

1066 
fže
 = 
·¹
->
–ts
;

1067 
i
 = 0;

1070 ià(
fže
[
i
].
Çme
.
Ën
 == 0) {

1074 ià(
fže
[
i
].
æush
) {

1075 
fže
[
i
].
	`æush
(&fže[i], 
cyþe
->
log
);

1078 
fd
 = 
	`ngx_Ý’_fže
(
fže
[
i
].
Çme
.
d©a
, 
NGX_FILE_APPEND
,

1079 
NGX_FILE_CREATE_OR_OPEN
, 
NGX_FILE_DEFAULT_ACCESS
);

1081 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

1083 
fže
[
i
].
Çme
.
d©a
, fže[i].
fd
, fd);

1085 ià(
fd
 =ð
NGX_INVALID_FILE
) {

1086 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1087 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
fže
[
i
].
Çme
.
d©a
);

1091 #ià!(
NGX_WIN32
)

1092 ià(
u£r
 !ð(
ngx_uid_t
è
NGX_CONF_UNSET_UINT
) {

1093 
ngx_fže_šfo_t
 
fi
;

1095 ià(
	`ngx_fže_šfo
((cÚ¡ *è
fže
[
i
].
Çme
.
d©a
, &
fi
)

1096 =ð
NGX_FILE_ERROR
)

1098 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1099 
ngx_fže_šfo_n
 " \"%s\" failed",

1100 
fže
[
i
].
Çme
.
d©a
);

1102 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

1103 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1104 
ngx_þo£_fže_n
 " \"%s\" failed",

1105 
fže
[
i
].
Çme
.
d©a
);

1111 ià(
fi
.
¡_uid
 !ð
u£r
) {

1112 ià(
	`chown
((cÚ¡ *è
fže
[
i
].
Çme
.
d©a
, 
u£r
, -1) == -1) {

1113 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1115 
fže
[
i
].
Çme
.
d©a
, 
u£r
);

1117 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

1118 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1119 
ngx_þo£_fže_n
 " \"%s\" failed",

1120 
fže
[
i
].
Çme
.
d©a
);

1127 ià((
fi
.
¡_mode
 & (
S_IRUSR
|
S_IWUSR
)) != (S_IRUSR|S_IWUSR)) {

1129 
fi
.
¡_mode
 |ð(
S_IRUSR
|
S_IWUSR
);

1131 ià(
	`chmod
((cÚ¡ *è
fže
[
i
].
Çme
.
d©a
, 
fi
.
¡_mode
) == -1) {

1132 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1133 "chmod(è\"%s\" fažed", 
fže
[
i
].
Çme
.
d©a
);

1135 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

1136 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1137 
ngx_þo£_fže_n
 " \"%s\" failed",

1138 
fže
[
i
].
Çme
.
d©a
);

1146 ià(
	`fúŽ
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
) == -1) {

1147 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1149 
fže
[
i
].
Çme
.
d©a
);

1151 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

1152 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1153 
ngx_þo£_fže_n
 " \"%s\" failed",

1154 
fže
[
i
].
Çme
.
d©a
);

1161 ià(
	`ngx_þo£_fže
(
fže
[
i
].
fd
è=ð
NGX_FILE_ERROR
) {

1162 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

1163 
ngx_þo£_fže_n
 " \"%s\" failed",

1164 
fže
[
i
].
Çme
.
d©a
);

1167 
fže
[
i
].
fd
 = fd;

1170 (è
	`ngx_log_»dœeù_¡d”r
(
cyþe
);

1171 
	}
}

1174 
ngx_shm_zÚe_t
 *

1175 
	$ngx_sh¬ed_memÜy_add
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
Çme
, 
size_t
 
size
, *
g
)

1177 
ngx_ušt_t
 
i
;

1178 
ngx_shm_zÚe_t
 *
shm_zÚe
;

1179 
ngx_li¡_·¹_t
 *
·¹
;

1181 
·¹
 = &
cf
->
cyþe
->
sh¬ed_memÜy
.part;

1182 
shm_zÚe
 = 
·¹
->
–ts
;

1184 
i
 = 0; ; i++) {

1186 ià(
i
 >ð
·¹
->
ÃÉs
) {

1187 ià(
·¹
->
Ãxt
 =ð
NULL
) {

1190 
·¹
 =…¬t->
Ãxt
;

1191 
shm_zÚe
 = 
·¹
->
–ts
;

1192 
i
 = 0;

1195 ià(
Çme
->
Ën
 !ð
shm_zÚe
[
i
].
shm
.name.len) {

1199 ià(
	`ngx_¡ºcmp
(
Çme
->
d©a
, 
shm_zÚe
[
i
].
shm
.Çme.d©a,‚ame->
Ën
)

1205 ià(
g
 !ð
shm_zÚe
[
i
].tag) {

1206 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1209 &
shm_zÚe
[
i
].
shm
.
Çme
);

1210  
NULL
;

1213 ià(
size
 && siz!ð
shm_zÚe
[
i
].
shm
.size) {

1214 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1217 
size
, &
shm_zÚe
[
i
].
shm
.
Çme
, shm_zone[i].shm.size);

1218  
NULL
;

1221  &
shm_zÚe
[
i
];

1224 
shm_zÚe
 = 
	`ngx_li¡_push
(&
cf
->
cyþe
->
sh¬ed_memÜy
);

1226 ià(
shm_zÚe
 =ð
NULL
) {

1227  
NULL
;

1230 
shm_zÚe
->
d©a
 = 
NULL
;

1231 
shm_zÚe
->
shm
.
log
 = 
cf
->
cyþe
->log;

1232 
shm_zÚe
->
shm
.
size
 = size;

1233 
shm_zÚe
->
shm
.
Çme
 = *name;

1234 
shm_zÚe
->
shm
.
exi¡s
 = 0;

1235 
shm_zÚe
->
š™
 = 
NULL
;

1236 
shm_zÚe
->
g
 =ag;

1238  
shm_zÚe
;

1239 
	}
}

1243 
	$ngx_þ—n_Þd_cyþes
(
ngx_ev’t_t
 *
ev
)

1245 
ngx_ušt_t
 
i
, 
n
, 
found
, 
live
;

1246 
ngx_log_t
 *
log
;

1247 
ngx_cyþe_t
 **
cyþe
;

1249 
log
 = 
ngx_cyþe
->log;

1250 
ngx_‹mp_poÞ
->
log
 =†og;

1252 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "clean old cycles");

1254 
live
 = 0;

1256 
cyþe
 = 
ngx_Þd_cyþes
.
–ts
;

1257 
i
 = 0; i < 
ngx_Þd_cyþes
.
ÃÉs
; i++) {

1259 ià(
cyþe
[
i
] =ð
NULL
) {

1263 
found
 = 0;

1265 
n
 = 0;‚ < 
cyþe
[
i
]->
cÚÃùiÚ_n
;‚++) {

1266 ià(
cyþe
[
i
]->
cÚÃùiÚs
[
n
].
fd
 !ð(
ngx_sock‘_t
) -1) {

1267 
found
 = 1;

1269 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "livfd:%d", 
n
);

1275 ià(
found
) {

1276 
live
 = 1;

1280 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "þ—ÀÞd cyþe: %d", 
i
);

1282 
	`ngx_de¡roy_poÞ
(
cyþe
[
i
]->
poÞ
);

1283 
cyþe
[
i
] = 
NULL
;

1286 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "Þd cyþe ¡©us: %d", 
live
);

1288 ià(
live
) {

1289 
	`ngx_add_tim”
(
ev
, 30000);

1292 
	`ngx_de¡roy_poÞ
(
ngx_‹mp_poÞ
);

1293 
ngx_‹mp_poÞ
 = 
NULL
;

1294 
ngx_Þd_cyþes
.
ÃÉs
 = 0;

1296 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_file.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_št_t
 
ngx_‹¡_fuÎ_Çme
(
ngx_¡r_t
 *
Çme
);

15 
ngx_©omic_t
 
	g‹mp_numb”
 = 0;

16 
ngx_©omic_t
 *
	gngx_‹mp_numb”
 = &
‹mp_numb”
;

17 
ngx_©omic_št_t
 
	gngx_¿ndom_numb”
 = 123456;

20 
ngx_št_t


21 
	$ngx_g‘_fuÎ_Çme
(
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
´efix
,‚gx_¡r_ˆ*
Çme
)

23 
size_t
 
Ën
;

24 
u_ch¬
 *
p
, *
n
;

25 
ngx_št_t
 
rc
;

27 
rc
 = 
	`ngx_‹¡_fuÎ_Çme
(
Çme
);

29 ià(
rc
 =ð
NGX_OK
) {

30  
rc
;

33 
Ën
 = 
´efix
->len;

35 #ià(
NGX_WIN32
)

37 ià(
rc
 == 2) {

38 
Ën
 = 
rc
;

43 
n
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
 + 
Çme
->len + 1);

44 ià(
n
 =ð
NULL
) {

45  
NGX_ERROR
;

48 
p
 = 
	`ngx_ýymem
(
n
, 
´efix
->
d©a
, 
Ën
);

49 
	`ngx_ýy¡º
(
p
, 
Çme
->
d©a
,‚ame->
Ën
 + 1);

51 
Çme
->
Ën
 +=†en;

52 
Çme
->
d©a
 = 
n
;

54  
NGX_OK
;

55 
	}
}

58 
ngx_št_t


59 
	$ngx_‹¡_fuÎ_Çme
(
ngx_¡r_t
 *
Çme
)

61 #ià(
NGX_WIN32
)

62 
u_ch¬
 
c0
, 
c1
;

64 
c0
 = 
Çme
->
d©a
[0];

66 ià(
Çme
->
Ën
 < 2) {

67 ià(
c0
 == '/') {

71  
NGX_DECLINED
;

74 
c1
 = 
Çme
->
d©a
[1];

76 ià(
c1
 == ':') {

77 
c0
 |= 0x20;

79 ià((
c0
 >= 'a' && c0 <= 'z')) {

80  
NGX_OK
;

83  
NGX_DECLINED
;

86 ià(
c1
 == '/') {

87  
NGX_OK
;

90 ià(
c0
 == '/') {

94  
NGX_DECLINED
;

98 ià(
Çme
->
d©a
[0] == '/') {

99  
NGX_OK
;

102  
NGX_DECLINED
;

105 
	}
}

108 
ssize_t


109 
	$ngx_wr™e_chaš_to_‹mp_fže
(
ngx_‹mp_fže_t
 *
tf
, 
ngx_chaš_t
 *
chaš
)

111 
ngx_št_t
 
rc
;

113 ià(
tf
->
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

114 
rc
 = 
	`ngx_ü—‹_‹mp_fže
(&
tf
->
fže
,f->
·th
,f->
poÞ
,

115 
tf
->
³rsi¡’t
,f->
þ—n
,f->
acûss
);

117 ià(
rc
 =ð
NGX_ERROR
 ||„ø=ð
NGX_AGAIN
) {

118  
rc
;

121 ià(
tf
->
log_Ëv–
) {

122 
	`ngx_log_”rÜ
(
tf
->
log_Ëv–
,f->
fže
.
log
, 0, "%s %V",

123 
tf
->
w¬n
, &tf->
fže
.
Çme
);

127  
	`ngx_wr™e_chaš_to_fže
(&
tf
->
fže
, 
chaš
,f->
off£t
,f->
poÞ
);

128 
	}
}

131 
ngx_št_t


132 
	$ngx_ü—‹_‹mp_fže
(
ngx_fže_t
 *
fže
, 
ngx_·th_t
 *
·th
, 
ngx_poÞ_t
 *
poÞ
,

133 
ngx_ušt_t
 
³rsi¡’t
,‚gx_ušt_ˆ
þ—n
,‚gx_ušt_ˆ
acûss
)

135 
ušt32_t
 
n
;

136 
ngx_”r_t
 
”r
;

137 
ngx_poÞ_þ—nup_t
 *
þn
;

138 
ngx_poÞ_þ—nup_fže_t
 *
þnf
;

140 
fže
->
Çme
.
Ën
 = 
·th
->name.len + 1 +…ath->len + 10;

142 
fže
->
Çme
.
d©a
 = 
	`ngx_²®loc
(
poÞ
, fže->Çme.
Ën
 + 1);

143 ià(
fže
->
Çme
.
d©a
 =ð
NULL
) {

144  
NGX_ERROR
;

148 
i
 = 0; i < 
fže
->
Çme
.
Ën
; i++) {

149 
fže
->
Çme
.
d©a
[
i
] = 'X';

153 
	`ngx_memýy
(
fže
->
Çme
.
d©a
, 
·th
->Çme.d©a,…©h->Çme.
Ën
);

155 
n
 = (
ušt32_t
è
	`ngx_Ãxt_‹mp_numb”
(0);

157 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
poÞ
, (
ngx_poÞ_þ—nup_fže_t
));

158 ià(
þn
 =ð
NULL
) {

159  
NGX_ERROR
;

163 (è
	`ngx_¥rštf
(
fže
->
Çme
.
d©a
 + 
·th
->Çme.
Ën
 + 1 +…ath->len,

164 "%010uD%Z", 
n
);

166 
	`ngx_ü—‹_hashed_fž’ame
(
·th
, 
fže
->
Çme
.
d©a
, fže->Çme.
Ën
);

168 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

169 "hashed…©h: %s", 
fže
->
Çme
.
d©a
);

171 
fže
->
fd
 = 
	`ngx_Ý’_‹mpfže
(fže->
Çme
.
d©a
, 
³rsi¡’t
, 
acûss
);

173 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

174 "‹m°fd:%d", 
fže
->
fd
);

176 ià(
fže
->
fd
 !ð
NGX_INVALID_FILE
) {

178 
þn
->
hªdËr
 = 
þ—n
 ? 
ngx_poÞ_d–‘e_fže
 : 
ngx_poÞ_þ—nup_fže
;

179 
þnf
 = 
þn
->
d©a
;

181 
þnf
->
fd
 = 
fže
->fd;

182 
þnf
->
Çme
 = 
fže
->Çme.
d©a
;

183 
þnf
->
log
 = 
poÞ
->log;

185  
NGX_OK
;

188 
”r
 = 
ngx_”ºo
;

190 ià(
”r
 =ð
NGX_EEXIST
) {

191 
n
 = (
ušt32_t
è
	`ngx_Ãxt_‹mp_numb”
(1);

195 ià((
·th
->
Ëv–
[0] =ð0è|| (
”r
 !ð
NGX_ENOPATH
)) {

196 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
”r
,

197 
ngx_Ý’_‹mpfže_n
 " \"%s\" failed",

198 
fže
->
Çme
.
d©a
);

199  
NGX_ERROR
;

202 ià(
	`ngx_ü—‹_·th
(
fže
, 
·th
è=ð
NGX_ERROR
) {

203  
NGX_ERROR
;

206 
	}
}

210 
	$ngx_ü—‹_hashed_fž’ame
(
ngx_·th_t
 *
·th
, 
u_ch¬
 *
fže
, 
size_t
 
Ën
)

212 
size_t
 
i
, 
Ëv–
;

213 
ngx_ušt_t
 
n
;

215 
i
 = 
·th
->
Çme
.
Ën
 + 1;

217 
fže
[
·th
->
Çme
.
Ën
 +…ath->len] = '/';

219 
n
 = 0;‚ < 3;‚++) {

220 
Ëv–
 = 
·th
->Ëv–[
n
];

222 ià(
Ëv–
 == 0) {

226 
Ën
 -ð
Ëv–
;

227 
fže
[
i
 - 1] = '/';

228 
	`ngx_memýy
(&
fže
[
i
], &fže[
Ën
], 
Ëv–
);

229 
i
 +ð
Ëv–
 + 1;

231 
	}
}

234 
ngx_št_t


235 
	$ngx_ü—‹_·th
(
ngx_fže_t
 *
fže
, 
ngx_·th_t
 *
·th
)

237 
size_t
 
pos
;

238 
ngx_”r_t
 
”r
;

239 
ngx_ušt_t
 
i
;

241 
pos
 = 
·th
->
Çme
.
Ën
;

243 
i
 = 0; i < 3; i++) {

244 ià(
·th
->
Ëv–
[
i
] == 0) {

248 
pos
 +ð
·th
->
Ëv–
[
i
] + 1;

250 
fže
->
Çme
.
d©a
[
pos
] = '\0';

252 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

253 "‹m°fže: \"%s\"", 
fže
->
Çme
.
d©a
);

255 ià(
	`ngx_ü—‹_dœ
(
fže
->
Çme
.
d©a
, 0700è=ð
NGX_FILE_ERROR
) {

256 
”r
 = 
ngx_”ºo
;

257 ià(
”r
 !ð
NGX_EEXIST
) {

258 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
”r
,

259 
ngx_ü—‹_dœ_n
 " \"%s\" failed",

260 
fže
->
Çme
.
d©a
);

261  
NGX_ERROR
;

265 
fže
->
Çme
.
d©a
[
pos
] = '/';

268  
NGX_OK
;

269 
	}
}

272 
ngx_”r_t


273 
	$ngx_ü—‹_fuÎ_·th
(
u_ch¬
 *
dœ
, 
ngx_ušt_t
 
acûss
)

275 
u_ch¬
 *
p
, 
ch
;

276 
ngx_”r_t
 
”r
;

278 
”r
 = 0;

280 #ià(
NGX_WIN32
)

281 
p
 = 
dœ
 + 3;

283 
p
 = 
dœ
 + 1;

286  ; *
p
;…++) {

287 
ch
 = *
p
;

289 ià(
ch
 != '/') {

293 *
p
 = '\0';

295 ià(
	`ngx_ü—‹_dœ
(
dœ
, 
acûss
è=ð
NGX_FILE_ERROR
) {

296 
”r
 = 
ngx_”ºo
;

298 
”r
) {

299 
NGX_EEXIST
:

300 
”r
 = 0;

301 
NGX_EACCES
:

305  
”r
;

309 *
p
 = '/';

312  
”r
;

313 
	}
}

316 
ngx_©omic_ušt_t


317 
	$ngx_Ãxt_‹mp_numb”
(
ngx_ušt_t
 
cÞlisiÚ
)

319 
ngx_©omic_ušt_t
 
n
, 
add
;

321 
add
 = 
cÞlisiÚ
 ? 
ngx_¿ndom_numb”
 : 1;

323 
n
 = 
	`ngx_©omic_ãtch_add
(
ngx_‹mp_numb”
, 
add
);

325  
n
 + 
add
;

326 
	}
}

330 
	$ngx_cÚf_£t_·th_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

332 *
p
 = 
cÚf
;

334 
ssize_t
 
Ëv–
;

335 
ngx_¡r_t
 *
v®ue
;

336 
ngx_ušt_t
 
i
, 
n
;

337 
ngx_·th_t
 *
·th
, **
¦Ù
;

339 
¦Ù
 = (
ngx_·th_t
 **è(
p
 + 
cmd
->
off£t
);

341 ià(*
¦Ù
) {

345 
·th
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_·th_t
));

346 ià(
·th
 =ð
NULL
) {

347  
NGX_CONF_ERROR
;

350 
v®ue
 = 
cf
->
¬gs
->
–ts
;

352 
·th
->
Çme
 = 
v®ue
[1];

354 ià(
·th
->
Çme
.
d©a
[·th->Çme.
Ën
 - 1] == '/') {

355 
·th
->
Çme
.
Ën
--;

358 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
·th
->
Çme
, 0è!ð
NGX_OK
) {

359  
NULL
;

362 
·th
->
cÚf_fže
 = 
cf
->cÚf_fže->
fže
.
Çme
.
d©a
;

363 
·th
->
lše
 = 
cf
->
cÚf_fže
->line;

365 
i
 = 0, 
n
 = 2;‚ < 
cf
->
¬gs
->
ÃÉs
; i++,‚++) {

366 
Ëv–
 = 
	`ngx_©oi
(
v®ue
[
n
].
d©a
, v®ue[n].
Ën
);

367 ià(
Ëv–
 =ð
NGX_ERROR
 ||†evel == 0) {

371 
·th
->
Ëv–
[
i
] =†evel;

372 
·th
->
Ën
 +ð
Ëv–
 + 1;

375 
i
 < 3) {

376 
·th
->
Ëv–
[
i
++] = 0;

379 *
¦Ù
 = 
·th
;

381 ià(
	`ngx_add_·th
(
cf
, 
¦Ù
è=ð
NGX_ERROR
) {

382  
NGX_CONF_ERROR
;

385  
NGX_CONF_OK
;

386 
	}
}

390 
	$ngx_cÚf_m”ge_·th_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_·th_t
 **
·th
,‚gx_·th_ˆ*
´ev
,

391 
ngx_·th_š™_t
 *
š™
)

393 ià(*
·th
) {

394  
NGX_CONF_OK
;

397 ià(
´ev
) {

398 *
·th
 = 
´ev
;

399  
NGX_CONF_OK
;

402 *
·th
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_·th_t
));

403 ià(*
·th
 =ð
NULL
) {

404  
NGX_CONF_ERROR
;

407 (*
·th
)->
Çme
 = 
š™
->name;

409 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &(*
·th
)->
Çme
, 0è!ð
NGX_OK
) {

410  
NGX_CONF_ERROR
;

413 (*
·th
)->
Ëv–
[0] = 
š™
->level[0];

414 (*
·th
)->
Ëv–
[1] = 
š™
->level[1];

415 (*
·th
)->
Ëv–
[2] = 
š™
->level[2];

417 (*
·th
)->
Ën
 = 
š™
->
Ëv–
[0] + (init->level[0] ? 1 : 0)

418 + 
š™
->
Ëv–
[1] + (init->level[1] ? 1 : 0)

419 + 
š™
->
Ëv–
[2] + (init->level[2] ? 1 : 0);

421 ià(
	`ngx_add_·th
(
cf
, 
·th
è!ð
NGX_OK
) {

422  
NGX_CONF_ERROR
;

425  
NGX_CONF_OK
;

426 
	}
}

430 
	$ngx_cÚf_£t_acûss_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

432 *
cÚå
 = 
cÚf
;

434 
u_ch¬
 *
p
;

435 
ngx_¡r_t
 *
v®ue
;

436 
ngx_ušt_t
 
i
, 
right
, 
shiá
, *
acûss
;

438 
acûss
 = (
ngx_ušt_t
 *è(
cÚå
 + 
cmd
->
off£t
);

440 ià(*
acûss
 !ð
NGX_CONF_UNSET_UINT
) {

444 
v®ue
 = 
cf
->
¬gs
->
–ts
;

446 *
acûss
 = 0600;

448 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

450 
p
 = 
v®ue
[
i
].
d©a
;

452 ià(
	`ngx_¡ºcmp
(
p
, "user:", ("user:") - 1) == 0) {

453 
shiá
 = 6;

454 
p
 += ("user:") - 1;

456 } ià(
	`ngx_¡ºcmp
(
p
, "group:", ("group:") - 1) == 0) {

457 
shiá
 = 3;

458 
p
 += ("group:") - 1;

460 } ià(
	`ngx_¡ºcmp
(
p
, "all:", ("all:") - 1) == 0) {

461 
shiá
 = 0;

462 
p
 += ("all:") - 1;

465 
šv®id
;

468 ià(
	`ngx_¡rcmp
(
p
, "rw") == 0) {

469 
right
 = 6;

471 } ià(
	`ngx_¡rcmp
(
p
, "r") == 0) {

472 
right
 = 4;

475 
šv®id
;

478 *
acûss
 |ð
right
 << 
shiá
;

481  
NGX_CONF_OK
;

483 
šv®id
:

485 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "šv®id v®u\"%V\"", &
v®ue
[
i
]);

487  
NGX_CONF_ERROR
;

488 
	}
}

491 
ngx_št_t


492 
	$ngx_add_·th
(
ngx_cÚf_t
 *
cf
, 
ngx_·th_t
 **
¦Ù
)

494 
ngx_ušt_t
 
i
, 
n
;

495 
ngx_·th_t
 *
·th
, **
p
;

497 
·th
 = *
¦Ù
;

499 
p
 = 
cf
->
cyþe
->
·ths
.
–ts
;

500 
i
 = 0; i < 
cf
->
cyþe
->
·ths
.
ÃÉs
; i++) {

501 ià(
p
[
i
]->
Çme
.
Ën
 =ð
·th
->name.len

502 && 
	`ngx_¡rcmp
(
p
[
i
]->
Çme
.
d©a
, 
·th
->name.data) == 0)

504 ià(
p
[
i
]->
d©a
 !ð
·th
->data) {

505 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

508 &
p
[
i
]->
Çme
,…[i]->
cÚf_fže
,…[i]->
lše
);

509  
NGX_ERROR
;

512 
n
 = 0;‚ < 3;‚++) {

513 ià(
p
[
i
]->
Ëv–
[
n
] !ð
·th
->level[n]) {

514 ià(
·th
->
cÚf_fže
 =ð
NULL
) {

515 ià(
p
[
i
]->
cÚf_fže
 =ð
NULL
) {

516 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

521 &
p
[
i
]->
Çme
);

522  
NGX_ERROR
;

525 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

530 &
p
[
i
]->
Çme
,…[i]->
cÚf_fže
,…[i]->
lše
);

531  
NGX_ERROR
;

534 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

537 &
p
[
i
]->
Çme
,…[i]->
cÚf_fže
,…[i]->
lše
);

538  
NGX_ERROR
;

541 ià(
p
[
i
]->
Ëv–
[
n
] == 0) {

546 *
¦Ù
 = 
p
[
i
];

548  
NGX_OK
;

552 
p
 = 
	`ngx_¬¿y_push
(&
cf
->
cyþe
->
·ths
);

553 ià(
p
 =ð
NULL
) {

554  
NGX_ERROR
;

557 *
p
 = 
·th
;

559  
NGX_OK
;

560 
	}
}

563 
ngx_št_t


564 
	$ngx_ü—‹_·ths
(
ngx_cyþe_t
 *
cyþe
, 
ngx_uid_t
 
u£r
)

566 
ngx_”r_t
 
”r
;

567 
ngx_ušt_t
 
i
;

568 
ngx_·th_t
 **
·th
;

570 
·th
 = 
cyþe
->
·ths
.
–ts
;

571 
i
 = 0; i < 
cyþe
->
·ths
.
ÃÉs
; i++) {

573 ià(
	`ngx_ü—‹_dœ
(
·th
[
i
]->
Çme
.
d©a
, 0700è=ð
NGX_FILE_ERROR
) {

574 
”r
 = 
ngx_”ºo
;

575 ià(
”r
 !ð
NGX_EEXIST
) {

576 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
”r
,

577 
ngx_ü—‹_dœ_n
 " \"%s\" failed",

578 
·th
[
i
]->
Çme
.
d©a
);

579  
NGX_ERROR
;

583 ià(
u£r
 =ð(
ngx_uid_t
è
NGX_CONF_UNSET_UINT
) {

587 #ià!(
NGX_WIN32
)

589 
ngx_fže_šfo_t
 
fi
;

591 ià(
	`ngx_fže_šfo
((cÚ¡ *è
·th
[
i
]->
Çme
.
d©a
, &
fi
)

592 =ð
NGX_FILE_ERROR
)

594 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

595 
ngx_fže_šfo_n
 " \"%s\" fažed", 
·th
[
i
]->
Çme
.
d©a
);

596  
NGX_ERROR
;

599 ià(
fi
.
¡_uid
 !ð
u£r
) {

600 ià(
	`chown
((cÚ¡ *è
·th
[
i
]->
Çme
.
d©a
, 
u£r
, -1) == -1) {

601 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

603 
·th
[
i
]->
Çme
.
d©a
, 
u£r
);

604  
NGX_ERROR
;

608 ià((
fi
.
¡_mode
 & (
S_IRUSR
|
S_IWUSR
|
S_IXUSR
))

609 !ð(
S_IRUSR
|
S_IWUSR
|
S_IXUSR
))

611 
fi
.
¡_mode
 |ð(
S_IRUSR
|
S_IWUSR
|
S_IXUSR
);

613 ià(
	`chmod
((cÚ¡ *è
·th
[
i
]->
Çme
.
d©a
, 
fi
.
¡_mode
) == -1) {

614 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

615 "chmod(è\"%s\" fažed", 
·th
[
i
]->
Çme
.
d©a
);

616  
NGX_ERROR
;

623  
NGX_OK
;

624 
	}
}

627 
ngx_št_t


628 
	$ngx_ext_»Çme_fže
(
ngx_¡r_t
 *
¤c
,‚gx_¡r_ˆ*
to
, 
ngx_ext_»Çme_fže_t
 *
ext
)

630 
u_ch¬
 *
Çme
;

631 
ngx_”r_t
 
”r
;

632 
ngx_cÝy_fže_t
 
cf
;

634 #ià!(
NGX_WIN32
)

636 ià(
ext
->
acûss
) {

637 ià(
	`ngx_chªge_fže_acûss
(
¤c
->
d©a
, 
ext
->
acûss
è=ð
NGX_FILE_ERROR
) {

638 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_”ºo
,

639 
ngx_chªge_fže_acûss_n
 " \"%s\" fažed", 
¤c
->
d©a
);

640 
”r
 = 0;

641 
çžed
;

647 ià(
ext
->
time
 != -1) {

648 ià(
	`ngx_£t_fže_time
(
¤c
->
d©a
, 
ext
->
fd
,ƒxt->
time
è!ð
NGX_OK
) {

649 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_”ºo
,

650 
ngx_£t_fže_time_n
 " \"%s\" fažed", 
¤c
->
d©a
);

651 
”r
 = 0;

652 
çžed
;

656 ià(
	`ngx_»Çme_fže
(
¤c
->
d©a
, 
to
->d©aè!ð
NGX_FILE_ERROR
) {

657  
NGX_OK
;

660 
”r
 = 
ngx_”ºo
;

662 ià(
”r
 =ð
NGX_ENOPATH
) {

664 ià(!
ext
->
ü—‹_·th
) {

665 
çžed
;

668 
”r
 = 
	`ngx_ü—‹_fuÎ_·th
(
to
->
d©a
, 
	`ngx_dœ_acûss
(
ext
->
·th_acûss
));

670 ià(
”r
) {

671 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ext
->
log
, 
”r
,

672 
ngx_ü—‹_dœ_n
 " \"%s\" fažed", 
to
->
d©a
);

673 
”r
 = 0;

674 
çžed
;

677 ià(
	`ngx_»Çme_fže
(
¤c
->
d©a
, 
to
->d©aè!ð
NGX_FILE_ERROR
) {

678  
NGX_OK
;

681 
”r
 = 
ngx_”ºo
;

684 #ià(
NGX_WIN32
)

686 ià(
”r
 =ð
NGX_EEXIST
) {

687 
”r
 = 
	`ngx_wš32_»Çme_fže
(
¤c
, 
to
, 
ext
->
log
);

689 ià(
”r
 == 0) {

690  
NGX_OK
;

696 ià(
”r
 =ð
NGX_EXDEV
) {

698 
cf
.
size
 = -1;

699 
cf
.
buf_size
 = 0;

700 
cf
.
acûss
 = 
ext
->access;

701 
cf
.
time
 = 
ext
->time;

702 
cf
.
log
 = 
ext
->log;

704 
Çme
 = 
	`ngx_®loc
(
to
->
Ën
 + 1 + 10 + 1, 
ext
->
log
);

705 ià(
Çme
 =ð
NULL
) {

706  
NGX_ERROR
;

709 (è
	`ngx_¥rštf
(
Çme
, "%*s.%010uD%Z", 
to
->
Ën
,o->
d©a
,

710 (
ušt32_t
è
	`ngx_Ãxt_‹mp_numb”
(0));

712 ià(
	`ngx_cÝy_fže
(
¤c
->
d©a
, 
Çme
, &
cf
è=ð
NGX_OK
) {

714 ià(
	`ngx_»Çme_fže
(
Çme
, 
to
->
d©a
è!ð
NGX_FILE_ERROR
) {

715 
	`ngx_ä“
(
Çme
);

717 ià(
	`ngx_d–‘e_fže
(
¤c
->
d©a
è=ð
NGX_FILE_ERROR
) {

718 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_”ºo
,

719 
ngx_d–‘e_fže_n
 " \"%s\" failed",

720 
¤c
->
d©a
);

721  
NGX_ERROR
;

724  
NGX_OK
;

727 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_”ºo
,

728 
ngx_»Çme_fže_n
 " \"%s\"o \"%s\" failed",

729 
Çme
, 
to
->
d©a
);

731 ià(
	`ngx_d–‘e_fže
(
Çme
è=ð
NGX_FILE_ERROR
) {

732 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_”ºo
,

733 
ngx_d–‘e_fže_n
 " \"%s\" fažed", 
Çme
);

738 
	`ngx_ä“
(
Çme
);

740 
”r
 = 0;

743 
çžed
:

745 ià(
ext
->
d–‘e_fže
) {

746 ià(
	`ngx_d–‘e_fže
(
¤c
->
d©a
è=ð
NGX_FILE_ERROR
) {

747 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_”ºo
,

748 
ngx_d–‘e_fže_n
 " \"%s\" fažed", 
¤c
->
d©a
);

752 ià(
”r
) {

753 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ext
->
log
, 
”r
,

754 
ngx_»Çme_fže_n
 " \"%s\"o \"%s\" failed",

755 
¤c
->
d©a
, 
to
->data);

758  
NGX_ERROR
;

759 
	}
}

762 
ngx_št_t


763 
	$ngx_cÝy_fže
(
u_ch¬
 *
äom
, u_ch¬ *
to
, 
ngx_cÝy_fže_t
 *
cf
)

765 *
buf
;

766 
off_t
 
size
;

767 
size_t
 
Ën
;

768 
ssize_t
 
n
;

769 
ngx_fd_t
 
fd
, 
nfd
;

770 
ngx_št_t
 
rc
;

771 
ngx_fže_šfo_t
 
fi
;

773 
rc
 = 
NGX_ERROR
;

774 
buf
 = 
NULL
;

775 
nfd
 = 
NGX_INVALID_FILE
;

777 
fd
 = 
	`ngx_Ý’_fže
(
äom
, 
NGX_FILE_RDONLY
, 
NGX_FILE_OPEN
, 0);

779 ià(
fd
 =ð
NGX_INVALID_FILE
) {

780 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
->
log
, 
ngx_”ºo
,

781 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
äom
);

782 
çžed
;

785 ià(
cf
->
size
 != -1) {

786 
size
 = 
cf
->size;

789 ià(
	`ngx_fd_šfo
(
fd
, &
fi
è=ð
NGX_FILE_ERROR
) {

790 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

791 
ngx_fd_šfo_n
 " \"%s\" fažed", 
äom
);

793 
çžed
;

796 
size
 = 
	`ngx_fže_size
(&
fi
);

799 
Ën
 = 
cf
->
buf_size
 ? cf->buf_size : 65536;

801 ià((
off_t
è
Ën
 > 
size
) {

802 
Ën
 = (
size_t
è
size
;

805 
buf
 = 
	`ngx_®loc
(
Ën
, 
cf
->
log
);

806 ià(
buf
 =ð
NULL
) {

807 
çžed
;

810 
nfd
 = 
	`ngx_Ý’_fže
(
to
, 
NGX_FILE_WRONLY
, 
NGX_FILE_CREATE_OR_OPEN
,

811 
cf
->
acûss
);

813 ià(
nfd
 =ð
NGX_INVALID_FILE
) {

814 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
->
log
, 
ngx_”ºo
,

815 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
to
);

816 
çžed
;

819 
size
 > 0) {

821 ià((
off_t
è
Ën
 > 
size
) {

822 
Ën
 = (
size_t
è
size
;

825 
n
 = 
	`ngx_»ad_fd
(
fd
, 
buf
, 
Ën
);

827 ià(
n
 == -1) {

828 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

829 
ngx_»ad_fd_n
 " \"%s\" fažed", 
äom
);

830 
çžed
;

833 ià((
size_t
è
n
 !ð
Ën
) {

834 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 0,

835 
ngx_»ad_fd_n
 " has„ead only %z of %uz from %s",

836 
n
, 
size
, 
äom
);

837 
çžed
;

840 
n
 = 
	`ngx_wr™e_fd
(
nfd
, 
buf
, 
Ën
);

842 ià(
n
 == -1) {

843 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

844 
ngx_wr™e_fd_n
 " \"%s\" fažed", 
to
);

845 
çžed
;

848 ià((
size_t
è
n
 !ð
Ën
) {

849 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 0,

850 
ngx_wr™e_fd_n
 " has written only %z of %uzo %s",

851 
n
, 
size
, 
to
);

852 
çžed
;

855 
size
 -ð
n
;

858 ià(
cf
->
time
 != -1) {

859 ià(
	`ngx_£t_fže_time
(
to
, 
nfd
, 
cf
->
time
è!ð
NGX_OK
) {

860 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

861 
ngx_£t_fže_time_n
 " \"%s\" fažed", 
to
);

862 
çžed
;

866 
rc
 = 
NGX_OK
;

868 
çžed
:

870 ià(
nfd
 !ð
NGX_INVALID_FILE
) {

871 ià(
	`ngx_þo£_fže
(
nfd
è=ð
NGX_FILE_ERROR
) {

872 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

873 
ngx_þo£_fže_n
 " \"%s\" fažed", 
to
);

877 ià(
fd
 !ð
NGX_INVALID_FILE
) {

878 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

879 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

880 
ngx_þo£_fže_n
 " \"%s\" fažed", 
äom
);

884 ià(
buf
) {

885 
	`ngx_ä“
(
buf
);

888  
rc
;

889 
	}
}

910 
ngx_št_t


911 
	$ngx_w®k_Œ“
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
Œ“
)

913 *
d©a
, *
´ev
;

914 
u_ch¬
 *
p
, *
Çme
;

915 
size_t
 
Ën
;

916 
ngx_št_t
 
rc
;

917 
ngx_”r_t
 
”r
;

918 
ngx_¡r_t
 
fže
, 
buf
;

919 
ngx_dœ_t
 
dœ
;

921 
	`ngx_¡r_nuÎ
(&
buf
);

923 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ùx
->
log
, 0,

924 "w®k»\"%V\"", 
Œ“
);

926 ià(
	`ngx_Ý’_dœ
(
Œ“
, &
dœ
è=ð
NGX_ERROR
) {

927 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 
ngx_”ºo
,

928 
ngx_Ý’_dœ_n
 " \"%s\" fažed", 
Œ“
->
d©a
);

929  
NGX_ERROR
;

932 
´ev
 = 
ùx
->
d©a
;

934 ià(
ùx
->
®loc
) {

935 
d©a
 = 
	`ngx_®loc
(
ùx
->
®loc
, ctx->
log
);

936 ià(
d©a
 =ð
NULL
) {

937 
çžed
;

940 ià(
ùx
->
	`š™_hªdËr
(
d©a
, 
´ev
è=ð
NGX_ABORT
) {

941 
çžed
;

944 
ùx
->
d©a
 = data;

947 
d©a
 = 
NULL
;

952 
	`ngx_£t_”ºo
(0);

954 ià(
	`ngx_»ad_dœ
(&
dœ
è=ð
NGX_ERROR
) {

955 
”r
 = 
ngx_”ºo
;

957 ià(
”r
 =ð
NGX_ENOMOREFILES
) {

958 
rc
 = 
NGX_OK
;

961 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 
”r
,

962 
ngx_»ad_dœ_n
 " \"%s\" fažed", 
Œ“
->
d©a
);

963 
rc
 = 
NGX_ERROR
;

966 
dÚe
;

969 
Ën
 = 
	`ngx_de_Çm–’
(&
dœ
);

970 
Çme
 = 
	`ngx_de_Çme
(&
dœ
);

972 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
ùx
->
log
, 0,

973 "Œ“‚am%uz:\"%s\"", 
Ën
, 
Çme
);

975 ià(
Ën
 =ð1 && 
Çme
[0] == '.') {

979 ià(
Ën
 =ð2 && 
Çme
[0] == '.' &&‚ame[1] == '.') {

983 
fže
.
Ën
 = 
Œ“
->len + 1 +†en;

985 ià(
fže
.
Ën
 + 
NGX_DIR_MASK_LEN
 > 
buf
.len) {

987 ià(
buf
.
Ën
) {

988 
	`ngx_ä“
(
buf
.
d©a
);

991 
buf
.
Ën
 = 
Œ“
->ËÀ+ 1 +†’ + 
NGX_DIR_MASK_LEN
;

993 
buf
.
d©a
 = 
	`ngx_®loc
(buf.
Ën
 + 1, 
ùx
->
log
);

994 ià(
buf
.
d©a
 =ð
NULL
) {

995 
çžed
;

999 
p
 = 
	`ngx_ýymem
(
buf
.
d©a
, 
Œ“
->d©a,»e->
Ën
);

1000 *
p
++ = '/';

1001 
	`ngx_memýy
(
p
, 
Çme
, 
Ën
 + 1);

1003 
fže
.
d©a
 = 
buf
.data;

1005 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ùx
->
log
, 0,

1006 "Œ“…©h \"%s\"", 
fže
.
d©a
);

1008 ià(!
dœ
.
v®id_šfo
) {

1009 ià(
	`ngx_de_šfo
(
fže
.
d©a
, &
dœ
è=ð
NGX_FILE_ERROR
) {

1010 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 
ngx_”ºo
,

1011 
ngx_de_šfo_n
 " \"%s\" fažed", 
fže
.
d©a
);

1016 ià(
	`ngx_de_is_fže
(&
dœ
)) {

1018 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ùx
->
log
, 0,

1019 "Œ“ fž\"%s\"", 
fže
.
d©a
);

1021 
ùx
->
size
 = 
	`ngx_de_size
(&
dœ
);

1022 
ùx
->
fs_size
 = 
	`ngx_de_fs_size
(&
dœ
);

1023 
ùx
->
acûss
 = 
	`ngx_de_acûss
(&
dœ
);

1024 
ùx
->
mtime
 = 
	`ngx_de_mtime
(&
dœ
);

1026 ià(
ùx
->
	`fže_hªdËr
(ùx, &
fže
è=ð
NGX_ABORT
) {

1027 
çžed
;

1030 } ià(
	`ngx_de_is_dœ
(&
dœ
)) {

1032 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ùx
->
log
, 0,

1033 "Œ“ƒÁ” dœ \"%s\"", 
fže
.
d©a
);

1035 
ùx
->
acûss
 = 
	`ngx_de_acûss
(&
dœ
);

1036 
ùx
->
mtime
 = 
	`ngx_de_mtime
(&
dœ
);

1038 ià(
ùx
->
	`´e_Œ“_hªdËr
(ùx, &
fže
è=ð
NGX_ABORT
) {

1039 
çžed
;

1042 ià(
	`ngx_w®k_Œ“
(
ùx
, &
fže
è=ð
NGX_ABORT
) {

1043 
çžed
;

1046 
ùx
->
acûss
 = 
	`ngx_de_acûss
(&
dœ
);

1047 
ùx
->
mtime
 = 
	`ngx_de_mtime
(&
dœ
);

1049 ià(
ùx
->
	`po¡_Œ“_hªdËr
(ùx, &
fže
è=ð
NGX_ABORT
) {

1050 
çžed
;

1055 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ùx
->
log
, 0,

1056 "Œ“ s³cŸÈ\"%s\"", 
fže
.
d©a
);

1058 ià(
ùx
->
	`¥ec_hªdËr
(ùx, &
fže
è=ð
NGX_ABORT
) {

1059 
çžed
;

1064 
çžed
:

1066 
rc
 = 
NGX_ABORT
;

1068 
dÚe
:

1070 ià(
buf
.
Ën
) {

1071 
	`ngx_ä“
(
buf
.
d©a
);

1074 ià(
d©a
) {

1075 
	`ngx_ä“
(
d©a
);

1076 
ùx
->
d©a
 = 
´ev
;

1079 ià(
	`ngx_þo£_dœ
(&
dœ
è=ð
NGX_ERROR
) {

1080 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 
ngx_”ºo
,

1081 
ngx_þo£_dœ_n
 " \"%s\" fažed", 
Œ“
->
d©a
);

1084  
rc
;

1085 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_hash.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

13 
	$ngx_hash_fšd
(
ngx_hash_t
 *
hash
, 
ngx_ušt_t
 
key
, 
u_ch¬
 *
Çme
, 
size_t
 
Ën
)

15 
ngx_ušt_t
 
i
;

16 
ngx_hash_–t_t
 *
–t
;

19 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0, "hf:\"%*s\"", 
Ën
, 
Çme
);

22 
–t
 = 
hash
->
buck‘s
[
key
 % hash->
size
];

24 ià(
–t
 =ð
NULL
) {

25  
NULL
;

28 
–t
->
v®ue
) {

29 ià(
Ën
 !ð(
size_t
è
–t
->len) {

30 
Ãxt
;

33 
i
 = 0; i < 
Ën
; i++) {

34 ià(
Çme
[
i
] !ð
–t
->name[i]) {

35 
Ãxt
;

39  
–t
->
v®ue
;

41 
Ãxt
:

43 
–t
 = (
ngx_hash_–t_t
 *è
	`ngx_®ign_±r
(&–t->
Çme
[0] +ƒÉ->
Ën
,

48  
NULL
;

49 
	}
}

53 
	$ngx_hash_fšd_wc_h—d
(
ngx_hash_wždÿrd_t
 *
hwc
, 
u_ch¬
 *
Çme
, 
size_t
 
Ën
)

55 *
v®ue
;

56 
ngx_ušt_t
 
i
, 
n
, 
key
;

59 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0, "wch:\"%*s\"", 
Ën
, 
Çme
);

62 
n
 = 
Ën
;

64 
n
) {

65 ià(
Çme
[
n
 - 1] == '.') {

69 
n
--;

72 
key
 = 0;

74 
i
 = 
n
; i < 
Ën
; i++) {

75 
key
 = 
	`ngx_hash
(key, 
Çme
[
i
]);

79 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0, "key:\"%ui\"", 
key
);

82 
v®ue
 = 
	`ngx_hash_fšd
(&
hwc
->
hash
, 
key
, &
Çme
[
n
], 
Ën
 -‚);

85 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0, "v®ue:\"%p\"", 
v®ue
);

88 ià(
v®ue
) {

101 ià((
ušŒ_t
è
v®ue
 & 2) {

103 ià(
n
 == 0) {

107 ià((
ušŒ_t
è
v®ue
 & 1) {

108  
NULL
;

111 
hwc
 = (
ngx_hash_wždÿrd_t
 *)

112 ((
ušŒ_t
è
v®ue
 & (uintptr_t) ~3);

113  
hwc
->
v®ue
;

116 
hwc
 = (
ngx_hash_wždÿrd_t
 *è((
ušŒ_t
è
v®ue
 & (uintptr_t) ~3);

118 
v®ue
 = 
	`ngx_hash_fšd_wc_h—d
(
hwc
, 
Çme
, 
n
 - 1);

120 ià(
v®ue
) {

121  
v®ue
;

124  
hwc
->
v®ue
;

127 ià((
ušŒ_t
è
v®ue
 & 1) {

129 ià(
n
 == 0) {

133  
NULL
;

136  (*è((
ušŒ_t
è
v®ue
 & (uintptr_t) ~3);

139  
v®ue
;

142  
hwc
->
v®ue
;

143 
	}
}

147 
	$ngx_hash_fšd_wc_ž
(
ngx_hash_wždÿrd_t
 *
hwc
, 
u_ch¬
 *
Çme
, 
size_t
 
Ën
)

149 *
v®ue
;

150 
ngx_ušt_t
 
i
, 
key
;

153 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0, "wù:\"%*s\"", 
Ën
, 
Çme
);

156 
key
 = 0;

158 
i
 = 0; i < 
Ën
; i++) {

159 ià(
Çme
[
i
] == '.') {

163 
key
 = 
	`ngx_hash
(key, 
Çme
[
i
]);

166 ià(
i
 =ð
Ën
) {

167  
NULL
;

171 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0, "key:\"%ui\"", 
key
);

174 
v®ue
 = 
	`ngx_hash_fšd
(&
hwc
->
hash
, 
key
, 
Çme
, 
i
);

177 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0, "v®ue:\"%p\"", 
v®ue
);

180 ià(
v®ue
) {

188 ià((
ušŒ_t
è
v®ue
 & 2) {

190 
i
++;

192 
hwc
 = (
ngx_hash_wždÿrd_t
 *è((
ušŒ_t
è
v®ue
 & (uintptr_t) ~3);

194 
v®ue
 = 
	`ngx_hash_fšd_wc_ž
(
hwc
, &
Çme
[
i
], 
Ën
 - i);

196 ià(
v®ue
) {

197  
v®ue
;

200  
hwc
->
v®ue
;

203  
v®ue
;

206  
hwc
->
v®ue
;

207 
	}
}

211 
	$ngx_hash_fšd_combšed
(
ngx_hash_combšed_t
 *
hash
, 
ngx_ušt_t
 
key
, 
u_ch¬
 *
Çme
,

212 
size_t
 
Ën
)

214 *
v®ue
;

216 ià(
hash
->hash.
buck‘s
) {

217 
v®ue
 = 
	`ngx_hash_fšd
(&
hash
->hash, 
key
, 
Çme
, 
Ën
);

219 ià(
v®ue
) {

220  
v®ue
;

224 ià(
Ën
 == 0) {

225  
NULL
;

228 ià(
hash
->
wc_h—d
 && hash->wc_h—d->hash.
buck‘s
) {

229 
v®ue
 = 
	`ngx_hash_fšd_wc_h—d
(
hash
->
wc_h—d
, 
Çme
, 
Ën
);

231 ià(
v®ue
) {

232  
v®ue
;

236 ià(
hash
->
wc_ž
 && hash->wc_ž->hash.
buck‘s
) {

237 
v®ue
 = 
	`ngx_hash_fšd_wc_ž
(
hash
->
wc_ž
, 
Çme
, 
Ën
);

239 ià(
v®ue
) {

240  
v®ue
;

244  
NULL
;

245 
	}
}

248 
	#NGX_HASH_ELT_SIZE
(
Çme
) \

249 ((*è+ 
	`ngx_®ign
((
Çme
)->
key
.
Ën
 + 2, (*)))

	)

251 
ngx_št_t


252 
	$ngx_hash_š™
(
ngx_hash_š™_t
 *
hš™
, 
ngx_hash_key_t
 *
Çmes
, 
ngx_ušt_t
 
ÃÉs
)

254 
u_ch¬
 *
–ts
;

255 
size_t
 
Ën
;

256 
u_shÜt
 *
‹¡
;

257 
ngx_ušt_t
 
i
, 
n
, 
key
, 
size
, 
¡¬t
, 
buck‘_size
;

258 
ngx_hash_–t_t
 *
–t
, **
buck‘s
;

260 
n
 = 0;‚ < 
ÃÉs
;‚++) {

261 ià(
hš™
->
buck‘_size
 < 
	`NGX_HASH_ELT_SIZE
(&
Çmes
[
n
]) + (*))

263 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
hš™
->
poÞ
->
log
, 0,

266 
hš™
->
Çme
, hš™->Çme, hš™->
buck‘_size
);

267  
NGX_ERROR
;

271 
‹¡
 = 
	`ngx_®loc
(
hš™
->
max_size
 * (
u_shÜt
), hš™->
poÞ
->
log
);

272 ià(
‹¡
 =ð
NULL
) {

273  
NGX_ERROR
;

276 
buck‘_size
 = 
hš™
->bucket_size - (*);

278 
¡¬t
 = 
ÃÉs
 / (
buck‘_size
 / (2 * (*)));

279 
¡¬t
 = start ? start : 1;

281 ià(
hš™
->
max_size
 > 10000 && 
ÃÉs
 && hinit->max_size /‚elts < 100) {

282 
¡¬t
 = 
hš™
->
max_size
 - 1000;

285 
size
 = 
¡¬t
; siz<ð
hš™
->
max_size
; size++) {

287 
	`ngx_memz”o
(
‹¡
, 
size
 * (
u_shÜt
));

289 
n
 = 0;‚ < 
ÃÉs
;‚++) {

290 ià(
Çmes
[
n
].
key
.
d©a
 =ð
NULL
) {

294 
key
 = 
Çmes
[
n
].
key_hash
 % 
size
;

295 
‹¡
[
key
] = (
u_shÜt
èÑe¡[key] + 
	`NGX_HASH_ELT_SIZE
(&
Çmes
[
n
]));

298 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
hš™
->
poÞ
->
log
, 0,

300 
size
, 
key
, 
‹¡
[key], &
Çmes
[
n
].key);

303 ià(
‹¡
[
key
] > (
u_shÜt
è
buck‘_size
) {

304 
Ãxt
;

308 
found
;

310 
Ãxt
:

315 
size
--;

317 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
hš™
->
poÞ
->
log
, 0,

321 
hš™
->
Çme
, hš™->Çme, hš™->
max_size
,

322 
hš™
->
Çme
, hš™->
buck‘_size
, hinit->name);

324 
found
:

326 
i
 = 0; i < 
size
; i++) {

327 
‹¡
[
i
] = (*);

330 
n
 = 0;‚ < 
ÃÉs
;‚++) {

331 ià(
Çmes
[
n
].
key
.
d©a
 =ð
NULL
) {

335 
key
 = 
Çmes
[
n
].
key_hash
 % 
size
;

336 
‹¡
[
key
] = (
u_shÜt
èÑe¡[key] + 
	`NGX_HASH_ELT_SIZE
(&
Çmes
[
n
]));

339 
Ën
 = 0;

341 
i
 = 0; i < 
size
; i++) {

342 ià(
‹¡
[
i
] == (*)) {

346 
‹¡
[
i
] = (
u_shÜt
è(
	`ngx_®ign
Ñe¡[i], 
ngx_ÿch–še_size
));

348 
Ën
 +ð
‹¡
[
i
];

351 ià(
hš™
->
hash
 =ð
NULL
) {

352 
hš™
->
hash
 = 
	`ngx_pÿÎoc
(hš™->
poÞ
, (
ngx_hash_wždÿrd_t
)

353 + 
size
 * (
ngx_hash_–t_t
 *));

354 ià(
hš™
->
hash
 =ð
NULL
) {

355 
	`ngx_ä“
(
‹¡
);

356  
NGX_ERROR
;

359 
buck‘s
 = (
ngx_hash_–t_t
 **)

360 ((
u_ch¬
 *è
hš™
->
hash
 + (
ngx_hash_wždÿrd_t
));

363 
buck‘s
 = 
	`ngx_pÿÎoc
(
hš™
->
poÞ
, 
size
 * (
ngx_hash_–t_t
 *));

364 ià(
buck‘s
 =ð
NULL
) {

365 
	`ngx_ä“
(
‹¡
);

366  
NGX_ERROR
;

370 
–ts
 = 
	`ngx_·Îoc
(
hš™
->
poÞ
, 
Ën
 + 
ngx_ÿch–še_size
);

371 ià(
–ts
 =ð
NULL
) {

372 
	`ngx_ä“
(
‹¡
);

373  
NGX_ERROR
;

376 
–ts
 = 
	`ngx_®ign_±r
ÓÉs, 
ngx_ÿch–še_size
);

378 
i
 = 0; i < 
size
; i++) {

379 ià(
‹¡
[
i
] == (*)) {

383 
buck‘s
[
i
] = (
ngx_hash_–t_t
 *è
–ts
;

384 
–ts
 +ð
‹¡
[
i
];

388 
i
 = 0; i < 
size
; i++) {

389 
‹¡
[
i
] = 0;

392 
n
 = 0;‚ < 
ÃÉs
;‚++) {

393 ià(
Çmes
[
n
].
key
.
d©a
 =ð
NULL
) {

397 
key
 = 
Çmes
[
n
].
key_hash
 % 
size
;

398 
–t
 = (
ngx_hash_–t_t
 *è((
u_ch¬
 *è
buck‘s
[
key
] + 
‹¡
[key]);

400 
–t
->
v®ue
 = 
Çmes
[
n
].value;

401 
–t
->
Ën
 = (
u_shÜt
è
Çmes
[
n
].
key
.len;

403 
	`ngx_¡¾ow
(
–t
->
Çme
, 
Çmes
[
n
].
key
.
d©a
,‚ames[n].key.
Ën
);

405 
‹¡
[
key
] = (
u_shÜt
èÑe¡[key] + 
	`NGX_HASH_ELT_SIZE
(&
Çmes
[
n
]));

408 
i
 = 0; i < 
size
; i++) {

409 ià(
buck‘s
[
i
] =ð
NULL
) {

413 
–t
 = (
ngx_hash_–t_t
 *è((
u_ch¬
 *è
buck‘s
[
i
] + 
‹¡
[i]);

415 
–t
->
v®ue
 = 
NULL
;

418 
	`ngx_ä“
(
‹¡
);

420 
hš™
->
hash
->
buck‘s
 = buckets;

421 
hš™
->
hash
->
size
 = size;

425 
i
 = 0; i < 
size
; i++) {

426 
ngx_¡r_t
 
v®
;

427 
ngx_ušt_t
 
key
;

429 
–t
 = 
buck‘s
[
i
];

431 ià(
–t
 =ð
NULL
) {

432 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
hš™
->
poÞ
->
log
, 0,

433 "%ui: NULL", 
i
);

437 
–t
->
v®ue
) {

438 
v®
.
Ën
 = 
–t
->len;

439 
v®
.
d©a
 = &
–t
->
Çme
[0];

441 
key
 = 
hš™
->
	`key
(
v®
.
d©a
, v®.
Ën
);

443 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
hš™
->
poÞ
->
log
, 0,

444 "%ui: %°\"%V\" %ui", 
i
, 
–t
, &
v®
, 
key
);

446 
–t
 = (
ngx_hash_–t_t
 *è
	`ngx_®ign_±r
(&–t->
Çme
[0] +ƒÉ->
Ën
,

453  
NGX_OK
;

454 
	}
}

457 
ngx_št_t


458 
	$ngx_hash_wždÿrd_š™
(
ngx_hash_š™_t
 *
hš™
, 
ngx_hash_key_t
 *
Çmes
,

459 
ngx_ušt_t
 
ÃÉs
)

461 
size_t
 
Ën
, 
dÙ_Ën
;

462 
ngx_ušt_t
 
i
, 
n
, 
dÙ
;

463 
ngx_¬¿y_t
 
cu¼_Çmes
, 
Ãxt_Çmes
;

464 
ngx_hash_key_t
 *
Çme
, *
Ãxt_Çme
;

465 
ngx_hash_š™_t
 
h
;

466 
ngx_hash_wždÿrd_t
 *
wdc
;

468 ià(
	`ngx_¬¿y_š™
(&
cu¼_Çmes
, 
hš™
->
‹mp_poÞ
, 
ÃÉs
,

469 (
ngx_hash_key_t
))

470 !ð
NGX_OK
)

472  
NGX_ERROR
;

475 ià(
	`ngx_¬¿y_š™
(&
Ãxt_Çmes
, 
hš™
->
‹mp_poÞ
, 
ÃÉs
,

476 (
ngx_hash_key_t
))

477 !ð
NGX_OK
)

479  
NGX_ERROR
;

482 
n
 = 0;‚ < 
ÃÉs
;‚ = 
i
) {

485 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
hš™
->
poÞ
->
log
, 0,

486 "wc0: \"%V\"", &
Çmes
[
n
].
key
);

489 
dÙ
 = 0;

491 
Ën
 = 0;†’ < 
Çmes
[
n
].
key
.len;†en++) {

492 ià(
Çmes
[
n
].
key
.
d©a
[
Ën
] == '.') {

493 
dÙ
 = 1;

498 
Çme
 = 
	`ngx_¬¿y_push
(&
cu¼_Çmes
);

499 ià(
Çme
 =ð
NULL
) {

500  
NGX_ERROR
;

503 
Çme
->
key
.
Ën
 =†en;

504 
Çme
->
key
.
d©a
 = 
Çmes
[
n
].key.data;

505 
Çme
->
key_hash
 = 
hš™
->
	`key
Òame->
key
.
d©a
,‚ame->key.
Ën
);

506 
Çme
->
v®ue
 = 
Çmes
[
n
].value;

509 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
hš™
->
poÞ
->
log
, 0,

510 "wc1: \"%V\" %ui", &
Çme
->
key
, 
dÙ
);

513 
dÙ_Ën
 = 
Ën
 + 1;

515 ià(
dÙ
) {

516 
Ën
++;

519 
Ãxt_Çmes
.
ÃÉs
 = 0;

521 ià(
Çmes
[
n
].
key
.
Ën
 !=†en) {

522 
Ãxt_Çme
 = 
	`ngx_¬¿y_push
(&
Ãxt_Çmes
);

523 ià(
Ãxt_Çme
 =ð
NULL
) {

524  
NGX_ERROR
;

527 
Ãxt_Çme
->
key
.
Ën
 = 
Çmes
[
n
].key.len -†en;

528 
Ãxt_Çme
->
key
.
d©a
 = 
Çmes
[
n
].key.d©¨+ 
Ën
;

529 
Ãxt_Çme
->
key_hash
 = 0;

530 
Ãxt_Çme
->
v®ue
 = 
Çmes
[
n
].value;

533 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
hš™
->
poÞ
->
log
, 0,

534 "wc2: \"%V\"", &
Ãxt_Çme
->
key
);

538 
i
 = 
n
 + 1; i < 
ÃÉs
; i++) {

539 ià(
	`ngx_¡ºcmp
(
Çmes
[
n
].
key
.
d©a
,‚ames[
i
].key.d©a, 
Ën
) != 0) {

543 ià(!
dÙ


544 && 
Çmes
[
i
].
key
.
Ën
 >†en

545 && 
Çmes
[
i
].
key
.
d©a
[
Ën
] != '.')

550 
Ãxt_Çme
 = 
	`ngx_¬¿y_push
(&
Ãxt_Çmes
);

551 ià(
Ãxt_Çme
 =ð
NULL
) {

552  
NGX_ERROR
;

555 
Ãxt_Çme
->
key
.
Ën
 = 
Çmes
[
i
].key.ËÀ- 
dÙ_Ën
;

556 
Ãxt_Çme
->
key
.
d©a
 = 
Çmes
[
i
].key.d©¨+ 
dÙ_Ën
;

557 
Ãxt_Çme
->
key_hash
 = 0;

558 
Ãxt_Çme
->
v®ue
 = 
Çmes
[
i
].value;

561 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
hš™
->
poÞ
->
log
, 0,

562 "wc3: \"%V\"", &
Ãxt_Çme
->
key
);

566 ià(
Ãxt_Çmes
.
ÃÉs
) {

568 
h
 = *
hš™
;

569 
h
.
hash
 = 
NULL
;

571 ià(
	`ngx_hash_wždÿrd_š™
(&
h
, (
ngx_hash_key_t
 *è
Ãxt_Çmes
.
–ts
,

572 
Ãxt_Çmes
.
ÃÉs
)

573 !ð
NGX_OK
)

575  
NGX_ERROR
;

578 
wdc
 = (
ngx_hash_wždÿrd_t
 *è
h
.
hash
;

580 ià(
Çmes
[
n
].
key
.
Ën
 ==†en) {

581 
wdc
->
v®ue
 = 
Çmes
[
n
].value;

584 
Çme
->
v®ue
 = (*è((
ušŒ_t
è
wdc
 | (
dÙ
 ? 3 : 2));

586 } ià(
dÙ
) {

587 
Çme
->
v®ue
 = (*è((
ušŒ_t
)‚ame->value | 1);

591 ià(
	`ngx_hash_š™
(
hš™
, (
ngx_hash_key_t
 *è
cu¼_Çmes
.
–ts
,

592 
cu¼_Çmes
.
ÃÉs
)

593 !ð
NGX_OK
)

595  
NGX_ERROR
;

598  
NGX_OK
;

599 
	}
}

602 
ngx_ušt_t


603 
	$ngx_hash_key
(
u_ch¬
 *
d©a
, 
size_t
 
Ën
)

605 
ngx_ušt_t
 
i
, 
key
;

607 
key
 = 0;

609 
i
 = 0; i < 
Ën
; i++) {

610 
key
 = 
	`ngx_hash
(key, 
d©a
[
i
]);

613  
key
;

614 
	}
}

617 
ngx_ušt_t


618 
	$ngx_hash_key_lc
(
u_ch¬
 *
d©a
, 
size_t
 
Ën
)

620 
ngx_ušt_t
 
i
, 
key
;

622 
key
 = 0;

624 
i
 = 0; i < 
Ën
; i++) {

625 
key
 = 
	`ngx_hash
(key, 
	`ngx_tÞow”
(
d©a
[
i
]));

628  
key
;

629 
	}
}

632 
ngx_ušt_t


633 
	$ngx_hash_¡¾ow
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
n
)

635 
ngx_ušt_t
 
key
;

637 
key
 = 0;

639 
n
--) {

640 *
d¡
 = 
	`ngx_tÞow”
(*
¤c
);

641 
key
 = 
	`ngx_hash
(key, *
d¡
);

642 
d¡
++;

643 
¤c
++;

646  
key
;

647 
	}
}

650 
ngx_št_t


651 
	$ngx_hash_keys_¬¿y_š™
(
ngx_hash_keys_¬¿ys_t
 *
ha
, 
ngx_ušt_t
 
ty³
)

653 
ngx_ušt_t
 
asize
;

655 ià(
ty³
 =ð
NGX_HASH_SMALL
) {

656 
asize
 = 4;

657 
ha
->
hsize
 = 107;

660 
asize
 = 
NGX_HASH_LARGE_ASIZE
;

661 
ha
->
hsize
 = 
NGX_HASH_LARGE_HSIZE
;

664 ià(
	`ngx_¬¿y_š™
(&
ha
->
keys
, ha->
‹mp_poÞ
, 
asize
, (
ngx_hash_key_t
))

665 !ð
NGX_OK
)

667  
NGX_ERROR
;

670 ià(
	`ngx_¬¿y_š™
(&
ha
->
dns_wc_h—d
, ha->
‹mp_poÞ
, 
asize
,

671 (
ngx_hash_key_t
))

672 !ð
NGX_OK
)

674  
NGX_ERROR
;

677 ià(
	`ngx_¬¿y_š™
(&
ha
->
dns_wc_ž
, ha->
‹mp_poÞ
, 
asize
,

678 (
ngx_hash_key_t
))

679 !ð
NGX_OK
)

681  
NGX_ERROR
;

684 
ha
->
keys_hash
 = 
	`ngx_pÿÎoc
(ha->
‹mp_poÞ
, (
ngx_¬¿y_t
è* ha->
hsize
);

685 ià(
ha
->
keys_hash
 =ð
NULL
) {

686  
NGX_ERROR
;

689 
ha
->
dns_wc_h—d_hash
 = 
	`ngx_pÿÎoc
(ha->
‹mp_poÞ
,

690 (
ngx_¬¿y_t
è* 
ha
->
hsize
);

691 ià(
ha
->
dns_wc_h—d_hash
 =ð
NULL
) {

692  
NGX_ERROR
;

695 
ha
->
dns_wc_ž_hash
 = 
	`ngx_pÿÎoc
(ha->
‹mp_poÞ
,

696 (
ngx_¬¿y_t
è* 
ha
->
hsize
);

697 ià(
ha
->
dns_wc_ž_hash
 =ð
NULL
) {

698  
NGX_ERROR
;

701  
NGX_OK
;

702 
	}
}

705 
ngx_št_t


706 
	$ngx_hash_add_key
(
ngx_hash_keys_¬¿ys_t
 *
ha
, 
ngx_¡r_t
 *
key
, *
v®ue
,

707 
ngx_ušt_t
 
æags
)

709 
size_t
 
Ën
;

710 
u_ch¬
 *
p
;

711 
ngx_¡r_t
 *
Çme
;

712 
ngx_ušt_t
 
i
, 
k
, 
n
, 
sk
, 
Ï¡
;

713 
ngx_¬¿y_t
 *
keys
, *
hwc
;

714 
ngx_hash_key_t
 *
hk
;

716 
Ï¡
 = 
key
->
Ën
;

718 ià(
æags
 & 
NGX_HASH_WILDCARD_KEY
) {

725 
n
 = 0;

727 
i
 = 0; i < 
key
->
Ën
; i++) {

729 ià(
key
->
d©a
[
i
] == '*') {

730 ià(++
n
 > 1) {

731  
NGX_DECLINED
;

735 ià(
key
->
d©a
[
i
] == '.' && key->data[i + 1] == '.') {

736  
NGX_DECLINED
;

740 ià(
key
->
Ën
 > 1 && key->
d©a
[0] == '.') {

741 
sk
 = 1;

742 
wždÿrd
;

745 ià(
key
->
Ën
 > 2) {

747 ià(
key
->
d©a
[0] == '*' && key->data[1] == '.') {

748 
sk
 = 2;

749 
wždÿrd
;

752 ià(
key
->
d©a
[
i
 - 2] == '.' && key->data[i - 1] == '*') {

753 
sk
 = 0;

754 
Ï¡
 -= 2;

755 
wždÿrd
;

759 ià(
n
) {

760  
NGX_DECLINED
;

766 
k
 = 0;

768 
i
 = 0; i < 
Ï¡
; i++) {

769 ià(!(
æags
 & 
NGX_HASH_READONLY_KEY
)) {

770 
key
->
d©a
[
i
] = 
	`ngx_tÞow”
(key->data[i]);

772 
k
 = 
	`ngx_hash
(k, 
key
->
d©a
[
i
]);

775 
k
 %ð
ha
->
hsize
;

779 
Çme
 = 
ha
->
keys_hash
[
k
].
–ts
;

781 ià(
Çme
) {

782 
i
 = 0; i < 
ha
->
keys_hash
[
k
].
ÃÉs
; i++) {

783 ià(
Ï¡
 !ð
Çme
[
i
].
Ën
) {

787 ià(
	`ngx_¡ºcmp
(
key
->
d©a
, 
Çme
[
i
].d©a, 
Ï¡
) == 0) {

788  
NGX_BUSY
;

793 ià(
	`ngx_¬¿y_š™
(&
ha
->
keys_hash
[
k
], ha->
‹mp_poÞ
, 4,

794 (
ngx_¡r_t
))

795 !ð
NGX_OK
)

797  
NGX_ERROR
;

801 
Çme
 = 
	`ngx_¬¿y_push
(&
ha
->
keys_hash
[
k
]);

802 ià(
Çme
 =ð
NULL
) {

803  
NGX_ERROR
;

806 *
Çme
 = *
key
;

808 
hk
 = 
	`ngx_¬¿y_push
(&
ha
->
keys
);

809 ià(
hk
 =ð
NULL
) {

810  
NGX_ERROR
;

813 
hk
->
key
 = *key;

814 
hk
->
key_hash
 = 
	`ngx_hash_key
(
key
->
d©a
, 
Ï¡
);

815 
hk
->
v®ue
 = value;

817  
NGX_OK
;

820 
wždÿrd
:

824 
k
 = 
	`ngx_hash_¡¾ow
(&
key
->
d©a
[
sk
], &key->d©a[sk], 
Ï¡
 - skip);

826 
k
 %ð
ha
->
hsize
;

828 ià(
sk
 == 1) {

832 
Çme
 = 
ha
->
keys_hash
[
k
].
–ts
;

834 ià(
Çme
) {

835 
Ën
 = 
Ï¡
 - 
sk
;

837 
i
 = 0; i < 
ha
->
keys_hash
[
k
].
ÃÉs
; i++) {

838 ià(
Ën
 !ð
Çme
[
i
].len) {

842 ià(
	`ngx_¡ºcmp
(&
key
->
d©a
[1], 
Çme
[
i
].d©a, 
Ën
) == 0) {

843  
NGX_BUSY
;

848 ià(
	`ngx_¬¿y_š™
(&
ha
->
keys_hash
[
k
], ha->
‹mp_poÞ
, 4,

849 (
ngx_¡r_t
))

850 !ð
NGX_OK
)

852  
NGX_ERROR
;

856 
Çme
 = 
	`ngx_¬¿y_push
(&
ha
->
keys_hash
[
k
]);

857 ià(
Çme
 =ð
NULL
) {

858  
NGX_ERROR
;

861 
Çme
->
Ën
 = 
Ï¡
 - 1;

862 
Çme
->
d©a
 = 
	`ngx_²®loc
(
ha
->
‹mp_poÞ
,‚ame->
Ën
);

863 ià(
Çme
->
d©a
 =ð
NULL
) {

864  
NGX_ERROR
;

867 
	`ngx_memýy
(
Çme
->
d©a
, &
key
->d©a[1],‚ame->
Ën
);

871 ià(
sk
) {

878 
p
 = 
	`ngx_²®loc
(
ha
->
‹mp_poÞ
, 
Ï¡
);

879 ià(
p
 =ð
NULL
) {

880  
NGX_ERROR
;

883 
Ën
 = 0;

884 
n
 = 0;

886 
i
 = 
Ï¡
 - 1; i; i--) {

887 ià(
key
->
d©a
[
i
] == '.') {

888 
	`ngx_memýy
(&
p
[
n
], &
key
->
d©a
[
i
 + 1], 
Ën
);

889 
n
 +ð
Ën
;

890 
p
[
n
++] = '.';

891 
Ën
 = 0;

895 
Ën
++;

898 ià(
Ën
) {

899 
	`ngx_memýy
(&
p
[
n
], &
key
->
d©a
[1], 
Ën
);

900 
n
 +ð
Ën
;

903 
p
[
n
] = '\0';

905 
hwc
 = &
ha
->
dns_wc_h—d
;

906 
keys
 = &
ha
->
dns_wc_h—d_hash
[
k
];

912 
Ï¡
++;

914 
p
 = 
	`ngx_²®loc
(
ha
->
‹mp_poÞ
, 
Ï¡
);

915 ià(
p
 =ð
NULL
) {

916  
NGX_ERROR
;

919 
	`ngx_ýy¡º
(
p
, 
key
->
d©a
, 
Ï¡
);

921 
hwc
 = &
ha
->
dns_wc_ž
;

922 
keys
 = &
ha
->
dns_wc_ž_hash
[
k
];

928 
Çme
 = 
keys
->
–ts
;

930 ià(
Çme
) {

931 
Ën
 = 
Ï¡
 - 
sk
;

933 
i
 = 0; i < 
keys
->
ÃÉs
; i++) {

934 ià(
Ën
 !ð
Çme
[
i
].len) {

938 ià(
	`ngx_¡ºcmp
(
key
->
d©a
 + 
sk
, 
Çme
[
i
].d©a, 
Ën
) == 0) {

939  
NGX_BUSY
;

944 ià(
	`ngx_¬¿y_š™
(
keys
, 
ha
->
‹mp_poÞ
, 4, (
ngx_¡r_t
)è!ð
NGX_OK
)

946  
NGX_ERROR
;

950 
Çme
 = 
	`ngx_¬¿y_push
(
keys
);

951 ià(
Çme
 =ð
NULL
) {

952  
NGX_ERROR
;

955 
Çme
->
Ën
 = 
Ï¡
 - 
sk
;

956 
Çme
->
d©a
 = 
	`ngx_²®loc
(
ha
->
‹mp_poÞ
,‚ame->
Ën
);

957 ià(
Çme
->
d©a
 =ð
NULL
) {

958  
NGX_ERROR
;

961 
	`ngx_memýy
(
Çme
->
d©a
, 
key
->d©¨+ 
sk
,‚ame->
Ën
);

966 
hk
 = 
	`ngx_¬¿y_push
(
hwc
);

967 ià(
hk
 =ð
NULL
) {

968  
NGX_ERROR
;

971 
hk
->
key
.
Ën
 = 
Ï¡
 - 1;

972 
hk
->
key
.
d©a
 = 
p
;

973 
hk
->
key_hash
 = 0;

974 
hk
->
v®ue
 = value;

976  
NGX_OK
;

977 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_inet.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_št_t
 
ngx_·r£_unix_domaš_u¾
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
);

13 
ngx_št_t
 
ngx_·r£_š‘_u¾
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
);

14 
ngx_št_t
 
ngx_·r£_š‘6_u¾
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
);

17 
š_addr_t


18 
	$ngx_š‘_addr
(
u_ch¬
 *
‹xt
, 
size_t
 
Ën
)

20 
u_ch¬
 *
p
, 
c
;

21 
š_addr_t
 
addr
;

22 
ngx_ušt_t
 
où‘
, 
n
;

24 
addr
 = 0;

25 
où‘
 = 0;

26 
n
 = 0;

28 
p
 = 
‹xt
;… <exˆ+ 
Ën
;…++) {

30 
c
 = *
p
;

32 ià(
c
 >= '0' && c <= '9') {

33 
où‘
 = où‘ * 10 + (
c
 - '0');

37 ià(
c
 =ð'.' && 
où‘
 < 256) {

38 
addr
 = (add¸<< 8è+ 
où‘
;

39 
où‘
 = 0;

40 
n
++;

44  
INADDR_NONE
;

47 ià(
n
 =ð3 && 
où‘
 < 256) {

48 
addr
 = (add¸<< 8è+ 
où‘
;

49  
	`htÚl
(
addr
);

52  
INADDR_NONE
;

53 
	}
}

56 #ià(
NGX_HAVE_INET6
)

58 
ngx_št_t


59 
	$ngx_š‘6_addr
(
u_ch¬
 *
p
, 
size_t
 
Ën
, u_ch¬ *
addr
)

61 
u_ch¬
 
c
, *
z”o
, *
dig™
, *
s
, *
d
;

62 
size_t
 
Ën4
;

63 
ngx_ušt_t
 
n
, 
nibbËs
, 
wÜd
;

65 ià(
Ën
 == 0) {

66  
NGX_ERROR
;

69 
z”o
 = 
NULL
;

70 
dig™
 = 
NULL
;

71 
Ën4
 = 0;

72 
nibbËs
 = 0;

73 
wÜd
 = 0;

74 
n
 = 8;

76 ià(
p
[0] == ':') {

77 
p
++;

78 
Ën
--;

81  ; 
Ën
;†en--) {

82 
c
 = *
p
++;

84 ià(
c
 == ':') {

85 ià(
nibbËs
) {

86 
dig™
 = 
p
;

87 
Ën4
 = 
Ën
;

88 *
addr
++ = (
u_ch¬
è(
wÜd
 >> 8);

89 *
addr
++ = (
u_ch¬
è(
wÜd
 & 0xff);

91 ià(--
n
) {

92 
nibbËs
 = 0;

93 
wÜd
 = 0;

98 ià(
z”o
 =ð
NULL
) {

99 
dig™
 = 
p
;

100 
Ën4
 = 
Ën
;

101 
z”o
 = 
addr
;

106  
NGX_ERROR
;

109 ià(
c
 =ð'.' && 
nibbËs
) {

110 ià(
n
 < 2 || 
dig™
 =ð
NULL
) {

111  
NGX_ERROR
;

114 
wÜd
 = 
	`ngx_š‘_addr
(
dig™
, 
Ën4
 - 1);

115 ià(
wÜd
 =ð
INADDR_NONE
) {

116  
NGX_ERROR
;

119 
wÜd
 = 
	`Áohl
(word);

120 *
addr
++ = (
u_ch¬
è((
wÜd
 >> 24) & 0xff);

121 *
addr
++ = (
u_ch¬
è((
wÜd
 >> 16) & 0xff);

122 
n
--;

126 ià(++
nibbËs
 > 4) {

127  
NGX_ERROR
;

130 ià(
c
 >= '0' && c <= '9') {

131 
wÜd
 = wÜd * 16 + (
c
 - '0');

135 
c
 |= 0x20;

137 ià(
c
 >= 'a' && c <= 'f') {

138 
wÜd
 = wÜd * 16 + (
c
 - 'a') + 10;

142  
NGX_ERROR
;

145 ià(
nibbËs
 =ð0 && 
z”o
 =ð
NULL
) {

146  
NGX_ERROR
;

149 *
addr
++ = (
u_ch¬
è(
wÜd
 >> 8);

150 *
addr
++ = (
u_ch¬
è(
wÜd
 & 0xff);

152 ià(--
n
) {

153 ià(
z”o
) {

154 
n
 *= 2;

155 
s
 = 
addr
 - 1;

156 
d
 = 
s
 + 
n
;

157 
s
 >ð
z”o
) {

158 *
d
-- = *
s
--;

160 
	`ngx_memz”o
(
z”o
, 
n
);

161  
NGX_OK
;

165 ià(
z”o
 =ð
NULL
) {

166  
NGX_OK
;

170  
NGX_ERROR
;

171 
	}
}

176 
size_t


177 
	$ngx_sock_ÁÝ
(
sockaddr
 *
§
, 
sockËn_t
 
sockËn
, 
u_ch¬
 *
‹xt
, 
size_t
 
Ën
,

178 
ngx_ušt_t
 
pÜt
)

180 
u_ch¬
 *
p
;

181 
sockaddr_š
 *
sš
;

182 #ià(
NGX_HAVE_INET6
)

183 
size_t
 
n
;

184 
sockaddr_š6
 *
sš6
;

186 #ià(
NGX_HAVE_UNIX_DOMAIN
)

187 
sockaddr_un
 *
§un
;

190 
§
->
§_çmžy
) {

192 
AF_INET
:

194 
sš
 = (
sockaddr_š
 *è
§
;

195 
p
 = (
u_ch¬
 *è&
sš
->
sš_addr
;

197 ià(
pÜt
) {

198 
p
 = 
	`ngx_¢´štf
(
‹xt
, 
Ën
, "%ud.%ud.%ud.%ud:%d",

199 
p
[0],…[1],…[2],…[3], 
	`Áohs
(
sš
->
sš_pÜt
));

201 
p
 = 
	`ngx_¢´štf
(
‹xt
, 
Ën
, "%ud.%ud.%ud.%ud",

202 
p
[0],…[1],…[2],…[3]);

205  (
p
 - 
‹xt
);

207 #ià(
NGX_HAVE_INET6
)

209 
AF_INET6
:

211 
sš6
 = (
sockaddr_š6
 *è
§
;

213 
n
 = 0;

215 ià(
pÜt
) {

216 
‹xt
[
n
++] = '[';

219 
n
 = 
	`ngx_š‘6_ÁÝ
(
sš6
->
sš6_addr
.
s6_addr
, &
‹xt
[n], 
Ën
);

221 ià(
pÜt
) {

222 
n
 = 
	`ngx_¥rštf
(&
‹xt
[1 +‚], "]:%d",

223 
	`Áohs
(
sš6
->
sš6_pÜt
)è- 
‹xt
;

226  
n
;

229 #ià(
NGX_HAVE_UNIX_DOMAIN
)

231 
AF_UNIX
:

232 
§un
 = (
sockaddr_un
 *è
§
;

236 ià(
sockËn
 <ð(
sockËn_t
è
	`off£tof
(
sockaddr_un
, 
sun_·th
)) {

237 
p
 = 
	`ngx_¢´štf
(
‹xt
, 
Ën
, "unix:%Z");

240 
p
 = 
	`ngx_¢´štf
(
‹xt
, 
Ën
, "unix:%s%Z", 
§un
->
sun_·th
);

245  (
p
 - 
‹xt
 - 1);

252 
	}
}

255 
size_t


256 
	$ngx_š‘_ÁÝ
(
çmžy
, *
addr
, 
u_ch¬
 *
‹xt
, 
size_t
 
Ën
)

258 
u_ch¬
 *
p
;

260 
çmžy
) {

262 
AF_INET
:

264 
p
 = 
addr
;

266  
	`ngx_¢´štf
(
‹xt
, 
Ën
, "%ud.%ud.%ud.%ud",

267 
p
[0],…[1],…[2],…[3])

268 - 
‹xt
;

270 #ià(
NGX_HAVE_INET6
)

272 
AF_INET6
:

273  
	`ngx_š‘6_ÁÝ
(
addr
, 
‹xt
, 
Ën
);

280 
	}
}

283 #ià(
NGX_HAVE_INET6
)

285 
size_t


286 
	$ngx_š‘6_ÁÝ
(
u_ch¬
 *
p
, u_ch¬ *
‹xt
, 
size_t
 
Ën
)

288 
u_ch¬
 *
d¡
;

289 
size_t
 
max
, 
n
;

290 
ngx_ušt_t
 
i
, 
z”o
, 
Ï¡
;

292 ià(
Ën
 < 
NGX_INET6_ADDRSTRLEN
) {

296 
z”o
 = (
ngx_ušt_t
) -1;

297 
Ï¡
 = (
ngx_ušt_t
) -1;

298 
max
 = 1;

299 
n
 = 0;

301 
i
 = 0; i < 16; i += 2) {

303 ià(
p
[
i
] ||…[i + 1]) {

305 ià(
max
 < 
n
) {

306 
z”o
 = 
Ï¡
;

307 
max
 = 
n
;

310 
n
 = 0;

314 ià(
n
++ == 0) {

315 
Ï¡
 = 
i
;

319 ià(
max
 < 
n
) {

320 
z”o
 = 
Ï¡
;

321 
max
 = 
n
;

324 
d¡
 = 
‹xt
;

325 
n
 = 16;

327 ià(
z”o
 == 0) {

329 ià((
max
 =ð5 && 
p
[10] == 0xff &&…[11] == 0xff)

330 || (
max
 == 6)

331 || (
max
 =ð7 && 
p
[14] != 0 &&…[15] != 1))

333 
n
 = 12;

336 *
d¡
++ = ':';

339 
i
 = 0; i < 
n
; i += 2) {

341 ià(
i
 =ð
z”o
) {

342 *
d¡
++ = ':';

343 
i
 +ð(
max
 - 1) * 2;

347 
d¡
 = 
	`ngx_¥rštf
(d¡, "%uxi", 
p
[
i
] * 256 +…[i + 1]);

349 ià(
i
 < 14) {

350 *
d¡
++ = ':';

354 ià(
n
 == 12) {

355 
d¡
 = 
	`ngx_¥rštf
(d¡, "%ud.%ud.%ud.%ud", 
p
[12],…[13],…[14],…[15]);

358  
d¡
 - 
‹xt
;

359 
	}
}

364 
ngx_št_t


365 
	$ngx_±ocidr
(
ngx_¡r_t
 *
‹xt
, 
ngx_cidr_t
 *
cidr
)

367 
u_ch¬
 *
addr
, *
mask
, *
Ï¡
;

368 
size_t
 
Ën
;

369 
ngx_št_t
 
shiá
;

370 #ià(
NGX_HAVE_INET6
)

371 
ngx_št_t
 
rc
;

372 
ngx_ušt_t
 
s
, 
i
;

375 
addr
 = 
‹xt
->
d©a
;

376 
Ï¡
 = 
addr
 + 
‹xt
->
Ën
;

378 
mask
 = 
	`ngx_¡¾chr
(
addr
, 
Ï¡
, '/');

379 
Ën
 = (
mask
 ? mask : 
Ï¡
è- 
addr
;

381 
cidr
->
u
.
š
.
addr
 = 
	`ngx_š‘_addr
×ddr, 
Ën
);

383 ià(
cidr
->
u
.
š
.
addr
 !ð
INADDR_NONE
) {

384 
cidr
->
çmžy
 = 
AF_INET
;

386 ià(
mask
 =ð
NULL
) {

387 
cidr
->
u
.
š
.
mask
 = 0xffffffff;

388  
NGX_OK
;

391 #ià(
NGX_HAVE_INET6
)

392 } ià(
	`ngx_š‘6_addr
(
addr
, 
Ën
, 
cidr
->
u
.
š6
.addr.
s6_addr
è=ð
NGX_OK
) {

393 
cidr
->
çmžy
 = 
AF_INET6
;

395 ià(
mask
 =ð
NULL
) {

396 
	`ngx_mem£t
(
cidr
->
u
.
š6
.
mask
.
s6_addr
, 0xff, 16);

397  
NGX_OK
;

402  
NGX_ERROR
;

405 
mask
++;

407 
shiá
 = 
	`ngx_©oi
(
mask
, 
Ï¡
 - mask);

408 ià(
shiá
 =ð
NGX_ERROR
) {

409  
NGX_ERROR
;

412 
cidr
->
çmžy
) {

414 #ià(
NGX_HAVE_INET6
)

415 
AF_INET6
:

416 ià(
shiá
 > 128) {

417  
NGX_ERROR
;

420 
addr
 = 
cidr
->
u
.
š6
.addr.
s6_addr
;

421 
mask
 = 
cidr
->
u
.
š6
.mask.
s6_addr
;

422 
rc
 = 
NGX_OK
;

424 
i
 = 0; i < 16; i++) {

426 
s
 = (
shiá
 > 8) ? 8 : shift;

427 
shiá
 -ð
s
;

429 
mask
[
i
] = (
u_ch¬
è(0xffu << (8 - 
s
));

431 ià(
addr
[
i
] !ð×ddr[i] & 
mask
[i])) {

432 
rc
 = 
NGX_DONE
;

433 
addr
[
i
] &ð
mask
[i];

437  
rc
;

441 ià(
shiá
 > 32) {

442  
NGX_ERROR
;

445 ià(
shiá
) {

446 
cidr
->
u
.
š
.
mask
 = 
	`htÚl
((
ušt32_t
è(0xffffffffu << (32 - 
shiá
)));

450 
cidr
->
u
.
š
.
mask
 = 0;

453 ià(
cidr
->
u
.
š
.
addr
 =ð(cidr->u.š.add¸& cidr->u.š.
mask
)) {

454  
NGX_OK
;

457 
cidr
->
u
.
š
.
addr
 &ðcidr->u.š.
mask
;

459  
NGX_DONE
;

461 
	}
}

464 
ngx_št_t


465 
	$ngx_·r£_addr
(
ngx_poÞ_t
 *
poÞ
, 
ngx_addr_t
 *
addr
, 
u_ch¬
 *
‹xt
, 
size_t
 
Ën
)

467 
š_addr_t
 
šaddr
;

468 
ngx_ušt_t
 
çmžy
;

469 
sockaddr_š
 *
sš
;

470 #ià(
NGX_HAVE_INET6
)

471 
š6_addr
 
šaddr6
;

472 
sockaddr_š6
 *
sš6
;

478 
	`ngx_memz”o
(&
šaddr6
, (
š6_addr
));

481 
šaddr
 = 
	`ngx_š‘_addr
(
‹xt
, 
Ën
);

483 ià(
šaddr
 !ð
INADDR_NONE
) {

484 
çmžy
 = 
AF_INET
;

485 
Ën
 = (
sockaddr_š
);

487 #ià(
NGX_HAVE_INET6
)

488 } ià(
	`ngx_š‘6_addr
(
‹xt
, 
Ën
, 
šaddr6
.
s6_addr
è=ð
NGX_OK
) {

489 
çmžy
 = 
AF_INET6
;

490 
Ën
 = (
sockaddr_š6
);

494  
NGX_DECLINED
;

497 
addr
->
sockaddr
 = 
	`ngx_pÿÎoc
(
poÞ
, 
Ën
);

498 ià(
addr
->
sockaddr
 =ð
NULL
) {

499  
NGX_ERROR
;

502 
addr
->
sockaddr
->
§_çmžy
 = (
u_ch¬
è
çmžy
;

503 
addr
->
sockËn
 = 
Ën
;

505 
çmžy
) {

507 #ià(
NGX_HAVE_INET6
)

508 
AF_INET6
:

509 
sš6
 = (
sockaddr_š6
 *è
addr
->
sockaddr
;

510 
	`ngx_memýy
(
sš6
->
sš6_addr
.
s6_addr
, 
šaddr6
.s6_addr, 16);

515 
sš
 = (
sockaddr_š
 *è
addr
->
sockaddr
;

516 
sš
->
sš_addr
.
s_addr
 = 
šaddr
;

520  
NGX_OK
;

521 
	}
}

524 
ngx_št_t


525 
	$ngx_·r£_u¾
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
)

527 
u_ch¬
 *
p
;

529 
p
 = 
u
->
u¾
.
d©a
;

531 ià(
	`ngx_¡ºÿ£cmp
(
p
, (
u_ch¬
 *) "unix:", 5) == 0) {

532  
	`ngx_·r£_unix_domaš_u¾
(
poÞ
, 
u
);

535 ià(
p
[0] == '[') {

536  
	`ngx_·r£_š‘6_u¾
(
poÞ
, 
u
);

539  
	`ngx_·r£_š‘_u¾
(
poÞ
, 
u
);

540 
	}
}

543 
ngx_št_t


544 
	$ngx_·r£_unix_domaš_u¾
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
)

546 #ià(
NGX_HAVE_UNIX_DOMAIN
)

547 
u_ch¬
 *
·th
, *
uri
, *
Ï¡
;

548 
size_t
 
Ën
;

549 
sockaddr_un
 *
§un
;

551 
Ën
 = 
u
->
u¾
.len;

552 
·th
 = 
u
->
u¾
.
d©a
;

554 
·th
 += 5;

555 
Ën
 -= 5;

557 ià(
u
->
uri_·¹
) {

559 
Ï¡
 = 
·th
 + 
Ën
;

560 
uri
 = 
	`ngx_¡¾chr
(
·th
, 
Ï¡
, ':');

562 ià(
uri
) {

563 
Ën
 = 
uri
 - 
·th
;

564 
uri
++;

565 
u
->
uri
.
Ën
 = 
Ï¡
 - uri;

566 
u
->
uri
.
d©a
 = uri;

570 ià(
Ën
 == 0) {

571 
u
->
”r
 = "no…ath inhe unix domain socket";

572  
NGX_ERROR
;

575 
u
->
ho¡
.
Ën
 =†en++;

576 
u
->
ho¡
.
d©a
 = 
·th
;

578 ià(
Ën
 > (
§un
->
sun_·th
)) {

579 
u
->
”r
 = "too†ong…ath inhe unix domain socket";

580  
NGX_ERROR
;

583 
u
->
sockËn
 = (
sockaddr_un
);

584 
§un
 = (
sockaddr_un
 *è&
u
->
sockaddr
;

585 
§un
->
sun_çmžy
 = 
AF_UNIX
;

586 (è
	`ngx_ýy¡º
((
u_ch¬
 *è
§un
->
sun_·th
, 
·th
, 
Ën
);

588 
u
->
addrs
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_addr_t
));

589 ià(
u
->
addrs
 =ð
NULL
) {

590  
NGX_ERROR
;

593 
§un
 = 
	`ngx_pÿÎoc
(
poÞ
, (
sockaddr_un
));

594 ià(
§un
 =ð
NULL
) {

595  
NGX_ERROR
;

598 
u
->
çmžy
 = 
AF_UNIX
;

599 
u
->
Çddrs
 = 1;

601 
§un
->
sun_çmžy
 = 
AF_UNIX
;

602 (è
	`ngx_ýy¡º
((
u_ch¬
 *è
§un
->
sun_·th
, 
·th
, 
Ën
);

604 
u
->
addrs
[0].
sockaddr
 = (sockadd¸*è
§un
;

605 
u
->
addrs
[0].
sockËn
 = (
sockaddr_un
);

606 
u
->
addrs
[0].
Çme
.
Ën
 =†en + 4;

607 
u
->
addrs
[0].
Çme
.
d©a
 = u->
u¾
.data;

609  
NGX_OK
;

613 
u
->
”r
 = "the unix domain sockets‡re‚ot supported onhis…latform";

615  
NGX_ERROR
;

618 
	}
}

621 
ngx_št_t


622 
	$ngx_·r£_š‘_u¾
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
)

624 
u_ch¬
 *
p
, *
ho¡
, *
pÜt
, *
Ï¡
, *
uri
, *
¬gs
;

625 
size_t
 
Ën
;

626 
ngx_št_t
 
n
;

627 
sockaddr_š
 *
sš
;

628 #ià(
NGX_HAVE_INET6
)

629 
sockaddr_š6
 *
sš6
;

632 
u
->
sockËn
 = (
sockaddr_š
);

633 
sš
 = (
sockaddr_š
 *è&
u
->
sockaddr
;

634 
sš
->
sš_çmžy
 = 
AF_INET
;

636 
u
->
çmžy
 = 
AF_INET
;

638 
ho¡
 = 
u
->
u¾
.
d©a
;

640 
Ï¡
 = 
ho¡
 + 
u
->
u¾
.
Ën
;

642 
pÜt
 = 
	`ngx_¡¾chr
(
ho¡
, 
Ï¡
, ':');

644 
uri
 = 
	`ngx_¡¾chr
(
ho¡
, 
Ï¡
, '/');

646 
¬gs
 = 
	`ngx_¡¾chr
(
ho¡
, 
Ï¡
, '?');

648 ià(
¬gs
) {

649 ià(
uri
 =ð
NULL
 || 
¬gs
 < uri) {

650 
uri
 = 
¬gs
;

654 ià(
uri
) {

655 ià(
u
->
li¡’
 || !u->
uri_·¹
) {

656 
u
->
”r
 = "invalid host";

657  
NGX_ERROR
;

660 
u
->
uri
.
Ën
 = 
Ï¡
 - uri;

661 
u
->
uri
.
d©a
 = uri;

663 
Ï¡
 = 
uri
;

665 ià(
uri
 < 
pÜt
) {

666 
pÜt
 = 
NULL
;

670 ià(
pÜt
) {

671 
pÜt
++;

673 
Ën
 = 
Ï¡
 - 
pÜt
;

675 
n
 = 
	`ngx_©oi
(
pÜt
, 
Ën
);

677 ià(
n
 < 1 ||‚ > 65535) {

678 
u
->
”r
 = "invalid…ort";

679  
NGX_ERROR
;

682 
u
->
pÜt
 = (
š_pÜt_t
è
n
;

683 
sš
->
sš_pÜt
 = 
	`htÚs
((
š_pÜt_t
è
n
);

685 
u
->
pÜt_‹xt
.
Ën
 =†en;

686 
u
->
pÜt_‹xt
.
d©a
 = 
pÜt
;

688 
Ï¡
 = 
pÜt
 - 1;

691 ià(
uri
 =ð
NULL
) {

693 ià(
u
->
li¡’
) {

697 
n
 = 
	`ngx_©oi
(
ho¡
, 
Ï¡
 - host);

699 ià(
n
 !ð
NGX_ERROR
) {

701 ià(
n
 < 1 ||‚ > 65535) {

702 
u
->
”r
 = "invalid…ort";

703  
NGX_ERROR
;

706 
u
->
pÜt
 = (
š_pÜt_t
è
n
;

707 
sš
->
sš_pÜt
 = 
	`htÚs
((
š_pÜt_t
è
n
);

709 
u
->
pÜt_‹xt
.
Ën
 = 
Ï¡
 - 
ho¡
;

710 
u
->
pÜt_‹xt
.
d©a
 = 
ho¡
;

712 
u
->
wždÿrd
 = 1;

714  
NGX_OK
;

719 
u
->
no_pÜt
 = 1;

720 
u
->
pÜt
 = u->
deçuÉ_pÜt
;

721 
sš
->
sš_pÜt
 = 
	`htÚs
(
u
->
deçuÉ_pÜt
);

724 
Ën
 = 
Ï¡
 - 
ho¡
;

726 ià(
Ën
 == 0) {

727 
u
->
”r
 = "no host";

728  
NGX_ERROR
;

731 
u
->
ho¡
.
Ën
 =†en;

732 
u
->
ho¡
.
d©a
 = host;

734 ià(
u
->
li¡’
 && 
Ën
 =ð1 && *
ho¡
 == '*') {

735 
sš
->
sš_addr
.
s_addr
 = 
INADDR_ANY
;

736 
u
->
wždÿrd
 = 1;

737  
NGX_OK
;

740 
sš
->
sš_addr
.
s_addr
 = 
	`ngx_š‘_addr
(
ho¡
, 
Ën
);

742 ià(
sš
->
sš_addr
.
s_addr
 !ð
INADDR_NONE
) {

744 ià(
sš
->
sš_addr
.
s_addr
 =ð
INADDR_ANY
) {

745 
u
->
wždÿrd
 = 1;

748 
u
->
Çddrs
 = 1;

750 
u
->
addrs
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_addr_t
));

751 ià(
u
->
addrs
 =ð
NULL
) {

752  
NGX_ERROR
;

755 
sš
 = 
	`ngx_pÿÎoc
(
poÞ
, (
sockaddr_š
));

756 ià(
sš
 =ð
NULL
) {

757  
NGX_ERROR
;

760 
	`ngx_memýy
(
sš
, 
u
->
sockaddr
, (
sockaddr_š
));

762 
u
->
addrs
[0].
sockaddr
 = (sockadd¸*è
sš
;

763 
u
->
addrs
[0].
sockËn
 = (
sockaddr_š
);

765 
p
 = 
	`ngx_²®loc
(
poÞ
, 
u
->
ho¡
.
Ën
 + (":65535") - 1);

766 ià(
p
 =ð
NULL
) {

767  
NGX_ERROR
;

770 
u
->
addrs
[0].
Çme
.
Ën
 = 
	`ngx_¥rštf
(
p
, "%V:%d",

771 &
u
->
ho¡
, u->
pÜt
è- 
p
;

772 
u
->
addrs
[0].
Çme
.
d©a
 = 
p
;

774  
NGX_OK
;

777 ià(
u
->
no_»sÞve
) {

778  
NGX_OK
;

781 ià(
	`ngx_š‘_»sÞve_ho¡
(
poÞ
, 
u
è!ð
NGX_OK
) {

782  
NGX_ERROR
;

785 
u
->
çmžy
 = u->
addrs
[0].
sockaddr
->
§_çmžy
;

786 
u
->
sockËn
 = u->
addrs
[0].socklen;

787 
	`ngx_memýy
(
u
->
sockaddr
, u->
addrs
[0].sockaddr, u->addrs[0].
sockËn
);

789 
u
->
çmžy
) {

791 #ià(
NGX_HAVE_INET6
)

792 
AF_INET6
:

793 
sš6
 = (
sockaddr_š6
 *è&
u
->
sockaddr
;

795 ià(
	`IN6_IS_ADDR_UNSPECIFIED
(&
sš6
->
sš6_addr
)) {

796 
u
->
wždÿrd
 = 1;

803 
sš
 = (
sockaddr_š
 *è&
u
->
sockaddr
;

805 ià(
sš
->
sš_addr
.
s_addr
 =ð
INADDR_ANY
) {

806 
u
->
wždÿrd
 = 1;

812  
NGX_OK
;

813 
	}
}

816 
ngx_št_t


817 
	$ngx_·r£_š‘6_u¾
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
)

819 #ià(
NGX_HAVE_INET6
)

820 
u_ch¬
 *
p
, *
ho¡
, *
pÜt
, *
Ï¡
, *
uri
;

821 
size_t
 
Ën
;

822 
ngx_št_t
 
n
;

823 
sockaddr_š6
 *
sš6
;

825 
u
->
sockËn
 = (
sockaddr_š6
);

826 
sš6
 = (
sockaddr_š6
 *è&
u
->
sockaddr
;

827 
sš6
->
sš6_çmžy
 = 
AF_INET6
;

829 
ho¡
 = 
u
->
u¾
.
d©a
 + 1;

831 
Ï¡
 = 
u
->
u¾
.
d©a
 + u->u¾.
Ën
;

833 
p
 = 
	`ngx_¡¾chr
(
ho¡
, 
Ï¡
, ']');

835 ià(
p
 =ð
NULL
) {

836 
u
->
”r
 = "invalid host";

837  
NGX_ERROR
;

840 ià(
Ï¡
 - 
p
) {

842 
pÜt
 = 
p
 + 1;

844 
uri
 = 
	`ngx_¡¾chr
(
pÜt
, 
Ï¡
, '/');

846 ià(
uri
) {

847 ià(
u
->
li¡’
 || !u->
uri_·¹
) {

848 
u
->
”r
 = "invalid host";

849  
NGX_ERROR
;

852 
u
->
uri
.
Ën
 = 
Ï¡
 - uri;

853 
u
->
uri
.
d©a
 = uri;

855 
Ï¡
 = 
uri
;

858 ià(*
pÜt
 == ':') {

859 
pÜt
++;

861 
Ën
 = 
Ï¡
 - 
pÜt
;

863 
n
 = 
	`ngx_©oi
(
pÜt
, 
Ën
);

865 ià(
n
 < 1 ||‚ > 65535) {

866 
u
->
”r
 = "invalid…ort";

867  
NGX_ERROR
;

870 
u
->
pÜt
 = (
š_pÜt_t
è
n
;

871 
sš6
->
sš6_pÜt
 = 
	`htÚs
((
š_pÜt_t
è
n
);

873 
u
->
pÜt_‹xt
.
Ën
 =†en;

874 
u
->
pÜt_‹xt
.
d©a
 = 
pÜt
;

877 
u
->
no_pÜt
 = 1;

878 
u
->
pÜt
 = u->
deçuÉ_pÜt
;

879 
sš6
->
sš6_pÜt
 = 
	`htÚs
(
u
->
deçuÉ_pÜt
);

883 
Ën
 = 
p
 - 
ho¡
;

885 ià(
Ën
 == 0) {

886 
u
->
”r
 = "no host";

887  
NGX_ERROR
;

890 
u
->
ho¡
.
Ën
 =†en + 2;

891 
u
->
ho¡
.
d©a
 = host - 1;

893 ià(
	`ngx_š‘6_addr
(
ho¡
, 
Ën
, 
sš6
->
sš6_addr
.
s6_addr
è!ð
NGX_OK
) {

894 
u
->
”r
 = "invalid IPv6‡ddress";

895  
NGX_ERROR
;

898 ià(
	`IN6_IS_ADDR_UNSPECIFIED
(&
sš6
->
sš6_addr
)) {

899 
u
->
wždÿrd
 = 1;

902 
u
->
çmžy
 = 
AF_INET6
;

903 
u
->
Çddrs
 = 1;

905 
u
->
addrs
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_addr_t
));

906 ià(
u
->
addrs
 =ð
NULL
) {

907  
NGX_ERROR
;

910 
sš6
 = 
	`ngx_pÿÎoc
(
poÞ
, (
sockaddr_š6
));

911 ià(
sš6
 =ð
NULL
) {

912  
NGX_ERROR
;

915 
	`ngx_memýy
(
sš6
, 
u
->
sockaddr
, (
sockaddr_š6
));

917 
u
->
addrs
[0].
sockaddr
 = (sockadd¸*è
sš6
;

918 
u
->
addrs
[0].
sockËn
 = (
sockaddr_š6
);

920 
p
 = 
	`ngx_²®loc
(
poÞ
, 
u
->
ho¡
.
Ën
 + (":65535") - 1);

921 ià(
p
 =ð
NULL
) {

922  
NGX_ERROR
;

925 
u
->
addrs
[0].
Çme
.
Ën
 = 
	`ngx_¥rštf
(
p
, "%V:%d",

926 &
u
->
ho¡
, u->
pÜt
è- 
p
;

927 
u
->
addrs
[0].
Çme
.
d©a
 = 
p
;

929  
NGX_OK
;

933 
u
->
”r
 = "the INET6 sockets‡re‚ot supported onhis…latform";

935  
NGX_ERROR
;

938 
	}
}

941 #ià(
NGX_HAVE_GETADDRINFO
 && 
NGX_HAVE_INET6
)

943 
ngx_št_t


944 
	$ngx_š‘_»sÞve_ho¡
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
)

946 
u_ch¬
 *
p
, *
ho¡
;

947 
size_t
 
Ën
;

948 
š_pÜt_t
 
pÜt
;

949 
ngx_ušt_t
 
i
;

950 
addršfo
 
hšts
, *
»s
, *
½
;

951 
sockaddr_š
 *
sš
;

952 
sockaddr_š6
 *
sš6
;

954 
pÜt
 = 
	`htÚs
(
u
->port);

956 
ho¡
 = 
	`ngx_®loc
(
u
->ho¡.
Ën
 + 1, 
poÞ
->
log
);

957 ià(
ho¡
 =ð
NULL
) {

958  
NGX_ERROR
;

961 (è
	`ngx_ýy¡º
(
ho¡
, 
u
->ho¡.
d©a
, u->ho¡.
Ën
 + 1);

963 
	`ngx_memz”o
(&
hšts
, (
addršfo
));

964 
hšts
.
ai_çmžy
 = 
AF_UNSPEC
;

965 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

966 #ifdeà
AI_ADDRCONFIG


967 
hšts
.
ai_æags
 = 
AI_ADDRCONFIG
;

970 ià(
	`g‘addršfo
((*è
ho¡
, 
NULL
, &
hšts
, &
»s
) != 0) {

971 
u
->
”r
 = "host‚ot found";

972 
	`ngx_ä“
(
ho¡
);

973  
NGX_ERROR
;

976 
	`ngx_ä“
(
ho¡
);

978 
i
 = 0, 
½
 = 
»s
;„°!ð
NULL
;„°ð½->
ai_Ãxt
) {

980 
½
->
ai_çmžy
) {

982 
AF_INET
:

983 
AF_INET6
:

990 
i
++;

993 ià(
i
 == 0) {

994 
u
->
”r
 = "host‚ot found";

995 
çžed
;

1000 
u
->
addrs
 = 
	`ngx_pÿÎoc
(
poÞ
, 
i
 * (
ngx_addr_t
));

1001 ià(
u
->
addrs
 =ð
NULL
) {

1002 
çžed
;

1005 
u
->
Çddrs
 = 
i
;

1007 
i
 = 0;

1011 
½
 = 
»s
;„°!ð
NULL
;„°ð½->
ai_Ãxt
) {

1013 ià(
½
->
ai_çmžy
 !ð
AF_INET
) {

1017 
sš
 = 
	`ngx_pÿÎoc
(
poÞ
, 
½
->
ai_add¾’
);

1018 ià(
sš
 =ð
NULL
) {

1019 
çžed
;

1022 
	`ngx_memýy
(
sš
, 
½
->
ai_addr
,„p->
ai_add¾’
);

1024 
sš
->
sš_pÜt
 = 
pÜt
;

1026 
u
->
addrs
[
i
].
sockaddr
 = (sockadd¸*è
sš
;

1027 
u
->
addrs
[
i
].
sockËn
 = 
½
->
ai_add¾’
;

1029 
Ën
 = 
NGX_INET_ADDRSTRLEN
 + (":65535") - 1;

1031 
p
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

1032 ià(
p
 =ð
NULL
) {

1033 
çžed
;

1036 
Ën
 = 
	`ngx_sock_ÁÝ
((
sockaddr
 *è
sš
, 
½
->
ai_add¾’
, 
p
,†en, 1);

1038 
u
->
addrs
[
i
].
Çme
.
Ën
 =†en;

1039 
u
->
addrs
[
i
].
Çme
.
d©a
 = 
p
;

1041 
i
++;

1044 
½
 = 
»s
;„°!ð
NULL
;„°ð½->
ai_Ãxt
) {

1046 ià(
½
->
ai_çmžy
 !ð
AF_INET6
) {

1050 
sš6
 = 
	`ngx_pÿÎoc
(
poÞ
, 
½
->
ai_add¾’
);

1051 ià(
sš6
 =ð
NULL
) {

1052 
çžed
;

1055 
	`ngx_memýy
(
sš6
, 
½
->
ai_addr
,„p->
ai_add¾’
);

1057 
sš6
->
sš6_pÜt
 = 
pÜt
;

1059 
u
->
addrs
[
i
].
sockaddr
 = (sockadd¸*è
sš6
;

1060 
u
->
addrs
[
i
].
sockËn
 = 
½
->
ai_add¾’
;

1062 
Ën
 = 
NGX_INET6_ADDRSTRLEN
 + ("[]:65535") - 1;

1064 
p
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

1065 ià(
p
 =ð
NULL
) {

1066 
çžed
;

1069 
Ën
 = 
	`ngx_sock_ÁÝ
((
sockaddr
 *è
sš6
, 
½
->
ai_add¾’
, 
p
,

1070 
Ën
, 1);

1072 
u
->
addrs
[
i
].
Çme
.
Ën
 =†en;

1073 
u
->
addrs
[
i
].
Çme
.
d©a
 = 
p
;

1075 
i
++;

1078 
	`ä“addršfo
(
»s
);

1079  
NGX_OK
;

1081 
çžed
:

1083 
	`ä“addršfo
(
»s
);

1084  
NGX_ERROR
;

1085 
	}
}

1089 
ngx_št_t


1090 
	$ngx_š‘_»sÞve_ho¡
(
ngx_poÞ_t
 *
poÞ
, 
ngx_u¾_t
 *
u
)

1092 
u_ch¬
 *
p
, *
ho¡
;

1093 
size_t
 
Ën
;

1094 
š_pÜt_t
 
pÜt
;

1095 
š_addr_t
 
š_addr
;

1096 
ngx_ušt_t
 
i
;

1097 
ho¡’t
 *
h
;

1098 
sockaddr_š
 *
sš
;

1102 
pÜt
 = 
	`htÚs
(
u
->port);

1104 
š_addr
 = 
	`ngx_š‘_addr
(
u
->
ho¡
.
d©a
, u->ho¡.
Ën
);

1106 ià(
š_addr
 =ð
INADDR_NONE
) {

1107 
ho¡
 = 
	`ngx_®loc
(
u
->ho¡.
Ën
 + 1, 
poÞ
->
log
);

1108 ià(
ho¡
 =ð
NULL
) {

1109  
NGX_ERROR
;

1112 (è
	`ngx_ýy¡º
(
ho¡
, 
u
->ho¡.
d©a
, u->ho¡.
Ën
 + 1);

1114 
h
 = 
	`g‘ho¡byÇme
((*è
ho¡
);

1116 
	`ngx_ä“
(
ho¡
);

1118 ià(
h
 =ð
NULL
 || h->
h_addr_li¡
[0] == NULL) {

1119 
u
->
”r
 = "host‚ot found";

1120  
NGX_ERROR
;

1123 
i
 = 0; 
h
->
h_addr_li¡
[i] !ð
NULL
; i++) { }

1127 
u
->
addrs
 = 
	`ngx_pÿÎoc
(
poÞ
, 
i
 * (
ngx_addr_t
));

1128 ià(
u
->
addrs
 =ð
NULL
) {

1129  
NGX_ERROR
;

1132 
u
->
Çddrs
 = 
i
;

1134 
i
 = 0; i < 
u
->
Çddrs
; i++) {

1136 
sš
 = 
	`ngx_pÿÎoc
(
poÞ
, (
sockaddr_š
));

1137 ià(
sš
 =ð
NULL
) {

1138  
NGX_ERROR
;

1141 
sš
->
sš_çmžy
 = 
AF_INET
;

1142 
sš
->
sš_pÜt
 = 
pÜt
;

1143 
sš
->
sš_addr
.
s_addr
 = *(
š_addr_t
 *è(
h
->
h_addr_li¡
[
i
]);

1145 
u
->
addrs
[
i
].
sockaddr
 = (sockadd¸*è
sš
;

1146 
u
->
addrs
[
i
].
sockËn
 = (
sockaddr_š
);

1148 
Ën
 = 
NGX_INET_ADDRSTRLEN
 + (":65535") - 1;

1150 
p
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

1151 ià(
p
 =ð
NULL
) {

1152  
NGX_ERROR
;

1155 
Ën
 = 
	`ngx_sock_ÁÝ
((
sockaddr
 *è
sš
,

1156 (
sockaddr_š
), 
p
, 
Ën
, 1);

1158 
u
->
addrs
[
i
].
Çme
.
Ën
 =†en;

1159 
u
->
addrs
[
i
].
Çme
.
d©a
 = 
p
;

1166 
u
->
addrs
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_addr_t
));

1167 ià(
u
->
addrs
 =ð
NULL
) {

1168  
NGX_ERROR
;

1171 
sš
 = 
	`ngx_pÿÎoc
(
poÞ
, (
sockaddr_š
));

1172 ià(
sš
 =ð
NULL
) {

1173  
NGX_ERROR
;

1176 
u
->
Çddrs
 = 1;

1178 
sš
->
sš_çmžy
 = 
AF_INET
;

1179 
sš
->
sš_pÜt
 = 
pÜt
;

1180 
sš
->
sš_addr
.
s_addr
 = 
š_addr
;

1182 
u
->
addrs
[0].
sockaddr
 = (sockadd¸*è
sš
;

1183 
u
->
addrs
[0].
sockËn
 = (
sockaddr_š
);

1185 
p
 = 
	`ngx_²®loc
(
poÞ
, 
u
->
ho¡
.
Ën
 + (":65535") - 1);

1186 ià(
p
 =ð
NULL
) {

1187  
NGX_ERROR
;

1190 
u
->
addrs
[0].
Çme
.
Ën
 = 
	`ngx_¥rštf
(
p
, "%V:%d",

1191 &
u
->
ho¡
, 
	`Áohs
(
pÜt
)è- 
p
;

1192 
u
->
addrs
[0].
Çme
.
d©a
 = 
p
;

1195  
NGX_OK
;

1196 
	}
}

1201 
ngx_št_t


1202 
	$ngx_cmp_sockaddr
(
sockaddr
 *
§1
, 
sockËn_t
 
¦’1
,

1203 
sockaddr
 *
§2
, 
sockËn_t
 
¦’2
, 
ngx_ušt_t
 
cmp_pÜt
)

1205 
sockaddr_š
 *
sš1
, *
sš2
;

1206 #ià(
NGX_HAVE_INET6
)

1207 
sockaddr_š6
 *
sš61
, *
sš62
;

1209 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1210 
sockaddr_un
 *
§un1
, *
§un2
;

1213 ià(
§1
->
§_çmžy
 !ð
§2
->sa_family) {

1214  
NGX_DECLINED
;

1217 
§1
->
§_çmžy
) {

1219 #ià(
NGX_HAVE_INET6
)

1220 
AF_INET6
:

1222 
sš61
 = (
sockaddr_š6
 *è
§1
;

1223 
sš62
 = (
sockaddr_š6
 *è
§2
;

1225 ià(
cmp_pÜt
 && 
sš61
->
sš6_pÜt
 !ð
sš62
->sin6_port) {

1226  
NGX_DECLINED
;

1229 ià(
	`ngx_memcmp
(&
sš61
->
sš6_addr
, &
sš62
->sin6_addr, 16) != 0) {

1230  
NGX_DECLINED
;

1236 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1237 
AF_UNIX
:

1241 
§un1
 = (
sockaddr_un
 *è
§1
;

1242 
§un2
 = (
sockaddr_un
 *è
§2
;

1244 ià(
	`ngx_memcmp
(&
§un1
->
sun_·th
, &
§un2
->sun_path,

1245 (
§un1
->
sun_·th
))

1248  
NGX_DECLINED
;

1256 
sš1
 = (
sockaddr_š
 *è
§1
;

1257 
sš2
 = (
sockaddr_š
 *è
§2
;

1259 ià(
cmp_pÜt
 && 
sš1
->
sš_pÜt
 !ð
sš2
->sin_port) {

1260  
NGX_DECLINED
;

1263 ià(
sš1
->
sš_addr
.
s_addr
 !ð
sš2
->sin_addr.s_addr) {

1264  
NGX_DECLINED
;

1270  
NGX_OK
;

1271 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_list.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_li¡_t
 *

13 
	$ngx_li¡_ü—‹
(
ngx_poÞ_t
 *
poÞ
, 
ngx_ušt_t
 
n
, 
size_t
 
size
)

15 
ngx_li¡_t
 *
li¡
;

17 
li¡
 = 
	`ngx_·Îoc
(
poÞ
, (
ngx_li¡_t
));

18 ià(
li¡
 =ð
NULL
) {

19  
NULL
;

22 ià(
	`ngx_li¡_š™
(
li¡
, 
poÞ
, 
n
, 
size
è!ð
NGX_OK
) {

23  
NULL
;

26  
li¡
;

27 
	}
}

31 
	$ngx_li¡_push
(
ngx_li¡_t
 *
l
)

33 *
–t
;

34 
ngx_li¡_·¹_t
 *
Ï¡
;

36 
Ï¡
 = 
l
->last;

38 ià(
Ï¡
->
ÃÉs
 =ð
l
->
ÇÎoc
) {

42 
Ï¡
 = 
	`ngx_·Îoc
(
l
->
poÞ
, (
ngx_li¡_·¹_t
));

43 ià(
Ï¡
 =ð
NULL
) {

44  
NULL
;

47 
Ï¡
->
–ts
 = 
	`ngx_·Îoc
(
l
->
poÞ
,†->
ÇÎoc
 *†->
size
);

48 ià(
Ï¡
->
–ts
 =ð
NULL
) {

49  
NULL
;

52 
Ï¡
->
ÃÉs
 = 0;

53 
Ï¡
->
Ãxt
 = 
NULL
;

55 
l
->
Ï¡
->
Ãxt
 =†ast;

56 
l
->
Ï¡
 =†ast;

59 
–t
 = (*è
Ï¡
->
–ts
 + 
l
->
size
 *†a¡->
ÃÉs
;

60 
Ï¡
->
ÃÉs
++;

62  
–t
;

63 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_log.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 *
ngx_”rÜ_log
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

13 *
ngx_log_£t_Ëv–s
(
ngx_cÚf_t
 *
cf
, 
ngx_log_t
 *
log
);

14 
ngx_log_š£¹
(
ngx_log_t
 *
log
,‚gx_log_ˆ*
Ãw_log
);

17 
ngx_commªd_t
 
	gngx_”¾og_commªds
[] = {

19 {
ngx_¡ršg
("error_log"),

20 
NGX_MAIN_CONF
|
NGX_CONF_1MORE
,

21 
ngx_”rÜ_log
,

24 
NULL
},

26 
ngx_nuÎ_commªd


30 
ngx_cÜe_moduË_t
 
	gngx_”¾og_moduË_ùx
 = {

31 
ngx_¡ršg
("errlog"),

32 
NULL
,

33 
NULL


37 
ngx_moduË_t
 
	gngx_”¾og_moduË
 = {

38 
NGX_MODULE_V1
,

39 &
ngx_”¾og_moduË_ùx
,

40 
ngx_”¾og_commªds
,

41 
NGX_CORE_MODULE
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NGX_MODULE_V1_PADDING


53 
ngx_log_t
 
	gngx_log
;

54 
ngx_Ý’_fže_t
 
	gngx_log_fže
;

55 
ngx_ušt_t
 
	gngx_u£_¡d”r
 = 1;

58 
ngx_¡r_t
 
	g”r_Ëv–s
[] = {

59 
ngx_nuÎ_¡ršg
,

60 
ngx_¡ršg
("emerg"),

61 
ngx_¡ršg
("alert"),

62 
ngx_¡ršg
("crit"),

63 
ngx_¡ršg
("error"),

64 
ngx_¡ršg
("warn"),

65 
ngx_¡ršg
("notice"),

66 
ngx_¡ršg
("info"),

67 
ngx_¡ršg
("debug")

70 cÚ¡ *
	gdebug_Ëv–s
[] = {

76 #ià(
NGX_HAVE_VARIADIC_MACROS
)

79 
	$ngx_log_”rÜ_cÜe
(
ngx_ušt_t
 
Ëv–
, 
ngx_log_t
 *
log
, 
ngx_”r_t
 
”r
,

80 cÚ¡ *
fmt
, ...)

85 
	$ngx_log_”rÜ_cÜe
(
ngx_ušt_t
 
Ëv–
, 
ngx_log_t
 *
log
, 
ngx_”r_t
 
”r
,

86 cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

90 #ià(
NGX_HAVE_VARIADIC_MACROS
)

91 
va_li¡
 
¬gs
;

93 
u_ch¬
 *
p
, *
Ï¡
, *
msg
;

94 
u_ch¬
 
”r¡r
[
NGX_MAX_ERROR_STR
];

95 
ngx_ušt_t
 
wrÙe_¡d”r
, 
debug_cÚÃùiÚ
;

97 
Ï¡
 = 
”r¡r
 + 
NGX_MAX_ERROR_STR
;

99 
	`ngx_memýy
(
”r¡r
, 
ngx_ÿched_”r_log_time
.
d©a
,

100 
ngx_ÿched_”r_log_time
.
Ën
);

102 
p
 = 
”r¡r
 + 
ngx_ÿched_”r_log_time
.
Ën
;

104 
p
 = 
	`ngx_¦´štf
Õ, 
Ï¡
, " [%V] ", &
”r_Ëv–s
[
Ëv–
]);

107 
p
 = 
	`ngx_¦´štf
Õ, 
Ï¡
, "%P#" 
NGX_TID_T_FMT
 ": ",

108 
ngx_log_pid
, 
ngx_log_tid
);

110 ià(
log
->
cÚÃùiÚ
) {

111 
p
 = 
	`ngx_¦´štf
Õ, 
Ï¡
, "*%uA ", 
log
->
cÚÃùiÚ
);

114 
msg
 = 
p
;

116 #ià(
NGX_HAVE_VARIADIC_MACROS
)

118 
	`va_¡¬t
(
¬gs
, 
fmt
);

119 
p
 = 
	`ngx_v¦´štf
Õ, 
Ï¡
, 
fmt
, 
¬gs
);

120 
	`va_’d
(
¬gs
);

124 
p
 = 
	`ngx_v¦´štf
Õ, 
Ï¡
, 
fmt
, 
¬gs
);

128 ià(
”r
) {

129 
p
 = 
	`ngx_log_”ºo
Õ, 
Ï¡
, 
”r
);

132 ià(
Ëv–
 !ð
NGX_LOG_DEBUG
 && 
log
->
hªdËr
) {

133 
p
 = 
log
->
	`hªdËr
Öog,…, 
Ï¡
 -…);

136 ià(
p
 > 
Ï¡
 - 
NGX_LINEFEED_SIZE
) {

137 
p
 = 
Ï¡
 - 
NGX_LINEFEED_SIZE
;

140 
	`ngx_lšeãed
(
p
);

142 
wrÙe_¡d”r
 = 0;

143 
debug_cÚÃùiÚ
 = (
log
->
log_Ëv–
 & 
NGX_LOG_DEBUG_CONNECTION
) != 0;

145 
log
) {

147 ià(
log
->
log_Ëv–
 < 
Ëv–
 && !
debug_cÚÃùiÚ
) {

151 ià(
log
->
wr™”
) {

152 
log
->
	`wr™”
Öog, 
Ëv–
, 
”r¡r
, 
p
 -ƒrrstr);

153 
log
 =†og->
Ãxt
;

157 (è
	`ngx_wr™e_fd
(
log
->
fže
->
fd
, 
”r¡r
, 
p
 -ƒrrstr);

159 ià(
log
->
fže
->
fd
 =ð
ngx_¡d”r
) {

160 
wrÙe_¡d”r
 = 1;

163 
log
 =†og->
Ãxt
;

166 ià(!
ngx_u£_¡d”r


167 || 
Ëv–
 > 
NGX_LOG_WARN


168 || 
wrÙe_¡d”r
)

173 
msg
 -ð(7 + 
”r_Ëv–s
[
Ëv–
].
Ën
 + 3);

175 (è
	`ngx_¥rštf
(
msg
, "ngšx: [%V] ", &
”r_Ëv–s
[
Ëv–
]);

177 (è
	`ngx_wr™e_cÚsÞe
(
ngx_¡d”r
, 
msg
, 
p
 - msg);

178 
	}
}

181 #ià!(
NGX_HAVE_VARIADIC_MACROS
)

183 
ngx_cdeþ


184 
	$ngx_log_”rÜ
(
ngx_ušt_t
 
Ëv–
, 
ngx_log_t
 *
log
, 
ngx_”r_t
 
”r
,

185 cÚ¡ *
fmt
, ...)

187 
va_li¡
 
¬gs
;

189 ià(
log
->
log_Ëv–
 >ð
Ëv–
) {

190 
	`va_¡¬t
(
¬gs
, 
fmt
);

191 
	`ngx_log_”rÜ_cÜe
(
Ëv–
, 
log
, 
”r
, 
fmt
, 
¬gs
);

192 
	`va_’d
(
¬gs
);

194 
	}
}

197 
ngx_cdeþ


198 
	$ngx_log_debug_cÜe
(
ngx_log_t
 *
log
, 
ngx_”r_t
 
”r
, cÚ¡ *
fmt
, ...)

200 
va_li¡
 
¬gs
;

202 
	`va_¡¬t
(
¬gs
, 
fmt
);

203 
	`ngx_log_”rÜ_cÜe
(
NGX_LOG_DEBUG
, 
log
, 
”r
, 
fmt
, 
¬gs
);

204 
	`va_’d
(
¬gs
);

205 
	}
}

210 
ngx_cdeþ


211 
	$ngx_log_abÜt
(
ngx_”r_t
 
”r
, cÚ¡ *
fmt
, ...)

213 
u_ch¬
 *
p
;

214 
va_li¡
 
¬gs
;

215 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

217 
	`va_¡¬t
(
¬gs
, 
fmt
);

218 
p
 = 
	`ngx_v¢´štf
(
”r¡r
, Ó¼¡rè- 1, 
fmt
, 
¬gs
);

219 
	`va_’d
(
¬gs
);

221 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
”r
,

222 "%*s", 
p
 - 
”r¡r
,ƒrrstr);

223 
	}
}

226 
ngx_cdeþ


227 
	$ngx_log_¡d”r
(
ngx_”r_t
 
”r
, cÚ¡ *
fmt
, ...)

229 
u_ch¬
 *
p
, *
Ï¡
;

230 
va_li¡
 
¬gs
;

231 
u_ch¬
 
”r¡r
[
NGX_MAX_ERROR_STR
];

233 
Ï¡
 = 
”r¡r
 + 
NGX_MAX_ERROR_STR
;

234 
p
 = 
”r¡r
 + 7;

236 
	`ngx_memýy
(
”r¡r
, "nginx: ", 7);

238 
	`va_¡¬t
(
¬gs
, 
fmt
);

239 
p
 = 
	`ngx_v¦´štf
Õ, 
Ï¡
, 
fmt
, 
¬gs
);

240 
	`va_’d
(
¬gs
);

242 ià(
”r
) {

243 
p
 = 
	`ngx_log_”ºo
Õ, 
Ï¡
, 
”r
);

246 ià(
p
 > 
Ï¡
 - 
NGX_LINEFEED_SIZE
) {

247 
p
 = 
Ï¡
 - 
NGX_LINEFEED_SIZE
;

250 
	`ngx_lšeãed
(
p
);

252 (è
	`ngx_wr™e_cÚsÞe
(
ngx_¡d”r
, 
”r¡r
, 
p
 -ƒrrstr);

253 
	}
}

256 
u_ch¬
 *

257 
	$ngx_log_”ºo
(
u_ch¬
 *
buf
, u_ch¬ *
Ï¡
, 
ngx_”r_t
 
”r
)

259 ià(
buf
 > 
Ï¡
 - 50) {

263 
buf
 = 
Ï¡
 - 50;

264 *
buf
++ = '.';

265 *
buf
++ = '.';

266 *
buf
++ = '.';

269 #ià(
NGX_WIN32
)

270 
buf
 = 
	`ngx_¦´štf
(buf, 
Ï¡
, ((è
”r
 < 0x80000000)

271 ? " (%d: " : " (%Xd: ", 
”r
);

273 
buf
 = 
	`ngx_¦´štf
(buf, 
Ï¡
, " (%d: ", 
”r
);

276 
buf
 = 
	`ngx_¡»¼Ü
(
”r
, buf, 
Ï¡
 - buf);

278 ià(
buf
 < 
Ï¡
) {

279 *
buf
++ = ')';

282  
buf
;

283 
	}
}

286 
ngx_log_t
 *

287 
	$ngx_log_š™
(
u_ch¬
 *
´efix
)

289 
u_ch¬
 *
p
, *
Çme
;

290 
size_t
 
Æ’
, 
¶’
;

292 
ngx_log
.
fže
 = &
ngx_log_fže
;

293 
ngx_log
.
log_Ëv–
 = 
NGX_LOG_NOTICE
;

295 
Çme
 = (
u_ch¬
 *è
NGX_ERROR_LOG_PATH
;

302 
Æ’
 = 
	`ngx_¡¾’
(
Çme
);

304 ià(
Æ’
 == 0) {

305 
ngx_log_fže
.
fd
 = 
ngx_¡d”r
;

306  &
ngx_log
;

309 
p
 = 
NULL
;

311 #ià(
NGX_WIN32
)

312 ià(
Çme
[1] != ':') {

314 ià(
Çme
[0] != '/') {

317 ià(
´efix
) {

318 
¶’
 = 
	`ngx_¡¾’
(
´efix
);

321 #ifdeà
NGX_PREFIX


322 
´efix
 = (
u_ch¬
 *è
NGX_PREFIX
;

323 
¶’
 = 
	`ngx_¡¾’
(
´efix
);

325 
¶’
 = 0;

329 ià(
¶’
) {

330 
Çme
 = 
	`m®loc
(
¶’
 + 
Æ’
 + 2);

331 ià(
Çme
 =ð
NULL
) {

332  
NULL
;

335 
p
 = 
	`ngx_ýymem
(
Çme
, 
´efix
, 
¶’
);

337 ià(!
	`ngx_·th_£·¿tÜ
(*(
p
 - 1))) {

338 *
p
++ = '/';

341 
	`ngx_ýy¡º
(
p
, (
u_ch¬
 *è
NGX_ERROR_LOG_PATH
, 
Æ’
 + 1);

343 
p
 = 
Çme
;

347 
ngx_log_fže
.
fd
 = 
	`ngx_Ý’_fže
(
Çme
, 
NGX_FILE_APPEND
,

348 
NGX_FILE_CREATE_OR_OPEN
,

349 
NGX_FILE_DEFAULT_ACCESS
);

351 ià(
ngx_log_fže
.
fd
 =ð
NGX_INVALID_FILE
) {

352 
	`ngx_log_¡d”r
(
ngx_”ºo
,

354 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
Çme
);

355 #ià(
NGX_WIN32
)

356 
	`ngx_ev’t_log
(
ngx_”ºo
,

358 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
Çme
);

361 
ngx_log_fže
.
fd
 = 
ngx_¡d”r
;

364 ià(
p
) {

365 
	`ngx_ä“
(
p
);

368  &
ngx_log
;

369 
	}
}

372 
ngx_št_t


373 
	$ngx_log_Ý’_deçuÉ
(
ngx_cyþe_t
 *
cyþe
)

375 
ngx_log_t
 *
log
;

376 
ngx_¡r_t
 
”rÜ_log
 = 
	`ngx_¡ršg
(
NGX_ERROR_LOG_PATH
);

378 ià(
	`ngx_log_g‘_fže_log
(&
cyþe
->
Ãw_log
è!ð
NULL
) {

379  
NGX_OK
;

382 ià(
cyþe
->
Ãw_log
.
log_Ëv–
 != 0) {

385 
log
 = 
	`ngx_pÿÎoc
(
cyþe
->
poÞ
, (
ngx_log_t
));

386 ià(
log
 =ð
NULL
) {

387  
NGX_ERROR
;

392 
log
 = &
cyþe
->
Ãw_log
;

395 
log
->
log_Ëv–
 = 
NGX_LOG_ERR
;

397 
log
->
fže
 = 
	`ngx_cÚf_Ý’_fže
(
cyþe
, &
”rÜ_log
);

398 ià(
log
->
fže
 =ð
NULL
) {

399  
NGX_ERROR
;

402 ià(
log
 !ð&
cyþe
->
Ãw_log
) {

403 
	`ngx_log_š£¹
(&
cyþe
->
Ãw_log
, 
log
);

406  
NGX_OK
;

407 
	}
}

410 
ngx_št_t


411 
	$ngx_log_»dœeù_¡d”r
(
ngx_cyþe_t
 *
cyþe
)

413 
ngx_fd_t
 
fd
;

415 ià(
cyþe
->
log_u£_¡d”r
) {

416  
NGX_OK
;

420 
fd
 = 
	`ngx_log_g‘_fže_log
(
cyþe
->
log
)->
fže
->fd;

422 ià(
fd
 !ð
ngx_¡d”r
) {

423 ià(
	`ngx_£t_¡d”r
(
fd
è=ð
NGX_FILE_ERROR
) {

424 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

425 
ngx_£t_¡d”r_n
 " failed");

427  
NGX_ERROR
;

431  
NGX_OK
;

432 
	}
}

435 
ngx_log_t
 *

436 
	$ngx_log_g‘_fže_log
(
ngx_log_t
 *
h—d
)

438 
ngx_log_t
 *
log
;

440 
log
 = 
h—d
;†og;†og =†og->
Ãxt
) {

441 ià(
log
->
fže
 !ð
NULL
) {

442  
log
;

446  
NULL
;

447 
	}
}

451 
	$ngx_log_£t_Ëv–s
(
ngx_cÚf_t
 *
cf
, 
ngx_log_t
 *
log
)

453 
ngx_ušt_t
 
i
, 
n
, 
d
, 
found
;

454 
ngx_¡r_t
 *
v®ue
;

456 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

457 
log
->
log_Ëv–
 = 
NGX_LOG_ERR
;

458  
NGX_CONF_OK
;

461 
v®ue
 = 
cf
->
¬gs
->
–ts
;

463 
i
 = 2; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

464 
found
 = 0;

466 
n
 = 1;‚ <ð
NGX_LOG_DEBUG
;‚++) {

467 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, 
”r_Ëv–s
[
n
].data) == 0) {

469 ià(
log
->
log_Ëv–
 != 0) {

470 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

472 &
v®ue
[
i
]);

473  
NGX_CONF_ERROR
;

476 
log
->
log_Ëv–
 = 
n
;

477 
found
 = 1;

482 
n
 = 0, 
d
 = 
NGX_LOG_DEBUG_FIRST
; d <ð
NGX_LOG_DEBUG_LAST
; d <<= 1) {

483 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, 
debug_Ëv–s
[
n
++]) == 0) {

484 ià(
log
->
log_Ëv–
 & ~
NGX_LOG_DEBUG_ALL
) {

485 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

487 &
v®ue
[
i
]);

488  
NGX_CONF_ERROR
;

491 
log
->
log_Ëv–
 |ð
d
;

492 
found
 = 1;

498 ià(!
found
) {

499 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

500 "šv®id†og†ev– \"%V\"", &
v®ue
[
i
]);

501  
NGX_CONF_ERROR
;

505 ià(
log
->
log_Ëv–
 =ð
NGX_LOG_DEBUG
) {

506 
log
->
log_Ëv–
 = 
NGX_LOG_DEBUG_ALL
;

509  
NGX_CONF_OK
;

510 
	}
}

514 
	$ngx_”rÜ_log
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

516 
ngx_log_t
 *
dummy
;

518 
dummy
 = &
cf
->
cyþe
->
Ãw_log
;

520  
	`ngx_log_£t_log
(
cf
, &
dummy
);

521 
	}
}

525 
	$ngx_log_£t_log
(
ngx_cÚf_t
 *
cf
, 
ngx_log_t
 **
h—d
)

527 
ngx_log_t
 *
Ãw_log
;

528 
ngx_¡r_t
 *
v®ue
, 
Çme
;

529 
ngx_sy¦og_³”_t
 *
³”
;

531 ià(*
h—d
 !ð
NULL
 && (*h—d)->
log_Ëv–
 == 0) {

532 
Ãw_log
 = *
h—d
;

536 
Ãw_log
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_log_t
));

537 ià(
Ãw_log
 =ð
NULL
) {

538  
NGX_CONF_ERROR
;

541 ià(*
h—d
 =ð
NULL
) {

542 *
h—d
 = 
Ãw_log
;

546 
v®ue
 = 
cf
->
¬gs
->
–ts
;

548 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "stderr") == 0) {

549 
	`ngx_¡r_nuÎ
(&
Çme
);

550 
cf
->
cyþe
->
log_u£_¡d”r
 = 1;

552 
Ãw_log
->
fže
 = 
	`ngx_cÚf_Ý’_fže
(
cf
->
cyþe
, &
Çme
);

553 ià(
Ãw_log
->
fže
 =ð
NULL
) {

554  
NGX_CONF_ERROR
;

558 } ià(
	`ngx_¡ºcmp
(
v®ue
[1].
d©a
, "syslog:", 7) == 0) {

559 
³”
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_sy¦og_³”_t
));

560 ià(
³”
 =ð
NULL
) {

561  
NGX_CONF_ERROR
;

564 ià(
	`ngx_sy¦og_´oûss_cÚf
(
cf
, 
³”
è!ð
NGX_CONF_OK
) {

565  
NGX_CONF_ERROR
;

568 
Ãw_log
->
wr™”
 = 
ngx_sy¦og_wr™”
;

569 
Ãw_log
->
wd©a
 = 
³”
;

572 
Ãw_log
->
fže
 = 
	`ngx_cÚf_Ý’_fže
(
cf
->
cyþe
, &
v®ue
[1]);

573 ià(
Ãw_log
->
fže
 =ð
NULL
) {

574  
NGX_CONF_ERROR
;

578 ià(
	`ngx_log_£t_Ëv–s
(
cf
, 
Ãw_log
è!ð
NGX_CONF_OK
) {

579  
NGX_CONF_ERROR
;

582 ià(*
h—d
 !ð
Ãw_log
) {

583 
	`ngx_log_š£¹
(*
h—d
, 
Ãw_log
);

586  
NGX_CONF_OK
;

587 
	}
}

591 
	$ngx_log_š£¹
(
ngx_log_t
 *
log
,‚gx_log_ˆ*
Ãw_log
)

593 
ngx_log_t
 
tmp
;

595 ià(
Ãw_log
->
log_Ëv–
 > 
log
->log_level) {

602 
tmp
 = *
log
;

603 *
log
 = *
Ãw_log
;

604 *
Ãw_log
 = 
tmp
;

606 
log
->
Ãxt
 = 
Ãw_log
;

610 
log
->
Ãxt
) {

611 ià(
Ãw_log
->
log_Ëv–
 > 
log
->
Ãxt
->log_level) {

612 
Ãw_log
->
Ãxt
 = 
log
->next;

613 
log
->
Ãxt
 = 
Ãw_log
;

617 
log
 =†og->
Ãxt
;

620 
log
->
Ãxt
 = 
Ãw_log
;

621 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_md5.c

11 
	~<ngx_cÚfig.h
>

12 
	~<ngx_cÜe.h
>

13 
	~<ngx_md5.h
>

16 #ià!(
NGX_HAVE_MD5
)

18 cÚ¡ 
u_ch¬
 *
ngx_md5_body
(
ngx_md5_t
 *
ùx
, cÚ¡ u_ch¬ *
d©a
,

19 
size_t
 
size
);

23 
	$ngx_md5_š™
(
ngx_md5_t
 *
ùx
)

25 
ùx
->
a
 = 0x67452301;

26 
ùx
->
b
 = 0xefcdab89;

27 
ùx
->
c
 = 0x98badcfe;

28 
ùx
->
d
 = 0x10325476;

30 
ùx
->
by‹s
 = 0;

31 
	}
}

35 
	$ngx_md5_upd©e
(
ngx_md5_t
 *
ùx
, cÚ¡ *
d©a
, 
size_t
 
size
)

37 
size_t
 
u£d
, 
ä“
;

39 
u£d
 = (
size_t
è(
ùx
->
by‹s
 & 0x3f);

40 
ùx
->
by‹s
 +ð
size
;

42 ià(
u£d
) {

43 
ä“
 = 64 - 
u£d
;

45 ià(
size
 < 
ä“
) {

46 
	`ngx_memýy
(&
ùx
->
bufãr
[
u£d
], 
d©a
, 
size
);

50 
	`ngx_memýy
(&
ùx
->
bufãr
[
u£d
], 
d©a
, 
ä“
);

51 
d©a
 = (
u_ch¬
 *èd©¨+ 
ä“
;

52 
size
 -ð
ä“
;

53 (è
	`ngx_md5_body
(
ùx
, ctx->
bufãr
, 64);

56 ià(
size
 >= 64) {

57 
d©a
 = 
	`ngx_md5_body
(
ùx
, d©a, 
size
 & ~(
size_t
) 0x3f);

58 
size
 &= 0x3f;

61 
	`ngx_memýy
(
ùx
->
bufãr
, 
d©a
, 
size
);

62 
	}
}

66 
	$ngx_md5_fš®
(
u_ch¬
 
»suÉ
[16], 
ngx_md5_t
 *
ùx
)

68 
size_t
 
u£d
, 
ä“
;

70 
u£d
 = (
size_t
è(
ùx
->
by‹s
 & 0x3f);

72 
ùx
->
bufãr
[
u£d
++] = 0x80;

74 
ä“
 = 64 - 
u£d
;

76 ià(
ä“
 < 8) {

77 
	`ngx_memz”o
(&
ùx
->
bufãr
[
u£d
], 
ä“
);

78 (è
	`ngx_md5_body
(
ùx
, ctx->
bufãr
, 64);

79 
u£d
 = 0;

80 
ä“
 = 64;

83 
	`ngx_memz”o
(&
ùx
->
bufãr
[
u£d
], 
ä“
 - 8);

85 
ùx
->
by‹s
 <<= 3;

86 
ùx
->
bufãr
[56] = (
u_ch¬
èùx->
by‹s
;

87 
ùx
->
bufãr
[57] = (
u_ch¬
è(ùx->
by‹s
 >> 8);

88 
ùx
->
bufãr
[58] = (
u_ch¬
è(ùx->
by‹s
 >> 16);

89 
ùx
->
bufãr
[59] = (
u_ch¬
è(ùx->
by‹s
 >> 24);

90 
ùx
->
bufãr
[60] = (
u_ch¬
è(ùx->
by‹s
 >> 32);

91 
ùx
->
bufãr
[61] = (
u_ch¬
è(ùx->
by‹s
 >> 40);

92 
ùx
->
bufãr
[62] = (
u_ch¬
è(ùx->
by‹s
 >> 48);

93 
ùx
->
bufãr
[63] = (
u_ch¬
è(ùx->
by‹s
 >> 56);

95 (è
	`ngx_md5_body
(
ùx
, ctx->
bufãr
, 64);

97 
»suÉ
[0] = (
u_ch¬
è
ùx
->
a
;

98 
»suÉ
[1] = (
u_ch¬
è(
ùx
->
a
 >> 8);

99 
»suÉ
[2] = (
u_ch¬
è(
ùx
->
a
 >> 16);

100 
»suÉ
[3] = (
u_ch¬
è(
ùx
->
a
 >> 24);

101 
»suÉ
[4] = (
u_ch¬
è
ùx
->
b
;

102 
»suÉ
[5] = (
u_ch¬
è(
ùx
->
b
 >> 8);

103 
»suÉ
[6] = (
u_ch¬
è(
ùx
->
b
 >> 16);

104 
»suÉ
[7] = (
u_ch¬
è(
ùx
->
b
 >> 24);

105 
»suÉ
[8] = (
u_ch¬
è
ùx
->
c
;

106 
»suÉ
[9] = (
u_ch¬
è(
ùx
->
c
 >> 8);

107 
»suÉ
[10] = (
u_ch¬
è(
ùx
->
c
 >> 16);

108 
»suÉ
[11] = (
u_ch¬
è(
ùx
->
c
 >> 24);

109 
»suÉ
[12] = (
u_ch¬
è
ùx
->
d
;

110 
»suÉ
[13] = (
u_ch¬
è(
ùx
->
d
 >> 8);

111 
»suÉ
[14] = (
u_ch¬
è(
ùx
->
d
 >> 16);

112 
»suÉ
[15] = (
u_ch¬
è(
ùx
->
d
 >> 24);

114 
	`ngx_memz”o
(
ùx
, (*ctx));

115 
	}
}

126 
	#F
(
x
, 
y
, 
z
è((zè^ ((xè& ((yè^ (z))))

	)

127 
	#G
(
x
, 
y
, 
z
è((yè^ ((zè& ((xè^ (y))))

	)

128 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

129 
	#I
(
x
, 
y
, 
z
è((yè^ ((xè| ~(z)))

	)

135 
	#STEP
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
t
, 
s
) \

136 (
a
è+ð
	`f
((
b
), (
c
), (
d
)è+ (
x
è+ (
t
); \

137 (
a
èð((×è<< (
s
)) | (((a) & 0xffffffff) >> (32 - (s)))); \

138 (
a
è+ð(
b
)

	)

149 #ià(
NGX_HAVE_LITTLE_ENDIAN
 && 
NGX_HAVE_NONALIGNED
)

151 
	#SET
(
n
è(*(
ušt32_t
 *è&
p
[À* 4])

	)

152 
	#GET
(
n
è(*(
ušt32_t
 *è&
p
[À* 4])

	)

156 
	#SET
(
n
) \

157 (
block
[
n
] = \

158 (
ušt32_t
è
p
[
n
 * 4] | \

159 ((
ušt32_t
è
p
[
n
 * 4 + 1] << 8) | \

160 ((
ušt32_t
è
p
[
n
 * 4 + 2] << 16) | \

161 ((
ušt32_t
è
p
[
n
 * 4 + 3] << 24))

	)

163 
	#GET
(
n
è
block
[n]

	)

173 cÚ¡ 
u_ch¬
 *

174 
	$ngx_md5_body
(
ngx_md5_t
 *
ùx
, cÚ¡ 
u_ch¬
 *
d©a
, 
size_t
 
size
)

176 
ušt32_t
 
a
, 
b
, 
c
, 
d
;

177 
ušt32_t
 
§ved_a
, 
§ved_b
, 
§ved_c
, 
§ved_d
;

178 cÚ¡ 
u_ch¬
 *
p
;

179 #ià!(
NGX_HAVE_LITTLE_ENDIAN
 && 
NGX_HAVE_NONALIGNED
)

180 
ušt32_t
 
block
[16];

183 
p
 = 
d©a
;

185 
a
 = 
ùx
->a;

186 
b
 = 
ùx
->b;

187 
c
 = 
ùx
->c;

188 
d
 = 
ùx
->d;

191 
§ved_a
 = 
a
;

192 
§ved_b
 = 
b
;

193 
§ved_c
 = 
c
;

194 
§ved_d
 = 
d
;

198 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(0), 0xd76aa478, 7);

199 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(1), 0xe8c7b756, 12);

200 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(2), 0x242070db, 17);

201 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(3), 0xc1bdceee, 22);

202 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(4), 0xf57c0faf, 7);

203 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(5), 0x4787c62a, 12);

204 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(6), 0xa8304613, 17);

205 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(7), 0xfd469501, 22);

206 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(8), 0x698098d8, 7);

207 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(9), 0x8b44f7af, 12);

208 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(10), 0xffff5bb1, 17);

209 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(11), 0x895cd7be, 22);

210 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(12), 0x6b901122, 7);

211 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(13), 0xfd987193, 12);

212 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(14), 0xa679438e, 17);

213 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(15), 0x49b40821, 22);

217 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xf61e2562, 5);

218 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(6), 0xc040b340, 9);

219 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x265e5a51, 14);

220 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(0), 0xe9b6c7aa, 20);

221 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xd62f105d, 5);

222 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(10), 0x02441453, 9);

223 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0xd8a1e681, 14);

224 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(4), 0xe7d3fbc8, 20);

225 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0x21e1cde6, 5);

226 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(14), 0xc33707d6, 9);

227 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xf4d50d87, 14);

228 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(8), 0x455a14ed, 20);

229 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0xa9e3e905, 5);

230 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(2), 0xfcefa3f8, 9);

231 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0x676f02d9, 14);

232 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(12), 0x8d2a4c8a, 20);

236 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xfffa3942, 4);

237 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(8), 0x8771f681, 11);

238 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x6d9d6122, 16);

239 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(14), 0xfde5380c, 23);

240 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xa4beea44, 4);

241 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(4), 0x4bdecfa9, 11);

242 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0xf6bb4b60, 16);

243 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(10), 0xbebfbc70, 23);

244 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0x289b7ec6, 4);

245 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(0), 0xeaa127fa, 11);

246 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xd4ef3085, 16);

247 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(6), 0x04881d05, 23);

248 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0xd9d4d039, 4);

249 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(12), 0xe6db99e5, 11);

250 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0x1fa27cf8, 16);

251 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(2), 0xc4ac5665, 23);

255 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(0), 0xf4292244, 6);

256 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(7), 0x432aff97, 10);

257 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(14), 0xab9423a7, 15);

258 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(5), 0xfc93a039, 21);

259 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(12), 0x655b59c3, 6);

260 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(3), 0x8f0ccc92, 10);

261 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(10), 0xffeff47d, 15);

262 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(1), 0x85845dd1, 21);

263 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(8), 0x6fa87e4f, 6);

264 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(15), 0xfe2ce6e0, 10);

265 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(6), 0xa3014314, 15);

266 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(13), 0x4e0811a1, 21);

267 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(4), 0xf7537e82, 6);

268 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(11), 0xbd3af235, 10);

269 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(2), 0x2ad7d2bb, 15);

270 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(9), 0xeb86d391, 21);

272 
a
 +ð
§ved_a
;

273 
b
 +ð
§ved_b
;

274 
c
 +ð
§ved_c
;

275 
d
 +ð
§ved_d
;

277 
p
 += 64;

279 } 
size
 -= 64);

281 
ùx
->
a
 =‡;

282 
ùx
->
b
 = b;

283 
ùx
->
c
 = c;

284 
ùx
->
d
 = d;

286  
p
;

287 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_murmurhash.c

7 
	~<ngx_cÚfig.h
>

8 
	~<ngx_cÜe.h
>

11 
ušt32_t


12 
	$ngx_murmur_hash2
(
u_ch¬
 *
d©a
, 
size_t
 
Ën
)

14 
ušt32_t
 
h
, 
k
;

16 
h
 = 0 ^ 
Ën
;

18 
Ën
 >= 4) {

19 
k
 = 
d©a
[0];

20 
k
 |ð
d©a
[1] << 8;

21 
k
 |ð
d©a
[2] << 16;

22 
k
 |ð
d©a
[3] << 24;

24 
k
 *= 0x5bd1e995;

25 
k
 ^= k >> 24;

26 
k
 *= 0x5bd1e995;

28 
h
 *= 0x5bd1e995;

29 
h
 ^ð
k
;

31 
d©a
 += 4;

32 
Ën
 -= 4;

35 
Ën
) {

37 
h
 ^ð
d©a
[2] << 16;

39 
h
 ^ð
d©a
[1] << 8;

41 
h
 ^ð
d©a
[0];

42 
h
 *= 0x5bd1e995;

45 
h
 ^= h >> 13;

46 
h
 *= 0x5bd1e995;

47 
h
 ^= h >> 15;

49  
h
;

50 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_open_file_cache.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

21 
	#NGX_MIN_READ_AHEAD
 (128 * 1024)

	)

24 
ngx_Ý’_fže_ÿche_þ—nup
(*
d©a
);

25 #ià(
NGX_HAVE_OPENAT
)

26 
ngx_fd_t
 
ngx_Ý’©_fže_owÃr
Ògx_fd_ˆ
©_fd
, cÚ¡ 
u_ch¬
 *
Çme
,

27 
ngx_št_t
 
mode
,‚gx_št_ˆ
ü—‹
,‚gx_št_ˆ
acûss
, 
ngx_log_t
 *
log
);

28 #ià(
NGX_HAVE_O_PATH
)

29 
ngx_št_t
 
ngx_fže_o_·th_šfo
(
ngx_fd_t
 
fd
, 
ngx_fže_šfo_t
 *
fi
,

30 
ngx_log_t
 *
log
);

33 
ngx_fd_t
 
ngx_Ý’_fže_w¿µ”
(
ngx_¡r_t
 *
Çme
,

34 
ngx_Ý’_fže_šfo_t
 *
of
, 
ngx_št_t
 
mode
,‚gx_št_ˆ
ü—‹
,

35 
ngx_št_t
 
acûss
, 
ngx_log_t
 *
log
);

36 
ngx_št_t
 
ngx_fže_šfo_w¿µ”
(
ngx_¡r_t
 *
Çme
,

37 
ngx_Ý’_fže_šfo_t
 *
of
, 
ngx_fže_šfo_t
 *
fi
, 
ngx_log_t
 *
log
);

38 
ngx_št_t
 
ngx_Ý’_ªd_¡©_fže
(
ngx_¡r_t
 *
Çme
,

39 
ngx_Ý’_fže_šfo_t
 *
of
, 
ngx_log_t
 *
log
);

40 
ngx_Ý’_fže_add_ev’t
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
,

41 
ngx_ÿched_Ý’_fže_t
 *
fže
, 
ngx_Ý’_fže_šfo_t
 *
of
, 
ngx_log_t
 *
log
);

42 
ngx_Ý’_fže_þ—nup
(*
d©a
);

43 
ngx_þo£_ÿched_fže
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
,

44 
ngx_ÿched_Ý’_fže_t
 *
fže
, 
ngx_ušt_t
 
mš_u£s
, 
ngx_log_t
 *
log
);

45 
ngx_Ý’_fže_d–_ev’t
(
ngx_ÿched_Ý’_fže_t
 *
fže
);

46 
ngx_expœe_Þd_ÿched_fžes
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
,

47 
ngx_ušt_t
 
n
, 
ngx_log_t
 *
log
);

48 
ngx_Ý’_fže_ÿche_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

49 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
);

50 
ngx_ÿched_Ý’_fže_t
 *

51 
ngx_Ý’_fže_lookup
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
, 
ngx_¡r_t
 *
Çme
,

52 
ušt32_t
 
hash
);

53 
ngx_Ý’_fže_ÿche_»move
(
ngx_ev’t_t
 *
ev
);

56 
ngx_Ý’_fže_ÿche_t
 *

57 
	$ngx_Ý’_fže_ÿche_š™
(
ngx_poÞ_t
 *
poÞ
, 
ngx_ušt_t
 
max
, 
time_t
 
šaùive
)

59 
ngx_poÞ_þ—nup_t
 *
þn
;

60 
ngx_Ý’_fže_ÿche_t
 *
ÿche
;

62 
ÿche
 = 
	`ngx_·Îoc
(
poÞ
, (
ngx_Ý’_fže_ÿche_t
));

63 ià(
ÿche
 =ð
NULL
) {

64  
NULL
;

67 
	`ngx_rbŒ“_š™
(&
ÿche
->
rbŒ“
, &ÿche->
£Áš–
,

68 
ngx_Ý’_fže_ÿche_rbŒ“_š£¹_v®ue
);

70 
	`ngx_queue_š™
(&
ÿche
->
expœe_queue
);

72 
ÿche
->
cu¼’t
 = 0;

73 
ÿche
->
max
 = max;

74 
ÿche
->
šaùive
 = inactive;

76 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
poÞ
, 0);

77 ià(
þn
 =ð
NULL
) {

78  
NULL
;

81 
þn
->
hªdËr
 = 
ngx_Ý’_fže_ÿche_þ—nup
;

82 
þn
->
d©a
 = 
ÿche
;

84  
ÿche
;

85 
	}
}

89 
	$ngx_Ý’_fže_ÿche_þ—nup
(*
d©a
)

91 
ngx_Ý’_fže_ÿche_t
 *
ÿche
 = 
d©a
;

93 
ngx_queue_t
 *
q
;

94 
ngx_ÿched_Ý’_fže_t
 *
fže
;

96 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0,

101 ià(
	`ngx_queue_em±y
(&
ÿche
->
expœe_queue
)) {

105 
q
 = 
	`ngx_queue_Ï¡
(&
ÿche
->
expœe_queue
);

107 
fže
 = 
	`ngx_queue_d©a
(
q
, 
ngx_ÿched_Ý’_fže_t
, 
queue
);

109 
	`ngx_queue_»move
(
q
);

111 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
rbŒ“
, &
fže
->
node
);

113 
ÿche
->
cu¼’t
--;

115 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0,

116 "d–‘ÿched o³Àfže: %s", 
fže
->
Çme
);

118 ià(!
fže
->
”r
 && !fže->
is_dœ
) {

119 
fže
->
þo£
 = 1;

120 
fže
->
couÁ
 = 0;

121 
	`ngx_þo£_ÿched_fže
(
ÿche
, 
fže
, 0, 
ngx_cyþe
->
log
);

124 
	`ngx_ä“
(
fže
->
Çme
);

125 
	`ngx_ä“
(
fže
);

129 ià(
ÿche
->
cu¼’t
) {

130 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

132 
ÿche
->
cu¼’t
);

135 ià(
ÿche
->
rbŒ“
.
roÙ
 !ðÿche->rbŒ“.
£Áš–
) {

136 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

140 
	}
}

143 
ngx_št_t


144 
	$ngx_Ý’_ÿched_fže
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
, 
ngx_¡r_t
 *
Çme
,

145 
ngx_Ý’_fže_šfo_t
 *
of
, 
ngx_poÞ_t
 *
poÞ
)

147 
time_t
 
now
;

148 
ušt32_t
 
hash
;

149 
ngx_št_t
 
rc
;

150 
ngx_fže_šfo_t
 
fi
;

151 
ngx_poÞ_þ—nup_t
 *
þn
;

152 
ngx_ÿched_Ý’_fže_t
 *
fže
;

153 
ngx_poÞ_þ—nup_fže_t
 *
þnf
;

154 
ngx_Ý’_fže_ÿche_þ—nup_t
 *
ofþn
;

156 
of
->
fd
 = 
NGX_INVALID_FILE
;

157 
of
->
”r
 = 0;

159 ià(
ÿche
 =ð
NULL
) {

161 ià(
of
->
‹¡_Úly
) {

163 ià(
	`ngx_fže_šfo_w¿µ”
(
Çme
, 
of
, &
fi
, 
poÞ
->
log
)

164 =ð
NGX_FILE_ERROR
)

166  
NGX_ERROR
;

169 
of
->
uniq
 = 
	`ngx_fže_uniq
(&
fi
);

170 
of
->
mtime
 = 
	`ngx_fže_mtime
(&
fi
);

171 
of
->
size
 = 
	`ngx_fže_size
(&
fi
);

172 
of
->
fs_size
 = 
	`ngx_fže_fs_size
(&
fi
);

173 
of
->
is_dœ
 = 
	`ngx_is_dœ
(&
fi
);

174 
of
->
is_fže
 = 
	`ngx_is_fže
(&
fi
);

175 
of
->
is_lšk
 = 
	`ngx_is_lšk
(&
fi
);

176 
of
->
is_exec
 = 
	`ngx_is_exec
(&
fi
);

178  
NGX_OK
;

181 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
poÞ
, (
ngx_poÞ_þ—nup_fže_t
));

182 ià(
þn
 =ð
NULL
) {

183  
NGX_ERROR
;

186 
rc
 = 
	`ngx_Ý’_ªd_¡©_fže
(
Çme
, 
of
, 
poÞ
->
log
);

188 ià(
rc
 =ð
NGX_OK
 && !
of
->
is_dœ
) {

189 
þn
->
hªdËr
 = 
ngx_poÞ_þ—nup_fže
;

190 
þnf
 = 
þn
->
d©a
;

192 
þnf
->
fd
 = 
of
->fd;

193 
þnf
->
Çme
 =‚ame->
d©a
;

194 
þnf
->
log
 = 
poÞ
->log;

197  
rc
;

200 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
poÞ
, (
ngx_Ý’_fže_ÿche_þ—nup_t
));

201 ià(
þn
 =ð
NULL
) {

202  
NGX_ERROR
;

205 
now
 = 
	`ngx_time
();

207 
hash
 = 
	`ngx_üc32_lÚg
(
Çme
->
d©a
,‚ame->
Ën
);

209 
fže
 = 
	`ngx_Ý’_fže_lookup
(
ÿche
, 
Çme
, 
hash
);

211 ià(
fže
) {

213 
fže
->
u£s
++;

215 
	`ngx_queue_»move
(&
fže
->
queue
);

217 ià(
fže
->
fd
 =ð
NGX_INVALID_FILE
 && fže->
”r
 =ð0 && !fže->
is_dœ
) {

221 
rc
 = 
	`ngx_Ý’_ªd_¡©_fže
(
Çme
, 
of
, 
poÞ
->
log
);

223 ià(
rc
 !ð
NGX_OK
 && (
of
->
”r
 =ð0 || !of->
”rÜs
)) {

224 
çžed
;

227 
add_ev’t
;

230 ià(
fže
->
u£_ev’t


231 || (
fže
->
ev’t
 =ð
NULL


232 && (
of
->
uniq
 =ð0 || of->uniq =ð
fže
->uniq)

233 && 
now
 - 
fže
->
ü—‹d
 < 
of
->
v®id


234 #ià(
NGX_HAVE_OPENAT
)

235 && 
of
->
di§bË_symlšks
 =ð
fže
->disable_symlinks

236 && 
of
->
di§bË_symlšks_äom
 =ð
fže
->disable_symlinks_from

240 ià(
fže
->
”r
 == 0) {

242 
of
->
fd
 = 
fže
->fd;

243 
of
->
uniq
 = 
fže
->uniq;

244 
of
->
mtime
 = 
fže
->mtime;

245 
of
->
size
 = 
fže
->size;

247 
of
->
is_dœ
 = 
fže
->is_dir;

248 
of
->
is_fže
 = 
fže
->is_file;

249 
of
->
is_lšk
 = 
fže
->is_link;

250 
of
->
is_exec
 = 
fže
->is_exec;

251 
of
->
is_dœeùio
 = 
fže
->is_directio;

253 ià(!
fže
->
is_dœ
) {

254 
fže
->
couÁ
++;

255 
	`ngx_Ý’_fže_add_ev’t
(
ÿche
, 
fže
, 
of
, 
poÞ
->
log
);

259 
of
->
”r
 = 
fže
->err;

260 #ià(
NGX_HAVE_OPENAT
)

261 
of
->
çžed
 = 
fže
->
di§bË_symlšks
 ? 
ngx_Ý’©_fže_n


262 : 
ngx_Ý’_fže_n
;

264 
of
->
çžed
 = 
ngx_Ý’_fže_n
;

268 
found
;

271 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_CORE
, 
poÞ
->
log
, 0,

273 
fže
->
Çme
, fže->
fd
, fže->
couÁ
, fže->
”r
);

275 ià(
fže
->
is_dœ
) {

283 
of
->
‹¡_dœ
 = 1;

286 
of
->
fd
 = 
fže
->fd;

287 
of
->
uniq
 = 
fže
->uniq;

289 
rc
 = 
	`ngx_Ý’_ªd_¡©_fže
(
Çme
, 
of
, 
poÞ
->
log
);

291 ià(
rc
 !ð
NGX_OK
 && (
of
->
”r
 =ð0 || !of->
”rÜs
)) {

292 
çžed
;

295 ià(
of
->
is_dœ
) {

297 ià(
fže
->
is_dœ
 || fže->
”r
) {

298 
upd©e
;

303 } ià(
of
->
”r
 == 0) {

305 ià(
fže
->
is_dœ
 || fže->
”r
) {

306 
add_ev’t
;

309 ià(
of
->
uniq
 =ð
fže
->uniq) {

311 ià(
fže
->
ev’t
) {

312 
fže
->
u£_ev’t
 = 1;

315 
of
->
is_dœeùio
 = 
fže
->is_directio;

317 
upd©e
;

324 ià(
fže
->
”r
 || fže->
is_dœ
) {

325 
upd©e
;

331 ià(
fže
->
couÁ
 == 0) {

333 
	`ngx_Ý’_fže_d–_ev’t
(
fže
);

335 ià(
	`ngx_þo£_fže
(
fže
->
fd
è=ð
NGX_FILE_ERROR
) {

336 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
poÞ
->
log
, 
ngx_”ºo
,

337 
ngx_þo£_fže_n
 " \"%V\" fažed", 
Çme
);

340 
add_ev’t
;

343 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
rbŒ“
, &
fže
->
node
);

345 
ÿche
->
cu¼’t
--;

347 
fže
->
þo£
 = 1;

349 
ü—‹
;

354 
rc
 = 
	`ngx_Ý’_ªd_¡©_fže
(
Çme
, 
of
, 
poÞ
->
log
);

356 ià(
rc
 !ð
NGX_OK
 && (
of
->
”r
 =ð0 || !of->
”rÜs
)) {

357 
çžed
;

360 
ü—‹
:

362 ià(
ÿche
->
cu¼’t
 >ðÿche->
max
) {

363 
	`ngx_expœe_Þd_ÿched_fžes
(
ÿche
, 0, 
poÞ
->
log
);

366 
fže
 = 
	`ngx_®loc
((
ngx_ÿched_Ý’_fže_t
), 
poÞ
->
log
);

368 ià(
fže
 =ð
NULL
) {

369 
çžed
;

372 
fže
->
Çme
 = 
	`ngx_®loc
Òame->
Ën
 + 1, 
poÞ
->
log
);

374 ià(
fže
->
Çme
 =ð
NULL
) {

375 
	`ngx_ä“
(
fže
);

376 
fže
 = 
NULL
;

377 
çžed
;

380 
	`ngx_ýy¡º
(
fže
->
Çme
,‚ame->
d©a
,‚ame->
Ën
 + 1);

382 
fže
->
node
.
key
 = 
hash
;

384 
	`ngx_rbŒ“_š£¹
(&
ÿche
->
rbŒ“
, &
fže
->
node
);

386 
ÿche
->
cu¼’t
++;

388 
fže
->
u£s
 = 1;

389 
fže
->
couÁ
 = 0;

390 
fže
->
u£_ev’t
 = 0;

391 
fže
->
ev’t
 = 
NULL
;

393 
add_ev’t
:

395 
	`ngx_Ý’_fže_add_ev’t
(
ÿche
, 
fže
, 
of
, 
poÞ
->
log
);

397 
upd©e
:

399 
fže
->
fd
 = 
of
->fd;

400 
fže
->
”r
 = 
of
->err;

401 #ià(
NGX_HAVE_OPENAT
)

402 
fže
->
di§bË_symlšks
 = 
of
->disable_symlinks;

403 
fže
->
di§bË_symlšks_äom
 = 
of
->disable_symlinks_from;

406 ià(
of
->
”r
 == 0) {

407 
fže
->
uniq
 = 
of
->uniq;

408 
fže
->
mtime
 = 
of
->mtime;

409 
fže
->
size
 = 
of
->size;

411 
fže
->
þo£
 = 0;

413 
fže
->
is_dœ
 = 
of
->is_dir;

414 
fže
->
is_fže
 = 
of
->is_file;

415 
fže
->
is_lšk
 = 
of
->is_link;

416 
fže
->
is_exec
 = 
of
->is_exec;

417 
fže
->
is_dœeùio
 = 
of
->is_directio;

419 ià(!
of
->
is_dœ
) {

420 
fže
->
couÁ
++;

424 
fže
->
ü—‹d
 = 
now
;

426 
found
:

428 
fže
->
acûs£d
 = 
now
;

430 
	`ngx_queue_š£¹_h—d
(&
ÿche
->
expœe_queue
, &
fže
->
queue
);

432 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_CORE
, 
poÞ
->
log
, 0,

434 
fže
->
Çme
, fže->
fd
, fže->
couÁ
, fže->
”r
, fže->
u£s
);

436 ià(
of
->
”r
 == 0) {

438 ià(!
of
->
is_dœ
) {

439 
þn
->
hªdËr
 = 
ngx_Ý’_fže_þ—nup
;

440 
ofþn
 = 
þn
->
d©a
;

442 
ofþn
->
ÿche
 = cache;

443 
ofþn
->
fže
 = file;

444 
ofþn
->
mš_u£s
 = 
of
->min_uses;

445 
ofþn
->
log
 = 
poÞ
->log;

448  
NGX_OK
;

451  
NGX_ERROR
;

453 
çžed
:

455 ià(
fže
) {

456 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
rbŒ“
, &
fže
->
node
);

458 
ÿche
->
cu¼’t
--;

460 ià(
fže
->
couÁ
 == 0) {

462 ià(
fže
->
fd
 !ð
NGX_INVALID_FILE
) {

463 ià(
	`ngx_þo£_fže
(
fže
->
fd
è=ð
NGX_FILE_ERROR
) {

464 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
poÞ
->
log
, 
ngx_”ºo
,

465 
ngx_þo£_fže_n
 " \"%s\" failed",

466 
fže
->
Çme
);

470 
	`ngx_ä“
(
fže
->
Çme
);

471 
	`ngx_ä“
(
fže
);

474 
fže
->
þo£
 = 1;

478 ià(
of
->
fd
 !ð
NGX_INVALID_FILE
) {

479 ià(
	`ngx_þo£_fže
(
of
->
fd
è=ð
NGX_FILE_ERROR
) {

480 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
poÞ
->
log
, 
ngx_”ºo
,

481 
ngx_þo£_fže_n
 " \"%V\" fažed", 
Çme
);

485  
NGX_ERROR
;

486 
	}
}

489 #ià(
NGX_HAVE_OPENAT
)

491 
ngx_fd_t


492 
	$ngx_Ý’©_fže_owÃr
(
ngx_fd_t
 
©_fd
, cÚ¡ 
u_ch¬
 *
Çme
,

493 
ngx_št_t
 
mode
,‚gx_št_ˆ
ü—‹
,‚gx_št_ˆ
acûss
, 
ngx_log_t
 *
log
)

495 
ngx_fd_t
 
fd
;

496 
ngx_”r_t
 
”r
;

497 
ngx_fže_šfo_t
 
fi
, 
©fi
;

511 
fd
 = 
	`ngx_Ý’©_fže
(
©_fd
, 
Çme
, 
mode
, 
ü—‹
, 
acûss
);

513 ià(
fd
 =ð
NGX_INVALID_FILE
) {

514  
NGX_INVALID_FILE
;

517 ià(
	`ngx_fže_©_šfo
(
©_fd
, 
Çme
, &
©fi
, 
AT_SYMLINK_NOFOLLOW
)

518 =ð
NGX_FILE_ERROR
)

520 
”r
 = 
ngx_”ºo
;

521 
çžed
;

524 #ià(
NGX_HAVE_O_PATH
)

525 ià(
	`ngx_fže_o_·th_šfo
(
fd
, &
fi
, 
log
è=ð
NGX_ERROR
) {

526 
”r
 = 
ngx_”ºo
;

527 
çžed
;

530 ià(
	`ngx_fd_šfo
(
fd
, &
fi
è=ð
NGX_FILE_ERROR
) {

531 
”r
 = 
ngx_”ºo
;

532 
çžed
;

536 ià(
fi
.
¡_uid
 !ð
©fi
.st_uid) {

537 
”r
 = 
NGX_ELOOP
;

538 
çžed
;

541  
fd
;

543 
çžed
:

545 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

546 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

547 
ngx_þo£_fže_n
 " \"%V\" fažed", 
Çme
);

550 
	`ngx_£t_”ºo
(
”r
);

552  
NGX_INVALID_FILE
;

553 
	}
}

556 #ià(
NGX_HAVE_O_PATH
)

558 
ngx_št_t


559 
	$ngx_fže_o_·th_šfo
(
ngx_fd_t
 
fd
, 
ngx_fže_šfo_t
 *
fi
, 
ngx_log_t
 *
log
)

561 
ngx_ušt_t
 
u£_f¡©
 = 1;

585 ià(
u£_f¡©
) {

586 ià(
	`ngx_fd_šfo
(
fd
, 
fi
è!ð
NGX_FILE_ERROR
) {

587  
NGX_OK
;

590 ià(
ngx_”ºo
 !ð
NGX_EBADF
) {

591  
NGX_ERROR
;

594 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0,

598 
u£_f¡©
 = 0;

601 ià(
	`ngx_fže_©_šfo
(
fd
, "", 
fi
, 
AT_EMPTY_PATH
è!ð
NGX_FILE_ERROR
) {

602  
NGX_OK
;

605  
NGX_ERROR
;

606 
	}
}

613 
ngx_fd_t


614 
	$ngx_Ý’_fže_w¿µ”
(
ngx_¡r_t
 *
Çme
, 
ngx_Ý’_fže_šfo_t
 *
of
,

615 
ngx_št_t
 
mode
,‚gx_št_ˆ
ü—‹
,‚gx_št_ˆ
acûss
, 
ngx_log_t
 *
log
)

617 
ngx_fd_t
 
fd
;

619 #ià!(
NGX_HAVE_OPENAT
)

621 
fd
 = 
	`ngx_Ý’_fže
(
Çme
->
d©a
, 
mode
, 
ü—‹
, 
acûss
);

623 ià(
fd
 =ð
NGX_INVALID_FILE
) {

624 
of
->
”r
 = 
ngx_”ºo
;

625 
of
->
çžed
 = 
ngx_Ý’_fže_n
;

626  
NGX_INVALID_FILE
;

629  
fd
;

633 
u_ch¬
 *
p
, *
ý
, *
’d
;

634 
ngx_fd_t
 
©_fd
;

635 
ngx_¡r_t
 
©_Çme
;

637 ià(
of
->
di§bË_symlšks
 =ð
NGX_DISABLE_SYMLINKS_OFF
) {

638 
fd
 = 
	`ngx_Ý’_fže
(
Çme
->
d©a
, 
mode
, 
ü—‹
, 
acûss
);

640 ià(
fd
 =ð
NGX_INVALID_FILE
) {

641 
of
->
”r
 = 
ngx_”ºo
;

642 
of
->
çžed
 = 
ngx_Ý’_fže_n
;

643  
NGX_INVALID_FILE
;

646  
fd
;

649 
p
 = 
Çme
->
d©a
;

650 
’d
 = 
p
 + 
Çme
->
Ën
;

652 
©_Çme
 = *
Çme
;

654 ià(
of
->
di§bË_symlšks_äom
) {

656 
ý
 = 
p
 + 
of
->
di§bË_symlšks_äom
;

658 *
ý
 = '\0';

660 
©_fd
 = 
	`ngx_Ý’_fže
(
p
, 
NGX_FILE_SEARCH
|
NGX_FILE_NONBLOCK
,

661 
NGX_FILE_OPEN
, 0);

663 *
ý
 = '/';

665 ià(
©_fd
 =ð
NGX_INVALID_FILE
) {

666 
of
->
”r
 = 
ngx_”ºo
;

667 
of
->
çžed
 = 
ngx_Ý’_fže_n
;

668  
NGX_INVALID_FILE
;

671 
©_Çme
.
Ën
 = 
of
->
di§bË_symlšks_äom
;

672 
p
 = 
ý
 + 1;

674 } ià(*
p
 == '/') {

676 
©_fd
 = 
	`ngx_Ý’_fže
("/",

677 
NGX_FILE_SEARCH
|
NGX_FILE_NONBLOCK
,

678 
NGX_FILE_OPEN
, 0);

680 ià(
©_fd
 =ð
NGX_INVALID_FILE
) {

681 
of
->
”r
 = 
ngx_”ºo
;

682 
of
->
çžed
 = 
ngx_Ý’©_fže_n
;

683  
NGX_INVALID_FILE
;

686 
©_Çme
.
Ën
 = 1;

687 
p
++;

690 
©_fd
 = 
NGX_AT_FDCWD
;

694 
ý
 = 
	`ngx_¡¾chr
(
p
, 
’d
, '/');

695 ià(
ý
 =ð
NULL
) {

699 ià(
ý
 =ð
p
) {

700 
p
++;

704 *
ý
 = '\0';

706 ià(
of
->
di§bË_symlšks
 =ð
NGX_DISABLE_SYMLINKS_NOTOWNER
) {

707 
fd
 = 
	`ngx_Ý’©_fže_owÃr
(
©_fd
, 
p
,

708 
NGX_FILE_SEARCH
|
NGX_FILE_NONBLOCK
,

709 
NGX_FILE_OPEN
, 0, 
log
);

712 
fd
 = 
	`ngx_Ý’©_fže
(
©_fd
, 
p
,

713 
NGX_FILE_SEARCH
|
NGX_FILE_NONBLOCK
|
NGX_FILE_NOFOLLOW
,

714 
NGX_FILE_OPEN
, 0);

717 *
ý
 = '/';

719 ià(
fd
 =ð
NGX_INVALID_FILE
) {

720 
of
->
”r
 = 
ngx_”ºo
;

721 
of
->
çžed
 = 
ngx_Ý’©_fže_n
;

722 
çžed
;

725 ià(
©_fd
 !ð
NGX_AT_FDCWD
 && 
	`ngx_þo£_fže
×t_fdè=ð
NGX_FILE_ERROR
) {

726 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

727 
ngx_þo£_fže_n
 " \"%V\" fažed", &
©_Çme
);

730 
p
 = 
ý
 + 1;

731 
©_fd
 = 
fd
;

732 
©_Çme
.
Ën
 = 
ý
 -‡t_Çme.
d©a
;

735 ià(
p
 =ð
’d
) {

748 
fd
 = 
	`ngx_Ý’©_fže
(
©_fd
, ".", 
mode
, 
ü—‹
, 
acûss
);

749 
dÚe
;

752 ià(
of
->
di§bË_symlšks
 =ð
NGX_DISABLE_SYMLINKS_NOTOWNER


753 && !(
ü—‹
 & (
NGX_FILE_CREATE_OR_OPEN
|
NGX_FILE_TRUNCATE
)))

755 
fd
 = 
	`ngx_Ý’©_fže_owÃr
(
©_fd
, 
p
, 
mode
, 
ü—‹
, 
acûss
, 
log
);

758 
fd
 = 
	`ngx_Ý’©_fže
(
©_fd
, 
p
, 
mode
|
NGX_FILE_NOFOLLOW
, 
ü—‹
, 
acûss
);

761 
dÚe
:

763 ià(
fd
 =ð
NGX_INVALID_FILE
) {

764 
of
->
”r
 = 
ngx_”ºo
;

765 
of
->
çžed
 = 
ngx_Ý’©_fže_n
;

768 
çžed
:

770 ià(
©_fd
 !ð
NGX_AT_FDCWD
 && 
	`ngx_þo£_fže
×t_fdè=ð
NGX_FILE_ERROR
) {

771 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

772 
ngx_þo£_fže_n
 " \"%V\" fažed", &
©_Çme
);

775  
fd
;

777 
	}
}

780 
ngx_št_t


781 
	$ngx_fže_šfo_w¿µ”
(
ngx_¡r_t
 *
Çme
, 
ngx_Ý’_fže_šfo_t
 *
of
,

782 
ngx_fže_šfo_t
 *
fi
, 
ngx_log_t
 *
log
)

784 
ngx_št_t
 
rc
;

786 #ià!(
NGX_HAVE_OPENAT
)

788 
rc
 = 
	`ngx_fže_šfo
(
Çme
->
d©a
, 
fi
);

790 ià(
rc
 =ð
NGX_FILE_ERROR
) {

791 
of
->
”r
 = 
ngx_”ºo
;

792 
of
->
çžed
 = 
ngx_fže_šfo_n
;

793  
NGX_FILE_ERROR
;

796  
rc
;

800 
ngx_fd_t
 
fd
;

802 ià(
of
->
di§bË_symlšks
 =ð
NGX_DISABLE_SYMLINKS_OFF
) {

804 
rc
 = 
	`ngx_fže_šfo
(
Çme
->
d©a
, 
fi
);

806 ià(
rc
 =ð
NGX_FILE_ERROR
) {

807 
of
->
”r
 = 
ngx_”ºo
;

808 
of
->
çžed
 = 
ngx_fže_šfo_n
;

809  
NGX_FILE_ERROR
;

812  
rc
;

815 
fd
 = 
	`ngx_Ý’_fže_w¿µ”
(
Çme
, 
of
, 
NGX_FILE_RDONLY
|
NGX_FILE_NONBLOCK
,

816 
NGX_FILE_OPEN
, 0, 
log
);

818 ià(
fd
 =ð
NGX_INVALID_FILE
) {

819  
NGX_FILE_ERROR
;

822 
rc
 = 
	`ngx_fd_šfo
(
fd
, 
fi
);

824 ià(
rc
 =ð
NGX_FILE_ERROR
) {

825 
of
->
”r
 = 
ngx_”ºo
;

826 
of
->
çžed
 = 
ngx_fd_šfo_n
;

829 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

830 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

831 
ngx_þo£_fže_n
 " \"%V\" fažed", 
Çme
);

834  
rc
;

836 
	}
}

839 
ngx_št_t


840 
	$ngx_Ý’_ªd_¡©_fže
(
ngx_¡r_t
 *
Çme
, 
ngx_Ý’_fže_šfo_t
 *
of
,

841 
ngx_log_t
 *
log
)

843 
ngx_fd_t
 
fd
;

844 
ngx_fže_šfo_t
 
fi
;

846 ià(
of
->
fd
 !ð
NGX_INVALID_FILE
) {

848 ià(
	`ngx_fže_šfo_w¿µ”
(
Çme
, 
of
, &
fi
, 
log
è=ð
NGX_FILE_ERROR
) {

849 
of
->
fd
 = 
NGX_INVALID_FILE
;

850  
NGX_ERROR
;

853 ià(
of
->
uniq
 =ð
	`ngx_fže_uniq
(&
fi
)) {

854 
dÚe
;

857 } ià(
of
->
‹¡_dœ
) {

859 ià(
	`ngx_fže_šfo_w¿µ”
(
Çme
, 
of
, &
fi
, 
log
è=ð
NGX_FILE_ERROR
) {

860 
of
->
fd
 = 
NGX_INVALID_FILE
;

861  
NGX_ERROR
;

864 ià(
	`ngx_is_dœ
(&
fi
)) {

865 
dÚe
;

869 ià(!
of
->
log
) {

876 
fd
 = 
	`ngx_Ý’_fže_w¿µ”
(
Çme
, 
of
, 
NGX_FILE_RDONLY
|
NGX_FILE_NONBLOCK
,

877 
NGX_FILE_OPEN
, 0, 
log
);

880 
fd
 = 
	`ngx_Ý’_fže_w¿µ”
(
Çme
, 
of
, 
NGX_FILE_APPEND
,

881 
NGX_FILE_CREATE_OR_OPEN
,

882 
NGX_FILE_DEFAULT_ACCESS
, 
log
);

885 ià(
fd
 =ð
NGX_INVALID_FILE
) {

886 
of
->
fd
 = 
NGX_INVALID_FILE
;

887  
NGX_ERROR
;

890 ià(
	`ngx_fd_šfo
(
fd
, &
fi
è=ð
NGX_FILE_ERROR
) {

891 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
log
, 
ngx_”ºo
,

892 
ngx_fd_šfo_n
 " \"%V\" fažed", 
Çme
);

894 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

895 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

896 
ngx_þo£_fže_n
 " \"%V\" fažed", 
Çme
);

899 
of
->
fd
 = 
NGX_INVALID_FILE
;

901  
NGX_ERROR
;

904 ià(
	`ngx_is_dœ
(&
fi
)) {

905 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

906 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

907 
ngx_þo£_fže_n
 " \"%V\" fažed", 
Çme
);

910 
of
->
fd
 = 
NGX_INVALID_FILE
;

913 
of
->
fd
 = fd;

915 ià(
of
->
»ad_ah—d
 && 
	`ngx_fže_size
(&
fi
è> 
NGX_MIN_READ_AHEAD
) {

916 ià(
	`ngx_»ad_ah—d
(
fd
, 
of
->
»ad_ah—d
è=ð
NGX_ERROR
) {

917 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

918 
ngx_»ad_ah—d_n
 " \"%V\" fažed", 
Çme
);

922 ià(
of
->
dœeùio
 <ð
	`ngx_fže_size
(&
fi
)) {

923 ià(
	`ngx_dœeùio_Ú
(
fd
è=ð
NGX_FILE_ERROR
) {

924 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

925 
ngx_dœeùio_Ú_n
 " \"%V\" fažed", 
Çme
);

928 
of
->
is_dœeùio
 = 1;

933 
dÚe
:

935 
of
->
uniq
 = 
	`ngx_fže_uniq
(&
fi
);

936 
of
->
mtime
 = 
	`ngx_fže_mtime
(&
fi
);

937 
of
->
size
 = 
	`ngx_fže_size
(&
fi
);

938 
of
->
fs_size
 = 
	`ngx_fže_fs_size
(&
fi
);

939 
of
->
is_dœ
 = 
	`ngx_is_dœ
(&
fi
);

940 
of
->
is_fže
 = 
	`ngx_is_fže
(&
fi
);

941 
of
->
is_lšk
 = 
	`ngx_is_lšk
(&
fi
);

942 
of
->
is_exec
 = 
	`ngx_is_exec
(&
fi
);

944  
NGX_OK
;

945 
	}
}

954 
	$ngx_Ý’_fže_add_ev’t
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
,

955 
ngx_ÿched_Ý’_fže_t
 *
fže
, 
ngx_Ý’_fže_šfo_t
 *
of
, 
ngx_log_t
 *
log
)

957 
ngx_Ý’_fže_ÿche_ev’t_t
 *
ãv
;

959 ià(!(
ngx_ev’t_æags
 & 
NGX_USE_VNODE_EVENT
)

960 || !
of
->
ev’ts


961 || 
fže
->
ev’t


962 || 
of
->
fd
 =ð
NGX_INVALID_FILE


963 || 
fže
->
u£s
 < 
of
->
mš_u£s
)

968 
fže
->
u£_ev’t
 = 0;

970 
fže
->
ev’t
 = 
	`ngx_ÿÎoc
((
ngx_ev’t_t
), 
log
);

971 ià(
fže
->
ev’t
=ð
NULL
) {

975 
ãv
 = 
	`ngx_®loc
((
ngx_Ý’_fže_ÿche_ev’t_t
), 
log
);

976 ià(
ãv
 =ð
NULL
) {

977 
	`ngx_ä“
(
fže
->
ev’t
);

978 
fže
->
ev’t
 = 
NULL
;

982 
ãv
->
fd
 = 
of
->fd;

983 
ãv
->
fže
 = file;

984 
ãv
->
ÿche
 = cache;

986 
fže
->
ev’t
->
hªdËr
 = 
ngx_Ý’_fže_ÿche_»move
;

987 
fže
->
ev’t
->
d©a
 = 
ãv
;

995 
fže
->
ev’t
->
log
 = 
ngx_cyþe
->log;

997 ià(
	`ngx_add_ev’t
(
fže
->
ev’t
, 
NGX_VNODE_EVENT
, 
NGX_ONESHOT_EVENT
)

998 !ð
NGX_OK
)

1000 
	`ngx_ä“
(
fže
->
ev’t
->
d©a
);

1001 
	`ngx_ä“
(
fže
->
ev’t
);

1002 
fže
->
ev’t
 = 
NULL
;

1014 
	}
}

1018 
	$ngx_Ý’_fže_þ—nup
(*
d©a
)

1020 
ngx_Ý’_fže_ÿche_þ—nup_t
 *
c
 = 
d©a
;

1022 
c
->
fže
->
couÁ
--;

1024 
	`ngx_þo£_ÿched_fže
(
c
->
ÿche
, c->
fže
, c->
mš_u£s
, c->
log
);

1027 
	`ngx_expœe_Þd_ÿched_fžes
(
c
->
ÿche
, 1, c->
log
);

1028 
	}
}

1032 
	$ngx_þo£_ÿched_fže
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
,

1033 
ngx_ÿched_Ý’_fže_t
 *
fže
, 
ngx_ušt_t
 
mš_u£s
, 
ngx_log_t
 *
log
)

1035 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

1037 
fže
->
Çme
, fže->
fd
, fže->
couÁ
, fže->
u£s
, fže->
þo£
);

1039 ià(!
fže
->
þo£
) {

1041 
fže
->
acûs£d
 = 
	`ngx_time
();

1043 
	`ngx_queue_»move
(&
fže
->
queue
);

1045 
	`ngx_queue_š£¹_h—d
(&
ÿche
->
expœe_queue
, &
fže
->
queue
);

1047 ià(
fže
->
u£s
 >ð
mš_u£s
 || fže->
couÁ
) {

1052 
	`ngx_Ý’_fže_d–_ev’t
(
fže
);

1054 ià(
fže
->
couÁ
) {

1058 ià(
fže
->
fd
 !ð
NGX_INVALID_FILE
) {

1060 ià(
	`ngx_þo£_fže
(
fže
->
fd
è=ð
NGX_FILE_ERROR
) {

1061 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

1062 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fže
->
Çme
);

1065 
fže
->
fd
 = 
NGX_INVALID_FILE
;

1068 ià(!
fže
->
þo£
) {

1072 
	`ngx_ä“
(
fže
->
Çme
);

1073 
	`ngx_ä“
(
fže
);

1074 
	}
}

1078 
	$ngx_Ý’_fže_d–_ev’t
(
ngx_ÿched_Ý’_fže_t
 *
fže
)

1080 ià(
fže
->
ev’t
 =ð
NULL
) {

1084 (è
	`ngx_d–_ev’t
(
fže
->
ev’t
, 
NGX_VNODE_EVENT
,

1085 
fže
->
couÁ
 ? 
NGX_FLUSH_EVENT
 : 
NGX_CLOSE_EVENT
);

1087 
	`ngx_ä“
(
fže
->
ev’t
->
d©a
);

1088 
	`ngx_ä“
(
fže
->
ev’t
);

1089 
fže
->
ev’t
 = 
NULL
;

1090 
fže
->
u£_ev’t
 = 0;

1091 
	}
}

1095 
	$ngx_expœe_Þd_ÿched_fžes
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
, 
ngx_ušt_t
 
n
,

1096 
ngx_log_t
 *
log
)

1098 
time_t
 
now
;

1099 
ngx_queue_t
 *
q
;

1100 
ngx_ÿched_Ý’_fže_t
 *
fže
;

1102 
now
 = 
	`ngx_time
();

1110 
n
 < 3) {

1112 ià(
	`ngx_queue_em±y
(&
ÿche
->
expœe_queue
)) {

1116 
q
 = 
	`ngx_queue_Ï¡
(&
ÿche
->
expœe_queue
);

1118 
fže
 = 
	`ngx_queue_d©a
(
q
, 
ngx_ÿched_Ý’_fže_t
, 
queue
);

1120 ià(
n
++ !ð0 && 
now
 - 
fže
->
acûs£d
 <ð
ÿche
->
šaùive
) {

1124 
	`ngx_queue_»move
(
q
);

1126 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
rbŒ“
, &
fže
->
node
);

1128 
ÿche
->
cu¼’t
--;

1130 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

1131 "expœÿched o³Àfže: %s", 
fže
->
Çme
);

1133 ià(!
fže
->
”r
 && !fže->
is_dœ
) {

1134 
fže
->
þo£
 = 1;

1135 
	`ngx_þo£_ÿched_fže
(
ÿche
, 
fže
, 0, 
log
);

1138 
	`ngx_ä“
(
fže
->
Çme
);

1139 
	`ngx_ä“
(
fže
);

1142 
	}
}

1146 
	$ngx_Ý’_fže_ÿche_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

1147 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
)

1149 
ngx_rbŒ“_node_t
 **
p
;

1150 
ngx_ÿched_Ý’_fže_t
 *
fže
, *
fže_‹mp
;

1154 ià(
node
->
key
 < 
‹mp
->key) {

1156 
p
 = &
‹mp
->
Ëá
;

1158 } ià(
node
->
key
 > 
‹mp
->key) {

1160 
p
 = &
‹mp
->
right
;

1164 
fže
 = (
ngx_ÿched_Ý’_fže_t
 *è
node
;

1165 
fže_‹mp
 = (
ngx_ÿched_Ý’_fže_t
 *è
‹mp
;

1167 
p
 = (
	`ngx_¡rcmp
(
fže
->
Çme
, 
fže_‹mp
->name) < 0)

1168 ? &
‹mp
->
Ëá
 : &‹mp->
right
;

1171 ià(*
p
 =ð
£Áš–
) {

1175 
‹mp
 = *
p
;

1178 *
p
 = 
node
;

1179 
node
->
·»Á
 = 
‹mp
;

1180 
node
->
Ëá
 = 
£Áš–
;

1181 
node
->
right
 = 
£Áš–
;

1182 
	`ngx_rbt_»d
(
node
);

1183 
	}
}

1186 
ngx_ÿched_Ý’_fže_t
 *

1187 
	$ngx_Ý’_fže_lookup
(
ngx_Ý’_fže_ÿche_t
 *
ÿche
, 
ngx_¡r_t
 *
Çme
,

1188 
ušt32_t
 
hash
)

1190 
ngx_št_t
 
rc
;

1191 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

1192 
ngx_ÿched_Ý’_fže_t
 *
fže
;

1194 
node
 = 
ÿche
->
rbŒ“
.
roÙ
;

1195 
£Áš–
 = 
ÿche
->
rbŒ“
.sentinel;

1197 
node
 !ð
£Áš–
) {

1199 ià(
hash
 < 
node
->
key
) {

1200 
node
 =‚ode->
Ëá
;

1204 ià(
hash
 > 
node
->
key
) {

1205 
node
 =‚ode->
right
;

1211 
fže
 = (
ngx_ÿched_Ý’_fže_t
 *è
node
;

1213 
rc
 = 
	`ngx_¡rcmp
(
Çme
->
d©a
, 
fže
->name);

1215 ià(
rc
 == 0) {

1216  
fže
;

1219 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

1222  
NULL
;

1223 
	}
}

1227 
	$ngx_Ý’_fže_ÿche_»move
(
ngx_ev’t_t
 *
ev
)

1229 
ngx_ÿched_Ý’_fže_t
 *
fže
;

1230 
ngx_Ý’_fže_ÿche_ev’t_t
 *
ãv
;

1232 
ãv
 = 
ev
->
d©a
;

1233 
fže
 = 
ãv
->file;

1235 
	`ngx_queue_»move
(&
fže
->
queue
);

1237 
	`ngx_rbŒ“_d–‘e
(&
ãv
->
ÿche
->
rbŒ“
, &
fže
->
node
);

1239 
ãv
->
ÿche
->
cu¼’t
--;

1242 
fže
->
ev’t
 = 
NULL
;

1243 
fže
->
u£_ev’t
 = 0;

1245 
fže
->
þo£
 = 1;

1247 
	`ngx_þo£_ÿched_fže
(
ãv
->
ÿche
, 
fže
, 0, 
ev
->
log
);

1251 
	`ngx_ä“
(
ev
->
d©a
);

1252 
	`ngx_ä“
(
ev
);

1253 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_output_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

14 
	#NGX_SENDFILE_LIMIT
 4096

	)

27 
	#NGX_NONE
 1

	)

30 
ngx_šlše
 
ngx_št_t


31 
ngx_ouut_chaš_as_is
(
ngx_ouut_chaš_ùx_t
 *
ùx
, 
ngx_buf_t
 *
buf
);

32 
ngx_št_t
 
ngx_ouut_chaš_add_cÝy
(
ngx_poÞ_t
 *
poÞ
,

33 
ngx_chaš_t
 **
chaš
,‚gx_chaš_ˆ*
š
);

34 
ngx_št_t
 
ngx_ouut_chaš_®ign_fže_buf
(
ngx_ouut_chaš_ùx_t
 *
ùx
,

35 
off_t
 
bsize
);

36 
ngx_št_t
 
ngx_ouut_chaš_g‘_buf
(
ngx_ouut_chaš_ùx_t
 *
ùx
,

37 
off_t
 
bsize
);

38 
ngx_št_t
 
ngx_ouut_chaš_cÝy_buf
(
ngx_ouut_chaš_ùx_t
 *
ùx
);

41 
ngx_št_t


42 
	$ngx_ouut_chaš
(
ngx_ouut_chaš_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
)

44 
off_t
 
bsize
;

45 
ngx_št_t
 
rc
, 
Ï¡
;

46 
ngx_chaš_t
 *
þ
, *
out
, **
Ï¡_out
;

48 ià(
ùx
->
š
 =ð
NULL
 && ctx->
busy
 == NULL) {

56 ià(
š
 =ð
NULL
) {

57  
ùx
->
	`ouut_fž‹r
(ùx->
fž‹r_ùx
, 
š
);

60 ià(
š
->
Ãxt
 =ð
NULL


61 #ià(
NGX_SENDFILE_LIMIT
)

62 && !(
š
->
buf
->
š_fže
 && in->buf->
fže_Ï¡
 > 
NGX_SENDFILE_LIMIT
)

64 && 
	`ngx_ouut_chaš_as_is
(
ùx
, 
š
->
buf
))

66  
ùx
->
	`ouut_fž‹r
(ùx->
fž‹r_ùx
, 
š
);

72 ià(
š
) {

73 ià(
	`ngx_ouut_chaš_add_cÝy
(
ùx
->
poÞ
, &ùx->
š
, inè=ð
NGX_ERROR
) {

74  
NGX_ERROR
;

78 
out
 = 
NULL
;

79 
Ï¡_out
 = &
out
;

80 
Ï¡
 = 
NGX_NONE
;

84 #ià(
NGX_HAVE_FILE_AIO
)

85 ià(
ùx
->
aio
) {

86  
NGX_AGAIN
;

90 
ùx
->
š
) {

97 
bsize
 = 
	`ngx_buf_size
(
ùx
->
š
->
buf
);

99 ià(
bsize
 =ð0 && !
	`ngx_buf_¥ecŸl
(
ùx
->
š
->
buf
)) {

101 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ùx
->
poÞ
->
log
, 0,

104 
ùx
->
š
->
buf
->
‹mpÜ¬y
,

105 
ùx
->
š
->
buf
->
»cyþed
,

106 
ùx
->
š
->
buf
->
š_fže
,

107 
ùx
->
š
->
buf
->
¡¬t
,

108 
ùx
->
š
->
buf
->
pos
,

109 
ùx
->
š
->
buf
->
Ï¡
,

110 
ùx
->
š
->
buf
->
fže
,

111 
ùx
->
š
->
buf
->
fže_pos
,

112 
ùx
->
š
->
buf
->
fže_Ï¡
);

114 
	`ngx_debug_pošt
();

116 
ùx
->
š
 = ctx->š->
Ãxt
;

121 ià(
	`ngx_ouut_chaš_as_is
(
ùx
, ctx->
š
->
buf
)) {

125 
þ
 = 
ùx
->
š
;

126 
ùx
->
š
 = 
þ
->
Ãxt
;

128 *
Ï¡_out
 = 
þ
;

129 
Ï¡_out
 = &
þ
->
Ãxt
;

130 
þ
->
Ãxt
 = 
NULL
;

135 ià(
ùx
->
buf
 =ð
NULL
) {

137 
rc
 = 
	`ngx_ouut_chaš_®ign_fže_buf
(
ùx
, 
bsize
);

139 ià(
rc
 =ð
NGX_ERROR
) {

140  
NGX_ERROR
;

143 ià(
rc
 !ð
NGX_OK
) {

145 ià(
ùx
->
ä“
) {

149 
þ
 = 
ùx
->
ä“
;

150 
ùx
->
buf
 = 
þ
->buf;

151 
ùx
->
ä“
 = 
þ
->
Ãxt
;

153 
	`ngx_ä“_chaš
(
ùx
->
poÞ
, 
þ
);

155 } ià(
out
 || 
ùx
->
®loÿ‹d
 =ðùx->
bufs
.
num
) {

159 } ià(
	`ngx_ouut_chaš_g‘_buf
(
ùx
, 
bsize
è!ð
NGX_OK
) {

160  
NGX_ERROR
;

165 
rc
 = 
	`ngx_ouut_chaš_cÝy_buf
(
ùx
);

167 ià(
rc
 =ð
NGX_ERROR
) {

168  
rc
;

171 ià(
rc
 =ð
NGX_AGAIN
) {

172 ià(
out
) {

176  
rc
;

181 ià(
	`ngx_buf_size
(
ùx
->
š
->
buf
) == 0) {

182 
ùx
->
š
 = ctx->š->
Ãxt
;

185 
þ
 = 
	`ngx_®loc_chaš_lšk
(
ùx
->
poÞ
);

186 ià(
þ
 =ð
NULL
) {

187  
NGX_ERROR
;

190 
þ
->
buf
 = 
ùx
->buf;

191 
þ
->
Ãxt
 = 
NULL
;

192 *
Ï¡_out
 = 
þ
;

193 
Ï¡_out
 = &
þ
->
Ãxt
;

194 
ùx
->
buf
 = 
NULL
;

197 ià(
out
 =ð
NULL
 && 
Ï¡
 !ð
NGX_NONE
) {

199 ià(
ùx
->
š
) {

200  
NGX_AGAIN
;

203  
Ï¡
;

206 
Ï¡
 = 
ùx
->
	`ouut_fž‹r
(ùx->
fž‹r_ùx
, 
out
);

208 ià(
Ï¡
 =ð
NGX_ERROR
 ||†a¡ =ð
NGX_DONE
) {

209  
Ï¡
;

212 
	`ngx_chaš_upd©e_chašs
(
ùx
->
poÞ
, &ùx->
ä“
, &ùx->
busy
, &
out
,

213 
ùx
->
g
);

214 
Ï¡_out
 = &
out
;

216 
	}
}

219 
ngx_šlše
 
ngx_št_t


220 
	$ngx_ouut_chaš_as_is
(
ngx_ouut_chaš_ùx_t
 *
ùx
, 
ngx_buf_t
 *
buf
)

222 
ngx_ušt_t
 
£ndfže
;

224 ià(
	`ngx_buf_¥ecŸl
(
buf
)) {

228 ià(
buf
->
š_fže
 && buf->
fže
->
dœeùio
) {

232 
£ndfže
 = 
ùx
->sendfile;

234 #ià(
NGX_SENDFILE_LIMIT
)

236 ià(
buf
->
š_fže
 && buf->
fže_pos
 >ð
NGX_SENDFILE_LIMIT
) {

237 
£ndfže
 = 0;

242 ià(!
£ndfže
) {

244 ià(!
	`ngx_buf_š_memÜy
(
buf
)) {

248 
buf
->
š_fže
 = 0;

251 ià(
ùx
->
Ãed_š_memÜy
 && !
	`ngx_buf_š_memÜy
(
buf
)) {

255 ià(
ùx
->
Ãed_š_‹mp
 && (
buf
->
memÜy
 || buf->
mm­
)) {

260 
	}
}

263 
ngx_št_t


264 
	$ngx_ouut_chaš_add_cÝy
(
ngx_poÞ_t
 *
poÞ
, 
ngx_chaš_t
 **
chaš
,

265 
ngx_chaš_t
 *
š
)

267 
ngx_chaš_t
 *
þ
, **
Î
;

268 #ià(
NGX_SENDFILE_LIMIT
)

269 
ngx_buf_t
 *
b
, *
buf
;

272 
Î
 = 
chaš
;

274 
þ
 = *
chaš
; cl; cÈðþ->
Ãxt
) {

275 
Î
 = &
þ
->
Ãxt
;

278 
š
) {

280 
þ
 = 
	`ngx_®loc_chaš_lšk
(
poÞ
);

281 ià(
þ
 =ð
NULL
) {

282  
NGX_ERROR
;

285 #ià(
NGX_SENDFILE_LIMIT
)

287 
buf
 = 
š
->buf;

289 ià(
buf
->
š_fže


290 && 
buf
->
fže_pos
 < 
NGX_SENDFILE_LIMIT


291 && 
buf
->
fže_Ï¡
 > 
NGX_SENDFILE_LIMIT
)

295 
b
 = 
	`ngx_ÿÎoc_buf
(
poÞ
);

296 ià(
b
 =ð
NULL
) {

297  
NGX_ERROR
;

300 
	`ngx_memýy
(
b
, 
buf
, (
ngx_buf_t
));

302 ià(
	`ngx_buf_š_memÜy
(
buf
)) {

303 
buf
->
pos
 +ð(
ssize_t
è(
NGX_SENDFILE_LIMIT
 - buf->
fže_pos
);

304 
b
->
Ï¡
 = 
buf
->
pos
;

307 
buf
->
fže_pos
 = 
NGX_SENDFILE_LIMIT
;

308 
b
->
fže_Ï¡
 = 
NGX_SENDFILE_LIMIT
;

310 
þ
->
buf
 = 
b
;

313 
þ
->
buf
 = buf;

314 
š
 = in->
Ãxt
;

318 
þ
->
buf
 = 
š
->buf;

319 
š
 = in->
Ãxt
;

323 
þ
->
Ãxt
 = 
NULL
;

324 *
Î
 = 
þ
;

325 
Î
 = &
þ
->
Ãxt
;

328  
NGX_OK
;

329 
	}
}

332 
ngx_št_t


333 
	$ngx_ouut_chaš_®ign_fže_buf
(
ngx_ouut_chaš_ùx_t
 *
ùx
, 
off_t
 
bsize
)

335 
size_t
 
size
;

336 
ngx_buf_t
 *
š
;

338 
š
 = 
ùx
->š->
buf
;

340 ià(
š
->
fže
 =ð
NULL
 || !š->fže->
dœeùio
) {

341  
NGX_DECLINED
;

344 
ùx
->
dœeùio
 = 1;

346 
size
 = (
size_t
è(
š
->
fže_pos
 - (š->fže_po & ~(
ùx
->
®ignm’t
 - 1)));

348 ià(
size
 == 0) {

350 ià(
bsize
 >ð(
off_t
è
ùx
->
bufs
.
size
) {

351  
NGX_DECLINED
;

354 
size
 = (
size_t
è
bsize
;

357 
size
 = (
size_t
è
ùx
->
®ignm’t
 - size;

359 ià((
off_t
è
size
 > 
bsize
) {

360 
size
 = (
size_t
è
bsize
;

364 
ùx
->
buf
 = 
	`ngx_ü—‹_‹mp_buf
(ùx->
poÞ
, 
size
);

365 ià(
ùx
->
buf
 =ð
NULL
) {

366  
NGX_ERROR
;

374 #ià(
NGX_HAVE_ALIGNED_DIRECTIO
)

375 
ùx
->
uÇligÃd
 = 1;

378  
NGX_OK
;

379 
	}
}

382 
ngx_št_t


383 
	$ngx_ouut_chaš_g‘_buf
(
ngx_ouut_chaš_ùx_t
 *
ùx
, 
off_t
 
bsize
)

385 
size_t
 
size
;

386 
ngx_buf_t
 *
b
, *
š
;

387 
ngx_ušt_t
 
»cyþed
;

389 
š
 = 
ùx
->š->
buf
;

390 
size
 = 
ùx
->
bufs
.size;

391 
»cyþed
 = 1;

393 ià(
š
->
Ï¡_š_chaš
) {

395 ià(
bsize
 < (
off_t
è
size
) {

402 
size
 = (
size_t
è
bsize
;

403 
»cyþed
 = 0;

405 } ià(!
ùx
->
dœeùio


406 && 
ùx
->
bufs
.
num
 == 1

407 && (
bsize
 < (
off_t
è(
size
 + size / 4)))

415 
size
 = (
size_t
è
bsize
;

416 
»cyþed
 = 0;

420 
b
 = 
	`ngx_ÿÎoc_buf
(
ùx
->
poÞ
);

421 ià(
b
 =ð
NULL
) {

422  
NGX_ERROR
;

425 ià(
ùx
->
dœeùio
) {

432 
b
->
¡¬t
 = 
	`ngx_pmem®ign
(
ùx
->
poÞ
, 
size
, (
size_t
èùx->
®ignm’t
);

433 ià(
b
->
¡¬t
 =ð
NULL
) {

434  
NGX_ERROR
;

438 
b
->
¡¬t
 = 
	`ngx_·Îoc
(
ùx
->
poÞ
, 
size
);

439 ià(
b
->
¡¬t
 =ð
NULL
) {

440  
NGX_ERROR
;

444 
b
->
pos
 = b->
¡¬t
;

445 
b
->
Ï¡
 = b->
¡¬t
;

446 
b
->
’d
 = b->
Ï¡
 + 
size
;

447 
b
->
‹mpÜ¬y
 = 1;

448 
b
->
g
 = 
ùx
->tag;

449 
b
->
»cyþed
 =„ecycled;

451 
ùx
->
buf
 = 
b
;

452 
ùx
->
®loÿ‹d
++;

454  
NGX_OK
;

455 
	}
}

458 
ngx_št_t


459 
	$ngx_ouut_chaš_cÝy_buf
(
ngx_ouut_chaš_ùx_t
 *
ùx
)

461 
off_t
 
size
;

462 
ssize_t
 
n
;

463 
ngx_buf_t
 *
¤c
, *
d¡
;

464 
ngx_ušt_t
 
£ndfže
;

466 
¤c
 = 
ùx
->
š
->
buf
;

467 
d¡
 = 
ùx
->
buf
;

469 
size
 = 
	`ngx_buf_size
(
¤c
);

470 
size
 = 
	`ngx_mš
(size, 
d¡
->
’d
 - d¡->
pos
);

472 
£ndfže
 = 
ùx
->£ndfž& !ùx->
dœeùio
;

474 #ià(
NGX_SENDFILE_LIMIT
)

476 ià(
¤c
->
š_fže
 && src->
fže_pos
 >ð
NGX_SENDFILE_LIMIT
) {

477 
£ndfže
 = 0;

482 ià(
	`ngx_buf_š_memÜy
(
¤c
)) {

483 
	`ngx_memýy
(
d¡
->
pos
, 
¤c
->pos, (
size_t
è
size
);

484 
¤c
->
pos
 +ð(
size_t
è
size
;

485 
d¡
->
Ï¡
 +ð(
size_t
è
size
;

487 ià(
¤c
->
š_fže
) {

489 ià(
£ndfže
) {

490 
d¡
->
š_fže
 = 1;

491 
d¡
->
fže
 = 
¤c
->file;

492 
d¡
->
fže_pos
 = 
¤c
->file_pos;

493 
d¡
->
fže_Ï¡
 = 
¤c
->
fže_pos
 + 
size
;

496 
d¡
->
š_fže
 = 0;

499 
¤c
->
fže_pos
 +ð
size
;

502 
d¡
->
š_fže
 = 0;

505 ià(
¤c
->
pos
 =ð¤c->
Ï¡
) {

506 
d¡
->
æush
 = 
¤c
->flush;

507 
d¡
->
Ï¡_buf
 = 
¤c
->last_buf;

508 
d¡
->
Ï¡_š_chaš
 = 
¤c
->last_in_chain;

513 #ià(
NGX_HAVE_ALIGNED_DIRECTIO
)

515 ià(
ùx
->
uÇligÃd
) {

516 ià(
	`ngx_dœeùio_off
(
¤c
->
fže
->
fd
è=ð
NGX_FILE_ERROR
) {

517 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ùx
->
poÞ
->
log
, 
ngx_”ºo
,

518 
ngx_dœeùio_off_n
 " \"%s\" failed",

519 
¤c
->
fže
->
Çme
.
d©a
);

525 #ià(
NGX_HAVE_FILE_AIO
)

527 ià(
ùx
->
aio_hªdËr
) {

528 
n
 = 
	`ngx_fže_aio_»ad
(
¤c
->
fže
, 
d¡
->
pos
, (
size_t
è
size
,

529 
¤c
->
fže_pos
, 
ùx
->
poÞ
);

530 ià(
n
 =ð
NGX_AGAIN
) {

531 
ùx
->
	`aio_hªdËr
(ùx, 
¤c
->
fže
);

532  
NGX_AGAIN
;

536 
n
 = 
	`ngx_»ad_fže
(
¤c
->
fže
, 
d¡
->
pos
, (
size_t
è
size
,

537 
¤c
->
fže_pos
);

541 
n
 = 
	`ngx_»ad_fže
(
¤c
->
fže
, 
d¡
->
pos
, (
size_t
è
size
, src->
fže_pos
);

545 #ià(
NGX_HAVE_ALIGNED_DIRECTIO
)

547 ià(
ùx
->
uÇligÃd
) {

548 
ngx_”r_t
 
”r
;

550 
”r
 = 
ngx_”ºo
;

552 ià(
	`ngx_dœeùio_Ú
(
¤c
->
fže
->
fd
è=ð
NGX_FILE_ERROR
) {

553 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ùx
->
poÞ
->
log
, 
ngx_”ºo
,

554 
ngx_dœeùio_Ú_n
 " \"%s\" failed",

555 
¤c
->
fže
->
Çme
.
d©a
);

558 
	`ngx_£t_”ºo
(
”r
);

560 
ùx
->
uÇligÃd
 = 0;

565 ià(
n
 =ð
NGX_ERROR
) {

566  (
ngx_št_t
è
n
;

569 ià(
n
 !ð
size
) {

570 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ùx
->
poÞ
->
log
, 0,

571 
ngx_»ad_fže_n
 "„ead only %z of %O from \"%s\"",

572 
n
, 
size
, 
¤c
->
fže
->
Çme
.
d©a
);

573  
NGX_ERROR
;

576 
d¡
->
Ï¡
 +ð
n
;

578 ià(
£ndfže
) {

579 
d¡
->
š_fže
 = 1;

580 
d¡
->
fže
 = 
¤c
->file;

581 
d¡
->
fže_pos
 = 
¤c
->file_pos;

582 
d¡
->
fže_Ï¡
 = 
¤c
->
fže_pos
 + 
n
;

585 
d¡
->
š_fže
 = 0;

588 
¤c
->
fže_pos
 +ð
n
;

590 ià(
¤c
->
fže_pos
 =ð¤c->
fže_Ï¡
) {

591 
d¡
->
æush
 = 
¤c
->flush;

592 
d¡
->
Ï¡_buf
 = 
¤c
->last_buf;

593 
d¡
->
Ï¡_š_chaš
 = 
¤c
->last_in_chain;

597  
NGX_OK
;

598 
	}
}

601 
ngx_št_t


602 
	$ngx_chaš_wr™”
(*
d©a
, 
ngx_chaš_t
 *
š
)

604 
ngx_chaš_wr™”_ùx_t
 *
ùx
 = 
d©a
;

606 
off_t
 
size
;

607 
ngx_chaš_t
 *
þ
;

608 
ngx_cÚÃùiÚ_t
 *
c
;

610 
c
 = 
ùx
->
cÚÃùiÚ
;

612 
size
 = 0; 
š
; iÀðš->
Ãxt
) {

615 ià(
	`ngx_buf_size
(
š
->
buf
è=ð0 && !
	`ngx_buf_¥ecŸl
(in->buf)) {

616 
	`ngx_debug_pošt
();

620 
size
 +ð
	`ngx_buf_size
(
š
->
buf
);

622 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

624 
š
->
buf
->
æush
, 
	`ngx_buf_size
(in->buf));

626 
þ
 = 
	`ngx_®loc_chaš_lšk
(
ùx
->
poÞ
);

627 ià(
þ
 =ð
NULL
) {

628  
NGX_ERROR
;

631 
þ
->
buf
 = 
š
->buf;

632 
þ
->
Ãxt
 = 
NULL
;

633 *
ùx
->
Ï¡
 = 
þ
;

634 
ùx
->
Ï¡
 = &
þ
->
Ãxt
;

637 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

638 "chaš wr™” in: %p", 
ùx
->
out
);

640 
þ
 = 
ùx
->
out
; cl; cÈðþ->
Ãxt
) {

643 ià(
	`ngx_buf_size
(
þ
->
buf
è=ð0 && !
	`ngx_buf_¥ecŸl
(cl->buf)) {

644 
	`ngx_debug_pošt
();

649 
size
 +ð
	`ngx_buf_size
(
þ
->
buf
);

652 ià(
size
 =ð0 && !
c
->
bufã»d
) {

653  
NGX_OK
;

656 
ùx
->
out
 = 
c
->
	`£nd_chaš
(c, ctx->out, ctx->
lim™
);

658 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

659 "chaš wr™” out: %p", 
ùx
->
out
);

661 ià(
ùx
->
out
 =ð
NGX_CHAIN_ERROR
) {

662  
NGX_ERROR
;

665 ià(
ùx
->
out
 =ð
NULL
) {

666 
ùx
->
Ï¡
 = &ùx->
out
;

668 ià(!
c
->
bufã»d
) {

669  
NGX_OK
;

673  
NGX_AGAIN
;

674 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_palloc.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 *
ngx_·Îoc_block
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
);

13 *
ngx_·Îoc_Ïrge
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
);

16 
ngx_poÞ_t
 *

17 
	$ngx_ü—‹_poÞ
(
size_t
 
size
, 
ngx_log_t
 *
log
)

19 
ngx_poÞ_t
 *
p
;

21 
p
 = 
	`ngx_mem®ign
(
NGX_POOL_ALIGNMENT
, 
size
, 
log
);

22 ià(
p
 =ð
NULL
) {

23  
NULL
;

26 
p
->
d
.
Ï¡
 = (
u_ch¬
 *è°+ (
ngx_poÞ_t
);

27 
p
->
d
.
’d
 = (
u_ch¬
 *è°+ 
size
;

28 
p
->
d
.
Ãxt
 = 
NULL
;

29 
p
->
d
.
çžed
 = 0;

31 
size
 = siz- (
ngx_poÞ_t
);

32 
p
->
max
 = (
size
 < 
NGX_MAX_ALLOC_FROM_POOL
) ? size : NGX_MAX_ALLOC_FROM_POOL;

34 
p
->
cu¼’t
 =…;

35 
p
->
chaš
 = 
NULL
;

36 
p
->
Ïrge
 = 
NULL
;

37 
p
->
þ—nup
 = 
NULL
;

38 
p
->
log
 =†og;

40  
p
;

41 
	}
}

45 
	$ngx_de¡roy_poÞ
(
ngx_poÞ_t
 *
poÞ
)

47 
ngx_poÞ_t
 *
p
, *
n
;

48 
ngx_poÞ_Ïrge_t
 *
l
;

49 
ngx_poÞ_þ—nup_t
 *
c
;

51 
c
 = 
poÞ
->
þ—nup
; c; c = c->
Ãxt
) {

52 ià(
c
->
hªdËr
) {

53 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
poÞ
->
log
, 0,

54 "ruÀþ—nup: %p", 
c
);

55 
c
->
	`hªdËr
(c->
d©a
);

59 
l
 = 
poÞ
->
Ïrge
;†;† =†->
Ãxt
) {

61 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
poÞ
->
log
, 0, "ä“: %p", 
l
->
®loc
);

63 ià(
l
->
®loc
) {

64 
	`ngx_ä“
(
l
->
®loc
);

68 #ià(
NGX_DEBUG
)

75 
p
 = 
poÞ
, 
n
 =…oÞ->
d
.
Ãxt
; ;… =‚,‚ =‚->d.next) {

76 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_ALLOC
, 
poÞ
->
log
, 0,

77 "ä“: %p, unu£d: %uz", 
p
,…->
d
.
’d
 -…->d.
Ï¡
);

79 ià(
n
 =ð
NULL
) {

86 
p
 = 
poÞ
, 
n
 =…oÞ->
d
.
Ãxt
; ;… =‚,‚ =‚->d.next) {

87 
	`ngx_ä“
(
p
);

89 ià(
n
 =ð
NULL
) {

93 
	}
}

97 
	$ngx_»£t_poÞ
(
ngx_poÞ_t
 *
poÞ
)

99 
ngx_poÞ_t
 *
p
;

100 
ngx_poÞ_Ïrge_t
 *
l
;

102 
l
 = 
poÞ
->
Ïrge
;†;† =†->
Ãxt
) {

103 ià(
l
->
®loc
) {

104 
	`ngx_ä“
(
l
->
®loc
);

108 
p
 = 
poÞ
;…;… =…->
d
.
Ãxt
) {

109 
p
->
d
.
Ï¡
 = (
u_ch¬
 *è°+ (
ngx_poÞ_t
);

110 
p
->
d
.
çžed
 = 0;

113 
poÞ
->
cu¼’t
 =…ool;

114 
poÞ
->
chaš
 = 
NULL
;

115 
poÞ
->
Ïrge
 = 
NULL
;

116 
	}
}

120 
	$ngx_·Îoc
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
)

122 
u_ch¬
 *
m
;

123 
ngx_poÞ_t
 *
p
;

125 ià(
size
 <ð
poÞ
->
max
) {

127 
p
 = 
poÞ
->
cu¼’t
;

130 
m
 = 
	`ngx_®ign_±r
(
p
->
d
.
Ï¡
, 
NGX_ALIGNMENT
);

132 ià((
size_t
è(
p
->
d
.
’d
 - 
m
è>ð
size
) {

133 
p
->
d
.
Ï¡
 = 
m
 + 
size
;

135  
m
;

138 
p
 =…->
d
.
Ãxt
;

140 } 
p
);

142  
	`ngx_·Îoc_block
(
poÞ
, 
size
);

145  
	`ngx_·Îoc_Ïrge
(
poÞ
, 
size
);

146 
	}
}

150 
	$ngx_²®loc
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
)

152 
u_ch¬
 *
m
;

153 
ngx_poÞ_t
 *
p
;

155 ià(
size
 <ð
poÞ
->
max
) {

157 
p
 = 
poÞ
->
cu¼’t
;

160 
m
 = 
p
->
d
.
Ï¡
;

162 ià((
size_t
è(
p
->
d
.
’d
 - 
m
è>ð
size
) {

163 
p
->
d
.
Ï¡
 = 
m
 + 
size
;

165  
m
;

168 
p
 =…->
d
.
Ãxt
;

170 } 
p
);

172  
	`ngx_·Îoc_block
(
poÞ
, 
size
);

175  
	`ngx_·Îoc_Ïrge
(
poÞ
, 
size
);

176 
	}
}

180 
	$ngx_·Îoc_block
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
)

182 
u_ch¬
 *
m
;

183 
size_t
 
psize
;

184 
ngx_poÞ_t
 *
p
, *
Ãw
;

186 
psize
 = (
size_t
è(
poÞ
->
d
.
’d
 - (
u_ch¬
 *)…ool);

188 
m
 = 
	`ngx_mem®ign
(
NGX_POOL_ALIGNMENT
, 
psize
, 
poÞ
->
log
);

189 ià(
m
 =ð
NULL
) {

190  
NULL
;

193 
Ãw
 = (
ngx_poÞ_t
 *è
m
;

195 
Ãw
->
d
.
’d
 = 
m
 + 
psize
;

196 
Ãw
->
d
.
Ãxt
 = 
NULL
;

197 
Ãw
->
d
.
çžed
 = 0;

199 
m
 +ð(
ngx_poÞ_d©a_t
);

200 
m
 = 
	`ngx_®ign_±r
(m, 
NGX_ALIGNMENT
);

201 
Ãw
->
d
.
Ï¡
 = 
m
 + 
size
;

203 
p
 = 
poÞ
->
cu¼’t
;…->
d
.
Ãxt
;… =…->d.next) {

204 ià(
p
->
d
.
çžed
++ > 4) {

205 
poÞ
->
cu¼’t
 = 
p
->
d
.
Ãxt
;

209 
p
->
d
.
Ãxt
 = 
Ãw
;

211  
m
;

212 
	}
}

216 
	$ngx_·Îoc_Ïrge
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
)

218 *
p
;

219 
ngx_ušt_t
 
n
;

220 
ngx_poÞ_Ïrge_t
 *
Ïrge
;

222 
p
 = 
	`ngx_®loc
(
size
, 
poÞ
->
log
);

223 ià(
p
 =ð
NULL
) {

224  
NULL
;

227 
n
 = 0;

229 
Ïrge
 = 
poÞ
->Ïrge;†¬ge;†¬gðÏrge->
Ãxt
) {

230 ià(
Ïrge
->
®loc
 =ð
NULL
) {

231 
Ïrge
->
®loc
 = 
p
;

232  
p
;

235 ià(
n
++ > 3) {

240 
Ïrge
 = 
	`ngx_·Îoc
(
poÞ
, (
ngx_poÞ_Ïrge_t
));

241 ià(
Ïrge
 =ð
NULL
) {

242 
	`ngx_ä“
(
p
);

243  
NULL
;

246 
Ïrge
->
®loc
 = 
p
;

247 
Ïrge
->
Ãxt
 = 
poÞ
->large;

248 
poÞ
->
Ïrge
 =†arge;

250  
p
;

251 
	}
}

255 
	$ngx_pmem®ign
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
, size_ˆ
®ignm’t
)

257 *
p
;

258 
ngx_poÞ_Ïrge_t
 *
Ïrge
;

260 
p
 = 
	`ngx_mem®ign
(
®ignm’t
, 
size
, 
poÞ
->
log
);

261 ià(
p
 =ð
NULL
) {

262  
NULL
;

265 
Ïrge
 = 
	`ngx_·Îoc
(
poÞ
, (
ngx_poÞ_Ïrge_t
));

266 ià(
Ïrge
 =ð
NULL
) {

267 
	`ngx_ä“
(
p
);

268  
NULL
;

271 
Ïrge
->
®loc
 = 
p
;

272 
Ïrge
->
Ãxt
 = 
poÞ
->large;

273 
poÞ
->
Ïrge
 =†arge;

275  
p
;

276 
	}
}

279 
ngx_št_t


280 
	$ngx_pä“
(
ngx_poÞ_t
 *
poÞ
, *
p
)

282 
ngx_poÞ_Ïrge_t
 *
l
;

284 
l
 = 
poÞ
->
Ïrge
;†;† =†->
Ãxt
) {

285 ià(
p
 =ð
l
->
®loc
) {

286 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
poÞ
->
log
, 0,

287 "ä“: %p", 
l
->
®loc
);

288 
	`ngx_ä“
(
l
->
®loc
);

289 
l
->
®loc
 = 
NULL
;

291  
NGX_OK
;

295  
NGX_DECLINED
;

296 
	}
}

300 
	$ngx_pÿÎoc
(
ngx_poÞ_t
 *
poÞ
, 
size_t
 
size
)

302 *
p
;

304 
p
 = 
	`ngx_·Îoc
(
poÞ
, 
size
);

305 ià(
p
) {

306 
	`ngx_memz”o
(
p
, 
size
);

309  
p
;

310 
	}
}

313 
ngx_poÞ_þ—nup_t
 *

314 
	$ngx_poÞ_þ—nup_add
(
ngx_poÞ_t
 *
p
, 
size_t
 
size
)

316 
ngx_poÞ_þ—nup_t
 *
c
;

318 
c
 = 
	`ngx_·Îoc
(
p
, (
ngx_poÞ_þ—nup_t
));

319 ià(
c
 =ð
NULL
) {

320  
NULL
;

323 ià(
size
) {

324 
c
->
d©a
 = 
	`ngx_·Îoc
(
p
, 
size
);

325 ià(
c
->
d©a
 =ð
NULL
) {

326  
NULL
;

330 
c
->
d©a
 = 
NULL
;

333 
c
->
hªdËr
 = 
NULL
;

334 
c
->
Ãxt
 = 
p
->
þ—nup
;

336 
p
->
þ—nup
 = 
c
;

338 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
p
->
log
, 0, "add cËªup: %p", 
c
);

340  
c
;

341 
	}
}

345 
	$ngx_poÞ_run_þ—nup_fže
(
ngx_poÞ_t
 *
p
, 
ngx_fd_t
 
fd
)

347 
ngx_poÞ_þ—nup_t
 *
c
;

348 
ngx_poÞ_þ—nup_fže_t
 *
cf
;

350 
c
 = 
p
->
þ—nup
; c; c = c->
Ãxt
) {

351 ià(
c
->
hªdËr
 =ð
ngx_poÞ_þ—nup_fže
) {

353 
cf
 = 
c
->
d©a
;

355 ià(
cf
->
fd
 == fd) {

356 
c
->
	`hªdËr
(
cf
);

357 
c
->
hªdËr
 = 
NULL
;

362 
	}
}

366 
	$ngx_poÞ_þ—nup_fže
(*
d©a
)

368 
ngx_poÞ_þ—nup_fže_t
 *
c
 = 
d©a
;

370 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
c
->
log
, 0, "file cleanup: fd:%d",

371 
c
->
fd
);

373 ià(
	`ngx_þo£_fže
(
c
->
fd
è=ð
NGX_FILE_ERROR
) {

374 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

375 
ngx_þo£_fže_n
 " \"%s\" fažed", 
c
->
Çme
);

377 
	}
}

381 
	$ngx_poÞ_d–‘e_fže
(*
d©a
)

383 
ngx_poÞ_þ—nup_fže_t
 *
c
 = 
d©a
;

385 
ngx_”r_t
 
”r
;

387 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_ALLOC
, 
c
->
log
, 0, "file cleanup: fd:%d %s",

388 
c
->
fd
, c->
Çme
);

390 ià(
	`ngx_d–‘e_fže
(
c
->
Çme
è=ð
NGX_FILE_ERROR
) {

391 
”r
 = 
ngx_”ºo
;

393 ià(
”r
 !ð
NGX_ENOENT
) {

394 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
c
->
log
, 
”r
,

395 
ngx_d–‘e_fže_n
 " \"%s\" fažed", 
c
->
Çme
);

399 ià(
	`ngx_þo£_fže
(
c
->
fd
è=ð
NGX_FILE_ERROR
) {

400 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

401 
ngx_þo£_fže_n
 " \"%s\" fažed", 
c
->
Çme
);

403 
	}
}

409 
	$ngx_g‘_ÿched_block
(
size_t
 
size
)

411 *
p
;

412 
ngx_ÿched_block_¦Ù_t
 *
¦Ù
;

414 ià(
ngx_cyþe
->
ÿche
 =ð
NULL
) {

415  
NULL
;

418 
¦Ù
 = &
ngx_cyþe
->
ÿche
[(
size
 + 
ngx_·gesize
 - 1) /‚gx_pagesize];

420 
¦Ù
->
Œ›s
++;

422 ià(
¦Ù
->
numb”
) {

423 
p
 = 
¦Ù
->
block
;

424 
¦Ù
->
block
 = slÙ->block->
Ãxt
;

425 
¦Ù
->
numb”
--;

426  
p
;

429  
NULL
;

430 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_parse.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ssize_t


13 
	$ngx_·r£_size
(
ngx_¡r_t
 *
lše
)

15 
u_ch¬
 
un™
;

16 
size_t
 
Ën
;

17 
ssize_t
 
size
;

18 
ngx_št_t
 
sÿË
;

20 
Ën
 = 
lše
->len;

21 
un™
 = 
lše
->
d©a
[
Ën
 - 1];

23 
un™
) {

26 
Ën
--;

27 
sÿË
 = 1024;

32 
Ën
--;

33 
sÿË
 = 1024 * 1024;

37 
sÿË
 = 1;

40 
size
 = 
	`ngx_©osz
(
lše
->
d©a
, 
Ën
);

41 ià(
size
 =ð
NGX_ERROR
) {

42  
NGX_ERROR
;

45 
size
 *ð
sÿË
;

47  
size
;

48 
	}
}

51 
off_t


52 
	$ngx_·r£_off£t
(
ngx_¡r_t
 *
lše
)

54 
u_ch¬
 
un™
;

55 
off_t
 
off£t
;

56 
size_t
 
Ën
;

57 
ngx_št_t
 
sÿË
;

59 
Ën
 = 
lše
->len;

60 
un™
 = 
lše
->
d©a
[
Ën
 - 1];

62 
un™
) {

65 
Ën
--;

66 
sÿË
 = 1024;

71 
Ën
--;

72 
sÿË
 = 1024 * 1024;

77 
Ën
--;

78 
sÿË
 = 1024 * 1024 * 1024;

82 
sÿË
 = 1;

85 
off£t
 = 
	`ngx_©oof
(
lše
->
d©a
, 
Ën
);

86 ià(
off£t
 =ð
NGX_ERROR
) {

87  
NGX_ERROR
;

90 
off£t
 *ð
sÿË
;

92  
off£t
;

93 
	}
}

96 
ngx_št_t


97 
	$ngx_·r£_time
(
ngx_¡r_t
 *
lše
, 
ngx_ušt_t
 
is_£c
)

99 
u_ch¬
 *
p
, *
Ï¡
;

100 
ngx_št_t
 
v®ue
, 
tÙ®
, 
sÿË
;

101 
ngx_ušt_t
 
max
, 
v®id
;

103 
¡_¡¬t
 = 0,

104 
¡_y—r
,

105 
¡_mÚth
,

106 
¡_w“k
,

107 
¡_day
,

108 
¡_hour
,

109 
¡_mš
,

110 
¡_£c
,

111 
¡_m£c
,

112 
¡_Ï¡


113 } 
¡•
;

115 
v®id
 = 0;

116 
v®ue
 = 0;

117 
tÙ®
 = 0;

118 
¡•
 = 
is_£c
 ? 
¡_¡¬t
 : 
¡_mÚth
;

119 
sÿË
 = 
is_£c
 ? 1 : 1000;

121 
p
 = 
lše
->
d©a
;

122 
Ï¡
 = 
p
 + 
lše
->
Ën
;

124 
p
 < 
Ï¡
) {

126 ià(*
p
 >= '0' && *p <= '9') {

127 
v®ue
 = v®u* 10 + (*
p
++ - '0');

128 
v®id
 = 1;

132 *
p
++) {

135 ià(
¡•
 > 
¡_¡¬t
) {

136  
NGX_ERROR
;

138 
¡•
 = 
¡_y—r
;

139 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60 * 24 * 365);

140 
sÿË
 = 60 * 60 * 24 * 365;

144 ià(
¡•
 >ð
¡_mÚth
) {

145  
NGX_ERROR
;

147 
¡•
 = 
¡_mÚth
;

148 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60 * 24 * 30);

149 
sÿË
 = 60 * 60 * 24 * 30;

153 ià(
¡•
 >ð
¡_w“k
) {

154  
NGX_ERROR
;

156 
¡•
 = 
¡_w“k
;

157 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60 * 24 * 7);

158 
sÿË
 = 60 * 60 * 24 * 7;

162 ià(
¡•
 >ð
¡_day
) {

163  
NGX_ERROR
;

165 
¡•
 = 
¡_day
;

166 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60 * 24);

167 
sÿË
 = 60 * 60 * 24;

171 ià(
¡•
 >ð
¡_hour
) {

172  
NGX_ERROR
;

174 
¡•
 = 
¡_hour
;

175 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60);

176 
sÿË
 = 60 * 60;

180 ià(*
p
 == 's') {

181 ià(
is_£c
 || 
¡•
 >ð
¡_m£c
) {

182  
NGX_ERROR
;

184 
p
++;

185 
¡•
 = 
¡_m£c
;

186 
max
 = 
NGX_MAX_INT32_VALUE
;

187 
sÿË
 = 1;

191 ià(
¡•
 >ð
¡_mš
) {

192  
NGX_ERROR
;

194 
¡•
 = 
¡_mš
;

195 
max
 = 
NGX_MAX_INT32_VALUE
 / 60;

196 
sÿË
 = 60;

200 ià(
¡•
 >ð
¡_£c
) {

201  
NGX_ERROR
;

203 
¡•
 = 
¡_£c
;

204 
max
 = 
NGX_MAX_INT32_VALUE
;

205 
sÿË
 = 1;

209 ià(
¡•
 >ð
¡_£c
) {

210  
NGX_ERROR
;

212 
¡•
 = 
¡_Ï¡
;

213 
max
 = 
NGX_MAX_INT32_VALUE
;

214 
sÿË
 = 1;

218  
NGX_ERROR
;

221 ià(
¡•
 !ð
¡_m£c
 && !
is_£c
) {

222 
sÿË
 *= 1000;

223 
max
 /= 1000;

226 ià((
ngx_ušt_t
è
v®ue
 > 
max
) {

227  
NGX_ERROR
;

230 
tÙ®
 +ð
v®ue
 * 
sÿË
;

232 ià((
ngx_ušt_t
è
tÙ®
 > 
NGX_MAX_INT32_VALUE
) {

233  
NGX_ERROR
;

236 
v®ue
 = 0;

237 
sÿË
 = 
is_£c
 ? 1 : 1000;

239 
p
 < 
Ï¡
 && *p == ' ') {

240 
p
++;

244 ià(
v®id
) {

245  
tÙ®
 + 
v®ue
 * 
sÿË
;

248  
NGX_ERROR
;

249 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_proxy_protocol.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
u_ch¬
 *

13 
	$ngx_´oxy_´ÙocÞ_·r£
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, u_ch¬ *
Ï¡
)

15 
size_t
 
Ën
;

16 
u_ch¬
 
ch
, *
p
, *
addr
;

18 
p
 = 
buf
;

19 
Ën
 = 
Ï¡
 - 
buf
;

21 ià(
Ën
 < 8 || 
	`ngx_¡ºcmp
(
p
, "PROXY ", 6) != 0) {

22 
šv®id
;

25 
p
 += 6;

26 
Ën
 -= 6;

28 ià(
Ën
 >ð7 && 
	`ngx_¡ºcmp
(
p
, "UNKNOWN", 7) == 0) {

29 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

31 
p
 += 7;

32 
sk
;

35 ià(
Ën
 < 5 || 
	`ngx_¡ºcmp
(
p
, "TCP", 3) != 0

36 || (
p
[3] != '4' &&…[3] != '6') ||…[4] != ' ')

38 
šv®id
;

41 
p
 += 5;

42 
addr
 = 
p
;

45 ià(
p
 =ð
Ï¡
) {

46 
šv®id
;

49 
ch
 = *
p
++;

51 ià(
ch
 == ' ') {

55 ià(
ch
 != ':' && ch != '.'

56 && (
ch
 < 'a' || ch > 'f')

57 && (
ch
 < 'A' || ch > 'F')

58 && (
ch
 < '0' || ch > '9'))

60 
šv®id
;

64 
Ën
 = 
p
 - 
addr
 - 1;

65 
c
->
´oxy_´ÙocÞ_addr
.
d©a
 = 
	`ngx_²®loc
(c->
poÞ
, 
Ën
);

67 ià(
c
->
´oxy_´ÙocÞ_addr
.
d©a
 =ð
NULL
) {

68  
NULL
;

71 
	`ngx_memýy
(
c
->
´oxy_´ÙocÞ_addr
.
d©a
, 
addr
, 
Ën
);

72 
c
->
´oxy_´ÙocÞ_addr
.
Ën
 =†en;

74 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

75 "PROXY…rÙocÞ‡dd»ss: \"%V\"", &
c
->
´oxy_´ÙocÞ_addr
);

77 
sk
:

79  ; 
p
 < 
Ï¡
 - 1;…++) {

80 ià(
p
[0] =ð
CR
 &&…[1] =ð
LF
) {

81  
p
 + 2;

85 
šv®id
:

87 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

88 "brok’ h—d”: \"%*s\"", (
size_t
è(
Ï¡
 - 
buf
), buf);

90  
NULL
;

91 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_queue.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

17 
ngx_queue_t
 *

18 
	$ngx_queue_middË
(
ngx_queue_t
 *
queue
)

20 
ngx_queue_t
 *
middË
, *
Ãxt
;

22 
middË
 = 
	`ngx_queue_h—d
(
queue
);

24 ià(
middË
 =ð
	`ngx_queue_Ï¡
(
queue
)) {

25  
middË
;

28 
Ãxt
 = 
	`ngx_queue_h—d
(
queue
);

31 
middË
 = 
	`ngx_queue_Ãxt
(middle);

33 
Ãxt
 = 
	`ngx_queue_Ãxt
(next);

35 ià(
Ãxt
 =ð
	`ngx_queue_Ï¡
(
queue
)) {

36  
middË
;

39 
Ãxt
 = 
	`ngx_queue_Ãxt
(next);

41 ià(
Ãxt
 =ð
	`ngx_queue_Ï¡
(
queue
)) {

42  
middË
;

45 
	}
}

51 
ngx_queue_sÜt
(
ngx_queue_t
 *
queue
,

52 
	$ngx_št_t
 (*
cmp
)(cÚ¡ 
ngx_queue_t
 *, const‚gx_queue_t *))

54 
ngx_queue_t
 *
q
, *
´ev
, *
Ãxt
;

56 
q
 = 
	`ngx_queue_h—d
(
queue
);

58 ià(
q
 =ð
	`ngx_queue_Ï¡
(
queue
)) {

62 
q
 = 
	`ngx_queue_Ãxt
(q); q !ð
	`ngx_queue_£Áš–
(
queue
); q = 
Ãxt
) {

64 
´ev
 = 
	`ngx_queue_´ev
(
q
);

65 
Ãxt
 = 
	`ngx_queue_Ãxt
(
q
);

67 
	`ngx_queue_»move
(
q
);

70 ià(
	`cmp
(
´ev
, 
q
) <= 0) {

74 
´ev
 = 
	`ngx_queue_´ev
(prev);

76 } 
´ev
 !ð
	`ngx_queue_£Áš–
(
queue
));

78 
	`ngx_queue_š£¹_aá”
(
´ev
, 
q
);

80 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_radix_tree.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_¿dix_node_t
 *
ngx_¿dix_®loc
(
ngx_¿dix_Œ“_t
 *
Œ“
);

15 
ngx_¿dix_Œ“_t
 *

16 
	$ngx_¿dix_Œ“_ü—‹
(
ngx_poÞ_t
 *
poÞ
, 
ngx_št_t
 
´—Îoÿ‹
)

18 
ušt32_t
 
key
, 
mask
, 
šc
;

19 
ngx_¿dix_Œ“_t
 *
Œ“
;

21 
Œ“
 = 
	`ngx_·Îoc
(
poÞ
, (
ngx_¿dix_Œ“_t
));

22 ià(
Œ“
 =ð
NULL
) {

23  
NULL
;

26 
Œ“
->
poÞ
 =…ool;

27 
Œ“
->
ä“
 = 
NULL
;

28 
Œ“
->
¡¬t
 = 
NULL
;

29 
Œ“
->
size
 = 0;

31 
Œ“
->
roÙ
 = 
	`ngx_¿dix_®loc
(tree);

32 ià(
Œ“
->
roÙ
 =ð
NULL
) {

33  
NULL
;

36 
Œ“
->
roÙ
->
right
 = 
NULL
;

37 
Œ“
->
roÙ
->
Ëá
 = 
NULL
;

38 
Œ“
->
roÙ
->
·»Á
 = 
NULL
;

39 
Œ“
->
roÙ
->
v®ue
 = 
NGX_RADIX_NO_VALUE
;

41 ià(
´—Îoÿ‹
 == 0) {

42  
Œ“
;

62 ià(
´—Îoÿ‹
 == -1) {

63 
ngx_·gesize
 / (
ngx_¿dix_node_t
)) {

67 
´—Îoÿ‹
 = 6;

72 
´—Îoÿ‹
 = 7;

77 
´—Îoÿ‹
 = 8;

81 
mask
 = 0;

82 
šc
 = 0x80000000;

84 
´—Îoÿ‹
--) {

86 
key
 = 0;

87 
mask
 >>= 1;

88 
mask
 |= 0x80000000;

91 ià(
	`ngx_¿dix32Œ“_š£¹
(
Œ“
, 
key
, 
mask
, 
NGX_RADIX_NO_VALUE
)

92 !ð
NGX_OK
)

94  
NULL
;

97 
key
 +ð
šc
;

99 } 
key
);

101 
šc
 >>= 1;

104  
Œ“
;

105 
	}
}

108 
ngx_št_t


109 
	$ngx_¿dix32Œ“_š£¹
(
ngx_¿dix_Œ“_t
 *
Œ“
, 
ušt32_t
 
key
, ušt32_ˆ
mask
,

110 
ušŒ_t
 
v®ue
)

112 
ušt32_t
 
b™
;

113 
ngx_¿dix_node_t
 *
node
, *
Ãxt
;

115 
b™
 = 0x80000000;

117 
node
 = 
Œ“
->
roÙ
;

118 
Ãxt
 = 
Œ“
->
roÙ
;

120 
b™
 & 
mask
) {

121 ià(
key
 & 
b™
) {

122 
Ãxt
 = 
node
->
right
;

125 
Ãxt
 = 
node
->
Ëá
;

128 ià(
Ãxt
 =ð
NULL
) {

132 
b™
 >>= 1;

133 
node
 = 
Ãxt
;

136 ià(
Ãxt
) {

137 ià(
node
->
v®ue
 !ð
NGX_RADIX_NO_VALUE
) {

138  
NGX_BUSY
;

141 
node
->
v®ue
 = value;

142  
NGX_OK
;

145 
b™
 & 
mask
) {

146 
Ãxt
 = 
	`ngx_¿dix_®loc
(
Œ“
);

147 ià(
Ãxt
 =ð
NULL
) {

148  
NGX_ERROR
;

151 
Ãxt
->
right
 = 
NULL
;

152 
Ãxt
->
Ëá
 = 
NULL
;

153 
Ãxt
->
·»Á
 = 
node
;

154 
Ãxt
->
v®ue
 = 
NGX_RADIX_NO_VALUE
;

156 ià(
key
 & 
b™
) {

157 
node
->
right
 = 
Ãxt
;

160 
node
->
Ëá
 = 
Ãxt
;

163 
b™
 >>= 1;

164 
node
 = 
Ãxt
;

167 
node
->
v®ue
 = value;

169  
NGX_OK
;

170 
	}
}

173 
ngx_št_t


174 
	$ngx_¿dix32Œ“_d–‘e
(
ngx_¿dix_Œ“_t
 *
Œ“
, 
ušt32_t
 
key
, ušt32_ˆ
mask
)

176 
ušt32_t
 
b™
;

177 
ngx_¿dix_node_t
 *
node
;

179 
b™
 = 0x80000000;

180 
node
 = 
Œ“
->
roÙ
;

182 
node
 && (
b™
 & 
mask
)) {

183 ià(
key
 & 
b™
) {

184 
node
 =‚ode->
right
;

187 
node
 =‚ode->
Ëá
;

190 
b™
 >>= 1;

193 ià(
node
 =ð
NULL
) {

194  
NGX_ERROR
;

197 ià(
node
->
right
 ||‚ode->
Ëá
) {

198 ià(
node
->
v®ue
 !ð
NGX_RADIX_NO_VALUE
) {

199 
node
->
v®ue
 = 
NGX_RADIX_NO_VALUE
;

200  
NGX_OK
;

203  
NGX_ERROR
;

207 ià(
node
->
·»Á
->
right
 ==‚ode) {

208 
node
->
·»Á
->
right
 = 
NULL
;

211 
node
->
·»Á
->
Ëá
 = 
NULL
;

214 
node
->
right
 = 
Œ“
->
ä“
;

215 
Œ“
->
ä“
 = 
node
;

217 
node
 =‚ode->
·»Á
;

219 ià(
node
->
right
 ||‚ode->
Ëá
) {

223 ià(
node
->
v®ue
 !ð
NGX_RADIX_NO_VALUE
) {

227 ià(
node
->
·»Á
 =ð
NULL
) {

232  
NGX_OK
;

233 
	}
}

236 
ušŒ_t


237 
	$ngx_¿dix32Œ“_fšd
(
ngx_¿dix_Œ“_t
 *
Œ“
, 
ušt32_t
 
key
)

239 
ušt32_t
 
b™
;

240 
ušŒ_t
 
v®ue
;

241 
ngx_¿dix_node_t
 *
node
;

243 
b™
 = 0x80000000;

244 
v®ue
 = 
NGX_RADIX_NO_VALUE
;

245 
node
 = 
Œ“
->
roÙ
;

247 
node
) {

248 ià(
node
->
v®ue
 !ð
NGX_RADIX_NO_VALUE
) {

249 
v®ue
 = 
node
->value;

252 ià(
key
 & 
b™
) {

253 
node
 =‚ode->
right
;

256 
node
 =‚ode->
Ëá
;

259 
b™
 >>= 1;

262  
v®ue
;

263 
	}
}

266 #ià(
NGX_HAVE_INET6
)

268 
ngx_št_t


269 
	$ngx_¿dix128Œ“_š£¹
(
ngx_¿dix_Œ“_t
 *
Œ“
, 
u_ch¬
 *
key
, u_ch¬ *
mask
,

270 
ušŒ_t
 
v®ue
)

272 
u_ch¬
 
b™
;

273 
ngx_ušt_t
 
i
;

274 
ngx_¿dix_node_t
 *
node
, *
Ãxt
;

276 
i
 = 0;

277 
b™
 = 0x80;

279 
node
 = 
Œ“
->
roÙ
;

280 
Ãxt
 = 
Œ“
->
roÙ
;

282 
b™
 & 
mask
[
i
]) {

283 ià(
key
[
i
] & 
b™
) {

284 
Ãxt
 = 
node
->
right
;

287 
Ãxt
 = 
node
->
Ëá
;

290 ià(
Ãxt
 =ð
NULL
) {

294 
b™
 >>= 1;

295 
node
 = 
Ãxt
;

297 ià(
b™
 == 0) {

298 ià(++
i
 == 16) {

302 
b™
 = 0x80;

306 ià(
Ãxt
) {

307 ià(
node
->
v®ue
 !ð
NGX_RADIX_NO_VALUE
) {

308  
NGX_BUSY
;

311 
node
->
v®ue
 = value;

312  
NGX_OK
;

315 
b™
 & 
mask
[
i
]) {

316 
Ãxt
 = 
	`ngx_¿dix_®loc
(
Œ“
);

317 ià(
Ãxt
 =ð
NULL
) {

318  
NGX_ERROR
;

321 
Ãxt
->
right
 = 
NULL
;

322 
Ãxt
->
Ëá
 = 
NULL
;

323 
Ãxt
->
·»Á
 = 
node
;

324 
Ãxt
->
v®ue
 = 
NGX_RADIX_NO_VALUE
;

326 ià(
key
[
i
] & 
b™
) {

327 
node
->
right
 = 
Ãxt
;

330 
node
->
Ëá
 = 
Ãxt
;

333 
b™
 >>= 1;

334 
node
 = 
Ãxt
;

336 ià(
b™
 == 0) {

337 ià(++
i
 == 16) {

341 
b™
 = 0x80;

345 
node
->
v®ue
 = value;

347  
NGX_OK
;

348 
	}
}

351 
ngx_št_t


352 
	$ngx_¿dix128Œ“_d–‘e
(
ngx_¿dix_Œ“_t
 *
Œ“
, 
u_ch¬
 *
key
, u_ch¬ *
mask
)

354 
u_ch¬
 
b™
;

355 
ngx_ušt_t
 
i
;

356 
ngx_¿dix_node_t
 *
node
;

358 
i
 = 0;

359 
b™
 = 0x80;

360 
node
 = 
Œ“
->
roÙ
;

362 
node
 && (
b™
 & 
mask
[
i
])) {

363 ià(
key
[
i
] & 
b™
) {

364 
node
 =‚ode->
right
;

367 
node
 =‚ode->
Ëá
;

370 
b™
 >>= 1;

372 ià(
b™
 == 0) {

373 ià(++
i
 == 16) {

377 
b™
 = 0x80;

381 ià(
node
 =ð
NULL
) {

382  
NGX_ERROR
;

385 ià(
node
->
right
 ||‚ode->
Ëá
) {

386 ià(
node
->
v®ue
 !ð
NGX_RADIX_NO_VALUE
) {

387 
node
->
v®ue
 = 
NGX_RADIX_NO_VALUE
;

388  
NGX_OK
;

391  
NGX_ERROR
;

395 ià(
node
->
·»Á
->
right
 ==‚ode) {

396 
node
->
·»Á
->
right
 = 
NULL
;

399 
node
->
·»Á
->
Ëá
 = 
NULL
;

402 
node
->
right
 = 
Œ“
->
ä“
;

403 
Œ“
->
ä“
 = 
node
;

405 
node
 =‚ode->
·»Á
;

407 ià(
node
->
right
 ||‚ode->
Ëá
) {

411 ià(
node
->
v®ue
 !ð
NGX_RADIX_NO_VALUE
) {

415 ià(
node
->
·»Á
 =ð
NULL
) {

420  
NGX_OK
;

421 
	}
}

424 
ušŒ_t


425 
	$ngx_¿dix128Œ“_fšd
(
ngx_¿dix_Œ“_t
 *
Œ“
, 
u_ch¬
 *
key
)

427 
u_ch¬
 
b™
;

428 
ušŒ_t
 
v®ue
;

429 
ngx_ušt_t
 
i
;

430 
ngx_¿dix_node_t
 *
node
;

432 
i
 = 0;

433 
b™
 = 0x80;

434 
v®ue
 = 
NGX_RADIX_NO_VALUE
;

435 
node
 = 
Œ“
->
roÙ
;

437 
node
) {

438 ià(
node
->
v®ue
 !ð
NGX_RADIX_NO_VALUE
) {

439 
v®ue
 = 
node
->value;

442 ià(
key
[
i
] & 
b™
) {

443 
node
 =‚ode->
right
;

446 
node
 =‚ode->
Ëá
;

449 
b™
 >>= 1;

451 ià(
b™
 == 0) {

452 
i
++;

453 
b™
 = 0x80;

457  
v®ue
;

458 
	}
}

463 
ngx_¿dix_node_t
 *

464 
	$ngx_¿dix_®loc
(
ngx_¿dix_Œ“_t
 *
Œ“
)

466 
ngx_¿dix_node_t
 *
p
;

468 ià(
Œ“
->
ä“
) {

469 
p
 = 
Œ“
->
ä“
;

470 
Œ“
->
ä“
 =»e->ä“->
right
;

471  
p
;

474 ià(
Œ“
->
size
 < (
ngx_¿dix_node_t
)) {

475 
Œ“
->
¡¬t
 = 
	`ngx_pmem®ign
Ñ»e->
poÞ
, 
ngx_·gesize
,‚gx_pagesize);

476 ià(
Œ“
->
¡¬t
 =ð
NULL
) {

477  
NULL
;

480 
Œ“
->
size
 = 
ngx_·gesize
;

483 
p
 = (
ngx_¿dix_node_t
 *è
Œ“
->
¡¬t
;

484 
Œ“
->
¡¬t
 +ð(
ngx_¿dix_node_t
);

485 
Œ“
->
size
 -ð(
ngx_¿dix_node_t
);

487  
p
;

488 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_rbtree.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

18 
ngx_šlše
 
ngx_rbŒ“_Ëá_rÙ©e
(
ngx_rbŒ“_node_t
 **
roÙ
,

19 
ngx_rbŒ“_node_t
 *
£Áš–
,‚gx_rbŒ“_node_ˆ*
node
);

20 
ngx_šlše
 
ngx_rbŒ“_right_rÙ©e
(
ngx_rbŒ“_node_t
 **
roÙ
,

21 
ngx_rbŒ“_node_t
 *
£Áš–
,‚gx_rbŒ“_node_ˆ*
node
);

25 
	$ngx_rbŒ“_š£¹
(
ngx_rbŒ“_t
 *
Œ“
, 
ngx_rbŒ“_node_t
 *
node
)

27 
ngx_rbŒ“_node_t
 **
roÙ
, *
‹mp
, *
£Áš–
;

31 
roÙ
 = (
ngx_rbŒ“_node_t
 **è&
Œ“
->root;

32 
£Áš–
 = 
Œ“
->sentinel;

34 ià(*
roÙ
 =ð
£Áš–
) {

35 
node
->
·»Á
 = 
NULL
;

36 
node
->
Ëá
 = 
£Áš–
;

37 
node
->
right
 = 
£Áš–
;

38 
	`ngx_rbt_bÏck
(
node
);

39 *
roÙ
 = 
node
;

44 
Œ“
->
	`š£¹
(*
roÙ
, 
node
, 
£Áš–
);

48 
node
 !ð*
roÙ
 && 
	`ngx_rbt_is_»d
Òode->
·»Á
)) {

50 ià(
node
->
·»Á
 =ðnode->·»Á->·»Á->
Ëá
) {

51 
‹mp
 = 
node
->
·»Á
->·»Á->
right
;

53 ià(
	`ngx_rbt_is_»d
(
‹mp
)) {

54 
	`ngx_rbt_bÏck
(
node
->
·»Á
);

55 
	`ngx_rbt_bÏck
(
‹mp
);

56 
	`ngx_rbt_»d
(
node
->
·»Á
->parent);

57 
node
 =‚ode->
·»Á
->parent;

60 ià(
node
 =ðnode->
·»Á
->
right
) {

61 
node
 =‚ode->
·»Á
;

62 
	`ngx_rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
node
);

65 
	`ngx_rbt_bÏck
(
node
->
·»Á
);

66 
	`ngx_rbt_»d
(
node
->
·»Á
->parent);

67 
	`ngx_rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
node
->
·»Á
->parent);

71 
‹mp
 = 
node
->
·»Á
->·»Á->
Ëá
;

73 ià(
	`ngx_rbt_is_»d
(
‹mp
)) {

74 
	`ngx_rbt_bÏck
(
node
->
·»Á
);

75 
	`ngx_rbt_bÏck
(
‹mp
);

76 
	`ngx_rbt_»d
(
node
->
·»Á
->parent);

77 
node
 =‚ode->
·»Á
->parent;

80 ià(
node
 =ðnode->
·»Á
->
Ëá
) {

81 
node
 =‚ode->
·»Á
;

82 
	`ngx_rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
node
);

85 
	`ngx_rbt_bÏck
(
node
->
·»Á
);

86 
	`ngx_rbt_»d
(
node
->
·»Á
->parent);

87 
	`ngx_rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
node
->
·»Á
->parent);

92 
	`ngx_rbt_bÏck
(*
roÙ
);

93 
	}
}

97 
	$ngx_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,‚gx_rbŒ“_node_ˆ*
node
,

98 
ngx_rbŒ“_node_t
 *
£Áš–
)

100 
ngx_rbŒ“_node_t
 **
p
;

104 
p
 = (
node
->
key
 < 
‹mp
->keyè? &‹mp->
Ëá
 : &‹mp->
right
;

106 ià(*
p
 =ð
£Áš–
) {

110 
‹mp
 = *
p
;

113 *
p
 = 
node
;

114 
node
->
·»Á
 = 
‹mp
;

115 
node
->
Ëá
 = 
£Áš–
;

116 
node
->
right
 = 
£Áš–
;

117 
	`ngx_rbt_»d
(
node
);

118 
	}
}

122 
	$ngx_rbŒ“_š£¹_tim”_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,‚gx_rbŒ“_node_ˆ*
node
,

123 
ngx_rbŒ“_node_t
 *
£Áš–
)

125 
ngx_rbŒ“_node_t
 **
p
;

138 
p
 = ((
ngx_rbŒ“_key_št_t
è(
node
->
key
 - 
‹mp
->key) < 0)

139 ? &
‹mp
->
Ëá
 : &‹mp->
right
;

141 ià(*
p
 =ð
£Áš–
) {

145 
‹mp
 = *
p
;

148 *
p
 = 
node
;

149 
node
->
·»Á
 = 
‹mp
;

150 
node
->
Ëá
 = 
£Áš–
;

151 
node
->
right
 = 
£Áš–
;

152 
	`ngx_rbt_»d
(
node
);

153 
	}
}

157 
	$ngx_rbŒ“_d–‘e
(
ngx_rbŒ“_t
 *
Œ“
, 
ngx_rbŒ“_node_t
 *
node
)

159 
ngx_ušt_t
 
»d
;

160 
ngx_rbŒ“_node_t
 **
roÙ
, *
£Áš–
, *
sub¡
, *
‹mp
, *
w
;

164 
roÙ
 = (
ngx_rbŒ“_node_t
 **è&
Œ“
->root;

165 
£Áš–
 = 
Œ“
->sentinel;

167 ià(
node
->
Ëá
 =ð
£Áš–
) {

168 
‹mp
 = 
node
->
right
;

169 
sub¡
 = 
node
;

171 } ià(
node
->
right
 =ð
£Áš–
) {

172 
‹mp
 = 
node
->
Ëá
;

173 
sub¡
 = 
node
;

176 
sub¡
 = 
	`ngx_rbŒ“_mš
(
node
->
right
, 
£Áš–
);

178 ià(
sub¡
->
Ëá
 !ð
£Áš–
) {

179 
‹mp
 = 
sub¡
->
Ëá
;

181 
‹mp
 = 
sub¡
->
right
;

185 ià(
sub¡
 =ð*
roÙ
) {

186 *
roÙ
 = 
‹mp
;

187 
	`ngx_rbt_bÏck
(
‹mp
);

190 
node
->
Ëá
 = 
NULL
;

191 
node
->
right
 = 
NULL
;

192 
node
->
·»Á
 = 
NULL
;

193 
node
->
key
 = 0;

198 
»d
 = 
	`ngx_rbt_is_»d
(
sub¡
);

200 ià(
sub¡
 =ðsub¡->
·»Á
->
Ëá
) {

201 
sub¡
->
·»Á
->
Ëá
 = 
‹mp
;

204 
sub¡
->
·»Á
->
right
 = 
‹mp
;

207 ià(
sub¡
 =ð
node
) {

209 
‹mp
->
·»Á
 = 
sub¡
->parent;

213 ià(
sub¡
->
·»Á
 =ð
node
) {

214 
‹mp
->
·»Á
 = 
sub¡
;

217 
‹mp
->
·»Á
 = 
sub¡
->parent;

220 
sub¡
->
Ëá
 = 
node
->left;

221 
sub¡
->
right
 = 
node
->right;

222 
sub¡
->
·»Á
 = 
node
->parent;

223 
	`ngx_rbt_cÝy_cÞÜ
(
sub¡
, 
node
);

225 ià(
node
 =ð*
roÙ
) {

226 *
roÙ
 = 
sub¡
;

229 ià(
node
 =ðnode->
·»Á
->
Ëá
) {

230 
node
->
·»Á
->
Ëá
 = 
sub¡
;

232 
node
->
·»Á
->
right
 = 
sub¡
;

236 ià(
sub¡
->
Ëá
 !ð
£Áš–
) {

237 
sub¡
->
Ëá
->
·»Á
 = subst;

240 ià(
sub¡
->
right
 !ð
£Áš–
) {

241 
sub¡
->
right
->
·»Á
 = subst;

246 
node
->
Ëá
 = 
NULL
;

247 
node
->
right
 = 
NULL
;

248 
node
->
·»Á
 = 
NULL
;

249 
node
->
key
 = 0;

251 ià(
»d
) {

257 
‹mp
 !ð*
roÙ
 && 
	`ngx_rbt_is_bÏck
(temp)) {

259 ià(
‹mp
 =ð‹mp->
·»Á
->
Ëá
) {

260 
w
 = 
‹mp
->
·»Á
->
right
;

262 ià(
	`ngx_rbt_is_»d
(
w
)) {

263 
	`ngx_rbt_bÏck
(
w
);

264 
	`ngx_rbt_»d
(
‹mp
->
·»Á
);

265 
	`ngx_rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

266 
w
 = 
‹mp
->
·»Á
->
right
;

269 ià(
	`ngx_rbt_is_bÏck
(
w
->
Ëá
è&&‚gx_rbt_is_bÏck(w->
right
)) {

270 
	`ngx_rbt_»d
(
w
);

271 
‹mp
 =emp->
·»Á
;

274 ià(
	`ngx_rbt_is_bÏck
(
w
->
right
)) {

275 
	`ngx_rbt_bÏck
(
w
->
Ëá
);

276 
	`ngx_rbt_»d
(
w
);

277 
	`ngx_rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
w
);

278 
w
 = 
‹mp
->
·»Á
->
right
;

281 
	`ngx_rbt_cÝy_cÞÜ
(
w
, 
‹mp
->
·»Á
);

282 
	`ngx_rbt_bÏck
(
‹mp
->
·»Á
);

283 
	`ngx_rbt_bÏck
(
w
->
right
);

284 
	`ngx_rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

285 
‹mp
 = *
roÙ
;

289 
w
 = 
‹mp
->
·»Á
->
Ëá
;

291 ià(
	`ngx_rbt_is_»d
(
w
)) {

292 
	`ngx_rbt_bÏck
(
w
);

293 
	`ngx_rbt_»d
(
‹mp
->
·»Á
);

294 
	`ngx_rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

295 
w
 = 
‹mp
->
·»Á
->
Ëá
;

298 ià(
	`ngx_rbt_is_bÏck
(
w
->
Ëá
è&&‚gx_rbt_is_bÏck(w->
right
)) {

299 
	`ngx_rbt_»d
(
w
);

300 
‹mp
 =emp->
·»Á
;

303 ià(
	`ngx_rbt_is_bÏck
(
w
->
Ëá
)) {

304 
	`ngx_rbt_bÏck
(
w
->
right
);

305 
	`ngx_rbt_»d
(
w
);

306 
	`ngx_rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
w
);

307 
w
 = 
‹mp
->
·»Á
->
Ëá
;

310 
	`ngx_rbt_cÝy_cÞÜ
(
w
, 
‹mp
->
·»Á
);

311 
	`ngx_rbt_bÏck
(
‹mp
->
·»Á
);

312 
	`ngx_rbt_bÏck
(
w
->
Ëá
);

313 
	`ngx_rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

314 
‹mp
 = *
roÙ
;

319 
	`ngx_rbt_bÏck
(
‹mp
);

320 
	}
}

323 
ngx_šlše
 

324 
	$ngx_rbŒ“_Ëá_rÙ©e
(
ngx_rbŒ“_node_t
 **
roÙ
,‚gx_rbŒ“_node_ˆ*
£Áš–
,

325 
ngx_rbŒ“_node_t
 *
node
)

327 
ngx_rbŒ“_node_t
 *
‹mp
;

329 
‹mp
 = 
node
->
right
;

330 
node
->
right
 = 
‹mp
->
Ëá
;

332 ià(
‹mp
->
Ëá
 !ð
£Áš–
) {

333 
‹mp
->
Ëá
->
·»Á
 = 
node
;

336 
‹mp
->
·»Á
 = 
node
->parent;

338 ià(
node
 =ð*
roÙ
) {

339 *
roÙ
 = 
‹mp
;

341 } ià(
node
 =ðnode->
·»Á
->
Ëá
) {

342 
node
->
·»Á
->
Ëá
 = 
‹mp
;

345 
node
->
·»Á
->
right
 = 
‹mp
;

348 
‹mp
->
Ëá
 = 
node
;

349 
node
->
·»Á
 = 
‹mp
;

350 
	}
}

353 
ngx_šlše
 

354 
	$ngx_rbŒ“_right_rÙ©e
(
ngx_rbŒ“_node_t
 **
roÙ
,‚gx_rbŒ“_node_ˆ*
£Áš–
,

355 
ngx_rbŒ“_node_t
 *
node
)

357 
ngx_rbŒ“_node_t
 *
‹mp
;

359 
‹mp
 = 
node
->
Ëá
;

360 
node
->
Ëá
 = 
‹mp
->
right
;

362 ià(
‹mp
->
right
 !ð
£Áš–
) {

363 
‹mp
->
right
->
·»Á
 = 
node
;

366 
‹mp
->
·»Á
 = 
node
->parent;

368 ià(
node
 =ð*
roÙ
) {

369 *
roÙ
 = 
‹mp
;

371 } ià(
node
 =ðnode->
·»Á
->
right
) {

372 
node
->
·»Á
->
right
 = 
‹mp
;

375 
node
->
·»Á
->
Ëá
 = 
‹mp
;

378 
‹mp
->
right
 = 
node
;

379 
node
->
·»Á
 = 
‹mp
;

380 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_regex.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

13 
ngx_æag_t
 
	mpüe_j™
;

14 } 
	tngx_»gex_cÚf_t
;

17 * 
ngx_libc_cdeþ
 
ngx_»gex_m®loc
(
size_t
 
size
);

18 
ngx_libc_cdeþ
 
ngx_»gex_ä“
(*
p
);

19 #ià(
NGX_HAVE_PCRE_JIT
)

20 
ngx_püe_ä“_¡ud›s
(*
d©a
);

23 
ngx_št_t
 
ngx_»gex_moduË_š™
(
ngx_cyþe_t
 *
cyþe
);

25 *
ngx_»gex_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

26 *
ngx_»gex_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

28 *
ngx_»gex_püe_j™
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

29 
ngx_cÚf_po¡_t
 
	gngx_»gex_püe_j™_po¡
 = { 
ngx_»gex_püe_j™
 };

32 
ngx_commªd_t
 
	gngx_»gex_commªds
[] = {

34 { 
ngx_¡ršg
("pcre_jit"),

35 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

36 
ngx_cÚf_£t_æag_¦Ù
,

38 
off£tof
(
ngx_»gex_cÚf_t
, 
püe_j™
),

39 &
ngx_»gex_püe_j™_po¡
 },

41 
ngx_nuÎ_commªd


45 
ngx_cÜe_moduË_t
 
	gngx_»gex_moduË_ùx
 = {

46 
ngx_¡ršg
("regex"),

47 
ngx_»gex_ü—‹_cÚf
,

48 
ngx_»gex_š™_cÚf


52 
ngx_moduË_t
 
	gngx_»gex_moduË
 = {

53 
NGX_MODULE_V1
,

54 &
ngx_»gex_moduË_ùx
,

55 
ngx_»gex_commªds
,

56 
NGX_CORE_MODULE
,

57 
NULL
,

58 
ngx_»gex_moduË_š™
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NULL
,

63 
NULL
,

64 
NGX_MODULE_V1_PADDING


68 
ngx_poÞ_t
 *
	gngx_püe_poÞ
;

69 
ngx_li¡_t
 *
	gngx_püe_¡ud›s
;

73 
	$ngx_»gex_š™
()

75 
püe_m®loc
 = 
ngx_»gex_m®loc
;

76 
püe_ä“
 = 
ngx_»gex_ä“
;

77 
	}
}

80 
ngx_šlše
 

81 
	$ngx_»gex_m®loc_š™
(
ngx_poÞ_t
 *
poÞ
)

83 #ià(
NGX_THREADS
)

84 
ngx_cÜe_Žs_t
 *
Žs
;

86 ià(
ngx_th»aded
) {

87 
Žs
 = 
	`ngx_th»ad_g‘_Žs
(
ngx_cÜe_Žs_key
);

88 
Žs
->
poÞ
 =…ool;

94 
ngx_püe_poÞ
 = 
poÞ
;

95 
	}
}

98 
ngx_šlše
 

99 
	$ngx_»gex_m®loc_dÚe
()

101 #ià(
NGX_THREADS
)

102 
ngx_cÜe_Žs_t
 *
Žs
;

104 ià(
ngx_th»aded
) {

105 
Žs
 = 
	`ngx_th»ad_g‘_Žs
(
ngx_cÜe_Žs_key
);

106 
Žs
->
poÞ
 = 
NULL
;

112 
ngx_püe_poÞ
 = 
NULL
;

113 
	}
}

116 
ngx_št_t


117 
	$ngx_»gex_compže
(
ngx_»gex_compže_t
 *
rc
)

119 
n
, 
”roff
;

120 *
p
;

121 
püe
 *
»
;

122 cÚ¡ *
”r¡r
;

123 
ngx_»gex_–t_t
 *
–t
;

125 
	`ngx_»gex_m®loc_š™
(
rc
->
poÞ
);

127 
»
 = 
	`püe_compže
((cÚ¡ *è
rc
->
·‰”n
.
d©a
, (èrc->
ÝtiÚs
,

128 &
”r¡r
, &
”roff
, 
NULL
);

131 
	`ngx_»gex_m®loc_dÚe
();

133 ià(
»
 =ð
NULL
) {

134 ià((
size_t
è
”roff
 =ð
rc
->
·‰”n
.
Ën
) {

135 
rc
->
”r
.
Ën
 = 
	`ngx_¢´štf
Ôc->”r.
d©a
,„c->err.len,

137 
”r¡r
, &
rc
->
·‰”n
)

138 - 
rc
->
”r
.
d©a
;

141 
rc
->
”r
.
Ën
 = 
	`ngx_¢´štf
Ôc->”r.
d©a
,„c->err.len,

143 
”r¡r
, &
rc
->
·‰”n
,„c->·‰”n.
d©a
 + 
”roff
)

144 - 
rc
->
”r
.
d©a
;

147  
NGX_ERROR
;

150 
rc
->
»gex
 = 
	`ngx_pÿÎoc
Ôc->
poÞ
, (
ngx_»gex_t
));

151 ià(
rc
->
»gex
 =ð
NULL
) {

152 
nomem
;

155 
rc
->
»gex
->
code
 = 
»
;

159 ià(
ngx_püe_¡ud›s
 !ð
NULL
) {

160 
–t
 = 
	`ngx_li¡_push
(
ngx_püe_¡ud›s
);

161 ià(
–t
 =ð
NULL
) {

162 
nomem
;

165 
–t
->
»gex
 = 
rc
->regex;

166 
–t
->
Çme
 = 
rc
->
·‰”n
.
d©a
;

169 
n
 = 
	`püe_fuÎšfo
(
»
, 
NULL
, 
PCRE_INFO_CAPTURECOUNT
, &
rc
->
ÿ±u»s
);

170 ià(
n
 < 0) {

171 
p
 = "pcre_fullinfo(\"%V\", PCRE_INFO_CAPTURECOUNT) failed: %d";

172 
çžed
;

175 ià(
rc
->
ÿ±u»s
 == 0) {

176  
NGX_OK
;

179 
n
 = 
	`püe_fuÎšfo
(
»
, 
NULL
, 
PCRE_INFO_NAMECOUNT
, &
rc
->
Çmed_ÿ±u»s
);

180 ià(
n
 < 0) {

181 
p
 = "pcre_fullinfo(\"%V\", PCRE_INFO_NAMECOUNT) failed: %d";

182 
çžed
;

185 ià(
rc
->
Çmed_ÿ±u»s
 == 0) {

186  
NGX_OK
;

189 
n
 = 
	`püe_fuÎšfo
(
»
, 
NULL
, 
PCRE_INFO_NAMEENTRYSIZE
, &
rc
->
Çme_size
);

190 ià(
n
 < 0) {

191 
p
 = "pcre_fullinfo(\"%V\", PCRE_INFO_NAMEENTRYSIZE) failed: %d";

192 
çžed
;

195 
n
 = 
	`püe_fuÎšfo
(
»
, 
NULL
, 
PCRE_INFO_NAMETABLE
, &
rc
->
Çmes
);

196 ià(
n
 < 0) {

197 
p
 = "pcre_fullinfo(\"%V\", PCRE_INFO_NAMETABLE) failed: %d";

198 
çžed
;

201  
NGX_OK
;

203 
çžed
:

205 
rc
->
”r
.
Ën
 = 
	`ngx_¢´štf
Ôc->”r.
d©a
,„c->”r.Ën, 
p
, &rc->
·‰”n
, 
n
)

206 - 
rc
->
”r
.
d©a
;

207  
NGX_ERROR
;

209 
nomem
:

211 
rc
->
”r
.
Ën
 = 
	`ngx_¢´štf
Ôc->”r.
d©a
,„c->err.len,

213 &
rc
->
·‰”n
)

214 - 
rc
->
”r
.
d©a
;

215  
NGX_ERROR
;

216 
	}
}

219 
ngx_št_t


220 
	$ngx_»gex_exec_¬¿y
(
ngx_¬¿y_t
 *
a
, 
ngx_¡r_t
 *
s
, 
ngx_log_t
 *
log
)

222 
ngx_št_t
 
n
;

223 
ngx_ušt_t
 
i
;

224 
ngx_»gex_–t_t
 *
»
;

226 
»
 = 
a
->
–ts
;

228 
i
 = 0; i < 
a
->
ÃÉs
; i++) {

230 
n
 = 
	`ngx_»gex_exec
(
»
[
i
].
»gex
, 
s
, 
NULL
, 0);

232 ià(
n
 =ð
NGX_REGEX_NO_MATCHED
) {

236 ià(
n
 < 0) {

237 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

238 
ngx_»gex_exec_n
 " failed: %i on \"%V\" using \"%s\"",

239 
n
, 
s
, 
»
[
i
].
Çme
);

240  
NGX_ERROR
;

245  
NGX_OK
;

248  
NGX_DECLINED
;

249 
	}
}

252 * 
ngx_libc_cdeþ


253 
	$ngx_»gex_m®loc
(
size_t
 
size
)

255 
ngx_poÞ_t
 *
poÞ
;

256 #ià(
NGX_THREADS
)

257 
ngx_cÜe_Žs_t
 *
Žs
;

259 ià(
ngx_th»aded
) {

260 
Žs
 = 
	`ngx_th»ad_g‘_Žs
(
ngx_cÜe_Žs_key
);

261 
poÞ
 = 
Žs
->pool;

264 
poÞ
 = 
ngx_püe_poÞ
;

269 
poÞ
 = 
ngx_püe_poÞ
;

273 ià(
poÞ
) {

274  
	`ngx_·Îoc
(
poÞ
, 
size
);

277  
NULL
;

278 
	}
}

281 
ngx_libc_cdeþ


282 
	$ngx_»gex_ä“
(*
p
)

285 
	}
}

288 #ià(
NGX_HAVE_PCRE_JIT
)

291 
	$ngx_püe_ä“_¡ud›s
(*
d©a
)

293 
ngx_li¡_t
 *
¡ud›s
 = 
d©a
;

295 
ngx_ušt_t
 
i
;

296 
ngx_li¡_·¹_t
 *
·¹
;

297 
ngx_»gex_–t_t
 *
–ts
;

299 
·¹
 = &
¡ud›s
->part;

300 
–ts
 = 
·¹
->elts;

302 
i
 = 0 ; ; i++) {

304 ià(
i
 >ð
·¹
->
ÃÉs
) {

305 ià(
·¹
->
Ãxt
 =ð
NULL
) {

309 
·¹
 =…¬t->
Ãxt
;

310 
–ts
 = 
·¹
->elts;

311 
i
 = 0;

314 ià(
–ts
[
i
].
»gex
->
exŒa
 !ð
NULL
) {

315 
	`püe_ä“_¡udy
(
–ts
[
i
].
»gex
->
exŒa
);

318 
	}
}

323 
ngx_št_t


324 
	$ngx_»gex_moduË_š™
(
ngx_cyþe_t
 *
cyþe
)

326 
Ýt
;

327 cÚ¡ *
”r¡r
;

328 
ngx_ušt_t
 
i
;

329 
ngx_li¡_·¹_t
 *
·¹
;

330 
ngx_»gex_–t_t
 *
–ts
;

332 
Ýt
 = 0;

334 #ià(
NGX_HAVE_PCRE_JIT
)

336 
ngx_»gex_cÚf_t
 *
rcf
;

337 
ngx_poÞ_þ—nup_t
 *
þn
;

339 
rcf
 = (
ngx_»gex_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_»gex_moduË
);

341 ià(
rcf
->
püe_j™
) {

342 
Ýt
 = 
PCRE_STUDY_JIT_COMPILE
;

350 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cyþe
->
poÞ
, 0);

351 ià(
þn
 =ð
NULL
) {

352  
NGX_ERROR
;

355 
þn
->
hªdËr
 = 
ngx_püe_ä“_¡ud›s
;

356 
þn
->
d©a
 = 
ngx_püe_¡ud›s
;

361 
	`ngx_»gex_m®loc_š™
(
cyþe
->
poÞ
);

363 
·¹
 = &
ngx_püe_¡ud›s
->part;

364 
–ts
 = 
·¹
->elts;

366 
i
 = 0 ; ; i++) {

368 ià(
i
 >ð
·¹
->
ÃÉs
) {

369 ià(
·¹
->
Ãxt
 =ð
NULL
) {

373 
·¹
 =…¬t->
Ãxt
;

374 
–ts
 = 
·¹
->elts;

375 
i
 = 0;

378 
–ts
[
i
].
»gex
->
exŒa
 = 
	`püe_¡udy
ÓÉs[i].»gex->
code
, 
Ýt
, &
”r¡r
);

380 ià(
”r¡r
 !ð
NULL
) {

381 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

383 
”r¡r
, 
–ts
[
i
].
Çme
);

386 #ià(
NGX_HAVE_PCRE_JIT
)

387 ià(
Ýt
 & 
PCRE_STUDY_JIT_COMPILE
) {

388 
j™
, 
n
;

390 
j™
 = 0;

391 
n
 = 
	`püe_fuÎšfo
(
–ts
[
i
].
»gex
->
code
,ƒÉs[i].»gex->
exŒa
,

392 
PCRE_INFO_JIT
, &
j™
);

394 ià(
n
 !ð0 || 
j™
 != 1) {

395 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
cyþe
->
log
, 0,

397 
–ts
[
i
].
Çme
);

403 
	`ngx_»gex_m®loc_dÚe
();

405 
ngx_püe_¡ud›s
 = 
NULL
;

407  
NGX_OK
;

408 
	}
}

412 
	$ngx_»gex_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

414 
ngx_»gex_cÚf_t
 *
rcf
;

416 
rcf
 = 
	`ngx_pÿÎoc
(
cyþe
->
poÞ
, (
ngx_»gex_cÚf_t
));

417 ià(
rcf
 =ð
NULL
) {

418  
NULL
;

421 
rcf
->
püe_j™
 = 
NGX_CONF_UNSET
;

423 
ngx_püe_¡ud›s
 = 
	`ngx_li¡_ü—‹
(
cyþe
->
poÞ
, 8, (
ngx_»gex_–t_t
));

424 ià(
ngx_püe_¡ud›s
 =ð
NULL
) {

425  
NULL
;

428  
rcf
;

429 
	}
}

433 
	$ngx_»gex_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

435 
ngx_»gex_cÚf_t
 *
rcf
 = 
cÚf
;

437 
	`ngx_cÚf_š™_v®ue
(
rcf
->
püe_j™
, 0);

439  
NGX_CONF_OK
;

440 
	}
}

444 
	$ngx_»gex_püe_j™
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

446 
ngx_æag_t
 *
å
 = 
d©a
;

448 ià(*
å
 == 0) {

449  
NGX_CONF_OK
;

452 #ià(
NGX_HAVE_PCRE_JIT
)

454 
j™
, 
r
;

456 
j™
 = 0;

457 
r
 = 
	`püe_cÚfig
(
PCRE_CONFIG_JIT
, &
j™
);

459 ià(
r
 !ð0 || 
j™
 != 1) {

460 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

462 *
å
 = 0;

466 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

468 *
å
 = 0;

471  
NGX_CONF_OK
;

472 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_resolver.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
	#NGX_RESOLVER_UDP_SIZE
 4096

	)

17 
u_ch¬
 
	mid’t_hi
;

18 
u_ch¬
 
	mid’t_lo
;

19 
u_ch¬
 
	mæags_hi
;

20 
u_ch¬
 
	mæags_lo
;

21 
u_ch¬
 
	mnqs_hi
;

22 
u_ch¬
 
	mnqs_lo
;

23 
u_ch¬
 
	mÇn_hi
;

24 
u_ch¬
 
	mÇn_lo
;

25 
u_ch¬
 
	mÂs_hi
;

26 
u_ch¬
 
	mÂs_lo
;

27 
u_ch¬
 
	mÇr_hi
;

28 
u_ch¬
 
	mÇr_lo
;

29 } 
	tngx_»sÞv”_hdr_t
;

33 
u_ch¬
 
	mty³_hi
;

34 
u_ch¬
 
	mty³_lo
;

35 
u_ch¬
 
	mþass_hi
;

36 
u_ch¬
 
	mþass_lo
;

37 } 
	tngx_»sÞv”_qs_t
;

41 
u_ch¬
 
	mty³_hi
;

42 
u_ch¬
 
	mty³_lo
;

43 
u_ch¬
 
	mþass_hi
;

44 
u_ch¬
 
	mþass_lo
;

45 
u_ch¬
 
	m‰l
[4];

46 
u_ch¬
 
	mËn_hi
;

47 
u_ch¬
 
	mËn_lo
;

48 } 
	tngx_»sÞv”_ª_t
;

51 
	#ngx_»sÞv”_node
(
n
) \

52 (
ngx_»sÞv”_node_t
 *) \

53 ((
u_ch¬
 *è(
n
è- 
	`off£tof
(
ngx_»sÞv”_node_t
, 
node
))

	)

56 
ngx_št_t
 
ngx_udp_cÚÃù
(
ngx_udp_cÚÃùiÚ_t
 *
uc
);

59 
ngx_»sÞv”_þ—nup
(*
d©a
);

60 
ngx_»sÞv”_þ—nup_Œ“
(
ngx_»sÞv”_t
 *
r
, 
ngx_rbŒ“_t
 *
Œ“
);

61 
ngx_št_t
 
ngx_»sÞve_Çme_locked
(
ngx_»sÞv”_t
 *
r
,

62 
ngx_»sÞv”_ùx_t
 *
ùx
);

63 
ngx_»sÞv”_expœe
(
ngx_»sÞv”_t
 *
r
, 
ngx_rbŒ“_t
 *
Œ“
,

64 
ngx_queue_t
 *
queue
);

65 
ngx_št_t
 
ngx_»sÞv”_£nd_qu”y
(
ngx_»sÞv”_t
 *
r
,

66 
ngx_»sÞv”_node_t
 *
º
);

67 
ngx_št_t
 
ngx_»sÞv”_ü—‹_Çme_qu”y
(
ngx_»sÞv”_node_t
 *
º
,

68 
ngx_»sÞv”_ùx_t
 *
ùx
);

69 
ngx_št_t
 
ngx_»sÞv”_ü—‹_addr_qu”y
(
ngx_»sÞv”_node_t
 *
º
,

70 
ngx_»sÞv”_ùx_t
 *
ùx
);

71 
ngx_»sÞv”_»£nd_hªdËr
(
ngx_ev’t_t
 *
ev
);

72 
time_t
 
ngx_»sÞv”_»£nd
(
ngx_»sÞv”_t
 *
r
, 
ngx_rbŒ“_t
 *
Œ“
,

73 
ngx_queue_t
 *
queue
);

74 
ngx_»sÞv”_»ad_»¥Ú£
(
ngx_ev’t_t
 *
»v
);

75 
ngx_»sÞv”_´oûss_»¥Ú£
(
ngx_»sÞv”_t
 *
r
, 
u_ch¬
 *
buf
,

76 
size_t
 
n
);

77 
ngx_»sÞv”_´oûss_a
(
ngx_»sÞv”_t
 *
r
, 
u_ch¬
 *
buf
, 
size_t
 
n
,

78 
ngx_ušt_t
 
id’t
,‚gx_ušt_ˆ
code
,‚gx_ušt_ˆ
qty³
,

79 
ngx_ušt_t
 
Çn
,‚gx_ušt_ˆ
ªs
);

80 
ngx_»sÞv”_´oûss_±r
(
ngx_»sÞv”_t
 *
r
, 
u_ch¬
 *
buf
, 
size_t
 
n
,

81 
ngx_ušt_t
 
id’t
,‚gx_ušt_ˆ
code
,‚gx_ušt_ˆ
Çn
);

82 
ngx_»sÞv”_node_t
 *
ngx_»sÞv”_lookup_Çme
(
ngx_»sÞv”_t
 *
r
,

83 
ngx_¡r_t
 *
Çme
, 
ušt32_t
 
hash
);

84 
ngx_»sÞv”_node_t
 *
ngx_»sÞv”_lookup_addr
(
ngx_»sÞv”_t
 *
r
,

85 
š_addr_t
 
addr
);

86 
ngx_»sÞv”_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

87 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
);

88 
ngx_št_t
 
ngx_»sÞv”_cÝy
(
ngx_»sÞv”_t
 *
r
, 
ngx_¡r_t
 *
Çme
,

89 
u_ch¬
 *
buf
, u_ch¬ *
¤c
, u_ch¬ *
Ï¡
);

90 
ngx_»sÞv”_timeout_hªdËr
(
ngx_ev’t_t
 *
ev
);

91 
ngx_»sÞv”_ä“_node
(
ngx_»sÞv”_t
 *
r
, 
ngx_»sÞv”_node_t
 *
º
);

92 *
ngx_»sÞv”_®loc
(
ngx_»sÞv”_t
 *
r
, 
size_t
 
size
);

93 *
ngx_»sÞv”_ÿÎoc
(
ngx_»sÞv”_t
 *
r
, 
size_t
 
size
);

94 
ngx_»sÞv”_ä“
(
ngx_»sÞv”_t
 *
r
, *
p
);

95 
ngx_»sÞv”_ä“_locked
(
ngx_»sÞv”_t
 *
r
, *
p
);

96 *
ngx_»sÞv”_dup
(
ngx_»sÞv”_t
 *
r
, *
¤c
, 
size_t
 
size
);

97 
ngx_addr_t
 *
ngx_»sÞv”_expÜt
(
ngx_»sÞv”_t
 *
r
,

98 
ngx_»sÞv”_node_t
 *
º
, 
ngx_ušt_t
 
rÙ©e
);

99 
u_ch¬
 *
ngx_»sÞv”_log_”rÜ
(
ngx_log_t
 *
log
, u_ch¬ *
buf
, 
size_t
 
Ën
);

101 #ià(
NGX_HAVE_INET6
)

102 
ngx_»sÞv”_rbŒ“_š£¹_addr6_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

103 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
);

104 
ngx_»sÞv”_node_t
 *
ngx_»sÞv”_lookup_addr6
(
ngx_»sÞv”_t
 *
r
,

105 
š6_addr
 *
addr
, 
ušt32_t
 
hash
);

109 
ngx_»sÞv”_t
 *

110 
	$ngx_»sÞv”_ü—‹
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
Çmes
, 
ngx_ušt_t
 
n
)

112 
ngx_¡r_t
 
s
;

113 
ngx_u¾_t
 
u
;

114 
ngx_ušt_t
 
i
, 
j
;

115 
ngx_»sÞv”_t
 *
r
;

116 
ngx_poÞ_þ—nup_t
 *
þn
;

117 
ngx_udp_cÚÃùiÚ_t
 *
uc
;

119 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

120 ià(
þn
 =ð
NULL
) {

121  
NULL
;

124 
þn
->
hªdËr
 = 
ngx_»sÞv”_þ—nup
;

126 
r
 = 
	`ngx_ÿÎoc
((
ngx_»sÞv”_t
), 
cf
->
log
);

127 ià(
r
 =ð
NULL
) {

128  
NULL
;

131 
þn
->
d©a
 = 
r
;

133 
r
->
ev’t
 = 
	`ngx_ÿÎoc
((
ngx_ev’t_t
), 
cf
->
log
);

134 ià(
r
->
ev’t
 =ð
NULL
) {

135  
NULL
;

138 
	`ngx_rbŒ“_š™
(&
r
->
Çme_rbŒ“
, &r->
Çme_£Áš–
,

139 
ngx_»sÞv”_rbŒ“_š£¹_v®ue
);

141 
	`ngx_rbŒ“_š™
(&
r
->
addr_rbŒ“
, &r->
addr_£Áš–
,

142 
ngx_rbŒ“_š£¹_v®ue
);

144 
	`ngx_queue_š™
(&
r
->
Çme_»£nd_queue
);

145 
	`ngx_queue_š™
(&
r
->
addr_»£nd_queue
);

147 
	`ngx_queue_š™
(&
r
->
Çme_expœe_queue
);

148 
	`ngx_queue_š™
(&
r
->
addr_expœe_queue
);

150 #ià(
NGX_HAVE_INET6
)

151 
r
->
v6
 = 1;

153 
	`ngx_rbŒ“_š™
(&
r
->
addr6_rbŒ“
, &r->
addr6_£Áš–
,

154 
ngx_»sÞv”_rbŒ“_š£¹_addr6_v®ue
);

156 
	`ngx_queue_š™
(&
r
->
addr6_»£nd_queue
);

158 
	`ngx_queue_š™
(&
r
->
addr6_expœe_queue
);

161 
r
->
ev’t
->
hªdËr
 = 
ngx_»sÞv”_»£nd_hªdËr
;

162 
r
->
ev’t
->
d©a
 =„;

163 
r
->
ev’t
->
log
 = &
cf
->
cyþe
->
Ãw_log
;

164 
r
->
id’t
 = -1;

166 
r
->
»£nd_timeout
 = 5;

167 
r
->
expœe
 = 30;

168 
r
->
v®id
 = 0;

170 
r
->
log
 = &
cf
->
cyþe
->
Ãw_log
;

171 
r
->
log_Ëv–
 = 
NGX_LOG_ERR
;

173 ià(
n
) {

174 ià(
	`ngx_¬¿y_š™
(&
r
->
udp_cÚÃùiÚs
, 
cf
->
poÞ
, 
n
,

175 (
ngx_udp_cÚÃùiÚ_t
))

176 !ð
NGX_OK
)

178  
NULL
;

182 
i
 = 0; i < 
n
; i++) {

183 ià(
	`ngx_¡ºcmp
(
Çmes
[
i
].
d©a
, "valid=", 6) == 0) {

184 
s
.
Ën
 = 
Çmes
[
i
].len - 6;

185 
s
.
d©a
 = 
Çmes
[
i
].data + 6;

187 
r
->
v®id
 = 
	`ngx_·r£_time
(&
s
, 1);

189 ià(
r
->
v®id
 =ð(
time_t
è
NGX_ERROR
) {

190 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

191 "šv®id…¬am‘”: %V", &
Çmes
[
i
]);

192  
NULL
;

198 #ià(
NGX_HAVE_INET6
)

199 ià(
	`ngx_¡ºcmp
(
Çmes
[
i
].
d©a
, "ipv6=", 5) == 0) {

201 ià(
	`ngx_¡rcmp
(&
Çmes
[
i
].
d©a
[5], "on") == 0) {

202 
r
->
v6
 = 1;

204 } ià(
	`ngx_¡rcmp
(&
Çmes
[
i
].
d©a
[5], "off") == 0) {

205 
r
->
v6
 = 0;

208 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

209 "šv®id…¬am‘”: %V", &
Çmes
[
i
]);

210  
NULL
;

217 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

219 
u
.
u¾
 = 
Çmes
[
i
];

220 
u
.
deçuÉ_pÜt
 = 53;

222 ià(
	`ngx_·r£_u¾
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

223 ià(
u
.
”r
) {

224 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

226 
u
.
”r
, &u.
u¾
);

229  
NULL
;

232 
uc
 = 
	`ngx_¬¿y_push_n
(&
r
->
udp_cÚÃùiÚs
, 
u
.
Çddrs
);

233 ià(
uc
 =ð
NULL
) {

234  
NULL
;

237 
	`ngx_memz”o
(
uc
, 
u
.
Çddrs
 * (
ngx_udp_cÚÃùiÚ_t
));

239 
j
 = 0; j < 
u
.
Çddrs
; j++) {

240 
uc
[
j
].
sockaddr
 = 
u
.
addrs
[j].sockaddr;

241 
uc
[
j
].
sockËn
 = 
u
.
addrs
[j].socklen;

242 
uc
[
j
].
£rv”
 = 
u
.
addrs
[j].
Çme
;

246  
r
;

247 
	}
}

251 
	$ngx_»sÞv”_þ—nup
(*
d©a
)

253 
ngx_»sÞv”_t
 *
r
 = 
d©a
;

255 
ngx_ušt_t
 
i
;

256 
ngx_udp_cÚÃùiÚ_t
 *
uc
;

258 ià(
r
) {

259 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0,

262 
	`ngx_»sÞv”_þ—nup_Œ“
(
r
, &r->
Çme_rbŒ“
);

264 
	`ngx_»sÞv”_þ—nup_Œ“
(
r
, &r->
addr_rbŒ“
);

266 #ià(
NGX_HAVE_INET6
)

267 
	`ngx_»sÞv”_þ—nup_Œ“
(
r
, &r->
addr6_rbŒ“
);

270 ià(
r
->
ev’t
) {

271 
	`ngx_ä“
(
r
->
ev’t
);

275 
uc
 = 
r
->
udp_cÚÃùiÚs
.
–ts
;

277 
i
 = 0; i < 
r
->
udp_cÚÃùiÚs
.
ÃÉs
; i++) {

278 ià(
uc
[
i
].
cÚÃùiÚ
) {

279 
	`ngx_þo£_cÚÃùiÚ
(
uc
[
i
].
cÚÃùiÚ
);

283 
	`ngx_ä“
(
r
);

285 
	}
}

289 
	$ngx_»sÞv”_þ—nup_Œ“
(
ngx_»sÞv”_t
 *
r
, 
ngx_rbŒ“_t
 *
Œ“
)

291 
ngx_»sÞv”_ùx_t
 *
ùx
, *
Ãxt
;

292 
ngx_»sÞv”_node_t
 *
º
;

294 
Œ“
->
roÙ
 !ðŒ“->
£Áš–
) {

296 
º
 = 
	`ngx_»sÞv”_node
(
	`ngx_rbŒ“_mš
(
Œ“
->
roÙ
,»e->
£Áš–
));

298 
	`ngx_queue_»move
(&
º
->
queue
);

300 
ùx
 = 
º
->
wa™šg
; ctx; ctx = 
Ãxt
) {

301 
Ãxt
 = 
ùx
->next;

303 ià(
ùx
->
ev’t
) {

304 
	`ngx_»sÞv”_ä“
(
r
, 
ùx
->
ev’t
);

307 
	`ngx_»sÞv”_ä“
(
r
, 
ùx
);

310 
	`ngx_rbŒ“_d–‘e
(
Œ“
, &
º
->
node
);

312 
	`ngx_»sÞv”_ä“_node
(
r
, 
º
);

314 
	}
}

317 
ngx_»sÞv”_ùx_t
 *

318 
	$ngx_»sÞve_¡¬t
(
ngx_»sÞv”_t
 *
r
, 
ngx_»sÞv”_ùx_t
 *
‹mp
)

320 
š_addr_t
 
addr
;

321 
ngx_»sÞv”_ùx_t
 *
ùx
;

323 ià(
‹mp
) {

324 
addr
 = 
	`ngx_š‘_addr
(
‹mp
->
Çme
.
d©a
,emp->Çme.
Ën
);

326 ià(
addr
 !ð
INADDR_NONE
) {

327 
‹mp
->
»sÞv”
 = 
r
;

328 
‹mp
->
¡©e
 = 
NGX_OK
;

329 
‹mp
->
Çddrs
 = 1;

330 
‹mp
->
addrs
 = &‹mp->
addr
;

331 
‹mp
->
addr
.
sockaddr
 = (sockadd¸*è&‹mp->
sš
;

332 
‹mp
->
addr
.
sockËn
 = (
sockaddr_š
);

333 
	`ngx_memz”o
(&
‹mp
->
sš
, (
sockaddr_š
));

334 
‹mp
->
sš
.
sš_çmžy
 = 
AF_INET
;

335 
‹mp
->
sš
.
sš_addr
.
s_addr
 = 
addr
;

336 
‹mp
->
quick
 = 1;

338  
‹mp
;

342 ià(
r
->
udp_cÚÃùiÚs
.
ÃÉs
 == 0) {

343  
NGX_NO_RESOLVER
;

346 
ùx
 = 
	`ngx_»sÞv”_ÿÎoc
(
r
, (
ngx_»sÞv”_ùx_t
));

348 ià(
ùx
) {

349 
ùx
->
»sÞv”
 = 
r
;

352  
ùx
;

353 
	}
}

356 
ngx_št_t


357 
	$ngx_»sÞve_Çme
(
ngx_»sÞv”_ùx_t
 *
ùx
)

359 
ngx_št_t
 
rc
;

360 
ngx_»sÞv”_t
 *
r
;

362 
r
 = 
ùx
->
»sÞv”
;

364 ià(
ùx
->
Çme
.
Ën
 > 0 && ctx->Çme.
d©a
[ctx->name.len - 1] == '.') {

365 
ùx
->
Çme
.
Ën
--;

368 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

369 "»sÞve: \"%V\"", &
ùx
->
Çme
);

371 ià(
ùx
->
quick
) {

372 
ùx
->
	`hªdËr
(ctx);

373  
NGX_OK
;

378 
rc
 = 
	`ngx_»sÞve_Çme_locked
(
r
, 
ùx
);

380 ià(
rc
 =ð
NGX_OK
) {

381  
NGX_OK
;

386 ià(
rc
 =ð
NGX_AGAIN
) {

387  
NGX_OK
;

392 ià(
ùx
->
ev’t
) {

393 
	`ngx_»sÞv”_ä“
(
r
, 
ùx
->
ev’t
);

396 
	`ngx_»sÞv”_ä“
(
r
, 
ùx
);

398  
NGX_ERROR
;

399 
	}
}

403 
	$ngx_»sÞve_Çme_dÚe
(
ngx_»sÞv”_ùx_t
 *
ùx
)

405 
ušt32_t
 
hash
;

406 
ngx_»sÞv”_t
 *
r
;

407 
ngx_»sÞv”_ùx_t
 *
w
, **
p
;

408 
ngx_»sÞv”_node_t
 *
º
;

410 
r
 = 
ùx
->
»sÞv”
;

412 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

413 "»sÞvÇmdÚe: %i", 
ùx
->
¡©e
);

415 ià(
ùx
->
quick
) {

419 ià(
ùx
->
ev’t
 && ctx->ev’t->
tim”_£t
) {

420 
	`ngx_d–_tim”
(
ùx
->
ev’t
);

425 ià(
ùx
->
¡©e
 =ð
NGX_AGAIN
) {

427 
hash
 = 
	`ngx_üc32_shÜt
(
ùx
->
Çme
.
d©a
, ctx->Çme.
Ën
);

429 
º
 = 
	`ngx_»sÞv”_lookup_Çme
(
r
, &
ùx
->
Çme
, 
hash
);

431 ià(
º
) {

432 
p
 = &
º
->
wa™šg
;

433 
w
 = 
º
->
wa™šg
;

435 
w
) {

436 ià(
w
 =ð
ùx
) {

437 *
p
 = 
w
->
Ãxt
;

439 
dÚe
;

442 
p
 = &
w
->
Ãxt
;

443 
w
 = w->
Ãxt
;

447 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
log
, 0,

448 "could‚Ù cªûÈ%V„esÞvšg", &
ùx
->
Çme
);

451 
dÚe
:

453 
	`ngx_»sÞv”_expœe
(
r
, &r->
Çme_rbŒ“
, &r->
Çme_expœe_queue
);

459 ià(
ùx
->
ev’t
) {

460 
	`ngx_»sÞv”_ä“_locked
(
r
, 
ùx
->
ev’t
);

463 
	`ngx_»sÞv”_ä“_locked
(
r
, 
ùx
);

466 
	}
}

469 
ngx_št_t


470 
	$ngx_»sÞve_Çme_locked
(
ngx_»sÞv”_t
 *
r
, 
ngx_»sÞv”_ùx_t
 *
ùx
)

472 
ušt32_t
 
hash
;

473 
ngx_št_t
 
rc
;

474 
ngx_ušt_t
 
Çddrs
;

475 
ngx_addr_t
 *
addrs
;

476 
ngx_»sÞv”_ùx_t
 *
Ãxt
;

477 
ngx_»sÞv”_node_t
 *
º
;

479 
	`ngx_¡¾ow
(
ùx
->
Çme
.
d©a
, ctx->Çme.d©a, ctx->Çme.
Ën
);

481 
hash
 = 
	`ngx_üc32_shÜt
(
ùx
->
Çme
.
d©a
, ctx->Çme.
Ën
);

483 
º
 = 
	`ngx_»sÞv”_lookup_Çme
(
r
, &
ùx
->
Çme
, 
hash
);

485 ià(
º
) {

487 ià(
º
->
v®id
 >ð
	`ngx_time
()) {

489 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "resolve cached");

491 
	`ngx_queue_»move
(&
º
->
queue
);

493 
º
->
expœe
 = 
	`ngx_time
(è+ 
r
->expire;

495 
	`ngx_queue_š£¹_h—d
(&
r
->
Çme_expœe_queue
, &
º
->
queue
);

497 
Çddrs
 = (
º
->Çddr =ð(
u_shÜt
) -1) ? 0 :„n->naddrs;

498 #ià(
NGX_HAVE_INET6
)

499 
Çddrs
 +ð(
º
->
Çddrs6
 =ð(
u_shÜt
) -1) ? 0 :„n->naddrs6;

502 ià(
Çddrs
) {

504 ià(
Çddrs
 =ð1 && 
º
->naddrs == 1) {

505 
addrs
 = 
NULL
;

508 
addrs
 = 
	`ngx_»sÞv”_expÜt
(
r
, 
º
, 1);

509 ià(
addrs
 =ð
NULL
) {

510  
NGX_ERROR
;

514 
ùx
->
Ãxt
 = 
º
->
wa™šg
;

515 
º
->
wa™šg
 = 
NULL
;

520 
ùx
->
¡©e
 = 
NGX_OK
;

521 
ùx
->
Çddrs
 =‚addrs;

523 ià(
addrs
 =ð
NULL
) {

524 
ùx
->
addrs
 = &ùx->
addr
;

525 
ùx
->
addr
.
sockaddr
 = (sockadd¸*è&ùx->
sš
;

526 
ùx
->
addr
.
sockËn
 = (
sockaddr_š
);

527 
	`ngx_memz”o
(&
ùx
->
sš
, (
sockaddr_š
));

528 
ùx
->
sš
.
sš_çmžy
 = 
AF_INET
;

529 
ùx
->
sš
.
sš_addr
.
s_addr
 = 
º
->
u
.
addr
;

532 
ùx
->
addrs
 =‡ddrs;

535 
Ãxt
 = 
ùx
->next;

537 
ùx
->
	`hªdËr
(ctx);

539 
ùx
 = 
Ãxt
;

540 } 
ùx
);

542 ià(
addrs
 !ð
NULL
) {

543 
	`ngx_»sÞv”_ä“
(
r
, 
addrs
->
sockaddr
);

544 
	`ngx_»sÞv”_ä“
(
r
, 
addrs
);

547  
NGX_OK
;

552 ià(
ùx
->
»cursiÚ
++ < 
NGX_RESOLVER_MAX_RECURSION
) {

554 
ùx
->
Çme
.
Ën
 = 
º
->
úËn
;

555 
ùx
->
Çme
.
d©a
 = 
º
->
u
.
úame
;

557  
	`ngx_»sÞve_Çme_locked
(
r
, 
ùx
);

560 
ùx
->
Ãxt
 = 
º
->
wa™šg
;

561 
º
->
wa™šg
 = 
NULL
;

566 
ùx
->
¡©e
 = 
NGX_RESOLVE_NXDOMAIN
;

567 
Ãxt
 = 
ùx
->next;

569 
ùx
->
	`hªdËr
(ctx);

571 
ùx
 = 
Ãxt
;

572 } 
ùx
);

574  
NGX_OK
;

577 ià(
º
->
wa™šg
) {

579 
ùx
->
Ãxt
 = 
º
->
wa™šg
;

580 
º
->
wa™šg
 = 
ùx
;

581 
ùx
->
¡©e
 = 
NGX_AGAIN
;

583  
NGX_AGAIN
;

586 
	`ngx_queue_»move
(&
º
->
queue
);

590 ià(
º
->
qu”y
) {

591 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
qu”y
);

592 
º
->
qu”y
 = 
NULL
;

593 #ià(
NGX_HAVE_INET6
)

594 
º
->
qu”y6
 = 
NULL
;

598 ià(
º
->
úËn
) {

599 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
u
.
úame
);

602 ià(
º
->
Çddrs
 > 1 &&„n->Çddr !ð(
u_shÜt
) -1) {

603 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
u
.
addrs
);

606 #ià(
NGX_HAVE_INET6
)

607 ià(
º
->
Çddrs6
 > 1 &&„n->Çddrs6 !ð(
u_shÜt
) -1) {

608 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
u6
.
addrs6
);

616 
º
 = 
	`ngx_»sÞv”_®loc
(
r
, (
ngx_»sÞv”_node_t
));

617 ià(
º
 =ð
NULL
) {

618  
NGX_ERROR
;

621 
º
->
Çme
 = 
	`ngx_»sÞv”_dup
(
r
, 
ùx
->Çme.
d©a
, ctx->Çme.
Ën
);

622 ià(
º
->
Çme
 =ð
NULL
) {

623 
	`ngx_»sÞv”_ä“
(
r
, 
º
);

624  
NGX_ERROR
;

627 
º
->
node
.
key
 = 
hash
;

628 
º
->
Æ’
 = (
u_shÜt
è
ùx
->
Çme
.
Ën
;

629 
º
->
qu”y
 = 
NULL
;

630 #ià(
NGX_HAVE_INET6
)

631 
º
->
qu”y6
 = 
NULL
;

634 
	`ngx_rbŒ“_š£¹
(&
r
->
Çme_rbŒ“
, &
º
->
node
);

637 
rc
 = 
	`ngx_»sÞv”_ü—‹_Çme_qu”y
(
º
, 
ùx
);

639 ià(
rc
 =ð
NGX_ERROR
) {

640 
çžed
;

643 ià(
rc
 =ð
NGX_DECLINED
) {

644 
	`ngx_rbŒ“_d–‘e
(&
r
->
Çme_rbŒ“
, &
º
->
node
);

646 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
qu”y
);

647 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
Çme
);

648 
	`ngx_»sÞv”_ä“
(
r
, 
º
);

650 
ùx
->
¡©e
 = 
NGX_RESOLVE_NXDOMAIN
;

651 
ùx
->
	`hªdËr
(ctx);

653  
NGX_OK
;

656 
º
->
Çddrs
 = (
u_shÜt
) -1;

657 #ià(
NGX_HAVE_INET6
)

658 
º
->
Çddrs6
 = 
r
->
v6
 ? (
u_shÜt
) -1 : 0;

661 ià(
	`ngx_»sÞv”_£nd_qu”y
(
r
, 
º
è!ð
NGX_OK
) {

662 
çžed
;

665 ià(
ùx
->
ev’t
 =ð
NULL
) {

666 
ùx
->
ev’t
 = 
	`ngx_»sÞv”_ÿÎoc
(
r
, (
ngx_ev’t_t
));

667 ià(
ùx
->
ev’t
 =ð
NULL
) {

668 
çžed
;

671 
ùx
->
ev’t
->
hªdËr
 = 
ngx_»sÞv”_timeout_hªdËr
;

672 
ùx
->
ev’t
->
d©a
 = 
º
;

673 
ùx
->
ev’t
->
log
 = 
r
->log;

674 
º
->
id’t
 = -1;

676 
	`ngx_add_tim”
(
ùx
->
ev’t
, ctx->
timeout
);

679 ià(
	`ngx_queue_em±y
(&
r
->
Çme_»£nd_queue
)) {

680 
	`ngx_add_tim”
(
r
->
ev’t
, (
ngx_m£c_t
èÔ->
»£nd_timeout
 * 1000));

683 
º
->
expœe
 = 
	`ngx_time
(è+ 
r
->
»£nd_timeout
;

685 
	`ngx_queue_š£¹_h—d
(&
r
->
Çme_»£nd_queue
, &
º
->
queue
);

687 
º
->
code
 = 0;

688 
º
->
úËn
 = 0;

689 
º
->
v®id
 = 0;

690 
º
->
‰l
 = 
NGX_MAX_UINT32_VALUE
;

691 
º
->
wa™šg
 = 
ùx
;

693 
ùx
->
¡©e
 = 
NGX_AGAIN
;

695  
NGX_AGAIN
;

697 
çžed
:

699 
	`ngx_rbŒ“_d–‘e
(&
r
->
Çme_rbŒ“
, &
º
->
node
);

701 ià(
º
->
qu”y
) {

702 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
qu”y
);

705 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
Çme
);

707 
	`ngx_»sÞv”_ä“
(
r
, 
º
);

709  
NGX_ERROR
;

710 
	}
}

713 
ngx_št_t


714 
	$ngx_»sÞve_addr
(
ngx_»sÞv”_ùx_t
 *
ùx
)

716 
u_ch¬
 *
Çme
;

717 
š_addr_t
 
addr
;

718 
ngx_queue_t
 *
»£nd_queue
, *
expœe_queue
;

719 
ngx_rbŒ“_t
 *
Œ“
;

720 
ngx_»sÞv”_t
 *
r
;

721 
sockaddr_š
 *
sš
;

722 
ngx_»sÞv”_node_t
 *
º
;

723 #ià(
NGX_HAVE_INET6
)

724 
ušt32_t
 
hash
;

725 
sockaddr_š6
 *
sš6
;

728 #ià(
NGX_SUPPRESS_WARN
)

729 
addr
 = 0;

730 #ià(
NGX_HAVE_INET6
)

731 
hash
 = 0;

732 
sš6
 = 
NULL
;

736 
r
 = 
ùx
->
»sÞv”
;

738 
ùx
->
addr
.
sockaddr
->
§_çmžy
) {

740 #ià(
NGX_HAVE_INET6
)

741 
AF_INET6
:

742 
sš6
 = (
sockaddr_š6
 *è
ùx
->
addr
.
sockaddr
;

743 
hash
 = 
	`ngx_üc32_shÜt
(
sš6
->
sš6_addr
.
s6_addr
, 16);

747 
º
 = 
	`ngx_»sÞv”_lookup_addr6
(
r
, &
sš6
->
sš6_addr
, 
hash
);

749 
Œ“
 = &
r
->
addr6_rbŒ“
;

750 
»£nd_queue
 = &
r
->
addr6_»£nd_queue
;

751 
expœe_queue
 = &
r
->
addr6_expœe_queue
;

757 
sš
 = (
sockaddr_š
 *è
ùx
->
addr
.
sockaddr
;

758 
addr
 = 
	`Áohl
(
sš
->
sš_addr
.
s_addr
);

762 
º
 = 
	`ngx_»sÞv”_lookup_addr
(
r
, 
addr
);

764 
Œ“
 = &
r
->
addr_rbŒ“
;

765 
»£nd_queue
 = &
r
->
addr_»£nd_queue
;

766 
expœe_queue
 = &
r
->
addr_expœe_queue
;

769 ià(
º
) {

771 ià(
º
->
v®id
 >ð
	`ngx_time
()) {

773 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "resolve cached");

775 
	`ngx_queue_»move
(&
º
->
queue
);

777 
º
->
expœe
 = 
	`ngx_time
(è+ 
r
->expire;

779 
	`ngx_queue_š£¹_h—d
(
expœe_queue
, &
º
->
queue
);

781 
Çme
 = 
	`ngx_»sÞv”_dup
(
r
, 
º
->Çme,„n->
Æ’
);

782 ià(
Çme
 =ð
NULL
) {

783 
çžed
;

786 
ùx
->
Çme
.
Ën
 = 
º
->
Æ’
;

787 
ùx
->
Çme
.
d©a
 =‚ame;

791 
ùx
->
¡©e
 = 
NGX_OK
;

793 
ùx
->
	`hªdËr
(ctx);

795 
	`ngx_»sÞv”_ä“
(
r
, 
Çme
);

797  
NGX_OK
;

800 ià(
º
->
wa™šg
) {

802 
ùx
->
Ãxt
 = 
º
->
wa™šg
;

803 
º
->
wa™šg
 = 
ùx
;

804 
ùx
->
¡©e
 = 
NGX_AGAIN
;

808  
NGX_OK
;

811 
	`ngx_queue_»move
(&
º
->
queue
);

813 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
qu”y
);

814 
º
->
qu”y
 = 
NULL
;

815 #ià(
NGX_HAVE_INET6
)

816 
º
->
qu”y6
 = 
NULL
;

820 
º
 = 
	`ngx_»sÞv”_®loc
(
r
, (
ngx_»sÞv”_node_t
));

821 ià(
º
 =ð
NULL
) {

822 
çžed
;

825 
ùx
->
addr
.
sockaddr
->
§_çmžy
) {

827 #ià(
NGX_HAVE_INET6
)

828 
AF_INET6
:

829 
º
->
addr6
 = 
sš6
->
sš6_addr
;

830 
º
->
node
.
key
 = 
hash
;

835 
º
->
node
.
key
 = 
addr
;

838 
º
->
qu”y
 = 
NULL
;

839 #ià(
NGX_HAVE_INET6
)

840 
º
->
qu”y6
 = 
NULL
;

843 
	`ngx_rbŒ“_š£¹
(
Œ“
, &
º
->
node
);

846 ià(
	`ngx_»sÞv”_ü—‹_addr_qu”y
(
º
, 
ùx
è!ð
NGX_OK
) {

847 
çžed
;

850 
º
->
Çddrs
 = (
u_shÜt
) -1;

851 #ià(
NGX_HAVE_INET6
)

852 
º
->
Çddrs6
 = (
u_shÜt
) -1;

855 ià(
	`ngx_»sÞv”_£nd_qu”y
(
r
, 
º
è!ð
NGX_OK
) {

856 
çžed
;

859 
ùx
->
ev’t
 = 
	`ngx_»sÞv”_ÿÎoc
(
r
, (
ngx_ev’t_t
));

860 ià(
ùx
->
ev’t
 =ð
NULL
) {

861 
çžed
;

864 
ùx
->
ev’t
->
hªdËr
 = 
ngx_»sÞv”_timeout_hªdËr
;

865 
ùx
->
ev’t
->
d©a
 = 
º
;

866 
ùx
->
ev’t
->
log
 = 
r
->log;

867 
º
->
id’t
 = -1;

869 
	`ngx_add_tim”
(
ùx
->
ev’t
, ctx->
timeout
);

871 ià(
	`ngx_queue_em±y
(
»£nd_queue
)) {

872 
	`ngx_add_tim”
(
r
->
ev’t
, (
ngx_m£c_t
èÔ->
»£nd_timeout
 * 1000));

875 
º
->
expœe
 = 
	`ngx_time
(è+ 
r
->
»£nd_timeout
;

877 
	`ngx_queue_š£¹_h—d
(
»£nd_queue
, &
º
->
queue
);

879 
º
->
code
 = 0;

880 
º
->
úËn
 = 0;

881 
º
->
Çme
 = 
NULL
;

882 
º
->
Æ’
 = 0;

883 
º
->
v®id
 = 0;

884 
º
->
‰l
 = 
NGX_MAX_UINT32_VALUE
;

885 
º
->
wa™šg
 = 
ùx
;

889 
ùx
->
¡©e
 = 
NGX_AGAIN
;

891  
NGX_OK
;

893 
çžed
:

895 ià(
º
) {

896 
	`ngx_rbŒ“_d–‘e
(
Œ“
, &
º
->
node
);

898 ià(
º
->
qu”y
) {

899 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
qu”y
);

902 
	`ngx_»sÞv”_ä“
(
r
, 
º
);

907 ià(
ùx
->
ev’t
) {

908 
	`ngx_»sÞv”_ä“
(
r
, 
ùx
->
ev’t
);

911 
	`ngx_»sÞv”_ä“
(
r
, 
ùx
);

913  
NGX_ERROR
;

914 
	}
}

918 
	$ngx_»sÞve_addr_dÚe
(
ngx_»sÞv”_ùx_t
 *
ùx
)

920 
š_addr_t
 
addr
;

921 
ngx_queue_t
 *
expœe_queue
;

922 
ngx_rbŒ“_t
 *
Œ“
;

923 
ngx_»sÞv”_t
 *
r
;

924 
ngx_»sÞv”_ùx_t
 *
w
, **
p
;

925 
sockaddr_š
 *
sš
;

926 
ngx_»sÞv”_node_t
 *
º
;

927 #ià(
NGX_HAVE_INET6
)

928 
ušt32_t
 
hash
;

929 
sockaddr_š6
 *
sš6
;

932 
r
 = 
ùx
->
»sÞv”
;

934 
ùx
->
addr
.
sockaddr
->
§_çmžy
) {

936 #ià(
NGX_HAVE_INET6
)

937 
AF_INET6
:

938 
Œ“
 = &
r
->
addr6_rbŒ“
;

939 
expœe_queue
 = &
r
->
addr6_expœe_queue
;

944 
Œ“
 = &
r
->
addr_rbŒ“
;

945 
expœe_queue
 = &
r
->
addr_expœe_queue
;

948 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

949 "»sÞvadd¸dÚe: %i", 
ùx
->
¡©e
);

951 ià(
ùx
->
ev’t
 && ctx->ev’t->
tim”_£t
) {

952 
	`ngx_d–_tim”
(
ùx
->
ev’t
);

957 ià(
ùx
->
¡©e
 =ð
NGX_AGAIN
) {

959 
ùx
->
addr
.
sockaddr
->
§_çmžy
) {

961 #ià(
NGX_HAVE_INET6
)

962 
AF_INET6
:

963 
sš6
 = (
sockaddr_š6
 *è
ùx
->
addr
.
sockaddr
;

964 
hash
 = 
	`ngx_üc32_shÜt
(
sš6
->
sš6_addr
.
s6_addr
, 16);

965 
º
 = 
	`ngx_»sÞv”_lookup_addr6
(
r
, &
sš6
->
sš6_addr
, 
hash
);

970 
sš
 = (
sockaddr_š
 *è
ùx
->
addr
.
sockaddr
;

971 
addr
 = 
	`Áohl
(
sš
->
sš_addr
.
s_addr
);

972 
º
 = 
	`ngx_»sÞv”_lookup_addr
(
r
, 
addr
);

975 ià(
º
) {

976 
p
 = &
º
->
wa™šg
;

977 
w
 = 
º
->
wa™šg
;

979 
w
) {

980 ià(
w
 =ð
ùx
) {

981 *
p
 = 
w
->
Ãxt
;

983 
dÚe
;

986 
p
 = &
w
->
Ãxt
;

987 
w
 = w->
Ãxt
;

992 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

993 
ngx_¡r_t
 
add¹ext
;

995 
add¹ext
.
d©a
 = 
‹xt
;

996 
add¹ext
.
Ën
 = 
	`ngx_sock_ÁÝ
(
ùx
->
addr
.
sockaddr
, ctx->addr.
sockËn
,

997 
‹xt
, 
NGX_SOCKADDR_STRLEN
, 0);

999 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
log
, 0,

1000 "could‚Ù cªûÈ%V„esÞvšg", &
add¹ext
);

1004 
dÚe
:

1006 
	`ngx_»sÞv”_expœe
(
r
, 
Œ“
, 
expœe_queue
);

1012 ià(
ùx
->
ev’t
) {

1013 
	`ngx_»sÞv”_ä“_locked
(
r
, 
ùx
->
ev’t
);

1016 
	`ngx_»sÞv”_ä“_locked
(
r
, 
ùx
);

1019 
	}
}

1023 
	$ngx_»sÞv”_expœe
(
ngx_»sÞv”_t
 *
r
, 
ngx_rbŒ“_t
 *
Œ“
, 
ngx_queue_t
 *
queue
)

1025 
time_t
 
now
;

1026 
ngx_ušt_t
 
i
;

1027 
ngx_queue_t
 *
q
;

1028 
ngx_»sÞv”_node_t
 *
º
;

1030 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "resolverƒxpire");

1032 
now
 = 
	`ngx_time
();

1034 
i
 = 0; i < 2; i++) {

1035 ià(
	`ngx_queue_em±y
(
queue
)) {

1039 
q
 = 
	`ngx_queue_Ï¡
(
queue
);

1041 
º
 = 
	`ngx_queue_d©a
(
q
, 
ngx_»sÞv”_node_t
, 
queue
);

1043 ià(
now
 <ð
º
->
expœe
) {

1047 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1048 "»sÞv”ƒxpœ\"%*s\"", (
size_t
è
º
->
Æ’
,„n->
Çme
);

1050 
	`ngx_queue_»move
(
q
);

1052 
	`ngx_rbŒ“_d–‘e
(
Œ“
, &
º
->
node
);

1054 
	`ngx_»sÞv”_ä“_node
(
r
, 
º
);

1056 
	}
}

1059 
ngx_št_t


1060 
	$ngx_»sÞv”_£nd_qu”y
(
ngx_»sÞv”_t
 *
r
, 
ngx_»sÞv”_node_t
 *
º
)

1062 
ssize_t
 
n
;

1063 
ngx_udp_cÚÃùiÚ_t
 *
uc
;

1065 
uc
 = 
r
->
udp_cÚÃùiÚs
.
–ts
;

1067 
uc
 = &uc[
r
->
Ï¡_cÚÃùiÚ
++];

1068 ià(
r
->
Ï¡_cÚÃùiÚ
 =ðr->
udp_cÚÃùiÚs
.
ÃÉs
) {

1069 
r
->
Ï¡_cÚÃùiÚ
 = 0;

1072 ià(
uc
->
cÚÃùiÚ
 =ð
NULL
) {

1074 
uc
->
log
 = *
r
->log;

1075 
uc
->
log
.
hªdËr
 = 
ngx_»sÞv”_log_”rÜ
;

1076 
uc
->
log
.
d©a
 = uc;

1077 
uc
->
log
.
aùiÚ
 = "resolving";

1079 ià(
	`ngx_udp_cÚÃù
(
uc
è!ð
NGX_OK
) {

1080  
NGX_ERROR
;

1083 
uc
->
cÚÃùiÚ
->
d©a
 = 
r
;

1084 
uc
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_»sÞv”_»ad_»¥Ú£
;

1085 
uc
->
cÚÃùiÚ
->
»ad
->
»sÞv”
 = 1;

1088 ià(
º
->
Çddrs
 =ð(
u_shÜt
) -1) {

1089 
n
 = 
	`ngx_£nd
(
uc
->
cÚÃùiÚ
, 
º
->
qu”y
,„n->
qËn
);

1091 ià(
n
 == -1) {

1092  
NGX_ERROR
;

1095 ià((
size_t
è
n
 !ð(size_tè
º
->
qËn
) {

1096 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, &
uc
->
log
, 0, "send() incomplete");

1097  
NGX_ERROR
;

1101 #ià(
NGX_HAVE_INET6
)

1102 ià(
º
->
qu”y6
 &&„n->
Çddrs6
 =ð(
u_shÜt
) -1) {

1103 
n
 = 
	`ngx_£nd
(
uc
->
cÚÃùiÚ
, 
º
->
qu”y6
,„n->
qËn
);

1105 ià(
n
 == -1) {

1106  
NGX_ERROR
;

1109 ià((
size_t
è
n
 !ð(size_tè
º
->
qËn
) {

1110 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, &
uc
->
log
, 0, "send() incomplete");

1111  
NGX_ERROR
;

1116  
NGX_OK
;

1117 
	}
}

1121 
	$ngx_»sÞv”_»£nd_hªdËr
(
ngx_ev’t_t
 *
ev
)

1123 
time_t
 
tim”
, 
©im”
, 
Áim”
;

1124 #ià(
NGX_HAVE_INET6
)

1125 
time_t
 
a6tim”
;

1127 
ngx_»sÞv”_t
 *
r
;

1129 
r
 = 
ev
->
d©a
;

1131 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1136 
Áim”
 = 
	`ngx_»sÞv”_»£nd
(
r
, &r->
Çme_rbŒ“
, &r->
Çme_»£nd_queue
);

1142 
©im”
 = 
	`ngx_»sÞv”_»£nd
(
r
, &r->
addr_rbŒ“
, &r->
addr_»£nd_queue
);

1146 #ià(
NGX_HAVE_INET6
)

1150 
a6tim”
 = 
	`ngx_»sÞv”_»£nd
(
r
, &r->
addr6_rbŒ“
, &r->
addr6_»£nd_queue
);

1156 
tim”
 = 
Áim”
;

1158 ià(
tim”
 == 0) {

1159 
tim”
 = 
©im”
;

1161 } ià(
©im”
) {

1162 
tim”
 = 
	`ngx_mš
Ñim”, 
©im”
);

1165 #ià(
NGX_HAVE_INET6
)

1167 ià(
tim”
 == 0) {

1168 
tim”
 = 
a6tim”
;

1170 } ià(
a6tim”
) {

1171 
tim”
 = 
	`ngx_mš
Ñim”, 
a6tim”
);

1176 ià(
tim”
) {

1177 
	`ngx_add_tim”
(
r
->
ev’t
, (
ngx_m£c_t
è(
tim”
 * 1000));

1179 
	}
}

1182 
time_t


1183 
	$ngx_»sÞv”_»£nd
(
ngx_»sÞv”_t
 *
r
, 
ngx_rbŒ“_t
 *
Œ“
, 
ngx_queue_t
 *
queue
)

1185 
time_t
 
now
;

1186 
ngx_queue_t
 *
q
;

1187 
ngx_»sÞv”_node_t
 *
º
;

1189 
now
 = 
	`ngx_time
();

1192 ià(
	`ngx_queue_em±y
(
queue
)) {

1196 
q
 = 
	`ngx_queue_Ï¡
(
queue
);

1198 
º
 = 
	`ngx_queue_d©a
(
q
, 
ngx_»sÞv”_node_t
, 
queue
);

1200 ià(
now
 < 
º
->
expœe
) {

1201  
º
->
expœe
 - 
now
;

1204 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1206 (
size_t
è
º
->
Æ’
,„n->
Çme
,„n->
wa™šg
);

1208 
	`ngx_queue_»move
(
q
);

1210 ià(
º
->
wa™šg
) {

1212 (è
	`ngx_»sÞv”_£nd_qu”y
(
r
, 
º
);

1214 
º
->
expœe
 = 
now
 + 
r
->
»£nd_timeout
;

1216 
	`ngx_queue_š£¹_h—d
(
queue
, 
q
);

1221 
	`ngx_rbŒ“_d–‘e
(
Œ“
, &
º
->
node
);

1223 
	`ngx_»sÞv”_ä“_node
(
r
, 
º
);

1225 
	}
}

1229 
	$ngx_»sÞv”_»ad_»¥Ú£
(
ngx_ev’t_t
 *
»v
)

1231 
ssize_t
 
n
;

1232 
ngx_cÚÃùiÚ_t
 *
c
;

1233 
u_ch¬
 
buf
[
NGX_RESOLVER_UDP_SIZE
];

1235 
c
 = 
»v
->
d©a
;

1238 
n
 = 
	`ngx_udp_»cv
(
c
, 
buf
, 
NGX_RESOLVER_UDP_SIZE
);

1240 ià(
n
 < 0) {

1244 
	`ngx_»sÞv”_´oûss_»¥Ú£
(
c
->
d©a
, 
buf
, 
n
);

1246 } 
»v
->
»ady
);

1247 
	}
}

1251 
	$ngx_»sÞv”_´oûss_»¥Ú£
(
ngx_»sÞv”_t
 *
r
, 
u_ch¬
 *
buf
, 
size_t
 
n
)

1253 *
”r
;

1254 
ngx_ušt_t
 
i
, 
times
, 
id’t
, 
qid’t
, 
æags
, 
code
, 
nqs
, 
Çn
,

1255 
qty³
, 
qþass
;

1256 #ià(
NGX_HAVE_INET6
)

1257 
ngx_ušt_t
 
qid’t6
;

1259 
ngx_queue_t
 *
q
;

1260 
ngx_»sÞv”_qs_t
 *
qs
;

1261 
ngx_»sÞv”_hdr_t
 *
»¥Ú£
;

1262 
ngx_»sÞv”_node_t
 *
º
;

1264 ià(
n
 < (
ngx_»sÞv”_hdr_t
)) {

1265 
shÜt_»¥Ú£
;

1268 
»¥Ú£
 = (
ngx_»sÞv”_hdr_t
 *è
buf
;

1270 
id’t
 = (
»¥Ú£
->
id’t_hi
 << 8è+„e¥Ú£->
id’t_lo
;

1271 
æags
 = (
»¥Ú£
->
æags_hi
 << 8è+„e¥Ú£->
æags_lo
;

1272 
nqs
 = (
»¥Ú£
->
nqs_hi
 << 8è+„e¥Ú£->
nqs_lo
;

1273 
Çn
 = (
»¥Ú£
->
Çn_hi
 << 8è+„e¥Ú£->
Çn_lo
;

1275 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1277 
id’t
, 
æags
, 
nqs
, 
Çn
,

1278 (
»¥Ú£
->
Âs_hi
 << 8è+„e¥Ú£->
Âs_lo
,

1279 (
»¥Ú£
->
Çr_hi
 << 8è+„e¥Ú£->
Çr_lo
);

1282 ià((
æags
 & 0xf870) != 0x8000) {

1283 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1284 "šv®id DNS„e¥Ú£ %u˜æ:%04Xui", 
id’t
, 
æags
);

1288 
code
 = 
æags
 & 0xf;

1290 ià(
code
 =ð
NGX_RESOLVE_FORMERR
) {

1292 
times
 = 0;

1294 
q
 = 
	`ngx_queue_h—d
(&
r
->
Çme_»£nd_queue
);

1295 
q
 !ð
	`ngx_queue_£Áš–
(&
r
->
Çme_»£nd_queue
è|| 
times
++ < 100;

1296 
q
 = 
	`ngx_queue_Ãxt
(q))

1298 
º
 = 
	`ngx_queue_d©a
(
q
, 
ngx_»sÞv”_node_t
, 
queue
);

1299 
qid’t
 = (
º
->
qu”y
[0] << 8) +„n->query[1];

1301 ià(
qid’t
 =ð
id’t
) {

1302 
dns_”rÜ_Çme
;

1305 #ià(
NGX_HAVE_INET6
)

1306 ià(
º
->
qu”y6
) {

1307 
qid’t6
 = (
º
->
qu”y6
[0] << 8) +„n->query6[1];

1309 ià(
qid’t6
 =ð
id’t
) {

1310 
dns_”rÜ_Çme
;

1316 
dns_”rÜ
;

1319 ià(
code
 > 
NGX_RESOLVE_REFUSED
) {

1320 
dns_”rÜ
;

1323 ià(
nqs
 != 1) {

1324 
”r
 = "invalid‚umber of questions in DNS„esponse";

1325 
dÚe
;

1328 
i
 = (
ngx_»sÞv”_hdr_t
);

1330 
i
 < (
ngx_ušt_t
è
n
) {

1331 ià(
buf
[
i
] == '\0') {

1332 
found
;

1335 
i
 +ð1 + 
buf
[i];

1338 
shÜt_»¥Ú£
;

1340 
found
:

1342 ià(
i
++ =ð(
ngx_»sÞv”_hdr_t
)) {

1343 
”r
 = "zero-length domain‚ame in DNS„esponse";

1344 
dÚe
;

1347 ià(
i
 + (
ngx_»sÞv”_qs_t
è+ 
Çn
 * (2 + (
ngx_»sÞv”_ª_t
))

1348 > (
ngx_ušt_t
è
n
)

1350 
shÜt_»¥Ú£
;

1353 
qs
 = (
ngx_»sÞv”_qs_t
 *è&
buf
[
i
];

1355 
qty³
 = (
qs
->
ty³_hi
 << 8è+ qs->
ty³_lo
;

1356 
qþass
 = (
qs
->
þass_hi
 << 8è+ qs->
þass_lo
;

1358 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1359 "»sÞv” DNS„e¥Ú£ qt:%u˜þ:%ui", 
qty³
, 
qþass
);

1361 ià(
qþass
 != 1) {

1362 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1363 "unknowÀqu”y cÏs %u˜š DNS„e¥Ú£", 
qþass
);

1367 
qty³
) {

1369 
NGX_RESOLVE_A
:

1370 #ià(
NGX_HAVE_INET6
)

1371 
NGX_RESOLVE_AAAA
:

1374 
	`ngx_»sÞv”_´oûss_a
(
r
, 
buf
, 
n
, 
id’t
, 
code
, 
qty³
, 
Çn
,

1375 
i
 + (
ngx_»sÞv”_qs_t
));

1379 
NGX_RESOLVE_PTR
:

1381 
	`ngx_»sÞv”_´oûss_±r
(
r
, 
buf
, 
n
, 
id’t
, 
code
, 
Çn
);

1386 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1387 "unknowÀqu”yy³ %u˜š DNS„e¥Ú£", 
qty³
);

1393 
shÜt_»¥Ú£
:

1395 
”r
 = "short DNS„esponse";

1397 
dÚe
:

1399 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0, 
”r
);

1403 
dns_”rÜ_Çme
:

1405 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1407 
code
, 
	`ngx_»sÞv”_¡»¼Ü
(code), 
id’t
,

1408 
º
->
Æ’
,„n->
Çme
);

1411 
dns_”rÜ
:

1413 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1415 
code
, 
	`ngx_»sÞv”_¡»¼Ü
(code), 
id’t
);

1417 
	}
}

1421 
	$ngx_»sÞv”_´oûss_a
(
ngx_»sÞv”_t
 *
r
, 
u_ch¬
 *
buf
, 
size_t
 
Ï¡
,

1422 
ngx_ušt_t
 
id’t
,‚gx_ušt_ˆ
code
,‚gx_ušt_ˆ
qty³
,

1423 
ngx_ušt_t
 
Çn
,‚gx_ušt_ˆ
ªs
)

1425 *
”r
;

1426 
u_ch¬
 *
úame
;

1427 
size_t
 
Ën
;

1428 
št32_t
 
‰l
;

1429 
ušt32_t
 
hash
;

1430 
š_addr_t
 *
addr
;

1431 
ngx_¡r_t
 
Çme
;

1432 
ngx_addr_t
 *
addrs
;

1433 
ngx_ušt_t
 
ty³
, 
þass
, 
qid’t
, 
Çddrs
, 
a
, 
i
, 
n
, 
¡¬t
;

1434 #ià(
NGX_HAVE_INET6
)

1435 
š6_addr
 *
addr6
;

1437 
ngx_»sÞv”_ª_t
 *
ª
;

1438 
ngx_»sÞv”_ùx_t
 *
ùx
, *
Ãxt
;

1439 
ngx_»sÞv”_node_t
 *
º
;

1441 ià(
	`ngx_»sÞv”_cÝy
(
r
, &
Çme
, 
buf
,

1442 
buf
 + (
ngx_»sÞv”_hdr_t
), buà+ 
Ï¡
)

1443 !ð
NGX_OK
)

1448 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "»sÞv” qs:%V", &
Çme
);

1450 
hash
 = 
	`ngx_üc32_shÜt
(
Çme
.
d©a
,‚ame.
Ën
);

1454 
º
 = 
	`ngx_»sÞv”_lookup_Çme
(
r
, &
Çme
, 
hash
);

1456 ià(
º
 =ð
NULL
) {

1457 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1458 "uÃx³ùed„e¥Ú£ fÜ %V", &
Çme
);

1459 
	`ngx_»sÞv”_ä“
(
r
, 
Çme
.
d©a
);

1460 
çžed
;

1463 
qty³
) {

1465 #ià(
NGX_HAVE_INET6
)

1466 
NGX_RESOLVE_AAAA
:

1468 ià(
º
->
qu”y6
 =ð
NULL
 ||„n->
Çddrs6
 !ð(
u_shÜt
) -1) {

1469 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1470 "uÃx³ùed„e¥Ú£ fÜ %V", &
Çme
);

1471 
	`ngx_»sÞv”_ä“
(
r
, 
Çme
.
d©a
);

1472 
çžed
;

1475 
qid’t
 = (
º
->
qu”y6
[0] << 8) +„n->query6[1];

1482 ià(
º
->
qu”y
 =ð
NULL
 ||„n->
Çddrs
 !ð(
u_shÜt
) -1) {

1483 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1484 "uÃx³ùed„e¥Ú£ fÜ %V", &
Çme
);

1485 
	`ngx_»sÞv”_ä“
(
r
, 
Çme
.
d©a
);

1486 
çžed
;

1489 
qid’t
 = (
º
->
qu”y
[0] << 8) +„n->query[1];

1492 ià(
id’t
 !ð
qid’t
) {

1493 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1495 
id’t
, &
Çme
, 
qid’t
);

1496 
	`ngx_»sÞv”_ä“
(
r
, 
Çme
.
d©a
);

1497 
çžed
;

1500 
	`ngx_»sÞv”_ä“
(
r
, 
Çme
.
d©a
);

1502 ià(
code
 =ð0 && 
º
->code) {

1503 
code
 = 
º
->code;

1506 ià(
code
 =ð0 && 
Çn
 == 0) {

1508 #ià(
NGX_HAVE_INET6
)

1509 
qty³
) {

1511 
NGX_RESOLVE_AAAA
:

1513 
º
->
Çddrs6
 = 0;

1515 ià(
º
->
Çddrs
 =ð(
u_shÜt
) -1) {

1516 
Ãxt
;

1519 ià(
º
->
Çddrs
) {

1520 
expÜt
;

1527 
º
->
Çddrs
 = 0;

1529 ià(
º
->
Çddrs6
 =ð(
u_shÜt
) -1) {

1530 
Ãxt
;

1533 ià(
º
->
Çddrs6
) {

1534 
expÜt
;

1539 
code
 = 
NGX_RESOLVE_NXDOMAIN
;

1542 ià(
code
) {

1544 #ià(
NGX_HAVE_INET6
)

1545 
qty³
) {

1547 
NGX_RESOLVE_AAAA
:

1549 
º
->
Çddrs6
 = 0;

1551 ià(
º
->
Çddrs
 =ð(
u_shÜt
) -1) {

1552 
º
->
code
 = (
u_ch¬
) code;

1553 
Ãxt
;

1560 
º
->
Çddrs
 = 0;

1562 ià(
º
->
Çddrs6
 =ð(
u_shÜt
) -1) {

1563 
º
->
code
 = (
u_ch¬
) code;

1564 
Ãxt
;

1569 
Ãxt
 = 
º
->
wa™šg
;

1570 
º
->
wa™šg
 = 
NULL
;

1572 
	`ngx_queue_»move
(&
º
->
queue
);

1574 
	`ngx_rbŒ“_d–‘e
(&
r
->
Çme_rbŒ“
, &
º
->
node
);

1578 
Ãxt
) {

1579 
ùx
 = 
Ãxt
;

1580 
ùx
->
¡©e
 = 
code
;

1581 
Ãxt
 = 
ùx
->next;

1583 
ùx
->
	`hªdËr
(ctx);

1586 
	`ngx_»sÞv”_ä“_node
(
r
, 
º
);

1591 
i
 = 
ªs
;

1592 
Çddrs
 = 0;

1593 
úame
 = 
NULL
;

1595 
a
 = 0;‡ < 
Çn
;‡++) {

1597 
¡¬t
 = 
i
;

1599 
i
 < 
Ï¡
) {

1601 ià(
buf
[
i
] & 0xc0) {

1602 
i
 += 2;

1603 
found
;

1606 ià(
buf
[
i
] == 0) {

1607 
i
++;

1608 
‹¡_Ëngth
;

1611 
i
 +ð1 + 
buf
[i];

1614 
shÜt_»¥Ú£
;

1616 
‹¡_Ëngth
:

1618 ià(
i
 - 
¡¬t
 < 2) {

1619 
”r
 = "invalid‚ame in DNS„esponse";

1620 
šv®id
;

1623 
found
:

1625 ià(
i
 + (
ngx_»sÞv”_ª_t
è>ð
Ï¡
) {

1626 
shÜt_»¥Ú£
;

1629 
ª
 = (
ngx_»sÞv”_ª_t
 *è&
buf
[
i
];

1631 
ty³
 = (
ª
->
ty³_hi
 << 8è+‡n->
ty³_lo
;

1632 
þass
 = (
ª
->
þass_hi
 << 8è+‡n->
þass_lo
;

1633 
Ën
 = (
ª
->
Ën_hi
 << 8è+‡n->
Ën_lo
;

1634 
‰l
 = (
ª
->ttl[0] << 24) + (an->ttl[1] << 16)

1635 + (
ª
->
‰l
[2] << 8) + (an->ttl[3]);

1637 ià(
þass
 != 1) {

1638 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1639 "uÃx³ùed RR cÏs %ui", 
þass
);

1640 
çžed
;

1643 ià(
‰l
 < 0) {

1644 
‰l
 = 0;

1647 
º
->
‰l
 = 
	`ngx_mš
Ôn->‰l, (
ušt32_t
)tl);

1649 
i
 +ð(
ngx_»sÞv”_ª_t
);

1651 
ty³
) {

1653 
NGX_RESOLVE_A
:

1655 ià(
qty³
 !ð
NGX_RESOLVE_A
) {

1656 
”r
 = "unexpected A„ecord in DNS„esponse";

1657 
šv®id
;

1660 ià(
Ën
 != 4) {

1661 
”r
 = "invalid A„ecord in DNS„esponse";

1662 
šv®id
;

1665 ià(
i
 + 4 > 
Ï¡
) {

1666 
shÜt_»¥Ú£
;

1669 
Çddrs
++;

1673 #ià(
NGX_HAVE_INET6
)

1674 
NGX_RESOLVE_AAAA
:

1676 ià(
qty³
 !ð
NGX_RESOLVE_AAAA
) {

1677 
”r
 = "unexpected AAAA„ecord in DNS„esponse";

1678 
šv®id
;

1681 ià(
Ën
 != 16) {

1682 
”r
 = "invalid AAAA„ecord in DNS„esponse";

1683 
šv®id
;

1686 ià(
i
 + 16 > 
Ï¡
) {

1687 
shÜt_»¥Ú£
;

1690 
Çddrs
++;

1695 
NGX_RESOLVE_CNAME
:

1697 
úame
 = &
buf
[
i
];

1701 
NGX_RESOLVE_DNAME
:

1707 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1708 "uÃx³ùed RRy³ %ui", 
ty³
);

1711 
i
 +ð
Ën
;

1714 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1716 
Çddrs
, 
úame
, 
º
->
‰l
);

1718 ià(
Çddrs
) {

1720 
qty³
) {

1722 #ià(
NGX_HAVE_INET6
)

1723 
NGX_RESOLVE_AAAA
:

1725 ià(
Çddrs
 == 1) {

1726 
addr6
 = &
º
->
u6
.addr6;

1727 
º
->
Çddrs6
 = 1;

1730 
addr6
 = 
	`ngx_»sÞv”_®loc
(
r
, 
Çddrs
 * (
š6_addr
));

1731 ià(
addr6
 =ð
NULL
) {

1732 
çžed
;

1735 
º
->
u6
.
addrs6
 = 
addr6
;

1736 
º
->
Çddrs6
 = (
u_shÜt
è
Çddrs
;

1739 #ià(
NGX_SUPPRESS_WARN
)

1740 
addr
 = 
NULL
;

1748 ià(
Çddrs
 == 1) {

1749 
addr
 = &
º
->
u
.addr;

1750 
º
->
Çddrs
 = 1;

1753 
addr
 = 
	`ngx_»sÞv”_®loc
(
r
, 
Çddrs
 * (
š_addr_t
));

1754 ià(
addr
 =ð
NULL
) {

1755 
çžed
;

1758 
º
->
u
.
addrs
 = 
addr
;

1759 
º
->
Çddrs
 = (
u_shÜt
)‚addrs;

1762 #ià(
NGX_HAVE_INET6
 && 
NGX_SUPPRESS_WARN
)

1763 
addr6
 = 
NULL
;

1767 
n
 = 0;

1768 
i
 = 
ªs
;

1770 
a
 = 0;‡ < 
Çn
;‡++) {

1774 ià(
buf
[
i
] & 0xc0) {

1775 
i
 += 2;

1779 ià(
buf
[
i
] == 0) {

1780 
i
++;

1784 
i
 +ð1 + 
buf
[i];

1787 
ª
 = (
ngx_»sÞv”_ª_t
 *è&
buf
[
i
];

1789 
ty³
 = (
ª
->
ty³_hi
 << 8è+‡n->
ty³_lo
;

1790 
Ën
 = (
ª
->
Ën_hi
 << 8è+‡n->
Ën_lo
;

1792 
i
 +ð(
ngx_»sÞv”_ª_t
);

1794 ià(
ty³
 =ð
NGX_RESOLVE_A
) {

1796 
addr
[
n
] = 
	`htÚl
((
buf
[
i
] << 24) + (buf[i + 1] << 16)

1797 + (
buf
[
i
 + 2] << 8) + (buf[i + 3]));

1799 ià(++
n
 =ð
Çddrs
) {

1801 #ià(
NGX_HAVE_INET6
)

1802 ià(
º
->
Çddrs6
 =ð(
u_shÜt
) -1) {

1803 
Ãxt
;

1811 #ià(
NGX_HAVE_INET6
)

1812 ià(
ty³
 =ð
NGX_RESOLVE_AAAA
) {

1814 
	`ngx_memýy
(
addr6
[
n
].
s6_addr
, &
buf
[
i
], 16);

1816 ià(++
n
 =ð
Çddrs
) {

1818 ià(
º
->
Çddrs
 =ð(
u_shÜt
) -1) {

1819 
Ãxt
;

1827 
i
 +ð
Ën
;

1831 
qty³
) {

1833 #ià(
NGX_HAVE_INET6
)

1834 
NGX_RESOLVE_AAAA
:

1836 ià(
º
->
Çddrs6
 =ð(
u_shÜt
) -1) {

1837 
º
->
Çddrs6
 = 0;

1845 ià(
º
->
Çddrs
 =ð(
u_shÜt
) -1) {

1846 
º
->
Çddrs
 = 0;

1850 ià(
º
->
Çddrs
 !ð(
u_shÜt
) -1

1851 #ià(
NGX_HAVE_INET6
)

1852 && 
º
->
Çddrs6
 !ð(
u_shÜt
) -1

1854 && 
º
->
Çddrs


1855 #ià(
NGX_HAVE_INET6
)

1856 + 
º
->
Çddrs6


1861 #ià(
NGX_HAVE_INET6
)

1862 
expÜt
:

1865 
Çddrs
 = 
º
->naddrs;

1866 #ià(
NGX_HAVE_INET6
)

1867 
Çddrs
 +ð
º
->
Çddrs6
;

1870 ià(
Çddrs
 =ð1 && 
º
->naddrs == 1) {

1871 
addrs
 = 
NULL
;

1874 
addrs
 = 
	`ngx_»sÞv”_expÜt
(
r
, 
º
, 0);

1875 ià(
addrs
 =ð
NULL
) {

1876 
çžed
;

1880 
	`ngx_queue_»move
(&
º
->
queue
);

1882 
º
->
v®id
 = 
	`ngx_time
(è+ (
r
->v®id ?„->v®id : (
time_t
èº->
‰l
);

1883 
º
->
expœe
 = 
	`ngx_time
(è+ 
r
->expire;

1885 
	`ngx_queue_š£¹_h—d
(&
r
->
Çme_expœe_queue
, &
º
->
queue
);

1887 
Ãxt
 = 
º
->
wa™šg
;

1888 
º
->
wa™šg
 = 
NULL
;

1892 
Ãxt
) {

1893 
ùx
 = 
Ãxt
;

1894 
ùx
->
¡©e
 = 
NGX_OK
;

1895 
ùx
->
Çddrs
 =‚addrs;

1897 ià(
addrs
 =ð
NULL
) {

1898 
ùx
->
addrs
 = &ùx->
addr
;

1899 
ùx
->
addr
.
sockaddr
 = (sockadd¸*è&ùx->
sš
;

1900 
ùx
->
addr
.
sockËn
 = (
sockaddr_š
);

1901 
	`ngx_memz”o
(&
ùx
->
sš
, (
sockaddr_š
));

1902 
ùx
->
sš
.
sš_çmžy
 = 
AF_INET
;

1903 
ùx
->
sš
.
sš_addr
.
s_addr
 = 
º
->
u
.
addr
;

1906 
ùx
->
addrs
 =‡ddrs;

1909 
Ãxt
 = 
ùx
->next;

1911 
ùx
->
	`hªdËr
(ctx);

1914 ià(
addrs
 !ð
NULL
) {

1915 
	`ngx_»sÞv”_ä“
(
r
, 
addrs
->
sockaddr
);

1916 
	`ngx_»sÞv”_ä“
(
r
, 
addrs
);

1919 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
qu”y
);

1920 
º
->
qu”y
 = 
NULL
;

1921 #ià(
NGX_HAVE_INET6
)

1922 
º
->
qu”y6
 = 
NULL
;

1928 ià(
úame
) {

1932 ià(
º
->
Çddrs
 =ð(
u_shÜt
) -1

1933 #ià(
NGX_HAVE_INET6
)

1934 || 
º
->
Çddrs6
 =ð(
u_shÜt
) -1

1938 
Ãxt
;

1941 ià(
	`ngx_»sÞv”_cÝy
(
r
, &
Çme
, 
buf
, 
úame
, buà+ 
Ï¡
è!ð
NGX_OK
) {

1942 
çžed
;

1945 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1946 "»sÞv” cÇme:\"%V\"", &
Çme
);

1948 
	`ngx_queue_»move
(&
º
->
queue
);

1950 
º
->
úËn
 = (
u_shÜt
è
Çme
.
Ën
;

1951 
º
->
u
.
úame
 = 
Çme
.
d©a
;

1953 
º
->
v®id
 = 
	`ngx_time
(è+ (
r
->v®id ?„->v®id : (
time_t
èº->
‰l
);

1954 
º
->
expœe
 = 
	`ngx_time
(è+ 
r
->expire;

1956 
	`ngx_queue_š£¹_h—d
(&
r
->
Çme_expœe_queue
, &
º
->
queue
);

1958 
ùx
 = 
º
->
wa™šg
;

1959 
º
->
wa™šg
 = 
NULL
;

1961 ià(
ùx
) {

1962 
ùx
->
Çme
 =‚ame;

1964 (è
	`ngx_»sÞve_Çme_locked
(
r
, 
ùx
);

1967 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
qu”y
);

1968 
º
->
qu”y
 = 
NULL
;

1969 #ià(
NGX_HAVE_INET6
)

1970 
º
->
qu”y6
 = 
NULL
;

1978 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

1982 
shÜt_»¥Ú£
:

1984 
”r
 = "short DNS„esponse";

1986 
šv®id
:

1990 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0, 
”r
);

1994 
çžed
:

1996 
Ãxt
:

2001 
	}
}

2005 
	$ngx_»sÞv”_´oûss_±r
(
ngx_»sÞv”_t
 *
r
, 
u_ch¬
 *
buf
, 
size_t
 
n
,

2006 
ngx_ušt_t
 
id’t
,‚gx_ušt_ˆ
code
,‚gx_ušt_ˆ
Çn
)

2008 *
”r
;

2009 
size_t
 
Ën
;

2010 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

2011 
š_addr_t
 
addr
;

2012 
št32_t
 
‰l
;

2013 
ngx_št_t
 
où‘
;

2014 
ngx_¡r_t
 
Çme
;

2015 
ngx_ušt_t
 
i
, 
mask
, 
qid’t
, 
þass
;

2016 
ngx_queue_t
 *
expœe_queue
;

2017 
ngx_rbŒ“_t
 *
Œ“
;

2018 
ngx_»sÞv”_ª_t
 *
ª
;

2019 
ngx_»sÞv”_ùx_t
 *
ùx
, *
Ãxt
;

2020 
ngx_»sÞv”_node_t
 *
º
;

2021 #ià(
NGX_HAVE_INET6
)

2022 
ušt32_t
 
hash
;

2023 
ngx_št_t
 
dig™
;

2024 
š6_addr
 
addr6
;

2027 ià(
	`ngx_»sÞv”_cÝy
(
r
, 
NULL
, 
buf
,

2028 
buf
 + (
ngx_»sÞv”_hdr_t
), buà+ 
n
)

2029 !ð
NGX_OK
)

2036 
addr
 = 0;

2037 
i
 = (
ngx_»sÞv”_hdr_t
);

2039 
mask
 = 0; mask < 32; mask += 8) {

2040 
Ën
 = 
buf
[
i
++];

2042 
où‘
 = 
	`ngx_©oi
(&
buf
[
i
], 
Ën
);

2043 ià(
où‘
 =ð
NGX_ERROR
 || octet > 255) {

2044 
šv®id_š_addr_¬·
;

2047 
addr
 +ð
où‘
 << 
mask
;

2048 
i
 +ð
Ën
;

2051 ià(
	`ngx_¡rÿ£cmp
(&
buf
[
i
], (
u_ch¬
 *) "\7in-addr\4arpa") == 0) {

2052 
i
 += ("\7in-addr\4arpa");

2056 
º
 = 
	`ngx_»sÞv”_lookup_addr
(
r
, 
addr
);

2058 
Œ“
 = &
r
->
addr_rbŒ“
;

2059 
expœe_queue
 = &
r
->
addr_expœe_queue
;

2061 
addr
 = 
	`htÚl
(addr);

2062 
Çme
.
Ën
 = 
	`ngx_š‘_ÁÝ
(
AF_INET
, &
addr
, 
‹xt
, 
NGX_SOCKADDR_STRLEN
);

2063 
Çme
.
d©a
 = 
‹xt
;

2065 
v®id
;

2068 
šv®id_š_addr_¬·
:

2070 #ià(
NGX_HAVE_INET6
)

2072 
i
 = (
ngx_»sÞv”_hdr_t
);

2074 
où‘
 = 15; octet >= 0; octet--) {

2075 ià(
buf
[
i
++] != '\1') {

2076 
šv®id_6_¬·
;

2079 
dig™
 = 
	`ngx_hextoi
(&
buf
[
i
++], 1);

2080 ià(
dig™
 =ð
NGX_ERROR
) {

2081 
šv®id_6_¬·
;

2084 
addr6
.
s6_addr
[
où‘
] = (
u_ch¬
è
dig™
;

2086 ià(
buf
[
i
++] != '\1') {

2087 
šv®id_6_¬·
;

2090 
dig™
 = 
	`ngx_hextoi
(&
buf
[
i
++], 1);

2091 ià(
dig™
 =ð
NGX_ERROR
) {

2092 
šv®id_6_¬·
;

2095 
addr6
.
s6_addr
[
où‘
] +ð(
u_ch¬
è(
dig™
 * 16);

2098 ià(
	`ngx_¡rÿ£cmp
(&
buf
[
i
], (
u_ch¬
 *) "\3ip6\4arpa") == 0) {

2099 
i
 += ("\3ip6\4arpa");

2103 
hash
 = 
	`ngx_üc32_shÜt
(
addr6
.
s6_addr
, 16);

2104 
º
 = 
	`ngx_»sÞv”_lookup_addr6
(
r
, &
addr6
, 
hash
);

2106 
Œ“
 = &
r
->
addr6_rbŒ“
;

2107 
expœe_queue
 = &
r
->
addr6_expœe_queue
;

2109 
Çme
.
Ën
 = 
	`ngx_š‘6_ÁÝ
(
addr6
.
s6_addr
, 
‹xt
, 
NGX_SOCKADDR_STRLEN
);

2110 
Çme
.
d©a
 = 
‹xt
;

2112 
v®id
;

2115 
šv®id_6_¬·
:

2118 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

2122 
v®id
:

2124 ià(
º
 =ð
NULL
 ||„n->
qu”y
 == NULL) {

2125 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

2126 "uÃx³ùed„e¥Ú£ fÜ %V", &
Çme
);

2127 
çžed
;

2130 
qid’t
 = (
º
->
qu”y
[0] << 8) +„n->query[1];

2132 ià(
id’t
 !ð
qid’t
) {

2133 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

2135 
id’t
, &
Çme
, 
qid’t
);

2136 
çžed
;

2139 ià(
code
 =ð0 && 
Çn
 == 0) {

2140 
code
 = 
NGX_RESOLVE_NXDOMAIN
;

2143 ià(
code
) {

2144 
Ãxt
 = 
º
->
wa™šg
;

2145 
º
->
wa™šg
 = 
NULL
;

2147 
	`ngx_queue_»move
(&
º
->
queue
);

2149 
	`ngx_rbŒ“_d–‘e
(
Œ“
, &
º
->
node
);

2153 
Ãxt
) {

2154 
ùx
 = 
Ãxt
;

2155 
ùx
->
¡©e
 = 
code
;

2156 
Ãxt
 = 
ùx
->next;

2158 
ùx
->
	`hªdËr
(ctx);

2161 
	`ngx_»sÞv”_ä“_node
(
r
, 
º
);

2166 
i
 +ð(
ngx_»sÞv”_qs_t
);

2168 ià(
i
 + 2 + (
ngx_»sÞv”_ª_t
è>ð
n
) {

2169 
shÜt_»¥Ú£
;

2174 ià(
buf
[
i
] !ð0xc0 || buf[˜+ 1] !ð(
ngx_»sÞv”_hdr_t
)) {

2175 
”r
 = "invalid in-addr.arpa or ip6.arpa‚ame in DNS„esponse";

2176 
šv®id
;

2179 
ª
 = (
ngx_»sÞv”_ª_t
 *è&
buf
[
i
 + 2];

2181 
þass
 = (
ª
->
þass_hi
 << 8è+‡n->
þass_lo
;

2182 
Ën
 = (
ª
->
Ën_hi
 << 8è+‡n->
Ën_lo
;

2183 
‰l
 = (
ª
->ttl[0] << 24) + (an->ttl[1] << 16)

2184 + (
ª
->
‰l
[2] << 8) + (an->ttl[3]);

2186 ià(
þass
 != 1) {

2187 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0,

2188 "uÃx³ùed RR cÏs %ui", 
þass
);

2189 
çžed
;

2192 ià(
‰l
 < 0) {

2193 
‰l
 = 0;

2196 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

2198 (
ª
->
ty³_hi
 << 8è+‡n->
ty³_lo
,

2199 
þass
, 
Ën
);

2201 
i
 +ð2 + (
ngx_»sÞv”_ª_t
);

2203 ià(
i
 + 
Ën
 > 
n
) {

2204 
shÜt_»¥Ú£
;

2207 ià(
	`ngx_»sÞv”_cÝy
(
r
, &
Çme
, 
buf
, buà+ 
i
, buà+ 
n
è!ð
NGX_OK
) {

2208 
çžed
;

2211 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "»sÞv”‡n:%V", &
Çme
);

2213 ià(
Çme
.
Ën
 !ð(
size_t
è
º
->
Æ’


2214 || 
	`ngx_¡ºcmp
(
Çme
.
d©a
, 
º
->Çme,‚ame.
Ën
) != 0)

2216 ià(
º
->
Æ’
) {

2217 
	`ngx_»sÞv”_ä“
(
r
, 
º
->
Çme
);

2220 
º
->
Æ’
 = (
u_shÜt
è
Çme
.
Ën
;

2221 
º
->
Çme
 =‚ame.
d©a
;

2223 
Çme
.
d©a
 = 
	`ngx_»sÞv”_dup
(
r
, 
º
->Çme,‚ame.
Ën
);

2224 ià(
Çme
.
d©a
 =ð
NULL
) {

2225 
çžed
;

2229 
	`ngx_queue_»move
(&
º
->
queue
);

2231 
º
->
v®id
 = 
	`ngx_time
(è+ (
r
->v®id ?„->v®id : 
‰l
);

2232 
º
->
expœe
 = 
	`ngx_time
(è+ 
r
->expire;

2234 
	`ngx_queue_š£¹_h—d
(
expœe_queue
, &
º
->
queue
);

2236 
Ãxt
 = 
º
->
wa™šg
;

2237 
º
->
wa™šg
 = 
NULL
;

2241 
Ãxt
) {

2242 
ùx
 = 
Ãxt
;

2243 
ùx
->
¡©e
 = 
NGX_OK
;

2244 
ùx
->
Çme
 =‚ame;

2245 
Ãxt
 = 
ùx
->next;

2247 
ùx
->
	`hªdËr
(ctx);

2250 
	`ngx_»sÞv”_ä“
(
r
, 
Çme
.
d©a
);

2254 
shÜt_»¥Ú£
:

2256 
”r
 = "short DNS„esponse";

2258 
šv®id
:

2262 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0, 
”r
);

2266 
çžed
:

2271 
	}
}

2274 
ngx_»sÞv”_node_t
 *

2275 
	$ngx_»sÞv”_lookup_Çme
(
ngx_»sÞv”_t
 *
r
, 
ngx_¡r_t
 *
Çme
, 
ušt32_t
 
hash
)

2277 
ngx_št_t
 
rc
;

2278 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

2279 
ngx_»sÞv”_node_t
 *
º
;

2281 
node
 = 
r
->
Çme_rbŒ“
.
roÙ
;

2282 
£Áš–
 = 
r
->
Çme_rbŒ“
.sentinel;

2284 
node
 !ð
£Áš–
) {

2286 ià(
hash
 < 
node
->
key
) {

2287 
node
 =‚ode->
Ëá
;

2291 ià(
hash
 > 
node
->
key
) {

2292 
node
 =‚ode->
right
;

2298 
º
 = 
	`ngx_»sÞv”_node
(
node
);

2300 
rc
 = 
	`ngx_memn2cmp
(
Çme
->
d©a
, 
º
->Çme,‚ame->
Ën
,„n->
Æ’
);

2302 ià(
rc
 == 0) {

2303  
º
;

2306 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

2311  
NULL
;

2312 
	}
}

2315 
ngx_»sÞv”_node_t
 *

2316 
	$ngx_»sÞv”_lookup_addr
(
ngx_»sÞv”_t
 *
r
, 
š_addr_t
 
addr
)

2318 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

2320 
node
 = 
r
->
addr_rbŒ“
.
roÙ
;

2321 
£Áš–
 = 
r
->
addr_rbŒ“
.sentinel;

2323 
node
 !ð
£Áš–
) {

2325 ià(
addr
 < 
node
->
key
) {

2326 
node
 =‚ode->
Ëá
;

2330 ià(
addr
 > 
node
->
key
) {

2331 
node
 =‚ode->
right
;

2337  
	`ngx_»sÞv”_node
(
node
);

2342  
NULL
;

2343 
	}
}

2346 #ià(
NGX_HAVE_INET6
)

2348 
ngx_»sÞv”_node_t
 *

2349 
	$ngx_»sÞv”_lookup_addr6
(
ngx_»sÞv”_t
 *
r
, 
š6_addr
 *
addr
,

2350 
ušt32_t
 
hash
)

2352 
ngx_št_t
 
rc
;

2353 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

2354 
ngx_»sÞv”_node_t
 *
º
;

2356 
node
 = 
r
->
addr6_rbŒ“
.
roÙ
;

2357 
£Áš–
 = 
r
->
addr6_rbŒ“
.sentinel;

2359 
node
 !ð
£Áš–
) {

2361 ià(
hash
 < 
node
->
key
) {

2362 
node
 =‚ode->
Ëá
;

2366 ià(
hash
 > 
node
->
key
) {

2367 
node
 =‚ode->
right
;

2373 
º
 = 
	`ngx_»sÞv”_node
(
node
);

2375 
rc
 = 
	`ngx_memcmp
(
addr
, &
º
->
addr6
, 16);

2377 ià(
rc
 == 0) {

2378  
º
;

2381 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

2386  
NULL
;

2387 
	}
}

2393 
	$ngx_»sÞv”_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

2394 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
)

2396 
ngx_rbŒ“_node_t
 **
p
;

2397 
ngx_»sÞv”_node_t
 *
º
, *
º_‹mp
;

2401 ià(
node
->
key
 < 
‹mp
->key) {

2403 
p
 = &
‹mp
->
Ëá
;

2405 } ià(
node
->
key
 > 
‹mp
->key) {

2407 
p
 = &
‹mp
->
right
;

2411 
º
 = 
	`ngx_»sÞv”_node
(
node
);

2412 
º_‹mp
 = 
	`ngx_»sÞv”_node
(
‹mp
);

2414 
p
 = (
	`ngx_memn2cmp
(
º
->
Çme
, 
º_‹mp
->Çme,„n->
Æ’
,„n_temp->nlen)

2415 < 0è? &
‹mp
->
Ëá
 : &‹mp->
right
;

2418 ià(*
p
 =ð
£Áš–
) {

2422 
‹mp
 = *
p
;

2425 *
p
 = 
node
;

2426 
node
->
·»Á
 = 
‹mp
;

2427 
node
->
Ëá
 = 
£Áš–
;

2428 
node
->
right
 = 
£Áš–
;

2429 
	`ngx_rbt_»d
(
node
);

2430 
	}
}

2433 #ià(
NGX_HAVE_INET6
)

2436 
	$ngx_»sÞv”_rbŒ“_š£¹_addr6_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

2437 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
)

2439 
ngx_rbŒ“_node_t
 **
p
;

2440 
ngx_»sÞv”_node_t
 *
º
, *
º_‹mp
;

2444 ià(
node
->
key
 < 
‹mp
->key) {

2446 
p
 = &
‹mp
->
Ëá
;

2448 } ià(
node
->
key
 > 
‹mp
->key) {

2450 
p
 = &
‹mp
->
right
;

2454 
º
 = 
	`ngx_»sÞv”_node
(
node
);

2455 
º_‹mp
 = 
	`ngx_»sÞv”_node
(
‹mp
);

2457 
p
 = (
	`ngx_memcmp
(&
º
->
addr6
, &
º_‹mp
->addr6, 16)

2458 < 0è? &
‹mp
->
Ëá
 : &‹mp->
right
;

2461 ià(*
p
 =ð
£Áš–
) {

2465 
‹mp
 = *
p
;

2468 *
p
 = 
node
;

2469 
node
->
·»Á
 = 
‹mp
;

2470 
node
->
Ëá
 = 
£Áš–
;

2471 
node
->
right
 = 
£Áš–
;

2472 
	`ngx_rbt_»d
(
node
);

2473 
	}
}

2478 
ngx_št_t


2479 
	$ngx_»sÞv”_ü—‹_Çme_qu”y
(
ngx_»sÞv”_node_t
 *
º
, 
ngx_»sÞv”_ùx_t
 *
ùx
)

2481 
u_ch¬
 *
p
, *
s
;

2482 
size_t
 
Ën
, 
Æ’
;

2483 
ngx_ušt_t
 
id’t
;

2484 #ià(
NGX_HAVE_INET6
)

2485 
ngx_»sÞv”_t
 *
r
;

2487 
ngx_»sÞv”_qs_t
 *
qs
;

2488 
ngx_»sÞv”_hdr_t
 *
qu”y
;

2490 
Æ’
 = 
ùx
->
Çme
.
Ën
 ? (1 + ctx->name.len + 1) : 1;

2492 
Ën
 = (
ngx_»sÞv”_hdr_t
è+ 
Æ’
 + (
ngx_»sÞv”_qs_t
);

2494 #ià(
NGX_HAVE_INET6
)

2495 
r
 = 
ùx
->
»sÞv”
;

2497 
p
 = 
	`ngx_»sÞv”_®loc
(
ùx
->
»sÞv”
, 
r
->
v6
 ? 
Ën
 * 2 :†en);

2499 
p
 = 
	`ngx_»sÞv”_®loc
(
ùx
->
»sÞv”
, 
Ën
);

2501 ià(
p
 =ð
NULL
) {

2502  
NGX_ERROR
;

2505 
º
->
qËn
 = (
u_shÜt
è
Ën
;

2506 
º
->
qu”y
 = 
p
;

2508 #ià(
NGX_HAVE_INET6
)

2509 ià(
r
->
v6
) {

2510 
º
->
qu”y6
 = 
p
 + 
Ën
;

2514 
qu”y
 = (
ngx_»sÞv”_hdr_t
 *è
p
;

2516 
id’t
 = 
	`ngx_¿ndom
();

2518 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
ùx
->
»sÞv”
->
log
, 0,

2519 "»sÞve: \"%V\" A %i", &
ùx
->
Çme
, 
id’t
 & 0xffff);

2521 
qu”y
->
id’t_hi
 = (
u_ch¬
è((
id’t
 >> 8) & 0xff);

2522 
qu”y
->
id’t_lo
 = (
u_ch¬
è(
id’t
 & 0xff);

2525 
qu”y
->
æags_hi
 = 1; qu”y->
æags_lo
 = 0;

2528 
qu”y
->
nqs_hi
 = 0; qu”y->
nqs_lo
 = 1;

2529 
qu”y
->
Çn_hi
 = 0; qu”y->
Çn_lo
 = 0;

2530 
qu”y
->
Âs_hi
 = 0; qu”y->
Âs_lo
 = 0;

2531 
qu”y
->
Çr_hi
 = 0; qu”y->
Çr_lo
 = 0;

2533 
p
 +ð(
ngx_»sÞv”_hdr_t
è+ 
Æ’
;

2535 
qs
 = (
ngx_»sÞv”_qs_t
 *è
p
;

2538 
qs
->
ty³_hi
 = 0; qs->
ty³_lo
 = 
NGX_RESOLVE_A
;

2541 
qs
->
þass_hi
 = 0; qs->
þass_lo
 = 1;

2545 
Ën
 = 0;

2546 
p
--;

2547 *
p
-- = '\0';

2549 ià(
ùx
->
Çme
.
Ën
 == 0) {

2550  
NGX_DECLINED
;

2553 
s
 = 
ùx
->
Çme
.
d©a
 + ctx->Çme.
Ën
 - 1; s >= ctx->name.data; s--) {

2554 ià(*
s
 != '.') {

2555 *
p
 = *
s
;

2556 
Ën
++;

2559 ià(
Ën
 == 0 ||†en > 255) {

2560  
NGX_DECLINED
;

2563 *
p
 = (
u_ch¬
è
Ën
;

2564 
Ën
 = 0;

2567 
p
--;

2570 ià(
Ën
 == 0 ||†en > 255) {

2571  
NGX_DECLINED
;

2574 *
p
 = (
u_ch¬
è
Ën
;

2576 #ià(
NGX_HAVE_INET6
)

2577 ià(!
r
->
v6
) {

2578  
NGX_OK
;

2581 
p
 = 
º
->
qu”y6
;

2583 
	`ngx_memýy
(
p
, 
º
->
qu”y
,„n->
qËn
);

2585 
qu”y
 = (
ngx_»sÞv”_hdr_t
 *è
p
;

2587 
id’t
 = 
	`ngx_¿ndom
();

2589 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
ùx
->
»sÞv”
->
log
, 0,

2590 "»sÞve: \"%V\" AAAA %i", &
ùx
->
Çme
, 
id’t
 & 0xffff);

2592 
qu”y
->
id’t_hi
 = (
u_ch¬
è((
id’t
 >> 8) & 0xff);

2593 
qu”y
->
id’t_lo
 = (
u_ch¬
è(
id’t
 & 0xff);

2595 
p
 +ð(
ngx_»sÞv”_hdr_t
è+ 
Æ’
;

2597 
qs
 = (
ngx_»sÞv”_qs_t
 *è
p
;

2599 
qs
->
ty³_lo
 = 
NGX_RESOLVE_AAAA
;

2602  
NGX_OK
;

2603 
	}
}

2606 
ngx_št_t


2607 
	$ngx_»sÞv”_ü—‹_addr_qu”y
(
ngx_»sÞv”_node_t
 *
º
, 
ngx_»sÞv”_ùx_t
 *
ùx
)

2609 
u_ch¬
 *
p
, *
d
;

2610 
size_t
 
Ën
;

2611 
š_addr_t
 
addr
;

2612 
ngx_št_t
 
n
;

2613 
ngx_ušt_t
 
id’t
;

2614 
ngx_»sÞv”_hdr_t
 *
qu”y
;

2615 
sockaddr_š
 *
sš
;

2616 #ià(
NGX_HAVE_INET6
)

2617 
sockaddr_š6
 *
sš6
;

2620 
ùx
->
addr
.
sockaddr
->
§_çmžy
) {

2622 #ià(
NGX_HAVE_INET6
)

2623 
AF_INET6
:

2624 
Ën
 = (
ngx_»sÞv”_hdr_t
)

2626 + (
ngx_»sÞv”_qs_t
);

2632 
Ën
 = (
ngx_»sÞv”_hdr_t
)

2634 + (
ngx_»sÞv”_qs_t
);

2637 
p
 = 
	`ngx_»sÞv”_®loc
(
ùx
->
»sÞv”
, 
Ën
);

2638 ià(
p
 =ð
NULL
) {

2639  
NGX_ERROR
;

2642 
º
->
qu”y
 = 
p
;

2643 
qu”y
 = (
ngx_»sÞv”_hdr_t
 *è
p
;

2645 
id’t
 = 
	`ngx_¿ndom
();

2647 
qu”y
->
id’t_hi
 = (
u_ch¬
è((
id’t
 >> 8) & 0xff);

2648 
qu”y
->
id’t_lo
 = (
u_ch¬
è(
id’t
 & 0xff);

2651 
qu”y
->
æags_hi
 = 1; qu”y->
æags_lo
 = 0;

2654 
qu”y
->
nqs_hi
 = 0; qu”y->
nqs_lo
 = 1;

2655 
qu”y
->
Çn_hi
 = 0; qu”y->
Çn_lo
 = 0;

2656 
qu”y
->
Âs_hi
 = 0; qu”y->
Âs_lo
 = 0;

2657 
qu”y
->
Çr_hi
 = 0; qu”y->
Çr_lo
 = 0;

2659 
p
 +ð(
ngx_»sÞv”_hdr_t
);

2661 
ùx
->
addr
.
sockaddr
->
§_çmžy
) {

2663 #ià(
NGX_HAVE_INET6
)

2664 
AF_INET6
:

2665 
sš6
 = (
sockaddr_š6
 *è
ùx
->
addr
.
sockaddr
;

2667 
n
 = 15;‚ >= 0;‚--) {

2668 
p
 = 
	`ngx_¥rštf
(p, "\1%xd\1%xd",

2669 
sš6
->
sš6_addr
.
s6_addr
[
n
] & 0xf,

2670 (
sš6
->
sš6_addr
.
s6_addr
[
n
] >> 4) & 0xf);

2673 
p
 = 
	`ngx_ýymem
(p, "\3ip6\4arpa\0", 10);

2680 
sš
 = (
sockaddr_š
 *è
ùx
->
addr
.
sockaddr
;

2681 
addr
 = 
	`Áohl
(
sš
->
sš_addr
.
s_addr
);

2683 
n
 = 0;‚ < 32;‚ += 8) {

2684 
d
 = 
	`ngx_¥rštf
(&
p
[1], "%ud", (
addr
 >> 
n
) & 0xff);

2685 *
p
 = (
u_ch¬
è(
d
 - &p[1]);

2686 
p
 = 
d
;

2689 
p
 = 
	`ngx_ýymem
(p, "\7in-addr\4arpa\0", 14);

2693 
p
 = 
	`ngx_ýymem
(p, "\0\14\0\1", 4);

2695 
º
->
qËn
 = (
u_shÜt
è(
p
 -„n->
qu”y
);

2697  
NGX_OK
;

2698 
	}
}

2701 
ngx_št_t


2702 
	$ngx_»sÞv”_cÝy
(
ngx_»sÞv”_t
 *
r
, 
ngx_¡r_t
 *
Çme
, 
u_ch¬
 *
buf
, u_ch¬ *
¤c
,

2703 
u_ch¬
 *
Ï¡
)

2705 *
”r
;

2706 
u_ch¬
 *
p
, *
d¡
;

2707 
ssize_t
 
Ën
;

2708 
ngx_ušt_t
 
i
, 
n
;

2710 
p
 = 
¤c
;

2711 
Ën
 = -1;

2718 
i
 = 0; i < 128; i++) {

2719 
n
 = *
p
++;

2721 ià(
n
 == 0) {

2722 
dÚe
;

2725 ià(
n
 & 0xc0) {

2726 
n
 = (Ò & 0x3fè<< 8è+ *
p
;

2727 
p
 = &
buf
[
n
];

2730 
Ën
 +ð1 + 
n
;

2731 
p
 = &p[
n
];

2734 ià(
p
 >ð
Ï¡
) {

2735 
”r
 = "name is out of„esponse";

2736 
šv®id
;

2740 
”r
 = "compression…ointers†oop";

2742 
šv®id
:

2744 
	`ngx_log_”rÜ
(
r
->
log_Ëv–
,„->
log
, 0, 
”r
);

2746  
NGX_ERROR
;

2748 
dÚe
:

2750 ià(
Çme
 =ð
NULL
) {

2751  
NGX_OK
;

2754 ià(
Ën
 == -1) {

2755 
	`ngx_¡r_nuÎ
(
Çme
);

2756  
NGX_OK
;

2759 
d¡
 = 
	`ngx_»sÞv”_®loc
(
r
, 
Ën
);

2760 ià(
d¡
 =ð
NULL
) {

2761  
NGX_ERROR
;

2764 
Çme
->
d©a
 = 
d¡
;

2766 
n
 = *
¤c
++;

2769 ià(
n
 & 0xc0) {

2770 
n
 = (Ò & 0x3fè<< 8è+ *
¤c
;

2771 
¤c
 = &
buf
[
n
];

2773 
n
 = *
¤c
++;

2776 
	`ngx_¡¾ow
(
d¡
, 
¤c
, 
n
);

2777 
d¡
 +ð
n
;

2778 
¤c
 +ð
n
;

2780 
n
 = *
¤c
++;

2782 ià(
n
 != 0) {

2783 *
d¡
++ = '.';

2787 ià(
n
 == 0) {

2788 
Çme
->
Ën
 = 
d¡
 -‚ame->
d©a
;

2789  
NGX_OK
;

2792 
	}
}

2796 
	$ngx_»sÞv”_timeout_hªdËr
(
ngx_ev’t_t
 *
ev
)

2798 
ngx_»sÞv”_ùx_t
 *
ùx
, *
Ãxt
;

2799 
ngx_»sÞv”_node_t
 *
º
;

2801 
º
 = 
ev
->
d©a
;

2802 
ùx
 = 
º
->
wa™šg
;

2803 
º
->
wa™šg
 = 
NULL
;

2806 
ùx
->
¡©e
 = 
NGX_RESOLVE_TIMEDOUT
;

2807 
Ãxt
 = 
ùx
->next;

2809 
ùx
->
	`hªdËr
(ctx);

2811 
ùx
 = 
Ãxt
;

2812 } 
ùx
);

2813 
	}
}

2817 
	$ngx_»sÞv”_ä“_node
(
ngx_»sÞv”_t
 *
r
, 
ngx_»sÞv”_node_t
 *
º
)

2821 ià(
º
->
qu”y
) {

2822 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
qu”y
);

2825 ià(
º
->
Çme
) {

2826 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
Çme
);

2829 ià(
º
->
úËn
) {

2830 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
u
.
úame
);

2833 ià(
º
->
Çddrs
 > 1 &&„n->Çddr !ð(
u_shÜt
) -1) {

2834 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
u
.
addrs
);

2837 #ià(
NGX_HAVE_INET6
)

2838 ià(
º
->
Çddrs6
 > 1 &&„n->Çddrs6 !ð(
u_shÜt
) -1) {

2839 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
->
u6
.
addrs6
);

2843 
	`ngx_»sÞv”_ä“_locked
(
r
, 
º
);

2846 
	}
}

2850 
	$ngx_»sÞv”_®loc
(
ngx_»sÞv”_t
 *
r
, 
size_t
 
size
)

2852 
u_ch¬
 *
p
;

2856 
p
 = 
	`ngx_®loc
(
size
, 
r
->
log
);

2860  
p
;

2861 
	}
}

2865 
	$ngx_»sÞv”_ÿÎoc
(
ngx_»sÞv”_t
 *
r
, 
size_t
 
size
)

2867 
u_ch¬
 *
p
;

2869 
p
 = 
	`ngx_»sÞv”_®loc
(
r
, 
size
);

2871 ià(
p
) {

2872 
	`ngx_memz”o
(
p
, 
size
);

2875  
p
;

2876 
	}
}

2880 
	$ngx_»sÞv”_ä“
(
ngx_»sÞv”_t
 *
r
, *
p
)

2884 
	`ngx_ä“
(
p
);

2887 
	}
}

2891 
	$ngx_»sÞv”_ä“_locked
(
ngx_»sÞv”_t
 *
r
, *
p
)

2893 
	`ngx_ä“
(
p
);

2894 
	}
}

2898 
	$ngx_»sÞv”_dup
(
ngx_»sÞv”_t
 *
r
, *
¤c
, 
size_t
 
size
)

2900 *
d¡
;

2902 
d¡
 = 
	`ngx_»sÞv”_®loc
(
r
, 
size
);

2904 ià(
d¡
 =ð
NULL
) {

2905  
d¡
;

2908 
	`ngx_memýy
(
d¡
, 
¤c
, 
size
);

2910  
d¡
;

2911 
	}
}

2914 
ngx_addr_t
 *

2915 
	$ngx_»sÞv”_expÜt
(
ngx_»sÞv”_t
 *
r
, 
ngx_»sÞv”_node_t
 *
º
,

2916 
ngx_ušt_t
 
rÙ©e
)

2918 
ngx_addr_t
 *
d¡
;

2919 
ngx_ušt_t
 
d
, 
i
, 
j
, 
n
;

2920 
	`u_ch¬
 (*
sockaddr
)[
NGX_SOCKADDRLEN
];

2921 
š_addr_t
 *
addr
;

2922 
sockaddr_š
 *
sš
;

2923 #ià(
NGX_HAVE_INET6
)

2924 
š6_addr
 *
addr6
;

2925 
sockaddr_š6
 *
sš6
;

2928 
n
 = 
º
->
Çddrs
;

2929 #ià(
NGX_HAVE_INET6
)

2930 
n
 +ð
º
->
Çddrs6
;

2933 
d¡
 = 
	`ngx_»sÞv”_ÿÎoc
(
r
, 
n
 * (
ngx_addr_t
));

2934 ià(
d¡
 =ð
NULL
) {

2935  
NULL
;

2938 
sockaddr
 = 
	`ngx_»sÞv”_ÿÎoc
(
r
, 
n
 * 
NGX_SOCKADDRLEN
);

2939 ià(
sockaddr
 =ð
NULL
) {

2940 
	`ngx_»sÞv”_ä“
(
r
, 
d¡
);

2941  
NULL
;

2944 
i
 = 0;

2945 
d
 = 
rÙ©e
 ? 
	`ngx_¿ndom
(è% 
n
 : 0;

2947 ià(
º
->
Çddrs
) {

2948 
j
 = 
rÙ©e
 ? 
	`ngx_¿ndom
(è% 
º
->
Çddrs
 : 0;

2950 
addr
 = (
º
->
Çddrs
 =ð1è? &º->
u
.add¸:„n->u.
addrs
;

2953 
sš
 = (
sockaddr_š
 *è
sockaddr
[
d
];

2954 
sš
->
sš_çmžy
 = 
AF_INET
;

2955 
sš
->
sš_addr
.
s_addr
 = 
addr
[
j
++];

2956 
d¡
[
d
].
sockaddr
 = (sockadd¸*è
sš
;

2957 
d¡
[
d
++].
sockËn
 = (
sockaddr_š
);

2959 ià(
d
 =ð
n
) {

2960 
d
 = 0;

2963 ià(
j
 =ð
º
->
Çddrs
) {

2964 
j
 = 0;

2966 } ++
i
 < 
º
->
Çddrs
);

2969 #ià(
NGX_HAVE_INET6
)

2970 ià(
º
->
Çddrs6
) {

2971 
j
 = 
rÙ©e
 ? 
	`ngx_¿ndom
(è% 
º
->
Çddrs6
 : 0;

2973 
addr6
 = (
º
->
Çddrs6
 =ð1è? &º->
u6
.addr6 :„n->u6.
addrs6
;

2976 
sš6
 = (
sockaddr_š6
 *è
sockaddr
[
d
];

2977 
sš6
->
sš6_çmžy
 = 
AF_INET6
;

2978 
	`ngx_memýy
(
sš6
->
sš6_addr
.
s6_addr
, 
addr6
[
j
++].s6_addr, 16);

2979 
d¡
[
d
].
sockaddr
 = (sockadd¸*è
sš6
;

2980 
d¡
[
d
++].
sockËn
 = (
sockaddr_š6
);

2982 ià(
d
 =ð
n
) {

2983 
d
 = 0;

2986 ià(
j
 =ð
º
->
Çddrs6
) {

2987 
j
 = 0;

2989 } ++
i
 < 
n
);

2993  
d¡
;

2994 
	}
}

2998 
	$ngx_»sÞv”_¡»¼Ü
(
ngx_št_t
 
”r
)

3000 *
”rÜs
[] = {

3008 ià(
”r
 > 0 &&ƒrr < 6) {

3009  
”rÜs
[
”r
 - 1];

3012 ià(
”r
 =ð
NGX_RESOLVE_TIMEDOUT
) {

3017 
	}
}

3020 
u_ch¬
 *

3021 
	$ngx_»sÞv”_log_”rÜ
(
ngx_log_t
 *
log
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
)

3023 
u_ch¬
 *
p
;

3024 
ngx_udp_cÚÃùiÚ_t
 *
uc
;

3026 
p
 = 
buf
;

3028 ià(
log
->
aùiÚ
) {

3029 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, " whž%s", 
log
->
aùiÚ
);

3030 
Ën
 -ð
p
 - 
buf
;

3033 
uc
 = 
log
->
d©a
;

3035 ià(
uc
) {

3036 
p
 = 
	`ngx_¢´štf
Õ, 
Ën
, ",„esÞv”: %V", &
uc
->
£rv”
);

3039  
p
;

3040 
	}
}

3043 
ngx_št_t


3044 
	$ngx_udp_cÚÃù
(
ngx_udp_cÚÃùiÚ_t
 *
uc
)

3046 
rc
;

3047 
ngx_št_t
 
ev’t
;

3048 
ngx_ev’t_t
 *
»v
, *
wev
;

3049 
ngx_sock‘_t
 
s
;

3050 
ngx_cÚÃùiÚ_t
 *
c
;

3052 
s
 = 
	`ngx_sock‘
(
uc
->
sockaddr
->
§_çmžy
, 
SOCK_DGRAM
, 0);

3054 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, &
uc
->
log
, 0, "UDP sock‘ %d", 
s
);

3056 ià(
s
 =ð(
ngx_sock‘_t
) -1) {

3057 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, &
uc
->
log
, 
ngx_sock‘_”ºo
,

3058 
ngx_sock‘_n
 " failed");

3059  
NGX_ERROR
;

3062 
c
 = 
	`ngx_g‘_cÚÃùiÚ
(
s
, &
uc
->
log
);

3064 ià(
c
 =ð
NULL
) {

3065 ià(
	`ngx_þo£_sock‘
(
s
) == -1) {

3066 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, &
uc
->
log
, 
ngx_sock‘_”ºo
,

3067 
ngx_þo£_sock‘_n
 "failed");

3070  
NGX_ERROR
;

3073 ià(
	`ngx_nÚblockšg
(
s
) == -1) {

3074 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, &
uc
->
log
, 
ngx_sock‘_”ºo
,

3075 
ngx_nÚblockšg_n
 " failed");

3077 
çžed
;

3080 
»v
 = 
c
->
»ad
;

3081 
wev
 = 
c
->
wr™e
;

3083 
»v
->
log
 = &
uc
->log;

3084 
wev
->
log
 = &
uc
->log;

3086 
uc
->
cÚÃùiÚ
 = 
c
;

3088 
c
->
numb”
 = 
	`ngx_©omic_ãtch_add
(
ngx_cÚÃùiÚ_couÁ”
, 1);

3090 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, &
uc
->
log
, 0,

3091 "cÚÃùØ%V, fd:%d #%uA", &
uc
->
£rv”
, 
s
, 
c
->
numb”
);

3093 
rc
 = 
	`cÚÃù
(
s
, 
uc
->
sockaddr
, uc->
sockËn
);

3097 ià(
rc
 == -1) {

3098 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, &
uc
->
log
, 
ngx_sock‘_”ºo
,

3101 
çžed
;

3105 
wev
->
»ady
 = 1;

3107 ià(
ngx_add_ev’t
) {

3109 
ev’t
 = (
ngx_ev’t_æags
 & 
NGX_USE_CLEAR_EVENT
) ?

3110  
NGX_CLEAR_EVENT
:

3111  
NGX_LEVEL_EVENT
;

3114 ià(
	`ngx_add_ev’t
(
»v
, 
NGX_READ_EVENT
, 
ev’t
è!ð
NGX_OK
) {

3115 
çžed
;

3121 ià(
	`ngx_add_cÚn
(
c
è=ð
NGX_ERROR
) {

3122 
çžed
;

3126  
NGX_OK
;

3128 
çžed
:

3130 
	`ngx_þo£_cÚÃùiÚ
(
c
);

3131 
uc
->
cÚÃùiÚ
 = 
NULL
;

3133  
NGX_ERROR
;

3134 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_shmtx.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 #ià(
NGX_HAVE_ATOMIC_OPS
)

15 
ngx_shmtx_wakeup
(
ngx_shmtx_t
 *
mtx
);

18 
ngx_št_t


19 
	$ngx_shmtx_ü—‹
(
ngx_shmtx_t
 *
mtx
, 
ngx_shmtx_sh_t
 *
addr
, 
u_ch¬
 *
Çme
)

21 
mtx
->
lock
 = &
addr
->lock;

23 ià(
mtx
->
¥š
 =ð(
ngx_ušt_t
) -1) {

24  
NGX_OK
;

27 
mtx
->
¥š
 = 2048;

29 #ià(
NGX_HAVE_POSIX_SEM
)

31 
mtx
->
wa™
 = &
addr
->wait;

33 ià(
	`£m_š™
(&
mtx
->
£m
, 1, 0) == -1) {

34 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_”ºo
,

37 
mtx
->
£m­hÜe
 = 1;

42  
NGX_OK
;

43 
	}
}

47 
	$ngx_shmtx_de¡roy
(
ngx_shmtx_t
 *
mtx
)

49 #ià(
NGX_HAVE_POSIX_SEM
)

51 ià(
mtx
->
£m­hÜe
) {

52 ià(
	`£m_de¡roy
(&
mtx
->
£m
) == -1) {

53 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_”ºo
,

59 
	}
}

62 
ngx_ušt_t


63 
	$ngx_shmtx_Œylock
(
ngx_shmtx_t
 *
mtx
)

65  (*
mtx
->
lock
 =ð0 && 
	`ngx_©omic_cmp_£t
(mtx->lock, 0, 
ngx_pid
));

66 
	}
}

70 
	$ngx_shmtx_lock
(
ngx_shmtx_t
 *
mtx
)

72 
ngx_ušt_t
 
i
, 
n
;

74 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0, "shmtx†ock");

78 ià(*
mtx
->
lock
 =ð0 && 
	`ngx_©omic_cmp_£t
(mtx->lock, 0, 
ngx_pid
)) {

82 ià(
ngx_nýu
 > 1) {

84 
n
 = 1;‚ < 
mtx
->
¥š
;‚ <<= 1) {

86 
i
 = 0; i < 
n
; i++) {

87 
	`ngx_ýu_·u£
();

90 ià(*
mtx
->
lock
 == 0

91 && 
	`ngx_©omic_cmp_£t
(
mtx
->
lock
, 0, 
ngx_pid
))

98 #ià(
NGX_HAVE_POSIX_SEM
)

100 ià(
mtx
->
£m­hÜe
) {

101 (è
	`ngx_©omic_ãtch_add
(
mtx
->
wa™
, 1);

103 ià(*
mtx
->
lock
 =ð0 && 
	`ngx_©omic_cmp_£t
(mtx->lock, 0, 
ngx_pid
)) {

107 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0,

108 "shmtx wa™ %uA", *
mtx
->
wa™
);

110 
	`£m_wa™
(&
mtx
->
£m
) == -1) {

111 
ngx_”r_t
 
”r
;

113 
”r
 = 
ngx_”ºo
;

115 ià(
”r
 !ð
NGX_EINTR
) {

116 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
”r
,

122 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0,

130 
	`ngx_sched_y›ld
();

132 
	}
}

136 
	$ngx_shmtx_uÆock
(
ngx_shmtx_t
 *
mtx
)

138 ià(
mtx
->
¥š
 !ð(
ngx_ušt_t
) -1) {

139 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0, "shmtx unlock");

142 ià(
	`ngx_©omic_cmp_£t
(
mtx
->
lock
, 
ngx_pid
, 0)) {

143 
	`ngx_shmtx_wakeup
(
mtx
);

145 
	}
}

148 
ngx_ušt_t


149 
	$ngx_shmtx_fÜû_uÆock
(
ngx_shmtx_t
 *
mtx
, 
ngx_pid_t
 
pid
)

151 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0,

154 ià(
	`ngx_©omic_cmp_£t
(
mtx
->
lock
, 
pid
, 0)) {

155 
	`ngx_shmtx_wakeup
(
mtx
);

160 
	}
}

164 
	$ngx_shmtx_wakeup
(
ngx_shmtx_t
 *
mtx
)

166 #ià(
NGX_HAVE_POSIX_SEM
)

167 
ngx_©omic_ušt_t
 
wa™
;

169 ià(!
mtx
->
£m­hÜe
) {

175 
wa™
 = *
mtx
->wait;

177 ià(
wa™
 == 0) {

181 ià(
	`ngx_©omic_cmp_£t
(
mtx
->
wa™
, wait, wait - 1)) {

186 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0,

187 "shmtx wak%uA", 
wa™
);

189 ià(
	`£m_po¡
(&
mtx
->
£m
) == -1) {

190 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_”ºo
,

195 
	}
}

201 
ngx_št_t


202 
	$ngx_shmtx_ü—‹
(
ngx_shmtx_t
 *
mtx
, 
ngx_shmtx_sh_t
 *
addr
, 
u_ch¬
 *
Çme
)

204 ià(
mtx
->
Çme
) {

206 ià(
	`ngx_¡rcmp
(
Çme
, 
mtx
->name) == 0) {

207 
mtx
->
Çme
 =‚ame;

208  
NGX_OK
;

211 
	`ngx_shmtx_de¡roy
(
mtx
);

214 
mtx
->
fd
 = 
	`ngx_Ý’_fže
(
Çme
, 
NGX_FILE_RDWR
, 
NGX_FILE_CREATE_OR_OPEN
,

215 
NGX_FILE_DEFAULT_ACCESS
);

217 ià(
mtx
->
fd
 =ð
NGX_INVALID_FILE
) {

218 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
ngx_cyþe
->
log
, 
ngx_”ºo
,

219 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
Çme
);

220  
NGX_ERROR
;

223 ià(
	`ngx_d–‘e_fže
(
Çme
è=ð
NGX_FILE_ERROR
) {

224 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_”ºo
,

225 
ngx_d–‘e_fže_n
 " \"%s\" fažed", 
Çme
);

228 
mtx
->
Çme
 =‚ame;

230  
NGX_OK
;

231 
	}
}

235 
	$ngx_shmtx_de¡roy
(
ngx_shmtx_t
 *
mtx
)

237 ià(
	`ngx_þo£_fže
(
mtx
->
fd
è=ð
NGX_FILE_ERROR
) {

238 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_”ºo
,

239 
ngx_þo£_fže_n
 " \"%s\" fažed", 
mtx
->
Çme
);

241 
	}
}

244 
ngx_ušt_t


245 
	$ngx_shmtx_Œylock
(
ngx_shmtx_t
 *
mtx
)

247 
ngx_”r_t
 
”r
;

249 
”r
 = 
	`ngx_Œylock_fd
(
mtx
->
fd
);

251 ià(
”r
 == 0) {

255 ià(
”r
 =ð
NGX_EAGAIN
) {

259 #ià
__osf__


261 ià(
”r
 =ð
NGX_EACCESS
) {

267 
	`ngx_log_abÜt
(
”r
, 
ngx_Œylock_fd_n
 " % çžed", 
mtx
->
Çme
);

270 
	}
}

274 
	$ngx_shmtx_lock
(
ngx_shmtx_t
 *
mtx
)

276 
ngx_”r_t
 
”r
;

278 
”r
 = 
	`ngx_lock_fd
(
mtx
->
fd
);

280 ià(
”r
 == 0) {

284 
	`ngx_log_abÜt
(
”r
, 
ngx_lock_fd_n
 " % çžed", 
mtx
->
Çme
);

285 
	}
}

289 
	$ngx_shmtx_uÆock
(
ngx_shmtx_t
 *
mtx
)

291 
ngx_”r_t
 
”r
;

293 
”r
 = 
	`ngx_uÆock_fd
(
mtx
->
fd
);

295 ià(
”r
 == 0) {

299 
	`ngx_log_abÜt
(
”r
, 
ngx_uÆock_fd_n
 " % çžed", 
mtx
->
Çme
);

300 
	}
}

303 
ngx_ušt_t


304 
	$ngx_shmtx_fÜû_uÆock
(
ngx_shmtx_t
 *
mtx
, 
ngx_pid_t
 
pid
)

307 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_slab.c

7 
	~<ngx_cÚfig.h
>

8 
	~<ngx_cÜe.h
>

11 
	#NGX_SLAB_PAGE_MASK
 3

	)

12 
	#NGX_SLAB_PAGE
 0

	)

13 
	#NGX_SLAB_BIG
 1

	)

14 
	#NGX_SLAB_EXACT
 2

	)

15 
	#NGX_SLAB_SMALL
 3

	)

17 #ià(
NGX_PTR_SIZE
 == 4)

19 
	#NGX_SLAB_PAGE_FREE
 0

	)

20 
	#NGX_SLAB_PAGE_BUSY
 0xffffffff

	)

21 
	#NGX_SLAB_PAGE_START
 0x80000000

	)

23 
	#NGX_SLAB_SHIFT_MASK
 0x0000000f

	)

24 
	#NGX_SLAB_MAP_MASK
 0xffff0000

	)

25 
	#NGX_SLAB_MAP_SHIFT
 16

	)

27 
	#NGX_SLAB_BUSY
 0xffffffff

	)

31 
	#NGX_SLAB_PAGE_FREE
 0

	)

32 
	#NGX_SLAB_PAGE_BUSY
 0xffffffffffffffff

	)

33 
	#NGX_SLAB_PAGE_START
 0x8000000000000000

	)

35 
	#NGX_SLAB_SHIFT_MASK
 0x000000000000000f

	)

36 
	#NGX_SLAB_MAP_MASK
 0xffffffff00000000

	)

37 
	#NGX_SLAB_MAP_SHIFT
 32

	)

39 
	#NGX_SLAB_BUSY
 0xffffffffffffffff

	)

44 #ià(
NGX_DEBUG_MALLOC
)

46 
	#ngx_¦ab_junk
(
p
, 
size
è
	`ngx_mem£t
Õ, 0xA5, size)

	)

48 #–ià(
NGX_HAVE_DEBUG_MALLOC
)

50 
	#ngx_¦ab_junk
(
p
, 
size
) \

51 ià(
ngx_debug_m®loc
è
	`ngx_mem£t
(
p
, 0xA5, 
size
)

	)

55 
	#ngx_¦ab_junk
(
p
, 
size
)

	)

59 
ngx_¦ab_·ge_t
 *
ngx_¦ab_®loc_·ges
(
ngx_¦ab_poÞ_t
 *
poÞ
,

60 
ngx_ušt_t
 
·ges
);

61 
ngx_¦ab_ä“_·ges
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
ngx_¦ab_·ge_t
 *
·ge
,

62 
ngx_ušt_t
 
·ges
);

63 
ngx_¦ab_”rÜ
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
ngx_ušt_t
 
Ëv–
,

64 *
‹xt
);

67 
ngx_ušt_t
 
	gngx_¦ab_max_size
;

68 
ngx_ušt_t
 
	gngx_¦ab_exaù_size
;

69 
ngx_ušt_t
 
	gngx_¦ab_exaù_shiá
;

73 
	$ngx_¦ab_š™
(
ngx_¦ab_poÞ_t
 *
poÞ
)

75 
u_ch¬
 *
p
;

76 
size_t
 
size
;

77 
ngx_št_t
 
m
;

78 
ngx_ušt_t
 
i
, 
n
, 
·ges
;

79 
ngx_¦ab_·ge_t
 *
¦Ùs
;

82 ià(
ngx_¦ab_max_size
 == 0) {

83 
ngx_¦ab_max_size
 = 
ngx_·gesize
 / 2;

84 
ngx_¦ab_exaù_size
 = 
ngx_·gesize
 / (8 * (
ušŒ_t
));

85 
n
 = 
ngx_¦ab_exaù_size
;‚ >>ð1; 
ngx_¦ab_exaù_shiá
++) {

91 
poÞ
->
mš_size
 = 1 <<…oÞ->
mš_shiá
;

93 
p
 = (
u_ch¬
 *è
poÞ
 + (
ngx_¦ab_poÞ_t
);

94 
size
 = 
poÞ
->
’d
 - 
p
;

96 
	`ngx_¦ab_junk
(
p
, 
size
);

98 
¦Ùs
 = (
ngx_¦ab_·ge_t
 *è
p
;

99 
n
 = 
ngx_·gesize_shiá
 - 
poÞ
->
mš_shiá
;

101 
i
 = 0; i < 
n
; i++) {

102 
¦Ùs
[
i
].
¦ab
 = 0;

103 
¦Ùs
[
i
].
Ãxt
 = &slots[i];

104 
¦Ùs
[
i
].
´ev
 = 0;

107 
p
 +ð
n
 * (
ngx_¦ab_·ge_t
);

109 
·ges
 = (
ngx_ušt_t
è(
size
 / (
ngx_·gesize
 + (
ngx_¦ab_·ge_t
)));

111 
	`ngx_memz”o
(
p
, 
·ges
 * (
ngx_¦ab_·ge_t
));

113 
poÞ
->
·ges
 = (
ngx_¦ab_·ge_t
 *è
p
;

115 
poÞ
->
ä“
.
´ev
 = 0;

116 
poÞ
->
ä“
.
Ãxt
 = (
ngx_¦ab_·ge_t
 *è
p
;

118 
poÞ
->
·ges
->
¦ab
 =…ages;

119 
poÞ
->
·ges
->
Ãxt
 = &poÞ->
ä“
;

120 
poÞ
->
·ges
->
´ev
 = (
ušŒ_t
è&poÞ->
ä“
;

122 
poÞ
->
¡¬t
 = (
u_ch¬
 *)

123 
	`ngx_®ign_±r
((
ušŒ_t
è
p
 + 
·ges
 * (
ngx_¦ab_·ge_t
),

124 
ngx_·gesize
);

126 
m
 = 
·ges
 - (
poÞ
->
’d
 -…oÞ->
¡¬t
è/ 
ngx_·gesize
;

127 ià(
m
 > 0) {

128 
·ges
 -ð
m
;

129 
poÞ
->
·ges
->
¦ab
 =…ages;

132 
poÞ
->
Ï¡
 =…oÞ->
·ges
 +…ages;

134 
poÞ
->
log_nomem
 = 1;

135 
poÞ
->
log_ùx
 = &poÞ->
z”o
;

136 
poÞ
->
z”o
 = '\0';

137 
	}
}

141 
	$ngx_¦ab_®loc
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
size_t
 
size
)

143 *
p
;

145 
	`ngx_shmtx_lock
(&
poÞ
->
mu‹x
);

147 
p
 = 
	`ngx_¦ab_®loc_locked
(
poÞ
, 
size
);

149 
	`ngx_shmtx_uÆock
(&
poÞ
->
mu‹x
);

151  
p
;

152 
	}
}

156 
	$ngx_¦ab_®loc_locked
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
size_t
 
size
)

158 
size_t
 
s
;

159 
ušŒ_t
 
p
, 
n
, 
m
, 
mask
, *
b™m­
;

160 
ngx_ušt_t
 
i
, 
¦Ù
, 
shiá
, 
m­
;

161 
ngx_¦ab_·ge_t
 *
·ge
, *
´ev
, *
¦Ùs
;

163 ià(
size
 > 
ngx_¦ab_max_size
) {

165 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
ngx_cyþe
->
log
, 0,

166 "¦ab‡Îoc: %uz", 
size
);

168 
·ge
 = 
	`ngx_¦ab_®loc_·ges
(
poÞ
, (
size
 >> 
ngx_·gesize_shiá
)

169 + ((
size
 % 
ngx_·gesize
) ? 1 : 0));

170 ià(
·ge
) {

171 
p
 = (
·ge
 - 
poÞ
->
·ges
è<< 
ngx_·gesize_shiá
;

172 
p
 +ð(
ušŒ_t
è
poÞ
->
¡¬t
;

175 
p
 = 0;

178 
dÚe
;

181 ià(
size
 > 
poÞ
->
mš_size
) {

182 
shiá
 = 1;

183 
s
 = 
size
 - 1; s >>ð1; 
shiá
++) { }

184 
¦Ù
 = 
shiá
 - 
poÞ
->
mš_shiá
;

187 
size
 = 
poÞ
->
mš_size
;

188 
shiá
 = 
poÞ
->
mš_shiá
;

189 
¦Ù
 = 0;

192 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_ALLOC
, 
ngx_cyþe
->
log
, 0,

193 "¦ab‡Îoc: %uz slÙ: %ui", 
size
, 
¦Ù
);

195 
¦Ùs
 = (
ngx_¦ab_·ge_t
 *è((
u_ch¬
 *è
poÞ
 + (
ngx_¦ab_poÞ_t
));

196 
·ge
 = 
¦Ùs
[
¦Ù
].
Ãxt
;

198 ià(
·ge
->
Ãxt
 !=…age) {

200 ià(
shiá
 < 
ngx_¦ab_exaù_shiá
) {

203 
p
 = (
·ge
 - 
poÞ
->
·ges
è<< 
ngx_·gesize_shiá
;

204 
b™m­
 = (
ušŒ_t
 *è(
poÞ
->
¡¬t
 + 
p
);

206 
m­
 = (1 << (
ngx_·gesize_shiá
 - 
shiá
))

207 / ((
ušŒ_t
) * 8);

209 
n
 = 0;‚ < 
m­
;‚++) {

211 ià(
b™m­
[
n
] !ð
NGX_SLAB_BUSY
) {

213 
m
 = 1, 
i
 = 0; m; m <<= 1, i++) {

214 ià((
b™m­
[
n
] & 
m
)) {

218 
b™m­
[
n
] |ð
m
;

220 
i
 = ((
n
 * (
ušŒ_t
è* 8è<< 
shiá
)

221 + (
i
 << 
shiá
);

223 ià(
b™m­
[
n
] =ð
NGX_SLAB_BUSY
) {

224 
n
 =‚ + 1;‚ < 
m­
;‚++) {

225 ià(
b™m­
[
n
] !ð
NGX_SLAB_BUSY
) {

226 
p
 = (
ušŒ_t
è
b™m­
 + 
i
;

228 
dÚe
;

232 
´ev
 = (
ngx_¦ab_·ge_t
 *)

233 (
·ge
->
´ev
 & ~
NGX_SLAB_PAGE_MASK
);

234 
´ev
->
Ãxt
 = 
·ge
->next;

235 
·ge
->
Ãxt
->
´ev
 =…age->prev;

237 
·ge
->
Ãxt
 = 
NULL
;

238 
·ge
->
´ev
 = 
NGX_SLAB_SMALL
;

241 
p
 = (
ušŒ_t
è
b™m­
 + 
i
;

243 
dÚe
;

248 
·ge
 =…age->
Ãxt
;

250 } 
·ge
);

252 } ià(
shiá
 =ð
ngx_¦ab_exaù_shiá
) {

255 ià(
·ge
->
¦ab
 !ð
NGX_SLAB_BUSY
) {

257 
m
 = 1, 
i
 = 0; m; m <<= 1, i++) {

258 ià((
·ge
->
¦ab
 & 
m
)) {

262 
·ge
->
¦ab
 |ð
m
;

264 ià(
·ge
->
¦ab
 =ð
NGX_SLAB_BUSY
) {

265 
´ev
 = (
ngx_¦ab_·ge_t
 *)

266 (
·ge
->
´ev
 & ~
NGX_SLAB_PAGE_MASK
);

267 
´ev
->
Ãxt
 = 
·ge
->next;

268 
·ge
->
Ãxt
->
´ev
 =…age->prev;

270 
·ge
->
Ãxt
 = 
NULL
;

271 
·ge
->
´ev
 = 
NGX_SLAB_EXACT
;

274 
p
 = (
·ge
 - 
poÞ
->
·ges
è<< 
ngx_·gesize_shiá
;

275 
p
 +ð
i
 << 
shiá
;

276 
p
 +ð(
ušŒ_t
è
poÞ
->
¡¬t
;

278 
dÚe
;

282 
·ge
 =…age->
Ãxt
;

284 } 
·ge
);

288 
n
 = 
ngx_·gesize_shiá
 - (
·ge
->
¦ab
 & 
NGX_SLAB_SHIFT_MASK
);

289 
n
 = 1 <<‚;

290 
n
 = ((
ušŒ_t
) 1 <<‚) - 1;

291 
mask
 = 
n
 << 
NGX_SLAB_MAP_SHIFT
;

294 ià((
·ge
->
¦ab
 & 
NGX_SLAB_MAP_MASK
è!ð
mask
) {

296 
m
 = (
ušŒ_t
è1 << 
NGX_SLAB_MAP_SHIFT
, 
i
 = 0;

297 
m
 & 
mask
;

298 
m
 <<ð1, 
i
++)

300 ià((
·ge
->
¦ab
 & 
m
)) {

304 
·ge
->
¦ab
 |ð
m
;

306 ià((
·ge
->
¦ab
 & 
NGX_SLAB_MAP_MASK
è=ð
mask
) {

307 
´ev
 = (
ngx_¦ab_·ge_t
 *)

308 (
·ge
->
´ev
 & ~
NGX_SLAB_PAGE_MASK
);

309 
´ev
->
Ãxt
 = 
·ge
->next;

310 
·ge
->
Ãxt
->
´ev
 =…age->prev;

312 
·ge
->
Ãxt
 = 
NULL
;

313 
·ge
->
´ev
 = 
NGX_SLAB_BIG
;

316 
p
 = (
·ge
 - 
poÞ
->
·ges
è<< 
ngx_·gesize_shiá
;

317 
p
 +ð
i
 << 
shiá
;

318 
p
 +ð(
ušŒ_t
è
poÞ
->
¡¬t
;

320 
dÚe
;

324 
·ge
 =…age->
Ãxt
;

326 } 
·ge
);

330 
·ge
 = 
	`ngx_¦ab_®loc_·ges
(
poÞ
, 1);

332 ià(
·ge
) {

333 ià(
shiá
 < 
ngx_¦ab_exaù_shiá
) {

334 
p
 = (
·ge
 - 
poÞ
->
·ges
è<< 
ngx_·gesize_shiá
;

335 
b™m­
 = (
ušŒ_t
 *è(
poÞ
->
¡¬t
 + 
p
);

337 
s
 = 1 << 
shiá
;

338 
n
 = (1 << (
ngx_·gesize_shiá
 - 
shiá
)è/ 8 / 
s
;

340 ià(
n
 == 0) {

341 
n
 = 1;

344 
b™m­
[0] = (2 << 
n
) - 1;

346 
m­
 = (1 << (
ngx_·gesize_shiá
 - 
shiá
)è/ ((
ušŒ_t
) * 8);

348 
i
 = 1; i < 
m­
; i++) {

349 
b™m­
[
i
] = 0;

352 
·ge
->
¦ab
 = 
shiá
;

353 
·ge
->
Ãxt
 = &
¦Ùs
[
¦Ù
];

354 
·ge
->
´ev
 = (
ušŒ_t
è&
¦Ùs
[
¦Ù
] | 
NGX_SLAB_SMALL
;

356 
¦Ùs
[
¦Ù
].
Ãxt
 = 
·ge
;

358 
p
 = ((
·ge
 - 
poÞ
->
·ges
è<< 
ngx_·gesize_shiá
è+ 
s
 * 
n
;

359 
p
 +ð(
ušŒ_t
è
poÞ
->
¡¬t
;

361 
dÚe
;

363 } ià(
shiá
 =ð
ngx_¦ab_exaù_shiá
) {

365 
·ge
->
¦ab
 = 1;

366 
·ge
->
Ãxt
 = &
¦Ùs
[
¦Ù
];

367 
·ge
->
´ev
 = (
ušŒ_t
è&
¦Ùs
[
¦Ù
] | 
NGX_SLAB_EXACT
;

369 
¦Ùs
[
¦Ù
].
Ãxt
 = 
·ge
;

371 
p
 = (
·ge
 - 
poÞ
->
·ges
è<< 
ngx_·gesize_shiá
;

372 
p
 +ð(
ušŒ_t
è
poÞ
->
¡¬t
;

374 
dÚe
;

378 
·ge
->
¦ab
 = ((
ušŒ_t
è1 << 
NGX_SLAB_MAP_SHIFT
è| 
shiá
;

379 
·ge
->
Ãxt
 = &
¦Ùs
[
¦Ù
];

380 
·ge
->
´ev
 = (
ušŒ_t
è&
¦Ùs
[
¦Ù
] | 
NGX_SLAB_BIG
;

382 
¦Ùs
[
¦Ù
].
Ãxt
 = 
·ge
;

384 
p
 = (
·ge
 - 
poÞ
->
·ges
è<< 
ngx_·gesize_shiá
;

385 
p
 +ð(
ušŒ_t
è
poÞ
->
¡¬t
;

387 
dÚe
;

391 
p
 = 0;

393 
dÚe
:

395 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
ngx_cyþe
->
log
, 0, "¦ab‡Îoc: %p", 
p
);

397  (*è
p
;

398 
	}
}

402 
	$ngx_¦ab_ÿÎoc
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
size_t
 
size
)

404 *
p
;

406 
	`ngx_shmtx_lock
(&
poÞ
->
mu‹x
);

408 
p
 = 
	`ngx_¦ab_ÿÎoc_locked
(
poÞ
, 
size
);

410 
	`ngx_shmtx_uÆock
(&
poÞ
->
mu‹x
);

412  
p
;

413 
	}
}

417 
	$ngx_¦ab_ÿÎoc_locked
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
size_t
 
size
)

419 *
p
;

421 
p
 = 
	`ngx_¦ab_®loc_locked
(
poÞ
, 
size
);

422 ià(
p
) {

423 
	`ngx_memz”o
(
p
, 
size
);

426  
p
;

427 
	}
}

431 
	$ngx_¦ab_ä“
(
ngx_¦ab_poÞ_t
 *
poÞ
, *
p
)

433 
	`ngx_shmtx_lock
(&
poÞ
->
mu‹x
);

435 
	`ngx_¦ab_ä“_locked
(
poÞ
, 
p
);

437 
	`ngx_shmtx_uÆock
(&
poÞ
->
mu‹x
);

438 
	}
}

442 
	$ngx_¦ab_ä“_locked
(
ngx_¦ab_poÞ_t
 *
poÞ
, *
p
)

444 
size_t
 
size
;

445 
ušŒ_t
 
¦ab
, 
m
, *
b™m­
;

446 
ngx_ušt_t
 
n
, 
ty³
, 
¦Ù
, 
shiá
, 
m­
;

447 
ngx_¦ab_·ge_t
 *
¦Ùs
, *
·ge
;

449 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
ngx_cyþe
->
log
, 0, "¦ab f»e: %p", 
p
);

451 ià((
u_ch¬
 *è
p
 < 
poÞ
->
¡¬t
 || (u_ch¬ *è°>…oÞ->
’d
) {

452 
	`ngx_¦ab_”rÜ
(
poÞ
, 
NGX_LOG_ALERT
, "ngx_slab_free(): outside of…ool");

453 
çž
;

456 
n
 = ((
u_ch¬
 *è
p
 - 
poÞ
->
¡¬t
è>> 
ngx_·gesize_shiá
;

457 
·ge
 = &
poÞ
->
·ges
[
n
];

458 
¦ab
 = 
·ge
->slab;

459 
ty³
 = 
·ge
->
´ev
 & 
NGX_SLAB_PAGE_MASK
;

461 
ty³
) {

463 
NGX_SLAB_SMALL
:

465 
shiá
 = 
¦ab
 & 
NGX_SLAB_SHIFT_MASK
;

466 
size
 = 1 << 
shiá
;

468 ià((
ušŒ_t
è
p
 & (
size
 - 1)) {

469 
wrÚg_chunk
;

472 
n
 = ((
ušŒ_t
è
p
 & (
ngx_·gesize
 - 1)è>> 
shiá
;

473 
m
 = (
ušŒ_t
è1 << (
n
 & ((uintptr_t) * 8 - 1));

474 
n
 /ð((
ušŒ_t
) * 8);

475 
b™m­
 = (
ušŒ_t
 *)

476 ((
ušŒ_t
è
p
 & ~((ušŒ_tè
ngx_·gesize
 - 1));

478 ià(
b™m­
[
n
] & 
m
) {

480 ià(
·ge
->
Ãxt
 =ð
NULL
) {

481 
¦Ùs
 = (
ngx_¦ab_·ge_t
 *)

482 ((
u_ch¬
 *è
poÞ
 + (
ngx_¦ab_poÞ_t
));

483 
¦Ù
 = 
shiá
 - 
poÞ
->
mš_shiá
;

485 
·ge
->
Ãxt
 = 
¦Ùs
[
¦Ù
].next;

486 
¦Ùs
[
¦Ù
].
Ãxt
 = 
·ge
;

488 
·ge
->
´ev
 = (
ušŒ_t
è&
¦Ùs
[
¦Ù
] | 
NGX_SLAB_SMALL
;

489 
·ge
->
Ãxt
->
´ev
 = (
ušŒ_t
è·g| 
NGX_SLAB_SMALL
;

492 
b™m­
[
n
] &ð~
m
;

494 
n
 = (1 << (
ngx_·gesize_shiá
 - 
shiá
)) / 8 / (1 << shift);

496 ià(
n
 == 0) {

497 
n
 = 1;

500 ià(
b™m­
[0] & ~(((
ušŒ_t
è1 << 
n
) - 1)) {

501 
dÚe
;

504 
m­
 = (1 << (
ngx_·gesize_shiá
 - 
shiá
)è/ ((
ušŒ_t
) * 8);

506 
n
 = 1;‚ < 
m­
;‚++) {

507 ià(
b™m­
[
n
]) {

508 
dÚe
;

512 
	`ngx_¦ab_ä“_·ges
(
poÞ
, 
·ge
, 1);

514 
dÚe
;

517 
chunk_®»ady_ä“
;

519 
NGX_SLAB_EXACT
:

521 
m
 = (
ušŒ_t
) 1 <<

522 (((
ušŒ_t
è
p
 & (
ngx_·gesize
 - 1)è>> 
ngx_¦ab_exaù_shiá
);

523 
size
 = 
ngx_¦ab_exaù_size
;

525 ià((
ušŒ_t
è
p
 & (
size
 - 1)) {

526 
wrÚg_chunk
;

529 ià(
¦ab
 & 
m
) {

530 ià(
¦ab
 =ð
NGX_SLAB_BUSY
) {

531 
¦Ùs
 = (
ngx_¦ab_·ge_t
 *)

532 ((
u_ch¬
 *è
poÞ
 + (
ngx_¦ab_poÞ_t
));

533 
¦Ù
 = 
ngx_¦ab_exaù_shiá
 - 
poÞ
->
mš_shiá
;

535 
·ge
->
Ãxt
 = 
¦Ùs
[
¦Ù
].next;

536 
¦Ùs
[
¦Ù
].
Ãxt
 = 
·ge
;

538 
·ge
->
´ev
 = (
ušŒ_t
è&
¦Ùs
[
¦Ù
] | 
NGX_SLAB_EXACT
;

539 
·ge
->
Ãxt
->
´ev
 = (
ušŒ_t
è·g| 
NGX_SLAB_EXACT
;

542 
·ge
->
¦ab
 &ð~
m
;

544 ià(
·ge
->
¦ab
) {

545 
dÚe
;

548 
	`ngx_¦ab_ä“_·ges
(
poÞ
, 
·ge
, 1);

550 
dÚe
;

553 
chunk_®»ady_ä“
;

555 
NGX_SLAB_BIG
:

557 
shiá
 = 
¦ab
 & 
NGX_SLAB_SHIFT_MASK
;

558 
size
 = 1 << 
shiá
;

560 ià((
ušŒ_t
è
p
 & (
size
 - 1)) {

561 
wrÚg_chunk
;

564 
m
 = (
ušŒ_t
è1 << ((((ušŒ_tè
p
 & (
ngx_·gesize
 - 1)è>> 
shiá
)

565 + 
NGX_SLAB_MAP_SHIFT
);

567 ià(
¦ab
 & 
m
) {

569 ià(
·ge
->
Ãxt
 =ð
NULL
) {

570 
¦Ùs
 = (
ngx_¦ab_·ge_t
 *)

571 ((
u_ch¬
 *è
poÞ
 + (
ngx_¦ab_poÞ_t
));

572 
¦Ù
 = 
shiá
 - 
poÞ
->
mš_shiá
;

574 
·ge
->
Ãxt
 = 
¦Ùs
[
¦Ù
].next;

575 
¦Ùs
[
¦Ù
].
Ãxt
 = 
·ge
;

577 
·ge
->
´ev
 = (
ušŒ_t
è&
¦Ùs
[
¦Ù
] | 
NGX_SLAB_BIG
;

578 
·ge
->
Ãxt
->
´ev
 = (
ušŒ_t
è·g| 
NGX_SLAB_BIG
;

581 
·ge
->
¦ab
 &ð~
m
;

583 ià(
·ge
->
¦ab
 & 
NGX_SLAB_MAP_MASK
) {

584 
dÚe
;

587 
	`ngx_¦ab_ä“_·ges
(
poÞ
, 
·ge
, 1);

589 
dÚe
;

592 
chunk_®»ady_ä“
;

594 
NGX_SLAB_PAGE
:

596 ià((
ušŒ_t
è
p
 & (
ngx_·gesize
 - 1)) {

597 
wrÚg_chunk
;

600 ià(
¦ab
 =ð
NGX_SLAB_PAGE_FREE
) {

601 
	`ngx_¦ab_”rÜ
(
poÞ
, 
NGX_LOG_ALERT
,

603 
çž
;

606 ià(
¦ab
 =ð
NGX_SLAB_PAGE_BUSY
) {

607 
	`ngx_¦ab_”rÜ
(
poÞ
, 
NGX_LOG_ALERT
,

609 
çž
;

612 
n
 = ((
u_ch¬
 *è
p
 - 
poÞ
->
¡¬t
è>> 
ngx_·gesize_shiá
;

613 
size
 = 
¦ab
 & ~
NGX_SLAB_PAGE_START
;

615 
	`ngx_¦ab_ä“_·ges
(
poÞ
, &poÞ->
·ges
[
n
], 
size
);

617 
	`ngx_¦ab_junk
(
p
, 
size
 << 
ngx_·gesize_shiá
);

626 
dÚe
:

628 
	`ngx_¦ab_junk
(
p
, 
size
);

632 
wrÚg_chunk
:

634 
	`ngx_¦ab_”rÜ
(
poÞ
, 
NGX_LOG_ALERT
,

637 
çž
;

639 
chunk_®»ady_ä“
:

641 
	`ngx_¦ab_”rÜ
(
poÞ
, 
NGX_LOG_ALERT
,

644 
çž
:

647 
	}
}

650 
ngx_¦ab_·ge_t
 *

651 
	$ngx_¦ab_®loc_·ges
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
ngx_ušt_t
 
·ges
)

653 
ngx_¦ab_·ge_t
 *
·ge
, *
p
;

655 
·ge
 = 
poÞ
->
ä“
.
Ãxt
;…age != &pool->free;…age =…age->next) {

657 ià(
·ge
->
¦ab
 >ð
·ges
) {

659 ià(
·ge
->
¦ab
 > 
·ges
) {

660 
·ge
[·ge->
¦ab
 - 1].
´ev
 = (
ušŒ_t
è&·ge[
·ges
];

662 
·ge
[
·ges
].
¦ab
 =…age->slab -…ages;

663 
·ge
[
·ges
].
Ãxt
 =…age->next;

664 
·ge
[
·ges
].
´ev
 =…age->prev;

666 
p
 = (
ngx_¦ab_·ge_t
 *è
·ge
->
´ev
;

667 
p
->
Ãxt
 = &
·ge
[
·ges
];

668 
·ge
->
Ãxt
->
´ev
 = (
ušŒ_t
è&·ge[
·ges
];

671 
p
 = (
ngx_¦ab_·ge_t
 *è
·ge
->
´ev
;

672 
p
->
Ãxt
 = 
·ge
->next;

673 
·ge
->
Ãxt
->
´ev
 =…age->prev;

676 
·ge
->
¦ab
 = 
·ges
 | 
NGX_SLAB_PAGE_START
;

677 
·ge
->
Ãxt
 = 
NULL
;

678 
·ge
->
´ev
 = 
NGX_SLAB_PAGE
;

680 ià(--
·ges
 == 0) {

681  
·ge
;

684 
p
 = 
·ge
 + 1; 
·ges
;…ages--) {

685 
p
->
¦ab
 = 
NGX_SLAB_PAGE_BUSY
;

686 
p
->
Ãxt
 = 
NULL
;

687 
p
->
´ev
 = 
NGX_SLAB_PAGE
;

688 
p
++;

691  
·ge
;

695 ià(
poÞ
->
log_nomem
) {

696 
	`ngx_¦ab_”rÜ
(
poÞ
, 
NGX_LOG_CRIT
,

700  
NULL
;

701 
	}
}

705 
	$ngx_¦ab_ä“_·ges
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
ngx_¦ab_·ge_t
 *
·ge
,

706 
ngx_ušt_t
 
·ges
)

708 
ngx_ušt_t
 
ty³
;

709 
ngx_¦ab_·ge_t
 *
´ev
, *
još
;

711 
·ge
->
¦ab
 = 
·ges
--;

713 ià(
·ges
) {

714 
	`ngx_memz”o
(&
·ge
[1], 
·ges
 * (
ngx_¦ab_·ge_t
));

717 ià(
·ge
->
Ãxt
) {

718 
´ev
 = (
ngx_¦ab_·ge_t
 *è(
·ge
->´ev & ~
NGX_SLAB_PAGE_MASK
);

719 
´ev
->
Ãxt
 = 
·ge
->next;

720 
·ge
->
Ãxt
->
´ev
 =…age->prev;

723 
još
 = 
·ge
 +…age->
¦ab
;

725 ià(
još
 < 
poÞ
->
Ï¡
) {

726 
ty³
 = 
još
->
´ev
 & 
NGX_SLAB_PAGE_MASK
;

728 ià(
ty³
 =ð
NGX_SLAB_PAGE
) {

730 ià(
još
->
Ãxt
 !ð
NULL
) {

731 
·ges
 +ð
još
->
¦ab
;

732 
·ge
->
¦ab
 +ð
još
->slab;

734 
´ev
 = (
ngx_¦ab_·ge_t
 *è(
još
->´ev & ~
NGX_SLAB_PAGE_MASK
);

735 
´ev
->
Ãxt
 = 
još
->next;

736 
još
->
Ãxt
->
´ev
 = join->prev;

738 
još
->
¦ab
 = 
NGX_SLAB_PAGE_FREE
;

739 
još
->
Ãxt
 = 
NULL
;

740 
još
->
´ev
 = 
NGX_SLAB_PAGE
;

745 ià(
·ge
 > 
poÞ
->
·ges
) {

746 
još
 = 
·ge
 - 1;

747 
ty³
 = 
još
->
´ev
 & 
NGX_SLAB_PAGE_MASK
;

749 ià(
ty³
 =ð
NGX_SLAB_PAGE
) {

751 ià(
još
->
¦ab
 =ð
NGX_SLAB_PAGE_FREE
) {

752 
još
 = (
ngx_¦ab_·ge_t
 *è(još->
´ev
 & ~
NGX_SLAB_PAGE_MASK
);

755 ià(
još
->
Ãxt
 !ð
NULL
) {

756 
·ges
 +ð
još
->
¦ab
;

757 
još
->
¦ab
 +ð
·ge
->slab;

759 
´ev
 = (
ngx_¦ab_·ge_t
 *è(
još
->´ev & ~
NGX_SLAB_PAGE_MASK
);

760 
´ev
->
Ãxt
 = 
još
->next;

761 
još
->
Ãxt
->
´ev
 = join->prev;

763 
·ge
->
¦ab
 = 
NGX_SLAB_PAGE_FREE
;

764 
·ge
->
Ãxt
 = 
NULL
;

765 
·ge
->
´ev
 = 
NGX_SLAB_PAGE
;

767 
·ge
 = 
još
;

772 ià(
·ges
) {

773 
·ge
[
·ges
].
´ev
 = (
ušŒ_t
)…age;

776 
·ge
->
´ev
 = (
ušŒ_t
è&
poÞ
->
ä“
;

777 
·ge
->
Ãxt
 = 
poÞ
->
ä“
.next;

779 
·ge
->
Ãxt
->
´ev
 = (
ušŒ_t
)…age;

781 
poÞ
->
ä“
.
Ãxt
 = 
·ge
;

782 
	}
}

786 
	$ngx_¦ab_”rÜ
(
ngx_¦ab_poÞ_t
 *
poÞ
, 
ngx_ušt_t
 
Ëv–
, *
‹xt
)

788 
	`ngx_log_”rÜ
(
Ëv–
, 
ngx_cyþe
->
log
, 0, "%s%s", 
‹xt
, 
poÞ
->
log_ùx
);

789 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_spinlock.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

13 
	$ngx_¥šlock
(
ngx_©omic_t
 *
lock
, 
ngx_©omic_št_t
 
v®ue
, 
ngx_ušt_t
 
¥š
)

16 #ià(
NGX_HAVE_ATOMIC_OPS
)

18 
ngx_ušt_t
 
i
, 
n
;

22 ià(*
lock
 =ð0 && 
	`ngx_©omic_cmp_£t
Öock, 0, 
v®ue
)) {

26 ià(
ngx_nýu
 > 1) {

28 
n
 = 1;‚ < 
¥š
;‚ <<= 1) {

30 
i
 = 0; i < 
n
; i++) {

31 
	`ngx_ýu_·u£
();

34 ià(*
lock
 =ð0 && 
	`ngx_©omic_cmp_£t
Öock, 0, 
v®ue
)) {

40 
	`ngx_sched_y›ld
();

45 #ià(
NGX_THREADS
)

47 #”rÜ 
	`ngx_¥šlock
(è
Ü
 
	`ngx_©omic_cmp_£t
(è
¬e
 
nÙ
 
defšed
 !

53 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_string.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
u_ch¬
 *
ngx_¥rštf_num
(u_ch¬ *
buf
, u_ch¬ *
Ï¡
, 
ušt64_t
 
ui64
,

13 
u_ch¬
 
z”o
, 
ngx_ušt_t
 
hexadecim®
,‚gx_ušt_ˆ
width
);

14 
ngx_’code_ba£64_š‹º®
(
ngx_¡r_t
 *
d¡
,‚gx_¡r_ˆ*
¤c
,

15 cÚ¡ 
u_ch¬
 *
basis
, 
ngx_ušt_t
 
·ddšg
);

16 
ngx_št_t
 
ngx_decode_ba£64_š‹º®
(
ngx_¡r_t
 *
d¡
,‚gx_¡r_ˆ*
¤c
,

17 cÚ¡ 
u_ch¬
 *
basis
);

21 
	$ngx_¡¾ow
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
n
)

23 
n
) {

24 *
d¡
 = 
	`ngx_tÞow”
(*
¤c
);

25 
d¡
++;

26 
¤c
++;

27 
n
--;

29 
	}
}

32 
u_ch¬
 *

33 
	$ngx_ýy¡º
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
n
)

35 ià(
n
 == 0) {

36  
d¡
;

39 --
n
) {

40 *
d¡
 = *
¤c
;

42 ià(*
d¡
 == '\0') {

43  
d¡
;

46 
d¡
++;

47 
¤c
++;

50 *
d¡
 = '\0';

52  
d¡
;

53 
	}
}

56 
u_ch¬
 *

57 
	$ngx_p¡rdup
(
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
¤c
)

59 
u_ch¬
 *
d¡
;

61 
d¡
 = 
	`ngx_²®loc
(
poÞ
, 
¤c
->
Ën
);

62 ià(
d¡
 =ð
NULL
) {

63  
NULL
;

66 
	`ngx_memýy
(
d¡
, 
¤c
->
d©a
, src->
Ën
);

68  
d¡
;

69 
	}
}

104 
u_ch¬
 * 
ngx_cdeþ


105 
	$ngx_¥rštf
(
u_ch¬
 *
buf
, cÚ¡ *
fmt
, ...)

107 
u_ch¬
 *
p
;

108 
va_li¡
 
¬gs
;

110 
	`va_¡¬t
(
¬gs
, 
fmt
);

111 
p
 = 
	`ngx_v¦´štf
(
buf
, (*è-1, 
fmt
, 
¬gs
);

112 
	`va_’d
(
¬gs
);

114  
p
;

115 
	}
}

118 
u_ch¬
 * 
ngx_cdeþ


119 
	$ngx_¢´štf
(
u_ch¬
 *
buf
, 
size_t
 
max
, cÚ¡ *
fmt
, ...)

121 
u_ch¬
 *
p
;

122 
va_li¡
 
¬gs
;

124 
	`va_¡¬t
(
¬gs
, 
fmt
);

125 
p
 = 
	`ngx_v¦´štf
(
buf
, buà+ 
max
, 
fmt
, 
¬gs
);

126 
	`va_’d
(
¬gs
);

128  
p
;

129 
	}
}

132 
u_ch¬
 * 
ngx_cdeþ


133 
	$ngx_¦´štf
(
u_ch¬
 *
buf
, u_ch¬ *
Ï¡
, cÚ¡ *
fmt
, ...)

135 
u_ch¬
 *
p
;

136 
va_li¡
 
¬gs
;

138 
	`va_¡¬t
(
¬gs
, 
fmt
);

139 
p
 = 
	`ngx_v¦´štf
(
buf
, 
Ï¡
, 
fmt
, 
¬gs
);

140 
	`va_’d
(
¬gs
);

142  
p
;

143 
	}
}

146 
u_ch¬
 *

147 
	$ngx_v¦´štf
(
u_ch¬
 *
buf
, u_ch¬ *
Ï¡
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

149 
u_ch¬
 *
p
, 
z”o
;

150 
d
;

151 
f
;

152 
size_t
 
Ën
, 
¦’
;

153 
št64_t
 
i64
;

154 
ušt64_t
 
ui64
, 
äac
;

155 
ngx_m£c_t
 
ms
;

156 
ngx_ušt_t
 
width
, 
sign
, 
hex
, 
max_width
, 
äac_width
, 
sÿË
, 
n
;

157 
ngx_¡r_t
 *
v
;

158 
ngx_v¬ŸbË_v®ue_t
 *
vv
;

160 *
fmt
 && 
buf
 < 
Ï¡
) {

167 ià(*
fmt
 == '%') {

169 
i64
 = 0;

170 
ui64
 = 0;

172 
z”o
 = (
u_ch¬
è((*++
fmt
 == '0') ? '0' : ' ');

173 
width
 = 0;

174 
sign
 = 1;

175 
hex
 = 0;

176 
max_width
 = 0;

177 
äac_width
 = 0;

178 
¦’
 = (
size_t
) -1;

180 *
fmt
 >= '0' && *fmt <= '9') {

181 
width
 = width * 10 + *
fmt
++ - '0';

186 *
fmt
) {

189 
sign
 = 0;

190 
fmt
++;

194 
max_width
 = 1;

195 
fmt
++;

199 
hex
 = 2;

200 
sign
 = 0;

201 
fmt
++;

205 
hex
 = 1;

206 
sign
 = 0;

207 
fmt
++;

211 
fmt
++;

213 *
fmt
 >= '0' && *fmt <= '9') {

214 
äac_width
 = f¿c_width * 10 + *
fmt
++ - '0';

220 
¦’
 = 
	`va_¬g
(
¬gs
, 
size_t
);

221 
fmt
++;

232 *
fmt
) {

235 
v
 = 
	`va_¬g
(
¬gs
, 
ngx_¡r_t
 *);

237 
Ën
 = 
	`ngx_mš
(((
size_t
è(
Ï¡
 - 
buf
)), 
v
->len);

238 
buf
 = 
	`ngx_ýymem
(buf, 
v
->
d©a
, 
Ën
);

239 
fmt
++;

244 
vv
 = 
	`va_¬g
(
¬gs
, 
ngx_v¬ŸbË_v®ue_t
 *);

246 
Ën
 = 
	`ngx_mš
(((
size_t
è(
Ï¡
 - 
buf
)), 
vv
->len);

247 
buf
 = 
	`ngx_ýymem
(buf, 
vv
->
d©a
, 
Ën
);

248 
fmt
++;

253 
p
 = 
	`va_¬g
(
¬gs
, 
u_ch¬
 *);

255 ià(
¦’
 =ð(
size_t
) -1) {

256 *
p
 && 
buf
 < 
Ï¡
) {

257 *
buf
++ = *
p
++;

261 
Ën
 = 
	`ngx_mš
(((
size_t
è(
Ï¡
 - 
buf
)), 
¦’
);

262 
buf
 = 
	`ngx_ýymem
(buf, 
p
, 
Ën
);

265 
fmt
++;

270 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, 
off_t
);

271 
sign
 = 1;

275 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, 
ngx_pid_t
);

276 
sign
 = 1;

280 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, 
time_t
);

281 
sign
 = 1;

285 
ms
 = (
ngx_m£c_t
è
	`va_¬g
(
¬gs
,‚gx_msec_t);

286 ià((
ngx_m£c_št_t
è
ms
 == -1) {

287 
sign
 = 1;

288 
i64
 = -1;

290 
sign
 = 0;

291 
ui64
 = (
ušt64_t
è
ms
;

296 ià(
sign
) {

297 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, 
ssize_t
);

299 
ui64
 = (
ušt64_t
è
	`va_¬g
(
¬gs
, 
size_t
);

304 ià(
sign
) {

305 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, 
ngx_št_t
);

307 
ui64
 = (
ušt64_t
è
	`va_¬g
(
¬gs
, 
ngx_ušt_t
);

310 ià(
max_width
) {

311 
width
 = 
NGX_INT_T_LEN
;

317 ià(
sign
) {

318 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, );

320 
ui64
 = (
ušt64_t
è
	`va_¬g
(
¬gs
, 
u_št
);

325 ià(
sign
) {

326 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, );

328 
ui64
 = (
ušt64_t
è
	`va_¬g
(
¬gs
, 
u_lÚg
);

333 ià(
sign
) {

334 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, 
št32_t
);

336 
ui64
 = (
ušt64_t
è
	`va_¬g
(
¬gs
, 
ušt32_t
);

341 ià(
sign
) {

342 
i64
 = 
	`va_¬g
(
¬gs
, 
št64_t
);

344 
ui64
 = 
	`va_¬g
(
¬gs
, 
ušt64_t
);

349 ià(
sign
) {

350 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, 
ngx_©omic_št_t
);

352 
ui64
 = (
ušt64_t
è
	`va_¬g
(
¬gs
, 
ngx_©omic_ušt_t
);

355 ià(
max_width
) {

356 
width
 = 
NGX_ATOMIC_T_LEN
;

362 
f
 = 
	`va_¬g
(
¬gs
, );

364 ià(
f
 < 0) {

365 *
buf
++ = '-';

366 
f
 = -f;

369 
ui64
 = (
št64_t
è
f
;

370 
äac
 = 0;

372 ià(
äac_width
) {

374 
sÿË
 = 1;

375 
n
 = 
äac_width
;‚;‚--) {

376 
sÿË
 *= 10;

379 
äac
 = (
ušt64_t
è((
f
 - (è
ui64
è* 
sÿË
 + 0.5);

381 ià(
äac
 =ð
sÿË
) {

382 
ui64
++;

383 
äac
 = 0;

387 
buf
 = 
	`ngx_¥rštf_num
(buf, 
Ï¡
, 
ui64
, 
z”o
, 0, 
width
);

389 ià(
äac_width
) {

390 ià(
buf
 < 
Ï¡
) {

391 *
buf
++ = '.';

394 
buf
 = 
	`ngx_¥rštf_num
(buf, 
Ï¡
, 
äac
, '0', 0, 
äac_width
);

397 
fmt
++;

401 #ià!(
NGX_WIN32
)

403 
i64
 = (
št64_t
è
	`va_¬g
(
¬gs
, 
¾im_t
);

404 
sign
 = 1;

409 
ui64
 = (
ušŒ_t
è
	`va_¬g
(
¬gs
, *);

410 
hex
 = 2;

411 
sign
 = 0;

412 
z”o
 = '0';

413 
width
 = 
NGX_PTR_SIZE
 * 2;

417 
d
 = 
	`va_¬g
(
¬gs
, );

418 *
buf
++ = (
u_ch¬
è(
d
 & 0xff);

419 
fmt
++;

424 *
buf
++ = '\0';

425 
fmt
++;

430 #ià(
NGX_WIN32
)

431 *
buf
++ = 
CR
;

433 *
buf
++ = 
LF
;

434 
fmt
++;

439 *
buf
++ = '%';

440 
fmt
++;

445 *
buf
++ = *
fmt
++;

450 ià(
sign
) {

451 ià(
i64
 < 0) {

452 *
buf
++ = '-';

453 
ui64
 = (
ušt64_t
è-
i64
;

456 
ui64
 = (
ušt64_t
è
i64
;

460 
buf
 = 
	`ngx_¥rštf_num
(buf, 
Ï¡
, 
ui64
, 
z”o
, 
hex
, 
width
);

462 
fmt
++;

465 *
buf
++ = *
fmt
++;

469  
buf
;

470 
	}
}

473 
u_ch¬
 *

474 
	$ngx_¥rštf_num
(
u_ch¬
 *
buf
, u_ch¬ *
Ï¡
, 
ušt64_t
 
ui64
, u_ch¬ 
z”o
,

475 
ngx_ušt_t
 
hexadecim®
,‚gx_ušt_ˆ
width
)

477 
u_ch¬
 *
p
, 
‹mp
[
NGX_INT64_LEN
 + 1];

482 
size_t
 
Ën
;

483 
ušt32_t
 
ui32
;

484 
u_ch¬
 
hex
[] = "0123456789abcdef";

485 
u_ch¬
 
HEX
[] = "0123456789ABCDEF";

487 
p
 = 
‹mp
 + 
NGX_INT64_LEN
;

489 ià(
hexadecim®
 == 0) {

491 ià(
ui64
 <ð(
ušt64_t
è
NGX_MAX_UINT32_VALUE
) {

508 
ui32
 = (
ušt32_t
è
ui64
;

511 *--
p
 = (
u_ch¬
è(
ui32
 % 10 + '0');

512 } 
ui32
 /= 10);

516 *--
p
 = (
u_ch¬
è(
ui64
 % 10 + '0');

517 } 
ui64
 /= 10);

520 } ià(
hexadecim®
 == 1) {

525 *--
p
 = 
hex
[(
ušt32_t
è(
ui64
 & 0xf)];

527 } 
ui64
 >>= 4);

534 *--
p
 = 
HEX
[(
ušt32_t
è(
ui64
 & 0xf)];

536 } 
ui64
 >>= 4);

541 
Ën
 = (
‹mp
 + 
NGX_INT64_LEN
è- 
p
;

543 
Ën
++ < 
width
 && 
buf
 < 
Ï¡
) {

544 *
buf
++ = 
z”o
;

549 
Ën
 = (
‹mp
 + 
NGX_INT64_LEN
è- 
p
;

551 ià(
buf
 + 
Ën
 > 
Ï¡
) {

552 
Ën
 = 
Ï¡
 - 
buf
;

555  
	`ngx_ýymem
(
buf
, 
p
, 
Ën
);

556 
	}
}

566 
ngx_št_t


567 
	$ngx_¡rÿ£cmp
(
u_ch¬
 *
s1
, u_ch¬ *
s2
)

569 
ngx_ušt_t
 
c1
, 
c2
;

572 
c1
 = (
ngx_ušt_t
è*
s1
++;

573 
c2
 = (
ngx_ušt_t
è*
s2
++;

575 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

576 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

578 ià(
c1
 =ð
c2
) {

580 ià(
c1
) {

587  
c1
 - 
c2
;

589 
	}
}

592 
ngx_št_t


593 
	$ngx_¡ºÿ£cmp
(
u_ch¬
 *
s1
, u_ch¬ *
s2
, 
size_t
 
n
)

595 
ngx_ušt_t
 
c1
, 
c2
;

597 
n
) {

598 
c1
 = (
ngx_ušt_t
è*
s1
++;

599 
c2
 = (
ngx_ušt_t
è*
s2
++;

601 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

602 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

604 ià(
c1
 =ð
c2
) {

606 ià(
c1
) {

607 
n
--;

614  
c1
 - 
c2
;

618 
	}
}

621 
u_ch¬
 *

622 
	$ngx_¡º¡r
(
u_ch¬
 *
s1
, *
s2
, 
size_t
 
Ën
)

624 
u_ch¬
 
c1
, 
c2
;

625 
size_t
 
n
;

627 
c2
 = *(
u_ch¬
 *è
s2
++;

629 
n
 = 
	`ngx_¡¾’
(
s2
);

633 ià(
Ën
-- == 0) {

634  
NULL
;

637 
c1
 = *
s1
++;

639 ià(
c1
 == 0) {

640  
NULL
;

643 } 
c1
 !ð
c2
);

645 ià(
n
 > 
Ën
) {

646  
NULL
;

649 } 
	`ngx_¡ºcmp
(
s1
, (
u_ch¬
 *è
s2
, 
n
) != 0);

651  --
s1
;

652 
	}
}

661 
u_ch¬
 *

662 
	$ngx_¡r¡º
(
u_ch¬
 *
s1
, *
s2
, 
size_t
 
n
)

664 
u_ch¬
 
c1
, 
c2
;

666 
c2
 = *(
u_ch¬
 *è
s2
++;

670 
c1
 = *
s1
++;

672 ià(
c1
 == 0) {

673  
NULL
;

676 } 
c1
 !ð
c2
);

678 } 
	`ngx_¡ºcmp
(
s1
, (
u_ch¬
 *è
s2
, 
n
) != 0);

680  --
s1
;

681 
	}
}

684 
u_ch¬
 *

685 
	$ngx_¡rÿ£¡º
(
u_ch¬
 *
s1
, *
s2
, 
size_t
 
n
)

687 
ngx_ušt_t
 
c1
, 
c2
;

689 
c2
 = (
ngx_ušt_t
è*
s2
++;

690 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

694 
c1
 = (
ngx_ušt_t
è*
s1
++;

696 ià(
c1
 == 0) {

697  
NULL
;

700 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

702 } 
c1
 !ð
c2
);

704 } 
	`ngx_¡ºÿ£cmp
(
s1
, (
u_ch¬
 *è
s2
, 
n
) != 0);

706  --
s1
;

707 
	}
}

716 
u_ch¬
 *

717 
	$ngx_¡¾ÿ£¡º
(
u_ch¬
 *
s1
, u_ch¬ *
Ï¡
, u_ch¬ *
s2
, 
size_t
 
n
)

719 
ngx_ušt_t
 
c1
, 
c2
;

721 
c2
 = (
ngx_ušt_t
è*
s2
++;

722 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

723 
Ï¡
 -ð
n
;

727 ià(
s1
 >ð
Ï¡
) {

728  
NULL
;

731 
c1
 = (
ngx_ušt_t
è*
s1
++;

733 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

735 } 
c1
 !ð
c2
);

737 } 
	`ngx_¡ºÿ£cmp
(
s1
, 
s2
, 
n
) != 0);

739  --
s1
;

740 
	}
}

743 
ngx_št_t


744 
	$ngx_r¡ºcmp
(
u_ch¬
 *
s1
, u_ch¬ *
s2
, 
size_t
 
n
)

746 ià(
n
 == 0) {

750 
n
--;

753 ià(
s1
[
n
] !ð
s2
[n]) {

754  
s1
[
n
] - 
s2
[n];

757 ià(
n
 == 0) {

761 
n
--;

763 
	}
}

766 
ngx_št_t


767 
	$ngx_r¡ºÿ£cmp
(
u_ch¬
 *
s1
, u_ch¬ *
s2
, 
size_t
 
n
)

769 
u_ch¬
 
c1
, 
c2
;

771 ià(
n
 == 0) {

775 
n
--;

778 
c1
 = 
s1
[
n
];

779 ià(
c1
 >= 'a' && c1 <= 'z') {

780 
c1
 -= 'a' - 'A';

783 
c2
 = 
s2
[
n
];

784 ià(
c2
 >= 'a' && c2 <= 'z') {

785 
c2
 -= 'a' - 'A';

788 ià(
c1
 !ð
c2
) {

789  
c1
 - 
c2
;

792 ià(
n
 == 0) {

796 
n
--;

798 
	}
}

801 
ngx_št_t


802 
	$ngx_memn2cmp
(
u_ch¬
 *
s1
, u_ch¬ *
s2
, 
size_t
 
n1
, size_ˆ
n2
)

804 
size_t
 
n
;

805 
ngx_št_t
 
m
, 
z
;

807 ià(
n1
 <ð
n2
) {

808 
n
 = 
n1
;

809 
z
 = -1;

812 
n
 = 
n2
;

813 
z
 = 1;

816 
m
 = 
	`ngx_memcmp
(
s1
, 
s2
, 
n
);

818 ià(
m
 || 
n1
 =ð
n2
) {

819  
m
;

822  
z
;

823 
	}
}

826 
ngx_št_t


827 
	$ngx_dns_¡rcmp
(
u_ch¬
 *
s1
, u_ch¬ *
s2
)

829 
ngx_ušt_t
 
c1
, 
c2
;

832 
c1
 = (
ngx_ušt_t
è*
s1
++;

833 
c2
 = (
ngx_ušt_t
è*
s2
++;

835 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

836 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

838 ià(
c1
 =ð
c2
) {

840 ià(
c1
) {

849 
c1
 = (c1 == '.') ? ' ' : c1;

850 
c2
 = (c2 == '.') ? ' ' : c2;

852  
c1
 - 
c2
;

854 
	}
}

857 
ngx_št_t


858 
	$ngx_fž’ame_cmp
(
u_ch¬
 *
s1
, u_ch¬ *
s2
, 
size_t
 
n
)

860 
ngx_ušt_t
 
c1
, 
c2
;

862 
n
) {

863 
c1
 = (
ngx_ušt_t
è*
s1
++;

864 
c2
 = (
ngx_ušt_t
è*
s2
++;

866 #ià(
NGX_HAVE_CASELESS_FILESYSTEM
)

867 
c1
 = 
	`tÞow”
(c1);

868 
c2
 = 
	`tÞow”
(c2);

871 ià(
c1
 =ð
c2
) {

873 ià(
c1
) {

874 
n
--;

883 ià(
c1
 =ð0 || 
c2
 == 0) {

884  
c1
 - 
c2
;

887 
c1
 = (c1 == '/') ? 0 : c1;

888 
c2
 = (c2 == '/') ? 0 : c2;

890  
c1
 - 
c2
;

894 
	}
}

897 
ngx_št_t


898 
	$ngx_©oi
(
u_ch¬
 *
lše
, 
size_t
 
n
)

900 
ngx_št_t
 
v®ue
;

902 ià(
n
 == 0) {

903  
NGX_ERROR
;

906 
v®ue
 = 0; 
n
--; 
lše
++) {

907 ià(*
lše
 < '0' || *line > '9') {

908  
NGX_ERROR
;

911 
v®ue
 = v®u* 10 + (*
lše
 - '0');

914 ià(
v®ue
 < 0) {

915  
NGX_ERROR
;

918  
v®ue
;

920 
	}
}

925 
ngx_št_t


926 
	$ngx_©oå
(
u_ch¬
 *
lše
, 
size_t
 
n
, size_ˆ
pošt
)

928 
ngx_št_t
 
v®ue
;

929 
ngx_ušt_t
 
dÙ
;

931 ià(
n
 == 0) {

932  
NGX_ERROR
;

935 
dÙ
 = 0;

937 
v®ue
 = 0; 
n
--; 
lše
++) {

939 ià(
pošt
 == 0) {

940  
NGX_ERROR
;

943 ià(*
lše
 == '.') {

944 ià(
dÙ
) {

945  
NGX_ERROR
;

948 
dÙ
 = 1;

952 ià(*
lše
 < '0' || *line > '9') {

953  
NGX_ERROR
;

956 
v®ue
 = v®u* 10 + (*
lše
 - '0');

957 
pošt
 -ð
dÙ
;

960 
pošt
--) {

961 
v®ue
 = value * 10;

964 ià(
v®ue
 < 0) {

965  
NGX_ERROR
;

968  
v®ue
;

970 
	}
}

973 
ssize_t


974 
	$ngx_©osz
(
u_ch¬
 *
lše
, 
size_t
 
n
)

976 
ssize_t
 
v®ue
;

978 ià(
n
 == 0) {

979  
NGX_ERROR
;

982 
v®ue
 = 0; 
n
--; 
lše
++) {

983 ià(*
lše
 < '0' || *line > '9') {

984  
NGX_ERROR
;

987 
v®ue
 = v®u* 10 + (*
lše
 - '0');

990 ià(
v®ue
 < 0) {

991  
NGX_ERROR
;

994  
v®ue
;

996 
	}
}

999 
off_t


1000 
	$ngx_©oof
(
u_ch¬
 *
lše
, 
size_t
 
n
)

1002 
off_t
 
v®ue
;

1004 ià(
n
 == 0) {

1005  
NGX_ERROR
;

1008 
v®ue
 = 0; 
n
--; 
lše
++) {

1009 ià(*
lše
 < '0' || *line > '9') {

1010  
NGX_ERROR
;

1013 
v®ue
 = v®u* 10 + (*
lše
 - '0');

1016 ià(
v®ue
 < 0) {

1017  
NGX_ERROR
;

1020  
v®ue
;

1022 
	}
}

1025 
time_t


1026 
	$ngx_©Ùm
(
u_ch¬
 *
lše
, 
size_t
 
n
)

1028 
time_t
 
v®ue
;

1030 ià(
n
 == 0) {

1031  
NGX_ERROR
;

1034 
v®ue
 = 0; 
n
--; 
lše
++) {

1035 ià(*
lše
 < '0' || *line > '9') {

1036  
NGX_ERROR
;

1039 
v®ue
 = v®u* 10 + (*
lše
 - '0');

1042 ià(
v®ue
 < 0) {

1043  
NGX_ERROR
;

1046  
v®ue
;

1048 
	}
}

1051 
ngx_št_t


1052 
	$ngx_hextoi
(
u_ch¬
 *
lše
, 
size_t
 
n
)

1054 
u_ch¬
 
c
, 
ch
;

1055 
ngx_št_t
 
v®ue
;

1057 ià(
n
 == 0) {

1058  
NGX_ERROR
;

1061 
v®ue
 = 0; 
n
--; 
lše
++) {

1062 
ch
 = *
lše
;

1064 ià(
ch
 >= '0' && ch <= '9') {

1065 
v®ue
 = v®u* 16 + (
ch
 - '0');

1069 
c
 = (
u_ch¬
è(
ch
 | 0x20);

1071 ià(
c
 >= 'a' && c <= 'f') {

1072 
v®ue
 = v®u* 16 + (
c
 - 'a' + 10);

1076  
NGX_ERROR
;

1079 ià(
v®ue
 < 0) {

1080  
NGX_ERROR
;

1083  
v®ue
;

1085 
	}
}

1088 
u_ch¬
 *

1089 
	$ngx_hex_dump
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
Ën
)

1091 
u_ch¬
 
hex
[] = "0123456789abcdef";

1093 
Ën
--) {

1094 *
d¡
++ = 
hex
[*
¤c
 >> 4];

1095 *
d¡
++ = 
hex
[*
¤c
++ & 0xf];

1098  
d¡
;

1099 
	}
}

1103 
	$ngx_’code_ba£64
(
ngx_¡r_t
 *
d¡
,‚gx_¡r_ˆ*
¤c
)

1105 
u_ch¬
 
basis64
[] =

1108 
	`ngx_’code_ba£64_š‹º®
(
d¡
, 
¤c
, 
basis64
, 1);

1109 
	}
}

1113 
	$ngx_’code_ba£64u¾
(
ngx_¡r_t
 *
d¡
,‚gx_¡r_ˆ*
¤c
)

1115 
u_ch¬
 
basis64
[] =

1118 
	`ngx_’code_ba£64_š‹º®
(
d¡
, 
¤c
, 
basis64
, 0);

1119 
	}
}

1123 
	$ngx_’code_ba£64_š‹º®
(
ngx_¡r_t
 *
d¡
,‚gx_¡r_ˆ*
¤c
, cÚ¡ 
u_ch¬
 *
basis
,

1124 
ngx_ušt_t
 
·ddšg
)

1126 
u_ch¬
 *
d
, *
s
;

1127 
size_t
 
Ën
;

1129 
Ën
 = 
¤c
->len;

1130 
s
 = 
¤c
->
d©a
;

1131 
d
 = 
d¡
->
d©a
;

1133 
Ën
 > 2) {

1134 *
d
++ = 
basis
[(
s
[0] >> 2) & 0x3f];

1135 *
d
++ = 
basis
[((
s
[0] & 3) << 4) | (s[1] >> 4)];

1136 *
d
++ = 
basis
[((
s
[1] & 0x0f) << 2) | (s[2] >> 6)];

1137 *
d
++ = 
basis
[
s
[2] & 0x3f];

1139 
s
 += 3;

1140 
Ën
 -= 3;

1143 ià(
Ën
) {

1144 *
d
++ = 
basis
[(
s
[0] >> 2) & 0x3f];

1146 ià(
Ën
 == 1) {

1147 *
d
++ = 
basis
[(
s
[0] & 3) << 4];

1148 ià(
·ddšg
) {

1149 *
d
++ = '=';

1153 *
d
++ = 
basis
[((
s
[0] & 3) << 4) | (s[1] >> 4)];

1154 *
d
++ = 
basis
[(
s
[1] & 0x0f) << 2];

1157 ià(
·ddšg
) {

1158 *
d
++ = '=';

1162 
d¡
->
Ën
 = 
d
 - d¡->
d©a
;

1163 
	}
}

1166 
ngx_št_t


1167 
	$ngx_decode_ba£64
(
ngx_¡r_t
 *
d¡
,‚gx_¡r_ˆ*
¤c
)

1169 
u_ch¬
 
basis64
[] = {

1189  
	`ngx_decode_ba£64_š‹º®
(
d¡
, 
¤c
, 
basis64
);

1190 
	}
}

1193 
ngx_št_t


1194 
	$ngx_decode_ba£64u¾
(
ngx_¡r_t
 *
d¡
,‚gx_¡r_ˆ*
¤c
)

1196 
u_ch¬
 
basis64
[] = {

1216  
	`ngx_decode_ba£64_š‹º®
(
d¡
, 
¤c
, 
basis64
);

1217 
	}
}

1220 
ngx_št_t


1221 
	$ngx_decode_ba£64_š‹º®
(
ngx_¡r_t
 *
d¡
,‚gx_¡r_ˆ*
¤c
, cÚ¡ 
u_ch¬
 *
basis
)

1223 
size_t
 
Ën
;

1224 
u_ch¬
 *
d
, *
s
;

1226 
Ën
 = 0;†’ < 
¤c
->len;†en++) {

1227 ià(
¤c
->
d©a
[
Ën
] == '=') {

1231 ià(
basis
[
¤c
->
d©a
[
Ën
]] == 77) {

1232  
NGX_ERROR
;

1236 ià(
Ën
 % 4 == 1) {

1237  
NGX_ERROR
;

1240 
s
 = 
¤c
->
d©a
;

1241 
d
 = 
d¡
->
d©a
;

1243 
Ën
 > 3) {

1244 *
d
++ = (
u_ch¬
è(
basis
[
s
[0]] << 2 | basis[s[1]] >> 4);

1245 *
d
++ = (
u_ch¬
è(
basis
[
s
[1]] << 4 | basis[s[2]] >> 2);

1246 *
d
++ = (
u_ch¬
è(
basis
[
s
[2]] << 6 | basis[s[3]]);

1248 
s
 += 4;

1249 
Ën
 -= 4;

1252 ià(
Ën
 > 1) {

1253 *
d
++ = (
u_ch¬
è(
basis
[
s
[0]] << 2 | basis[s[1]] >> 4);

1256 ià(
Ën
 > 2) {

1257 *
d
++ = (
u_ch¬
è(
basis
[
s
[1]] << 4 | basis[s[2]] >> 2);

1260 
d¡
->
Ën
 = 
d
 - d¡->
d©a
;

1262  
NGX_OK
;

1263 
	}
}

1275 
ušt32_t


1276 
	$ngx_utf8_decode
(
u_ch¬
 **
p
, 
size_t
 
n
)

1278 
size_t
 
Ën
;

1279 
ušt32_t
 
u
, 
i
, 
v®id
;

1281 
u
 = **
p
;

1283 ià(
u
 >= 0xf0) {

1285 
u
 &= 0x07;

1286 
v®id
 = 0xffff;

1287 
Ën
 = 3;

1289 } ià(
u
 >= 0xe0) {

1291 
u
 &= 0x0f;

1292 
v®id
 = 0x7ff;

1293 
Ën
 = 2;

1295 } ià(
u
 >= 0xc2) {

1297 
u
 &= 0x1f;

1298 
v®id
 = 0x7f;

1299 
Ën
 = 1;

1302 (*
p
)++;

1306 ià(
n
 - 1 < 
Ën
) {

1310 (*
p
)++;

1312 
Ën
) {

1313 
i
 = *(*
p
)++;

1315 ià(
i
 < 0x80) {

1319 
u
 = (u << 6è| (
i
 & 0x3f);

1321 
Ën
--;

1324 ià(
u
 > 
v®id
) {

1325  
u
;

1329 
	}
}

1332 
size_t


1333 
	$ngx_utf8_Ëngth
(
u_ch¬
 *
p
, 
size_t
 
n
)

1335 
u_ch¬
 
c
, *
Ï¡
;

1336 
size_t
 
Ën
;

1338 
Ï¡
 = 
p
 + 
n
;

1340 
Ën
 = 0; 
p
 < 
Ï¡
;†en++) {

1342 
c
 = *
p
;

1344 ià(
c
 < 0x80) {

1345 
p
++;

1349 ià(
	`ngx_utf8_decode
(&
p
, 
n
) > 0x10ffff) {

1351  
n
;

1355  
Ën
;

1356 
	}
}

1359 
u_ch¬
 *

1360 
	$ngx_utf8_ýy¡º
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
n
, size_ˆ
Ën
)

1362 
u_ch¬
 
c
, *
Ãxt
;

1364 ià(
n
 == 0) {

1365  
d¡
;

1368 --
n
) {

1370 
c
 = *
¤c
;

1371 *
d¡
 = 
c
;

1373 ià(
c
 < 0x80) {

1375 ià(
c
 != '\0') {

1376 
d¡
++;

1377 
¤c
++;

1378 
Ën
--;

1383  
d¡
;

1386 
Ãxt
 = 
¤c
;

1388 ià(
	`ngx_utf8_decode
(&
Ãxt
, 
Ën
) > 0x10ffff) {

1393 
¤c
 < 
Ãxt
) {

1394 *
d¡
++ = *
¤c
++;

1395 
Ën
--;

1399 *
d¡
 = '\0';

1401  
d¡
;

1402 
	}
}

1405 
ušŒ_t


1406 
	$ngx_esÿ³_uri
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
size
, 
ngx_ušt_t
 
ty³
)

1408 
ngx_ušt_t
 
n
;

1409 
ušt32_t
 *
esÿ³
;

1410 
u_ch¬
 
hex
[] = "0123456789ABCDEF";

1414 
ušt32_t
 
uri
[] = {

1434 
ušt32_t
 
¬gs
[] = {

1454 
ušt32_t
 
uri_compÚ’t
[] = {

1474 
ušt32_t
 
html
[] = {

1494 
ušt32_t
 
»äesh
[] = {

1514 
ušt32_t
 
memÿched
[] = {

1534 
ušt32_t
 *
m­
[] =

1535 { 
uri
, 
¬gs
, 
uri_compÚ’t
, 
html
, 
»äesh
, 
memÿched
, memcached };

1538 
esÿ³
 = 
m­
[
ty³
];

1540 ià(
d¡
 =ð
NULL
) {

1544 
n
 = 0;

1546 
size
) {

1547 ià(
esÿ³
[*
¤c
 >> 5] & (1 << (*src & 0x1f))) {

1548 
n
++;

1550 
¤c
++;

1551 
size
--;

1554  (
ušŒ_t
è
n
;

1557 
size
) {

1558 ià(
esÿ³
[*
¤c
 >> 5] & (1 << (*src & 0x1f))) {

1559 *
d¡
++ = '%';

1560 *
d¡
++ = 
hex
[*
¤c
 >> 4];

1561 *
d¡
++ = 
hex
[*
¤c
 & 0xf];

1562 
¤c
++;

1565 *
d¡
++ = *
¤c
++;

1567 
size
--;

1570  (
ušŒ_t
è
d¡
;

1571 
	}
}

1575 
	$ngx_uÃsÿ³_uri
(
u_ch¬
 **
d¡
, u_ch¬ **
¤c
, 
size_t
 
size
, 
ngx_ušt_t
 
ty³
)

1577 
u_ch¬
 *
d
, *
s
, 
ch
, 
c
, 
decoded
;

1579 
sw_usu®
 = 0,

1580 
sw_quÙed
,

1581 
sw_quÙed_£cÚd


1582 } 
¡©e
;

1584 
d
 = *
d¡
;

1585 
s
 = *
¤c
;

1587 
¡©e
 = 0;

1588 
decoded
 = 0;

1590 
size
--) {

1592 
ch
 = *
s
++;

1594 
¡©e
) {

1595 
sw_usu®
:

1596 ià(
ch
 == '?'

1597 && (
ty³
 & (
NGX_UNESCAPE_URI
|
NGX_UNESCAPE_REDIRECT
)))

1599 *
d
++ = 
ch
;

1600 
dÚe
;

1603 ià(
ch
 == '%') {

1604 
¡©e
 = 
sw_quÙed
;

1608 *
d
++ = 
ch
;

1611 
sw_quÙed
:

1613 ià(
ch
 >= '0' && ch <= '9') {

1614 
decoded
 = (
u_ch¬
è(
ch
 - '0');

1615 
¡©e
 = 
sw_quÙed_£cÚd
;

1619 
c
 = (
u_ch¬
è(
ch
 | 0x20);

1620 ià(
c
 >= 'a' && c <= 'f') {

1621 
decoded
 = (
u_ch¬
è(
c
 - 'a' + 10);

1622 
¡©e
 = 
sw_quÙed_£cÚd
;

1628 
¡©e
 = 
sw_usu®
;

1630 *
d
++ = 
ch
;

1634 
sw_quÙed_£cÚd
:

1636 
¡©e
 = 
sw_usu®
;

1638 ià(
ch
 >= '0' && ch <= '9') {

1639 
ch
 = (
u_ch¬
è((
decoded
 << 4) + ch - '0');

1641 ià(
ty³
 & 
NGX_UNESCAPE_REDIRECT
) {

1642 ià(
ch
 > '%' && ch < 0x7f) {

1643 *
d
++ = 
ch
;

1647 *
d
++ = '%'; *d++ = *(
s
 - 2); *d++ = *(s - 1);

1652 *
d
++ = 
ch
;

1657 
c
 = (
u_ch¬
è(
ch
 | 0x20);

1658 ià(
c
 >= 'a' && c <= 'f') {

1659 
ch
 = (
u_ch¬
è((
decoded
 << 4è+ 
c
 - 'a' + 10);

1661 ià(
ty³
 & 
NGX_UNESCAPE_URI
) {

1662 ià(
ch
 == '?') {

1663 *
d
++ = 
ch
;

1664 
dÚe
;

1667 *
d
++ = 
ch
;

1671 ià(
ty³
 & 
NGX_UNESCAPE_REDIRECT
) {

1672 ià(
ch
 == '?') {

1673 *
d
++ = 
ch
;

1674 
dÚe
;

1677 ià(
ch
 > '%' && ch < 0x7f) {

1678 *
d
++ = 
ch
;

1682 *
d
++ = '%'; *d++ = *(
s
 - 2); *d++ = *(s - 1);

1686 *
d
++ = 
ch
;

1697 
dÚe
:

1699 *
d¡
 = 
d
;

1700 *
¤c
 = 
s
;

1701 
	}
}

1704 
ušŒ_t


1705 
	$ngx_esÿ³_html
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
size
)

1707 
u_ch¬
 
ch
;

1708 
ngx_ušt_t
 
Ën
;

1710 ià(
d¡
 =ð
NULL
) {

1712 
Ën
 = 0;

1714 
size
) {

1715 *
¤c
++) {

1718 
Ën
 += ("&lt;") - 2;

1722 
Ën
 += ("&gt;") - 2;

1726 
Ën
 += ("&amp;") - 2;

1730 
Ën
 += ("&quot;") - 2;

1736 
size
--;

1739  (
ušŒ_t
è
Ën
;

1742 
size
) {

1743 
ch
 = *
¤c
++;

1745 
ch
) {

1748 *
d¡
++ = '&'; *dst++ = 'l'; *dst++ = 't'; *dst++ = ';';

1752 *
d¡
++ = '&'; *dst++ = 'g'; *dst++ = 't'; *dst++ = ';';

1756 *
d¡
++ = '&'; *dst++ = 'a'; *dst++ = 'm'; *dst++ = 'p';

1757 *
d¡
++ = ';';

1761 *
d¡
++ = '&'; *dst++ = 'q'; *dst++ = 'u'; *dst++ = 'o';

1762 *
d¡
++ = 't'; *dst++ = ';';

1766 *
d¡
++ = 
ch
;

1769 
size
--;

1772  (
ušŒ_t
è
d¡
;

1773 
	}
}

1777 
	$ngx_¡r_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

1778 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
)

1780 
ngx_¡r_node_t
 *
n
, *
t
;

1781 
ngx_rbŒ“_node_t
 **
p
;

1785 
n
 = (
ngx_¡r_node_t
 *è
node
;

1786 
t
 = (
ngx_¡r_node_t
 *è
‹mp
;

1788 ià(
node
->
key
 !ð
‹mp
->key) {

1790 
p
 = (
node
->
key
 < 
‹mp
->keyè? &‹mp->
Ëá
 : &‹mp->
right
;

1792 } ià(
n
->
¡r
.
Ën
 !ð
t
->str.len) {

1794 
p
 = (
n
->
¡r
.
Ën
 < 
t
->¡r.Ënè? &
‹mp
->
Ëá
 : &‹mp->
right
;

1797 
p
 = (
	`ngx_memcmp
(
n
->
¡r
.
d©a
, 
t
->¡r.d©a,‚->¡r.
Ën
) < 0)

1798 ? &
‹mp
->
Ëá
 : &‹mp->
right
;

1801 ià(*
p
 =ð
£Áš–
) {

1805 
‹mp
 = *
p
;

1808 *
p
 = 
node
;

1809 
node
->
·»Á
 = 
‹mp
;

1810 
node
->
Ëá
 = 
£Áš–
;

1811 
node
->
right
 = 
£Áš–
;

1812 
	`ngx_rbt_»d
(
node
);

1813 
	}
}

1816 
ngx_¡r_node_t
 *

1817 
	$ngx_¡r_rbŒ“_lookup
(
ngx_rbŒ“_t
 *
rbŒ“
, 
ngx_¡r_t
 *
v®
, 
ušt32_t
 
hash
)

1819 
ngx_št_t
 
rc
;

1820 
ngx_¡r_node_t
 *
n
;

1821 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

1823 
node
 = 
rbŒ“
->
roÙ
;

1824 
£Áš–
 = 
rbŒ“
->sentinel;

1826 
node
 !ð
£Áš–
) {

1828 
n
 = (
ngx_¡r_node_t
 *è
node
;

1830 ià(
hash
 !ð
node
->
key
) {

1831 
node
 = (
hash
 <‚ode->
key
è?‚ode->
Ëá
 :‚ode->
right
;

1835 ià(
v®
->
Ën
 !ð
n
->
¡r
.len) {

1836 
node
 = (
v®
->
Ën
 < 
n
->
¡r
.Ënè?‚ode->
Ëá
 :‚ode->
right
;

1840 
rc
 = 
	`ngx_memcmp
(
v®
->
d©a
, 
n
->
¡r
.d©a, v®->
Ën
);

1842 ià(
rc
 < 0) {

1843 
node
 =‚ode->
Ëá
;

1847 ià(
rc
 > 0) {

1848 
node
 =‚ode->
right
;

1852  
n
;

1855  
NULL
;

1856 
	}
}

1862 
ngx_sÜt
(*
ba£
, 
size_t
 
n
, size_ˆ
size
,

1863 
	$ngx_št_t
 (*
cmp
)(const *, const *))

1865 
u_ch¬
 *
p1
, *
p2
, *
p
;

1867 
p
 = 
	`ngx_®loc
(
size
, 
ngx_cyþe
->
log
);

1868 ià(
p
 =ð
NULL
) {

1872 
p1
 = (
u_ch¬
 *è
ba£
 + 
size
;

1873 
p1
 < (
u_ch¬
 *è
ba£
 + 
n
 * 
size
;

1874 
p1
 +ð
size
)

1876 
	`ngx_memýy
(
p
, 
p1
, 
size
);

1878 
p2
 = 
p1
;

1879 
p2
 > (
u_ch¬
 *è
ba£
 && 
	`cmp
Õ2 - 
size
, 
p
) > 0;

1880 
p2
 -ð
size
)

1882 
	`ngx_memýy
(
p2
,…2 - 
size
, size);

1885 
	`ngx_memýy
(
p2
, 
p
, 
size
);

1888 
	`ngx_ä“
(
p
);

1889 
	}
}

1892 #ià(
NGX_MEMCPY_LIMIT
)

1895 
	$ngx_memýy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
n
)

1897 ià(
n
 > 
NGX_MEMCPY_LIMIT
) {

1898 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0, "memýy %uz by‹s", 
n
);

1899 
	`ngx_debug_pošt
();

1902  
	`memýy
(
d¡
, 
¤c
, 
n
);

1903 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_syslog.c

7 
	~<ngx_cÚfig.h
>

8 
	~<ngx_cÜe.h
>

9 
	~<ngx_ev’t.h
>

12 
	#NGX_SYSLOG_MAX_STR
 \

13 
NGX_MAX_ERROR_STR
 + ("<255>Jan 01 00:00:00 ") - 1 \

14 + (
NGX_MAXHOSTNAMELEN
 - 1) + 1 \

15 + 32 + 2

	)

18 *
ngx_sy¦og_·r£_¬gs
(
ngx_cÚf_t
 *
cf
, 
ngx_sy¦og_³”_t
 *
³”
);

19 
ngx_št_t
 
ngx_sy¦og_š™_³”
(
ngx_sy¦og_³”_t
 *
³”
);

20 
ngx_sy¦og_þ—nup
(*
d©a
);

23 *
	gçcž™›s
[] = {

27 
NULL


31 *
	g£v”™›s
[] = {

32 "em”g", "®”t", "ü™", "”rÜ", "w¬n", "nÙiû", "šfo", "debug", 
NULL


35 
ngx_log_t
 
	gngx_sy¦og_dummy_log
;

36 
ngx_ev’t_t
 
	gngx_sy¦og_dummy_ev’t
;

40 
	$ngx_sy¦og_´oûss_cÚf
(
ngx_cÚf_t
 *
cf
, 
ngx_sy¦og_³”_t
 *
³”
)

42 
³”
->
poÞ
 = 
cf
->pool;

43 
³”
->
çcž™y
 = 
NGX_CONF_UNSET_UINT
;

44 
³”
->
£v”™y
 = 
NGX_CONF_UNSET_UINT
;

46 ià(
	`ngx_sy¦og_·r£_¬gs
(
cf
, 
³”
è!ð
NGX_CONF_OK
) {

47  
NGX_CONF_ERROR
;

50 ià(
³”
->
£rv”
.
sockaddr
 =ð
NULL
) {

51 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

53  
NGX_CONF_ERROR
;

56 ià(
³”
->
çcž™y
 =ð
NGX_CONF_UNSET_UINT
) {

57 
³”
->
çcž™y
 = 23;

60 ià(
³”
->
£v”™y
 =ð
NGX_CONF_UNSET_UINT
) {

61 
³”
->
£v”™y
 = 6;

64 ià(
³”
->
g
.
d©a
 =ð
NULL
) {

65 
	`ngx_¡r_£t
(&
³”
->
g
, "nginx");

68 
³”
->
cÚn
.
fd
 = (
ngx_sock‘_t
) -1;

70  
NGX_CONF_OK
;

71 
	}
}

75 
	$ngx_sy¦og_·r£_¬gs
(
ngx_cÚf_t
 *
cf
, 
ngx_sy¦og_³”_t
 *
³”
)

77 
u_ch¬
 *
p
, *
comma
, 
c
;

78 
size_t
 
Ën
;

79 
ngx_¡r_t
 *
v®ue
;

80 
ngx_u¾_t
 
u
;

81 
ngx_ušt_t
 
i
;

83 
v®ue
 = 
cf
->
¬gs
->
–ts
;

85 
p
 = 
v®ue
[1].
d©a
 + ("syslog:") - 1;

88 
comma
 = (
u_ch¬
 *è
	`ngx_¡rchr
(
p
, ',');

90 ià(
comma
 !ð
NULL
) {

91 
Ën
 = 
comma
 - 
p
;

92 *
comma
 = '\0';

95 
Ën
 = 
v®ue
[1].
d©a
 + v®ue[1].ËÀ- 
p
;

98 ià(
	`ngx_¡ºcmp
(
p
, "server=", 7) == 0) {

100 ià(
³”
->
£rv”
.
sockaddr
 !ð
NULL
) {

101 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

103  
NGX_CONF_ERROR
;

106 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

108 
u
.
u¾
.
d©a
 = 
p
 + 7;

109 
u
.
u¾
.
Ën
 =†en - 7;

110 
u
.
deçuÉ_pÜt
 = 514;

112 ià(
	`ngx_·r£_u¾
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

113 ià(
u
.
”r
) {

114 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

116 
u
.
”r
, &u.
u¾
);

119  
NGX_CONF_ERROR
;

122 
³”
->
£rv”
 = 
u
.
addrs
[0];

124 } ià(
	`ngx_¡ºcmp
(
p
, "facility=", 9) == 0) {

126 ià(
³”
->
çcž™y
 !ð
NGX_CONF_UNSET_UINT
) {

127 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

129  
NGX_CONF_ERROR
;

132 
i
 = 0; 
çcž™›s
[i] !ð
NULL
; i++) {

134 ià(
	`ngx_¡rcmp
(
p
 + 9, 
çcž™›s
[
i
]) == 0) {

135 
³”
->
çcž™y
 = 
i
;

136 
Ãxt
;

140 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

141 "unknowÀsy¦og facž™y \"%s\"", 
p
 + 9);

142  
NGX_CONF_ERROR
;

144 } ià(
	`ngx_¡ºcmp
(
p
, "severity=", 9) == 0) {

146 ià(
³”
->
£v”™y
 !ð
NGX_CONF_UNSET_UINT
) {

147 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

149  
NGX_CONF_ERROR
;

152 
i
 = 0; 
£v”™›s
[i] !ð
NULL
; i++) {

154 ià(
	`ngx_¡rcmp
(
p
 + 9, 
£v”™›s
[
i
]) == 0) {

155 
³”
->
£v”™y
 = 
i
;

156 
Ãxt
;

160 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

161 "unknowÀsy¦og sev”™y \"%s\"", 
p
 + 9);

162  
NGX_CONF_ERROR
;

164 } ià(
	`ngx_¡ºcmp
(
p
, "tag=", 4) == 0) {

166 ià(
³”
->
g
.
d©a
 !ð
NULL
) {

167 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

169  
NGX_CONF_ERROR
;

176 ià(
Ën
 - 4 > 32) {

177 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

179  
NGX_CONF_ERROR
;

182 
i
 = 4; i < 
Ën
; i++) {

183 
c
 = 
	`ngx_tÞow”
(
p
[
i
]);

185 ià(
c
 < '0' || (c > '9' && c < 'a' && c != '_') || c > 'z') {

186 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

190  
NGX_CONF_ERROR
;

194 
³”
->
g
.
d©a
 = 
p
 + 4;

195 
³”
->
g
.
Ën
 =†en - 4;

198 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

199 "unknowÀsy¦og…¬am‘” \"%s\"", 
p
);

200  
NGX_CONF_ERROR
;

203 
Ãxt
:

205 ià(
comma
 =ð
NULL
) {

209 
p
 = 
comma
 + 1;

212  
NGX_CONF_OK
;

213 
	}
}

216 
u_ch¬
 *

217 
	$ngx_sy¦og_add_h—d”
(
ngx_sy¦og_³”_t
 *
³”
, 
u_ch¬
 *
buf
)

219 
ngx_ušt_t
 
´i
;

221 
´i
 = 
³”
->
çcž™y
 * 8 +…“r->
£v”™y
;

223  
	`ngx_¥rštf
(
buf
, "<%ui>%V %V %V: ", 
´i
, &
ngx_ÿched_sy¦og_time
,

224 &
ngx_cyþe
->
ho¡Çme
, &
³”
->
g
);

225 
	}
}

229 
	$ngx_sy¦og_wr™”
(
ngx_log_t
 *
log
, 
ngx_ušt_t
 
Ëv–
, 
u_ch¬
 *
buf
,

230 
size_t
 
Ën
)

232 
u_ch¬
 *
p
, 
msg
[
NGX_SYSLOG_MAX_STR
];

233 
ngx_ušt_t
 
h—d_Ën
;

234 
ngx_sy¦og_³”_t
 *
³”
;

236 
³”
 = 
log
->
wd©a
;

238 ià(
³”
->
busy
) {

242 
³”
->
busy
 = 1;

243 
³”
->
£v”™y
 = 
Ëv–
 - 1;

245 
p
 = 
	`ngx_sy¦og_add_h—d”
(
³”
, 
msg
);

246 
h—d_Ën
 = 
p
 - 
msg
;

248 
Ën
 -ð
NGX_LINEFEED_SIZE
;

250 ià(
Ën
 > 
NGX_SYSLOG_MAX_STR
 - 
h—d_Ën
) {

251 
Ën
 = 
NGX_SYSLOG_MAX_STR
 - 
h—d_Ën
;

254 
p
 = 
	`ngx_¢´štf
Õ, 
Ën
, "%s", 
buf
);

256 (è
	`ngx_sy¦og_£nd
(
³”
, 
msg
, 
p
 - msg);

258 
³”
->
busy
 = 0;

259 
	}
}

262 
ssize_t


263 
	$ngx_sy¦og_£nd
(
ngx_sy¦og_³”_t
 *
³”
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
)

265 
ssize_t
 
n
;

267 ià(
³”
->
cÚn
.
fd
 =ð(
ngx_sock‘_t
) -1) {

268 ià(
	`ngx_sy¦og_š™_³”
(
³”
è!ð
NGX_OK
) {

269  
NGX_ERROR
;

274 
³”
->
cÚn
.
log
 = 
ngx_cyþe
->log;

276 ià(
ngx_£nd
) {

277 
n
 = 
	`ngx_£nd
(&
³”
->
cÚn
, 
buf
, 
Ën
);

281 
n
 = 
ngx_os_io
.
	`£nd
(&
³”
->
cÚn
, 
buf
, 
Ën
);

284 #ià(
NGX_HAVE_UNIX_DOMAIN
)

286 ià(
n
 =ð
NGX_ERROR
 && 
³”
->
£rv”
.
sockaddr
->
§_çmžy
 =ð
AF_UNIX
) {

288 ià(
	`ngx_þo£_sock‘
(
³”
->
cÚn
.
fd
) == -1) {

289 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_sock‘_”ºo
,

290 
ngx_þo£_sock‘_n
 " failed");

293 
³”
->
cÚn
.
fd
 = (
ngx_sock‘_t
) -1;

298  
n
;

299 
	}
}

302 
ngx_št_t


303 
	$ngx_sy¦og_š™_³”
(
ngx_sy¦og_³”_t
 *
³”
)

305 
ngx_sock‘_t
 
fd
;

306 
ngx_poÞ_þ—nup_t
 *
þn
;

308 
³”
->
cÚn
.
»ad
 = &
ngx_sy¦og_dummy_ev’t
;

309 
³”
->
cÚn
.
wr™e
 = &
ngx_sy¦og_dummy_ev’t
;

311 
ngx_sy¦og_dummy_ev’t
.
log
 = &
ngx_sy¦og_dummy_log
;

313 
fd
 = 
	`ngx_sock‘
(
³”
->
£rv”
.
sockaddr
->
§_çmžy
, 
SOCK_DGRAM
, 0);

314 ià(
fd
 =ð(
ngx_sock‘_t
) -1) {

315 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_sock‘_”ºo
,

316 
ngx_sock‘_n
 " failed");

317  
NGX_ERROR
;

320 ià(
	`ngx_nÚblockšg
(
fd
) == -1) {

321 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_sock‘_”ºo
,

322 
ngx_nÚblockšg_n
 " failed");

323 
çžed
;

326 ià(
	`cÚÃù
(
fd
, 
³”
->
£rv”
.
sockaddr
,…“r->£rv”.
sockËn
) == -1) {

327 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_sock‘_”ºo
,

329 
çžed
;

332 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
³”
->
poÞ
, 0);

333 ià(
þn
 =ð
NULL
) {

334 
çžed
;

337 
þn
->
d©a
 = 
³”
;

338 
þn
->
hªdËr
 = 
ngx_sy¦og_þ—nup
;

340 
³”
->
cÚn
.
fd
 = fd;

343 
³”
->
cÚn
.
wr™e
->
»ady
 = 1;

345  
NGX_OK
;

347 
çžed
:

349 ià(
	`ngx_þo£_sock‘
(
fd
) == -1) {

350 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_sock‘_”ºo
,

351 
ngx_þo£_sock‘_n
 " failed");

354  
NGX_ERROR
;

355 
	}
}

359 
	$ngx_sy¦og_þ—nup
(*
d©a
)

361 
ngx_sy¦og_³”_t
 *
³”
 = 
d©a
;

364 
³”
->
busy
 = 1;

366 ià(
³”
->
cÚn
.
fd
 =ð(
ngx_sock‘_t
) -1) {

370 ià(
	`ngx_þo£_sock‘
(
³”
->
cÚn
.
fd
) == -1) {

371 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
ngx_sock‘_”ºo
,

372 
ngx_þo£_sock‘_n
 " failed");

374 
	}
}

	@/home/wuhong/github/google/ngx_google/src/core/ngx_times.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

21 
	#NGX_TIME_SLOTS
 64

	)

23 
ngx_ušt_t
 
	g¦Ù
;

24 
ngx_©omic_t
 
	gngx_time_lock
;

26 vÞ©ž
ngx_m£c_t
 
	gngx_cu¼’t_m£c
;

27 vÞ©ž
ngx_time_t
 *
	gngx_ÿched_time
;

28 vÞ©ž
ngx_¡r_t
 
	gngx_ÿched_”r_log_time
;

29 vÞ©ž
ngx_¡r_t
 
	gngx_ÿched_h‰p_time
;

30 vÞ©ž
ngx_¡r_t
 
	gngx_ÿched_h‰p_log_time
;

31 vÞ©ž
ngx_¡r_t
 
	gngx_ÿched_h‰p_log_iso8601
;

32 vÞ©ž
ngx_¡r_t
 
	gngx_ÿched_sy¦og_time
;

34 #ià!(
NGX_WIN32
)

42 
ngx_št_t
 
	gÿched_gmtoff
;

45 
ngx_time_t
 
	gÿched_time
[
NGX_TIME_SLOTS
];

46 
u_ch¬
 
	gÿched_”r_log_time
[
NGX_TIME_SLOTS
]

48 
u_ch¬
 
	gÿched_h‰p_time
[
NGX_TIME_SLOTS
]

50 
u_ch¬
 
	gÿched_h‰p_log_time
[
NGX_TIME_SLOTS
]

52 
u_ch¬
 
	gÿched_h‰p_log_iso8601
[
NGX_TIME_SLOTS
]

54 
u_ch¬
 
	gÿched_sy¦og_time
[
NGX_TIME_SLOTS
]

58 *
	gw“k
[] = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

59 *
	gmÚths
[] = { "Jan", "Feb", "Mar", "Apr", "May", "Jun",

63 
	$ngx_time_š™
()

65 
ngx_ÿched_”r_log_time
.
Ën
 = ("1970/09/28 12:00:00") - 1;

66 
ngx_ÿched_h‰p_time
.
Ën
 = ("Mon, 28 Sep 1970 06:00:00 GMT") - 1;

67 
ngx_ÿched_h‰p_log_time
.
Ën
 = ("28/Sep/1970:12:00:00 +0600") - 1;

68 
ngx_ÿched_h‰p_log_iso8601
.
Ën
 = ("1970-09-28T12:00:00+06:00") - 1;

69 
ngx_ÿched_sy¦og_time
.
Ën
 = ("Sep 28 12:00:00") - 1;

71 
ngx_ÿched_time
 = &
ÿched_time
[0];

73 
	`ngx_time_upd©e
();

74 
	}
}

78 
	$ngx_time_upd©e
()

80 
u_ch¬
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
;

81 
ngx_tm_t
 
tm
, 
gmt
;

82 
time_t
 
£c
;

83 
ngx_ušt_t
 
m£c
;

84 
ngx_time_t
 *

;

85 
timev®
 
tv
;

87 ià(!
	`ngx_Œylock
(&
ngx_time_lock
)) {

91 
	`ngx_g‘timeofday
(&
tv
);

93 
£c
 = 
tv
.
tv_£c
;

94 
m£c
 = 
tv
.
tv_u£c
 / 1000;

96 
ngx_cu¼’t_m£c
 = (
ngx_m£c_t
è
£c
 * 1000 + 
m£c
;

98 

 = &
ÿched_time
[
¦Ù
];

100 ià(

->
£c
 == sec) {

101 

->
m£c
 = msec;

102 
	`ngx_uÆock
(&
ngx_time_lock
);

106 ià(
¦Ù
 =ð
NGX_TIME_SLOTS
 - 1) {

107 
¦Ù
 = 0;

109 
¦Ù
++;

112 

 = &
ÿched_time
[
¦Ù
];

114 

->
£c
 = sec;

115 

->
m£c
 = msec;

117 
	`ngx_gmtime
(
£c
, &
gmt
);

120 
p0
 = &
ÿched_h‰p_time
[
¦Ù
][0];

122 (è
	`ngx_¥rštf
(
p0
, "%s, %02d %s %4d %02d:%02d:%02d GMT",

123 
w“k
[
gmt
.
ngx_tm_wday
], gmt.
ngx_tm_mday
,

124 
mÚths
[
gmt
.
ngx_tm_mÚ
 - 1], gmt.
ngx_tm_y—r
,

125 
gmt
.
ngx_tm_hour
, gmt.
ngx_tm_mš
, gmt.
ngx_tm_£c
);

127 #ià(
NGX_HAVE_GETTIMEZONE
)

129 

->
gmtoff
 = 
	`ngx_g‘timezÚe
();

130 
	`ngx_gmtime
(
£c
 + 

->
gmtoff
 * 60, &
tm
);

132 #–ià(
NGX_HAVE_GMTOFF
)

134 
	`ngx_loÿÉime
(
£c
, &
tm
);

135 
ÿched_gmtoff
 = (
ngx_št_t
è(
tm
.
ngx_tm_gmtoff
 / 60);

136 

->
gmtoff
 = 
ÿched_gmtoff
;

140 
	`ngx_loÿÉime
(
£c
, &
tm
);

141 
ÿched_gmtoff
 = 
	`ngx_timezÚe
(
tm
.
ngx_tm_isd¡
);

142 

->
gmtoff
 = 
ÿched_gmtoff
;

147 
p1
 = &
ÿched_”r_log_time
[
¦Ù
][0];

149 (è
	`ngx_¥rštf
(
p1
, "%4d/%02d/%02d %02d:%02d:%02d",

150 
tm
.
ngx_tm_y—r
,m.
ngx_tm_mÚ
,

151 
tm
.
ngx_tm_mday
,m.
ngx_tm_hour
,

152 
tm
.
ngx_tm_mš
,m.
ngx_tm_£c
);

155 
p2
 = &
ÿched_h‰p_log_time
[
¦Ù
][0];

157 (è
	`ngx_¥rštf
(
p2
, "%02d/%s/%d:%02d:%02d:%02d %c%02d%02d",

158 
tm
.
ngx_tm_mday
, 
mÚths
[tm.
ngx_tm_mÚ
 - 1],

159 
tm
.
ngx_tm_y—r
,m.
ngx_tm_hour
,

160 
tm
.
ngx_tm_mš
,m.
ngx_tm_£c
,

161 

->
gmtoff
 < 0 ? '-' : '+',

162 
	`ngx_abs
(

->
gmtoff
 / 60),‚gx_abs(tp->gmtoff % 60));

164 
p3
 = &
ÿched_h‰p_log_iso8601
[
¦Ù
][0];

166 (è
	`ngx_¥rštf
(
p3
, "%4d-%02d-%02dT%02d:%02d:%02d%c%02d:%02d",

167 
tm
.
ngx_tm_y—r
,m.
ngx_tm_mÚ
,

168 
tm
.
ngx_tm_mday
,m.
ngx_tm_hour
,

169 
tm
.
ngx_tm_mš
,m.
ngx_tm_£c
,

170 

->
gmtoff
 < 0 ? '-' : '+',

171 
	`ngx_abs
(

->
gmtoff
 / 60),‚gx_abs(tp->gmtoff % 60));

173 
p4
 = &
ÿched_sy¦og_time
[
¦Ù
][0];

175 (è
	`ngx_¥rštf
(
p4
, "%s %2d %02d:%02d:%02d",

176 
mÚths
[
tm
.
ngx_tm_mÚ
 - 1],m.
ngx_tm_mday
,

177 
tm
.
ngx_tm_hour
,m.
ngx_tm_mš
,m.
ngx_tm_£c
);

179 
	`ngx_memÜy_b¬r›r
();

181 
ngx_ÿched_time
 = 

;

182 
ngx_ÿched_h‰p_time
.
d©a
 = 
p0
;

183 
ngx_ÿched_”r_log_time
.
d©a
 = 
p1
;

184 
ngx_ÿched_h‰p_log_time
.
d©a
 = 
p2
;

185 
ngx_ÿched_h‰p_log_iso8601
.
d©a
 = 
p3
;

186 
ngx_ÿched_sy¦og_time
.
d©a
 = 
p4
;

188 
	`ngx_uÆock
(&
ngx_time_lock
);

189 
	}
}

192 #ià!(
NGX_WIN32
)

195 
	$ngx_time_sig§ã_upd©e
()

197 
u_ch¬
 *
p
, *
p2
;

198 
ngx_tm_t
 
tm
;

199 
time_t
 
£c
;

200 
ngx_time_t
 *

;

201 
timev®
 
tv
;

203 ià(!
	`ngx_Œylock
(&
ngx_time_lock
)) {

207 
	`ngx_g‘timeofday
(&
tv
);

209 
£c
 = 
tv
.
tv_£c
;

211 

 = &
ÿched_time
[
¦Ù
];

213 ià(

->
£c
 == sec) {

214 
	`ngx_uÆock
(&
ngx_time_lock
);

218 ià(
¦Ù
 =ð
NGX_TIME_SLOTS
 - 1) {

219 
¦Ù
 = 0;

221 
¦Ù
++;

224 

 = &
ÿched_time
[
¦Ù
];

226 

->
£c
 = 0;

228 
	`ngx_gmtime
(
£c
 + 
ÿched_gmtoff
 * 60, &
tm
);

230 
p
 = &
ÿched_”r_log_time
[
¦Ù
][0];

232 (è
	`ngx_¥rštf
(
p
, "%4d/%02d/%02d %02d:%02d:%02d",

233 
tm
.
ngx_tm_y—r
,m.
ngx_tm_mÚ
,

234 
tm
.
ngx_tm_mday
,m.
ngx_tm_hour
,

235 
tm
.
ngx_tm_mš
,m.
ngx_tm_£c
);

237 
p2
 = &
ÿched_sy¦og_time
[
¦Ù
][0];

239 (è
	`ngx_¥rštf
(
p2
, "%s %2d %02d:%02d:%02d",

240 
mÚths
[
tm
.
ngx_tm_mÚ
 - 1],m.
ngx_tm_mday
,

241 
tm
.
ngx_tm_hour
,m.
ngx_tm_mš
,m.
ngx_tm_£c
);

243 
	`ngx_memÜy_b¬r›r
();

245 
ngx_ÿched_”r_log_time
.
d©a
 = 
p
;

246 
ngx_ÿched_sy¦og_time
.
d©a
 = 
p2
;

248 
	`ngx_uÆock
(&
ngx_time_lock
);

249 
	}
}

254 
u_ch¬
 *

255 
	$ngx_h‰p_time
(
u_ch¬
 *
buf
, 
time_t
 
t
)

257 
ngx_tm_t
 
tm
;

259 
	`ngx_gmtime
(
t
, &
tm
);

261  
	`ngx_¥rštf
(
buf
, "%s, %02d %s %4d %02d:%02d:%02d GMT",

262 
w“k
[
tm
.
ngx_tm_wday
],

263 
tm
.
ngx_tm_mday
,

264 
mÚths
[
tm
.
ngx_tm_mÚ
 - 1],

265 
tm
.
ngx_tm_y—r
,

266 
tm
.
ngx_tm_hour
,

267 
tm
.
ngx_tm_mš
,

268 
tm
.
ngx_tm_£c
);

269 
	}
}

272 
u_ch¬
 *

273 
	$ngx_h‰p_cook›_time
(
u_ch¬
 *
buf
, 
time_t
 
t
)

275 
ngx_tm_t
 
tm
;

277 
	`ngx_gmtime
(
t
, &
tm
);

284  
	`ngx_¥rštf
(
buf
,

285 (
tm
.
ngx_tm_y—r
 > 2037) ?

288 
w“k
[
tm
.
ngx_tm_wday
],

289 
tm
.
ngx_tm_mday
,

290 
mÚths
[
tm
.
ngx_tm_mÚ
 - 1],

291 (
tm
.
ngx_tm_y—r
 > 2037) ?m.ngx_tm_year:

292 
tm
.
ngx_tm_y—r
 % 100,

293 
tm
.
ngx_tm_hour
,

294 
tm
.
ngx_tm_mš
,

295 
tm
.
ngx_tm_£c
);

296 
	}
}

300 
	$ngx_gmtime
(
time_t
 
t
, 
ngx_tm_t
 *

)

302 
ngx_št_t
 
yday
;

303 
ngx_ušt_t
 
n
, 
£c
, 
mš
, 
hour
, 
mday
, 
mÚ
, 
y—r
, 
wday
, 
days
, 
Ë­
;

307 
n
 = (
ngx_ušt_t
è
t
;

309 
days
 = 
n
 / 86400;

313 
wday
 = (4 + 
days
) % 7;

315 
n
 %= 86400;

316 
hour
 = 
n
 / 3600;

317 
n
 %= 3600;

318 
mš
 = 
n
 / 60;

319 
£c
 = 
n
 % 60;

327 
days
 = days - (31 + 28) + 719527;

336 
y—r
 = (
days
 + 2) * 400 / (365 * 400 + 100 - 4 + 1);

338 
yday
 = 
days
 - (365 * 
y—r
 + year / 4 - year / 100 + year / 400);

340 ià(
yday
 < 0) {

341 
Ë­
 = (
y—r
 % 4 == 0) && (year % 100 || (year % 400 == 0));

342 
yday
 = 365 + 
Ë­
 + yday;

343 
y—r
--;

354 
mÚ
 = (
yday
 + 31) * 10 / 306;

358 
mday
 = 
yday
 - (367 * 
mÚ
 / 12 - 30) + 1;

360 ià(
yday
 >= 306) {

362 
y—r
++;

363 
mÚ
 -= 10;

373 
mÚ
 += 2;

382 

->
ngx_tm_£c
 = (
ngx_tm_£c_t
è
£c
;

383 

->
ngx_tm_mš
 = (
ngx_tm_mš_t
è
mš
;

384 

->
ngx_tm_hour
 = (
ngx_tm_hour_t
è
hour
;

385 

->
ngx_tm_mday
 = (
ngx_tm_mday_t
è
mday
;

386 

->
ngx_tm_mÚ
 = (
ngx_tm_mÚ_t
è
mÚ
;

387 

->
ngx_tm_y—r
 = (
ngx_tm_y—r_t
è
y—r
;

388 

->
ngx_tm_wday
 = (
ngx_tm_wday_t
è
wday
;

389 
	}
}

392 
time_t


393 
	$ngx_Ãxt_time
(
time_t
 
wh’
)

395 
time_t
 
now
, 
Ãxt
;

396 
tm
m;

398 
now
 = 
	`ngx_time
();

400 
	`ngx_libc_loÿÉime
(
now
, &
tm
);

402 
tm
.
tm_hour
 = (è(
wh’
 / 3600);

403 
wh’
 %= 3600;

404 
tm
.
tm_mš
 = (è(
wh’
 / 60);

405 
tm
.
tm_£c
 = (è(
wh’
 % 60);

407 
Ãxt
 = 
	`mktime
(&
tm
);

409 ià(
Ãxt
 == -1) {

413 ià(
Ãxt
 - 
now
 > 0) {

414  
Ãxt
;

417 
tm
.
tm_mday
++;

421 
Ãxt
 = 
	`mktime
(&
tm
);

423 ià(
Ãxt
 != -1) {

424  
Ãxt
;

428 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_aio_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_ev’t_moduË_t
 
ngx_kqueue_moduË_ùx
;

16 
ngx_št_t
 
ngx_aio_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

17 
ngx_aio_dÚe
(
ngx_cyþe_t
 *
cyþe
);

18 
ngx_št_t
 
ngx_aio_add_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

19 
ngx_ušt_t
 
æags
);

20 
ngx_št_t
 
ngx_aio_d–_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

21 
ngx_ušt_t
 
æags
);

22 
ngx_št_t
 
ngx_aio_d–_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
æags
);

23 
ngx_št_t
 
ngx_aio_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

24 
ngx_ušt_t
 
æags
);

27 
ngx_os_io_t
 
	gngx_os_aio
 = {

28 
ngx_aio_»ad
,

29 
ngx_aio_»ad_chaš
,

30 
NULL
,

31 
ngx_aio_wr™e
,

32 
ngx_aio_wr™e_chaš
,

37 
ngx_¡r_t
 
	gaio_Çme
 = 
ngx_¡ršg
("aio");

39 
ngx_ev’t_moduË_t
 
	gngx_aio_moduË_ùx
 = {

40 &
aio_Çme
,

41 
NULL
,

42 
NULL
,

45 
ngx_aio_add_ev’t
,

46 
ngx_aio_d–_ev’t
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
ngx_aio_d–_cÚÃùiÚ
,

51 
NULL
,

52 
ngx_aio_´oûss_ev’ts
,

53 
ngx_aio_š™
,

54 
ngx_aio_dÚe


59 
ngx_moduË_t
 
	gngx_aio_moduË
 = {

60 
NGX_MODULE_V1
,

61 &
ngx_aio_moduË_ùx
,

62 
NULL
,

63 
NGX_EVENT_MODULE
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
NULL
,

71 
NGX_MODULE_V1_PADDING


75 #ià(
NGX_HAVE_KQUEUE
)

77 
ngx_št_t


78 
	$ngx_aio_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

80 ià(
ngx_kqueue_moduË_ùx
.
aùiÚs
.
	`š™
(
cyþe
, 
tim”
è=ð
NGX_ERROR
) {

81  
NGX_ERROR
;

84 
ngx_io
 = 
ngx_os_aio
;

86 
ngx_ev’t_æags
 = 
NGX_USE_AIO_EVENT
;

87 
ngx_ev’t_aùiÚs
 = 
ngx_aio_moduË_ùx
.
aùiÚs
;

90  
NGX_OK
;

91 
	}
}

95 
	$ngx_aio_dÚe
(
ngx_cyþe_t
 *
cyþe
)

97 
ngx_kqueue_moduË_ùx
.
aùiÚs
.
	`dÚe
(
cyþe
);

98 
	}
}

103 
ngx_št_t


104 
	$ngx_aio_add_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

106  
ngx_kqueue_moduË_ùx
.
aùiÚs
.
	`add
(
ev
, 
ev’t
, 
æags
);

107 
	}
}

110 
ngx_št_t


111 
	$ngx_aio_d–_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

113  
ngx_kqueue_moduË_ùx
.
aùiÚs
.
	`d–
(
ev
, 
ev’t
, 
æags
);

114 
	}
}

117 
ngx_št_t


118 
	$ngx_aio_d–_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
æags
)

120 
rc
;

122 ià(
c
->
»ad
->
aùive
 =ð0 && c->
wr™e
->active == 0) {

123  
NGX_OK
;

126 ià(
æags
 & 
NGX_CLOSE_EVENT
) {

127  
NGX_OK
;

130 
rc
 = 
	`aio_ÿnûl
(
c
->
fd
, 
NULL
);

132 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "aio_ÿnûl: %d", 
rc
);

134 ià(
rc
 =ð
AIO_CANCELED
) {

135 
c
->
»ad
->
aùive
 = 0;

136 
c
->
wr™e
->
aùive
 = 0;

137  
NGX_OK
;

140 ià(
rc
 =ð
AIO_ALLDONE
) {

141 
c
->
»ad
->
aùive
 = 0;

142 
c
->
wr™e
->
aùive
 = 0;

143 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

145  
NGX_OK
;

148 ià(
rc
 == -1) {

149 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

151  
NGX_ERROR
;

154 ià(
rc
 =ð
AIO_NOTCANCELED
) {

155 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

158  
NGX_ERROR
;

161  
NGX_OK
;

162 
	}
}

165 
ngx_št_t


166 
	$ngx_aio_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
, 
ngx_ušt_t
 
æags
)

168  
ngx_kqueue_moduË_ùx
.
aùiÚs
.
	`´oûss_ev’ts
(
cyþe
, 
tim”
, 
æags
);

169 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_devpoll_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 #ià(
NGX_TEST_BUILD_DEVPOLL
)

17 
	#POLLREMOVE
 0x0800

	)

18 
	#DP_POLL
 0xD001

	)

19 
	#DP_ISPOLLED
 0xD002

	)

21 
	sdvpÞl
 {

22 
pÞlfd
 *
	mdp_fds
;

23 
	mdp_nfds
;

24 
	mdp_timeout
;

31 
ngx_ušt_t
 
	mchªges
;

32 
ngx_ušt_t
 
	mev’ts
;

33 } 
	tngx_devpÞl_cÚf_t
;

36 
ngx_št_t
 
ngx_devpÞl_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

37 
ngx_devpÞl_dÚe
(
ngx_cyþe_t
 *
cyþe
);

38 
ngx_št_t
 
ngx_devpÞl_add_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

39 
ngx_ušt_t
 
æags
);

40 
ngx_št_t
 
ngx_devpÞl_d–_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

41 
ngx_ušt_t
 
æags
);

42 
ngx_št_t
 
ngx_devpÞl_£t_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

43 
ngx_ušt_t
 
æags
);

44 
ngx_št_t
 
ngx_devpÞl_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
,

45 
ngx_m£c_t
 
tim”
, 
ngx_ušt_t
 
æags
);

47 *
ngx_devpÞl_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

48 *
ngx_devpÞl_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

50 
	gdp
 = -1;

51 
pÞlfd
 *
	gchªge_li¡
, *
	gev’t_li¡
;

52 
ngx_ušt_t
 
	gnchªges
, 
	gmax_chªges
, 
	gÃv’ts
;

54 
ngx_ev’t_t
 **
	gchªge_šdex
;

57 
ngx_¡r_t
 
	gdevpÞl_Çme
 = 
ngx_¡ršg
("/dev/poll");

59 
ngx_commªd_t
 
	gngx_devpÞl_commªds
[] = {

61 { 
ngx_¡ršg
("devpoll_changes"),

62 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

63 
ngx_cÚf_£t_num_¦Ù
,

65 
off£tof
(
ngx_devpÞl_cÚf_t
, 
chªges
),

66 
NULL
 },

68 { 
ngx_¡ršg
("devpoll_events"),

69 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

70 
ngx_cÚf_£t_num_¦Ù
,

72 
off£tof
(
ngx_devpÞl_cÚf_t
, 
ev’ts
),

73 
NULL
 },

75 
ngx_nuÎ_commªd


79 
ngx_ev’t_moduË_t
 
	gngx_devpÞl_moduË_ùx
 = {

80 &
devpÞl_Çme
,

81 
ngx_devpÞl_ü—‹_cÚf
,

82 
ngx_devpÞl_š™_cÚf
,

85 
ngx_devpÞl_add_ev’t
,

86 
ngx_devpÞl_d–_ev’t
,

87 
ngx_devpÞl_add_ev’t
,

88 
ngx_devpÞl_d–_ev’t
,

89 
NULL
,

90 
NULL
,

91 
NULL
,

92 
ngx_devpÞl_´oûss_ev’ts
,

93 
ngx_devpÞl_š™
,

94 
ngx_devpÞl_dÚe
,

99 
ngx_moduË_t
 
	gngx_devpÞl_moduË
 = {

100 
NGX_MODULE_V1
,

101 &
ngx_devpÞl_moduË_ùx
,

102 
ngx_devpÞl_commªds
,

103 
NGX_EVENT_MODULE
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NULL
,

110 
NULL
,

111 
NGX_MODULE_V1_PADDING


115 
ngx_št_t


116 
	$ngx_devpÞl_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

118 
size_t
 
n
;

119 
ngx_devpÞl_cÚf_t
 *
dpcf
;

121 
dpcf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_devpÞl_moduË
);

123 ià(
dp
 == -1) {

124 
dp
 = 
	`Ý’
("/dev/pÞl", 
O_RDWR
);

126 ià(
dp
 == -1) {

127 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

129  
NGX_ERROR
;

133 ià(
max_chªges
 < 
dpcf
->
chªges
) {

134 ià(
nchªges
) {

135 
n
 = 
nchªges
 * (
pÞlfd
);

136 ià(
	`wr™e
(
dp
, 
chªge_li¡
, 
n
è!ð(
ssize_t
)‚) {

137 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

139  
NGX_ERROR
;

142 
nchªges
 = 0;

145 ià(
chªge_li¡
) {

146 
	`ngx_ä“
(
chªge_li¡
);

149 
chªge_li¡
 = 
	`ngx_®loc
((
pÞlfd
è* 
dpcf
->
chªges
,

150 
cyþe
->
log
);

151 ià(
chªge_li¡
 =ð
NULL
) {

152  
NGX_ERROR
;

155 ià(
chªge_šdex
) {

156 
	`ngx_ä“
(
chªge_šdex
);

159 
chªge_šdex
 = 
	`ngx_®loc
((
ngx_ev’t_t
 *è* 
dpcf
->
chªges
,

160 
cyþe
->
log
);

161 ià(
chªge_šdex
 =ð
NULL
) {

162  
NGX_ERROR
;

166 
max_chªges
 = 
dpcf
->
chªges
;

168 ià(
Ãv’ts
 < 
dpcf
->
ev’ts
) {

169 ià(
ev’t_li¡
) {

170 
	`ngx_ä“
(
ev’t_li¡
);

173 
ev’t_li¡
 = 
	`ngx_®loc
((
pÞlfd
è* 
dpcf
->
ev’ts
,

174 
cyþe
->
log
);

175 ià(
ev’t_li¡
 =ð
NULL
) {

176  
NGX_ERROR
;

180 
Ãv’ts
 = 
dpcf
->
ev’ts
;

182 
ngx_io
 = 
ngx_os_io
;

184 
ngx_ev’t_aùiÚs
 = 
ngx_devpÞl_moduË_ùx
.
aùiÚs
;

186 
ngx_ev’t_æags
 = 
NGX_USE_LEVEL_EVENT
|
NGX_USE_FD_EVENT
;

188  
NGX_OK
;

189 
	}
}

193 
	$ngx_devpÞl_dÚe
(
ngx_cyþe_t
 *
cyþe
)

195 ià(
	`þo£
(
dp
) == -1) {

196 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

200 
dp
 = -1;

202 
	`ngx_ä“
(
chªge_li¡
);

203 
	`ngx_ä“
(
ev’t_li¡
);

204 
	`ngx_ä“
(
chªge_šdex
);

206 
chªge_li¡
 = 
NULL
;

207 
ev’t_li¡
 = 
NULL
;

208 
chªge_šdex
 = 
NULL
;

209 
max_chªges
 = 0;

210 
nchªges
 = 0;

211 
Ãv’ts
 = 0;

212 
	}
}

215 
ngx_št_t


216 
	$ngx_devpÞl_add_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

218 #ià(
NGX_DEBUG
)

219 
ngx_cÚÃùiÚ_t
 *
c
;

222 #ià(
NGX_READ_EVENT
 !ð
POLLIN
)

223 
ev’t
 = (ev’ˆ=ð
NGX_READ_EVENT
è? 
POLLIN
 : 
POLLOUT
;

226 #ià(
NGX_DEBUG
)

227 
c
 = 
ev
->
d©a
;

228 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

229 "devpÞÈaddƒv’t: fd:%dƒv:%04Xi", 
c
->
fd
, 
ev’t
);

232 
ev
->
aùive
 = 1;

234  
	`ngx_devpÞl_£t_ev’t
(
ev
, 
ev’t
, 0);

235 
	}
}

238 
ngx_št_t


239 
	$ngx_devpÞl_d–_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

241 
ngx_ev’t_t
 *
e
;

242 
ngx_cÚÃùiÚ_t
 *
c
;

244 
c
 = 
ev
->
d©a
;

246 #ià(
NGX_READ_EVENT
 !ð
POLLIN
)

247 
ev’t
 = (ev’ˆ=ð
NGX_READ_EVENT
è? 
POLLIN
 : 
POLLOUT
;

250 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

251 "devpÞÈd–ƒv’t: fd:%dƒv:%04Xi", 
c
->
fd
, 
ev’t
);

253 ià(
	`ngx_devpÞl_£t_ev’t
(
ev
, 
POLLREMOVE
, 
æags
è=ð
NGX_ERROR
) {

254  
NGX_ERROR
;

257 
ev
->
aùive
 = 0;

259 ià(
æags
 & 
NGX_CLOSE_EVENT
) {

260 
e
 = (
ev’t
 =ð
POLLIN
è? 
c
->
wr™e
 : c->
»ad
;

262 ià(
e
) {

263 
e
->
aùive
 = 0;

266  
NGX_OK
;

271 ià(
ev’t
 =ð
POLLIN
) {

272 
e
 = 
c
->
wr™e
;

273 
ev’t
 = 
POLLOUT
;

276 
e
 = 
c
->
»ad
;

277 
ev’t
 = 
POLLIN
;

280 ià(
e
 &&ƒ->
aùive
) {

281  
	`ngx_devpÞl_£t_ev’t
(
e
, 
ev’t
, 0);

284  
NGX_OK
;

285 
	}
}

288 
ngx_št_t


289 
	$ngx_devpÞl_£t_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

291 
size_t
 
n
;

292 
ngx_cÚÃùiÚ_t
 *
c
;

294 
c
 = 
ev
->
d©a
;

296 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

297 "devpÞÈfd:%dƒv:%04X˜æ:%04Xi", 
c
->
fd
, 
ev’t
, 
æags
);

299 ià(
nchªges
 >ð
max_chªges
) {

300 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
ev
->
log
, 0,

303 
n
 = 
nchªges
 * (
pÞlfd
);

304 ià(
	`wr™e
(
dp
, 
chªge_li¡
, 
n
è!ð(
ssize_t
)‚) {

305 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

307  
NGX_ERROR
;

310 
nchªges
 = 0;

313 
chªge_li¡
[
nchªges
].
fd
 = 
c
->fd;

314 
chªge_li¡
[
nchªges
].
ev’ts
 = (è
ev’t
;

315 
chªge_li¡
[
nchªges
].
»v’ts
 = 0;

317 
chªge_šdex
[
nchªges
] = 
ev
;

318 
ev
->
šdex
 = 
nchªges
;

320 
nchªges
++;

322 ià(
æags
 & 
NGX_CLOSE_EVENT
) {

323 
n
 = 
nchªges
 * (
pÞlfd
);

324 ià(
	`wr™e
(
dp
, 
chªge_li¡
, 
n
è!ð(
ssize_t
)‚) {

325 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

327  
NGX_ERROR
;

330 
nchªges
 = 0;

333  
NGX_OK
;

334 
	}
}

337 
ngx_št_t


338 
	$ngx_devpÞl_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

339 
ngx_ušt_t
 
æags
)

341 
ev’ts
, 
»v’ts
, 
rc
;

342 
size_t
 
n
;

343 
ngx_fd_t
 
fd
;

344 
ngx_”r_t
 
”r
;

345 
ngx_št_t
 
i
;

346 
ngx_ušt_t
 
Ëv–
, 
š¡ªû
;

347 
ngx_ev’t_t
 *
»v
, *
wev
;

348 
ngx_queue_t
 *
queue
;

349 
ngx_cÚÃùiÚ_t
 *
c
;

350 
pÞlfd
 
pfd
;

351 
dvpÞl
 
dvp
;

355 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

356 "devpÞÈtim”: %M", 
tim”
);

358 ià(
nchªges
) {

359 
n
 = 
nchªges
 * (
pÞlfd
);

360 ià(
	`wr™e
(
dp
, 
chªge_li¡
, 
n
è!ð(
ssize_t
)‚) {

361 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

363  
NGX_ERROR
;

366 
nchªges
 = 0;

369 
dvp
.
dp_fds
 = 
ev’t_li¡
;

370 
dvp
.
dp_nfds
 = (è
Ãv’ts
;

371 
dvp
.
dp_timeout
 = 
tim”
;

372 
ev’ts
 = 
	`ioùl
(
dp
, 
DP_POLL
, &
dvp
);

374 
”r
 = (
ev’ts
 =ð-1è? 
ngx_”ºo
 : 0;

376 ià(
æags
 & 
NGX_UPDATE_TIME
 || 
ngx_ev’t_tim”_®¬m
) {

377 
	`ngx_time_upd©e
();

380 ià(
”r
) {

381 ià(
”r
 =ð
NGX_EINTR
) {

383 ià(
ngx_ev’t_tim”_®¬m
) {

384 
ngx_ev’t_tim”_®¬m
 = 0;

385  
NGX_OK
;

388 
Ëv–
 = 
NGX_LOG_INFO
;

391 
Ëv–
 = 
NGX_LOG_ALERT
;

394 
	`ngx_log_”rÜ
(
Ëv–
, 
cyþe
->
log
, 
”r
, "ioctl(DP_POLL) failed");

395  
NGX_ERROR
;

398 ià(
ev’ts
 == 0) {

399 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

400  
NGX_OK
;

403 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

405  
NGX_ERROR
;

408 
i
 = 0; i < 
ev’ts
; i++) {

410 
fd
 = 
ev’t_li¡
[
i
].fd;

411 
»v’ts
 = 
ev’t_li¡
[
i
].revents;

413 
c
 = 
ngx_cyþe
->
fžes
[
fd
];

415 ià(
c
 =ð
NULL
 || c->
fd
 == -1) {

417 
pfd
.
fd
 = fd;

418 
pfd
.
ev’ts
 = 0;

419 
pfd
.
»v’ts
 = 0;

421 
rc
 = 
	`ioùl
(
dp
, 
DP_ISPOLLED
, &
pfd
);

423 
rc
) {

426 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

428 
fd
, 
»v’ts
);

432 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

434 
»v’ts
, 
fd
);

438 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

441 
»v’ts
, 
fd
, 
rc
, 
pfd
.fd,…fd.revents);

443 
pfd
.
fd
 = fd;

444 
pfd
.
ev’ts
 = 
POLLREMOVE
;

445 
pfd
.
»v’ts
 = 0;

447 ià(
	`wr™e
(
dp
, &
pfd
, (
pÞlfd
))

448 !ð(
ssize_t
è(
pÞlfd
))

450 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

451 "wr™e(/dev/pÞlèfÜ %d fažed", 
fd
);

454 ià(
	`þo£
(
fd
) == -1) {

455 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

456 "þo£(%dèçžed", 
fd
);

465 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

467 
fd
, 
ev’t_li¡
[
i
].
ev’ts
, 
»v’ts
);

469 ià(
»v’ts
 & (
POLLERR
|
POLLHUP
|
POLLNVAL
)) {

470 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

472 
fd
, 
ev’t_li¡
[
i
].
ev’ts
, 
»v’ts
);

475 ià(
»v’ts
 & ~(
POLLIN
|
POLLOUT
|
POLLERR
|
POLLHUP
|
POLLNVAL
)) {

476 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

479 
fd
, 
ev’t_li¡
[
i
].
ev’ts
, 
»v’ts
);

482 ià((
»v’ts
 & (
POLLERR
|
POLLHUP
|
POLLNVAL
))

483 && (
»v’ts
 & (
POLLIN
|
POLLOUT
)) == 0)

491 
»v’ts
 |ð
POLLIN
|
POLLOUT
;

494 
»v
 = 
c
->
»ad
;

496 ià((
»v’ts
 & 
POLLIN
è&& 
»v
->
aùive
) {

497 
»v
->
»ady
 = 1;

499 ià(
æags
 & 
NGX_POST_EVENTS
) {

500 
queue
 = 
»v
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


501 : &
ngx_po¡ed_ev’ts
;

503 
	`ngx_po¡_ev’t
(
»v
, 
queue
);

506 
š¡ªû
 = 
»v
->instance;

508 
»v
->
	`hªdËr
(rev);

510 ià(
c
->
fd
 =ð-1 || 
»v
->
š¡ªû
 != instance) {

516 
wev
 = 
c
->
wr™e
;

518 ià((
»v’ts
 & 
POLLOUT
è&& 
wev
->
aùive
) {

519 
wev
->
»ady
 = 1;

521 ià(
æags
 & 
NGX_POST_EVENTS
) {

522 
	`ngx_po¡_ev’t
(
wev
, &
ngx_po¡ed_ev’ts
);

525 
wev
->
	`hªdËr
(wev);

530  
NGX_OK
;

531 
	}
}

535 
	$ngx_devpÞl_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

537 
ngx_devpÞl_cÚf_t
 *
dpcf
;

539 
dpcf
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, (
ngx_devpÞl_cÚf_t
));

540 ià(
dpcf
 =ð
NULL
) {

541  
NULL
;

544 
dpcf
->
chªges
 = 
NGX_CONF_UNSET
;

545 
dpcf
->
ev’ts
 = 
NGX_CONF_UNSET
;

547  
dpcf
;

548 
	}
}

552 
	$ngx_devpÞl_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

554 
ngx_devpÞl_cÚf_t
 *
dpcf
 = 
cÚf
;

556 
	`ngx_cÚf_š™_ušt_v®ue
(
dpcf
->
chªges
, 32);

557 
	`ngx_cÚf_š™_ušt_v®ue
(
dpcf
->
ev’ts
, 32);

559  
NGX_CONF_OK
;

560 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_epoll_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 #ià(
NGX_TEST_BUILD_EPOLL
)

17 
	#EPOLLIN
 0x001

	)

18 
	#EPOLLPRI
 0x002

	)

19 
	#EPOLLOUT
 0x004

	)

20 
	#EPOLLRDNORM
 0x040

	)

21 
	#EPOLLRDBAND
 0x080

	)

22 
	#EPOLLWRNORM
 0x100

	)

23 
	#EPOLLWRBAND
 0x200

	)

24 
	#EPOLLMSG
 0x400

	)

25 
	#EPOLLERR
 0x008

	)

26 
	#EPOLLHUP
 0x010

	)

28 
	#EPOLLRDHUP
 0x2000

	)

30 
	#EPOLLET
 0x80000000

	)

31 
	#EPOLLONESHOT
 0x40000000

	)

33 
	#EPOLL_CTL_ADD
 1

	)

34 
	#EPOLL_CTL_DEL
 2

	)

35 
	#EPOLL_CTL_MOD
 3

	)

37 
	u•Þl_d©a
 {

38 *
	m±r
;

39 
	mfd
;

40 
ušt32_t
 
	mu32
;

41 
ušt64_t
 
	mu64
;

42 } 
	t•Þl_d©a_t
;

44 
	s•Þl_ev’t
 {

45 
ušt32_t
 
	mev’ts
;

46 
•Þl_d©a_t
 
	md©a
;

50 
•Þl_ü—‹
(
size
);

52 
	$•Þl_ü—‹
(
size
)

55 
	}
}

58 
•Þl_ùl
(
•fd
, 
Ý
, 
fd
, 
•Þl_ev’t
 *
ev’t
);

60 
	$•Þl_ùl
(
•fd
, 
Ý
, 
fd
, 
•Þl_ev’t
 *
ev’t
)

63 
	}
}

66 
•Þl_wa™
(
•fd
, 
•Þl_ev’t
 *
ev’ts
, 
Ãv’ts
, 
timeout
);

68 
	$•Þl_wa™
(
•fd
, 
•Þl_ev’t
 *
ev’ts
, 
Ãv’ts
, 
timeout
)

71 
	}
}

73 #ià(
NGX_HAVE_FILE_AIO
)

75 
	#SYS_io_£tup
 245

	)

76 
	#SYS_io_de¡roy
 246

	)

77 
	#SYS_io_g‘ev’ts
 247

	)

78 
	#SYS_ev’tfd
 323

	)

80 
u_št
 
	taio_cÚ‹xt_t
;

82 
	sio_ev’t
 {

83 
ušt64_t
 
	md©a
;

84 
ušt64_t
 
	mobj
;

85 
št64_t
 
	m»s
;

86 
št64_t
 
	m»s2
;

95 
ngx_ušt_t
 
	mev’ts
;

96 
ngx_ušt_t
 
	maio_»que¡s
;

97 } 
	tngx_•Þl_cÚf_t
;

100 
ngx_št_t
 
ngx_•Þl_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

101 
ngx_•Þl_dÚe
(
ngx_cyþe_t
 *
cyþe
);

102 
ngx_št_t
 
ngx_•Þl_add_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

103 
ngx_ušt_t
 
æags
);

104 
ngx_št_t
 
ngx_•Þl_d–_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

105 
ngx_ušt_t
 
æags
);

106 
ngx_št_t
 
ngx_•Þl_add_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
);

107 
ngx_št_t
 
ngx_•Þl_d–_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
,

108 
ngx_ušt_t
 
æags
);

109 
ngx_št_t
 
ngx_•Þl_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

110 
ngx_ušt_t
 
æags
);

112 #ià(
NGX_HAVE_FILE_AIO
)

113 
ngx_•Þl_ev’tfd_hªdËr
(
ngx_ev’t_t
 *
ev
);

116 *
ngx_•Þl_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

117 *
ngx_•Þl_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

119 
	g•
 = -1;

120 
•Þl_ev’t
 *
	gev’t_li¡
;

121 
ngx_ušt_t
 
	gÃv’ts
;

123 #ià(
NGX_HAVE_FILE_AIO
)

125 
	gngx_ev’tfd
 = -1;

126 
aio_cÚ‹xt_t
 
	gngx_aio_ùx
 = 0;

128 
ngx_ev’t_t
 
	gngx_ev’tfd_ev’t
;

129 
ngx_cÚÃùiÚ_t
 
	gngx_ev’tfd_cÚn
;

133 
ngx_¡r_t
 
	g•Þl_Çme
 = 
ngx_¡ršg
("epoll");

135 
ngx_commªd_t
 
	gngx_•Þl_commªds
[] = {

137 { 
ngx_¡ršg
("epoll_events"),

138 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

139 
ngx_cÚf_£t_num_¦Ù
,

141 
off£tof
(
ngx_•Þl_cÚf_t
, 
ev’ts
),

142 
NULL
 },

144 { 
ngx_¡ršg
("worker_aio_requests"),

145 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

146 
ngx_cÚf_£t_num_¦Ù
,

148 
off£tof
(
ngx_•Þl_cÚf_t
, 
aio_»que¡s
),

149 
NULL
 },

151 
ngx_nuÎ_commªd


155 
ngx_ev’t_moduË_t
 
	gngx_•Þl_moduË_ùx
 = {

156 &
•Þl_Çme
,

157 
ngx_•Þl_ü—‹_cÚf
,

158 
ngx_•Þl_š™_cÚf
,

161 
ngx_•Þl_add_ev’t
,

162 
ngx_•Þl_d–_ev’t
,

163 
ngx_•Þl_add_ev’t
,

164 
ngx_•Þl_d–_ev’t
,

165 
ngx_•Þl_add_cÚÃùiÚ
,

166 
ngx_•Þl_d–_cÚÃùiÚ
,

167 
NULL
,

168 
ngx_•Þl_´oûss_ev’ts
,

169 
ngx_•Þl_š™
,

170 
ngx_•Þl_dÚe
,

174 
ngx_moduË_t
 
	gngx_•Þl_moduË
 = {

175 
NGX_MODULE_V1
,

176 &
ngx_•Þl_moduË_ùx
,

177 
ngx_•Þl_commªds
,

178 
NGX_EVENT_MODULE
,

179 
NULL
,

180 
NULL
,

181 
NULL
,

182 
NULL
,

183 
NULL
,

184 
NULL
,

185 
NULL
,

186 
NGX_MODULE_V1_PADDING


190 #ià(
NGX_HAVE_FILE_AIO
)

199 
	$io_£tup
(
u_št
 
Ä_»qs
, 
aio_cÚ‹xt_t
 *
ùx
)

201  
	`sysÿÎ
(
SYS_io_£tup
, 
Ä_»qs
, 
ùx
);

202 
	}
}

206 
	$io_de¡roy
(
aio_cÚ‹xt_t
 
ùx
)

208  
	`sysÿÎ
(
SYS_io_de¡roy
, 
ùx
);

209 
	}
}

213 
	$io_g‘ev’ts
(
aio_cÚ‹xt_t
 
ùx
, 
mš_Ä
, 
Ä
, 
io_ev’t
 *
ev’ts
,

214 
time¥ec
 *
tmo
)

216  
	`sysÿÎ
(
SYS_io_g‘ev’ts
, 
ùx
, 
mš_Ä
, 
Ä
, 
ev’ts
, 
tmo
);

217 
	}
}

221 
	$ngx_•Þl_aio_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_•Þl_cÚf_t
 *
•cf
)

223 
n
;

224 
•Þl_ev’t
 
“
;

226 #ià(
NGX_HAVE_SYS_EVENTFD_H
)

227 
ngx_ev’tfd
 = 
	`ev’tfd
(0, 0);

229 
ngx_ev’tfd
 = 
	`sysÿÎ
(
SYS_ev’tfd
, 0);

232 ià(
ngx_ev’tfd
 == -1) {

233 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

235 
ngx_fže_aio
 = 0;

239 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

240 "ev’tfd: %d", 
ngx_ev’tfd
);

242 
n
 = 1;

244 ià(
	`ioùl
(
ngx_ev’tfd
, 
FIONBIO
, &
n
) == -1) {

245 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

247 
çžed
;

250 ià(
	`io_£tup
(
•cf
->
aio_»que¡s
, &
ngx_aio_ùx
) == -1) {

251 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

253 
çžed
;

256 
ngx_ev’tfd_ev’t
.
d©a
 = &
ngx_ev’tfd_cÚn
;

257 
ngx_ev’tfd_ev’t
.
hªdËr
 = 
ngx_•Þl_ev’tfd_hªdËr
;

258 
ngx_ev’tfd_ev’t
.
log
 = 
cyþe
->log;

259 
ngx_ev’tfd_ev’t
.
aùive
 = 1;

260 
ngx_ev’tfd_cÚn
.
fd
 = 
ngx_ev’tfd
;

261 
ngx_ev’tfd_cÚn
.
»ad
 = &
ngx_ev’tfd_ev’t
;

262 
ngx_ev’tfd_cÚn
.
log
 = 
cyþe
->log;

264 
“
.
ev’ts
 = 
EPOLLIN
|
EPOLLET
;

265 
“
.
d©a
.
±r
 = &
ngx_ev’tfd_cÚn
;

267 ià(
	`•Þl_ùl
(
•
, 
EPOLL_CTL_ADD
, 
ngx_ev’tfd
, &
“
) != -1) {

271 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

274 ià(
	`io_de¡roy
(
ngx_aio_ùx
) == -1) {

275 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

279 
çžed
:

281 ià(
	`þo£
(
ngx_ev’tfd
) == -1) {

282 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

286 
ngx_ev’tfd
 = -1;

287 
ngx_aio_ùx
 = 0;

288 
ngx_fže_aio
 = 0;

289 
	}
}

294 
ngx_št_t


295 
	$ngx_•Þl_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

297 
ngx_•Þl_cÚf_t
 *
•cf
;

299 
•cf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_•Þl_moduË
);

301 ià(
•
 == -1) {

302 
•
 = 
	`•Þl_ü—‹
(
cyþe
->
cÚÃùiÚ_n
 / 2);

304 ià(
•
 == -1) {

305 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

307  
NGX_ERROR
;

310 #ià(
NGX_HAVE_FILE_AIO
)

312 
	`ngx_•Þl_aio_š™
(
cyþe
, 
•cf
);

317 ià(
Ãv’ts
 < 
•cf
->
ev’ts
) {

318 ià(
ev’t_li¡
) {

319 
	`ngx_ä“
(
ev’t_li¡
);

322 
ev’t_li¡
 = 
	`ngx_®loc
((
•Þl_ev’t
è* 
•cf
->
ev’ts
,

323 
cyþe
->
log
);

324 ià(
ev’t_li¡
 =ð
NULL
) {

325  
NGX_ERROR
;

329 
Ãv’ts
 = 
•cf
->
ev’ts
;

331 
ngx_io
 = 
ngx_os_io
;

333 
ngx_ev’t_aùiÚs
 = 
ngx_•Þl_moduË_ùx
.
aùiÚs
;

335 #ià(
NGX_HAVE_CLEAR_EVENT
)

336 
ngx_ev’t_æags
 = 
NGX_USE_CLEAR_EVENT


338 
ngx_ev’t_æags
 = 
NGX_USE_LEVEL_EVENT


340 |
NGX_USE_GREEDY_EVENT


341 |
NGX_USE_EPOLL_EVENT
;

343  
NGX_OK
;

344 
	}
}

348 
	$ngx_•Þl_dÚe
(
ngx_cyþe_t
 *
cyþe
)

350 ià(
	`þo£
(
•
) == -1) {

351 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

355 
•
 = -1;

357 #ià(
NGX_HAVE_FILE_AIO
)

359 ià(
ngx_ev’tfd
 != -1) {

361 ià(
	`io_de¡roy
(
ngx_aio_ùx
) == -1) {

362 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

366 ià(
	`þo£
(
ngx_ev’tfd
) == -1) {

367 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

371 
ngx_ev’tfd
 = -1;

374 
ngx_aio_ùx
 = 0;

378 
	`ngx_ä“
(
ev’t_li¡
);

380 
ev’t_li¡
 = 
NULL
;

381 
Ãv’ts
 = 0;

382 
	}
}

385 
ngx_št_t


386 
	$ngx_•Þl_add_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

388 
Ý
;

389 
ušt32_t
 
ev’ts
, 
´ev
;

390 
ngx_ev’t_t
 *
e
;

391 
ngx_cÚÃùiÚ_t
 *
c
;

392 
•Þl_ev’t
 
“
;

394 
c
 = 
ev
->
d©a
;

396 
ev’ts
 = (
ušt32_t
è
ev’t
;

398 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

399 
e
 = 
c
->
wr™e
;

400 
´ev
 = 
EPOLLOUT
;

401 #ià(
NGX_READ_EVENT
 !ð
EPOLLIN
|
EPOLLRDHUP
)

402 
ev’ts
 = 
EPOLLIN
|
EPOLLRDHUP
;

406 
e
 = 
c
->
»ad
;

407 
´ev
 = 
EPOLLIN
|
EPOLLRDHUP
;

408 #ià(
NGX_WRITE_EVENT
 !ð
EPOLLOUT
)

409 
ev’ts
 = 
EPOLLOUT
;

413 ià(
e
->
aùive
) {

414 
Ý
 = 
EPOLL_CTL_MOD
;

415 
ev’ts
 |ð
´ev
;

418 
Ý
 = 
EPOLL_CTL_ADD
;

421 
“
.
ev’ts
 =ƒv’t | (
ušt32_t
è
æags
;

422 
“
.
d©a
.
±r
 = (*è((
ušŒ_t
è
c
 | 
ev
->
š¡ªû
);

424 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

426 
c
->
fd
, 
Ý
, 
“
.
ev’ts
);

428 ià(
	`•Þl_ùl
(
•
, 
Ý
, 
c
->
fd
, &
“
) == -1) {

429 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

430 "•Þl_ùl(%d, %dèçžed", 
Ý
, 
c
->
fd
);

431  
NGX_ERROR
;

434 
ev
->
aùive
 = 1;

436 
ev
->
ÚeshÙ
 = (
æags
 & 
NGX_ONESHOT_EVENT
) ? 1 : 0;

439  
NGX_OK
;

440 
	}
}

443 
ngx_št_t


444 
	$ngx_•Þl_d–_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

446 
Ý
;

447 
ušt32_t
 
´ev
;

448 
ngx_ev’t_t
 *
e
;

449 
ngx_cÚÃùiÚ_t
 *
c
;

450 
•Þl_ev’t
 
“
;

458 ià(
æags
 & 
NGX_CLOSE_EVENT
) {

459 
ev
->
aùive
 = 0;

460  
NGX_OK
;

463 
c
 = 
ev
->
d©a
;

465 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

466 
e
 = 
c
->
wr™e
;

467 
´ev
 = 
EPOLLOUT
;

470 
e
 = 
c
->
»ad
;

471 
´ev
 = 
EPOLLIN
|
EPOLLRDHUP
;

474 ià(
e
->
aùive
) {

475 
Ý
 = 
EPOLL_CTL_MOD
;

476 
“
.
ev’ts
 = 
´ev
 | (
ušt32_t
è
æags
;

477 
“
.
d©a
.
±r
 = (*è((
ušŒ_t
è
c
 | 
ev
->
š¡ªû
);

480 
Ý
 = 
EPOLL_CTL_DEL
;

481 
“
.
ev’ts
 = 0;

482 
“
.
d©a
.
±r
 = 
NULL
;

485 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

487 
c
->
fd
, 
Ý
, 
“
.
ev’ts
);

489 ià(
	`•Þl_ùl
(
•
, 
Ý
, 
c
->
fd
, &
“
) == -1) {

490 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

491 "•Þl_ùl(%d, %dèçžed", 
Ý
, 
c
->
fd
);

492  
NGX_ERROR
;

495 
ev
->
aùive
 = 0;

497  
NGX_OK
;

498 
	}
}

501 
ngx_št_t


502 
	$ngx_•Þl_add_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

504 
•Þl_ev’t
 
“
;

506 
“
.
ev’ts
 = 
EPOLLIN
|
EPOLLOUT
|
EPOLLET
|
EPOLLRDHUP
;

507 
“
.
d©a
.
±r
 = (*è((
ušŒ_t
è
c
 | c->
»ad
->
š¡ªû
);

509 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

510 "•ÞÈadd cÚÃùiÚ: fd:%dƒv:%08XD", 
c
->
fd
, 
“
.
ev’ts
);

512 ià(
	`•Þl_ùl
(
•
, 
EPOLL_CTL_ADD
, 
c
->
fd
, &
“
) == -1) {

513 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

514 "•Þl_ùl(EPOLL_CTL_ADD, %dèçžed", 
c
->
fd
);

515  
NGX_ERROR
;

518 
c
->
»ad
->
aùive
 = 1;

519 
c
->
wr™e
->
aùive
 = 1;

521  
NGX_OK
;

522 
	}
}

525 
ngx_št_t


526 
	$ngx_•Þl_d–_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
æags
)

528 
Ý
;

529 
•Þl_ev’t
 
“
;

537 ià(
æags
 & 
NGX_CLOSE_EVENT
) {

538 
c
->
»ad
->
aùive
 = 0;

539 
c
->
wr™e
->
aùive
 = 0;

540  
NGX_OK
;

543 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

544 "•ÞÈd– cÚÃùiÚ: fd:%d", 
c
->
fd
);

546 
Ý
 = 
EPOLL_CTL_DEL
;

547 
“
.
ev’ts
 = 0;

548 
“
.
d©a
.
±r
 = 
NULL
;

550 ià(
	`•Þl_ùl
(
•
, 
Ý
, 
c
->
fd
, &
“
) == -1) {

551 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

552 "•Þl_ùl(%d, %dèçžed", 
Ý
, 
c
->
fd
);

553  
NGX_ERROR
;

556 
c
->
»ad
->
aùive
 = 0;

557 
c
->
wr™e
->
aùive
 = 0;

559  
NGX_OK
;

560 
	}
}

563 
ngx_št_t


564 
	$ngx_•Þl_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
, 
ngx_ušt_t
 
æags
)

566 
ev’ts
;

567 
ušt32_t
 
»v’ts
;

568 
ngx_št_t
 
š¡ªû
, 
i
;

569 
ngx_ušt_t
 
Ëv–
;

570 
ngx_”r_t
 
”r
;

571 
ngx_ev’t_t
 *
»v
, *
wev
;

572 
ngx_queue_t
 *
queue
;

573 
ngx_cÚÃùiÚ_t
 *
c
;

577 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

578 "•ÞÈtim”: %M", 
tim”
);

580 
ev’ts
 = 
	`•Þl_wa™
(
•
, 
ev’t_li¡
, (è
Ãv’ts
, 
tim”
);

582 
”r
 = (
ev’ts
 =ð-1è? 
ngx_”ºo
 : 0;

584 ià(
æags
 & 
NGX_UPDATE_TIME
 || 
ngx_ev’t_tim”_®¬m
) {

585 
	`ngx_time_upd©e
();

588 ià(
”r
) {

589 ià(
”r
 =ð
NGX_EINTR
) {

591 ià(
ngx_ev’t_tim”_®¬m
) {

592 
ngx_ev’t_tim”_®¬m
 = 0;

593  
NGX_OK
;

596 
Ëv–
 = 
NGX_LOG_INFO
;

599 
Ëv–
 = 
NGX_LOG_ALERT
;

602 
	`ngx_log_”rÜ
(
Ëv–
, 
cyþe
->
log
, 
”r
, "epoll_wait() failed");

603  
NGX_ERROR
;

606 ià(
ev’ts
 == 0) {

607 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

608  
NGX_OK
;

611 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

613  
NGX_ERROR
;

616 
i
 = 0; i < 
ev’ts
; i++) {

617 
c
 = 
ev’t_li¡
[
i
].
d©a
.
±r
;

619 
š¡ªû
 = (
ušŒ_t
è
c
 & 1;

620 
c
 = (
ngx_cÚÃùiÚ_t
 *è((
ušŒ_t
) c & (uintptr_t) ~1);

622 
»v
 = 
c
->
»ad
;

624 ià(
c
->
fd
 =ð-1 || 
»v
->
š¡ªû
 != instance) {

631 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

632 "•Þl: sËƒv’ˆ%p", 
c
);

636 
»v’ts
 = 
ev’t_li¡
[
i
].
ev’ts
;

638 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

640 
c
->
fd
, 
»v’ts
, 
ev’t_li¡
[
i
].
d©a
.
±r
);

642 ià(
»v’ts
 & (
EPOLLERR
|
EPOLLHUP
)) {

643 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

645 
c
->
fd
, 
»v’ts
);

649 ià(
»v’ts
 & ~(
EPOLLIN
|
EPOLLOUT
|
EPOLLERR
|
EPOLLHUP
)) {

650 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

652 
c
->
fd
, 
»v’ts
);

656 ià((
»v’ts
 & (
EPOLLERR
|
EPOLLHUP
))

657 && (
»v’ts
 & (
EPOLLIN
|
EPOLLOUT
)) == 0)

665 
»v’ts
 |ð
EPOLLIN
|
EPOLLOUT
;

668 ià((
»v’ts
 & 
EPOLLIN
è&& 
»v
->
aùive
) {

670 #ià(
NGX_HAVE_EPOLLRDHUP
)

671 ià(
»v’ts
 & 
EPOLLRDHUP
) {

672 
»v
->
³ndšg_eof
 = 1;

676 
»v
->
»ady
 = 1;

678 ià(
æags
 & 
NGX_POST_EVENTS
) {

679 
queue
 = 
»v
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


680 : &
ngx_po¡ed_ev’ts
;

682 
	`ngx_po¡_ev’t
(
»v
, 
queue
);

685 
»v
->
	`hªdËr
(rev);

689 
wev
 = 
c
->
wr™e
;

691 ià((
»v’ts
 & 
EPOLLOUT
è&& 
wev
->
aùive
) {

693 ià(
c
->
fd
 =ð-1 || 
wev
->
š¡ªû
 != instance) {

700 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

701 "•Þl: sËƒv’ˆ%p", 
c
);

705 
wev
->
»ady
 = 1;

707 ià(
æags
 & 
NGX_POST_EVENTS
) {

708 
	`ngx_po¡_ev’t
(
wev
, &
ngx_po¡ed_ev’ts
);

711 
wev
->
	`hªdËr
(wev);

716  
NGX_OK
;

717 
	}
}

720 #ià(
NGX_HAVE_FILE_AIO
)

723 
	$ngx_•Þl_ev’tfd_hªdËr
(
ngx_ev’t_t
 *
ev
)

725 
n
, 
ev’ts
;

726 
i
;

727 
ušt64_t
 
»ady
;

728 
ngx_”r_t
 
”r
;

729 
ngx_ev’t_t
 *
e
;

730 
ngx_ev’t_aio_t
 *
aio
;

731 
io_ev’t
 
ev’t
[64];

732 
time¥ec
 
ts
;

734 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0, "eventfd handler");

736 
n
 = 
	`»ad
(
ngx_ev’tfd
, &
»ady
, 8);

738 
”r
 = 
ngx_”ºo
;

740 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0, "ev’tfd: %d", 
n
);

742 ià(
n
 != 8) {

743 ià(
n
 == -1) {

744 ià(
”r
 =ð
NGX_EAGAIN
) {

748 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
”r
, "read(eventfd) failed");

752 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

753 "»adÓv’tfdè»tuºed oÆy %d by‹s", 
n
);

757 
ts
.
tv_£c
 = 0;

758 
ts
.
tv_n£c
 = 0;

760 
»ady
) {

762 
ev’ts
 = 
	`io_g‘ev’ts
(
ngx_aio_ùx
, 1, 64, 
ev’t
, &
ts
);

764 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

765 "io_g‘ev’ts: %l", 
ev’ts
);

767 ià(
ev’ts
 > 0) {

768 
»ady
 -ð
ev’ts
;

770 
i
 = 0; i < 
ev’ts
; i++) {

772 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

774 
ev’t
[
i
].
d©a
,ƒv’t[i].
obj
,

775 
ev’t
[
i
].
»s
,ƒv’t[i].
»s2
);

777 
e
 = (
ngx_ev’t_t
 *è(
ušŒ_t
è
ev’t
[
i
].
d©a
;

779 
e
->
com¶‘e
 = 1;

780 
e
->
aùive
 = 0;

781 
e
->
»ady
 = 1;

783 
aio
 = 
e
->
d©a
;

784 
aio
->
»s
 = 
ev’t
[
i
].res;

786 
	`ngx_po¡_ev’t
(
e
, &
ngx_po¡ed_ev’ts
);

792 ià(
ev’ts
 == 0) {

797 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

801 
	}
}

807 
	$ngx_•Þl_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

809 
ngx_•Þl_cÚf_t
 *
•cf
;

811 
•cf
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, (
ngx_•Þl_cÚf_t
));

812 ià(
•cf
 =ð
NULL
) {

813  
NULL
;

816 
•cf
->
ev’ts
 = 
NGX_CONF_UNSET
;

817 
•cf
->
aio_»que¡s
 = 
NGX_CONF_UNSET
;

819  
•cf
;

820 
	}
}

824 
	$ngx_•Þl_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

826 
ngx_•Þl_cÚf_t
 *
•cf
 = 
cÚf
;

828 
	`ngx_cÚf_š™_ušt_v®ue
(
•cf
->
ev’ts
, 512);

829 
	`ngx_cÚf_š™_ušt_v®ue
(
•cf
->
aio_»que¡s
, 32);

831  
NGX_CONF_OK
;

832 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_eventport_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 #ià(
NGX_TEST_BUILD_EVENTPORT
)

15 
	#ushÜt_t
 
u_shÜt


	)

16 
	#ušt_t
 
u_št


	)

18 #iâdeà
CLOCK_REALTIME


19 
	#CLOCK_REALTIME
 0

	)

20 
	tþockid_t
;

21 * 
	ttim”_t
;

26 
	#PORT_SOURCE_AIO
 1

	)

27 
	#PORT_SOURCE_TIMER
 2

	)

28 
	#PORT_SOURCE_USER
 3

	)

29 
	#PORT_SOURCE_FD
 4

	)

30 
	#PORT_SOURCE_ALERT
 5

	)

31 
	#PORT_SOURCE_MQ
 6

	)

33 #iâdeà
ETIME


34 
	#ETIME
 64

	)

37 
	#SIGEV_PORT
 4

	)

40 
	mpÜ‹v_ev’ts
;

41 
ushÜt_t
 
	mpÜ‹v_sourû
;

42 
ushÜt_t
 
	mpÜ‹v_·d
;

43 
ušŒ_t
 
	mpÜ‹v_objeù
;

44 *
	mpÜ‹v_u£r
;

45 } 
	tpÜt_ev’t_t
;

47 
	spÜt_nÙify
 {

48 
	mpÜŠfy_pÜt
;

49 *
	mpÜŠfy_u£r
;

50 } 
	tpÜt_nÙify_t
;

52 #ià(
__F»eBSD_v”siÚ
 < 700005)

54 
	s™im”¥ec
 {

55 
time¥ec
 
	m™_š‹rv®
;

56 
time¥ec
 
	m™_v®ue
;

57 } 
	t™im”¥ec_t
;

61 
pÜt_ü—‹
();

63 
	$pÜt_ü—‹
()

66 
	}
}

69 
pÜt_assocŸ‹
(
pÜt
, 
sourû
, 
ušŒ_t
 
objeù
, 
ev’ts
,

70 *
u£r
);

72 
	$pÜt_assocŸ‹
(
pÜt
, 
sourû
, 
ušŒ_t
 
objeù
, 
ev’ts
,

73 *
u£r
)

76 
	}
}

79 
pÜt_dissocŸ‹
(
pÜt
, 
sourû
, 
ušŒ_t
 
objeù
);

81 
	$pÜt_dissocŸ‹
(
pÜt
, 
sourû
, 
ušŒ_t
 
objeù
)

84 
	}
}

87 
pÜt_g‘n
(
pÜt
, 
pÜt_ev’t_t
 
li¡
[], 
ušt_t
 
max
, ušt_ˆ*
ng‘
,

88 
time¥ec
 *
timeout
);

90 
	$pÜt_g‘n
(
pÜt
, 
pÜt_ev’t_t
 
li¡
[], 
ušt_t
 
max
, ušt_ˆ*
ng‘
,

91 
time¥ec
 *
timeout
)

94 
	}
}

97 
tim”_ü—‹
(
þockid_t
 
þock_id
, 
sigev’t
 *
evp
, 
tim”_t
 *
tim”id
);

99 
	$tim”_ü—‹
(
þockid_t
 
þock_id
, 
sigev’t
 *
evp
, 
tim”_t
 *
tim”id
)

102 
	}
}

105 
tim”_£‰ime
(
tim”_t
 
tim”id
, 
æags
, cÚ¡ 
™im”¥ec
 *
v®ue
,

106 
™im”¥ec
 *
ov®ue
);

108 
	$tim”_£‰ime
(
tim”_t
 
tim”id
, 
æags
, cÚ¡ 
™im”¥ec
 *
v®ue
,

109 
™im”¥ec
 *
ov®ue
)

112 
	}
}

115 
tim”_d–‘e
(
tim”_t
 
tim”id
);

117 
	$tim”_d–‘e
(
tim”_t
 
tim”id
)

120 
	}
}

126 
ngx_ušt_t
 
	mev’ts
;

127 } 
	tngx_ev’Üt_cÚf_t
;

130 
ngx_št_t
 
ngx_ev’Üt_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

131 
ngx_ev’Üt_dÚe
(
ngx_cyþe_t
 *
cyþe
);

132 
ngx_št_t
 
ngx_ev’Üt_add_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

133 
ngx_ušt_t
 
æags
);

134 
ngx_št_t
 
ngx_ev’Üt_d–_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

135 
ngx_ušt_t
 
æags
);

136 
ngx_št_t
 
ngx_ev’Üt_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
,

137 
ngx_m£c_t
 
tim”
, 
ngx_ušt_t
 
æags
);

139 *
ngx_ev’Üt_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

140 *
ngx_ev’Üt_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

142 
	g•
 = -1;

143 
pÜt_ev’t_t
 *
	gev’t_li¡
;

144 
ngx_ušt_t
 
	gÃv’ts
;

145 
tim”_t
 
	gev’t_tim”
 = (timer_t) -1;

147 
ngx_¡r_t
 
	gev’Üt_Çme
 = 
ngx_¡ršg
("eventport");

150 
ngx_commªd_t
 
	gngx_ev’Üt_commªds
[] = {

152 { 
ngx_¡ršg
("eventport_events"),

153 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

154 
ngx_cÚf_£t_num_¦Ù
,

156 
off£tof
(
ngx_ev’Üt_cÚf_t
, 
ev’ts
),

157 
NULL
 },

159 
ngx_nuÎ_commªd


163 
ngx_ev’t_moduË_t
 
	gngx_ev’Üt_moduË_ùx
 = {

164 &
ev’Üt_Çme
,

165 
ngx_ev’Üt_ü—‹_cÚf
,

166 
ngx_ev’Üt_š™_cÚf
,

169 
ngx_ev’Üt_add_ev’t
,

170 
ngx_ev’Üt_d–_ev’t
,

171 
ngx_ev’Üt_add_ev’t
,

172 
ngx_ev’Üt_d–_ev’t
,

173 
NULL
,

174 
NULL
,

175 
NULL
,

176 
ngx_ev’Üt_´oûss_ev’ts
,

177 
ngx_ev’Üt_š™
,

178 
ngx_ev’Üt_dÚe
,

183 
ngx_moduË_t
 
	gngx_ev’Üt_moduË
 = {

184 
NGX_MODULE_V1
,

185 &
ngx_ev’Üt_moduË_ùx
,

186 
ngx_ev’Üt_commªds
,

187 
NGX_EVENT_MODULE
,

188 
NULL
,

189 
NULL
,

190 
NULL
,

191 
NULL
,

192 
NULL
,

193 
NULL
,

194 
NULL
,

195 
NGX_MODULE_V1_PADDING


199 
ngx_št_t


200 
	$ngx_ev’Üt_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

202 
pÜt_nÙify_t
 
²
;

203 
™im”¥ec
 
™s
;

204 
sigev’t
 
£v
;

205 
ngx_ev’Üt_cÚf_t
 *
•cf
;

207 
•cf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_ev’Üt_moduË
);

209 ià(
•
 == -1) {

210 
•
 = 
	`pÜt_ü—‹
();

212 ià(
•
 == -1) {

213 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

215  
NGX_ERROR
;

219 ià(
Ãv’ts
 < 
•cf
->
ev’ts
) {

220 ià(
ev’t_li¡
) {

221 
	`ngx_ä“
(
ev’t_li¡
);

224 
ev’t_li¡
 = 
	`ngx_®loc
((
pÜt_ev’t_t
è* 
•cf
->
ev’ts
,

225 
cyþe
->
log
);

226 ià(
ev’t_li¡
 =ð
NULL
) {

227  
NGX_ERROR
;

231 
ngx_ev’t_æags
 = 
NGX_USE_EVENTPORT_EVENT
;

233 ià(
tim”
) {

234 
	`ngx_memz”o
(&
²
, (
pÜt_nÙify_t
));

235 
²
.
pÜŠfy_pÜt
 = 
•
;

237 
	`ngx_memz”o
(&
£v
, (
sigev’t
));

238 
£v
.
sigev_nÙify
 = 
SIGEV_PORT
;

239 #ià!(
NGX_TEST_BUILD_EVENTPORT
)

240 
£v
.
sigev_v®ue
.
siv®_±r
 = &
²
;

243 ià(
	`tim”_ü—‹
(
CLOCK_REALTIME
, &
£v
, &
ev’t_tim”
) == -1) {

244 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

246  
NGX_ERROR
;

249 
™s
.
™_š‹rv®
.
tv_£c
 = 
tim”
 / 1000;

250 
™s
.
™_š‹rv®
.
tv_n£c
 = (
tim”
 % 1000) * 1000000;

251 
™s
.
™_v®ue
.
tv_£c
 = 
tim”
 / 1000;

252 
™s
.
™_v®ue
.
tv_n£c
 = (
tim”
 % 1000) * 1000000;

254 ià(
	`tim”_£‰ime
(
ev’t_tim”
, 0, &
™s
, 
NULL
) == -1) {

255 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

257  
NGX_ERROR
;

260 
ngx_ev’t_æags
 |ð
NGX_USE_TIMER_EVENT
;

263 
Ãv’ts
 = 
•cf
->
ev’ts
;

265 
ngx_io
 = 
ngx_os_io
;

267 
ngx_ev’t_aùiÚs
 = 
ngx_ev’Üt_moduË_ùx
.
aùiÚs
;

269  
NGX_OK
;

270 
	}
}

274 
	$ngx_ev’Üt_dÚe
(
ngx_cyþe_t
 *
cyþe
)

276 ià(
ev’t_tim”
 !ð(
tim”_t
) -1) {

277 ià(
	`tim”_d–‘e
(
ev’t_tim”
) == -1) {

278 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

282 
ev’t_tim”
 = (
tim”_t
) -1;

285 ià(
	`þo£
(
•
) == -1) {

286 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

290 
•
 = -1;

292 
	`ngx_ä“
(
ev’t_li¡
);

294 
ev’t_li¡
 = 
NULL
;

295 
Ãv’ts
 = 0;

296 
	}
}

299 
ngx_št_t


300 
	$ngx_ev’Üt_add_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

302 
ngx_št_t
 
ev’ts
, 
´ev
;

303 
ngx_ev’t_t
 *
e
;

304 
ngx_cÚÃùiÚ_t
 *
c
;

306 
c
 = 
ev
->
d©a
;

308 
ev’ts
 = 
ev’t
;

310 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

311 
e
 = 
c
->
wr™e
;

312 
´ev
 = 
POLLOUT
;

313 #ià(
NGX_READ_EVENT
 !ð
POLLIN
)

314 
ev’ts
 = 
POLLIN
;

318 
e
 = 
c
->
»ad
;

319 
´ev
 = 
POLLIN
;

320 #ià(
NGX_WRITE_EVENT
 !ð
POLLOUT
)

321 
ev’ts
 = 
POLLOUT
;

325 ià(
e
->
ÚeshÙ
) {

326 
ev’ts
 |ð
´ev
;

329 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

330 "ev’Üˆaddƒv’t: fd:%dƒv:%04Xi", 
c
->
fd
, 
ev’ts
);

332 ià(
	`pÜt_assocŸ‹
(
•
, 
PORT_SOURCE_FD
, 
c
->
fd
, 
ev’ts
,

333 (*è((
ušŒ_t
è
ev
 |ƒv->
š¡ªû
))

336 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

338  
NGX_ERROR
;

341 
ev
->
aùive
 = 1;

342 
ev
->
ÚeshÙ
 = 1;

344  
NGX_OK
;

345 
	}
}

348 
ngx_št_t


349 
	$ngx_ev’Üt_d–_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

351 
ngx_ev’t_t
 *
e
;

352 
ngx_cÚÃùiÚ_t
 *
c
;

360 ià(
æags
 & 
NGX_CLOSE_EVENT
) {

361 
ev
->
aùive
 = 0;

362 
ev
->
ÚeshÙ
 = 0;

363  
NGX_OK
;

366 
c
 = 
ev
->
d©a
;

368 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

369 
e
 = 
c
->
wr™e
;

370 
ev’t
 = 
POLLOUT
;

373 
e
 = 
c
->
»ad
;

374 
ev’t
 = 
POLLIN
;

377 ià(
e
->
ÚeshÙ
) {

378 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

379 "ev’Üˆchªgev’t: fd:%dƒv:%04Xi", 
c
->
fd
, 
ev’t
);

381 ià(
	`pÜt_assocŸ‹
(
•
, 
PORT_SOURCE_FD
, 
c
->
fd
, 
ev’t
,

382 (*è((
ušŒ_t
è
ev
 |ƒv->
š¡ªû
))

385 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

387  
NGX_ERROR
;

391 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

392 "ev’Üˆd–ƒv’t: fd:%d", 
c
->
fd
);

394 ià(
	`pÜt_dissocŸ‹
(
•
, 
PORT_SOURCE_FD
, 
c
->
fd
) == -1) {

395 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

397  
NGX_ERROR
;

401 
ev
->
aùive
 = 0;

402 
ev
->
ÚeshÙ
 = 0;

404  
NGX_OK
;

405 
	}
}

408 
ngx_št_t


409 
	$ngx_ev’Üt_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

410 
ngx_ušt_t
 
æags
)

412 
n
, 
»v’ts
;

413 
u_št
 
ev’ts
;

414 
ngx_”r_t
 
”r
;

415 
ngx_št_t
 
š¡ªû
;

416 
ngx_ušt_t
 
i
, 
Ëv–
;

417 
ngx_ev’t_t
 *
ev
, *
»v
, *
wev
;

418 
ngx_queue_t
 *
queue
;

419 
ngx_cÚÃùiÚ_t
 *
c
;

420 
time¥ec
 
ts
, *

;

422 ià(
tim”
 =ð
NGX_TIMER_INFINITE
) {

423 

 = 
NULL
;

426 
ts
.
tv_£c
 = 
tim”
 / 1000;

427 
ts
.
tv_n£c
 = (
tim”
 % 1000) * 1000000;

428 

 = &
ts
;

431 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

432 "ev’Üˆtim”: %M", 
tim”
);

434 
ev’ts
 = 1;

436 
n
 = 
	`pÜt_g‘n
(
•
, 
ev’t_li¡
, (
u_št
è
Ãv’ts
, &
ev’ts
, 

);

438 
”r
 = 
ngx_”ºo
;

440 ià(
æags
 & 
NGX_UPDATE_TIME
) {

441 
	`ngx_time_upd©e
();

444 ià(
n
 == -1) {

445 ià(
”r
 =ð
ETIME
) {

446 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

447  
NGX_OK
;

450 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

452  
NGX_ERROR
;

455 
Ëv–
 = (
”r
 =ð
NGX_EINTR
è? 
NGX_LOG_INFO
 : 
NGX_LOG_ALERT
;

456 
	`ngx_log_”rÜ
(
Ëv–
, 
cyþe
->
log
, 
”r
, "port_getn() failed");

457  
NGX_ERROR
;

460 ià(
ev’ts
 == 0) {

461 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

462  
NGX_OK
;

465 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

467  
NGX_ERROR
;

470 
i
 = 0; i < 
ev’ts
; i++) {

472 ià(
ev’t_li¡
[
i
].
pÜ‹v_sourû
 =ð
PORT_SOURCE_TIMER
) {

473 
	`ngx_time_upd©e
();

477 
ev
 = 
ev’t_li¡
[
i
].
pÜ‹v_u£r
;

479 
ev’t_li¡
[
i
].
pÜ‹v_sourû
) {

481 
PORT_SOURCE_FD
:

483 
š¡ªû
 = (
ušŒ_t
è
ev
 & 1;

484 
ev
 = (
ngx_ev’t_t
 *è((
ušŒ_t
)ƒv & (uintptr_t) ~1);

486 ià(
ev
->
þo£d
 ||ƒv->
š¡ªû
 != instance) {

493 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

494 "ev’Üt: sËƒv’ˆ%p", 
ev
);

498 
»v’ts
 = 
ev’t_li¡
[
i
].
pÜ‹v_ev’ts
;

500 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

502 
ev’t_li¡
[
i
].
pÜ‹v_objeù
, 
»v’ts
);

504 ià(
»v’ts
 & (
POLLERR
|
POLLHUP
|
POLLNVAL
)) {

505 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

507 
ev’t_li¡
[
i
].
pÜ‹v_objeù
, 
»v’ts
);

510 ià(
»v’ts
 & ~(
POLLIN
|
POLLOUT
|
POLLERR
|
POLLHUP
|
POLLNVAL
)) {

511 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

513 
ev’t_li¡
[
i
].
pÜ‹v_objeù
, 
»v’ts
);

516 ià((
»v’ts
 & (
POLLERR
|
POLLHUP
|
POLLNVAL
))

517 && (
»v’ts
 & (
POLLIN
|
POLLOUT
)) == 0)

525 
»v’ts
 |ð
POLLIN
|
POLLOUT
;

528 
c
 = 
ev
->
d©a
;

529 
»v
 = 
c
->
»ad
;

530 
wev
 = 
c
->
wr™e
;

532 
»v
->
aùive
 = 0;

533 
wev
->
aùive
 = 0;

535 ià(
»v’ts
 & 
POLLIN
) {

536 
»v
->
»ady
 = 1;

538 ià(
æags
 & 
NGX_POST_EVENTS
) {

539 
queue
 = 
»v
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


540 : &
ngx_po¡ed_ev’ts
;

542 
	`ngx_po¡_ev’t
(
»v
, 
queue
);

545 
»v
->
	`hªdËr
(rev);

547 ià(
ev
->
þo£d
 ||ƒv->
š¡ªû
 != instance) {

552 ià(
»v
->
acû±
) {

553 ià(
ngx_u£_acû±_mu‹x
) {

554 
ngx_acû±_ev’ts
 = 1;

558 ià(
	`pÜt_assocŸ‹
(
•
, 
PORT_SOURCE_FD
, 
c
->
fd
, 
POLLIN
,

559 (*è((
ušŒ_t
è
ev
 |ƒv->
š¡ªû
))

562 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

564  
NGX_ERROR
;

569 ià(
»v’ts
 & 
POLLOUT
) {

570 
wev
->
»ady
 = 1;

572 ià(
æags
 & 
NGX_POST_EVENTS
) {

573 
	`ngx_po¡_ev’t
(
wev
, &
ngx_po¡ed_ev’ts
);

576 
wev
->
	`hªdËr
(wev);

583 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

585 
ev’t_li¡
[
i
].
pÜ‹v_objeù
);

590  
NGX_OK
;

591 
	}
}

595 
	$ngx_ev’Üt_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

597 
ngx_ev’Üt_cÚf_t
 *
•cf
;

599 
•cf
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, (
ngx_ev’Üt_cÚf_t
));

600 ià(
•cf
 =ð
NULL
) {

601  
NULL
;

604 
•cf
->
ev’ts
 = 
NGX_CONF_UNSET
;

606  
•cf
;

607 
	}
}

611 
	$ngx_ev’Üt_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

613 
ngx_ev’Üt_cÚf_t
 *
•cf
 = 
cÚf
;

615 
	`ngx_cÚf_š™_ušt_v®ue
(
•cf
->
ev’ts
, 32);

617  
NGX_CONF_OK
;

618 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_kqueue_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

14 
ngx_ušt_t
 
	mchªges
;

15 
ngx_ušt_t
 
	mev’ts
;

16 } 
	tngx_kqueue_cÚf_t
;

19 
ngx_št_t
 
ngx_kqueue_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

20 
ngx_kqueue_dÚe
(
ngx_cyþe_t
 *
cyþe
);

21 
ngx_št_t
 
ngx_kqueue_add_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

22 
ngx_ušt_t
 
æags
);

23 
ngx_št_t
 
ngx_kqueue_d–_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

24 
ngx_ušt_t
 
æags
);

25 
ngx_št_t
 
ngx_kqueue_£t_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
fž‹r
,

26 
ngx_ušt_t
 
æags
);

27 
ngx_št_t
 
ngx_kqueue_´oûss_chªges
(
ngx_cyþe_t
 *
cyþe
, 
ngx_ušt_t
 
Œy
);

28 
ngx_št_t
 
ngx_kqueue_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

29 
ngx_ušt_t
 
æags
);

30 
ngx_šlše
 
ngx_kqueue_dump_ev’t
(
ngx_log_t
 *
log
,

31 
kev’t
 *
kev
);

33 *
ngx_kqueue_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

34 *
ngx_kqueue_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

37 
	gngx_kqueue
 = -1;

47 
kev’t
 *
	gchªge_li¡
, *
	gchªge_li¡0
, *
	gchªge_li¡1
;

48 
kev’t
 *
	gev’t_li¡
;

49 
ngx_ušt_t
 
	gmax_chªges
, 
	gnchªges
, 
	gÃv’ts
;

51 #ià(
NGX_THREADS
)

52 
ngx_mu‹x_t
 *
	gli¡_mu‹x
;

53 
ngx_mu‹x_t
 *
	gkev’t_mu‹x
;

58 
ngx_¡r_t
 
	gkqueue_Çme
 = 
ngx_¡ršg
("kqueue");

60 
ngx_commªd_t
 
	gngx_kqueue_commªds
[] = {

62 { 
ngx_¡ršg
("kqueue_changes"),

63 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

64 
ngx_cÚf_£t_num_¦Ù
,

66 
off£tof
(
ngx_kqueue_cÚf_t
, 
chªges
),

67 
NULL
 },

69 { 
ngx_¡ršg
("kqueue_events"),

70 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

71 
ngx_cÚf_£t_num_¦Ù
,

73 
off£tof
(
ngx_kqueue_cÚf_t
, 
ev’ts
),

74 
NULL
 },

76 
ngx_nuÎ_commªd


80 
ngx_ev’t_moduË_t
 
	gngx_kqueue_moduË_ùx
 = {

81 &
kqueue_Çme
,

82 
ngx_kqueue_ü—‹_cÚf
,

83 
ngx_kqueue_š™_cÚf
,

86 
ngx_kqueue_add_ev’t
,

87 
ngx_kqueue_d–_ev’t
,

88 
ngx_kqueue_add_ev’t
,

89 
ngx_kqueue_d–_ev’t
,

90 
NULL
,

91 
NULL
,

92 
ngx_kqueue_´oûss_chªges
,

93 
ngx_kqueue_´oûss_ev’ts
,

94 
ngx_kqueue_š™
,

95 
ngx_kqueue_dÚe


100 
ngx_moduË_t
 
	gngx_kqueue_moduË
 = {

101 
NGX_MODULE_V1
,

102 &
ngx_kqueue_moduË_ùx
,

103 
ngx_kqueue_commªds
,

104 
NGX_EVENT_MODULE
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NULL
,

110 
NULL
,

111 
NULL
,

112 
NGX_MODULE_V1_PADDING


116 
ngx_št_t


117 
	$ngx_kqueue_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

119 
ngx_kqueue_cÚf_t
 *
kcf
;

120 
time¥ec
 
ts
;

121 #ià(
NGX_HAVE_TIMER_EVENT
)

122 
kev’t
 
kev
;

125 
kcf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_kqueue_moduË
);

127 ià(
ngx_kqueue
 == -1) {

128 
ngx_kqueue
 = 
	`kqueue
();

130 ià(
ngx_kqueue
 == -1) {

131 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

133  
NGX_ERROR
;

136 #ià(
NGX_THREADS
)

138 
li¡_mu‹x
 = 
	`ngx_mu‹x_š™
(
cyþe
->
log
, 0);

139 ià(
li¡_mu‹x
 =ð
NULL
) {

140  
NGX_ERROR
;

143 
kev’t_mu‹x
 = 
	`ngx_mu‹x_š™
(
cyþe
->
log
, 0);

144 ià(
kev’t_mu‹x
 =ð
NULL
) {

145  
NGX_ERROR
;

151 ià(
max_chªges
 < 
kcf
->
chªges
) {

152 ià(
nchªges
) {

153 
ts
.
tv_£c
 = 0;

154 
ts
.
tv_n£c
 = 0;

156 ià(
	`kev’t
(
ngx_kqueue
, 
chªge_li¡
, (è
nchªges
, 
NULL
, 0, &
ts
)

159 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

161  
NGX_ERROR
;

163 
nchªges
 = 0;

166 ià(
chªge_li¡0
) {

167 
	`ngx_ä“
(
chªge_li¡0
);

170 
chªge_li¡0
 = 
	`ngx_®loc
(
kcf
->
chªges
 * (
kev’t
),

171 
cyþe
->
log
);

172 ià(
chªge_li¡0
 =ð
NULL
) {

173  
NGX_ERROR
;

176 ià(
chªge_li¡1
) {

177 
	`ngx_ä“
(
chªge_li¡1
);

180 
chªge_li¡1
 = 
	`ngx_®loc
(
kcf
->
chªges
 * (
kev’t
),

181 
cyþe
->
log
);

182 ià(
chªge_li¡1
 =ð
NULL
) {

183  
NGX_ERROR
;

186 
chªge_li¡
 = 
chªge_li¡0
;

189 
max_chªges
 = 
kcf
->
chªges
;

191 ià(
Ãv’ts
 < 
kcf
->
ev’ts
) {

192 ià(
ev’t_li¡
) {

193 
	`ngx_ä“
(
ev’t_li¡
);

196 
ev’t_li¡
 = 
	`ngx_®loc
(
kcf
->
ev’ts
 * (
kev’t
), 
cyþe
->
log
);

197 ià(
ev’t_li¡
 =ð
NULL
) {

198  
NGX_ERROR
;

202 
ngx_ev’t_æags
 = 
NGX_USE_ONESHOT_EVENT


203 |
NGX_USE_KQUEUE_EVENT


204 |
NGX_USE_VNODE_EVENT
;

206 #ià(
NGX_HAVE_TIMER_EVENT
)

208 ià(
tim”
) {

209 
kev
.
id’t
 = 0;

210 
kev
.
fž‹r
 = 
EVFILT_TIMER
;

211 
kev
.
æags
 = 
EV_ADD
|
EV_ENABLE
;

212 
kev
.
fæags
 = 0;

213 
kev
.
d©a
 = 
tim”
;

214 
kev
.
ud©a
 = 0;

216 
ts
.
tv_£c
 = 0;

217 
ts
.
tv_n£c
 = 0;

219 ià(
	`kev’t
(
ngx_kqueue
, &
kev
, 1, 
NULL
, 0, &
ts
) == -1) {

220 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

222  
NGX_ERROR
;

225 
ngx_ev’t_æags
 |ð
NGX_USE_TIMER_EVENT
;

230 #ià(
NGX_HAVE_CLEAR_EVENT
)

231 
ngx_ev’t_æags
 |ð
NGX_USE_CLEAR_EVENT
;

233 
ngx_ev’t_æags
 |ð
NGX_USE_LEVEL_EVENT
;

236 #ià(
NGX_HAVE_LOWAT_EVENT
)

237 
ngx_ev’t_æags
 |ð
NGX_USE_LOWAT_EVENT
;

240 
Ãv’ts
 = 
kcf
->
ev’ts
;

242 
ngx_io
 = 
ngx_os_io
;

244 
ngx_ev’t_aùiÚs
 = 
ngx_kqueue_moduË_ùx
.
aùiÚs
;

246  
NGX_OK
;

247 
	}
}

251 
	$ngx_kqueue_dÚe
(
ngx_cyþe_t
 *
cyþe
)

253 ià(
	`þo£
(
ngx_kqueue
) == -1) {

254 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

258 
ngx_kqueue
 = -1;

260 #ià(
NGX_THREADS
)

261 
	`ngx_mu‹x_de¡roy
(
kev’t_mu‹x
);

262 
	`ngx_mu‹x_de¡roy
(
li¡_mu‹x
);

265 
	`ngx_ä“
(
chªge_li¡1
);

266 
	`ngx_ä“
(
chªge_li¡0
);

267 
	`ngx_ä“
(
ev’t_li¡
);

269 
chªge_li¡1
 = 
NULL
;

270 
chªge_li¡0
 = 
NULL
;

271 
chªge_li¡
 = 
NULL
;

272 
ev’t_li¡
 = 
NULL
;

273 
max_chªges
 = 0;

274 
nchªges
 = 0;

275 
Ãv’ts
 = 0;

276 
	}
}

279 
ngx_št_t


280 
	$ngx_kqueue_add_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

282 
ngx_št_t
 
rc
;

284 
ngx_ev’t_t
 *
e
;

285 
ngx_cÚÃùiÚ_t
 *
c
;

288 
ev
->
aùive
 = 1;

289 
ev
->
di§bËd
 = 0;

290 
ev
->
ÚeshÙ
 = (
æags
 & 
NGX_ONESHOT_EVENT
) ? 1 : 0;

292 
	`ngx_mu‹x_lock
(
li¡_mu‹x
);

296 ià(
ev
->
šdex
 < 
nchªges


297 && ((
ušŒ_t
è
chªge_li¡
[
ev
->
šdex
].
ud©a
 & (uintptr_t) ~1)

298 =ð(
ušŒ_t
è
ev
)

300 ià(
chªge_li¡
[
ev
->
šdex
].
æags
 =ð
EV_DISABLE
) {

307 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

309 
	`ngx_ev’t_id’t
(
ev
->
d©a
), 
ev’t
);

311 ià(
ev
->
šdex
 < --
nchªges
) {

312 
e
 = (
ngx_ev’t_t
 *)

313 ((
ušŒ_t
è
chªge_li¡
[
nchªges
].
ud©a
 & (uintptr_t) ~1);

314 
chªge_li¡
[
ev
->
šdex
] = chªge_li¡[
nchªges
];

315 
e
->
šdex
 = 
ev
->index;

318 
	`ngx_mu‹x_uÆock
(
li¡_mu‹x
);

320  
NGX_OK
;

323 
c
 = 
ev
->
d©a
;

325 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

326 "´eviou ev’ˆÚ #%d w”nÙ…as£d iÀk”Ãl", 
c
->
fd
);

328 
	`ngx_mu‹x_uÆock
(
li¡_mu‹x
);

330  
NGX_ERROR
;

335 
rc
 = 
	`ngx_kqueue_£t_ev’t
(
ev
, 
ev’t
, 
EV_ADD
|
EV_ENABLE
|
æags
);

337 
	`ngx_mu‹x_uÆock
(
li¡_mu‹x
);

339  
rc
;

340 
	}
}

343 
ngx_št_t


344 
	$ngx_kqueue_d–_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

346 
ngx_št_t
 
rc
;

347 
ngx_ev’t_t
 *
e
;

349 
ev
->
aùive
 = 0;

350 
ev
->
di§bËd
 = 0;

352 
	`ngx_mu‹x_lock
(
li¡_mu‹x
);

354 ià(
ev
->
šdex
 < 
nchªges


355 && ((
ušŒ_t
è
chªge_li¡
[
ev
->
šdex
].
ud©a
 & (uintptr_t) ~1)

356 =ð(
ušŒ_t
è
ev
)

358 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

360 
	`ngx_ev’t_id’t
(
ev
->
d©a
), 
ev’t
);

364 
nchªges
--;

366 ià(
ev
->
šdex
 < 
nchªges
) {

367 
e
 = (
ngx_ev’t_t
 *)

368 ((
ušŒ_t
è
chªge_li¡
[
nchªges
].
ud©a
 & (uintptr_t) ~1);

369 
chªge_li¡
[
ev
->
šdex
] = chªge_li¡[
nchªges
];

370 
e
->
šdex
 = 
ev
->index;

373 
	`ngx_mu‹x_uÆock
(
li¡_mu‹x
);

375  
NGX_OK
;

384 ià(
æags
 & 
NGX_CLOSE_EVENT
) {

385 
	`ngx_mu‹x_uÆock
(
li¡_mu‹x
);

386  
NGX_OK
;

389 ià(
æags
 & 
NGX_DISABLE_EVENT
) {

390 
ev
->
di§bËd
 = 1;

393 
æags
 |ð
EV_DELETE
;

396 
rc
 = 
	`ngx_kqueue_£t_ev’t
(
ev
, 
ev’t
, 
æags
);

398 
	`ngx_mu‹x_uÆock
(
li¡_mu‹x
);

400  
rc
;

401 
	}
}

404 
ngx_št_t


405 
	$ngx_kqueue_£t_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
fž‹r
, 
ngx_ušt_t
 
æags
)

407 
kev’t
 *
kev
;

408 
time¥ec
 
ts
;

409 
ngx_cÚÃùiÚ_t
 *
c
;

411 
c
 = 
ev
->
d©a
;

413 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

415 
c
->
fd
, 
fž‹r
, 
æags
);

417 ià(
nchªges
 >ð
max_chªges
) {

418 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
ev
->
log
, 0,

421 
ts
.
tv_£c
 = 0;

422 
ts
.
tv_n£c
 = 0;

424 ià(
	`kev’t
(
ngx_kqueue
, 
chªge_li¡
, (è
nchªges
, 
NULL
, 0, &
ts
)

427 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
, "kevent() failed");

428  
NGX_ERROR
;

431 
nchªges
 = 0;

434 
kev
 = &
chªge_li¡
[
nchªges
];

436 
kev
->
id’t
 = 
c
->
fd
;

437 
kev
->
fž‹r
 = () filter;

438 
kev
->
æags
 = (
u_shÜt
) flags;

439 
kev
->
ud©a
 = 
	`NGX_KQUEUE_UDATA_T
 ((
ušŒ_t
è
ev
 |ƒv->
š¡ªû
);

441 ià(
fž‹r
 =ð
EVFILT_VNODE
) {

442 
kev
->
fæags
 = 
NOTE_DELETE
|
NOTE_WRITE
|
NOTE_EXTEND


443 |
NOTE_ATTRIB
|
NOTE_RENAME


444 #ià(
__F»eBSD__
 =ð4 && 
__F»eBSD_v”siÚ
 >= 430000) \

445 || 
__F»eBSD_v”siÚ
 >= 500018

446 |
NOTE_REVOKE


449 
kev
->
d©a
 = 0;

452 #ià(
NGX_HAVE_LOWAT_EVENT
)

453 ià(
æags
 & 
NGX_LOWAT_EVENT
) {

454 
kev
->
fæags
 = 
NOTE_LOWAT
;

455 
kev
->
d©a
 = 
ev
->
avažabË
;

458 
kev
->
fæags
 = 0;

459 
kev
->
d©a
 = 0;

462 
kev
->
fæags
 = 0;

463 
kev
->
d©a
 = 0;

467 
ev
->
šdex
 = 
nchªges
;

468 
nchªges
++;

470 ià(
æags
 & 
NGX_FLUSH_EVENT
) {

471 
ts
.
tv_£c
 = 0;

472 
ts
.
tv_n£c
 = 0;

474 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0, "kevent flush");

476 ià(
	`kev’t
(
ngx_kqueue
, 
chªge_li¡
, (è
nchªges
, 
NULL
, 0, &
ts
)

479 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
, "kevent() failed");

480  
NGX_ERROR
;

483 
nchªges
 = 0;

486  
NGX_OK
;

487 
	}
}

490 
ngx_št_t


491 
	$ngx_kqueue_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

492 
ngx_ušt_t
 
æags
)

494 
ev’ts
, 
n
;

495 
ngx_št_t
 
i
, 
š¡ªû
;

496 
ngx_ušt_t
 
Ëv–
;

497 
ngx_”r_t
 
”r
;

498 
ngx_ev’t_t
 *
ev
;

499 
ngx_queue_t
 *
queue
;

500 
time¥ec
 
ts
, *

;

502 ià(
ngx_th»aded
) {

503 ià(
	`ngx_kqueue_´oûss_chªges
(
cyþe
, 0è=ð
NGX_ERROR
) {

504  
NGX_ERROR
;

507 
n
 = 0;

510 
n
 = (è
nchªges
;

511 
nchªges
 = 0;

514 ià(
tim”
 =ð
NGX_TIMER_INFINITE
) {

515 

 = 
NULL
;

519 
ts
.
tv_£c
 = 
tim”
 / 1000;

520 
ts
.
tv_n£c
 = (
tim”
 % 1000) * 1000000;

528 #ià(
NGX_DARWIN_KEVENT_BUG
)

529 
ts
.
tv_n£c
 <<= 32;

532 

 = &
ts
;

535 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

536 "kev’ˆtim”: %M, chªges: %d", 
tim”
, 
n
);

538 
ev’ts
 = 
	`kev’t
(
ngx_kqueue
, 
chªge_li¡
, 
n
, 
ev’t_li¡
, (è
Ãv’ts
, 

);

540 
”r
 = (
ev’ts
 =ð-1è? 
ngx_”ºo
 : 0;

542 ià(
æags
 & 
NGX_UPDATE_TIME
 || 
ngx_ev’t_tim”_®¬m
) {

543 
	`ngx_time_upd©e
();

546 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

547 "kev’ˆev’ts: %d", 
ev’ts
);

549 ià(
”r
) {

550 ià(
”r
 =ð
NGX_EINTR
) {

552 ià(
ngx_ev’t_tim”_®¬m
) {

553 
ngx_ev’t_tim”_®¬m
 = 0;

554  
NGX_OK
;

557 
Ëv–
 = 
NGX_LOG_INFO
;

560 
Ëv–
 = 
NGX_LOG_ALERT
;

563 
	`ngx_log_”rÜ
(
Ëv–
, 
cyþe
->
log
, 
”r
, "kevent() failed");

564  
NGX_ERROR
;

567 ià(
ev’ts
 == 0) {

568 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

569  
NGX_OK
;

572 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

574  
NGX_ERROR
;

577 
i
 = 0; i < 
ev’ts
; i++) {

579 
	`ngx_kqueue_dump_ev’t
(
cyþe
->
log
, &
ev’t_li¡
[
i
]);

581 ià(
ev’t_li¡
[
i
].
æags
 & 
EV_ERROR
) {

582 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ev’t_li¡
[
i
].
d©a
,

584 
ev’t_li¡
[
i
].
id’t
,ƒv’t_li¡[i].
fž‹r
,

585 
ev’t_li¡
[
i
].
æags
);

589 #ià(
NGX_HAVE_TIMER_EVENT
)

591 ià(
ev’t_li¡
[
i
].
fž‹r
 =ð
EVFILT_TIMER
) {

592 
	`ngx_time_upd©e
();

598 
ev
 = (
ngx_ev’t_t
 *è
ev’t_li¡
[
i
].
ud©a
;

600 
ev’t_li¡
[
i
].
fž‹r
) {

602 
EVFILT_READ
:

603 
EVFILT_WRITE
:

605 
š¡ªû
 = (
ušŒ_t
è
ev
 & 1;

606 
ev
 = (
ngx_ev’t_t
 *è((
ušŒ_t
)ƒv & (uintptr_t) ~1);

608 ià(
ev
->
þo£d
 ||ƒv->
š¡ªû
 != instance) {

615 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

616 "kev’t: sËƒv’ˆ%p", 
ev
);

620 ià(
ev
->
log
 && (ev->log->
log_Ëv–
 & 
NGX_LOG_DEBUG_CONNECTION
)) {

621 
	`ngx_kqueue_dump_ev’t
(
ev
->
log
, &
ev’t_li¡
[
i
]);

624 ià(
ev
->
ÚeshÙ
) {

625 
ev
->
aùive
 = 0;

628 
ev
->
avažabË
 = 
ev’t_li¡
[
i
].
d©a
;

630 ià(
ev’t_li¡
[
i
].
æags
 & 
EV_EOF
) {

631 
ev
->
³ndšg_eof
 = 1;

632 
ev
->
kq_”ºo
 = 
ev’t_li¡
[
i
].
fæags
;

635 
ev
->
»ady
 = 1;

639 
EVFILT_VNODE
:

640 
ev
->
kq_vnode
 = 1;

644 
EVFILT_AIO
:

645 
ev
->
com¶‘e
 = 1;

646 
ev
->
»ady
 = 1;

651 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

653 
ev’t_li¡
[
i
].
fž‹r
);

657 ià(
æags
 & 
NGX_POST_EVENTS
) {

658 
queue
 = 
ev
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


659 : &
ngx_po¡ed_ev’ts
;

661 
	`ngx_po¡_ev’t
(
ev
, 
queue
);

666 
ev
->
	`hªdËr
(ev);

669  
NGX_OK
;

670 
	}
}

673 
ngx_št_t


674 
	$ngx_kqueue_´oûss_chªges
(
ngx_cyþe_t
 *
cyþe
, 
ngx_ušt_t
 
Œy
)

676 
n
;

677 
ngx_št_t
 
rc
;

678 
ngx_”r_t
 
”r
;

679 
time¥ec
 
ts
;

680 
kev’t
 *
chªges
;

682 
	`ngx_mu‹x_lock
(
kev’t_mu‹x
);

684 
	`ngx_mu‹x_lock
(
li¡_mu‹x
);

686 ià(
nchªges
 == 0) {

687 
	`ngx_mu‹x_uÆock
(
li¡_mu‹x
);

688 
	`ngx_mu‹x_uÆock
(
kev’t_mu‹x
);

689  
NGX_OK
;

692 
chªges
 = 
chªge_li¡
;

693 ià(
chªge_li¡
 =ð
chªge_li¡0
) {

694 
chªge_li¡
 = 
chªge_li¡1
;

696 
chªge_li¡
 = 
chªge_li¡0
;

699 
n
 = (è
nchªges
;

700 
nchªges
 = 0;

702 
	`ngx_mu‹x_uÆock
(
li¡_mu‹x
);

704 
ts
.
tv_£c
 = 0;

705 
ts
.
tv_n£c
 = 0;

707 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

708 "kev’ˆchªges: %d", 
n
);

710 ià(
	`kev’t
(
ngx_kqueue
, 
chªges
, 
n
, 
NULL
, 0, &
ts
) == -1) {

711 
”r
 = 
ngx_”ºo
;

712 
	`ngx_log_”rÜ
((
”r
 =ð
NGX_EINTR
è? 
NGX_LOG_INFO
 : 
NGX_LOG_ALERT
,

713 
cyþe
->
log
, 
”r
, "kevent() failed");

714 
rc
 = 
NGX_ERROR
;

717 
rc
 = 
NGX_OK
;

720 
	`ngx_mu‹x_uÆock
(
kev’t_mu‹x
);

722  
rc
;

723 
	}
}

726 
ngx_šlše
 

727 
	$ngx_kqueue_dump_ev’t
(
ngx_log_t
 *
log
, 
kev’t
 *
kev
)

729 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_EVENT
, 
log
, 0,

730 (
kev
->
id’t
 > 0x8000000 && kev->ident != () -1) ?

733 
kev
->
id’t
, kev->
fž‹r
,

734 
kev
->
æags
, kev->
fæags
,

735 
kev
->
d©a
, kev->
ud©a
);

736 
	}
}

740 
	$ngx_kqueue_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

742 
ngx_kqueue_cÚf_t
 *
kcf
;

744 
kcf
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, (
ngx_kqueue_cÚf_t
));

745 ià(
kcf
 =ð
NULL
) {

746  
NULL
;

749 
kcf
->
chªges
 = 
NGX_CONF_UNSET
;

750 
kcf
->
ev’ts
 = 
NGX_CONF_UNSET
;

752  
kcf
;

753 
	}
}

757 
	$ngx_kqueue_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

759 
ngx_kqueue_cÚf_t
 *
kcf
 = 
cÚf
;

761 
	`ngx_cÚf_š™_ušt_v®ue
(
kcf
->
chªges
, 512);

762 
	`ngx_cÚf_š™_ušt_v®ue
(
kcf
->
ev’ts
, 512);

764  
NGX_CONF_OK
;

765 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_poll_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_št_t
 
ngx_pÞl_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

14 
ngx_pÞl_dÚe
(
ngx_cyþe_t
 *
cyþe
);

15 
ngx_št_t
 
ngx_pÞl_add_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

16 
ngx_ušt_t
 
æags
);

17 
ngx_št_t
 
ngx_pÞl_d–_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

18 
ngx_ušt_t
 
æags
);

19 
ngx_št_t
 
ngx_pÞl_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

20 
ngx_ušt_t
 
æags
);

21 *
ngx_pÞl_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

24 
pÞlfd
 *
	gev’t_li¡
;

25 
ngx_ušt_t
 
	gÃv’ts
;

28 
ngx_¡r_t
 
	gpÞl_Çme
 = 
ngx_¡ršg
("poll");

30 
ngx_ev’t_moduË_t
 
	gngx_pÞl_moduË_ùx
 = {

31 &
pÞl_Çme
,

32 
NULL
,

33 
ngx_pÞl_š™_cÚf
,

36 
ngx_pÞl_add_ev’t
,

37 
ngx_pÞl_d–_ev’t
,

38 
ngx_pÞl_add_ev’t
,

39 
ngx_pÞl_d–_ev’t
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
ngx_pÞl_´oûss_ev’ts
,

44 
ngx_pÞl_š™
,

45 
ngx_pÞl_dÚe


50 
ngx_moduË_t
 
	gngx_pÞl_moduË
 = {

51 
NGX_MODULE_V1
,

52 &
ngx_pÞl_moduË_ùx
,

53 
NULL
,

54 
NGX_EVENT_MODULE
,

55 
NULL
,

56 
NULL
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NGX_MODULE_V1_PADDING


67 
ngx_št_t


68 
	$ngx_pÞl_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

70 
pÞlfd
 *
li¡
;

72 ià(
ev’t_li¡
 =ð
NULL
) {

73 
Ãv’ts
 = 0;

76 ià(
ngx_´oûss
 >ð
NGX_PROCESS_WORKER


77 || 
cyþe
->
Þd_cyþe
 =ð
NULL


78 || 
cyþe
->
Þd_cyþe
->
cÚÃùiÚ_n
 < cycle->connection_n)

80 
li¡
 = 
	`ngx_®loc
((
pÞlfd
è* 
cyþe
->
cÚÃùiÚ_n
,

81 
cyþe
->
log
);

82 ià(
li¡
 =ð
NULL
) {

83  
NGX_ERROR
;

86 ià(
ev’t_li¡
) {

87 
	`ngx_memýy
(
li¡
, 
ev’t_li¡
, (
ngx_ev’t_t
 *è* 
Ãv’ts
);

88 
	`ngx_ä“
(
ev’t_li¡
);

91 
ev’t_li¡
 = 
li¡
;

94 
ngx_io
 = 
ngx_os_io
;

96 
ngx_ev’t_aùiÚs
 = 
ngx_pÞl_moduË_ùx
.
aùiÚs
;

98 
ngx_ev’t_æags
 = 
NGX_USE_LEVEL_EVENT
|
NGX_USE_FD_EVENT
;

100  
NGX_OK
;

101 
	}
}

105 
	$ngx_pÞl_dÚe
(
ngx_cyþe_t
 *
cyþe
)

107 
	`ngx_ä“
(
ev’t_li¡
);

109 
ev’t_li¡
 = 
NULL
;

110 
	}
}

113 
ngx_št_t


114 
	$ngx_pÞl_add_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

116 
ngx_ev’t_t
 *
e
;

117 
ngx_cÚÃùiÚ_t
 *
c
;

119 
c
 = 
ev
->
d©a
;

121 
ev
->
aùive
 = 1;

123 ià(
ev
->
šdex
 !ð
NGX_INVALID_INDEX
) {

124 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

125 "pÞÈev’ˆfd:%dƒv:%˜i ®»ady s‘", 
c
->
fd
, 
ev’t
);

126  
NGX_OK
;

129 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

130 
e
 = 
c
->
wr™e
;

131 #ià(
NGX_READ_EVENT
 !ð
POLLIN
)

132 
ev’t
 = 
POLLIN
;

136 
e
 = 
c
->
»ad
;

137 #ià(
NGX_WRITE_EVENT
 !ð
POLLOUT
)

138 
ev’t
 = 
POLLOUT
;

142 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

143 "pÞÈaddƒv’t: fd:%dƒv:%i", 
c
->
fd
, 
ev’t
);

145 ià(
e
 =ð
NULL
 ||ƒ->
šdex
 =ð
NGX_INVALID_INDEX
) {

146 
ev’t_li¡
[
Ãv’ts
].
fd
 = 
c
->fd;

147 
ev’t_li¡
[
Ãv’ts
].
ev’ts
 = (è
ev’t
;

148 
ev’t_li¡
[
Ãv’ts
].
»v’ts
 = 0;

150 
ev
->
šdex
 = 
Ãv’ts
;

151 
Ãv’ts
++;

154 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

155 "pÞÈadd index: %i", 
e
->
šdex
);

157 
ev’t_li¡
[
e
->
šdex
].
ev’ts
 |ð(è
ev’t
;

158 
ev
->
šdex
 = 
e
->index;

161  
NGX_OK
;

162 
	}
}

165 
ngx_št_t


166 
	$ngx_pÞl_d–_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

168 
ngx_ev’t_t
 *
e
;

169 
ngx_cÚÃùiÚ_t
 *
c
;

171 
c
 = 
ev
->
d©a
;

173 
ev
->
aùive
 = 0;

175 ià(
ev
->
šdex
 =ð
NGX_INVALID_INDEX
) {

176 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

178 
c
->
fd
, 
ev’t
);

179  
NGX_OK
;

182 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

183 
e
 = 
c
->
wr™e
;

184 #ià(
NGX_READ_EVENT
 !ð
POLLIN
)

185 
ev’t
 = 
POLLIN
;

189 
e
 = 
c
->
»ad
;

190 #ià(
NGX_WRITE_EVENT
 !ð
POLLOUT
)

191 
ev’t
 = 
POLLOUT
;

195 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

196 "pÞÈd–ƒv’t: fd:%dƒv:%i", 
c
->
fd
, 
ev’t
);

198 ià(
e
 =ð
NULL
 ||ƒ->
šdex
 =ð
NGX_INVALID_INDEX
) {

199 
Ãv’ts
--;

201 ià(
ev
->
šdex
 < 
Ãv’ts
) {

203 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

204 "šdex: cÝyƒv’ˆ%u˜tØ%i", 
Ãv’ts
, 
ev
->
šdex
);

206 
ev’t_li¡
[
ev
->
šdex
] =ƒv’t_li¡[
Ãv’ts
];

208 
c
 = 
ngx_cyþe
->
fžes
[
ev’t_li¡
[
Ãv’ts
].
fd
];

210 ià(
c
->
fd
 == -1) {

211 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

215 ià(
c
->
»ad
->
šdex
 =ð
Ãv’ts
) {

216 
c
->
»ad
->
šdex
 = 
ev
->index;

219 ià(
c
->
wr™e
->
šdex
 =ð
Ãv’ts
) {

220 
c
->
wr™e
->
šdex
 = 
ev
->index;

226 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

227 "pÞÈd– index: %i", 
e
->
šdex
);

229 
ev’t_li¡
[
e
->
šdex
].
ev’ts
 &ð(è~
ev’t
;

232 
ev
->
šdex
 = 
NGX_INVALID_INDEX
;

234  
NGX_OK
;

235 
	}
}

238 
ngx_št_t


239 
	$ngx_pÞl_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
, 
ngx_ušt_t
 
æags
)

241 
»ady
, 
»v’ts
;

242 
ngx_”r_t
 
”r
;

243 
ngx_ušt_t
 
i
, 
found
, 
Ëv–
;

244 
ngx_ev’t_t
 *
ev
;

245 
ngx_queue_t
 *
queue
;

246 
ngx_cÚÃùiÚ_t
 *
c
;

250 #ià(
NGX_DEBUG0
)

251 ià(
cyþe
->
log
->
log_Ëv–
 & 
NGX_LOG_DEBUG_ALL
) {

252 
i
 = 0; i < 
Ãv’ts
; i++) {

253 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

255 
i
, 
ev’t_li¡
[i].
fd
,ƒv’t_li¡[i].
ev’ts
);

260 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0, "pÞÈtim”: %M", 
tim”
);

262 
»ady
 = 
	`pÞl
(
ev’t_li¡
, (
u_št
è
Ãv’ts
, (è
tim”
);

264 
”r
 = (
»ady
 =ð-1è? 
ngx_”ºo
 : 0;

266 ià(
æags
 & 
NGX_UPDATE_TIME
 || 
ngx_ev’t_tim”_®¬m
) {

267 
	`ngx_time_upd©e
();

270 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

271 "pÞÈ»ady %d oà%ui", 
»ady
, 
Ãv’ts
);

273 ià(
”r
) {

274 ià(
”r
 =ð
NGX_EINTR
) {

276 ià(
ngx_ev’t_tim”_®¬m
) {

277 
ngx_ev’t_tim”_®¬m
 = 0;

278  
NGX_OK
;

281 
Ëv–
 = 
NGX_LOG_INFO
;

284 
Ëv–
 = 
NGX_LOG_ALERT
;

287 
	`ngx_log_”rÜ
(
Ëv–
, 
cyþe
->
log
, 
”r
, "poll() failed");

288  
NGX_ERROR
;

291 ià(
»ady
 == 0) {

292 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

293  
NGX_OK
;

296 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

298  
NGX_ERROR
;

301 
i
 = 0; i < 
Ãv’ts
 && 
»ady
; i++) {

303 
»v’ts
 = 
ev’t_li¡
[
i
].revents;

306 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

308 
i
, 
ev’t_li¡
[i].
fd
,ƒv’t_li¡[i].
ev’ts
, 
»v’ts
);

310 ià(
»v’ts
) {

311 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

313 
i
, 
ev’t_li¡
[i].
fd
,ƒv’t_li¡[i].
ev’ts
, 
»v’ts
);

317 ià(
»v’ts
 & 
POLLNVAL
) {

318 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

320 
ev’t_li¡
[
i
].
fd
,ƒv’t_li¡[i].
ev’ts
, 
»v’ts
);

323 ià(
»v’ts
 & ~(
POLLIN
|
POLLOUT
|
POLLERR
|
POLLHUP
|
POLLNVAL
)) {

324 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

326 
ev’t_li¡
[
i
].
fd
,ƒv’t_li¡[i].
ev’ts
, 
»v’ts
);

329 ià(
ev’t_li¡
[
i
].
fd
 == -1) {

337 
c
 = 
ngx_cyþe
->
fžes
[
ev’t_li¡
[
i
].
fd
];

339 ià(
c
->
fd
 == -1) {

340 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0, "unexpectedƒvent");

347 ià(
i
 =ð
Ãv’ts
 - 1) {

348 
Ãv’ts
--;

350 
ev’t_li¡
[
i
].
fd
 = -1;

356 ià((
»v’ts
 & (
POLLERR
|
POLLHUP
|
POLLNVAL
))

357 && (
»v’ts
 & (
POLLIN
|
POLLOUT
)) == 0)

365 
»v’ts
 |ð
POLLIN
|
POLLOUT
;

368 
found
 = 0;

370 ià((
»v’ts
 & 
POLLIN
è&& 
c
->
»ad
->
aùive
) {

371 
found
 = 1;

373 
ev
 = 
c
->
»ad
;

374 
ev
->
»ady
 = 1;

376 
queue
 = 
ev
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


377 : &
ngx_po¡ed_ev’ts
;

379 
	`ngx_po¡_ev’t
(
ev
, 
queue
);

382 ià((
»v’ts
 & 
POLLOUT
è&& 
c
->
wr™e
->
aùive
) {

383 
found
 = 1;

385 
ev
 = 
c
->
wr™e
;

386 
ev
->
»ady
 = 1;

388 
	`ngx_po¡_ev’t
(
ev
, &
ngx_po¡ed_ev’ts
);

391 ià(
found
) {

392 
»ady
--;

397 ià(
»ady
 != 0) {

398 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0, "poll„eady !=ƒvents");

401  
NGX_OK
;

402 
	}
}

406 
	$ngx_pÞl_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

408 
ngx_ev’t_cÚf_t
 *
ecf
;

410 
ecf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_ev’t_cÜe_moduË
);

412 ià(
ecf
->
u£
 !ð
ngx_pÞl_moduË
.
ùx_šdex
) {

413  
NGX_CONF_OK
;

416 #ià(
NGX_THREADS
)

418 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

420  
NGX_CONF_ERROR
;

424  
NGX_CONF_OK
;

427 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_rtsig_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 #ià(
NGX_TEST_BUILD_RTSIG
)

15 #ià(
NGX_DARWIN
)

17 
	#SIGRTMIN
 33

	)

18 
	#si_fd
 
__·d
[0]

	)

22 #ifdeà 
SIGRTMIN


23 
	#si_fd
 
_»asÚ
.
__¥¬e__
.
__¥¬e2__
[0]

	)

25 
	#SIGRTMIN
 33

	)

26 
	#si_fd
 
__¥¬e__
[0]

	)

31 
	#F_SETSIG
 10

	)

32 
	#KERN_RTSIGNR
 30

	)

33 
	#KERN_RTSIGMAX
 31

	)

35 
sigtimedwa™
(cÚ¡ 
sig£t_t
 *
£t
, 
sigšfo_t
 *
šfo
,

36 cÚ¡ 
time¥ec
 *
timeout
);

38 
	$sigtimedwa™
(cÚ¡ 
sig£t_t
 *
£t
, 
sigšfo_t
 *
šfo
,

39 cÚ¡ 
time¥ec
 *
timeout
)

42 
	}
}

44 
	gngx_lšux_¹sig_max
;

50 
ngx_ušt_t
 
	msigno
;

51 
ngx_ušt_t
 
	mov”æow_ev’ts
;

52 
ngx_ušt_t
 
	mov”æow_‹¡
;

53 
ngx_ušt_t
 
	mov”æow_th»shÞd
;

54 } 
	tngx_¹sig_cÚf_t
;

57 
ngx_ev’t_moduË_t
 
ngx_pÞl_moduË_ùx
;

59 
ngx_št_t
 
ngx_¹sig_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

60 
ngx_¹sig_dÚe
(
ngx_cyþe_t
 *
cyþe
);

61 
ngx_št_t
 
ngx_¹sig_add_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
);

62 
ngx_št_t
 
ngx_¹sig_d–_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
,

63 
ngx_ušt_t
 
æags
);

64 
ngx_št_t
 
ngx_¹sig_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
,

65 
ngx_m£c_t
 
tim”
, 
ngx_ušt_t
 
æags
);

66 
ngx_št_t
 
ngx_¹sig_´oûss_ov”æow
(
ngx_cyþe_t
 *
cyþe
,

67 
ngx_m£c_t
 
tim”
, 
ngx_ušt_t
 
æags
);

69 *
ngx_¹sig_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

70 *
ngx_¹sig_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

71 *
ngx_check_ngx_ov”æow_th»shÞd_bounds
(
ngx_cÚf_t
 *
cf
,

72 *
po¡
, *
d©a
);

75 
sig£t_t
 
	g£t
;

76 
ngx_ušt_t
 
	gov”æow
, 
	gov”æow_cu¼’t
;

77 
pÞlfd
 *
	gov”æow_li¡
;

80 
ngx_¡r_t
 
	g¹sig_Çme
 = 
ngx_¡ršg
("rtsig");

82 
ngx_cÚf_num_bounds_t
 
	gngx_ov”æow_th»shÞd_bounds
 = {

83 
ngx_check_ngx_ov”æow_th»shÞd_bounds
, 2, 10

87 
ngx_commªd_t
 
	gngx_¹sig_commªds
[] = {

89 { 
ngx_¡ršg
("rtsig_signo"),

90 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

91 
ngx_cÚf_£t_num_¦Ù
,

93 
off£tof
(
ngx_¹sig_cÚf_t
, 
signo
),

94 
NULL
 },

96 { 
ngx_¡ršg
("rtsig_overflow_events"),

97 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

98 
ngx_cÚf_£t_num_¦Ù
,

100 
off£tof
(
ngx_¹sig_cÚf_t
, 
ov”æow_ev’ts
),

101 
NULL
 },

103 { 
ngx_¡ršg
("rtsig_overflow_test"),

104 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

105 
ngx_cÚf_£t_num_¦Ù
,

107 
off£tof
(
ngx_¹sig_cÚf_t
, 
ov”æow_‹¡
),

108 
NULL
 },

110 { 
ngx_¡ršg
("rtsig_overflow_threshold"),

111 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

112 
ngx_cÚf_£t_num_¦Ù
,

114 
off£tof
(
ngx_¹sig_cÚf_t
, 
ov”æow_th»shÞd
),

115 &
ngx_ov”æow_th»shÞd_bounds
 },

117 
ngx_nuÎ_commªd


121 
ngx_ev’t_moduË_t
 
	gngx_¹sig_moduË_ùx
 = {

122 &
¹sig_Çme
,

123 
ngx_¹sig_ü—‹_cÚf
,

124 
ngx_¹sig_š™_cÚf
,

127 
NULL
,

128 
NULL
,

129 
NULL
,

130 
NULL
,

131 
ngx_¹sig_add_cÚÃùiÚ
,

132 
ngx_¹sig_d–_cÚÃùiÚ
,

133 
NULL
,

134 
ngx_¹sig_´oûss_ev’ts
,

135 
ngx_¹sig_š™
,

136 
ngx_¹sig_dÚe
,

141 
ngx_moduË_t
 
	gngx_¹sig_moduË
 = {

142 
NGX_MODULE_V1
,

143 &
ngx_¹sig_moduË_ùx
,

144 
ngx_¹sig_commªds
,

145 
NGX_EVENT_MODULE
,

146 
NULL
,

147 
NULL
,

148 
NULL
,

149 
NULL
,

150 
NULL
,

151 
NULL
,

152 
NULL
,

153 
NGX_MODULE_V1_PADDING


157 
ngx_št_t


158 
	$ngx_¹sig_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

160 
ngx_¹sig_cÚf_t
 *
¹scf
;

162 
¹scf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_¹sig_moduË
);

164 
	`sigem±y£t
(&
£t
);

165 
	`sigadd£t
(&
£t
, (è
¹scf
->
signo
);

166 
	`sigadd£t
(&
£t
, (è
¹scf
->
signo
 + 1);

167 
	`sigadd£t
(&
£t
, 
SIGIO
);

168 
	`sigadd£t
(&
£t
, 
SIGALRM
);

170 ià(
	`sig´ocmask
(
SIG_BLOCK
, &
£t
, 
NULL
) == -1) {

171 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

173  
NGX_ERROR
;

176 ià(
ov”æow_li¡
) {

177 
	`ngx_ä“
(
ov”æow_li¡
);

180 
ov”æow_li¡
 = 
	`ngx_®loc
((
pÞlfd
è* 
¹scf
->
ov”æow_ev’ts
,

181 
cyþe
->
log
);

182 ià(
ov”æow_li¡
 =ð
NULL
) {

183  
NGX_ERROR
;

186 
ngx_io
 = 
ngx_os_io
;

188 
ngx_ev’t_aùiÚs
 = 
ngx_¹sig_moduË_ùx
.
aùiÚs
;

190 
ngx_ev’t_æags
 = 
NGX_USE_RTSIG_EVENT


191 |
NGX_USE_GREEDY_EVENT


192 |
NGX_USE_FD_EVENT
;

194  
NGX_OK
;

195 
	}
}

199 
	$ngx_¹sig_dÚe
(
ngx_cyþe_t
 *
cyþe
)

201 
	`ngx_ä“
(
ov”æow_li¡
);

203 
ov”æow_li¡
 = 
NULL
;

204 
	}
}

207 
ngx_št_t


208 
	$ngx_¹sig_add_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

210 
ngx_ušt_t
 
signo
;

211 
ngx_¹sig_cÚf_t
 *
¹scf
;

213 ià(
c
->
»ad
->
acû±
 && c->»ad->
di§bËd
) {

215 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

216 "¹sigƒÇbË cÚÃùiÚ: fd:%d", 
c
->
fd
);

218 ià(
	`fúŽ
(
c
->
fd
, 
F_SETOWN
, 
ngx_pid
) == -1) {

219 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

221  
NGX_ERROR
;

224 
c
->
»ad
->
aùive
 = 1;

225 
c
->
»ad
->
di§bËd
 = 0;

228 
¹scf
 = 
	`ngx_ev’t_g‘_cÚf
(
ngx_cyþe
->
cÚf_ùx
, 
ngx_¹sig_moduË
);

230 
signo
 = 
¹scf
->signØ+ 
c
->
»ad
->
š¡ªû
;

232 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

233 "¹sig‡dd cÚÃùiÚ: fd:%d signo:%ui", 
c
->
fd
, 
signo
);

235 ià(
	`fúŽ
(
c
->
fd
, 
F_SETFL
, 
O_RDWR
|
O_NONBLOCK
|
O_ASYNC
) == -1) {

236 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

238  
NGX_ERROR
;

241 ià(
	`fúŽ
(
c
->
fd
, 
F_SETSIG
, (è
signo
) == -1) {

242 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

244  
NGX_ERROR
;

247 ià(
	`fúŽ
(
c
->
fd
, 
F_SETOWN
, 
ngx_pid
) == -1) {

248 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

250  
NGX_ERROR
;

253 #ià(
NGX_HAVE_ONESIGFD
)

254 ià(
	`fúŽ
(
c
->
fd
, 
F_SETAUXFL
, 
O_ONESIGFD
) == -1) {

255 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

257  
NGX_ERROR
;

261 
c
->
»ad
->
aùive
 = 1;

262 
c
->
wr™e
->
aùive
 = 1;

264  
NGX_OK
;

265 
	}
}

268 
ngx_št_t


269 
	$ngx_¹sig_d–_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
æags
)

271 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

272 "¹sig d– cÚÃùiÚ: fd:%d", 
c
->
fd
);

274 ià((
æags
 & 
NGX_DISABLE_EVENT
è&& 
c
->
»ad
->
acû±
) {

276 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

277 "¹sig di§bË cÚÃùiÚ: fd:%d", 
c
->
fd
);

279 
c
->
»ad
->
aùive
 = 0;

280 
c
->
»ad
->
di§bËd
 = 1;

281  
NGX_OK
;

284 ià(
æags
 & 
NGX_CLOSE_EVENT
) {

285 
c
->
»ad
->
aùive
 = 0;

286 
c
->
wr™e
->
aùive
 = 0;

287  
NGX_OK
;

290 ià(
	`fúŽ
(
c
->
fd
, 
F_SETFL
, 
O_RDWR
|
O_NONBLOCK
) == -1) {

291 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

293  
NGX_ERROR
;

296 
c
->
»ad
->
aùive
 = 0;

297 
c
->
wr™e
->
aùive
 = 0;

299  
NGX_OK
;

300 
	}
}

303 
ngx_št_t


304 
	$ngx_¹sig_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
, 
ngx_ušt_t
 
æags
)

306 
signo
;

307 
ngx_št_t
 
š¡ªû
;

308 
ngx_”r_t
 
”r
;

309 
sigšfo_t
 
si
;

310 
ngx_ev’t_t
 *
»v
, *
wev
;

311 
ngx_queue_t
 *
queue
;

312 
time¥ec
 
ts
, *

;

313 
sigaùiÚ
 
§
;

314 
ngx_cÚÃùiÚ_t
 *
c
;

315 
ngx_¹sig_cÚf_t
 *
¹scf
;

317 ià(
tim”
 =ð
NGX_TIMER_INFINITE
) {

318 

 = 
NULL
;

321 
ts
.
tv_£c
 = 
tim”
 / 1000;

322 
ts
.
tv_n£c
 = (
tim”
 % 1000) * 1000000;

323 

 = &
ts
;

326 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

327 "¹sigim”: %M", 
tim”
);

331 
signo
 = 
	`sigtimedwa™
(&
£t
, &
si
, 

);

333 ià(
signo
 == -1) {

334 
”r
 = 
ngx_”ºo
;

336 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 
”r
,

337 "¹sig signo:%d", 
signo
);

339 ià(
æags
 & 
NGX_UPDATE_TIME
) {

340 
	`ngx_time_upd©e
();

343 ià(
”r
 =ð
NGX_EAGAIN
) {

347 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

348  
NGX_AGAIN
;

351 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

353  
NGX_ERROR
;

356 
	`ngx_log_”rÜ
((
”r
 =ð
NGX_EINTR
è? 
NGX_LOG_INFO
 : 
NGX_LOG_ALERT
,

357 
cyþe
->
log
, 
”r
, "sigtimedwait() failed");

358  
NGX_ERROR
;

361 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

363 
signo
, 
si
.
si_fd
, si.
si_bªd
);

365 ià(
æags
 & 
NGX_UPDATE_TIME
) {

366 
	`ngx_time_upd©e
();

369 
¹scf
 = 
	`ngx_ev’t_g‘_cÚf
(
ngx_cyþe
->
cÚf_ùx
, 
ngx_¹sig_moduË
);

371 ià(
signo
 =ð(è
¹scf
->signo || signo == ()„tscf->signo + 1) {

373 ià(
ov”æow
 && (
ngx_ušt_t
è
si
.
si_fd
 > 
ov”æow_cu¼’t
) {

374  
NGX_OK
;

377 
c
 = 
ngx_cyþe
->
fžes
[
si
.
si_fd
];

379 ià(
c
 =ð
NULL
) {

383  
NGX_OK
;

386 
š¡ªû
 = 
signo
 - (è
¹scf
->signo;

388 
»v
 = 
c
->
»ad
;

390 ià(
»v
->
š¡ªû
 != instance) {

397 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

398 "¹sig: sËƒv’ˆ%p", 
c
);

400  
NGX_OK
;

403 ià((
si
.
si_bªd
 & (
POLLIN
|
POLLHUP
|
POLLERR
)è&& 
»v
->
aùive
) {

405 
»v
->
»ady
 = 1;

407 ià(
æags
 & 
NGX_POST_EVENTS
) {

408 
queue
 = 
»v
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


409 : &
ngx_po¡ed_ev’ts
;

411 
	`ngx_po¡_ev’t
(
»v
, 
queue
);

414 
»v
->
	`hªdËr
(rev);

418 
wev
 = 
c
->
wr™e
;

420 ià((
si
.
si_bªd
 & (
POLLOUT
|
POLLHUP
|
POLLERR
)è&& 
wev
->
aùive
) {

422 
wev
->
»ady
 = 1;

424 ià(
æags
 & 
NGX_POST_EVENTS
) {

425 
	`ngx_po¡_ev’t
(
wev
, &
ngx_po¡ed_ev’ts
);

428 
wev
->
	`hªdËr
(wev);

432  
NGX_OK
;

434 } ià(
signo
 =ð
SIGALRM
) {

436 
	`ngx_time_upd©e
();

438  
NGX_OK
;

440 } ià(
signo
 =ð
SIGIO
) {

442 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

447 
	`ngx_memz”o
(&
§
, (
sigaùiÚ
));

448 
§
.
§_hªdËr
 = 
SIG_DFL
;

449 
	`sigem±y£t
(&
§
.
§_mask
);

451 ià(
	`sigaùiÚ
(
¹scf
->
signo
, &
§
, 
NULL
) == -1) {

452 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

453 "sigaùiÚ(%d, SIG_DFLèçžed", 
¹scf
->
signo
);

456 ià(
	`sigaùiÚ
(
¹scf
->
signo
 + 1, &
§
, 
NULL
) == -1) {

457 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

458 "sigaùiÚ(%d, SIG_DFLèçžed", 
¹scf
->
signo
 + 1);

461 
ov”æow
 = 1;

462 
ov”æow_cu¼’t
 = 0;

463 
ngx_ev’t_aùiÚs
.
´oûss_ev’ts
 = 
ngx_¹sig_´oûss_ov”æow
;

465  
NGX_ERROR
;

469 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

470 "sigtimedwa™(è»tuºed uÃx³ùed sigÇl: %d", 
signo
);

472  
NGX_ERROR
;

473 
	}
}

476 
ngx_št_t


477 
	$ngx_¹sig_´oûss_ov”æow
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

478 
ngx_ušt_t
 
æags
)

480 
Çme
[2], 
¹sig_max
, 
¹sig_Ä
, 
ev’ts
, 
»ady
;

481 
size_t
 
Ën
;

482 
ngx_”r_t
 
”r
;

483 
ngx_ušt_t
 
‹¡ed
, 
n
, 
i
;

484 
ngx_ev’t_t
 *
»v
, *
wev
;

485 
ngx_queue_t
 *
queue
;

486 
ngx_cÚÃùiÚ_t
 *
c
;

487 
ngx_¹sig_cÚf_t
 *
¹scf
;

489 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

492 
¹scf
 = 
	`ngx_ev’t_g‘_cÚf
(
ngx_cyþe
->
cÚf_ùx
, 
ngx_¹sig_moduË
);

494 
‹¡ed
 = 0;

498 
n
 = 0;

499 
n
 < 
¹scf
->
ov”æow_ev’ts
) {

501 ià(
ov”æow_cu¼’t
 =ð
cyþe
->
cÚÃùiÚ_n
) {

505 
c
 = 
cyþe
->
fžes
[
ov”æow_cu¼’t
++];

507 ià(
c
 =ð
NULL
 || c->
fd
 == -1) {

511 
ev’ts
 = 0;

513 ià(
c
->
»ad
->
aùive
 && c->»ad->
hªdËr
) {

514 
ev’ts
 |ð
POLLIN
;

517 ià(
c
->
wr™e
->
aùive
 && c->wr™e->
hªdËr
) {

518 
ev’ts
 |ð
POLLOUT
;

521 ià(
ev’ts
 == 0) {

525 
ov”æow_li¡
[
n
].
fd
 = 
c
->fd;

526 
ov”æow_li¡
[
n
].
ev’ts
 =ƒvents;

527 
ov”æow_li¡
[
n
].
»v’ts
 = 0;

528 
n
++;

531 ià(
n
 == 0) {

536 
»ady
 = 
	`pÞl
(
ov”æow_li¡
, 
n
, 0);

538 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

539 "¹sig ov”æow…Þl:%d", 
»ady
);

541 ià(
»ady
 == -1) {

542 
”r
 = 
ngx_”ºo
;

543 
	`ngx_log_”rÜ
((
”r
 =ð
NGX_EINTR
è? 
NGX_LOG_INFO
 : 
NGX_LOG_ALERT
,

544 
cyþe
->
log
, 0,

547 ià(
”r
 =ð
NGX_EINTR
) {

555 ià(
»ady
 <= 0) {

559 
i
 = 0; i < 
n
; i++) {

560 
c
 = 
cyþe
->
fžes
[
ov”æow_li¡
[
i
].
fd
];

562 ià(
c
 =ð
NULL
) {

566 
»v
 = 
c
->
»ad
;

568 ià(
»v
->
aùive


569 && !
»v
->
þo£d


570 && 
»v
->
hªdËr


571 && (
ov”æow_li¡
[
i
].
»v’ts


572 & (
POLLIN
|
POLLERR
|
POLLHUP
|
POLLNVAL
)))

574 
‹¡ed
++;

576 
»v
->
»ady
 = 1;

578 ià(
æags
 & 
NGX_POST_EVENTS
) {

579 
queue
 = 
»v
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


580 : &
ngx_po¡ed_ev’ts
;

582 
	`ngx_po¡_ev’t
(
»v
, 
queue
);

585 
»v
->
	`hªdËr
(rev);

589 
wev
 = 
c
->
wr™e
;

591 ià(
wev
->
aùive


592 && !
wev
->
þo£d


593 && 
wev
->
hªdËr


594 && (
ov”æow_li¡
[
i
].
»v’ts


595 & (
POLLOUT
|
POLLERR
|
POLLHUP
|
POLLNVAL
)))

597 
‹¡ed
++;

599 
wev
->
»ady
 = 1;

601 ià(
æags
 & 
NGX_POST_EVENTS
) {

602 
	`ngx_po¡_ev’t
(
wev
, &
ngx_po¡ed_ev’ts
);

605 
wev
->
	`hªdËr
(wev);

610 ià(
‹¡ed
 >ð
¹scf
->
ov”æow_‹¡
) {

612 ià(
ngx_lšux_¹sig_max
) {

622 
Çme
[0] = 
CTL_KERN
;

623 
Çme
[1] = 
KERN_RTSIGMAX
;

624 
Ën
 = (
¹sig_max
);

626 ià(
	`sysùl
(
Çme
, 2, &
¹sig_max
, &
Ën
, 
NULL
, 0) == -1) {

627 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”ºo
,

629  
NGX_ERROR
;

633 
Çme
[1] = 
KERN_RTSIGNR
;

634 
Ën
 = (
¹sig_Ä
);

636 ià(
	`sysùl
(
Çme
, 2, &
¹sig_Ä
, &
Ën
, 
NULL
, 0) == -1) {

637 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”ºo
,

639  
NGX_ERROR
;

648 ià(
¹sig_max
 / (è
¹scf
->
ov”æow_th»shÞd
 < 
¹sig_Ä
) {

649 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

651 
¹sig_Ä
, 
¹sig_max
);

652 
	`ngx_¹sig_´oûss_ev’ts
(
cyþe
, 0, 
æags
è=ð
NGX_OK
)

665 
	`ngx_¹sig_´oûss_ev’ts
(
cyþe
, 0, 
æags
è=ð
NGX_OK
) {

670 
‹¡ed
 = 0;

674 ià(
æags
 & 
NGX_UPDATE_TIME
) {

675 
	`ngx_time_upd©e
();

678 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

681 
ov”æow
 = 0;

682 
ngx_ev’t_aùiÚs
.
´oûss_ev’ts
 = 
ngx_¹sig_´oûss_ev’ts
;

684  
NGX_OK
;

685 
	}
}

689 
	$ngx_¹sig_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

691 
ngx_¹sig_cÚf_t
 *
¹scf
;

693 
¹scf
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, (
ngx_¹sig_cÚf_t
));

694 ià(
¹scf
 =ð
NULL
) {

695  
NULL
;

698 
¹scf
->
signo
 = 
NGX_CONF_UNSET
;

699 
¹scf
->
ov”æow_ev’ts
 = 
NGX_CONF_UNSET
;

700 
¹scf
->
ov”æow_‹¡
 = 
NGX_CONF_UNSET
;

701 
¹scf
->
ov”æow_th»shÞd
 = 
NGX_CONF_UNSET
;

703  
¹scf
;

704 
	}
}

708 
	$ngx_¹sig_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

710 
ngx_¹sig_cÚf_t
 *
¹scf
 = 
cÚf
;

713 
	`ngx_cÚf_š™_ušt_v®ue
(
¹scf
->
signo
, 
SIGRTMIN
 + 10);

715 
	`ngx_cÚf_š™_ušt_v®ue
(
¹scf
->
ov”æow_ev’ts
, 16);

716 
	`ngx_cÚf_š™_ušt_v®ue
(
¹scf
->
ov”æow_‹¡
, 32);

717 
	`ngx_cÚf_š™_ušt_v®ue
(
¹scf
->
ov”æow_th»shÞd
, 10);

719  
NGX_CONF_OK
;

720 
	}
}

724 
	$ngx_check_ngx_ov”æow_th»shÞd_bounds
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

726 ià(
ngx_lšux_¹sig_max
) {

727  
	`ngx_cÚf_check_num_bounds
(
cf
, 
po¡
, 
d©a
);

730 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

734  
NGX_CONF_OK
;

735 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_select_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_št_t
 
ngx_£Ëù_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

14 
ngx_£Ëù_dÚe
(
ngx_cyþe_t
 *
cyþe
);

15 
ngx_št_t
 
ngx_£Ëù_add_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

16 
ngx_ušt_t
 
æags
);

17 
ngx_št_t
 
ngx_£Ëù_d–_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

18 
ngx_ušt_t
 
æags
);

19 
ngx_št_t
 
ngx_£Ëù_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

20 
ngx_ušt_t
 
æags
);

21 
ngx_£Ëù_»·œ_fd_£ts
(
ngx_cyþe_t
 *
cyþe
);

22 *
ngx_£Ëù_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

25 
fd_£t
 
	gma¡”_»ad_fd_£t
;

26 
fd_£t
 
	gma¡”_wr™e_fd_£t
;

27 
fd_£t
 
	gwÜk_»ad_fd_£t
;

28 
fd_£t
 
	gwÜk_wr™e_fd_£t
;

30 
ngx_št_t
 
	gmax_fd
;

31 
ngx_ušt_t
 
	gÃv’ts
;

33 
ngx_ev’t_t
 **
	gev’t_šdex
;

36 
ngx_¡r_t
 
	g£Ëù_Çme
 = 
ngx_¡ršg
("select");

38 
ngx_ev’t_moduË_t
 
	gngx_£Ëù_moduË_ùx
 = {

39 &
£Ëù_Çme
,

40 
NULL
,

41 
ngx_£Ëù_š™_cÚf
,

44 
ngx_£Ëù_add_ev’t
,

45 
ngx_£Ëù_d–_ev’t
,

46 
ngx_£Ëù_add_ev’t
,

47 
ngx_£Ëù_d–_ev’t
,

48 
NULL
,

49 
NULL
,

50 
NULL
,

51 
ngx_£Ëù_´oûss_ev’ts
,

52 
ngx_£Ëù_š™
,

53 
ngx_£Ëù_dÚe


58 
ngx_moduË_t
 
	gngx_£Ëù_moduË
 = {

59 
NGX_MODULE_V1
,

60 &
ngx_£Ëù_moduË_ùx
,

61 
NULL
,

62 
NGX_EVENT_MODULE
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
NGX_MODULE_V1_PADDING


74 
ngx_št_t


75 
	$ngx_£Ëù_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

77 
ngx_ev’t_t
 **
šdex
;

79 ià(
ev’t_šdex
 =ð
NULL
) {

80 
	`FD_ZERO
(&
ma¡”_»ad_fd_£t
);

81 
	`FD_ZERO
(&
ma¡”_wr™e_fd_£t
);

82 
Ãv’ts
 = 0;

85 ià(
ngx_´oûss
 >ð
NGX_PROCESS_WORKER


86 || 
cyþe
->
Þd_cyþe
 =ð
NULL


87 || 
cyþe
->
Þd_cyþe
->
cÚÃùiÚ_n
 < cycle->connection_n)

89 
šdex
 = 
	`ngx_®loc
((
ngx_ev’t_t
 *è* 2 * 
cyþe
->
cÚÃùiÚ_n
,

90 
cyþe
->
log
);

91 ià(
šdex
 =ð
NULL
) {

92  
NGX_ERROR
;

95 ià(
ev’t_šdex
) {

96 
	`ngx_memýy
(
šdex
, 
ev’t_šdex
, (
ngx_ev’t_t
 *è* 
Ãv’ts
);

97 
	`ngx_ä“
(
ev’t_šdex
);

100 
ev’t_šdex
 = 
šdex
;

103 
ngx_io
 = 
ngx_os_io
;

105 
ngx_ev’t_aùiÚs
 = 
ngx_£Ëù_moduË_ùx
.
aùiÚs
;

107 
ngx_ev’t_æags
 = 
NGX_USE_LEVEL_EVENT
;

109 
max_fd
 = -1;

111  
NGX_OK
;

112 
	}
}

116 
	$ngx_£Ëù_dÚe
(
ngx_cyþe_t
 *
cyþe
)

118 
	`ngx_ä“
(
ev’t_šdex
);

120 
ev’t_šdex
 = 
NULL
;

121 
	}
}

124 
ngx_št_t


125 
	$ngx_£Ëù_add_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

127 
ngx_cÚÃùiÚ_t
 *
c
;

129 
c
 = 
ev
->
d©a
;

131 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

132 "£Ëù‡ddƒv’ˆfd:%dƒv:%i", 
c
->
fd
, 
ev’t
);

134 ià(
ev
->
šdex
 !ð
NGX_INVALID_INDEX
) {

135 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

136 "£Ëùƒv’ˆfd:%dƒv:%˜i ®»ady s‘", 
c
->
fd
, 
ev’t
);

137  
NGX_OK
;

140 ià((
ev’t
 =ð
NGX_READ_EVENT
 && 
ev
->
wr™e
)

141 || (
ev’t
 =ð
NGX_WRITE_EVENT
 && !
ev
->
wr™e
))

143 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

145 
ev
->
wr™e
 ? "wr™e" : "»ad", 
c
->
fd
, 
ev’t
);

146  
NGX_ERROR
;

149 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

150 
	`FD_SET
(
c
->
fd
, &
ma¡”_»ad_fd_£t
);

152 } ià(
ev’t
 =ð
NGX_WRITE_EVENT
) {

153 
	`FD_SET
(
c
->
fd
, &
ma¡”_wr™e_fd_£t
);

156 ià(
max_fd
 !ð-1 && max_fd < 
c
->
fd
) {

157 
max_fd
 = 
c
->
fd
;

160 
ev
->
aùive
 = 1;

162 
ev’t_šdex
[
Ãv’ts
] = 
ev
;

163 
ev
->
šdex
 = 
Ãv’ts
;

164 
Ãv’ts
++;

166  
NGX_OK
;

167 
	}
}

170 
ngx_št_t


171 
	$ngx_£Ëù_d–_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

173 
ngx_ev’t_t
 *
e
;

174 
ngx_cÚÃùiÚ_t
 *
c
;

176 
c
 = 
ev
->
d©a
;

178 
ev
->
aùive
 = 0;

180 ià(
ev
->
šdex
 =ð
NGX_INVALID_INDEX
) {

181  
NGX_OK
;

184 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

185 "£Ëù d–ƒv’ˆfd:%dƒv:%i", 
c
->
fd
, 
ev’t
);

187 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

188 
	`FD_CLR
(
c
->
fd
, &
ma¡”_»ad_fd_£t
);

190 } ià(
ev’t
 =ð
NGX_WRITE_EVENT
) {

191 
	`FD_CLR
(
c
->
fd
, &
ma¡”_wr™e_fd_£t
);

194 ià(
max_fd
 =ð
c
->
fd
) {

195 
max_fd
 = -1;

198 ià(
ev
->
šdex
 < --
Ãv’ts
) {

199 
e
 = 
ev’t_šdex
[
Ãv’ts
];

200 
ev’t_šdex
[
ev
->
šdex
] = 
e
;

201 
e
->
šdex
 = 
ev
->index;

204 
ev
->
šdex
 = 
NGX_INVALID_INDEX
;

206  
NGX_OK
;

207 
	}
}

210 
ngx_št_t


211 
	$ngx_£Ëù_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

212 
ngx_ušt_t
 
æags
)

214 
»ady
, 
Ä—dy
;

215 
ngx_”r_t
 
”r
;

216 
ngx_ušt_t
 
i
, 
found
;

217 
ngx_ev’t_t
 *
ev
;

218 
ngx_queue_t
 *
queue
;

219 
timev®
 
tv
, *

;

220 
ngx_cÚÃùiÚ_t
 *
c
;

222 ià(
max_fd
 == -1) {

223 
i
 = 0; i < 
Ãv’ts
; i++) {

224 
c
 = 
ev’t_šdex
[
i
]->
d©a
;

225 ià(
max_fd
 < 
c
->
fd
) {

226 
max_fd
 = 
c
->
fd
;

230 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

231 "chªgmax_fd: %i", 
max_fd
);

234 #ià(
NGX_DEBUG
)

235 ià(
cyþe
->
log
->
log_Ëv–
 & 
NGX_LOG_DEBUG_ALL
) {

236 
i
 = 0; i < 
Ãv’ts
; i++) {

237 
ev
 = 
ev’t_šdex
[
i
];

238 
c
 = 
ev
->
d©a
;

239 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

240 "£Ëùƒv’t: fd:%d wr:%d", 
c
->
fd
, 
ev
->
wr™e
);

243 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

244 "max_fd: %i", 
max_fd
);

248 ià(
tim”
 =ð
NGX_TIMER_INFINITE
) {

249 

 = 
NULL
;

252 
tv
.
tv_£c
 = (è(
tim”
 / 1000);

253 
tv
.
tv_u£c
 = (è((
tim”
 % 1000) * 1000);

254 

 = &
tv
;

257 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

258 "£Ëùim”: %M", 
tim”
);

260 
wÜk_»ad_fd_£t
 = 
ma¡”_»ad_fd_£t
;

261 
wÜk_wr™e_fd_£t
 = 
ma¡”_wr™e_fd_£t
;

263 
»ady
 = 
	`£Ëù
(
max_fd
 + 1, &
wÜk_»ad_fd_£t
, &
wÜk_wr™e_fd_£t
, 
NULL
, 

);

265 
”r
 = (
»ady
 =ð-1è? 
ngx_”ºo
 : 0;

267 ià(
æags
 & 
NGX_UPDATE_TIME
 || 
ngx_ev’t_tim”_®¬m
) {

268 
	`ngx_time_upd©e
();

271 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

272 "£Ëù„—dy %d", 
»ady
);

274 ià(
”r
) {

275 
ngx_ušt_t
 
Ëv–
;

277 ià(
”r
 =ð
NGX_EINTR
) {

279 ià(
ngx_ev’t_tim”_®¬m
) {

280 
ngx_ev’t_tim”_®¬m
 = 0;

281  
NGX_OK
;

284 
Ëv–
 = 
NGX_LOG_INFO
;

287 
Ëv–
 = 
NGX_LOG_ALERT
;

290 
	`ngx_log_”rÜ
(
Ëv–
, 
cyþe
->
log
, 
”r
, "select() failed");

292 ià(
”r
 =ð
NGX_EBADF
) {

293 
	`ngx_£Ëù_»·œ_fd_£ts
(
cyþe
);

296  
NGX_ERROR
;

299 ià(
»ady
 == 0) {

300 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

301  
NGX_OK
;

304 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

306  
NGX_ERROR
;

309 
Ä—dy
 = 0;

311 
i
 = 0; i < 
Ãv’ts
; i++) {

312 
ev
 = 
ev’t_šdex
[
i
];

313 
c
 = 
ev
->
d©a
;

314 
found
 = 0;

316 ià(
ev
->
wr™e
) {

317 ià(
	`FD_ISSET
(
c
->
fd
, &
wÜk_wr™e_fd_£t
)) {

318 
found
 = 1;

319 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

320 "£Ëù wr™%d", 
c
->
fd
);

324 ià(
	`FD_ISSET
(
c
->
fd
, &
wÜk_»ad_fd_£t
)) {

325 
found
 = 1;

326 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

327 "£Ëù„—d %d", 
c
->
fd
);

331 ià(
found
) {

332 
ev
->
»ady
 = 1;

334 
queue
 = 
ev
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


335 : &
ngx_po¡ed_ev’ts
;

337 
	`ngx_po¡_ev’t
(
ev
, 
queue
);

339 
Ä—dy
++;

343 ià(
»ady
 !ð
Ä—dy
) {

344 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

345 "£Ëù„—dy !ðev’ts: %d:%d", 
»ady
, 
Ä—dy
);

347 
	`ngx_£Ëù_»·œ_fd_£ts
(
cyþe
);

350  
NGX_OK
;

351 
	}
}

355 
	$ngx_£Ëù_»·œ_fd_£ts
(
ngx_cyþe_t
 *
cyþe
)

357 
n
;

358 
sockËn_t
 
Ën
;

359 
ngx_”r_t
 
”r
;

360 
ngx_sock‘_t
 
s
;

362 
s
 = 0; s <ð
max_fd
; s++) {

364 ià(
	`FD_ISSET
(
s
, &
ma¡”_»ad_fd_£t
) == 0) {

368 
Ën
 = ();

370 ià(
	`g‘sockÝt
(
s
, 
SOL_SOCKET
, 
SO_TYPE
, &
n
, &
Ën
) == -1) {

371 
”r
 = 
ngx_sock‘_”ºo
;

373 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

374 "šv®id desütÜ #%d iÀ»ad fd_£t", 
s
);

376 
	`FD_CLR
(
s
, &
ma¡”_»ad_fd_£t
);

380 
s
 = 0; s <ð
max_fd
; s++) {

382 ià(
	`FD_ISSET
(
s
, &
ma¡”_wr™e_fd_£t
) == 0) {

386 
Ën
 = ();

388 ià(
	`g‘sockÝt
(
s
, 
SOL_SOCKET
, 
SO_TYPE
, &
n
, &
Ën
) == -1) {

389 
”r
 = 
ngx_sock‘_”ºo
;

391 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

392 "šv®id desütÜ #%d iÀwr™fd_£t", 
s
);

394 
	`FD_CLR
(
s
, &
ma¡”_wr™e_fd_£t
);

398 
max_fd
 = -1;

399 
	}
}

403 
	$ngx_£Ëù_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

405 
ngx_ev’t_cÚf_t
 *
ecf
;

407 
ecf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_ev’t_cÜe_moduË
);

409 ià(
ecf
->
u£
 !ð
ngx_£Ëù_moduË
.
ùx_šdex
) {

410  
NGX_CONF_OK
;

415 ià(
cyþe
->
cÚÃùiÚ_n
 > 
FD_SETSIZE
) {

416 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

418 "suµÜ‹d by s–eù(èi %ud", 
FD_SETSIZE
);

419  
NGX_CONF_ERROR
;

422 #ià(
NGX_THREADS
)

424 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

426  
NGX_CONF_ERROR
;

430  
NGX_CONF_OK
;

433 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/modules/ngx_win32_select_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_št_t
 
ngx_£Ëù_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
);

14 
ngx_£Ëù_dÚe
(
ngx_cyþe_t
 *
cyþe
);

15 
ngx_št_t
 
ngx_£Ëù_add_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

16 
ngx_ušt_t
 
æags
);

17 
ngx_št_t
 
ngx_£Ëù_d–_ev’t
(
ngx_ev’t_t
 *
ev
,‚gx_št_ˆ
ev’t
,

18 
ngx_ušt_t
 
æags
);

19 
ngx_št_t
 
ngx_£Ëù_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

20 
ngx_ušt_t
 
æags
);

21 
ngx_£Ëù_»·œ_fd_£ts
(
ngx_cyþe_t
 *
cyþe
);

22 *
ngx_£Ëù_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

25 
fd_£t
 
	gma¡”_»ad_fd_£t
;

26 
fd_£t
 
	gma¡”_wr™e_fd_£t
;

27 
fd_£t
 
	gwÜk_»ad_fd_£t
;

28 
fd_£t
 
	gwÜk_wr™e_fd_£t
;

30 
ngx_ušt_t
 
	gmax_»ad
;

31 
ngx_ušt_t
 
	gmax_wr™e
;

32 
ngx_ušt_t
 
	gÃv’ts
;

34 
ngx_ev’t_t
 **
	gev’t_šdex
;

37 
ngx_¡r_t
 
	g£Ëù_Çme
 = 
ngx_¡ršg
("select");

39 
ngx_ev’t_moduË_t
 
	gngx_£Ëù_moduË_ùx
 = {

40 &
£Ëù_Çme
,

41 
NULL
,

42 
ngx_£Ëù_š™_cÚf
,

45 
ngx_£Ëù_add_ev’t
,

46 
ngx_£Ëù_d–_ev’t
,

47 
ngx_£Ëù_add_ev’t
,

48 
ngx_£Ëù_d–_ev’t
,

49 
NULL
,

50 
NULL
,

51 
NULL
,

52 
ngx_£Ëù_´oûss_ev’ts
,

53 
ngx_£Ëù_š™
,

54 
ngx_£Ëù_dÚe


59 
ngx_moduË_t
 
	gngx_£Ëù_moduË
 = {

60 
NGX_MODULE_V1
,

61 &
ngx_£Ëù_moduË_ùx
,

62 
NULL
,

63 
NGX_EVENT_MODULE
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
NULL
,

71 
NGX_MODULE_V1_PADDING


75 
ngx_št_t


76 
	$ngx_£Ëù_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
)

78 
ngx_ev’t_t
 **
šdex
;

80 ià(
ev’t_šdex
 =ð
NULL
) {

81 
	`FD_ZERO
(&
ma¡”_»ad_fd_£t
);

82 
	`FD_ZERO
(&
ma¡”_wr™e_fd_£t
);

83 
Ãv’ts
 = 0;

86 ià(
ngx_´oûss
 >ð
NGX_PROCESS_WORKER


87 || 
cyþe
->
Þd_cyþe
 =ð
NULL


88 || 
cyþe
->
Þd_cyþe
->
cÚÃùiÚ_n
 < cycle->connection_n)

90 
šdex
 = 
	`ngx_®loc
((
ngx_ev’t_t
 *è* 2 * 
cyþe
->
cÚÃùiÚ_n
,

91 
cyþe
->
log
);

92 ià(
šdex
 =ð
NULL
) {

93  
NGX_ERROR
;

96 ià(
ev’t_šdex
) {

97 
	`ngx_memýy
(
šdex
, 
ev’t_šdex
, (
ngx_ev’t_t
 *è* 
Ãv’ts
);

98 
	`ngx_ä“
(
ev’t_šdex
);

101 
ev’t_šdex
 = 
šdex
;

104 
ngx_io
 = 
ngx_os_io
;

106 
ngx_ev’t_aùiÚs
 = 
ngx_£Ëù_moduË_ùx
.
aùiÚs
;

108 
ngx_ev’t_æags
 = 
NGX_USE_LEVEL_EVENT
;

110 
max_»ad
 = 0;

111 
max_wr™e
 = 0;

113  
NGX_OK
;

114 
	}
}

118 
	$ngx_£Ëù_dÚe
(
ngx_cyþe_t
 *
cyþe
)

120 
	`ngx_ä“
(
ev’t_šdex
);

122 
ev’t_šdex
 = 
NULL
;

123 
	}
}

126 
ngx_št_t


127 
	$ngx_£Ëù_add_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

129 
ngx_cÚÃùiÚ_t
 *
c
;

131 
c
 = 
ev
->
d©a
;

133 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

134 "£Ëù‡ddƒv’ˆfd:%dƒv:%i", 
c
->
fd
, 
ev’t
);

136 ià(
ev
->
šdex
 !ð
NGX_INVALID_INDEX
) {

137 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

138 "£Ëùƒv’ˆfd:%dƒv:%˜i ®»ady s‘", 
c
->
fd
, 
ev’t
);

139  
NGX_OK
;

142 ià((
ev’t
 =ð
NGX_READ_EVENT
 && 
ev
->
wr™e
)

143 || (
ev’t
 =ð
NGX_WRITE_EVENT
 && !
ev
->
wr™e
))

145 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 0,

147 
ev
->
wr™e
 ? "wr™e" : "»ad", 
c
->
fd
, 
ev’t
);

148  
NGX_ERROR
;

151 ià((
ev’t
 =ð
NGX_READ_EVENT
 && 
max_»ad
 >ð
FD_SETSIZE
)

152 || (
ev’t
 =ð
NGX_WRITE_EVENT
 && 
max_wr™e
 >ð
FD_SETSIZE
))

154 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ev
->
log
, 0,

156 "suµÜ‹d by s–eù(èi %d", 
FD_SETSIZE
);

157  
NGX_ERROR
;

160 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

161 
	`FD_SET
(
c
->
fd
, &
ma¡”_»ad_fd_£t
);

162 
max_»ad
++;

164 } ià(
ev’t
 =ð
NGX_WRITE_EVENT
) {

165 
	`FD_SET
(
c
->
fd
, &
ma¡”_wr™e_fd_£t
);

166 
max_wr™e
++;

169 
ev
->
aùive
 = 1;

171 
ev’t_šdex
[
Ãv’ts
] = 
ev
;

172 
ev
->
šdex
 = 
Ãv’ts
;

173 
Ãv’ts
++;

175  
NGX_OK
;

176 
	}
}

179 
ngx_št_t


180 
	$ngx_£Ëù_d–_ev’t
(
ngx_ev’t_t
 *
ev
, 
ngx_št_t
 
ev’t
, 
ngx_ušt_t
 
æags
)

182 
ngx_ev’t_t
 *
e
;

183 
ngx_cÚÃùiÚ_t
 *
c
;

185 
c
 = 
ev
->
d©a
;

187 
ev
->
aùive
 = 0;

189 ià(
ev
->
šdex
 =ð
NGX_INVALID_INDEX
) {

190  
NGX_OK
;

193 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

194 "£Ëù d–ƒv’ˆfd:%dƒv:%i", 
c
->
fd
, 
ev’t
);

196 ià(
ev’t
 =ð
NGX_READ_EVENT
) {

197 
	`FD_CLR
(
c
->
fd
, &
ma¡”_»ad_fd_£t
);

198 
max_»ad
--;

200 } ià(
ev’t
 =ð
NGX_WRITE_EVENT
) {

201 
	`FD_CLR
(
c
->
fd
, &
ma¡”_wr™e_fd_£t
);

202 
max_wr™e
--;

205 ià(
ev
->
šdex
 < --
Ãv’ts
) {

206 
e
 = 
ev’t_šdex
[
Ãv’ts
];

207 
ev’t_šdex
[
ev
->
šdex
] = 
e
;

208 
e
->
šdex
 = 
ev
->index;

211 
ev
->
šdex
 = 
NGX_INVALID_INDEX
;

213  
NGX_OK
;

214 
	}
}

217 
ngx_št_t


218 
	$ngx_£Ëù_´oûss_ev’ts
(
ngx_cyþe_t
 *
cyþe
, 
ngx_m£c_t
 
tim”
,

219 
ngx_ušt_t
 
æags
)

221 
»ady
, 
Ä—dy
;

222 
ngx_”r_t
 
”r
;

223 
ngx_ušt_t
 
i
, 
found
;

224 
ngx_ev’t_t
 *
ev
;

225 
ngx_queue_t
 *
queue
;

226 
timev®
 
tv
, *

;

227 
ngx_cÚÃùiÚ_t
 *
c
;

229 #ià(
NGX_DEBUG
)

230 ià(
cyþe
->
log
->
log_Ëv–
 & 
NGX_LOG_DEBUG_ALL
) {

231 
i
 = 0; i < 
Ãv’ts
; i++) {

232 
ev
 = 
ev’t_šdex
[
i
];

233 
c
 = 
ev
->
d©a
;

234 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

235 "£Ëùƒv’t: fd:%d wr:%d", 
c
->
fd
, 
ev
->
wr™e
);

240 ià(
tim”
 =ð
NGX_TIMER_INFINITE
) {

241 

 = 
NULL
;

244 
tv
.
tv_£c
 = (è(
tim”
 / 1000);

245 
tv
.
tv_u£c
 = (è((
tim”
 % 1000) * 1000);

246 

 = &
tv
;

249 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

250 "£Ëùim”: %M", 
tim”
);

252 
wÜk_»ad_fd_£t
 = 
ma¡”_»ad_fd_£t
;

253 
wÜk_wr™e_fd_£t
 = 
ma¡”_wr™e_fd_£t
;

255 ià(
max_»ad
 || 
max_wr™e
) {

256 
»ady
 = 
	`£Ëù
(0, &
wÜk_»ad_fd_£t
, &
wÜk_wr™e_fd_£t
, 
NULL
, 

);

266 
	`ngx_m¦“p
(
tim”
);

268 
»ady
 = 0;

271 
”r
 = (
»ady
 =ð-1è? 
ngx_sock‘_”ºo
 : 0;

273 ià(
æags
 & 
NGX_UPDATE_TIME
) {

274 
	`ngx_time_upd©e
();

277 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

278 "£Ëù„—dy %d", 
»ady
);

280 ià(
”r
) {

281 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
, "select() failed");

283 ià(
”r
 =ð
WSAENOTSOCK
) {

284 
	`ngx_£Ëù_»·œ_fd_£ts
(
cyþe
);

287  
NGX_ERROR
;

290 ià(
»ady
 == 0) {

291 ià(
tim”
 !ð
NGX_TIMER_INFINITE
) {

292  
NGX_OK
;

295 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

297  
NGX_ERROR
;

300 
Ä—dy
 = 0;

302 
i
 = 0; i < 
Ãv’ts
; i++) {

303 
ev
 = 
ev’t_šdex
[
i
];

304 
c
 = 
ev
->
d©a
;

305 
found
 = 0;

307 ià(
ev
->
wr™e
) {

308 ià(
	`FD_ISSET
(
c
->
fd
, &
wÜk_wr™e_fd_£t
)) {

309 
found
 = 1;

310 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

311 "£Ëù wr™%d", 
c
->
fd
);

315 ià(
	`FD_ISSET
(
c
->
fd
, &
wÜk_»ad_fd_£t
)) {

316 
found
 = 1;

317 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

318 "£Ëù„—d %d", 
c
->
fd
);

322 ià(
found
) {

323 
ev
->
»ady
 = 1;

325 
queue
 = 
ev
->
acû±
 ? &
ngx_po¡ed_acû±_ev’ts


326 : &
ngx_po¡ed_ev’ts
;

328 
	`ngx_po¡_ev’t
(
ev
, 
queue
);

330 
Ä—dy
++;

334 ià(
»ady
 !ð
Ä—dy
) {

335 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

336 "£Ëù„—dy !ðev’ts: %d:%d", 
»ady
, 
Ä—dy
);

338 
	`ngx_£Ëù_»·œ_fd_£ts
(
cyþe
);

341  
NGX_OK
;

342 
	}
}

346 
	$ngx_£Ëù_»·œ_fd_£ts
(
ngx_cyþe_t
 *
cyþe
)

348 
n
;

349 
u_št
 
i
;

350 
sockËn_t
 
Ën
;

351 
ngx_”r_t
 
”r
;

352 
ngx_sock‘_t
 
s
;

354 
i
 = 0; i < 
ma¡”_»ad_fd_£t
.
fd_couÁ
; i++) {

356 
s
 = 
ma¡”_»ad_fd_£t
.
fd_¬¿y
[
i
];

357 
Ën
 = ();

359 ià(
	`g‘sockÝt
(
s
, 
SOL_SOCKET
, 
SO_TYPE
, (*è&
n
, &
Ën
) == -1) {

360 
”r
 = 
ngx_sock‘_”ºo
;

362 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

363 "šv®id desütÜ #%d iÀ»ad fd_£t", 
s
);

365 
	`FD_CLR
(
s
, &
ma¡”_»ad_fd_£t
);

369 
i
 = 0; i < 
ma¡”_wr™e_fd_£t
.
fd_couÁ
; i++) {

371 
s
 = 
ma¡”_wr™e_fd_£t
.
fd_¬¿y
[
i
];

372 
Ën
 = ();

374 ià(
	`g‘sockÝt
(
s
, 
SOL_SOCKET
, 
SO_TYPE
, (*è&
n
, &
Ën
) == -1) {

375 
”r
 = 
ngx_sock‘_”ºo
;

377 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

378 "šv®id desütÜ #%d iÀwr™fd_£t", 
s
);

380 
	`FD_CLR
(
s
, &
ma¡”_wr™e_fd_£t
);

383 
	}
}

387 
	$ngx_£Ëù_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

389 
ngx_ev’t_cÚf_t
 *
ecf
;

391 
ecf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_ev’t_cÜe_moduË
);

393 ià(
ecf
->
u£
 !ð
ngx_£Ëù_moduË
.
ùx_šdex
) {

394  
NGX_CONF_OK
;

397  
NGX_CONF_OK
;

398 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
	#DEFAULT_CONNECTIONS
 512

	)

16 
ngx_moduË_t
 
ngx_kqueue_moduË
;

17 
ngx_moduË_t
 
ngx_ev’Üt_moduË
;

18 
ngx_moduË_t
 
ngx_devpÞl_moduË
;

19 
ngx_moduË_t
 
ngx_•Þl_moduË
;

20 
ngx_moduË_t
 
ngx_¹sig_moduË
;

21 
ngx_moduË_t
 
ngx_£Ëù_moduË
;

24 *
ngx_ev’t_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

25 
ngx_št_t
 
ngx_ev’t_moduË_š™
(
ngx_cyþe_t
 *
cyþe
);

26 
ngx_št_t
 
ngx_ev’t_´oûss_š™
(
ngx_cyþe_t
 *
cyþe
);

27 *
ngx_ev’ts_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

29 *
ngx_ev’t_cÚÃùiÚs
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

30 *
cÚf
);

31 *
ngx_ev’t_u£
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

32 *
ngx_ev’t_debug_cÚÃùiÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

33 *
cÚf
);

35 *
ngx_ev’t_cÜe_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

36 *
ngx_ev’t_cÜe_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
);

39 
ngx_ušt_t
 
	gngx_tim”_»sÞutiÚ
;

40 
sig_©omic_t
 
	gngx_ev’t_tim”_®¬m
;

42 
ngx_ušt_t
 
	gngx_ev’t_max_moduË
;

44 
ngx_ušt_t
 
	gngx_ev’t_æags
;

45 
ngx_ev’t_aùiÚs_t
 
	gngx_ev’t_aùiÚs
;

48 
ngx_©omic_t
 
	gcÚÃùiÚ_couÁ”
 = 1;

49 
ngx_©omic_t
 *
	gngx_cÚÃùiÚ_couÁ”
 = &
cÚÃùiÚ_couÁ”
;

52 
ngx_©omic_t
 *
	gngx_acû±_mu‹x_±r
;

53 
ngx_shmtx_t
 
	gngx_acû±_mu‹x
;

54 
ngx_ušt_t
 
	gngx_u£_acû±_mu‹x
;

55 
ngx_ušt_t
 
	gngx_acû±_ev’ts
;

56 
ngx_ušt_t
 
	gngx_acû±_mu‹x_h–d
;

57 
ngx_m£c_t
 
	gngx_acû±_mu‹x_d–ay
;

58 
ngx_št_t
 
	gngx_acû±_di§bËd
;

61 #ià(
NGX_STAT_STUB
)

63 
ngx_©omic_t
 
	gngx_¡©_acû±ed0
;

64 
ngx_©omic_t
 *
	gngx_¡©_acû±ed
 = &
ngx_¡©_acû±ed0
;

65 
ngx_©omic_t
 
	gngx_¡©_hªdËd0
;

66 
ngx_©omic_t
 *
	gngx_¡©_hªdËd
 = &
ngx_¡©_hªdËd0
;

67 
ngx_©omic_t
 
	gngx_¡©_»que¡s0
;

68 
ngx_©omic_t
 *
	gngx_¡©_»que¡s
 = &
ngx_¡©_»que¡s0
;

69 
ngx_©omic_t
 
	gngx_¡©_aùive0
;

70 
ngx_©omic_t
 *
	gngx_¡©_aùive
 = &
ngx_¡©_aùive0
;

71 
ngx_©omic_t
 
	gngx_¡©_»adšg0
;

72 
ngx_©omic_t
 *
	gngx_¡©_»adšg
 = &
ngx_¡©_»adšg0
;

73 
ngx_©omic_t
 
	gngx_¡©_wr™šg0
;

74 
ngx_©omic_t
 *
	gngx_¡©_wr™šg
 = &
ngx_¡©_wr™šg0
;

75 
ngx_©omic_t
 
	gngx_¡©_wa™šg0
;

76 
ngx_©omic_t
 *
	gngx_¡©_wa™šg
 = &
ngx_¡©_wa™šg0
;

82 
ngx_commªd_t
 
	gngx_ev’ts_commªds
[] = {

84 { 
ngx_¡ršg
("events"),

85 
NGX_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

86 
ngx_ev’ts_block
,

89 
NULL
 },

91 
ngx_nuÎ_commªd


95 
ngx_cÜe_moduË_t
 
	gngx_ev’ts_moduË_ùx
 = {

96 
ngx_¡ršg
("events"),

97 
NULL
,

98 
ngx_ev’t_š™_cÚf


102 
ngx_moduË_t
 
	gngx_ev’ts_moduË
 = {

103 
NGX_MODULE_V1
,

104 &
ngx_ev’ts_moduË_ùx
,

105 
ngx_ev’ts_commªds
,

106 
NGX_CORE_MODULE
,

107 
NULL
,

108 
NULL
,

109 
NULL
,

110 
NULL
,

111 
NULL
,

112 
NULL
,

113 
NULL
,

114 
NGX_MODULE_V1_PADDING


118 
ngx_¡r_t
 
	gev’t_cÜe_Çme
 = 
ngx_¡ršg
("event_core");

121 
ngx_commªd_t
 
	gngx_ev’t_cÜe_commªds
[] = {

123 { 
ngx_¡ršg
("worker_connections"),

124 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

125 
ngx_ev’t_cÚÃùiÚs
,

128 
NULL
 },

130 { 
ngx_¡ršg
("connections"),

131 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

132 
ngx_ev’t_cÚÃùiÚs
,

135 
NULL
 },

137 { 
ngx_¡ršg
("use"),

138 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

139 
ngx_ev’t_u£
,

142 
NULL
 },

144 { 
ngx_¡ršg
("multi_accept"),

145 
NGX_EVENT_CONF
|
NGX_CONF_FLAG
,

146 
ngx_cÚf_£t_æag_¦Ù
,

148 
off£tof
(
ngx_ev’t_cÚf_t
, 
muÉi_acû±
),

149 
NULL
 },

151 { 
ngx_¡ršg
("accept_mutex"),

152 
NGX_EVENT_CONF
|
NGX_CONF_FLAG
,

153 
ngx_cÚf_£t_æag_¦Ù
,

155 
off£tof
(
ngx_ev’t_cÚf_t
, 
acû±_mu‹x
),

156 
NULL
 },

158 { 
ngx_¡ršg
("accept_mutex_delay"),

159 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

160 
ngx_cÚf_£t_m£c_¦Ù
,

162 
off£tof
(
ngx_ev’t_cÚf_t
, 
acû±_mu‹x_d–ay
),

163 
NULL
 },

165 { 
ngx_¡ršg
("debug_connection"),

166 
NGX_EVENT_CONF
|
NGX_CONF_TAKE1
,

167 
ngx_ev’t_debug_cÚÃùiÚ
,

170 
NULL
 },

172 
ngx_nuÎ_commªd


176 
ngx_ev’t_moduË_t
 
	gngx_ev’t_cÜe_moduË_ùx
 = {

177 &
ev’t_cÜe_Çme
,

178 
ngx_ev’t_cÜe_ü—‹_cÚf
,

179 
ngx_ev’t_cÜe_š™_cÚf
,

181 { 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL }

185 
ngx_moduË_t
 
	gngx_ev’t_cÜe_moduË
 = {

186 
NGX_MODULE_V1
,

187 &
ngx_ev’t_cÜe_moduË_ùx
,

188 
ngx_ev’t_cÜe_commªds
,

189 
NGX_EVENT_MODULE
,

190 
NULL
,

191 
ngx_ev’t_moduË_š™
,

192 
ngx_ev’t_´oûss_š™
,

193 
NULL
,

194 
NULL
,

195 
NULL
,

196 
NULL
,

197 
NGX_MODULE_V1_PADDING


202 
	$ngx_´oûss_ev’ts_ªd_tim”s
(
ngx_cyþe_t
 *
cyþe
)

204 
ngx_ušt_t
 
æags
;

205 
ngx_m£c_t
 
tim”
, 
d–
;

207 ià(
ngx_tim”_»sÞutiÚ
) {

208 
tim”
 = 
NGX_TIMER_INFINITE
;

209 
æags
 = 0;

212 
tim”
 = 
	`ngx_ev’t_fšd_tim”
();

213 
æags
 = 
NGX_UPDATE_TIME
;

215 #ià(
NGX_THREADS
)

217 ià(
tim”
 =ð
NGX_TIMER_INFINITE
 ||imer > 500) {

218 
tim”
 = 500;

224 ià(
ngx_u£_acû±_mu‹x
) {

225 ià(
ngx_acû±_di§bËd
 > 0) {

226 
ngx_acû±_di§bËd
--;

229 ià(
	`ngx_Œylock_acû±_mu‹x
(
cyþe
è=ð
NGX_ERROR
) {

233 ià(
ngx_acû±_mu‹x_h–d
) {

234 
æags
 |ð
NGX_POST_EVENTS
;

237 ià(
tim”
 =ð
NGX_TIMER_INFINITE


238 || 
tim”
 > 
ngx_acû±_mu‹x_d–ay
)

240 
tim”
 = 
ngx_acû±_mu‹x_d–ay
;

246 
d–
 = 
ngx_cu¼’t_m£c
;

248 (è
	`ngx_´oûss_ev’ts
(
cyþe
, 
tim”
, 
æags
);

250 
d–
 = 
ngx_cu¼’t_m£c
 - delta;

252 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

253 "tim” d–: %M", 
d–
);

255 
	`ngx_ev’t_´oûss_po¡ed
(
cyþe
, &
ngx_po¡ed_acû±_ev’ts
);

257 ià(
ngx_acû±_mu‹x_h–d
) {

258 
	`ngx_shmtx_uÆock
(&
ngx_acû±_mu‹x
);

261 ià(
d–
) {

262 
	`ngx_ev’t_expœe_tim”s
();

265 
	`ngx_ev’t_´oûss_po¡ed
(
cyþe
, &
ngx_po¡ed_ev’ts
);

266 
	}
}

269 
ngx_št_t


270 
	$ngx_hªdË_»ad_ev’t
(
ngx_ev’t_t
 *
»v
, 
ngx_ušt_t
 
æags
)

272 ià(
ngx_ev’t_æags
 & 
NGX_USE_CLEAR_EVENT
) {

276 ià(!
»v
->
aùive
 && !»v->
»ady
) {

277 ià(
	`ngx_add_ev’t
(
»v
, 
NGX_READ_EVENT
, 
NGX_CLEAR_EVENT
)

278 =ð
NGX_ERROR
)

280  
NGX_ERROR
;

284  
NGX_OK
;

286 } ià(
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT
) {

290 ià(!
»v
->
aùive
 && !»v->
»ady
) {

291 ià(
	`ngx_add_ev’t
(
»v
, 
NGX_READ_EVENT
, 
NGX_LEVEL_EVENT
)

292 =ð
NGX_ERROR
)

294  
NGX_ERROR
;

297  
NGX_OK
;

300 ià(
»v
->
aùive
 && (»v->
»ady
 || (
æags
 & 
NGX_CLOSE_EVENT
))) {

301 ià(
	`ngx_d–_ev’t
(
»v
, 
NGX_READ_EVENT
, 
NGX_LEVEL_EVENT
 | 
æags
)

302 =ð
NGX_ERROR
)

304  
NGX_ERROR
;

307  
NGX_OK
;

310 } ià(
ngx_ev’t_æags
 & 
NGX_USE_EVENTPORT_EVENT
) {

314 ià(!
»v
->
aùive
 && !»v->
»ady
) {

315 ià(
	`ngx_add_ev’t
(
»v
, 
NGX_READ_EVENT
, 0è=ð
NGX_ERROR
) {

316  
NGX_ERROR
;

319  
NGX_OK
;

322 ià(
»v
->
ÚeshÙ
 && !»v->
»ady
) {

323 ià(
	`ngx_d–_ev’t
(
»v
, 
NGX_READ_EVENT
, 0è=ð
NGX_ERROR
) {

324  
NGX_ERROR
;

327  
NGX_OK
;

333  
NGX_OK
;

334 
	}
}

337 
ngx_št_t


338 
	$ngx_hªdË_wr™e_ev’t
(
ngx_ev’t_t
 *
wev
, 
size_t
 
low©
)

340 
ngx_cÚÃùiÚ_t
 *
c
;

342 ià(
low©
) {

343 
c
 = 
wev
->
d©a
;

345 ià(
	`ngx_£nd_low©
(
c
, 
low©
è=ð
NGX_ERROR
) {

346  
NGX_ERROR
;

350 ià(
ngx_ev’t_æags
 & 
NGX_USE_CLEAR_EVENT
) {

354 ià(!
wev
->
aùive
 && !wev->
»ady
) {

355 ià(
	`ngx_add_ev’t
(
wev
, 
NGX_WRITE_EVENT
,

356 
NGX_CLEAR_EVENT
 | (
low©
 ? 
NGX_LOWAT_EVENT
 : 0))

357 =ð
NGX_ERROR
)

359  
NGX_ERROR
;

363  
NGX_OK
;

365 } ià(
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT
) {

369 ià(!
wev
->
aùive
 && !wev->
»ady
) {

370 ià(
	`ngx_add_ev’t
(
wev
, 
NGX_WRITE_EVENT
, 
NGX_LEVEL_EVENT
)

371 =ð
NGX_ERROR
)

373  
NGX_ERROR
;

376  
NGX_OK
;

379 ià(
wev
->
aùive
 && wev->
»ady
) {

380 ià(
	`ngx_d–_ev’t
(
wev
, 
NGX_WRITE_EVENT
, 
NGX_LEVEL_EVENT
)

381 =ð
NGX_ERROR
)

383  
NGX_ERROR
;

386  
NGX_OK
;

389 } ià(
ngx_ev’t_æags
 & 
NGX_USE_EVENTPORT_EVENT
) {

393 ià(!
wev
->
aùive
 && !wev->
»ady
) {

394 ià(
	`ngx_add_ev’t
(
wev
, 
NGX_WRITE_EVENT
, 0è=ð
NGX_ERROR
) {

395  
NGX_ERROR
;

398  
NGX_OK
;

401 ià(
wev
->
ÚeshÙ
 && wev->
»ady
) {

402 ià(
	`ngx_d–_ev’t
(
wev
, 
NGX_WRITE_EVENT
, 0è=ð
NGX_ERROR
) {

403  
NGX_ERROR
;

406  
NGX_OK
;

412  
NGX_OK
;

413 
	}
}

417 
	$ngx_ev’t_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

419 ià(
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_ev’ts_moduË
è=ð
NULL
) {

420 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

422  
NGX_CONF_ERROR
;

425  
NGX_CONF_OK
;

426 
	}
}

429 
ngx_št_t


430 
	$ngx_ev’t_moduË_š™
(
ngx_cyþe_t
 *
cyþe
)

432 ***
cf
;

433 
u_ch¬
 *
sh¬ed
;

434 
size_t
 
size
, 
þ
;

435 
ngx_shm_t
 
shm
;

436 
ngx_time_t
 *

;

437 
ngx_cÜe_cÚf_t
 *
ccf
;

438 
ngx_ev’t_cÚf_t
 *
ecf
;

440 
cf
 = 
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_ev’ts_moduË
);

441 
ecf
 = (*
cf
)[
ngx_ev’t_cÜe_moduË
.
ùx_šdex
];

443 ià(!
ngx_‹¡_cÚfig
 && 
ngx_´oûss
 <ð
NGX_PROCESS_MASTER
) {

444 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0,

445 "usšgh\"%s\"ƒv’ˆm‘hod", 
ecf
->
Çme
);

448 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

450 
ngx_tim”_»sÞutiÚ
 = 
ccf
->
tim”_»sÞutiÚ
;

452 #ià!(
NGX_WIN32
)

454 
ngx_št_t
 
lim™
;

455 
¾im™
 
¾mt
;

457 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾mt
) == -1) {

458 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

462 ià(
ecf
->
cÚÃùiÚs
 > (
ngx_ušt_t
è
¾mt
.
¾im_cur


463 && (
ccf
->
¾im™_nofže
 =ð
NGX_CONF_UNSET


464 || 
ecf
->
cÚÃùiÚs
 > (
ngx_ušt_t
è
ccf
->
¾im™_nofže
))

466 
lim™
 = (
ccf
->
¾im™_nofže
 =ð
NGX_CONF_UNSET
) ?

467 (
ngx_št_t
è
¾mt
.
¾im_cur
 : 
ccf
->
¾im™_nofže
;

469 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
cyþe
->
log
, 0,

472 
ecf
->
cÚÃùiÚs
, 
lim™
);

479 ià(
ccf
->
ma¡”
 == 0) {

480  
NGX_OK
;

483 ià(
ngx_acû±_mu‹x_±r
) {

484  
NGX_OK
;

490 
þ
 = 128;

492 
size
 = 
þ


493 + 
þ


494 + 
þ
;

496 #ià(
NGX_STAT_STUB
)

498 
size
 +ð
þ


499 + 
þ


500 + 
þ


501 + 
þ


502 + 
þ


503 + 
þ


504 + 
þ
;

508 
shm
.
size
 = size;

509 
shm
.
Çme
.
Ën
 = ("nginx_shared_zone");

510 
shm
.
Çme
.
d©a
 = (
u_ch¬
 *) "nginx_shared_zone";

511 
shm
.
log
 = 
cyþe
->log;

513 ià(
	`ngx_shm_®loc
(&
shm
è!ð
NGX_OK
) {

514  
NGX_ERROR
;

517 
sh¬ed
 = 
shm
.
addr
;

519 
ngx_acû±_mu‹x_±r
 = (
ngx_©omic_t
 *è
sh¬ed
;

520 
ngx_acû±_mu‹x
.
¥š
 = (
ngx_ušt_t
) -1;

522 ià(
	`ngx_shmtx_ü—‹
(&
ngx_acû±_mu‹x
, (
ngx_shmtx_sh_t
 *è
sh¬ed
,

523 
cyþe
->
lock_fže
.
d©a
)

524 !ð
NGX_OK
)

526  
NGX_ERROR
;

529 
ngx_cÚÃùiÚ_couÁ”
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 1 * 
þ
);

531 (è
	`ngx_©omic_cmp_£t
(
ngx_cÚÃùiÚ_couÁ”
, 0, 1);

533 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

535 
ngx_cÚÃùiÚ_couÁ”
, *ngx_connection_counter);

537 
ngx_‹mp_numb”
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 2 * 
þ
);

539 

 = 
	`ngx_timeofday
();

541 
ngx_¿ndom_numb”
 = (

->
m£c
 << 16è+ 
ngx_pid
;

543 #ià(
NGX_STAT_STUB
)

545 
ngx_¡©_acû±ed
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 3 * 
þ
);

546 
ngx_¡©_hªdËd
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 4 * 
þ
);

547 
ngx_¡©_»que¡s
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 5 * 
þ
);

548 
ngx_¡©_aùive
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 6 * 
þ
);

549 
ngx_¡©_»adšg
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 7 * 
þ
);

550 
ngx_¡©_wr™šg
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 8 * 
þ
);

551 
ngx_¡©_wa™šg
 = (
ngx_©omic_t
 *è(
sh¬ed
 + 9 * 
þ
);

555  
NGX_OK
;

556 
	}
}

559 #ià!(
NGX_WIN32
)

562 
	$ngx_tim”_sigÇl_hªdËr
(
signo
)

564 
ngx_ev’t_tim”_®¬m
 = 1;

567 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ngx_cyþe
->
log
, 0, "timer signal");

569 
	}
}

574 
ngx_št_t


575 
	$ngx_ev’t_´oûss_š™
(
ngx_cyþe_t
 *
cyþe
)

577 
ngx_ušt_t
 
m
, 
i
;

578 
ngx_ev’t_t
 *
»v
, *
wev
;

579 
ngx_li¡’šg_t
 *
ls
;

580 
ngx_cÚÃùiÚ_t
 *
c
, *
Ãxt
, *
Þd
;

581 
ngx_cÜe_cÚf_t
 *
ccf
;

582 
ngx_ev’t_cÚf_t
 *
ecf
;

583 
ngx_ev’t_moduË_t
 *
moduË
;

585 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

586 
ecf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_ev’t_cÜe_moduË
);

588 ià(
ccf
->
ma¡”
 && ccf->
wÜk”_´oûs£s
 > 1 && 
ecf
->
acû±_mu‹x
) {

589 
ngx_u£_acû±_mu‹x
 = 1;

590 
ngx_acû±_mu‹x_h–d
 = 0;

591 
ngx_acû±_mu‹x_d–ay
 = 
ecf
->
acû±_mu‹x_d–ay
;

594 
ngx_u£_acû±_mu‹x
 = 0;

597 #ià(
NGX_WIN32
)

604 
ngx_u£_acû±_mu‹x
 = 0;

608 
	`ngx_queue_š™
(&
ngx_po¡ed_acû±_ev’ts
);

609 
	`ngx_queue_š™
(&
ngx_po¡ed_ev’ts
);

611 ià(
	`ngx_ev’t_tim”_š™
(
cyþe
->
log
è=ð
NGX_ERROR
) {

612  
NGX_ERROR
;

615 
m
 = 0; 
ngx_moduËs
[m]; m++) {

616 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_EVENT_MODULE
) {

620 ià(
ngx_moduËs
[
m
]->
ùx_šdex
 !ð
ecf
->
u£
) {

624 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

626 ià(
moduË
->
aùiÚs
.
	`š™
(
cyþe
, 
ngx_tim”_»sÞutiÚ
è!ð
NGX_OK
) {

628 
	`ex™
(2);

634 #ià!(
NGX_WIN32
)

636 ià(
ngx_tim”_»sÞutiÚ
 && !(
ngx_ev’t_æags
 & 
NGX_USE_TIMER_EVENT
)) {

637 
sigaùiÚ
 
§
;

638 
™im”v®
 
™v
;

640 
	`ngx_memz”o
(&
§
, (
sigaùiÚ
));

641 
§
.
§_hªdËr
 = 
ngx_tim”_sigÇl_hªdËr
;

642 
	`sigem±y£t
(&
§
.
§_mask
);

644 ià(
	`sigaùiÚ
(
SIGALRM
, &
§
, 
NULL
) == -1) {

645 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

647  
NGX_ERROR
;

650 
™v
.
™_š‹rv®
.
tv_£c
 = 
ngx_tim”_»sÞutiÚ
 / 1000;

651 
™v
.
™_š‹rv®
.
tv_u£c
 = (
ngx_tim”_»sÞutiÚ
 % 1000) * 1000;

652 
™v
.
™_v®ue
.
tv_£c
 = 
ngx_tim”_»sÞutiÚ
 / 1000;

653 
™v
.
™_v®ue
.
tv_u£c
 = (
ngx_tim”_»sÞutiÚ
 % 1000 ) * 1000;

655 ià(
	`£t™im”
(
ITIMER_REAL
, &
™v
, 
NULL
) == -1) {

656 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

661 ià(
ngx_ev’t_æags
 & 
NGX_USE_FD_EVENT
) {

662 
¾im™
 
¾mt
;

664 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾mt
) == -1) {

665 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

667  
NGX_ERROR
;

670 
cyþe
->
fžes_n
 = (
ngx_ušt_t
è
¾mt
.
¾im_cur
;

672 
cyþe
->
fžes
 = 
	`ngx_ÿÎoc
((
ngx_cÚÃùiÚ_t
 *è* cyþe->
fžes_n
,

673 
cyþe
->
log
);

674 ià(
cyþe
->
fžes
 =ð
NULL
) {

675  
NGX_ERROR
;

681 
cyþe
->
cÚÃùiÚs
 =

682 
	`ngx_®loc
((
ngx_cÚÃùiÚ_t
è* 
cyþe
->
cÚÃùiÚ_n
, cyþe->
log
);

683 ià(
cyþe
->
cÚÃùiÚs
 =ð
NULL
) {

684  
NGX_ERROR
;

687 
c
 = 
cyþe
->
cÚÃùiÚs
;

689 
cyþe
->
»ad_ev’ts
 = 
	`ngx_®loc
((
ngx_ev’t_t
è* cyþe->
cÚÃùiÚ_n
,

690 
cyþe
->
log
);

691 ià(
cyþe
->
»ad_ev’ts
 =ð
NULL
) {

692  
NGX_ERROR
;

695 
»v
 = 
cyþe
->
»ad_ev’ts
;

696 
i
 = 0; i < 
cyþe
->
cÚÃùiÚ_n
; i++) {

697 
»v
[
i
].
þo£d
 = 1;

698 
»v
[
i
].
š¡ªû
 = 1;

701 
cyþe
->
wr™e_ev’ts
 = 
	`ngx_®loc
((
ngx_ev’t_t
è* cyþe->
cÚÃùiÚ_n
,

702 
cyþe
->
log
);

703 ià(
cyþe
->
wr™e_ev’ts
 =ð
NULL
) {

704  
NGX_ERROR
;

707 
wev
 = 
cyþe
->
wr™e_ev’ts
;

708 
i
 = 0; i < 
cyþe
->
cÚÃùiÚ_n
; i++) {

709 
wev
[
i
].
þo£d
 = 1;

712 
i
 = 
cyþe
->
cÚÃùiÚ_n
;

713 
Ãxt
 = 
NULL
;

716 
i
--;

718 
c
[
i
].
d©a
 = 
Ãxt
;

719 
c
[
i
].
»ad
 = &
cyþe
->
»ad_ev’ts
[i];

720 
c
[
i
].
wr™e
 = &
cyþe
->
wr™e_ev’ts
[i];

721 
c
[
i
].
fd
 = (
ngx_sock‘_t
) -1;

723 
Ãxt
 = &
c
[
i
];

725 #ià(
NGX_THREADS
)

726 
c
[
i
].
lock
 = 0;

728 } 
i
);

730 
cyþe
->
ä“_cÚÃùiÚs
 = 
Ãxt
;

731 
cyþe
->
ä“_cÚÃùiÚ_n
 = cyþe->
cÚÃùiÚ_n
;

735 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

736 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

738 
c
 = 
	`ngx_g‘_cÚÃùiÚ
(
ls
[
i
].
fd
, 
cyþe
->
log
);

740 ià(
c
 =ð
NULL
) {

741  
NGX_ERROR
;

744 
c
->
log
 = &
ls
[
i
].log;

746 
c
->
li¡’šg
 = &
ls
[
i
];

747 
ls
[
i
].
cÚÃùiÚ
 = 
c
;

749 
»v
 = 
c
->
»ad
;

751 
»v
->
log
 = 
c
->log;

752 
»v
->
acû±
 = 1;

754 #ià(
NGX_HAVE_DEFERRED_ACCEPT
)

755 
»v
->
deã¼ed_acû±
 = 
ls
[
i
].deferred_accept;

758 ià(!(
ngx_ev’t_æags
 & 
NGX_USE_IOCP_EVENT
)) {

759 ià(
ls
[
i
].
´evious
) {

766 
Þd
 = 
ls
[
i
].
´evious
->
cÚÃùiÚ
;

768 ià(
	`ngx_d–_ev’t
(
Þd
->
»ad
, 
NGX_READ_EVENT
, 
NGX_CLOSE_EVENT
)

769 =ð
NGX_ERROR
)

771  
NGX_ERROR
;

774 
Þd
->
fd
 = (
ngx_sock‘_t
) -1;

778 #ià(
NGX_WIN32
)

780 ià(
ngx_ev’t_æags
 & 
NGX_USE_IOCP_EVENT
) {

781 
ngx_ioý_cÚf_t
 *
ioýcf
;

783 
»v
->
hªdËr
 = 
ngx_ev’t_acû±ex
;

785 ià(
ngx_u£_acû±_mu‹x
) {

789 ià(
	`ngx_add_ev’t
(
»v
, 0, 
NGX_IOCP_ACCEPT
è=ð
NGX_ERROR
) {

790  
NGX_ERROR
;

793 
ls
[
i
].
log
.
hªdËr
 = 
ngx_acû±ex_log_”rÜ
;

795 
ioýcf
 = 
	`ngx_ev’t_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_ioý_moduË
);

796 ià(
	`ngx_ev’t_po¡_acû±ex
(&
ls
[
i
], 
ioýcf
->
po¡_acû±ex
)

797 =ð
NGX_ERROR
)

799  
NGX_ERROR
;

803 
»v
->
hªdËr
 = 
ngx_ev’t_acû±
;

805 ià(
ngx_u£_acû±_mu‹x
) {

809 ià(
	`ngx_add_ev’t
(
»v
, 
NGX_READ_EVENT
, 0è=ð
NGX_ERROR
) {

810  
NGX_ERROR
;

816 
»v
->
hªdËr
 = 
ngx_ev’t_acû±
;

818 ià(
ngx_u£_acû±_mu‹x
) {

822 ià(
ngx_ev’t_æags
 & 
NGX_USE_RTSIG_EVENT
) {

823 ià(
	`ngx_add_cÚn
(
c
è=ð
NGX_ERROR
) {

824  
NGX_ERROR
;

828 ià(
	`ngx_add_ev’t
(
»v
, 
NGX_READ_EVENT
, 0è=ð
NGX_ERROR
) {

829  
NGX_ERROR
;

837  
NGX_OK
;

838 
	}
}

841 
ngx_št_t


842 
	$ngx_£nd_low©
(
ngx_cÚÃùiÚ_t
 *
c
, 
size_t
 
low©
)

844 
¢dlow©
;

846 #ià(
NGX_HAVE_LOWAT_EVENT
)

848 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

849 
c
->
wr™e
->
avažabË
 = 
low©
;

850  
NGX_OK
;

855 ià(
low©
 =ð0 || 
c
->
¢dlow©
) {

856  
NGX_OK
;

859 
¢dlow©
 = (è
low©
;

861 ià(
	`£tsockÝt
(
c
->
fd
, 
SOL_SOCKET
, 
SO_SNDLOWAT
,

862 (cÚ¡ *è&
¢dlow©
, ())

865 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
,

867  
NGX_ERROR
;

870 
c
->
¢dlow©
 = 1;

872  
NGX_OK
;

873 
	}
}

877 
	$ngx_ev’ts_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

879 *
rv
;

880 ***
ùx
;

881 
ngx_ušt_t
 
i
;

882 
ngx_cÚf_t
 
pcf
;

883 
ngx_ev’t_moduË_t
 *
m
;

885 ià(*(**è
cÚf
) {

891 
ngx_ev’t_max_moduË
 = 0;

892 
i
 = 0; 
ngx_moduËs
[i]; i++) {

893 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_EVENT_MODULE
) {

897 
ngx_moduËs
[
i
]->
ùx_šdex
 = 
ngx_ev’t_max_moduË
++;

900 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*));

901 ià(
ùx
 =ð
NULL
) {

902  
NGX_CONF_ERROR
;

905 *
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, 
ngx_ev’t_max_moduË
 * (*));

906 ià(*
ùx
 =ð
NULL
) {

907  
NGX_CONF_ERROR
;

910 *(**è
cÚf
 = 
ùx
;

912 
i
 = 0; 
ngx_moduËs
[i]; i++) {

913 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_EVENT_MODULE
) {

917 
m
 = 
ngx_moduËs
[
i
]->
ùx
;

919 ià(
m
->
ü—‹_cÚf
) {

920 (*
ùx
)[
ngx_moduËs
[
i
]->
ùx_šdex
] = 
m
->
	`ü—‹_cÚf
(
cf
->
cyþe
);

921 ià((*
ùx
)[
ngx_moduËs
[
i
]->
ùx_šdex
] =ð
NULL
) {

922  
NGX_CONF_ERROR
;

927 
pcf
 = *
cf
;

928 
cf
->
ùx
 = ctx;

929 
cf
->
moduË_ty³
 = 
NGX_EVENT_MODULE
;

930 
cf
->
cmd_ty³
 = 
NGX_EVENT_CONF
;

932 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

934 *
cf
 = 
pcf
;

936 ià(
rv
 !ð
NGX_CONF_OK
)

937  
rv
;

939 
i
 = 0; 
ngx_moduËs
[i]; i++) {

940 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_EVENT_MODULE
) {

944 
m
 = 
ngx_moduËs
[
i
]->
ùx
;

946 ià(
m
->
š™_cÚf
) {

947 
rv
 = 
m
->
	`š™_cÚf
(
cf
->
cyþe
, (*
ùx
)[
ngx_moduËs
[
i
]->
ùx_šdex
]);

948 ià(
rv
 !ð
NGX_CONF_OK
) {

949  
rv
;

954  
NGX_CONF_OK
;

955 
	}
}

959 
	$ngx_ev’t_cÚÃùiÚs
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

961 
ngx_ev’t_cÚf_t
 *
ecf
 = 
cÚf
;

963 
ngx_¡r_t
 *
v®ue
;

965 ià(
ecf
->
cÚÃùiÚs
 !ð
NGX_CONF_UNSET_UINT
) {

969 ià(
	`ngx_¡rcmp
(
cmd
->
Çme
.
d©a
, "connections") == 0) {

970 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

975 
v®ue
 = 
cf
->
¬gs
->
–ts
;

976 
ecf
->
cÚÃùiÚs
 = 
	`ngx_©oi
(
v®ue
[1].
d©a
, v®ue[1].
Ën
);

977 ià(
ecf
->
cÚÃùiÚs
 =ð(
ngx_ušt_t
è
NGX_ERROR
) {

978 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

979 "šv®id‚umb” \"%V\"", &
v®ue
[1]);

981  
NGX_CONF_ERROR
;

984 
cf
->
cyþe
->
cÚÃùiÚ_n
 = 
ecf
->
cÚÃùiÚs
;

986  
NGX_CONF_OK
;

987 
	}
}

991 
	$ngx_ev’t_u£
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

993 
ngx_ev’t_cÚf_t
 *
ecf
 = 
cÚf
;

995 
ngx_št_t
 
m
;

996 
ngx_¡r_t
 *
v®ue
;

997 
ngx_ev’t_cÚf_t
 *
Þd_ecf
;

998 
ngx_ev’t_moduË_t
 *
moduË
;

1000 ià(
ecf
->
u£
 !ð
NGX_CONF_UNSET_UINT
) {

1004 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1006 ià(
cf
->
cyþe
->
Þd_cyþe
->
cÚf_ùx
) {

1007 
Þd_ecf
 = 
	`ngx_ev’t_g‘_cÚf
(
cf
->
cyþe
->
Þd_cyþe
->
cÚf_ùx
,

1008 
ngx_ev’t_cÜe_moduË
);

1010 
Þd_ecf
 = 
NULL
;

1014 
m
 = 0; 
ngx_moduËs
[m]; m++) {

1015 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_EVENT_MODULE
) {

1019 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

1020 ià(
moduË
->
Çme
->
Ën
 =ð
v®ue
[1].len) {

1021 ià(
	`ngx_¡rcmp
(
moduË
->
Çme
->
d©a
, 
v®ue
[1].data) == 0) {

1022 
ecf
->
u£
 = 
ngx_moduËs
[
m
]->
ùx_šdex
;

1023 
ecf
->
Çme
 = 
moduË
->Çme->
d©a
;

1025 ià(
ngx_´oûss
 =ð
NGX_PROCESS_SINGLE


1026 && 
Þd_ecf


1027 && 
Þd_ecf
->
u£
 !ð
ecf
->use)

1029 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1036 &
v®ue
[1], 
Þd_ecf
->
Çme
);

1038  
NGX_CONF_ERROR
;

1041  
NGX_CONF_OK
;

1046 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1047 "šv®idƒv’ˆty³ \"%V\"", &
v®ue
[1]);

1049  
NGX_CONF_ERROR
;

1050 
	}
}

1054 
	$ngx_ev’t_debug_cÚÃùiÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1056 #ià(
NGX_DEBUG
)

1057 
ngx_ev’t_cÚf_t
 *
ecf
 = 
cÚf
;

1059 
ngx_št_t
 
rc
;

1060 
ngx_¡r_t
 *
v®ue
;

1061 
ngx_u¾_t
 
u
;

1062 
ngx_cidr_t
 
c
, *
cidr
;

1063 
ngx_ušt_t
 
i
;

1064 
sockaddr_š
 *
sš
;

1065 #ià(
NGX_HAVE_INET6
)

1066 
sockaddr_š6
 *
sš6
;

1069 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1071 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1073 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "unix:") == 0) {

1074 
cidr
 = 
	`ngx_¬¿y_push
(&
ecf
->
debug_cÚÃùiÚ
);

1075 ià(
cidr
 =ð
NULL
) {

1076  
NGX_CONF_ERROR
;

1079 
cidr
->
çmžy
 = 
AF_UNIX
;

1080  
NGX_CONF_OK
;

1085 
rc
 = 
	`ngx_±ocidr
(&
v®ue
[1], &
c
);

1087 ià(
rc
 !ð
NGX_ERROR
) {

1088 ià(
rc
 =ð
NGX_DONE
) {

1089 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1091 &
v®ue
[1]);

1094 
cidr
 = 
	`ngx_¬¿y_push
(&
ecf
->
debug_cÚÃùiÚ
);

1095 ià(
cidr
 =ð
NULL
) {

1096  
NGX_CONF_ERROR
;

1099 *
cidr
 = 
c
;

1101  
NGX_CONF_OK
;

1104 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

1105 
u
.
ho¡
 = 
v®ue
[1];

1107 ià(
	`ngx_š‘_»sÞve_ho¡
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

1108 ià(
u
.
”r
) {

1109 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1111 
u
.
”r
, &u.
ho¡
);

1114  
NGX_CONF_ERROR
;

1117 
cidr
 = 
	`ngx_¬¿y_push_n
(&
ecf
->
debug_cÚÃùiÚ
, 
u
.
Çddrs
);

1118 ià(
cidr
 =ð
NULL
) {

1119  
NGX_CONF_ERROR
;

1122 
	`ngx_memz”o
(
cidr
, 
u
.
Çddrs
 * (
ngx_cidr_t
));

1124 
i
 = 0; i < 
u
.
Çddrs
; i++) {

1125 
cidr
[
i
].
çmžy
 = 
u
.
addrs
[i].
sockaddr
->
§_çmžy
;

1127 
cidr
[
i
].
çmžy
) {

1129 #ià(
NGX_HAVE_INET6
)

1130 
AF_INET6
:

1131 
sš6
 = (
sockaddr_š6
 *è
u
.
addrs
[
i
].
sockaddr
;

1132 
cidr
[
i
].
u
.
š6
.
addr
 = 
sš6
->
sš6_addr
;

1133 
	`ngx_mem£t
(
cidr
[
i
].
u
.
š6
.
mask
.
s6_addr
, 0xff, 16);

1138 
sš
 = (
sockaddr_š
 *è
u
.
addrs
[
i
].
sockaddr
;

1139 
cidr
[
i
].
u
.
š
.
addr
 = 
sš
->
sš_addr
.
s_addr
;

1140 
cidr
[
i
].
u
.
š
.
mask
 = 0xffffffff;

1147 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1153  
NGX_CONF_OK
;

1154 
	}
}

1158 
	$ngx_ev’t_cÜe_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

1160 
ngx_ev’t_cÚf_t
 *
ecf
;

1162 
ecf
 = 
	`ngx_·Îoc
(
cyþe
->
poÞ
, (
ngx_ev’t_cÚf_t
));

1163 ià(
ecf
 =ð
NULL
) {

1164  
NULL
;

1167 
ecf
->
cÚÃùiÚs
 = 
NGX_CONF_UNSET_UINT
;

1168 
ecf
->
u£
 = 
NGX_CONF_UNSET_UINT
;

1169 
ecf
->
muÉi_acû±
 = 
NGX_CONF_UNSET
;

1170 
ecf
->
acû±_mu‹x
 = 
NGX_CONF_UNSET
;

1171 
ecf
->
acû±_mu‹x_d–ay
 = 
NGX_CONF_UNSET_MSEC
;

1172 
ecf
->
Çme
 = (*è
NGX_CONF_UNSET
;

1174 #ià(
NGX_DEBUG
)

1176 ià(
	`ngx_¬¿y_š™
(&
ecf
->
debug_cÚÃùiÚ
, 
cyþe
->
poÞ
, 4,

1177 (
ngx_cidr_t
)è=ð
NGX_ERROR
)

1179  
NULL
;

1184  
ecf
;

1185 
	}
}

1189 
	$ngx_ev’t_cÜe_š™_cÚf
(
ngx_cyþe_t
 *
cyþe
, *
cÚf
)

1191 
ngx_ev’t_cÚf_t
 *
ecf
 = 
cÚf
;

1193 #ià(
NGX_HAVE_EPOLL
è&& !(
NGX_TEST_BUILD_EPOLL
)

1194 
fd
;

1196 #ià(
NGX_HAVE_RTSIG
)

1197 
ngx_ušt_t
 
¹sig
;

1198 
ngx_cÜe_cÚf_t
 *
ccf
;

1200 
ngx_št_t
 
i
;

1201 
ngx_moduË_t
 *
moduË
;

1202 
ngx_ev’t_moduË_t
 *
ev’t_moduË
;

1204 
moduË
 = 
NULL
;

1206 #ià(
NGX_HAVE_EPOLL
è&& !(
NGX_TEST_BUILD_EPOLL
)

1208 
fd
 = 
	`•Þl_ü—‹
(100);

1210 ià(
fd
 != -1) {

1211 (è
	`þo£
(
fd
);

1212 
moduË
 = &
ngx_•Þl_moduË
;

1214 } ià(
ngx_”ºo
 !ð
NGX_ENOSYS
) {

1215 
moduË
 = &
ngx_•Þl_moduË
;

1220 #ià(
NGX_HAVE_RTSIG
)

1222 ià(
moduË
 =ð
NULL
) {

1223 
moduË
 = &
ngx_¹sig_moduË
;

1224 
¹sig
 = 1;

1227 
¹sig
 = 0;

1232 #ià(
NGX_HAVE_DEVPOLL
)

1234 
moduË
 = &
ngx_devpÞl_moduË
;

1238 #ià(
NGX_HAVE_KQUEUE
)

1240 
moduË
 = &
ngx_kqueue_moduË
;

1244 #ià(
NGX_HAVE_SELECT
)

1246 ià(
moduË
 =ð
NULL
) {

1247 
moduË
 = &
ngx_£Ëù_moduË
;

1252 ià(
moduË
 =ð
NULL
) {

1253 
i
 = 0; 
ngx_moduËs
[i]; i++) {

1255 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_EVENT_MODULE
) {

1259 
ev’t_moduË
 = 
ngx_moduËs
[
i
]->
ùx
;

1261 ià(
	`ngx_¡rcmp
(
ev’t_moduË
->
Çme
->
d©a
, 
ev’t_cÜe_Çme
.data) == 0)

1266 
moduË
 = 
ngx_moduËs
[
i
];

1271 ià(
moduË
 =ð
NULL
) {

1272 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0, "noƒvents module found");

1273  
NGX_CONF_ERROR
;

1276 
	`ngx_cÚf_š™_ušt_v®ue
(
ecf
->
cÚÃùiÚs
, 
DEFAULT_CONNECTIONS
);

1277 
cyþe
->
cÚÃùiÚ_n
 = 
ecf
->
cÚÃùiÚs
;

1279 
	`ngx_cÚf_š™_ušt_v®ue
(
ecf
->
u£
, 
moduË
->
ùx_šdex
);

1281 
ev’t_moduË
 = 
moduË
->
ùx
;

1282 
	`ngx_cÚf_š™_±r_v®ue
(
ecf
->
Çme
, 
ev’t_moduË
->Çme->
d©a
);

1284 
	`ngx_cÚf_š™_v®ue
(
ecf
->
muÉi_acû±
, 0);

1285 
	`ngx_cÚf_š™_v®ue
(
ecf
->
acû±_mu‹x
, 1);

1286 
	`ngx_cÚf_š™_m£c_v®ue
(
ecf
->
acû±_mu‹x_d–ay
, 500);

1289 #ià(
NGX_HAVE_RTSIG
)

1291 ià(!
¹sig
) {

1292  
NGX_CONF_OK
;

1295 ià(
ecf
->
acû±_mu‹x
) {

1296  
NGX_CONF_OK
;

1299 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

1301 ià(
ccf
->
wÜk”_´oûs£s
 == 0) {

1302  
NGX_CONF_OK
;

1305 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 0,

1308  
NGX_CONF_ERROR
;

1312  
NGX_CONF_OK
;

1315 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_accept.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_št_t
 
ngx_’abË_acû±_ev’ts
(
ngx_cyþe_t
 *
cyþe
);

14 
ngx_št_t
 
ngx_di§bË_acû±_ev’ts
(
ngx_cyþe_t
 *
cyþe
);

15 
ngx_þo£_acû±ed_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
);

19 
	$ngx_ev’t_acû±
(
ngx_ev’t_t
 *
ev
)

21 
sockËn_t
 
sockËn
;

22 
ngx_”r_t
 
”r
;

23 
ngx_log_t
 *
log
;

24 
ngx_ušt_t
 
Ëv–
;

25 
ngx_sock‘_t
 
s
;

26 
ngx_ev’t_t
 *
»v
, *
wev
;

27 
ngx_li¡’šg_t
 *
ls
;

28 
ngx_cÚÃùiÚ_t
 *
c
, *
lc
;

29 
ngx_ev’t_cÚf_t
 *
ecf
;

30 
u_ch¬
 
§
[
NGX_SOCKADDRLEN
];

31 #ià(
NGX_HAVE_ACCEPT4
)

32 
ngx_ušt_t
 
u£_acû±4
 = 1;

35 ià(
ev
->
timedout
) {

36 ià(
	`ngx_’abË_acû±_ev’ts
((
ngx_cyþe_t
 *è
ngx_cyþe
è!ð
NGX_OK
) {

40 
ev
->
timedout
 = 0;

43 
ecf
 = 
	`ngx_ev’t_g‘_cÚf
(
ngx_cyþe
->
cÚf_ùx
, 
ngx_ev’t_cÜe_moduË
);

45 ià(
ngx_ev’t_æags
 & 
NGX_USE_RTSIG_EVENT
) {

46 
ev
->
avažabË
 = 1;

48 } ià(!(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
)) {

49 
ev
->
avažabË
 = 
ecf
->
muÉi_acû±
;

52 
lc
 = 
ev
->
d©a
;

53 
ls
 = 
lc
->
li¡’šg
;

54 
ev
->
»ady
 = 0;

56 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

57 "acû± oÀ%V,„—dy: %d", &
ls
->
addr_‹xt
, 
ev
->
avažabË
);

60 
sockËn
 = 
NGX_SOCKADDRLEN
;

62 #ià(
NGX_HAVE_ACCEPT4
)

63 ià(
u£_acû±4
) {

64 
s
 = 
	`acû±4
(
lc
->
fd
, (
sockaddr
 *è
§
, &
sockËn
,

65 
SOCK_NONBLOCK
);

67 
s
 = 
	`acû±
(
lc
->
fd
, (
sockaddr
 *è
§
, &
sockËn
);

70 
s
 = 
	`acû±
(
lc
->
fd
, (
sockaddr
 *è
§
, &
sockËn
);

73 ià(
s
 =ð(
ngx_sock‘_t
) -1) {

74 
”r
 = 
ngx_sock‘_”ºo
;

76 ià(
”r
 =ð
NGX_EAGAIN
) {

77 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 
”r
,

82 
Ëv–
 = 
NGX_LOG_ALERT
;

84 ià(
”r
 =ð
NGX_ECONNABORTED
) {

85 
Ëv–
 = 
NGX_LOG_ERR
;

87 } ià(
”r
 =ð
NGX_EMFILE
 ||ƒ¼ =ð
NGX_ENFILE
) {

88 
Ëv–
 = 
NGX_LOG_CRIT
;

91 #ià(
NGX_HAVE_ACCEPT4
)

92 
	`ngx_log_”rÜ
(
Ëv–
, 
ev
->
log
, 
”r
,

93 
u£_acû±4
 ? "accept4() failed" : "accept() failed");

95 ià(
u£_acû±4
 && 
”r
 =ð
NGX_ENOSYS
) {

96 
u£_acû±4
 = 0;

97 
ngx_šh”™ed_nÚblockšg
 = 0;

101 
	`ngx_log_”rÜ
(
Ëv–
, 
ev
->
log
, 
”r
, "accept() failed");

104 ià(
”r
 =ð
NGX_ECONNABORTED
) {

105 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

106 
ev
->
avažabË
--;

109 ià(
ev
->
avažabË
) {

114 ià(
”r
 =ð
NGX_EMFILE
 ||ƒ¼ =ð
NGX_ENFILE
) {

115 ià(
	`ngx_di§bË_acû±_ev’ts
((
ngx_cyþe_t
 *è
ngx_cyþe
)

116 !ð
NGX_OK
)

121 ià(
ngx_u£_acû±_mu‹x
) {

122 ià(
ngx_acû±_mu‹x_h–d
) {

123 
	`ngx_shmtx_uÆock
(&
ngx_acû±_mu‹x
);

124 
ngx_acû±_mu‹x_h–d
 = 0;

127 
ngx_acû±_di§bËd
 = 1;

130 
	`ngx_add_tim”
(
ev
, 
ecf
->
acû±_mu‹x_d–ay
);

137 #ià(
NGX_STAT_STUB
)

138 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_acû±ed
, 1);

141 
ngx_acû±_di§bËd
 = 
ngx_cyþe
->
cÚÃùiÚ_n
 / 8

142 - 
ngx_cyþe
->
ä“_cÚÃùiÚ_n
;

144 
c
 = 
	`ngx_g‘_cÚÃùiÚ
(
s
, 
ev
->
log
);

146 ià(
c
 =ð
NULL
) {

147 ià(
	`ngx_þo£_sock‘
(
s
) == -1) {

148 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_sock‘_”ºo
,

149 
ngx_þo£_sock‘_n
 " failed");

155 #ià(
NGX_STAT_STUB
)

156 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_aùive
, 1);

159 
c
->
poÞ
 = 
	`ngx_ü—‹_poÞ
(
ls
->
poÞ_size
, 
ev
->
log
);

160 ià(
c
->
poÞ
 =ð
NULL
) {

161 
	`ngx_þo£_acû±ed_cÚÃùiÚ
(
c
);

165 
c
->
sockaddr
 = 
	`ngx_·Îoc
(c->
poÞ
, 
sockËn
);

166 ià(
c
->
sockaddr
 =ð
NULL
) {

167 
	`ngx_þo£_acû±ed_cÚÃùiÚ
(
c
);

171 
	`ngx_memýy
(
c
->
sockaddr
, 
§
, 
sockËn
);

173 
log
 = 
	`ngx_·Îoc
(
c
->
poÞ
, (
ngx_log_t
));

174 ià(
log
 =ð
NULL
) {

175 
	`ngx_þo£_acû±ed_cÚÃùiÚ
(
c
);

181 ià(
ngx_šh”™ed_nÚblockšg
) {

182 ià(
ngx_ev’t_æags
 & 
NGX_USE_AIO_EVENT
) {

183 ià(
	`ngx_blockšg
(
s
) == -1) {

184 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_sock‘_”ºo
,

185 
ngx_blockšg_n
 " failed");

186 
	`ngx_þo£_acû±ed_cÚÃùiÚ
(
c
);

192 ià(!(
ngx_ev’t_æags
 & (
NGX_USE_AIO_EVENT
|
NGX_USE_RTSIG_EVENT
))) {

193 ià(
	`ngx_nÚblockšg
(
s
) == -1) {

194 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_sock‘_”ºo
,

195 
ngx_nÚblockšg_n
 " failed");

196 
	`ngx_þo£_acû±ed_cÚÃùiÚ
(
c
);

202 *
log
 = 
ls
->log;

204 
c
->
»cv
 = 
ngx_»cv
;

205 
c
->
£nd
 = 
ngx_£nd
;

206 
c
->
»cv_chaš
 = 
ngx_»cv_chaš
;

207 
c
->
£nd_chaš
 = 
ngx_£nd_chaš
;

209 
c
->
log
 =†og;

210 
c
->
poÞ
->
log
 =†og;

212 
c
->
sockËn
 = socklen;

213 
c
->
li¡’šg
 = 
ls
;

214 
c
->
loÿl_sockaddr
 = 
ls
->
sockaddr
;

215 
c
->
loÿl_sockËn
 = 
ls
->
sockËn
;

217 
c
->
uÃx³ùed_eof
 = 1;

219 #ià(
NGX_HAVE_UNIX_DOMAIN
)

220 ià(
c
->
sockaddr
->
§_çmžy
 =ð
AF_UNIX
) {

221 
c
->
tý_nÝush
 = 
NGX_TCP_NOPUSH_DISABLED
;

222 
c
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_DISABLED
;

223 #ià(
NGX_SOLARIS
)

225 
c
->
£ndfže
 = 0;

230 
»v
 = 
c
->
»ad
;

231 
wev
 = 
c
->
wr™e
;

233 
wev
->
»ady
 = 1;

235 ià(
ngx_ev’t_æags
 & (
NGX_USE_AIO_EVENT
|
NGX_USE_RTSIG_EVENT
)) {

237 
»v
->
»ady
 = 1;

240 ià(
ev
->
deã¼ed_acû±
) {

241 
»v
->
»ady
 = 1;

242 #ià(
NGX_HAVE_KQUEUE
)

243 
»v
->
avažabË
 = 1;

247 
»v
->
log
 =†og;

248 
wev
->
log
 =†og;

259 
c
->
numb”
 = 
	`ngx_©omic_ãtch_add
(
ngx_cÚÃùiÚ_couÁ”
, 1);

261 #ià(
NGX_STAT_STUB
)

262 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_hªdËd
, 1);

265 ià(
ls
->
addr_ÁÝ
) {

266 
c
->
addr_‹xt
.
d©a
 = 
	`ngx_²®loc
(c->
poÞ
, 
ls
->
addr_‹xt_max_Ën
);

267 ià(
c
->
addr_‹xt
.
d©a
 =ð
NULL
) {

268 
	`ngx_þo£_acû±ed_cÚÃùiÚ
(
c
);

272 
c
->
addr_‹xt
.
Ën
 = 
	`ngx_sock_ÁÝ
(c->
sockaddr
, c->
sockËn
,

273 
c
->
addr_‹xt
.
d©a
,

274 
ls
->
addr_‹xt_max_Ën
, 0);

275 ià(
c
->
addr_‹xt
.
Ën
 == 0) {

276 
	`ngx_þo£_acû±ed_cÚÃùiÚ
(
c
);

281 #ià(
NGX_DEBUG
)

284 
ngx_¡r_t
 
addr
;

285 
sockaddr_š
 *
sš
;

286 
ngx_cidr_t
 *
cidr
;

287 
ngx_ušt_t
 
i
;

288 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

289 #ià(
NGX_HAVE_INET6
)

290 
sockaddr_š6
 *
sš6
;

291 
ngx_ušt_t
 
n
;

294 
cidr
 = 
ecf
->
debug_cÚÃùiÚ
.
–ts
;

295 
i
 = 0; i < 
ecf
->
debug_cÚÃùiÚ
.
ÃÉs
; i++) {

296 ià(
cidr
[
i
].
çmžy
 !ð(
ngx_ušt_t
è
c
->
sockaddr
->
§_çmžy
) {

297 
Ãxt
;

300 
cidr
[
i
].
çmžy
) {

302 #ià(
NGX_HAVE_INET6
)

303 
AF_INET6
:

304 
sš6
 = (
sockaddr_š6
 *è
c
->
sockaddr
;

305 
n
 = 0;‚ < 16;‚++) {

306 ià((
sš6
->
sš6_addr
.
s6_addr
[
n
]

307 & 
cidr
[
i
].
u
.
š6
.
mask
.
s6_addr
[
n
])

308 !ð
cidr
[
i
].
u
.
š6
.
addr
.
s6_addr
[
n
])

310 
Ãxt
;

316 #ià(
NGX_HAVE_UNIX_DOMAIN
)

317 
AF_UNIX
:

322 
sš
 = (
sockaddr_š
 *è
c
->
sockaddr
;

323 ià((
sš
->
sš_addr
.
s_addr
 & 
cidr
[
i
].
u
.
š
.
mask
)

324 !ð
cidr
[
i
].
u
.
š
.
addr
)

326 
Ãxt
;

331 
log
->
log_Ëv–
 = 
NGX_LOG_DEBUG_CONNECTION
|
NGX_LOG_DEBUG_ALL
;

334 
Ãxt
:

338 ià(
log
->
log_Ëv–
 & 
NGX_LOG_DEBUG_EVENT
) {

339 
addr
.
d©a
 = 
‹xt
;

340 
addr
.
Ën
 = 
	`ngx_sock_ÁÝ
(
c
->
sockaddr
, c->
sockËn
, 
‹xt
,

341 
NGX_SOCKADDR_STRLEN
, 1);

343 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
log
, 0,

344 "*%uA‡cû±: %V fd:%d", 
c
->
numb”
, &
addr
, 
s
);

350 ià(
ngx_add_cÚn
 && (
ngx_ev’t_æags
 & 
NGX_USE_EPOLL_EVENT
) == 0) {

351 ià(
	`ngx_add_cÚn
(
c
è=ð
NGX_ERROR
) {

352 
	`ngx_þo£_acû±ed_cÚÃùiÚ
(
c
);

357 
log
->
d©a
 = 
NULL
;

358 
log
->
hªdËr
 = 
NULL
;

360 
ls
->
	`hªdËr
(
c
);

362 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

363 
ev
->
avažabË
--;

366 } 
ev
->
avažabË
);

367 
	}
}

370 
ngx_št_t


371 
	$ngx_Œylock_acû±_mu‹x
(
ngx_cyþe_t
 *
cyþe
)

373 ià(
	`ngx_shmtx_Œylock
(&
ngx_acû±_mu‹x
)) {

375 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

378 ià(
ngx_acû±_mu‹x_h–d


379 && 
ngx_acû±_ev’ts
 == 0

380 && !(
ngx_ev’t_æags
 & 
NGX_USE_RTSIG_EVENT
))

382  
NGX_OK
;

385 ià(
	`ngx_’abË_acû±_ev’ts
(
cyþe
è=ð
NGX_ERROR
) {

386 
	`ngx_shmtx_uÆock
(&
ngx_acû±_mu‹x
);

387  
NGX_ERROR
;

390 
ngx_acû±_ev’ts
 = 0;

391 
ngx_acû±_mu‹x_h–d
 = 1;

393  
NGX_OK
;

396 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

397 "acû± mu‹x†ock fažed: %ui", 
ngx_acû±_mu‹x_h–d
);

399 ià(
ngx_acû±_mu‹x_h–d
) {

400 ià(
	`ngx_di§bË_acû±_ev’ts
(
cyþe
è=ð
NGX_ERROR
) {

401  
NGX_ERROR
;

404 
ngx_acû±_mu‹x_h–d
 = 0;

407  
NGX_OK
;

408 
	}
}

411 
ngx_št_t


412 
	$ngx_’abË_acû±_ev’ts
(
ngx_cyþe_t
 *
cyþe
)

414 
ngx_ušt_t
 
i
;

415 
ngx_li¡’šg_t
 *
ls
;

416 
ngx_cÚÃùiÚ_t
 *
c
;

418 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

419 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

421 
c
 = 
ls
[
i
].
cÚÃùiÚ
;

423 ià(
c
->
»ad
->
aùive
) {

427 ià(
ngx_ev’t_æags
 & 
NGX_USE_RTSIG_EVENT
) {

429 ià(
	`ngx_add_cÚn
(
c
è=ð
NGX_ERROR
) {

430  
NGX_ERROR
;

434 ià(
	`ngx_add_ev’t
(
c
->
»ad
, 
NGX_READ_EVENT
, 0è=ð
NGX_ERROR
) {

435  
NGX_ERROR
;

440  
NGX_OK
;

441 
	}
}

444 
ngx_št_t


445 
	$ngx_di§bË_acû±_ev’ts
(
ngx_cyþe_t
 *
cyþe
)

447 
ngx_ušt_t
 
i
;

448 
ngx_li¡’šg_t
 *
ls
;

449 
ngx_cÚÃùiÚ_t
 *
c
;

451 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

452 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

454 
c
 = 
ls
[
i
].
cÚÃùiÚ
;

456 ià(!
c
->
»ad
->
aùive
) {

460 ià(
ngx_ev’t_æags
 & 
NGX_USE_RTSIG_EVENT
) {

461 ià(
	`ngx_d–_cÚn
(
c
, 
NGX_DISABLE_EVENT
è=ð
NGX_ERROR
) {

462  
NGX_ERROR
;

466 ià(
	`ngx_d–_ev’t
(
c
->
»ad
, 
NGX_READ_EVENT
, 
NGX_DISABLE_EVENT
)

467 =ð
NGX_ERROR
)

469  
NGX_ERROR
;

474  
NGX_OK
;

475 
	}
}

479 
	$ngx_þo£_acû±ed_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

481 
ngx_sock‘_t
 
fd
;

483 
	`ngx_ä“_cÚÃùiÚ
(
c
);

485 
fd
 = 
c
->fd;

486 
c
->
fd
 = (
ngx_sock‘_t
) -1;

488 ià(
	`ngx_þo£_sock‘
(
fd
) == -1) {

489 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_sock‘_”ºo
,

490 
ngx_þo£_sock‘_n
 " failed");

493 ià(
c
->
poÞ
) {

494 
	`ngx_de¡roy_poÞ
(
c
->
poÞ
);

497 #ià(
NGX_STAT_STUB
)

498 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_aùive
, -1);

500 
	}
}

503 
u_ch¬
 *

504 
	$ngx_acû±_log_”rÜ
(
ngx_log_t
 *
log
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
)

506  
	`ngx_¢´štf
(
buf
, 
Ën
, " while‡ccepting‚ew connection on %V",

507 
log
->
d©a
);

508 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_busy_lock.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_št_t
 
ngx_ev’t_busy_lock_look_ÿch—bË
(
ngx_ev’t_busy_lock_t
 *
bl
,

14 
ngx_ev’t_busy_lock_ùx_t
 *
ùx
);

15 
ngx_ev’t_busy_lock_hªdËr
(
ngx_ev’t_t
 *
ev
);

16 
ngx_ev’t_busy_lock_po¡ed_hªdËr
(
ngx_ev’t_t
 *
ev
);

26 
ngx_št_t


27 
	$ngx_ev’t_busy_lock
(
ngx_ev’t_busy_lock_t
 *
bl
, 
ngx_ev’t_busy_lock_ùx_t
 *
ùx
)

29 
ngx_št_t
 
rc
;

31 
	`ngx_mu‹x_lock
(
bl
->
mu‹x
);

33 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
ev’t
->
log
, 0,

35 
bl
->
busy
, bl->
max_busy
);

37 ià(
bl
->
busy
 < bl->
max_busy
) {

38 
bl
->
busy
++;

40 
rc
 = 
NGX_OK
;

42 } ià(
ùx
->
tim”
 && 
bl
->
wa™šg
 < bl->
max_wa™šg
) {

43 
bl
->
wa™šg
++;

44 
	`ngx_add_tim”
(
ùx
->
ev’t
, ctx->
tim”
);

45 
ùx
->
ev’t
->
hªdËr
 = 
ngx_ev’t_busy_lock_hªdËr
;

47 ià(
bl
->
ev’ts
) {

48 
bl
->
Ï¡
->
Ãxt
 = 
ùx
;

51 
bl
->
ev’ts
 = 
ùx
;

54 
bl
->
Ï¡
 = 
ùx
;

56 
rc
 = 
NGX_AGAIN
;

59 
rc
 = 
NGX_BUSY
;

62 
	`ngx_mu‹x_uÆock
(
bl
->
mu‹x
);

64  
rc
;

65 
	}
}

68 
ngx_št_t


69 
	$ngx_ev’t_busy_lock_ÿch—bË
(
ngx_ev’t_busy_lock_t
 *
bl
,

70 
ngx_ev’t_busy_lock_ùx_t
 *
ùx
)

72 
ngx_št_t
 
rc
;

74 
	`ngx_mu‹x_lock
(
bl
->
mu‹x
);

76 
rc
 = 
	`ngx_ev’t_busy_lock_look_ÿch—bË
(
bl
, 
ùx
);

78 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
ev’t
->
log
, 0,

80 
rc
, 
bl
->
wa™šg
, bl->
max_wa™šg
);

88 ià(
rc
 =ð
NGX_AGAIN
) {

90 ià(
ùx
->
tim”
 && 
bl
->
wa™šg
 < bl->
max_wa™šg
) {

91 
bl
->
wa™šg
++;

92 
	`ngx_add_tim”
(
ùx
->
ev’t
, ctx->
tim”
);

93 
ùx
->
ev’t
->
hªdËr
 = 
ngx_ev’t_busy_lock_hªdËr
;

95 ià(
bl
->
ev’ts
 =ð
NULL
) {

96 
bl
->
ev’ts
 = 
ùx
;

98 
bl
->
Ï¡
->
Ãxt
 = 
ùx
;

100 
bl
->
Ï¡
 = 
ùx
;

103 
rc
 = 
NGX_BUSY
;

107 
	`ngx_mu‹x_uÆock
(
bl
->
mu‹x
);

109  
rc
;

110 
	}
}

114 
	$ngx_ev’t_busy_uÆock
(
ngx_ev’t_busy_lock_t
 *
bl
,

115 
ngx_ev’t_busy_lock_ùx_t
 *
ùx
)

117 
ngx_ev’t_t
 *
ev
;

118 
ngx_ev’t_busy_lock_ùx_t
 *
wakeup
;

120 
	`ngx_mu‹x_lock
(
bl
->
mu‹x
);

122 ià(
bl
->
ev’ts
) {

123 
wakeup
 = 
bl
->
ev’ts
;

124 
bl
->
ev’ts
 = bl->ev’ts->
Ãxt
;

127 
wakeup
 = 
NULL
;

128 
bl
->
busy
--;

136 ià(
wakeup
 =ð
NULL
) {

137 
	`ngx_mu‹x_uÆock
(
bl
->
mu‹x
);

141 ià(
ùx
->
md5
) {

142 
wakeup
 = 
bl
->
ev’ts
; wakeup; wakeu°ðwakeup->
Ãxt
) {

143 ià(
wakeup
->
md5
 =ð
NULL
 || wakeup->
¦Ù
 !ð
ùx
->slot) {

147 
wakeup
->
hªdËr
 = 
ngx_ev’t_busy_lock_po¡ed_hªdËr
;

148 
wakeup
->
ÿche_upd©ed
 = 1;

150 
ev
 = 
wakeup
->
ev’t
;

152 
	`ngx_po¡_ev’t
(
ev
, &
ngx_po¡ed_ev’ts
);

155 
	`ngx_mu‹x_uÆock
(
bl
->
mu‹x
);

158 
bl
->
wa™šg
--;

160 
	`ngx_mu‹x_uÆock
(
bl
->
mu‹x
);

162 
wakeup
->
hªdËr
 = 
ngx_ev’t_busy_lock_po¡ed_hªdËr
;

163 
wakeup
->
locked
 = 1;

165 
ev
 = 
wakeup
->
ev’t
;

167 ià(
ev
->
tim”_£t
) {

168 
	`ngx_d–_tim”
(
ev
);

171 
	`ngx_po¡_ev’t
(
ev
, &
ngx_po¡ed_ev’ts
);

173 
	}
}

177 
	$ngx_ev’t_busy_lock_ÿnûl
(
ngx_ev’t_busy_lock_t
 *
bl
,

178 
ngx_ev’t_busy_lock_ùx_t
 *
ùx
)

180 
ngx_ev’t_busy_lock_ùx_t
 *
c
, *
p
;

182 
	`ngx_mu‹x_lock
(
bl
->
mu‹x
);

184 
bl
->
wa™šg
--;

186 ià(
ùx
 =ð
bl
->
ev’ts
) {

187 
bl
->
ev’ts
 = 
ùx
->
Ãxt
;

190 
p
 = 
bl
->
ev’ts
;

191 
c
 = 
bl
->
ev’ts
->
Ãxt
; c; c = c->next) {

192 ià(
c
 =ð
ùx
) {

193 
p
->
Ãxt
 = 
ùx
->next;

196 
p
 = 
c
;

200 
	`ngx_mu‹x_uÆock
(
bl
->
mu‹x
);

201 
	}
}

204 
ngx_št_t


205 
	$ngx_ev’t_busy_lock_look_ÿch—bË
(
ngx_ev’t_busy_lock_t
 *
bl
,

206 
ngx_ev’t_busy_lock_ùx_t
 *
ùx
)

208 
ngx_št_t
 
ä“
;

209 
ngx_ušt_t
 
i
, 
b™
, 
ÿch—bË
, 
mask
;

211 
b™
 = 0;

212 
ÿch—bË
 = 0;

213 
ä“
 = -1;

215 #ià(
NGX_SUPPRESS_WARN
)

216 
mask
 = 0;

219 
i
 = 0; i < 
bl
->
max_busy
; i++) {

221 ià((
b™
 & 7) == 0) {

222 
mask
 = 
bl
->
md5_mask
[
i
 / 8];

225 ià(
mask
 & 1) {

226 ià(
	`ngx_memcmp
(&
bl
->
md5
[
i
 * 16], 
ùx
->md5, 16) == 0) {

227 
ùx
->
wa™šg
 = 1;

228 
ùx
->
¦Ù
 = 
i
;

229  
NGX_AGAIN
;

231 
ÿch—bË
++;

233 } ià(
ä“
 == -1) {

234 
ä“
 = 
i
;

237 ià(
ÿch—bË
 =ð
bl
->cacheable) {

238 ià(
ä“
 =ð-1 && 
ÿch—bË
 < 
bl
->
max_busy
) {

239 
ä“
 = 
i
 + 1;

245 
mask
 >>= 1;

246 
b™
++;

249 ià(
ä“
 == -1) {

250  
NGX_BUSY
;

254 ià(
bl
->
busy
 =ðbl->
max_busy
) {

255  
NGX_BUSY
;

259 
	`ngx_memýy
(&
bl
->
md5
[
ä“
 * 16], 
ùx
->md5, 16);

260 
bl
->
md5_mask
[
ä“
 / 8] |= 1 << (free & 7);

261 
ùx
->
¦Ù
 = 
ä“
;

263 
bl
->
ÿch—bË
++;

264 
bl
->
busy
++;

266  
NGX_OK
;

267 
	}
}

271 
	$ngx_ev’t_busy_lock_hªdËr
(
ngx_ev’t_t
 *
ev
)

273 
ev
->
hªdËr
 = 
ngx_ev’t_busy_lock_po¡ed_hªdËr
;

275 
	`ngx_po¡_ev’t
(
ev
, &
ngx_po¡ed_ev’ts
);

276 
	}
}

280 
	$ngx_ev’t_busy_lock_po¡ed_hªdËr
(
ngx_ev’t_t
 *
ev
)

282 
ngx_ev’t_busy_lock_ùx_t
 *
ùx
;

284 
ùx
 = 
ev
->
d©a
;

285 
ùx
->
	`hªdËr
(
ev
);

286 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_connect.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ev’t_cÚÃù.h
>

14 
ngx_št_t


15 
	$ngx_ev’t_cÚÃù_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
)

17 
rc
;

18 
ngx_št_t
 
ev’t
;

19 
ngx_”r_t
 
”r
;

20 
ngx_ušt_t
 
Ëv–
;

21 
ngx_sock‘_t
 
s
;

22 
ngx_ev’t_t
 *
»v
, *
wev
;

23 
ngx_cÚÃùiÚ_t
 *
c
;

25 
rc
 = 
pc
->
	`g‘
Õc,…c->
d©a
);

26 ià(
rc
 !ð
NGX_OK
) {

27  
rc
;

30 
s
 = 
	`ngx_sock‘
(
pc
->
sockaddr
->
§_çmžy
, 
SOCK_STREAM
, 0);

32 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
pc
->
log
, 0, "sock‘ %d", 
s
);

34 ià(
s
 =ð(
ngx_sock‘_t
) -1) {

35 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
pc
->
log
, 
ngx_sock‘_”ºo
,

36 
ngx_sock‘_n
 " failed");

37  
NGX_ERROR
;

41 
c
 = 
	`ngx_g‘_cÚÃùiÚ
(
s
, 
pc
->
log
);

43 ià(
c
 =ð
NULL
) {

44 ià(
	`ngx_þo£_sock‘
(
s
) == -1) {

45 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
pc
->
log
, 
ngx_sock‘_”ºo
,

46 
ngx_þo£_sock‘_n
 "failed");

49  
NGX_ERROR
;

52 ià(
pc
->
rcvbuf
) {

53 ià(
	`£tsockÝt
(
s
, 
SOL_SOCKET
, 
SO_RCVBUF
,

54 (cÚ¡ *è&
pc
->
rcvbuf
, ()) == -1)

56 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
pc
->
log
, 
ngx_sock‘_”ºo
,

58 
çžed
;

62 ià(
	`ngx_nÚblockšg
(
s
) == -1) {

63 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
pc
->
log
, 
ngx_sock‘_”ºo
,

64 
ngx_nÚblockšg_n
 " failed");

66 
çžed
;

69 ià(
pc
->
loÿl
) {

70 ià(
	`bšd
(
s
, 
pc
->
loÿl
->
sockaddr
,…c->loÿl->
sockËn
) == -1) {

71 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
pc
->
log
, 
ngx_sock‘_”ºo
,

72 "bšd(%Vèçžed", &
pc
->
loÿl
->
Çme
);

74 
çžed
;

78 
c
->
»cv
 = 
ngx_»cv
;

79 
c
->
£nd
 = 
ngx_£nd
;

80 
c
->
»cv_chaš
 = 
ngx_»cv_chaš
;

81 
c
->
£nd_chaš
 = 
ngx_£nd_chaš
;

83 
c
->
£ndfže
 = 1;

85 
c
->
log_”rÜ
 = 
pc
->log_error;

87 ià(
pc
->
sockaddr
->
§_çmžy
 =ð
AF_UNIX
) {

88 
c
->
tý_nÝush
 = 
NGX_TCP_NOPUSH_DISABLED
;

89 
c
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_DISABLED
;

91 #ià(
NGX_SOLARIS
)

93 
c
->
£ndfže
 = 0;

97 
»v
 = 
c
->
»ad
;

98 
wev
 = 
c
->
wr™e
;

100 
»v
->
log
 = 
pc
->log;

101 
wev
->
log
 = 
pc
->log;

103 
pc
->
cÚÃùiÚ
 = 
c
;

105 
c
->
numb”
 = 
	`ngx_©omic_ãtch_add
(
ngx_cÚÃùiÚ_couÁ”
, 1);

107 ià(
ngx_add_cÚn
) {

108 ià(
	`ngx_add_cÚn
(
c
è=ð
NGX_ERROR
) {

109 
çžed
;

113 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
pc
->
log
, 0,

114 "cÚÃùØ%V, fd:%d #%uA", 
pc
->
Çme
, 
s
, 
c
->
numb”
);

116 
rc
 = 
	`cÚÃù
(
s
, 
pc
->
sockaddr
,…c->
sockËn
);

118 ià(
rc
 == -1) {

119 
”r
 = 
ngx_sock‘_”ºo
;

122 ià(
”r
 !ð
NGX_EINPROGRESS


123 #ià(
NGX_WIN32
)

125 && 
”r
 !ð
NGX_EAGAIN


129 ià(
”r
 =ð
NGX_ECONNREFUSED


130 #ià(
NGX_LINUX
)

135 || 
”r
 =ð
NGX_EAGAIN


137 || 
”r
 =ð
NGX_ECONNRESET


138 || 
”r
 =ð
NGX_ENETDOWN


139 || 
”r
 =ð
NGX_ENETUNREACH


140 || 
”r
 =ð
NGX_EHOSTDOWN


141 || 
”r
 =ð
NGX_EHOSTUNREACH
)

143 
Ëv–
 = 
NGX_LOG_ERR
;

146 
Ëv–
 = 
NGX_LOG_CRIT
;

149 
	`ngx_log_”rÜ
(
Ëv–
, 
c
->
log
, 
”r
, "connect()o %V failed",

150 
pc
->
Çme
);

152 
	`ngx_þo£_cÚÃùiÚ
(
c
);

153 
pc
->
cÚÃùiÚ
 = 
NULL
;

155  
NGX_DECLINED
;

159 ià(
ngx_add_cÚn
) {

160 ià(
rc
 == -1) {

164  
NGX_AGAIN
;

167 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
pc
->
log
, 0, "connected");

169 
wev
->
»ady
 = 1;

171  
NGX_OK
;

174 ià(
ngx_ev’t_æags
 & 
NGX_USE_AIO_EVENT
) {

176 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
pc
->
log
, 
ngx_sock‘_”ºo
,

177 "cÚÃù(): %d", 
rc
);

181 ià(
	`ngx_blockšg
(
s
) == -1) {

182 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
pc
->
log
, 
ngx_sock‘_”ºo
,

183 
ngx_blockšg_n
 " failed");

184 
çžed
;

194 
»v
->
»ady
 = 1;

195 
wev
->
»ady
 = 1;

197  
NGX_OK
;

200 ià(
ngx_ev’t_æags
 & 
NGX_USE_CLEAR_EVENT
) {

204 
ev’t
 = 
NGX_CLEAR_EVENT
;

210 
ev’t
 = 
NGX_LEVEL_EVENT
;

213 ià(
	`ngx_add_ev’t
(
»v
, 
NGX_READ_EVENT
, 
ev’t
è!ð
NGX_OK
) {

214 
çžed
;

217 ià(
rc
 == -1) {

221 ià(
	`ngx_add_ev’t
(
wev
, 
NGX_WRITE_EVENT
, 
ev’t
è!ð
NGX_OK
) {

222 
çžed
;

225  
NGX_AGAIN
;

228 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
pc
->
log
, 0, "connected");

230 
wev
->
»ady
 = 1;

232  
NGX_OK
;

234 
çžed
:

236 
	`ngx_þo£_cÚÃùiÚ
(
c
);

237 
pc
->
cÚÃùiÚ
 = 
NULL
;

239  
NGX_ERROR
;

240 
	}
}

243 
ngx_št_t


244 
	$ngx_ev’t_g‘_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

246  
NGX_OK
;

247 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_mutex.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_št_t
 
	$ngx_ev’t_mu‹x_timedlock
(
ngx_ev’t_mu‹x_t
 *
m
, 
ngx_m£c_t
 
tim”
,

14 
ngx_ev’t_t
 *
ev
)

16 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

17 "lockƒv’ˆmu‹x %°lock:%XD", 
m
, m->
lock
);

19 ià(
m
->
lock
) {

21 ià(
m
->
ev’ts
 =ð
NULL
) {

22 
m
->
ev’ts
 = 
ev
;

25 
m
->
Ï¡
->
Ãxt
 = 
ev
;

28 
m
->
Ï¡
 = 
ev
;

29 
ev
->
Ãxt
 = 
NULL
;

31 #ià(
NGX_THREADS0
)

32 
ev
->
light
 = 1;

35 
	`ngx_add_tim”
(
ev
, 
tim”
);

37  
NGX_AGAIN
;

40 
m
->
lock
 = 1;

42  
NGX_OK
;

43 
	}
}

46 
ngx_št_t
 
	$ngx_ev’t_mu‹x_uÆock
(
ngx_ev’t_mu‹x_t
 *
m
, 
ngx_log_t
 *
log
)

48 
ngx_ev’t_t
 *
ev
;

50 ià(
m
->
lock
 == 0) {

51 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

52 "ŒšgØuÆockhä“ƒv’ˆmu‹x %p", 
m
);

53  
NGX_ERROR
;

56 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
log
, 0,

57 "uÆockƒv’ˆmu‹x %p,‚exˆev’t: %p", 
m
, m->
ev’ts
);

59 
m
->
lock
 = 0;

61 ià(
m
->
ev’ts
) {

62 
ev
 = 
m
->
ev’ts
;

63 
m
->
ev’ts
 = 
ev
->
Ãxt
;

65 
ev
->
Ãxt
 = 
ngx_po¡ed_ev’ts
;

66 
ngx_po¡ed_ev’ts
 = 
ev
;

69  
NGX_OK
;

70 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_openssl.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
	#NGX_SSL_PASSWORD_BUFFER_SIZE
 4096

	)

17 
ngx_ušt_t
 
	m’gše
;

18 } 
	tngx_Ý’s¦_cÚf_t
;

21 
ngx_s¦_·sswÜd_ÿÎback
(*
buf
, 
size
, 
rwæag
,

22 *
u£rd©a
);

23 
ngx_s¦_v”ify_ÿÎback
(
ok
, 
X509_STORE_CTX
 *
x509_¡Üe
);

24 
ngx_s¦_šfo_ÿÎback
(cÚ¡ 
ngx_s¦_cÚn_t
 *
s¦_cÚn
, 
wh”e
,

25 
»t
);

26 
ngx_s¦_·sswÜds_þ—nup
(*
d©a
);

27 
ngx_s¦_hªdshake_hªdËr
(
ngx_ev’t_t
 *
ev
);

28 
ngx_št_t
 
ngx_s¦_hªdË_»cv
(
ngx_cÚÃùiÚ_t
 *
c
, 
n
);

29 
ngx_s¦_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
);

30 
ngx_s¦_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
);

31 
ngx_s¦_shutdown_hªdËr
(
ngx_ev’t_t
 *
ev
);

32 
ngx_s¦_cÚÃùiÚ_”rÜ
(
ngx_cÚÃùiÚ_t
 *
c
, 
s¦”r
,

33 
ngx_”r_t
 
”r
, *
‹xt
);

34 
ngx_s¦_þ—r_”rÜ
(
ngx_log_t
 *
log
);

36 
ngx_št_t
 
ngx_s¦_£ssiÚ_id_cÚ‹xt
(
ngx_s¦_t
 *
s¦
,

37 
ngx_¡r_t
 *
£ss_ùx
);

38 
ngx_št_t
 
ngx_s¦_£ssiÚ_ÿche_š™
(
ngx_shm_zÚe_t
 *
shm_zÚe
, *
d©a
);

39 
ngx_s¦_Ãw_£ssiÚ
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
,

40 
ngx_s¦_£ssiÚ_t
 *
£ss
);

41 
ngx_s¦_£ssiÚ_t
 *
ngx_s¦_g‘_ÿched_£ssiÚ
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
,

42 
u_ch¬
 *
id
, 
Ën
, *
cÝy
);

43 
ngx_s¦_»move_£ssiÚ
(
SSL_CTX
 *
s¦
, 
ngx_s¦_£ssiÚ_t
 *
£ss
);

44 
ngx_s¦_expœe_£ssiÚs
(
ngx_s¦_£ssiÚ_ÿche_t
 *
ÿche
,

45 
ngx_¦ab_poÞ_t
 *
shpoÞ
, 
ngx_ušt_t
 
n
);

46 
ngx_s¦_£ssiÚ_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

47 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
);

49 #ifdeà
SSL_CTRL_SET_TLSEXT_TICKET_KEY_CB


50 
ngx_s¦_£ssiÚ_tick‘_key_ÿÎback
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
,

51 *
Çme
, *
iv
, 
EVP_CIPHER_CTX
 *
eùx
,

52 
HMAC_CTX
 *
hùx
, 
’c
);

55 #ià(
OPENSSL_VERSION_NUMBER
 < 0x10002002L || 
defšed
 
LIBRESSL_VERSION_NUMBER
)

56 
ngx_št_t
 
ngx_s¦_check_Çme
(
ngx_¡r_t
 *
Çme
, 
ASN1_STRING
 *
¡r
);

59 *
ngx_Ý’s¦_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

60 *
ngx_Ý’s¦_’gše
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

61 
ngx_Ý’s¦_ex™
(
ngx_cyþe_t
 *
cyþe
);

64 
ngx_commªd_t
 
	gngx_Ý’s¦_commªds
[] = {

66 { 
ngx_¡ršg
("ssl_engine"),

67 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

68 
ngx_Ý’s¦_’gše
,

71 
NULL
 },

73 
ngx_nuÎ_commªd


77 
ngx_cÜe_moduË_t
 
	gngx_Ý’s¦_moduË_ùx
 = {

78 
ngx_¡ršg
("openssl"),

79 
ngx_Ý’s¦_ü—‹_cÚf
,

80 
NULL


84 
ngx_moduË_t
 
	gngx_Ý’s¦_moduË
 = {

85 
NGX_MODULE_V1
,

86 &
ngx_Ý’s¦_moduË_ùx
,

87 
ngx_Ý’s¦_commªds
,

88 
NGX_CORE_MODULE
,

89 
NULL
,

90 
NULL
,

91 
NULL
,

92 
NULL
,

93 
NULL
,

94 
NULL
,

95 
ngx_Ý’s¦_ex™
,

96 
NGX_MODULE_V1_PADDING


100 
	gngx_s¦_cÚÃùiÚ_šdex
;

101 
	gngx_s¦_£rv”_cÚf_šdex
;

102 
	gngx_s¦_£ssiÚ_ÿche_šdex
;

103 
	gngx_s¦_£ssiÚ_tick‘_keys_šdex
;

104 
	gngx_s¦_û¹ifiÿ‹_šdex
;

105 
	gngx_s¦_¡­lšg_šdex
;

108 
ngx_št_t


109 
	$ngx_s¦_š™
(
ngx_log_t
 *
log
)

111 #iâdeà
OPENSSL_IS_BORINGSSL


112 
	`OPENSSL_cÚfig
(
NULL
);

115 
	`SSL_lib¿ry_š™
();

116 
	`SSL_lßd_”rÜ_¡ršgs
();

118 
	`O³nSSL_add_®l_®gÜ™hms
();

120 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090800fL

121 #iâdeà
SSL_OP_NO_COMPRESSION


127 
n
;

128 
	`STACK_OF
(
SSL_COMP
è*
s¦_comp_m‘hods
;

130 
s¦_comp_m‘hods
 = 
	`SSL_COMP_g‘_com´essiÚ_m‘hods
();

131 
n
 = 
	`sk_SSL_COMP_num
(
s¦_comp_m‘hods
);

133 
n
--) {

134 (è
	`sk_SSL_COMP_pÝ
(
s¦_comp_m‘hods
);

140 
ngx_s¦_cÚÃùiÚ_šdex
 = 
	`SSL_g‘_ex_Ãw_šdex
(0, 
NULL
, NULL, NULL, NULL);

142 ià(
ngx_s¦_cÚÃùiÚ_šdex
 == -1) {

143 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0, "SSL_get_ex_new_index() failed");

144  
NGX_ERROR
;

147 
ngx_s¦_£rv”_cÚf_šdex
 = 
	`SSL_CTX_g‘_ex_Ãw_šdex
(0, 
NULL
, NULL, NULL,

148 
NULL
);

149 ià(
ngx_s¦_£rv”_cÚf_šdex
 == -1) {

150 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

152  
NGX_ERROR
;

155 
ngx_s¦_£ssiÚ_ÿche_šdex
 = 
	`SSL_CTX_g‘_ex_Ãw_šdex
(0, 
NULL
, NULL, NULL,

156 
NULL
);

157 ià(
ngx_s¦_£ssiÚ_ÿche_šdex
 == -1) {

158 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

160  
NGX_ERROR
;

163 
ngx_s¦_£ssiÚ_tick‘_keys_šdex
 = 
	`SSL_CTX_g‘_ex_Ãw_šdex
(0, 
NULL
, NULL,

164 
NULL
, NULL);

165 ià(
ngx_s¦_£ssiÚ_tick‘_keys_šdex
 == -1) {

166 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

168  
NGX_ERROR
;

171 
ngx_s¦_û¹ifiÿ‹_šdex
 = 
	`SSL_CTX_g‘_ex_Ãw_šdex
(0, 
NULL
, NULL, NULL,

172 
NULL
);

173 ià(
ngx_s¦_û¹ifiÿ‹_šdex
 == -1) {

174 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

176  
NGX_ERROR
;

179 
ngx_s¦_¡­lšg_šdex
 = 
	`SSL_CTX_g‘_ex_Ãw_šdex
(0, 
NULL
, NULL, NULL,

180 
NULL
);

181 ià(
ngx_s¦_¡­lšg_šdex
 == -1) {

182 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

184  
NGX_ERROR
;

187  
NGX_OK
;

188 
	}
}

191 
ngx_št_t


192 
	$ngx_s¦_ü—‹
(
ngx_s¦_t
 *
s¦
, 
ngx_ušt_t
 
´ÙocÞs
, *
d©a
)

194 
s¦
->
ùx
 = 
	`SSL_CTX_Ãw
(
	`SSLv23_m‘hod
());

196 ià(
s¦
->
ùx
 =ð
NULL
) {

197 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0, "SSL_CTX_new() failed");

198  
NGX_ERROR
;

201 ià(
	`SSL_CTX_£t_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_£rv”_cÚf_šdex
, 
d©a
) == 0) {

202 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

204  
NGX_ERROR
;

207 
s¦
->
bufãr_size
 = 
NGX_SSL_BUFSIZE
;

211 #ifdeà
SSL_OP_MICROSOFT_SESS_ID_BUG


212 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_MICROSOFT_SESS_ID_BUG
);

215 #ifdeà
SSL_OP_NETSCAPE_CHALLENGE_BUG


216 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_NETSCAPE_CHALLENGE_BUG
);

221 #ifdeà
SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG


222 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG
);

225 #ifdeà
SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER


226 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER
);

229 #ifdeà
SSL_OP_MSIE_SSLV2_RSA_PADDING


231 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_MSIE_SSLV2_RSA_PADDING
);

234 #ifdeà
SSL_OP_SSLEAY_080_CLIENT_DH_BUG


235 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_SSLEAY_080_CLIENT_DH_BUG
);

238 #ifdeà
SSL_OP_TLS_D5_BUG


239 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_TLS_D5_BUG
);

242 #ifdeà
SSL_OP_TLS_BLOCK_PADDING_BUG


243 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_TLS_BLOCK_PADDING_BUG
);

246 #ifdeà
SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS


247 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS
);

250 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_SINGLE_DH_USE
);

252 ià(!(
´ÙocÞs
 & 
NGX_SSL_SSLv2
)) {

253 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_NO_SSLv2
);

255 ià(!(
´ÙocÞs
 & 
NGX_SSL_SSLv3
)) {

256 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_NO_SSLv3
);

258 ià(!(
´ÙocÞs
 & 
NGX_SSL_TLSv1
)) {

259 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_NO_TLSv1
);

261 #ifdeà
SSL_OP_NO_TLSv1_1


262 ià(!(
´ÙocÞs
 & 
NGX_SSL_TLSv1_1
)) {

263 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_NO_TLSv1_1
);

266 #ifdeà
SSL_OP_NO_TLSv1_2


267 ià(!(
´ÙocÞs
 & 
NGX_SSL_TLSv1_2
)) {

268 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_NO_TLSv1_2
);

272 #ifdeà
SSL_OP_NO_COMPRESSION


273 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_NO_COMPRESSION
);

276 #ifdeà
SSL_MODE_RELEASE_BUFFERS


277 
	`SSL_CTX_£t_mode
(
s¦
->
ùx
, 
SSL_MODE_RELEASE_BUFFERS
);

280 
	`SSL_CTX_£t_»ad_ah—d
(
s¦
->
ùx
, 1);

282 
	`SSL_CTX_£t_šfo_ÿÎback
(
s¦
->
ùx
, 
ngx_s¦_šfo_ÿÎback
);

284  
NGX_OK
;

285 
	}
}

288 
ngx_št_t


289 
	$ngx_s¦_û¹ifiÿ‹
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
û¹
,

290 
ngx_¡r_t
 *
key
, 
ngx_¬¿y_t
 *
·sswÜds
)

292 
BIO
 *
bio
;

293 
X509
 *
x509
;

294 
u_lÚg
 
n
;

295 
ngx_¡r_t
 *
pwd
;

296 
ngx_ušt_t
 
Œ›s
;

298 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, 
û¹
, 1è!ð
NGX_OK
) {

299  
NGX_ERROR
;

308 
bio
 = 
	`BIO_Ãw_fže
((*è
û¹
->
d©a
, "r");

309 ià(
bio
 =ð
NULL
) {

310 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

311 "BIO_Ãw_fže(\"%s\"èçžed", 
û¹
->
d©a
);

312  
NGX_ERROR
;

315 
x509
 = 
	`PEM_»ad_bio_X509_AUX
(
bio
, 
NULL
, NULL, NULL);

316 ià(
x509
 =ð
NULL
) {

317 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

318 "PEM_»ad_bio_X509_AUX(\"%s\"èçžed", 
û¹
->
d©a
);

319 
	`BIO_ä“
(
bio
);

320  
NGX_ERROR
;

323 ià(
	`SSL_CTX_u£_û¹ifiÿ‹
(
s¦
->
ùx
, 
x509
) == 0) {

324 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

325 "SSL_CTX_u£_û¹ifiÿ‹(\"%s\"èçžed", 
û¹
->
d©a
);

326 
	`X509_ä“
(
x509
);

327 
	`BIO_ä“
(
bio
);

328  
NGX_ERROR
;

331 ià(
	`SSL_CTX_£t_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_û¹ifiÿ‹_šdex
, 
x509
)

334 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

336 
	`X509_ä“
(
x509
);

337 
	`BIO_ä“
(
bio
);

338  
NGX_ERROR
;

341 
	`X509_ä“
(
x509
);

347 
x509
 = 
	`PEM_»ad_bio_X509
(
bio
, 
NULL
, NULL, NULL);

348 ià(
x509
 =ð
NULL
) {

349 
n
 = 
	`ERR_³ek_Ï¡_”rÜ
();

351 ià(
	`ERR_GET_LIB
(
n
è=ð
ERR_LIB_PEM


352 && 
	`ERR_GET_REASON
(
n
è=ð
PEM_R_NO_START_LINE
)

355 
	`ERR_þ—r_”rÜ
();

361 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

362 "PEM_»ad_bio_X509(\"%s\"èçžed", 
û¹
->
d©a
);

363 
	`BIO_ä“
(
bio
);

364  
NGX_ERROR
;

367 ià(
	`SSL_CTX_add_exŒa_chaš_û¹
(
s¦
->
ùx
, 
x509
) == 0) {

368 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

370 
û¹
->
d©a
);

371 
	`X509_ä“
(
x509
);

372 
	`BIO_ä“
(
bio
);

373  
NGX_ERROR
;

377 
	`BIO_ä“
(
bio
);

379 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, 
key
, 1è!ð
NGX_OK
) {

380  
NGX_ERROR
;

383 ià(
·sswÜds
) {

384 
Œ›s
 = 
·sswÜds
->
ÃÉs
;

385 
pwd
 = 
·sswÜds
->
–ts
;

387 
	`SSL_CTX_£t_deçuÉ_·sswd_cb
(
s¦
->
ùx
, 
ngx_s¦_·sswÜd_ÿÎback
);

388 
	`SSL_CTX_£t_deçuÉ_·sswd_cb_u£rd©a
(
s¦
->
ùx
, 
pwd
);

391 
Œ›s
 = 1;

392 #ià(
NGX_SUPPRESS_WARN
)

393 
pwd
 = 
NULL
;

399 ià(
	`SSL_CTX_u£_Priv©eKey_fže
(
s¦
->
ùx
, (*è
key
->
d©a
,

400 
SSL_FILETYPE_PEM
)

406 ià(--
Œ›s
) {

407 
	`ERR_þ—r_”rÜ
();

408 
	`SSL_CTX_£t_deçuÉ_·sswd_cb_u£rd©a
(
s¦
->
ùx
, ++
pwd
);

412 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

413 "SSL_CTX_u£_Priv©eKey_fže(\"%s\"èçžed", 
key
->
d©a
);

414  
NGX_ERROR
;

417 
	`SSL_CTX_£t_deçuÉ_·sswd_cb
(
s¦
->
ùx
, 
NULL
);

419  
NGX_OK
;

420 
	}
}

424 
	$ngx_s¦_·sswÜd_ÿÎback
(*
buf
, 
size
, 
rwæag
, *
u£rd©a
)

426 
ngx_¡r_t
 *
pwd
 = 
u£rd©a
;

428 ià(
rwæag
) {

429 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

434 ià(
pwd
->
Ën
 > (
size_t
è
size
) {

435 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ngx_cyþe
->
log
, 0,

436 "·sswÜd i Œunÿ‹dØ%d by‹s", 
size
);

438 
size
 = 
pwd
->
Ën
;

441 
	`ngx_memýy
(
buf
, 
pwd
->
d©a
, 
size
);

443  
size
;

444 
	}
}

447 
ngx_št_t


448 
	$ngx_s¦_þ›Á_û¹ifiÿ‹
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
û¹
,

449 
ngx_št_t
 
d•th
)

451 
	`STACK_OF
(
X509_NAME
è*
li¡
;

453 
	`SSL_CTX_£t_v”ify
(
s¦
->
ùx
, 
SSL_VERIFY_PEER
, 
ngx_s¦_v”ify_ÿÎback
);

455 
	`SSL_CTX_£t_v”ify_d•th
(
s¦
->
ùx
, 
d•th
);

457 ià(
û¹
->
Ën
 == 0) {

458  
NGX_OK
;

461 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, 
û¹
, 1è!ð
NGX_OK
) {

462  
NGX_ERROR
;

465 ià(
	`SSL_CTX_lßd_v”ify_loÿtiÚs
(
s¦
->
ùx
, (*è
û¹
->
d©a
, 
NULL
)

468 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

470 
û¹
->
d©a
);

471  
NGX_ERROR
;

479 
	`ERR_þ—r_”rÜ
();

481 
li¡
 = 
	`SSL_lßd_þ›Á_CA_fže
((*è
û¹
->
d©a
);

483 ià(
li¡
 =ð
NULL
) {

484 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

485 "SSL_lßd_þ›Á_CA_fže(\"%s\"èçžed", 
û¹
->
d©a
);

486  
NGX_ERROR
;

494 
	`ERR_þ—r_”rÜ
();

496 
	`SSL_CTX_£t_þ›Á_CA_li¡
(
s¦
->
ùx
, 
li¡
);

498  
NGX_OK
;

499 
	}
}

502 
ngx_št_t


503 
	$ngx_s¦_Œu¡ed_û¹ifiÿ‹
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
û¹
,

504 
ngx_št_t
 
d•th
)

506 
	`SSL_CTX_£t_v”ify_d•th
(
s¦
->
ùx
, 
d•th
);

508 ià(
û¹
->
Ën
 == 0) {

509  
NGX_OK
;

512 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, 
û¹
, 1è!ð
NGX_OK
) {

513  
NGX_ERROR
;

516 ià(
	`SSL_CTX_lßd_v”ify_loÿtiÚs
(
s¦
->
ùx
, (*è
û¹
->
d©a
, 
NULL
)

519 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

521 
û¹
->
d©a
);

522  
NGX_ERROR
;

530 
	`ERR_þ—r_”rÜ
();

532  
NGX_OK
;

533 
	}
}

536 
ngx_št_t


537 
	$ngx_s¦_ül
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
ül
)

539 
X509_STORE
 *
¡Üe
;

540 
X509_LOOKUP
 *
lookup
;

542 ià(
ül
->
Ën
 == 0) {

543  
NGX_OK
;

546 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, 
ül
, 1è!ð
NGX_OK
) {

547  
NGX_ERROR
;

550 
¡Üe
 = 
	`SSL_CTX_g‘_û¹_¡Üe
(
s¦
->
ùx
);

552 ià(
¡Üe
 =ð
NULL
) {

553 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

555  
NGX_ERROR
;

558 
lookup
 = 
	`X509_STORE_add_lookup
(
¡Üe
, 
	`X509_LOOKUP_fže
());

560 ià(
lookup
 =ð
NULL
) {

561 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

563  
NGX_ERROR
;

566 ià(
	`X509_LOOKUP_lßd_fže
(
lookup
, (*è
ül
->
d©a
, 
X509_FILETYPE_PEM
)

569 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

570 "X509_LOOKUP_lßd_fže(\"%s\"èçžed", 
ül
->
d©a
);

571  
NGX_ERROR
;

574 
	`X509_STORE_£t_æags
(
¡Üe
,

575 
X509_V_FLAG_CRL_CHECK
|
X509_V_FLAG_CRL_CHECK_ALL
);

577  
NGX_OK
;

578 
	}
}

582 
	$ngx_s¦_v”ify_ÿÎback
(
ok
, 
X509_STORE_CTX
 *
x509_¡Üe
)

584 #ià(
NGX_DEBUG
)

585 *
subjeù
, *
issu”
;

586 
”r
, 
d•th
;

587 
X509
 *
û¹
;

588 
X509_NAME
 *
¢ame
, *
šame
;

589 
ngx_cÚÃùiÚ_t
 *
c
;

590 
ngx_s¦_cÚn_t
 *
s¦_cÚn
;

592 
s¦_cÚn
 = 
	`X509_STORE_CTX_g‘_ex_d©a
(
x509_¡Üe
,

593 
	`SSL_g‘_ex_d©a_X509_STORE_CTX_idx
());

595 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
(
s¦_cÚn
);

597 
û¹
 = 
	`X509_STORE_CTX_g‘_cu¼’t_û¹
(
x509_¡Üe
);

598 
”r
 = 
	`X509_STORE_CTX_g‘_”rÜ
(
x509_¡Üe
);

599 
d•th
 = 
	`X509_STORE_CTX_g‘_”rÜ_d•th
(
x509_¡Üe
);

601 
¢ame
 = 
	`X509_g‘_subjeù_Çme
(
û¹
);

602 
subjeù
 = 
¢ame
 ? 
	`X509_NAME_Ú–še
(¢ame, 
NULL
, 0) : "(none)";

604 
šame
 = 
	`X509_g‘_issu”_Çme
(
û¹
);

605 
issu”
 = 
šame
 ? 
	`X509_NAME_Ú–še
(šame, 
NULL
, 0) : "(none)";

607 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

610 
ok
, 
”r
, 
d•th
, 
subjeù
, 
issu”
);

612 ià(
¢ame
) {

613 
	`OPENSSL_ä“
(
subjeù
);

616 ià(
šame
) {

617 
	`OPENSSL_ä“
(
issu”
);

622 
	}
}

626 
	$ngx_s¦_šfo_ÿÎback
(cÚ¡ 
ngx_s¦_cÚn_t
 *
s¦_cÚn
, 
wh”e
, 
»t
)

628 
BIO
 *
rbio
, *
wbio
;

629 
ngx_cÚÃùiÚ_t
 *
c
;

631 ià(
wh”e
 & 
SSL_CB_HANDSHAKE_START
) {

632 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
((
ngx_s¦_cÚn_t
 *è
s¦_cÚn
);

634 ià(
c
->
s¦
->
hªdshaked
) {

635 
c
->
s¦
->
»ÃgÙŸtiÚ
 = 1;

636 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSL„enegotiation");

640 ià((
wh”e
 & 
SSL_CB_ACCEPT_LOOP
) == SSL_CB_ACCEPT_LOOP) {

641 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
((
ngx_s¦_cÚn_t
 *è
s¦_cÚn
);

643 ià(!
c
->
s¦
->
hªdshake_bufãr_£t
) {

655 
rbio
 = 
	`SSL_g‘_rbio
((
ngx_s¦_cÚn_t
 *è
s¦_cÚn
);

656 
wbio
 = 
	`SSL_g‘_wbio
((
ngx_s¦_cÚn_t
 *è
s¦_cÚn
);

658 ià(
rbio
 !ð
wbio
) {

659 (è
	`BIO_£t_wr™e_bufãr_size
(
wbio
, 
NGX_SSL_BUFSIZE
);

660 
c
->
s¦
->
hªdshake_bufãr_£t
 = 1;

664 
	}
}

667 
RSA
 *

668 
	$ngx_s¦_r§512_key_ÿÎback
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
, 
is_expÜt
,

669 
key_Ëngth
)

671 
RSA
 *
key
;

673 ià(
key_Ëngth
 != 512) {

674  
NULL
;

677 #iâdeà
OPENSSL_NO_DEPRECATED


679 ià(
key
 =ð
NULL
) {

680 
key
 = 
	`RSA_g’”©e_key
(512, 
RSA_F4
, 
NULL
, NULL);

685  
key
;

686 
	}
}

689 
ngx_¬¿y_t
 *

690 
	$ngx_s¦_»ad_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
fže
)

692 
u_ch¬
 *
p
, *
Ï¡
, *
’d
;

693 
size_t
 
Ën
;

694 
ssize_t
 
n
;

695 
ngx_fd_t
 
fd
;

696 
ngx_¡r_t
 *
pwd
;

697 
ngx_¬¿y_t
 *
·sswÜds
;

698 
ngx_poÞ_þ—nup_t
 *
þn
;

699 
u_ch¬
 
buf
[
NGX_SSL_PASSWORD_BUFFER_SIZE
];

701 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, 
fže
, 1è!ð
NGX_OK
) {

702  
NULL
;

705 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
‹mp_poÞ
, 0);

706 
·sswÜds
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
‹mp_poÞ
, 4, (
ngx_¡r_t
));

708 ià(
þn
 =ð
NULL
 || 
·sswÜds
 == NULL) {

709  
NULL
;

712 
þn
->
hªdËr
 = 
ngx_s¦_·sswÜds_þ—nup
;

713 
þn
->
d©a
 = 
·sswÜds
;

715 
fd
 = 
	`ngx_Ý’_fže
(
fže
->
d©a
, 
NGX_FILE_RDONLY
, 
NGX_FILE_OPEN
, 0);

716 ià(
fd
 =ð
NGX_INVALID_FILE
) {

717 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 
ngx_”ºo
,

718 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
fže
->
d©a
);

719  
NULL
;

722 
Ën
 = 0;

723 
Ï¡
 = 
buf
;

726 
n
 = 
	`ngx_»ad_fd
(
fd
, 
Ï¡
, 
NGX_SSL_PASSWORD_BUFFER_SIZE
 - 
Ën
);

728 ià(
n
 == -1) {

729 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 
ngx_”ºo
,

730 
ngx_»ad_fd_n
 " \"%s\" fažed", 
fže
->
d©a
);

731 
·sswÜds
 = 
NULL
;

732 
þ—nup
;

735 
’d
 = 
Ï¡
 + 
n
;

737 ià(
Ën
 && 
n
 == 0) {

738 *
’d
++ = 
LF
;

741 
p
 = 
buf
;

744 
Ï¡
 = 
	`ngx_¡¾chr
Öa¡, 
’d
, 
LF
);

746 ià(
Ï¡
 =ð
NULL
) {

750 
Ën
 = 
Ï¡
++ - 
p
;

752 ià(
Ën
 && 
p
[ËÀ- 1] =ð
CR
) {

753 
Ën
--;

756 ià(
Ën
) {

757 
pwd
 = 
	`ngx_¬¿y_push
(
·sswÜds
);

758 ià(
pwd
 =ð
NULL
) {

759 
·sswÜds
 = 
NULL
;

760 
þ—nup
;

763 
pwd
->
Ën
 =†en;

764 
pwd
->
d©a
 = 
	`ngx_²®loc
(
cf
->
‹mp_poÞ
, 
Ën
);

766 ià(
pwd
->
d©a
 =ð
NULL
) {

767 
·sswÜds
->
ÃÉs
--;

768 
·sswÜds
 = 
NULL
;

769 
þ—nup
;

772 
	`ngx_memýy
(
pwd
->
d©a
, 
p
, 
Ën
);

775 
p
 = 
Ï¡
;

778 
Ën
 = 
’d
 - 
p
;

780 ià(
Ën
 =ð
NGX_SSL_PASSWORD_BUFFER_SIZE
) {

781 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

782 "toØlÚg†šš \"%s\"", 
fže
->
d©a
);

783 
·sswÜds
 = 
NULL
;

784 
þ—nup
;

787 
	`ngx_memmove
(
buf
, 
p
, 
Ën
);

788 
Ï¡
 = 
buf
 + 
Ën
;

790 } 
n
 != 0);

792 ià(
·sswÜds
->
ÃÉs
 == 0) {

793 
pwd
 = 
	`ngx_¬¿y_push
(
·sswÜds
);

794 ià(
pwd
 =ð
NULL
) {

795 
·sswÜds
 = 
NULL
;

796 
þ—nup
;

799 
	`ngx_memz”o
(
pwd
, (
ngx_¡r_t
));

802 
þ—nup
:

804 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

805 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
, 
ngx_”ºo
,

806 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fže
->
d©a
);

809 
	`ngx_memz”o
(
buf
, 
NGX_SSL_PASSWORD_BUFFER_SIZE
);

811  
·sswÜds
;

812 
	}
}

816 
	$ngx_s¦_·sswÜds_þ—nup
(*
d©a
)

818 
ngx_¬¿y_t
 *
·sswÜds
 = 
d©a
;

820 
ngx_¡r_t
 *
pwd
;

821 
ngx_ušt_t
 
i
;

823 
pwd
 = 
·sswÜds
->
–ts
;

825 
i
 = 0; i < 
·sswÜds
->
ÃÉs
; i++) {

826 
	`ngx_memz”o
(
pwd
[
i
].
d©a
,…wd[i].
Ën
);

828 
	}
}

831 
ngx_št_t


832 
	$ngx_s¦_dh·¿m
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
fže
)

834 
DH
 *
dh
;

835 
BIO
 *
bio
;

845 
dh1024_p
[] = {

859 
dh1024_g
[] = { 0x02 };

862 ià(
fže
->
Ën
 == 0) {

864 
dh
 = 
	`DH_Ãw
();

865 ià(
dh
 =ð
NULL
) {

866 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0, "DH_new() failed");

867  
NGX_ERROR
;

870 
dh
->
p
 = 
	`BN_bš2bn
(
dh1024_p
, (dh1024_p), 
NULL
);

871 
dh
->
g
 = 
	`BN_bš2bn
(
dh1024_g
, (dh1024_g), 
NULL
);

873 ià(
dh
->
p
 =ð
NULL
 || dh->
g
 == NULL) {

874 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0, "BN_bin2bn() failed");

875 
	`DH_ä“
(
dh
);

876  
NGX_ERROR
;

879 
	`SSL_CTX_£t_tmp_dh
(
s¦
->
ùx
, 
dh
);

881 
	`DH_ä“
(
dh
);

883  
NGX_OK
;

886 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, 
fže
, 1è!ð
NGX_OK
) {

887  
NGX_ERROR
;

890 
bio
 = 
	`BIO_Ãw_fže
((*è
fže
->
d©a
, "r");

891 ià(
bio
 =ð
NULL
) {

892 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

893 "BIO_Ãw_fže(\"%s\"èçžed", 
fže
->
d©a
);

894  
NGX_ERROR
;

897 
dh
 = 
	`PEM_»ad_bio_DH·¿ms
(
bio
, 
NULL
, NULL, NULL);

898 ià(
dh
 =ð
NULL
) {

899 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

900 "PEM_»ad_bio_DH·¿ms(\"%s\"èçžed", 
fže
->
d©a
);

901 
	`BIO_ä“
(
bio
);

902  
NGX_ERROR
;

905 
	`SSL_CTX_£t_tmp_dh
(
s¦
->
ùx
, 
dh
);

907 
	`DH_ä“
(
dh
);

908 
	`BIO_ä“
(
bio
);

910  
NGX_OK
;

911 
	}
}

914 
ngx_št_t


915 
	$ngx_s¦_ecdh_curve
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
Çme
)

917 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090800fL

918 #iâdeà
OPENSSL_NO_ECDH


919 
nid
;

920 
EC_KEY
 *
ecdh
;

929 
nid
 = 
	`OBJ_¢2nid
((cÚ¡ *è
Çme
->
d©a
);

930 ià(
nid
 == 0) {

931 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

932 "UnknowÀcurvÇm\"%s\"", 
Çme
->
d©a
);

933  
NGX_ERROR
;

936 
ecdh
 = 
	`EC_KEY_Ãw_by_curve_Çme
(
nid
);

937 ià(
ecdh
 =ð
NULL
) {

938 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

939 "UÇbËØü—‹ curv\"%s\"", 
Çme
->
d©a
);

940  
NGX_ERROR
;

943 
	`SSL_CTX_£t_ÝtiÚs
(
s¦
->
ùx
, 
SSL_OP_SINGLE_ECDH_USE
);

945 
	`SSL_CTX_£t_tmp_ecdh
(
s¦
->
ùx
, 
ecdh
);

947 
	`EC_KEY_ä“
(
ecdh
);

951  
NGX_OK
;

952 
	}
}

955 
ngx_št_t


956 
	$ngx_s¦_ü—‹_cÚÃùiÚ
(
ngx_s¦_t
 *
s¦
, 
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
æags
)

958 
ngx_s¦_cÚÃùiÚ_t
 *
sc
;

960 
sc
 = 
	`ngx_pÿÎoc
(
c
->
poÞ
, (
ngx_s¦_cÚÃùiÚ_t
));

961 ià(
sc
 =ð
NULL
) {

962  
NGX_ERROR
;

965 
sc
->
bufãr
 = ((
æags
 & 
NGX_SSL_BUFFER
) != 0);

966 
sc
->
bufãr_size
 = 
s¦
->buffer_size;

968 
sc
->
cÚÃùiÚ
 = 
	`SSL_Ãw
(
s¦
->
ùx
);

970 ià(
sc
->
cÚÃùiÚ
 =ð
NULL
) {

971 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "SSL_new() failed");

972  
NGX_ERROR
;

975 ià(
	`SSL_£t_fd
(
sc
->
cÚÃùiÚ
, 
c
->
fd
) == 0) {

976 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "SSL_set_fd() failed");

977  
NGX_ERROR
;

980 ià(
æags
 & 
NGX_SSL_CLIENT
) {

981 
	`SSL_£t_cÚÃù_¡©e
(
sc
->
cÚÃùiÚ
);

984 
	`SSL_£t_acû±_¡©e
(
sc
->
cÚÃùiÚ
);

987 ià(
	`SSL_£t_ex_d©a
(
sc
->
cÚÃùiÚ
, 
ngx_s¦_cÚÃùiÚ_šdex
, 
c
) == 0) {

988 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "SSL_set_ex_data() failed");

989  
NGX_ERROR
;

992 
c
->
s¦
 = 
sc
;

994  
NGX_OK
;

995 
	}
}

998 
ngx_št_t


999 
	$ngx_s¦_£t_£ssiÚ
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_s¦_£ssiÚ_t
 *
£ssiÚ
)

1001 ià(
£ssiÚ
) {

1002 ià(
	`SSL_£t_£ssiÚ
(
c
->
s¦
->
cÚÃùiÚ
, 
£ssiÚ
) == 0) {

1003 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "SSL_set_session() failed");

1004  
NGX_ERROR
;

1008  
NGX_OK
;

1009 
	}
}

1012 
ngx_št_t


1013 
	$ngx_s¦_hªdshake
(
ngx_cÚÃùiÚ_t
 *
c
)

1015 
n
, 
s¦”r
;

1016 
ngx_”r_t
 
”r
;

1018 
	`ngx_s¦_þ—r_”rÜ
(
c
->
log
);

1020 
n
 = 
	`SSL_do_hªdshake
(
c
->
s¦
->
cÚÃùiÚ
);

1022 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSL_do_hªdshake: %d", 
n
);

1024 ià(
n
 == 1) {

1026 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

1027  
NGX_ERROR
;

1030 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

1031  
NGX_ERROR
;

1034 #ià(
NGX_DEBUG
)

1036 
buf
[129], *
s
, *
d
;

1037 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10000000L

1040 
SSL_CIPHER
 *
ch”
;

1042 
ch”
 = 
	`SSL_g‘_cu¼’t_ch”
(
c
->
s¦
->
cÚÃùiÚ
);

1044 ià(
ch”
) {

1045 
	`SSL_CIPHER_desütiÚ
(
ch”
, &
buf
[1], 128);

1047 
s
 = &
buf
[1], 
d
 = buf; *s; s++) {

1048 ià(*
s
 =ð' ' && *
d
 == ' ') {

1052 ià(*
s
 =ð
LF
 || * =ð
CR
) {

1056 *++
d
 = *
s
;

1059 ià(*
d
 != ' ') {

1060 
d
++;

1063 *
d
 = '\0';

1065 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

1067 
	`SSL_g‘_v”siÚ
(
c
->
s¦
->
cÚÃùiÚ
), &
buf
[1]);

1069 ià(
	`SSL_£ssiÚ_»u£d
(
c
->
s¦
->
cÚÃùiÚ
)) {

1070 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

1075 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

1081 
c
->
s¦
->
hªdshaked
 = 1;

1083 
c
->
»cv
 = 
ngx_s¦_»cv
;

1084 
c
->
£nd
 = 
ngx_s¦_wr™e
;

1085 
c
->
»cv_chaš
 = 
ngx_s¦_»cv_chaš
;

1086 
c
->
£nd_chaš
 = 
ngx_s¦_£nd_chaš
;

1089 ià(
c
->
s¦
->
cÚÃùiÚ
->
s3
) {

1090 
c
->
s¦
->
cÚÃùiÚ
->
s3
->
æags
 |ð
SSL3_FLAGS_NO_RENEGOTIATE_CIPHERS
;

1093  
NGX_OK
;

1096 
s¦”r
 = 
	`SSL_g‘_”rÜ
(
c
->
s¦
->
cÚÃùiÚ
, 
n
);

1098 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSL_g‘_”rÜ: %d", 
s¦”r
);

1100 ià(
s¦”r
 =ð
SSL_ERROR_WANT_READ
) {

1101 
c
->
»ad
->
»ady
 = 0;

1102 
c
->
»ad
->
hªdËr
 = 
ngx_s¦_hªdshake_hªdËr
;

1103 
c
->
wr™e
->
hªdËr
 = 
ngx_s¦_hªdshake_hªdËr
;

1105 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

1106  
NGX_ERROR
;

1109 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

1110  
NGX_ERROR
;

1113  
NGX_AGAIN
;

1116 ià(
s¦”r
 =ð
SSL_ERROR_WANT_WRITE
) {

1117 
c
->
wr™e
->
»ady
 = 0;

1118 
c
->
»ad
->
hªdËr
 = 
ngx_s¦_hªdshake_hªdËr
;

1119 
c
->
wr™e
->
hªdËr
 = 
ngx_s¦_hªdshake_hªdËr
;

1121 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

1122  
NGX_ERROR
;

1125 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

1126  
NGX_ERROR
;

1129  
NGX_AGAIN
;

1132 
”r
 = (
s¦”r
 =ð
SSL_ERROR_SYSCALL
è? 
ngx_”ºo
 : 0;

1134 
c
->
s¦
->
no_wa™_shutdown
 = 1;

1135 
c
->
s¦
->
no_£nd_shutdown
 = 1;

1136 
c
->
»ad
->
eof
 = 1;

1138 ià(
s¦”r
 =ð
SSL_ERROR_ZERO_RETURN
 || 
	`ERR_³ek_”rÜ
() == 0) {

1139 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
,

1142  
NGX_ERROR
;

1145 
c
->
»ad
->
”rÜ
 = 1;

1147 
	`ngx_s¦_cÚÃùiÚ_”rÜ
(
c
, 
s¦”r
, 
”r
, "SSL_do_handshake() failed");

1149  
NGX_ERROR
;

1150 
	}
}

1154 
	$ngx_s¦_hªdshake_hªdËr
(
ngx_ev’t_t
 *
ev
)

1156 
ngx_cÚÃùiÚ_t
 *
c
;

1158 
c
 = 
ev
->
d©a
;

1160 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

1161 "SSL hªdshakhªdËr: %d", 
ev
->
wr™e
);

1163 ià(
ev
->
timedout
) {

1164 
c
->
s¦
->
	`hªdËr
(c);

1168 ià(
	`ngx_s¦_hªdshake
(
c
è=ð
NGX_AGAIN
) {

1172 
c
->
s¦
->
	`hªdËr
(c);

1173 
	}
}

1176 
ssize_t


1177 
	$ngx_s¦_»cv_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
þ
, 
off_t
 
lim™
)

1179 
u_ch¬
 *
Ï¡
;

1180 
ssize_t
 
n
, 
by‹s
, 
size
;

1181 
ngx_buf_t
 *
b
;

1183 
by‹s
 = 0;

1185 
b
 = 
þ
->
buf
;

1186 
Ï¡
 = 
b
->last;

1189 
size
 = 
b
->
’d
 - 
Ï¡
;

1191 ià(
lim™
) {

1192 ià(
by‹s
 >ð
lim™
) {

1193  
by‹s
;

1196 ià(
by‹s
 + 
size
 > 
lim™
) {

1197 
size
 = (
ssize_t
è(
lim™
 - 
by‹s
);

1201 
n
 = 
	`ngx_s¦_»cv
(
c
, 
Ï¡
, 
size
);

1203 ià(
n
 > 0) {

1204 
Ï¡
 +ð
n
;

1205 
by‹s
 +ð
n
;

1207 ià(
Ï¡
 =ð
b
->
’d
) {

1208 
þ
 = cl->
Ãxt
;

1210 ià(
þ
 =ð
NULL
) {

1211  
by‹s
;

1214 
b
 = 
þ
->
buf
;

1215 
Ï¡
 = 
b
->last;

1221 ià(
by‹s
) {

1223 ià(
n
 =ð0 ||‚ =ð
NGX_ERROR
) {

1224 
c
->
»ad
->
»ady
 = 1;

1227  
by‹s
;

1230  
n
;

1232 
	}
}

1235 
ssize_t


1236 
	$ngx_s¦_»cv
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, 
size_t
 
size
)

1238 
n
, 
by‹s
;

1240 ià(
c
->
s¦
->
Ï¡
 =ð
NGX_ERROR
) {

1241 
c
->
»ad
->
”rÜ
 = 1;

1242  
NGX_ERROR
;

1245 ià(
c
->
s¦
->
Ï¡
 =ð
NGX_DONE
) {

1246 
c
->
»ad
->
»ady
 = 0;

1247 
c
->
»ad
->
eof
 = 1;

1251 
by‹s
 = 0;

1253 
	`ngx_s¦_þ—r_”rÜ
(
c
->
log
);

1262 
n
 = 
	`SSL_»ad
(
c
->
s¦
->
cÚÃùiÚ
, 
buf
, 
size
);

1264 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSL_»ad: %d", 
n
);

1266 ià(
n
 > 0) {

1267 
by‹s
 +ð
n
;

1270 
c
->
s¦
->
Ï¡
 = 
	`ngx_s¦_hªdË_»cv
(c, 
n
);

1272 ià(
c
->
s¦
->
Ï¡
 =ð
NGX_OK
) {

1274 
size
 -ð
n
;

1276 ià(
size
 == 0) {

1277 
c
->
»ad
->
»ady
 = 1;

1278  
by‹s
;

1281 
buf
 +ð
n
;

1286 ià(
by‹s
) {

1287 ià(
c
->
s¦
->
Ï¡
 !ð
NGX_AGAIN
) {

1288 
c
->
»ad
->
»ady
 = 1;

1291  
by‹s
;

1294 
c
->
s¦
->
Ï¡
) {

1296 
NGX_DONE
:

1297 
c
->
»ad
->
»ady
 = 0;

1298 
c
->
»ad
->
eof
 = 1;

1301 
NGX_ERROR
:

1302 
c
->
»ad
->
”rÜ
 = 1;

1306 
NGX_AGAIN
:

1307  
c
->
s¦
->
Ï¡
;

1310 
	}
}

1313 
ngx_št_t


1314 
	$ngx_s¦_hªdË_»cv
(
ngx_cÚÃùiÚ_t
 *
c
, 
n
)

1316 
s¦”r
;

1317 
ngx_”r_t
 
”r
;

1319 ià(
c
->
s¦
->
»ÃgÙŸtiÚ
) {

1326 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
c
->
log
, 0, "SSL„enegotiation disabled");

1328 
	`ERR_³ek_”rÜ
()) {

1329 
	`ngx_s¦_”rÜ
(
NGX_LOG_DEBUG
, 
c
->
log
, 0,

1333 
	`ERR_þ—r_”rÜ
();

1335 
c
->
s¦
->
no_wa™_shutdown
 = 1;

1336 
c
->
s¦
->
no_£nd_shutdown
 = 1;

1338  
NGX_ERROR
;

1341 ià(
n
 > 0) {

1343 ià(
c
->
s¦
->
§ved_wr™e_hªdËr
) {

1345 
c
->
wr™e
->
hªdËr
 = c->
s¦
->
§ved_wr™e_hªdËr
;

1346 
c
->
s¦
->
§ved_wr™e_hªdËr
 = 
NULL
;

1347 
c
->
wr™e
->
»ady
 = 1;

1349 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

1350  
NGX_ERROR
;

1353 
	`ngx_po¡_ev’t
(
c
->
wr™e
, &
ngx_po¡ed_ev’ts
);

1356  
NGX_OK
;

1359 
s¦”r
 = 
	`SSL_g‘_”rÜ
(
c
->
s¦
->
cÚÃùiÚ
, 
n
);

1361 
”r
 = (
s¦”r
 =ð
SSL_ERROR_SYSCALL
è? 
ngx_”ºo
 : 0;

1363 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSL_g‘_”rÜ: %d", 
s¦”r
);

1365 ià(
s¦”r
 =ð
SSL_ERROR_WANT_READ
) {

1366 
c
->
»ad
->
»ady
 = 0;

1367  
NGX_AGAIN
;

1370 ià(
s¦”r
 =ð
SSL_ERROR_WANT_WRITE
) {

1372 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1375 
c
->
wr™e
->
»ady
 = 0;

1377 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

1378  
NGX_ERROR
;

1385 ià(
c
->
s¦
->
§ved_wr™e_hªdËr
 =ð
NULL
) {

1386 
c
->
s¦
->
§ved_wr™e_hªdËr
 = c->
wr™e
->
hªdËr
;

1387 
c
->
wr™e
->
hªdËr
 = 
ngx_s¦_wr™e_hªdËr
;

1390  
NGX_AGAIN
;

1393 
c
->
s¦
->
no_wa™_shutdown
 = 1;

1394 
c
->
s¦
->
no_£nd_shutdown
 = 1;

1396 ià(
s¦”r
 =ð
SSL_ERROR_ZERO_RETURN
 || 
	`ERR_³ek_”rÜ
() == 0) {

1397 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

1399  
NGX_DONE
;

1402 
	`ngx_s¦_cÚÃùiÚ_”rÜ
(
c
, 
s¦”r
, 
”r
, "SSL_read() failed");

1404  
NGX_ERROR
;

1405 
	}
}

1409 
	$ngx_s¦_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
)

1411 
ngx_cÚÃùiÚ_t
 *
c
;

1413 
c
 = 
wev
->
d©a
;

1415 
c
->
»ad
->
	`hªdËr
(c->read);

1416 
	}
}

1427 
ngx_chaš_t
 *

1428 
	$ngx_s¦_£nd_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
)

1430 
n
;

1431 
ngx_ušt_t
 
æush
;

1432 
ssize_t
 
£nd
, 
size
;

1433 
ngx_buf_t
 *
buf
;

1435 ià(!
c
->
s¦
->
bufãr
) {

1437 
š
) {

1438 ià(
	`ngx_buf_¥ecŸl
(
š
->
buf
)) {

1439 
š
 = in->
Ãxt
;

1443 
n
 = 
	`ngx_s¦_wr™e
(
c
, 
š
->
buf
->
pos
, in->buf->
Ï¡
 - in->buf->pos);

1445 ià(
n
 =ð
NGX_ERROR
) {

1446  
NGX_CHAIN_ERROR
;

1449 ià(
n
 =ð
NGX_AGAIN
) {

1450  
š
;

1453 
š
->
buf
->
pos
 +ð
n
;

1454 
c
->
£Á
 +ð
n
;

1456 ià(
š
->
buf
->
pos
 =ðš->buf->
Ï¡
) {

1457 
š
 = in->
Ãxt
;

1461  
š
;

1467 ià(
lim™
 =ð0 ||†im™ > (
off_t
è(
NGX_MAX_INT32_VALUE
 - 
ngx_·gesize
)) {

1468 
lim™
 = 
NGX_MAX_INT32_VALUE
 - 
ngx_·gesize
;

1471 
buf
 = 
c
->
s¦
->buf;

1473 ià(
buf
 =ð
NULL
) {

1474 
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
c
->
poÞ
, c->
s¦
->
bufãr_size
);

1475 ià(
buf
 =ð
NULL
) {

1476  
NGX_CHAIN_ERROR
;

1479 
c
->
s¦
->
buf
 = buf;

1482 ià(
buf
->
¡¬t
 =ð
NULL
) {

1483 
buf
->
¡¬t
 = 
	`ngx_·Îoc
(
c
->
poÞ
, c->
s¦
->
bufãr_size
);

1484 ià(
buf
->
¡¬t
 =ð
NULL
) {

1485  
NGX_CHAIN_ERROR
;

1488 
buf
->
pos
 = buf->
¡¬t
;

1489 
buf
->
Ï¡
 = buf->
¡¬t
;

1490 
buf
->
’d
 = buf->
¡¬t
 + 
c
->
s¦
->
bufãr_size
;

1493 
£nd
 = 
buf
->
Ï¡
 - buf->
pos
;

1494 
æush
 = (
š
 =ð
NULL
è? 1 : 
buf
->flush;

1498 
š
 && 
buf
->
Ï¡
 < buf->
’d
 && 
£nd
 < 
lim™
) {

1499 ià(
š
->
buf
->
Ï¡_buf
 || in->buf->
æush
) {

1500 
æush
 = 1;

1503 ià(
	`ngx_buf_¥ecŸl
(
š
->
buf
)) {

1504 
š
 = in->
Ãxt
;

1508 
size
 = 
š
->
buf
->
Ï¡
 - in->buf->
pos
;

1510 ià(
size
 > 
buf
->
’d
 - buf->
Ï¡
) {

1511 
size
 = 
buf
->
’d
 - buf->
Ï¡
;

1514 ià(
£nd
 + 
size
 > 
lim™
) {

1515 
size
 = (
ssize_t
è(
lim™
 - 
£nd
);

1518 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

1519 "SSL buàcÝy: %d", 
size
);

1521 
	`ngx_memýy
(
buf
->
Ï¡
, 
š
->buf->
pos
, 
size
);

1523 
buf
->
Ï¡
 +ð
size
;

1524 
š
->
buf
->
pos
 +ð
size
;

1525 
£nd
 +ð
size
;

1527 ià(
š
->
buf
->
pos
 =ðš->buf->
Ï¡
) {

1528 
š
 = in->
Ãxt
;

1532 ià(!
æush
 && 
£nd
 < 
lim™
 && 
buf
->
Ï¡
 < buf->
’d
) {

1536 
size
 = 
buf
->
Ï¡
 - buf->
pos
;

1538 ià(
size
 == 0) {

1539 
buf
->
æush
 = 0;

1540 
c
->
bufã»d
 &ð~
NGX_SSL_BUFFERED
;

1541  
š
;

1544 
n
 = 
	`ngx_s¦_wr™e
(
c
, 
buf
->
pos
, 
size
);

1546 ià(
n
 =ð
NGX_ERROR
) {

1547  
NGX_CHAIN_ERROR
;

1550 ià(
n
 =ð
NGX_AGAIN
) {

1554 
buf
->
pos
 +ð
n
;

1555 
c
->
£Á
 +ð
n
;

1557 ià(
n
 < 
size
) {

1561 
æush
 = 0;

1563 
buf
->
pos
 = buf->
¡¬t
;

1564 
buf
->
Ï¡
 = buf->
¡¬t
;

1566 ià(
š
 =ð
NULL
 || 
£nd
 =ð
lim™
) {

1571 
buf
->
æush
 = flush;

1573 ià(
buf
->
pos
 < buf->
Ï¡
) {

1574 
c
->
bufã»d
 |ð
NGX_SSL_BUFFERED
;

1577 
c
->
bufã»d
 &ð~
NGX_SSL_BUFFERED
;

1580  
š
;

1581 
	}
}

1584 
ssize_t


1585 
	$ngx_s¦_wr™e
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
d©a
, 
size_t
 
size
)

1587 
n
, 
s¦”r
;

1588 
ngx_”r_t
 
”r
;

1590 
	`ngx_s¦_þ—r_”rÜ
(
c
->
log
);

1592 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSLØwr™e: %d", 
size
);

1594 
n
 = 
	`SSL_wr™e
(
c
->
s¦
->
cÚÃùiÚ
, 
d©a
, 
size
);

1596 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSL_wr™e: %d", 
n
);

1598 ià(
n
 > 0) {

1600 ià(
c
->
s¦
->
§ved_»ad_hªdËr
) {

1602 
c
->
»ad
->
hªdËr
 = c->
s¦
->
§ved_»ad_hªdËr
;

1603 
c
->
s¦
->
§ved_»ad_hªdËr
 = 
NULL
;

1604 
c
->
»ad
->
»ady
 = 1;

1606 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

1607  
NGX_ERROR
;

1610 
	`ngx_po¡_ev’t
(
c
->
»ad
, &
ngx_po¡ed_ev’ts
);

1613  
n
;

1616 
s¦”r
 = 
	`SSL_g‘_”rÜ
(
c
->
s¦
->
cÚÃùiÚ
, 
n
);

1618 
”r
 = (
s¦”r
 =ð
SSL_ERROR_SYSCALL
è? 
ngx_”ºo
 : 0;

1620 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSL_g‘_”rÜ: %d", 
s¦”r
);

1622 ià(
s¦”r
 =ð
SSL_ERROR_WANT_WRITE
) {

1623 
c
->
wr™e
->
»ady
 = 0;

1624  
NGX_AGAIN
;

1627 ià(
s¦”r
 =ð
SSL_ERROR_WANT_READ
) {

1629 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1632 
c
->
»ad
->
»ady
 = 0;

1634 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

1635  
NGX_ERROR
;

1643 ià(
c
->
s¦
->
§ved_»ad_hªdËr
 =ð
NULL
) {

1644 
c
->
s¦
->
§ved_»ad_hªdËr
 = c->
»ad
->
hªdËr
;

1645 
c
->
»ad
->
hªdËr
 = 
ngx_s¦_»ad_hªdËr
;

1648  
NGX_AGAIN
;

1651 
c
->
s¦
->
no_wa™_shutdown
 = 1;

1652 
c
->
s¦
->
no_£nd_shutdown
 = 1;

1653 
c
->
wr™e
->
”rÜ
 = 1;

1655 
	`ngx_s¦_cÚÃùiÚ_”rÜ
(
c
, 
s¦”r
, 
”r
, "SSL_write() failed");

1657  
NGX_ERROR
;

1658 
	}
}

1662 
	$ngx_s¦_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
)

1664 
ngx_cÚÃùiÚ_t
 *
c
;

1666 
c
 = 
»v
->
d©a
;

1668 
c
->
wr™e
->
	`hªdËr
(c->write);

1669 
	}
}

1673 
	$ngx_s¦_ä“_bufãr
(
ngx_cÚÃùiÚ_t
 *
c
)

1675 ià(
c
->
s¦
->
buf
 && c->s¦->buf->
¡¬t
) {

1676 ià(
	`ngx_pä“
(
c
->
poÞ
, c->
s¦
->
buf
->
¡¬t
è=ð
NGX_OK
) {

1677 
c
->
s¦
->
buf
->
¡¬t
 = 
NULL
;

1680 
	}
}

1683 
ngx_št_t


1684 
	$ngx_s¦_shutdown
(
ngx_cÚÃùiÚ_t
 *
c
)

1686 
n
, 
s¦”r
, 
mode
;

1687 
ngx_”r_t
 
”r
;

1689 ià(
c
->
timedout
) {

1690 
mode
 = 
SSL_RECEIVED_SHUTDOWN
|
SSL_SENT_SHUTDOWN
;

1691 
	`SSL_£t_qu›t_shutdown
(
c
->
s¦
->
cÚÃùiÚ
, 1);

1694 
mode
 = 
	`SSL_g‘_shutdown
(
c
->
s¦
->
cÚÃùiÚ
);

1696 ià(
c
->
s¦
->
no_wa™_shutdown
) {

1697 
mode
 |ð
SSL_RECEIVED_SHUTDOWN
;

1700 ià(
c
->
s¦
->
no_£nd_shutdown
) {

1701 
mode
 |ð
SSL_SENT_SHUTDOWN
;

1704 ià(
c
->
s¦
->
no_wa™_shutdown
 && c->s¦->
no_£nd_shutdown
) {

1705 
	`SSL_£t_qu›t_shutdown
(
c
->
s¦
->
cÚÃùiÚ
, 1);

1709 
	`SSL_£t_shutdown
(
c
->
s¦
->
cÚÃùiÚ
, 
mode
);

1711 
	`ngx_s¦_þ—r_”rÜ
(
c
->
log
);

1713 
n
 = 
	`SSL_shutdown
(
c
->
s¦
->
cÚÃùiÚ
);

1715 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "SSL_shutdown: %d", 
n
);

1717 
s¦”r
 = 0;

1721 ià(
n
 !ð1 && 
	`ERR_³ek_”rÜ
()) {

1722 
s¦”r
 = 
	`SSL_g‘_”rÜ
(
c
->
s¦
->
cÚÃùiÚ
, 
n
);

1724 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

1725 "SSL_g‘_”rÜ: %d", 
s¦”r
);

1728 ià(
n
 =ð1 || 
s¦”r
 =ð0 || s¦”¸=ð
SSL_ERROR_ZERO_RETURN
) {

1729 
	`SSL_ä“
(
c
->
s¦
->
cÚÃùiÚ
);

1730 
c
->
s¦
 = 
NULL
;

1732  
NGX_OK
;

1735 ià(
s¦”r
 =ð
SSL_ERROR_WANT_READ
 || s¦”¸=ð
SSL_ERROR_WANT_WRITE
) {

1736 
c
->
»ad
->
hªdËr
 = 
ngx_s¦_shutdown_hªdËr
;

1737 
c
->
wr™e
->
hªdËr
 = 
ngx_s¦_shutdown_hªdËr
;

1739 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

1740  
NGX_ERROR
;

1743 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

1744  
NGX_ERROR
;

1747 ià(
s¦”r
 =ð
SSL_ERROR_WANT_READ
) {

1748 
	`ngx_add_tim”
(
c
->
»ad
, 30000);

1751  
NGX_AGAIN
;

1754 
”r
 = (
s¦”r
 =ð
SSL_ERROR_SYSCALL
è? 
ngx_”ºo
 : 0;

1756 
	`ngx_s¦_cÚÃùiÚ_”rÜ
(
c
, 
s¦”r
, 
”r
, "SSL_shutdown() failed");

1758 
	`SSL_ä“
(
c
->
s¦
->
cÚÃùiÚ
);

1759 
c
->
s¦
 = 
NULL
;

1761  
NGX_ERROR
;

1762 
	}
}

1766 
	$ngx_s¦_shutdown_hªdËr
(
ngx_ev’t_t
 *
ev
)

1768 
ngx_cÚÃùiÚ_t
 *
c
;

1769 
ngx_cÚÃùiÚ_hªdËr_±
 
hªdËr
;

1771 
c
 = 
ev
->
d©a
;

1772 
hªdËr
 = 
c
->
s¦
->handler;

1774 ià(
ev
->
timedout
) {

1775 
c
->
timedout
 = 1;

1778 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0, "SSL shutdown handler");

1780 ià(
	`ngx_s¦_shutdown
(
c
è=ð
NGX_AGAIN
) {

1784 
	`hªdËr
(
c
);

1785 
	}
}

1789 
	$ngx_s¦_cÚÃùiÚ_”rÜ
(
ngx_cÚÃùiÚ_t
 *
c
, 
s¦”r
, 
ngx_”r_t
 
”r
,

1790 *
‹xt
)

1792 
n
;

1793 
ngx_ušt_t
 
Ëv–
;

1795 
Ëv–
 = 
NGX_LOG_CRIT
;

1797 ià(
s¦”r
 =ð
SSL_ERROR_SYSCALL
) {

1799 ià(
”r
 =ð
NGX_ECONNRESET


1800 || 
”r
 =ð
NGX_EPIPE


1801 || 
”r
 =ð
NGX_ENOTCONN


1802 || 
”r
 =ð
NGX_ETIMEDOUT


1803 || 
”r
 =ð
NGX_ECONNREFUSED


1804 || 
”r
 =ð
NGX_ENETDOWN


1805 || 
”r
 =ð
NGX_ENETUNREACH


1806 || 
”r
 =ð
NGX_EHOSTDOWN


1807 || 
”r
 =ð
NGX_EHOSTUNREACH
)

1809 
c
->
log_”rÜ
) {

1811 
NGX_ERROR_IGNORE_ECONNRESET
:

1812 
NGX_ERROR_INFO
:

1813 
Ëv–
 = 
NGX_LOG_INFO
;

1816 
NGX_ERROR_ERR
:

1817 
Ëv–
 = 
NGX_LOG_ERR
;

1825 } ià(
s¦”r
 =ð
SSL_ERROR_SSL
) {

1827 
n
 = 
	`ERR_GET_REASON
(
	`ERR_³ek_”rÜ
());

1830 ià(
n
 =ð
SSL_R_BAD_CHANGE_CIPHER_SPEC


1831 || 
n
 =ð
SSL_R_BLOCK_CIPHER_PAD_IS_WRONG


1832 || 
n
 =ð
SSL_R_DIGEST_CHECK_FAILED


1833 || 
n
 =ð
SSL_R_ERROR_IN_RECEIVED_CIPHER_LIST


1834 || 
n
 =ð
SSL_R_EXCESSIVE_MESSAGE_SIZE


1835 || 
n
 =ð
SSL_R_LENGTH_MISMATCH


1836 || 
n
 =ð
SSL_R_NO_CIPHERS_PASSED


1837 || 
n
 =ð
SSL_R_NO_CIPHERS_SPECIFIED


1838 || 
n
 =ð
SSL_R_NO_COMPRESSION_SPECIFIED


1839 || 
n
 =ð
SSL_R_NO_SHARED_CIPHER


1840 || 
n
 =ð
SSL_R_RECORD_LENGTH_MISMATCH


1841 #ifdeà
SSL_R_PARSE_TLSEXT


1842 || 
n
 =ð
SSL_R_PARSE_TLSEXT


1844 || 
n
 =ð
SSL_R_UNEXPECTED_MESSAGE


1845 || 
n
 =ð
SSL_R_UNEXPECTED_RECORD


1846 || 
n
 =ð
SSL_R_UNKNOWN_ALERT_TYPE


1847 || 
n
 =ð
SSL_R_UNKNOWN_PROTOCOL


1848 || 
n
 =ð
SSL_R_WRONG_VERSION_NUMBER


1849 || 
n
 =ð
SSL_R_DECRYPTION_FAILED_OR_BAD_RECORD_MAC


1850 #ifdeà
SSL_R_RENEGOTIATE_EXT_TOO_LONG


1851 || 
n
 =ð
SSL_R_RENEGOTIATE_EXT_TOO_LONG


1852 || 
n
 =ð
SSL_R_RENEGOTIATION_ENCODING_ERR


1853 || 
n
 =ð
SSL_R_RENEGOTIATION_MISMATCH


1855 #ifdeà
SSL_R_UNSAFE_LEGACY_RENEGOTIATION_DISABLED


1856 || 
n
 =ð
SSL_R_UNSAFE_LEGACY_RENEGOTIATION_DISABLED


1858 #ifdeà
SSL_R_SCSV_RECEIVED_WHEN_RENEGOTIATING


1859 || 
n
 =ð
SSL_R_SCSV_RECEIVED_WHEN_RENEGOTIATING


1861 #ifdeà
SSL_R_INAPPROPRIATE_FALLBACK


1862 || 
n
 =ð
SSL_R_INAPPROPRIATE_FALLBACK


1864 || 
n
 == 1000

1865 || 
n
 =ð
SSL_R_SSLV3_ALERT_UNEXPECTED_MESSAGE


1866 || 
n
 =ð
SSL_R_SSLV3_ALERT_BAD_RECORD_MAC


1867 || 
n
 =ð
SSL_R_TLSV1_ALERT_DECRYPTION_FAILED


1868 || 
n
 =ð
SSL_R_TLSV1_ALERT_RECORD_OVERFLOW


1869 || 
n
 =ð
SSL_R_SSLV3_ALERT_DECOMPRESSION_FAILURE


1870 || 
n
 =ð
SSL_R_SSLV3_ALERT_HANDSHAKE_FAILURE


1871 || 
n
 =ð
SSL_R_SSLV3_ALERT_NO_CERTIFICATE


1872 || 
n
 =ð
SSL_R_SSLV3_ALERT_BAD_CERTIFICATE


1873 || 
n
 =ð
SSL_R_SSLV3_ALERT_UNSUPPORTED_CERTIFICATE


1874 || 
n
 =ð
SSL_R_SSLV3_ALERT_CERTIFICATE_REVOKED


1875 || 
n
 =ð
SSL_R_SSLV3_ALERT_CERTIFICATE_EXPIRED


1876 || 
n
 =ð
SSL_R_SSLV3_ALERT_CERTIFICATE_UNKNOWN


1877 || 
n
 =ð
SSL_R_SSLV3_ALERT_ILLEGAL_PARAMETER


1878 || 
n
 =ð
SSL_R_TLSV1_ALERT_UNKNOWN_CA


1879 || 
n
 =ð
SSL_R_TLSV1_ALERT_ACCESS_DENIED


1880 || 
n
 =ð
SSL_R_TLSV1_ALERT_DECODE_ERROR


1881 || 
n
 =ð
SSL_R_TLSV1_ALERT_DECRYPT_ERROR


1882 || 
n
 =ð
SSL_R_TLSV1_ALERT_EXPORT_RESTRICTION


1883 || 
n
 =ð
SSL_R_TLSV1_ALERT_PROTOCOL_VERSION


1884 || 
n
 =ð
SSL_R_TLSV1_ALERT_INSUFFICIENT_SECURITY


1885 || 
n
 =ð
SSL_R_TLSV1_ALERT_INTERNAL_ERROR


1886 || 
n
 =ð
SSL_R_TLSV1_ALERT_USER_CANCELLED


1887 || 
n
 =ð
SSL_R_TLSV1_ALERT_NO_RENEGOTIATION
)

1889 
c
->
log_”rÜ
) {

1891 
NGX_ERROR_IGNORE_ECONNRESET
:

1892 
NGX_ERROR_INFO
:

1893 
Ëv–
 = 
NGX_LOG_INFO
;

1896 
NGX_ERROR_ERR
:

1897 
Ëv–
 = 
NGX_LOG_ERR
;

1906 
	`ngx_s¦_”rÜ
(
Ëv–
, 
c
->
log
, 
”r
, 
‹xt
);

1907 
	}
}

1911 
	$ngx_s¦_þ—r_”rÜ
(
ngx_log_t
 *
log
)

1913 
	`ERR_³ek_”rÜ
()) {

1914 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0, "ignoring stale global SSLƒrror");

1917 
	`ERR_þ—r_”rÜ
();

1918 
	}
}

1921 
ngx_cdeþ


1922 
	$ngx_s¦_”rÜ
(
ngx_ušt_t
 
Ëv–
, 
ngx_log_t
 *
log
, 
ngx_”r_t
 
”r
, *
fmt
, ...)

1924 
æags
;

1925 
u_lÚg
 
n
;

1926 
va_li¡
 
¬gs
;

1927 
u_ch¬
 *
p
, *
Ï¡
;

1928 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

1929 cÚ¡ *
d©a
;

1931 
Ï¡
 = 
”r¡r
 + 
NGX_MAX_CONF_ERRSTR
;

1933 
	`va_¡¬t
(
¬gs
, 
fmt
);

1934 
p
 = 
	`ngx_v¦´štf
(
”r¡r
, 
Ï¡
 - 1, 
fmt
, 
¬gs
);

1935 
	`va_’d
(
¬gs
);

1937 
p
 = 
	`ngx_ýy¡º
Õ, (
u_ch¬
 *è" (SSL:", 
Ï¡
 -…);

1941 
n
 = 
	`ERR_³ek_”rÜ_lše_d©a
(
NULL
, NULL, &
d©a
, &
æags
);

1943 ià(
n
 == 0) {

1947 ià(
p
 >ð
Ï¡
) {

1948 
Ãxt
;

1951 *
p
++ = ' ';

1953 
	`ERR_”rÜ_¡ršg_n
(
n
, (*è
p
, 
Ï¡
 -…);

1955 
p
 < 
Ï¡
 && *p) {

1956 
p
++;

1959 ià(
p
 < 
Ï¡
 && *
d©a
 && (
æags
 & 
ERR_TXT_STRING
)) {

1960 *
p
++ = ':';

1961 
p
 = 
	`ngx_ýy¡º
Õ, (
u_ch¬
 *è
d©a
, 
Ï¡
 -…);

1964 
Ãxt
:

1966 (è
	`ERR_g‘_”rÜ
();

1969 
	`ngx_log_”rÜ
(
Ëv–
, 
log
, 
”r
, "%s)", 
”r¡r
);

1970 
	}
}

1973 
ngx_št_t


1974 
	$ngx_s¦_£ssiÚ_ÿche
(
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
£ss_ùx
,

1975 
ssize_t
 
bužtš_£ssiÚ_ÿche
, 
ngx_shm_zÚe_t
 *
shm_zÚe
, 
time_t
 
timeout
)

1977 
ÿche_mode
;

1979 
	`SSL_CTX_£t_timeout
(
s¦
->
ùx
, (è
timeout
);

1981 ià(
	`ngx_s¦_£ssiÚ_id_cÚ‹xt
(
s¦
, 
£ss_ùx
è!ð
NGX_OK
) {

1982  
NGX_ERROR
;

1985 ià(
bužtš_£ssiÚ_ÿche
 =ð
NGX_SSL_NO_SCACHE
) {

1986 
	`SSL_CTX_£t_£ssiÚ_ÿche_mode
(
s¦
->
ùx
, 
SSL_SESS_CACHE_OFF
);

1987  
NGX_OK
;

1990 ià(
bužtš_£ssiÚ_ÿche
 =ð
NGX_SSL_NONE_SCACHE
) {

2003 
	`SSL_CTX_£t_£ssiÚ_ÿche_mode
(
s¦
->
ùx
,

2004 
SSL_SESS_CACHE_SERVER


2005 |
SSL_SESS_CACHE_NO_AUTO_CLEAR


2006 |
SSL_SESS_CACHE_NO_INTERNAL_STORE
);

2008 
	`SSL_CTX_£ss_£t_ÿche_size
(
s¦
->
ùx
, 1);

2010  
NGX_OK
;

2013 
ÿche_mode
 = 
SSL_SESS_CACHE_SERVER
;

2015 ià(
shm_zÚe
 && 
bužtš_£ssiÚ_ÿche
 =ð
NGX_SSL_NO_BUILTIN_SCACHE
) {

2016 
ÿche_mode
 |ð
SSL_SESS_CACHE_NO_INTERNAL
;

2019 
	`SSL_CTX_£t_£ssiÚ_ÿche_mode
(
s¦
->
ùx
, 
ÿche_mode
);

2021 ià(
bužtš_£ssiÚ_ÿche
 !ð
NGX_SSL_NO_BUILTIN_SCACHE
) {

2023 ià(
bužtš_£ssiÚ_ÿche
 !ð
NGX_SSL_DFLT_BUILTIN_SCACHE
) {

2024 
	`SSL_CTX_£ss_£t_ÿche_size
(
s¦
->
ùx
, 
bužtš_£ssiÚ_ÿche
);

2028 ià(
shm_zÚe
) {

2029 
	`SSL_CTX_£ss_£t_Ãw_cb
(
s¦
->
ùx
, 
ngx_s¦_Ãw_£ssiÚ
);

2030 
	`SSL_CTX_£ss_£t_g‘_cb
(
s¦
->
ùx
, 
ngx_s¦_g‘_ÿched_£ssiÚ
);

2031 
	`SSL_CTX_£ss_£t_»move_cb
(
s¦
->
ùx
, 
ngx_s¦_»move_£ssiÚ
);

2033 ià(
	`SSL_CTX_£t_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_£ssiÚ_ÿche_šdex
, 
shm_zÚe
)

2036 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2038  
NGX_ERROR
;

2042  
NGX_OK
;

2043 
	}
}

2046 
ngx_št_t


2047 
	$ngx_s¦_£ssiÚ_id_cÚ‹xt
(
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
£ss_ùx
)

2049 
n
, 
i
;

2050 
X509
 *
û¹
;

2051 
X509_NAME
 *
Çme
;

2052 
EVP_MD_CTX
 
md
;

2053 
Ën
;

2054 
	`STACK_OF
(
X509_NAME
è*
li¡
;

2055 
u_ch¬
 
buf
[
EVP_MAX_MD_SIZE
];

2062 
	`EVP_MD_CTX_š™
(&
md
);

2064 ià(
	`EVP_Dige¡In™_ex
(&
md
, 
	`EVP_sha1
(), 
NULL
) == 0) {

2065 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2067 
çžed
;

2070 ià(
	`EVP_Dige¡Upd©e
(&
md
, 
£ss_ùx
->
d©a
, sess_ùx->
Ën
) == 0) {

2071 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2073 
çžed
;

2076 
û¹
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_û¹ifiÿ‹_šdex
);

2078 ià(
	`X509_dige¡
(
û¹
, 
	`EVP_sha1
(), 
buf
, &
Ën
) == 0) {

2079 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2081 
çžed
;

2084 ià(
	`EVP_Dige¡Upd©e
(&
md
, 
buf
, 
Ën
) == 0) {

2085 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2087 
çžed
;

2090 
li¡
 = 
	`SSL_CTX_g‘_þ›Á_CA_li¡
(
s¦
->
ùx
);

2092 ià(
li¡
 !ð
NULL
) {

2093 
n
 = 
	`sk_X509_NAME_num
(
li¡
);

2095 
i
 = 0; i < 
n
; i++) {

2096 
Çme
 = 
	`sk_X509_NAME_v®ue
(
li¡
, 
i
);

2098 ià(
	`X509_NAME_dige¡
(
Çme
, 
	`EVP_sha1
(), 
buf
, &
Ën
) == 0) {

2099 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2101 
çžed
;

2104 ià(
	`EVP_Dige¡Upd©e
(&
md
, 
buf
, 
Ën
) == 0) {

2105 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2107 
çžed
;

2112 ià(
	`EVP_Dige¡Fš®_ex
(&
md
, 
buf
, &
Ën
) == 0) {

2113 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2115 
çžed
;

2118 
	`EVP_MD_CTX_þ—nup
(&
md
);

2120 ià(
	`SSL_CTX_£t_£ssiÚ_id_cÚ‹xt
(
s¦
->
ùx
, 
buf
, 
Ën
) == 0) {

2121 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2123  
NGX_ERROR
;

2126  
NGX_OK
;

2128 
çžed
:

2130 
	`EVP_MD_CTX_þ—nup
(&
md
);

2132  
NGX_ERROR
;

2133 
	}
}

2136 
ngx_št_t


2137 
	$ngx_s¦_£ssiÚ_ÿche_š™
(
ngx_shm_zÚe_t
 *
shm_zÚe
, *
d©a
)

2139 
size_t
 
Ën
;

2140 
ngx_¦ab_poÞ_t
 *
shpoÞ
;

2141 
ngx_s¦_£ssiÚ_ÿche_t
 *
ÿche
;

2143 ià(
d©a
) {

2144 
shm_zÚe
->
d©a
 = data;

2145  
NGX_OK
;

2148 
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
shm_zÚe
->
shm
.
addr
;

2150 ià(
shm_zÚe
->
shm
.
exi¡s
) {

2151 
shm_zÚe
->
d©a
 = 
shpoÞ
->data;

2152  
NGX_OK
;

2155 
ÿche
 = 
	`ngx_¦ab_®loc
(
shpoÞ
, (
ngx_s¦_£ssiÚ_ÿche_t
));

2156 ià(
ÿche
 =ð
NULL
) {

2157  
NGX_ERROR
;

2160 
shpoÞ
->
d©a
 = 
ÿche
;

2161 
shm_zÚe
->
d©a
 = 
ÿche
;

2163 
	`ngx_rbŒ“_š™
(&
ÿche
->
£ssiÚ_rbŒ“
, &ÿche->
£Áš–
,

2164 
ngx_s¦_£ssiÚ_rbŒ“_š£¹_v®ue
);

2166 
	`ngx_queue_š™
(&
ÿche
->
expœe_queue
);

2168 
Ën
 = (" iÀSSL sessiÚ sh¬ed cach\"\""è+ 
shm_zÚe
->
shm
.
Çme
.len;

2170 
shpoÞ
->
log_ùx
 = 
	`ngx_¦ab_®loc
(shpoÞ, 
Ën
);

2171 ià(
shpoÞ
->
log_ùx
 =ð
NULL
) {

2172  
NGX_ERROR
;

2175 
	`ngx_¥rštf
(
shpoÞ
->
log_ùx
, " in SSL session shared cache \"%V\"%Z",

2176 &
shm_zÚe
->
shm
.
Çme
);

2178 
shpoÞ
->
log_nomem
 = 0;

2180  
NGX_OK
;

2181 
	}
}

2202 
	$ngx_s¦_Ãw_£ssiÚ
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
, 
ngx_s¦_£ssiÚ_t
 *
£ss
)

2204 
Ën
;

2205 
u_ch¬
 *
p
, *
id
, *
ÿched_£ss
, *
£ssiÚ_id
;

2206 
ušt32_t
 
hash
;

2207 
SSL_CTX
 *
s¦_ùx
;

2208 
£ssiÚ_id_Ëngth
;

2209 
ngx_shm_zÚe_t
 *
shm_zÚe
;

2210 
ngx_cÚÃùiÚ_t
 *
c
;

2211 
ngx_¦ab_poÞ_t
 *
shpoÞ
;

2212 
ngx_s¦_£ss_id_t
 *
£ss_id
;

2213 
ngx_s¦_£ssiÚ_ÿche_t
 *
ÿche
;

2214 
u_ch¬
 
buf
[
NGX_SSL_MAX_SESSION_SIZE
];

2216 
Ën
 = 
	`i2d_SSL_SESSION
(
£ss
, 
NULL
);

2220 ià(
Ën
 > (è
NGX_SSL_MAX_SESSION_SIZE
) {

2224 
p
 = 
buf
;

2225 
	`i2d_SSL_SESSION
(
£ss
, &
p
);

2227 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
(
s¦_cÚn
);

2229 
s¦_ùx
 = 
	`SSL_g‘_SSL_CTX
(
s¦_cÚn
);

2230 
shm_zÚe
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦_ùx
, 
ngx_s¦_£ssiÚ_ÿche_šdex
);

2232 
ÿche
 = 
shm_zÚe
->
d©a
;

2233 
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
shm_zÚe
->
shm
.
addr
;

2235 
	`ngx_shmtx_lock
(&
shpoÞ
->
mu‹x
);

2238 
	`ngx_s¦_expœe_£ssiÚs
(
ÿche
, 
shpoÞ
, 1);

2240 
ÿched_£ss
 = 
	`ngx_¦ab_®loc_locked
(
shpoÞ
, 
Ën
);

2242 ià(
ÿched_£ss
 =ð
NULL
) {

2246 
	`ngx_s¦_expœe_£ssiÚs
(
ÿche
, 
shpoÞ
, 0);

2248 
ÿched_£ss
 = 
	`ngx_¦ab_®loc_locked
(
shpoÞ
, 
Ën
);

2250 ià(
ÿched_£ss
 =ð
NULL
) {

2251 
£ss_id
 = 
NULL
;

2252 
çžed
;

2256 
£ss_id
 = 
	`ngx_¦ab_®loc_locked
(
shpoÞ
, (
ngx_s¦_£ss_id_t
));

2258 ià(
£ss_id
 =ð
NULL
) {

2262 
	`ngx_s¦_expœe_£ssiÚs
(
ÿche
, 
shpoÞ
, 0);

2264 
£ss_id
 = 
	`ngx_¦ab_®loc_locked
(
shpoÞ
, (
ngx_s¦_£ss_id_t
));

2266 ià(
£ss_id
 =ð
NULL
) {

2267 
çžed
;

2271 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090800fL

2273 
£ssiÚ_id
 = (
u_ch¬
 *è
	`SSL_SESSION_g‘_id
(
£ss
, &
£ssiÚ_id_Ëngth
);

2277 
£ssiÚ_id
 = 
£ss
->session_id;

2278 
£ssiÚ_id_Ëngth
 = 
£ss
->session_id_length;

2282 #ià(
NGX_PTR_SIZE
 == 8)

2284 
id
 = 
£ss_id
->sess_id;

2288 
id
 = 
	`ngx_¦ab_®loc_locked
(
shpoÞ
, 
£ssiÚ_id_Ëngth
);

2290 ià(
id
 =ð
NULL
) {

2294 
	`ngx_s¦_expœe_£ssiÚs
(
ÿche
, 
shpoÞ
, 0);

2296 
id
 = 
	`ngx_¦ab_®loc_locked
(
shpoÞ
, 
£ssiÚ_id_Ëngth
);

2298 ià(
id
 =ð
NULL
) {

2299 
çžed
;

2305 
	`ngx_memýy
(
ÿched_£ss
, 
buf
, 
Ën
);

2307 
	`ngx_memýy
(
id
, 
£ssiÚ_id
, 
£ssiÚ_id_Ëngth
);

2309 
hash
 = 
	`ngx_üc32_shÜt
(
£ssiÚ_id
, 
£ssiÚ_id_Ëngth
);

2311 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2313 
hash
, 
£ssiÚ_id_Ëngth
, 
Ën
);

2315 
£ss_id
->
node
.
key
 = 
hash
;

2316 
£ss_id
->
node
.
d©a
 = (
u_ch¬
è
£ssiÚ_id_Ëngth
;

2317 
£ss_id
->
id
 = id;

2318 
£ss_id
->
Ën
 =†en;

2319 
£ss_id
->
£ssiÚ
 = 
ÿched_£ss
;

2321 
£ss_id
->
expœe
 = 
	`ngx_time
(è+ 
	`SSL_CTX_g‘_timeout
(
s¦_ùx
);

2323 
	`ngx_queue_š£¹_h—d
(&
ÿche
->
expœe_queue
, &
£ss_id
->
queue
);

2325 
	`ngx_rbŒ“_š£¹
(&
ÿche
->
£ssiÚ_rbŒ“
, &
£ss_id
->
node
);

2327 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

2331 
çžed
:

2333 ià(
ÿched_£ss
) {

2334 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
ÿched_£ss
);

2337 ià(
£ss_id
) {

2338 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
);

2341 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

2343 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

2344 "could‚Ù‡Îoÿ‹‚ew sessiÚ%s", 
shpoÞ
->
log_ùx
);

2347 
	}
}

2350 
ngx_s¦_£ssiÚ_t
 *

2351 
	$ngx_s¦_g‘_ÿched_£ssiÚ
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
, 
u_ch¬
 *
id
, 
Ën
,

2352 *
cÝy
)

2354 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090707fL

2357 
u_ch¬
 *
p
;

2358 
ušt32_t
 
hash
;

2359 
ngx_št_t
 
rc
;

2360 
ngx_shm_zÚe_t
 *
shm_zÚe
;

2361 
ngx_¦ab_poÞ_t
 *
shpoÞ
;

2362 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

2363 
ngx_s¦_£ssiÚ_t
 *
£ss
;

2364 
ngx_s¦_£ss_id_t
 *
£ss_id
;

2365 
ngx_s¦_£ssiÚ_ÿche_t
 *
ÿche
;

2366 
u_ch¬
 
buf
[
NGX_SSL_MAX_SESSION_SIZE
];

2367 #ià(
NGX_DEBUG
)

2368 
ngx_cÚÃùiÚ_t
 *
c
;

2371 
hash
 = 
	`ngx_üc32_shÜt
(
id
, (
size_t
è
Ën
);

2372 *
cÝy
 = 0;

2374 #ià(
NGX_DEBUG
)

2375 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
(
s¦_cÚn
);

2377 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2378 "s¦ g‘ sessiÚ: %08XD:%d", 
hash
, 
Ën
);

2381 
shm_zÚe
 = 
	`SSL_CTX_g‘_ex_d©a
(
	`SSL_g‘_SSL_CTX
(
s¦_cÚn
),

2382 
ngx_s¦_£ssiÚ_ÿche_šdex
);

2384 
ÿche
 = 
shm_zÚe
->
d©a
;

2386 
£ss
 = 
NULL
;

2388 
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
shm_zÚe
->
shm
.
addr
;

2390 
	`ngx_shmtx_lock
(&
shpoÞ
->
mu‹x
);

2392 
node
 = 
ÿche
->
£ssiÚ_rbŒ“
.
roÙ
;

2393 
£Áš–
 = 
ÿche
->
£ssiÚ_rbŒ“
.sentinel;

2395 
node
 !ð
£Áš–
) {

2397 ià(
hash
 < 
node
->
key
) {

2398 
node
 =‚ode->
Ëá
;

2402 ià(
hash
 > 
node
->
key
) {

2403 
node
 =‚ode->
right
;

2409 
£ss_id
 = (
ngx_s¦_£ss_id_t
 *è
node
;

2411 
rc
 = 
	`ngx_memn2cmp
(
id
, 
£ss_id
->id, (
size_t
è
Ën
, (size_tè
node
->
d©a
);

2413 ià(
rc
 == 0) {

2415 ià(
£ss_id
->
expœe
 > 
	`ngx_time
()) {

2416 
	`ngx_memýy
(
buf
, 
£ss_id
->
£ssiÚ
, sess_id->
Ën
);

2418 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

2420 
p
 = 
buf
;

2421 
£ss
 = 
	`d2i_SSL_SESSION
(
NULL
, &
p
, 
£ss_id
->
Ën
);

2423  
£ss
;

2426 
	`ngx_queue_»move
(&
£ss_id
->
queue
);

2428 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
£ssiÚ_rbŒ“
, 
node
);

2430 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
->
£ssiÚ
);

2431 #ià(
NGX_PTR_SIZE
 == 4)

2432 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
->
id
);

2434 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
);

2436 
£ss
 = 
NULL
;

2438 
dÚe
;

2441 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

2444 
dÚe
:

2446 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

2448  
£ss
;

2449 
	}
}

2453 
	$ngx_s¦_»move_ÿched_£ssiÚ
(
SSL_CTX
 *
s¦
, 
ngx_s¦_£ssiÚ_t
 *
£ss
)

2455 
	`SSL_CTX_»move_£ssiÚ
(
s¦
, 
£ss
);

2457 
	`ngx_s¦_»move_£ssiÚ
(
s¦
, 
£ss
);

2458 
	}
}

2462 
	$ngx_s¦_»move_£ssiÚ
(
SSL_CTX
 *
s¦
, 
ngx_s¦_£ssiÚ_t
 *
£ss
)

2464 
u_ch¬
 *
id
;

2465 
ušt32_t
 
hash
;

2466 
ngx_št_t
 
rc
;

2467 
Ën
;

2468 
ngx_shm_zÚe_t
 *
shm_zÚe
;

2469 
ngx_¦ab_poÞ_t
 *
shpoÞ
;

2470 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

2471 
ngx_s¦_£ss_id_t
 *
£ss_id
;

2472 
ngx_s¦_£ssiÚ_ÿche_t
 *
ÿche
;

2474 
shm_zÚe
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦
, 
ngx_s¦_£ssiÚ_ÿche_šdex
);

2476 ià(
shm_zÚe
 =ð
NULL
) {

2480 
ÿche
 = 
shm_zÚe
->
d©a
;

2482 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090800fL

2484 
id
 = (
u_ch¬
 *è
	`SSL_SESSION_g‘_id
(
£ss
, &
Ën
);

2488 
id
 = 
£ss
->
£ssiÚ_id
;

2489 
Ën
 = 
£ss
->
£ssiÚ_id_Ëngth
;

2493 
hash
 = 
	`ngx_üc32_shÜt
(
id
, 
Ën
);

2495 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ngx_cyþe
->
log
, 0,

2496 "s¦„emov£ssiÚ: %08XD:%ud", 
hash
, 
Ën
);

2498 
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
shm_zÚe
->
shm
.
addr
;

2500 
	`ngx_shmtx_lock
(&
shpoÞ
->
mu‹x
);

2502 
node
 = 
ÿche
->
£ssiÚ_rbŒ“
.
roÙ
;

2503 
£Áš–
 = 
ÿche
->
£ssiÚ_rbŒ“
.sentinel;

2505 
node
 !ð
£Áš–
) {

2507 ià(
hash
 < 
node
->
key
) {

2508 
node
 =‚ode->
Ëá
;

2512 ià(
hash
 > 
node
->
key
) {

2513 
node
 =‚ode->
right
;

2519 
£ss_id
 = (
ngx_s¦_£ss_id_t
 *è
node
;

2521 
rc
 = 
	`ngx_memn2cmp
(
id
, 
£ss_id
->id, 
Ën
, (
size_t
è
node
->
d©a
);

2523 ià(
rc
 == 0) {

2525 
	`ngx_queue_»move
(&
£ss_id
->
queue
);

2527 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
£ssiÚ_rbŒ“
, 
node
);

2529 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
->
£ssiÚ
);

2530 #ià(
NGX_PTR_SIZE
 == 4)

2531 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
->
id
);

2533 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
);

2535 
dÚe
;

2538 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

2541 
dÚe
:

2543 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

2544 
	}
}

2548 
	$ngx_s¦_expœe_£ssiÚs
(
ngx_s¦_£ssiÚ_ÿche_t
 *
ÿche
,

2549 
ngx_¦ab_poÞ_t
 *
shpoÞ
, 
ngx_ušt_t
 
n
)

2551 
time_t
 
now
;

2552 
ngx_queue_t
 *
q
;

2553 
ngx_s¦_£ss_id_t
 *
£ss_id
;

2555 
now
 = 
	`ngx_time
();

2557 
n
 < 3) {

2559 ià(
	`ngx_queue_em±y
(&
ÿche
->
expœe_queue
)) {

2563 
q
 = 
	`ngx_queue_Ï¡
(&
ÿche
->
expœe_queue
);

2565 
£ss_id
 = 
	`ngx_queue_d©a
(
q
, 
ngx_s¦_£ss_id_t
, 
queue
);

2567 ià(
n
++ !ð0 && 
£ss_id
->
expœe
 > 
now
) {

2571 
	`ngx_queue_»move
(
q
);

2573 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
ngx_cyþe
->
log
, 0,

2574 "expœ£ssiÚ: %08Xi", 
£ss_id
->
node
.
key
);

2576 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
£ssiÚ_rbŒ“
, &
£ss_id
->
node
);

2578 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
->
£ssiÚ
);

2579 #ià(
NGX_PTR_SIZE
 == 4)

2580 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
->
id
);

2582 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
£ss_id
);

2584 
	}
}

2588 
	$ngx_s¦_£ssiÚ_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

2589 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
)

2591 
ngx_rbŒ“_node_t
 **
p
;

2592 
ngx_s¦_£ss_id_t
 *
£ss_id
, *
£ss_id_‹mp
;

2596 ià(
node
->
key
 < 
‹mp
->key) {

2598 
p
 = &
‹mp
->
Ëá
;

2600 } ià(
node
->
key
 > 
‹mp
->key) {

2602 
p
 = &
‹mp
->
right
;

2606 
£ss_id
 = (
ngx_s¦_£ss_id_t
 *è
node
;

2607 
£ss_id_‹mp
 = (
ngx_s¦_£ss_id_t
 *è
‹mp
;

2609 
p
 = (
	`ngx_memn2cmp
(
£ss_id
->
id
, 
£ss_id_‹mp
->id,

2610 (
size_t
è
node
->
d©a
, (size_tè
‹mp
->data)

2611 < 0è? &
‹mp
->
Ëá
 : &‹mp->
right
;

2614 ià(*
p
 =ð
£Áš–
) {

2618 
‹mp
 = *
p
;

2621 *
p
 = 
node
;

2622 
node
->
·»Á
 = 
‹mp
;

2623 
node
->
Ëá
 = 
£Áš–
;

2624 
node
->
right
 = 
£Áš–
;

2625 
	`ngx_rbt_»d
(
node
);

2626 
	}
}

2629 #ifdeà
SSL_CTRL_SET_TLSEXT_TICKET_KEY_CB


2631 
ngx_št_t


2632 
	$ngx_s¦_£ssiÚ_tick‘_keys
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¬¿y_t
 *
·ths
)

2634 
u_ch¬
 
buf
[48];

2635 
ssize_t
 
n
;

2636 
ngx_¡r_t
 *
·th
;

2637 
ngx_fže_t
 
fže
;

2638 
ngx_ušt_t
 
i
;

2639 
ngx_¬¿y_t
 *
keys
;

2640 
ngx_fže_šfo_t
 
fi
;

2641 
ngx_s¦_£ssiÚ_tick‘_key_t
 *
key
;

2643 ià(
·ths
 =ð
NULL
) {

2644  
NGX_OK
;

2647 
keys
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 
·ths
->
ÃÉs
,

2648 (
ngx_s¦_£ssiÚ_tick‘_key_t
));

2649 ià(
keys
 =ð
NULL
) {

2650  
NGX_ERROR
;

2653 
·th
 = 
·ths
->
–ts
;

2654 
i
 = 0; i < 
·ths
->
ÃÉs
; i++) {

2656 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
·th
[
i
], 1è!ð
NGX_OK
) {

2657  
NGX_ERROR
;

2660 
	`ngx_memz”o
(&
fže
, (
ngx_fže_t
));

2661 
fže
.
Çme
 = 
·th
[
i
];

2662 
fže
.
log
 = 
cf
->log;

2664 
fže
.
fd
 = 
	`ngx_Ý’_fže
(fže.
Çme
.
d©a
, 
NGX_FILE_RDONLY
, 0, 0);

2665 ià(
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

2666 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 
ngx_”ºo
,

2667 
ngx_Ý’_fže_n
 " \"%V\" fažed", &
fže
.
Çme
);

2668  
NGX_ERROR
;

2671 ià(
	`ngx_fd_šfo
(
fže
.
fd
, &
fi
è=ð
NGX_FILE_ERROR
) {

2672 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
, 
ngx_”ºo
,

2673 
ngx_fd_šfo_n
 " \"%V\" fažed", &
fže
.
Çme
);

2674 
çžed
;

2677 ià(
	`ngx_fže_size
(&
fi
) != 48) {

2678 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2679 "\"%V\" mu¡ b48 by‹s", &
fže
.
Çme
);

2680 
çžed
;

2683 
n
 = 
	`ngx_»ad_fže
(&
fže
, 
buf
, 48, 0);

2685 ià(
n
 =ð
NGX_ERROR
) {

2686 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
, 
ngx_”ºo
,

2687 
ngx_»ad_fže_n
 " \"%V\" fažed", &
fže
.
Çme
);

2688 
çžed
;

2691 ià(
n
 != 48) {

2692 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
, 0,

2693 
ngx_»ad_fže_n
 " \"%V\"„eturned only "

2694 "%z by‹ š¡—d oà48", &
fže
.
Çme
, 
n
);

2695 
çžed
;

2698 
key
 = 
	`ngx_¬¿y_push
(
keys
);

2699 ià(
key
 =ð
NULL
) {

2700 
çžed
;

2703 
	`ngx_memýy
(
key
->
Çme
, 
buf
, 16);

2704 
	`ngx_memýy
(
key
->
«s_key
, 
buf
 + 16, 16);

2705 
	`ngx_memýy
(
key
->
hmac_key
, 
buf
 + 32, 16);

2707 ià(
	`ngx_þo£_fže
(
fže
.
fd
è=ð
NGX_FILE_ERROR
) {

2708 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

2709 
ngx_þo£_fže_n
 " \"%V\" fažed", &
fže
.
Çme
);

2713 ià(
	`SSL_CTX_£t_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_£ssiÚ_tick‘_keys_šdex
, 
keys
)

2716 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

2718  
NGX_ERROR
;

2721 ià(
	`SSL_CTX_£t_Ž£xt_tick‘_key_cb
(
s¦
->
ùx
,

2722 
ngx_s¦_£ssiÚ_tick‘_key_ÿÎback
)

2725 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
cf
->
log
, 0,

2732  
NGX_OK
;

2734 
çžed
:

2736 ià(
	`ngx_þo£_fže
(
fže
.
fd
è=ð
NGX_FILE_ERROR
) {

2737 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

2738 
ngx_þo£_fže_n
 " \"%V\" fažed", &
fže
.
Çme
);

2741  
NGX_ERROR
;

2742 
	}
}

2745 #ifdeà
OPENSSL_NO_SHA256


2746 
	#ngx_s¦_£ssiÚ_tick‘_md
 
EVP_sha1


	)

2748 
	#ngx_s¦_£ssiÚ_tick‘_md
 
EVP_sha256


	)

2753 
	$ngx_s¦_£ssiÚ_tick‘_key_ÿÎback
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
,

2754 *
Çme
, *
iv
, 
EVP_CIPHER_CTX
 *
eùx
,

2755 
HMAC_CTX
 *
hùx
, 
’c
)

2757 
SSL_CTX
 *
s¦_ùx
;

2758 
ngx_ušt_t
 
i
;

2759 
ngx_¬¿y_t
 *
keys
;

2760 
ngx_s¦_£ssiÚ_tick‘_key_t
 *
key
;

2761 #ià(
NGX_DEBUG
)

2762 
u_ch¬
 
buf
[32];

2763 
ngx_cÚÃùiÚ_t
 *
c
;

2766 
s¦_ùx
 = 
	`SSL_g‘_SSL_CTX
(
s¦_cÚn
);

2768 
keys
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦_ùx
, 
ngx_s¦_£ssiÚ_tick‘_keys_šdex
);

2769 ià(
keys
 =ð
NULL
) {

2773 
key
 = 
keys
->
–ts
;

2775 #ià(
NGX_DEBUG
)

2776 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
(
s¦_cÚn
);

2779 ià(
’c
 == 1) {

2782 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2784 
	`ngx_hex_dump
(
buf
, 
key
[0].
Çme
, 16) - buf, buf,

2785 
	`SSL_£ssiÚ_»u£d
(
s¦_cÚn
) ? "reused" : "new");

2787 
	`RAND_p£udo_by‹s
(
iv
, 16);

2788 
	`EVP_Enüy±In™_ex
(
eùx
, 
	`EVP_«s_128_cbc
(), 
NULL
, 
key
[0].
«s_key
, 
iv
);

2789 
	`HMAC_In™_ex
(
hùx
, 
key
[0].
hmac_key
, 16,

2790 
	`ngx_s¦_£ssiÚ_tick‘_md
(), 
NULL
);

2791 
	`ngx_memýy
(
Çme
, 
key
[0].name, 16);

2798 
i
 = 0; i < 
keys
->
ÃÉs
; i++) {

2799 ià(
	`ngx_memcmp
(
Çme
, 
key
[
i
].name, 16) == 0) {

2800 
found
;

2804 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2806 
	`ngx_hex_dump
(
buf
, 
Çme
, 16) - buf, buf);

2810 
found
:

2812 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2814 
	`ngx_hex_dump
(
buf
, 
key
[
i
].
Çme
, 16) - buf, buf,

2815 (
i
 == 0) ? " (default)" : "");

2817 
	`HMAC_In™_ex
(
hùx
, 
key
[
i
].
hmac_key
, 16,

2818 
	`ngx_s¦_£ssiÚ_tick‘_md
(), 
NULL
);

2819 
	`EVP_Deüy±In™_ex
(
eùx
, 
	`EVP_«s_128_cbc
(), 
NULL
, 
key
[
i
].
«s_key
, 
iv
);

2821  (
i
 == 0) ? 1 : 2 ;

2823 
	}
}

2827 
ngx_št_t


2828 
	$ngx_s¦_£ssiÚ_tick‘_keys
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¬¿y_t
 *
·ths
)

2830 ià(
·ths
) {

2831 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
s¦
->
log
, 0,

2835  
NGX_OK
;

2836 
	}
}

2842 
	$ngx_s¦_þ—nup_ùx
(*
d©a
)

2844 
ngx_s¦_t
 *
s¦
 = 
d©a
;

2846 
	`SSL_CTX_ä“
(
s¦
->
ùx
);

2847 
	}
}

2850 
ngx_št_t


2851 
	$ngx_s¦_check_ho¡
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_¡r_t
 *
Çme
)

2853 
X509
 *
û¹
;

2855 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
c
->
s¦
->
cÚÃùiÚ
);

2856 ià(
û¹
 =ð
NULL
) {

2857  
NGX_ERROR
;

2860 #ià(
OPENSSL_VERSION_NUMBER
 >ð0x10002002L && !
defšed
 
LIBRESSL_VERSION_NUMBER
)

2864 ià(
Çme
->
Ën
 == 0) {

2865 
çžed
;

2868 ià(
	`X509_check_ho¡
(
û¹
, (*è
Çme
->
d©a
,‚ame->
Ën
, 0, 
NULL
) != 1) {

2869 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2871 
çžed
;

2874 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2877 
found
;

2881 
n
, 
i
;

2882 
X509_NAME
 *
¢ame
;

2883 
ASN1_STRING
 *
¡r
;

2884 
X509_NAME_ENTRY
 *
’Œy
;

2885 
GENERAL_NAME
 *
®Šame
;

2886 
	`STACK_OF
(
GENERAL_NAME
è*
®Šames
;

2893 
®Šames
 = 
	`X509_g‘_ext_d2i
(
û¹
, 
NID_subjeù_®t_Çme
, 
NULL
, NULL);

2895 ià(
®Šames
) {

2896 
n
 = 
	`sk_GENERAL_NAME_num
(
®Šames
);

2898 
i
 = 0; i < 
n
; i++) {

2899 
®Šame
 = 
	`sk_GENERAL_NAME_v®ue
(
®Šames
, 
i
);

2901 ià(
®Šame
->
ty³
 !ð
GEN_DNS
) {

2905 
¡r
 = 
®Šame
->
d
.
dNSName
;

2907 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2909 
	`ASN1_STRING_Ëngth
(
¡r
), 
	`ASN1_STRING_d©a
(str));

2911 ià(
	`ngx_s¦_check_Çme
(
Çme
, 
¡r
è=ð
NGX_OK
) {

2912 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2914 
	`GENERAL_NAMES_ä“
(
®Šames
);

2915 
found
;

2919 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2922 
	`GENERAL_NAMES_ä“
(
®Šames
);

2923 
çžed
;

2932 
¢ame
 = 
	`X509_g‘_subjeù_Çme
(
û¹
);

2934 ià(
¢ame
 =ð
NULL
) {

2935 
çžed
;

2938 
i
 = -1;

2940 
i
 = 
	`X509_NAME_g‘_šdex_by_NID
(
¢ame
, 
NID_commÚName
, i);

2942 ià(
i
 < 0) {

2946 
’Œy
 = 
	`X509_NAME_g‘_’Œy
(
¢ame
, 
i
);

2947 
¡r
 = 
	`X509_NAME_ENTRY_g‘_d©a
(
’Œy
);

2949 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2951 
	`ASN1_STRING_Ëngth
(
¡r
), 
	`ASN1_STRING_d©a
(str));

2953 ià(
	`ngx_s¦_check_Çme
(
Çme
, 
¡r
è=ð
NGX_OK
) {

2954 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2956 
found
;

2960 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

2965 
çžed
:

2967 
	`X509_ä“
(
û¹
);

2968  
NGX_ERROR
;

2970 
found
:

2972 
	`X509_ä“
(
û¹
);

2973  
NGX_OK
;

2974 
	}
}

2977 #ià(
OPENSSL_VERSION_NUMBER
 < 0x10002002L || 
defšed
 
LIBRESSL_VERSION_NUMBER
)

2979 
ngx_št_t


2980 
	$ngx_s¦_check_Çme
(
ngx_¡r_t
 *
Çme
, 
ASN1_STRING
 *
·‰”n
)

2982 
u_ch¬
 *
s
, *
p
, *
’d
;

2983 
size_t
 
¦’
, 
¶’
;

2985 
s
 = 
Çme
->
d©a
;

2986 
¦’
 = 
Çme
->
Ën
;

2988 
p
 = 
	`ASN1_STRING_d©a
(
·‰”n
);

2989 
¶’
 = 
	`ASN1_STRING_Ëngth
(
·‰”n
);

2991 ià(
¦’
 =ð
¶’
 && 
	`ngx_¡ºÿ£cmp
(
s
, 
p
,…len) == 0) {

2992  
NGX_OK
;

2995 ià(
¶’
 > 2 && 
p
[0] == '*' &&…[1] == '.') {

2996 
¶’
 -= 1;

2997 
p
 += 1;

2999 
’d
 = 
s
 + 
¦’
;

3000 
s
 = 
	`ngx_¡¾chr
(s, 
’d
, '.');

3002 ià(
s
 =ð
NULL
) {

3003  
NGX_ERROR
;

3006 
¦’
 = 
’d
 - 
s
;

3008 ià(
¶’
 =ð
¦’
 && 
	`ngx_¡ºÿ£cmp
(
s
, 
p
,…len) == 0) {

3009  
NGX_OK
;

3013  
NGX_ERROR
;

3014 
	}
}

3019 
ngx_št_t


3020 
	$ngx_s¦_g‘_´ÙocÞ
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3022 
s
->
d©a
 = (
u_ch¬
 *è
	`SSL_g‘_v”siÚ
(
c
->
s¦
->
cÚÃùiÚ
);

3023  
NGX_OK
;

3024 
	}
}

3027 
ngx_št_t


3028 
	$ngx_s¦_g‘_ch”_Çme
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3030 
s
->
d©a
 = (
u_ch¬
 *è
	`SSL_g‘_ch”_Çme
(
c
->
s¦
->
cÚÃùiÚ
);

3031  
NGX_OK
;

3032 
	}
}

3035 
ngx_št_t


3036 
	$ngx_s¦_g‘_£ssiÚ_id
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3038 
u_ch¬
 *
buf
;

3039 
SSL_SESSION
 *
£ss
;

3040 
Ën
;

3042 
£ss
 = 
	`SSL_g‘0_£ssiÚ
(
c
->
s¦
->
cÚÃùiÚ
);

3043 ià(
£ss
 =ð
NULL
) {

3044 
s
->
Ën
 = 0;

3045  
NGX_OK
;

3048 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090800fL

3050 
buf
 = (
u_ch¬
 *è
	`SSL_SESSION_g‘_id
(
£ss
, &
Ën
);

3054 
buf
 = 
£ss
->
£ssiÚ_id
;

3055 
Ën
 = 
£ss
->
£ssiÚ_id_Ëngth
;

3059 
s
->
Ën
 = 2 *†en;

3060 
s
->
d©a
 = 
	`ngx_²®loc
(
poÞ
, 2 * 
Ën
);

3061 ià(
s
->
d©a
 =ð
NULL
) {

3062  
NGX_ERROR
;

3065 
	`ngx_hex_dump
(
s
->
d©a
, 
buf
, 
Ën
);

3067  
NGX_OK
;

3068 
	}
}

3071 
ngx_št_t


3072 
	$ngx_s¦_g‘_£ssiÚ_»u£d
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3074 ià(
	`SSL_£ssiÚ_»u£d
(
c
->
s¦
->
cÚÃùiÚ
)) {

3075 
	`ngx_¡r_£t
(
s
, "r");

3078 
	`ngx_¡r_£t
(
s
, ".");

3081  
NGX_OK
;

3082 
	}
}

3085 
ngx_št_t


3086 
	$ngx_s¦_g‘_£rv”_Çme
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3088 #ifdeà
SSL_CTRL_SET_TLSEXT_HOSTNAME


3090 cÚ¡ *
£rv”Çme
;

3092 
£rv”Çme
 = 
	`SSL_g‘_£rv”Çme
(
c
->
s¦
->
cÚÃùiÚ
,

3093 
TLSEXT_NAMETYPE_ho¡_Çme
);

3094 ià(
£rv”Çme
) {

3095 
s
->
d©a
 = (
u_ch¬
 *è
£rv”Çme
;

3096 
s
->
Ën
 = 
	`ngx_¡¾’
(
£rv”Çme
);

3097  
NGX_OK
;

3102 
s
->
Ën
 = 0;

3103  
NGX_OK
;

3104 
	}
}

3107 
ngx_št_t


3108 
	$ngx_s¦_g‘_¿w_û¹ifiÿ‹
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3110 
size_t
 
Ën
;

3111 
BIO
 *
bio
;

3112 
X509
 *
û¹
;

3114 
s
->
Ën
 = 0;

3116 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
c
->
s¦
->
cÚÃùiÚ
);

3117 ià(
û¹
 =ð
NULL
) {

3118  
NGX_OK
;

3121 
bio
 = 
	`BIO_Ãw
(
	`BIO_s_mem
());

3122 ià(
bio
 =ð
NULL
) {

3123 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "BIO_new() failed");

3124 
	`X509_ä“
(
û¹
);

3125  
NGX_ERROR
;

3128 ià(
	`PEM_wr™e_bio_X509
(
bio
, 
û¹
) == 0) {

3129 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "PEM_write_bio_X509() failed");

3130 
çžed
;

3133 
Ën
 = 
	`BIO_³ndšg
(
bio
);

3134 
s
->
Ën
 =†en;

3136 
s
->
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

3137 ià(
s
->
d©a
 =ð
NULL
) {

3138 
çžed
;

3141 
	`BIO_»ad
(
bio
, 
s
->
d©a
, 
Ën
);

3143 
	`BIO_ä“
(
bio
);

3144 
	`X509_ä“
(
û¹
);

3146  
NGX_OK
;

3148 
çžed
:

3150 
	`BIO_ä“
(
bio
);

3151 
	`X509_ä“
(
û¹
);

3153  
NGX_ERROR
;

3154 
	}
}

3157 
ngx_št_t


3158 
	$ngx_s¦_g‘_û¹ifiÿ‹
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3160 
u_ch¬
 *
p
;

3161 
size_t
 
Ën
;

3162 
ngx_ušt_t
 
i
;

3163 
ngx_¡r_t
 
û¹
;

3165 ià(
	`ngx_s¦_g‘_¿w_û¹ifiÿ‹
(
c
, 
poÞ
, &
û¹
è!ð
NGX_OK
) {

3166  
NGX_ERROR
;

3169 ià(
û¹
.
Ën
 == 0) {

3170 
s
->
Ën
 = 0;

3171  
NGX_OK
;

3174 
Ën
 = 
û¹
.len - 1;

3176 
i
 = 0; i < 
û¹
.
Ën
 - 1; i++) {

3177 ià(
û¹
.
d©a
[
i
] =ð
LF
) {

3178 
Ën
++;

3182 
s
->
Ën
 =†en;

3183 
s
->
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

3184 ià(
s
->
d©a
 =ð
NULL
) {

3185  
NGX_ERROR
;

3188 
p
 = 
s
->
d©a
;

3190 
i
 = 0; i < 
û¹
.
Ën
 - 1; i++) {

3191 *
p
++ = 
û¹
.
d©a
[
i
];

3192 ià(
û¹
.
d©a
[
i
] =ð
LF
) {

3193 *
p
++ = '\t';

3197  
NGX_OK
;

3198 
	}
}

3201 
ngx_št_t


3202 
	$ngx_s¦_g‘_subjeù_dn
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3204 *
p
;

3205 
size_t
 
Ën
;

3206 
X509
 *
û¹
;

3207 
X509_NAME
 *
Çme
;

3209 
s
->
Ën
 = 0;

3211 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
c
->
s¦
->
cÚÃùiÚ
);

3212 ià(
û¹
 =ð
NULL
) {

3213  
NGX_OK
;

3216 
Çme
 = 
	`X509_g‘_subjeù_Çme
(
û¹
);

3217 ià(
Çme
 =ð
NULL
) {

3218 
	`X509_ä“
(
û¹
);

3219  
NGX_ERROR
;

3222 
p
 = 
	`X509_NAME_Ú–še
(
Çme
, 
NULL
, 0);

3224 
Ën
 = 0; 
p
[len];†en++) { }

3226 
s
->
Ën
 =†en;

3227 
s
->
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

3228 ià(
s
->
d©a
 =ð
NULL
) {

3229 
	`OPENSSL_ä“
(
p
);

3230 
	`X509_ä“
(
û¹
);

3231  
NGX_ERROR
;

3234 
	`ngx_memýy
(
s
->
d©a
, 
p
, 
Ën
);

3236 
	`OPENSSL_ä“
(
p
);

3237 
	`X509_ä“
(
û¹
);

3239  
NGX_OK
;

3240 
	}
}

3243 
ngx_št_t


3244 
	$ngx_s¦_g‘_issu”_dn
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3246 *
p
;

3247 
size_t
 
Ën
;

3248 
X509
 *
û¹
;

3249 
X509_NAME
 *
Çme
;

3251 
s
->
Ën
 = 0;

3253 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
c
->
s¦
->
cÚÃùiÚ
);

3254 ià(
û¹
 =ð
NULL
) {

3255  
NGX_OK
;

3258 
Çme
 = 
	`X509_g‘_issu”_Çme
(
û¹
);

3259 ià(
Çme
 =ð
NULL
) {

3260 
	`X509_ä“
(
û¹
);

3261  
NGX_ERROR
;

3264 
p
 = 
	`X509_NAME_Ú–še
(
Çme
, 
NULL
, 0);

3266 
Ën
 = 0; 
p
[len];†en++) { }

3268 
s
->
Ën
 =†en;

3269 
s
->
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

3270 ià(
s
->
d©a
 =ð
NULL
) {

3271 
	`OPENSSL_ä“
(
p
);

3272 
	`X509_ä“
(
û¹
);

3273  
NGX_ERROR
;

3276 
	`ngx_memýy
(
s
->
d©a
, 
p
, 
Ën
);

3278 
	`OPENSSL_ä“
(
p
);

3279 
	`X509_ä“
(
û¹
);

3281  
NGX_OK
;

3282 
	}
}

3285 
ngx_št_t


3286 
	$ngx_s¦_g‘_£rŸl_numb”
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3288 
size_t
 
Ën
;

3289 
X509
 *
û¹
;

3290 
BIO
 *
bio
;

3292 
s
->
Ën
 = 0;

3294 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
c
->
s¦
->
cÚÃùiÚ
);

3295 ià(
û¹
 =ð
NULL
) {

3296  
NGX_OK
;

3299 
bio
 = 
	`BIO_Ãw
(
	`BIO_s_mem
());

3300 ià(
bio
 =ð
NULL
) {

3301 
	`X509_ä“
(
û¹
);

3302  
NGX_ERROR
;

3305 
	`i2a_ASN1_INTEGER
(
bio
, 
	`X509_g‘_£rŸlNumb”
(
û¹
));

3306 
Ën
 = 
	`BIO_³ndšg
(
bio
);

3308 
s
->
Ën
 =†en;

3309 
s
->
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

3310 ià(
s
->
d©a
 =ð
NULL
) {

3311 
	`BIO_ä“
(
bio
);

3312 
	`X509_ä“
(
û¹
);

3313  
NGX_ERROR
;

3316 
	`BIO_»ad
(
bio
, 
s
->
d©a
, 
Ën
);

3317 
	`BIO_ä“
(
bio
);

3318 
	`X509_ä“
(
û¹
);

3320  
NGX_OK
;

3321 
	}
}

3324 
ngx_št_t


3325 
	$ngx_s¦_g‘_fšg”´št
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3327 
X509
 *
û¹
;

3328 
Ën
;

3329 
u_ch¬
 
buf
[
EVP_MAX_MD_SIZE
];

3331 
s
->
Ën
 = 0;

3333 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
c
->
s¦
->
cÚÃùiÚ
);

3334 ià(
û¹
 =ð
NULL
) {

3335  
NGX_OK
;

3338 ià(!
	`X509_dige¡
(
û¹
, 
	`EVP_sha1
(), 
buf
, &
Ën
)) {

3339 
	`X509_ä“
(
û¹
);

3340  
NGX_ERROR
;

3343 
s
->
Ën
 = 2 *†en;

3344 
s
->
d©a
 = 
	`ngx_²®loc
(
poÞ
, 2 * 
Ën
);

3345 ià(
s
->
d©a
 =ð
NULL
) {

3346 
	`X509_ä“
(
û¹
);

3347  
NGX_ERROR
;

3350 
	`ngx_hex_dump
(
s
->
d©a
, 
buf
, 
Ën
);

3352 
	`X509_ä“
(
û¹
);

3354  
NGX_OK
;

3355 
	}
}

3358 
ngx_št_t


3359 
	$ngx_s¦_g‘_þ›Á_v”ify
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
s
)

3361 
X509
 *
û¹
;

3363 ià(
	`SSL_g‘_v”ify_»suÉ
(
c
->
s¦
->
cÚÃùiÚ
è!ð
X509_V_OK
) {

3364 
	`ngx_¡r_£t
(
s
, "FAILED");

3365  
NGX_OK
;

3368 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
c
->
s¦
->
cÚÃùiÚ
);

3370 ià(
û¹
) {

3371 
	`ngx_¡r_£t
(
s
, "SUCCESS");

3374 
	`ngx_¡r_£t
(
s
, "NONE");

3377 
	`X509_ä“
(
û¹
);

3379  
NGX_OK
;

3380 
	}
}

3384 
	$ngx_Ý’s¦_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

3386 
ngx_Ý’s¦_cÚf_t
 *
oscf
;

3388 
oscf
 = 
	`ngx_pÿÎoc
(
cyþe
->
poÞ
, (
ngx_Ý’s¦_cÚf_t
));

3389 ià(
oscf
 =ð
NULL
) {

3390  
NULL
;

3399  
oscf
;

3400 
	}
}

3404 
	$ngx_Ý’s¦_’gše
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3406 #iâdeà
OPENSSL_NO_ENGINE


3408 
ngx_Ý’s¦_cÚf_t
 *
oscf
 = 
cÚf
;

3410 
ENGINE
 *
’gše
;

3411 
ngx_¡r_t
 *
v®ue
;

3413 ià(
oscf
->
’gše
) {

3417 
oscf
->
’gše
 = 1;

3419 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3421 
’gše
 = 
	`ENGINE_by_id
((cÚ¡ *è
v®ue
[1].
d©a
);

3423 ià(
’gše
 =ð
NULL
) {

3424 
	`ngx_s¦_”rÜ
(
NGX_LOG_WARN
, 
cf
->
log
, 0,

3425 "ENGINE_by_id(\"%V\"èçžed", &
v®ue
[1]);

3426  
NGX_CONF_ERROR
;

3429 ià(
	`ENGINE_£t_deçuÉ
(
’gše
, 
ENGINE_METHOD_ALL
) == 0) {

3430 
	`ngx_s¦_”rÜ
(
NGX_LOG_WARN
, 
cf
->
log
, 0,

3432 &
v®ue
[1]);

3434 
	`ENGINE_ä“
(
’gše
);

3436  
NGX_CONF_ERROR
;

3439 
	`ENGINE_ä“
(
’gše
);

3441  
NGX_CONF_OK
;

3448 
	}
}

3452 
	$ngx_Ý’s¦_ex™
(
ngx_cyþe_t
 *
cyþe
)

3454 
	`EVP_þ—nup
();

3455 #iâdeà
OPENSSL_NO_ENGINE


3456 
	`ENGINE_þ—nup
();

3458 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_openssl_stapling.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ev’t_cÚÃù.h
>

14 #ià(!
defšed
 
OPENSSL_NO_OCSP
 && defšed 
SSL_CTRL_SET_TLSEXT_STATUS_REQ_CB
)

18 
ngx_¡r_t
 
	m¡­Ë
;

19 
ngx_m£c_t
 
	mtimeout
;

21 
ngx_»sÞv”_t
 *
	m»sÞv”
;

22 
ngx_m£c_t
 
	m»sÞv”_timeout
;

24 
ngx_addr_t
 *
	maddrs
;

25 
ngx_¡r_t
 
	mho¡
;

26 
ngx_¡r_t
 
	muri
;

27 
š_pÜt_t
 
	mpÜt
;

29 
SSL_CTX
 *
	ms¦_ùx
;

31 
X509
 *
	mû¹
;

32 
X509
 *
	missu”
;

34 
time_t
 
	mv®id
;

36 
	mv”ify
:1;

37 
	mlßdšg
:1;

38 } 
	tngx_s¦_¡­lšg_t
;

41 
ngx_s¦_oc¥_ùx_s
 
	tngx_s¦_oc¥_ùx_t
;

43 
	sngx_s¦_oc¥_ùx_s
 {

44 
X509
 *
	mû¹
;

45 
X509
 *
	missu”
;

47 
ngx_ušt_t
 
	mÇddrs
;

49 
ngx_addr_t
 *
	maddrs
;

50 
ngx_¡r_t
 
	mho¡
;

51 
ngx_¡r_t
 
	muri
;

52 
š_pÜt_t
 
	mpÜt
;

54 
ngx_»sÞv”_t
 *
	m»sÞv”
;

55 
ngx_m£c_t
 
	m»sÞv”_timeout
;

57 
ngx_m£c_t
 
	mtimeout
;

59 (*
	mhªdËr
)(
ngx_s¦_oc¥_ùx_t
 *
	mr
);

60 *
	md©a
;

62 
ngx_buf_t
 *
	m»que¡
;

63 
ngx_buf_t
 *
	m»¥Ú£
;

64 
ngx_³”_cÚÃùiÚ_t
 
	m³”
;

66 
ngx_št_t
 (*
´oûss
)(
ngx_s¦_oc¥_ùx_t
 *
	mr
);

68 
ngx_ušt_t
 
	m¡©e
;

70 
ngx_ušt_t
 
	mcode
;

71 
ngx_ušt_t
 
	mcouÁ
;

73 
ngx_ušt_t
 
	mdÚe
;

75 
u_ch¬
 *
	mh—d”_Çme_¡¬t
;

76 
u_ch¬
 *
	mh—d”_Çme_’d
;

77 
u_ch¬
 *
	mh—d”_¡¬t
;

78 
u_ch¬
 *
	mh—d”_’d
;

80 
ngx_poÞ_t
 *
	mpoÞ
;

81 
ngx_log_t
 *
	mlog
;

85 
ngx_št_t
 
ngx_s¦_¡­lšg_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
,

86 
ngx_¡r_t
 *
fže
);

87 
ngx_št_t
 
ngx_s¦_¡­lšg_issu”
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
);

88 
ngx_št_t
 
ngx_s¦_¡­lšg_»¥Úd”
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
,

89 
ngx_¡r_t
 *
»¥Úd”
);

91 
ngx_s¦_û¹ifiÿ‹_¡©us_ÿÎback
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
,

92 *
d©a
);

93 
ngx_s¦_¡­lšg_upd©e
(
ngx_s¦_¡­lšg_t
 *
¡­Ë
);

94 
ngx_s¦_¡­lšg_oc¥_hªdËr
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

96 
ngx_s¦_¡­lšg_þ—nup
(*
d©a
);

98 
ngx_s¦_oc¥_ùx_t
 *
ngx_s¦_oc¥_¡¬t
();

99 
ngx_s¦_oc¥_dÚe
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

100 
ngx_s¦_oc¥_»que¡
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

101 
ngx_s¦_oc¥_»sÞve_hªdËr
(
ngx_»sÞv”_ùx_t
 *
»sÞve
);

102 
ngx_s¦_oc¥_cÚÃù
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

103 
ngx_s¦_oc¥_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
);

104 
ngx_s¦_oc¥_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
);

105 
ngx_s¦_oc¥_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
);

107 
ngx_št_t
 
ngx_s¦_oc¥_ü—‹_»que¡
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

108 
ngx_št_t
 
ngx_s¦_oc¥_´oûss_¡©us_lše
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

109 
ngx_št_t
 
ngx_s¦_oc¥_·r£_¡©us_lše
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

110 
ngx_št_t
 
ngx_s¦_oc¥_´oûss_h—d”s
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

111 
ngx_št_t
 
ngx_s¦_oc¥_·r£_h—d”_lše
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

112 
ngx_št_t
 
ngx_s¦_oc¥_´oûss_body
(
ngx_s¦_oc¥_ùx_t
 *
ùx
);

114 
u_ch¬
 *
ngx_s¦_oc¥_log_”rÜ
(
ngx_log_t
 *
log
, u_ch¬ *
buf
, 
size_t
 
Ën
);

117 
ngx_št_t


118 
	$ngx_s¦_¡­lšg
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
fže
,

119 
ngx_¡r_t
 *
»¥Úd”
, 
ngx_ušt_t
 
v”ify
)

121 
ngx_št_t
 
rc
;

122 
ngx_poÞ_þ—nup_t
 *
þn
;

123 
ngx_s¦_¡­lšg_t
 *
¡­Ë
;

125 
¡­Ë
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_s¦_¡­lšg_t
));

126 ià(
¡­Ë
 =ð
NULL
) {

127  
NGX_ERROR
;

130 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

131 ià(
þn
 =ð
NULL
) {

132  
NGX_ERROR
;

135 
þn
->
hªdËr
 = 
ngx_s¦_¡­lšg_þ—nup
;

136 
þn
->
d©a
 = 
¡­Ë
;

138 ià(
	`SSL_CTX_£t_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_¡­lšg_šdex
, 
¡­Ë
)

141 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

143  
NGX_ERROR
;

146 
¡­Ë
->
s¦_ùx
 = 
s¦
->
ùx
;

147 
¡­Ë
->
timeout
 = 60000;

148 
¡­Ë
->
v”ify
 = verify;

150 ià(
fže
->
Ën
) {

153 ià(
	`ngx_s¦_¡­lšg_fže
(
cf
, 
s¦
, 
fže
è!ð
NGX_OK
) {

154  
NGX_ERROR
;

157 
dÚe
;

160 
rc
 = 
	`ngx_s¦_¡­lšg_issu”
(
cf
, 
s¦
);

162 ià(
rc
 =ð
NGX_DECLINED
) {

163  
NGX_OK
;

166 ià(
rc
 !ð
NGX_OK
) {

167  
NGX_ERROR
;

170 
rc
 = 
	`ngx_s¦_¡­lšg_»¥Úd”
(
cf
, 
s¦
, 
»¥Úd”
);

172 ià(
rc
 =ð
NGX_DECLINED
) {

173  
NGX_OK
;

176 ià(
rc
 !ð
NGX_OK
) {

177  
NGX_ERROR
;

180 
dÚe
:

182 
	`SSL_CTX_£t_Ž£xt_¡©us_cb
(
s¦
->
ùx
, 
ngx_s¦_û¹ifiÿ‹_¡©us_ÿÎback
);

183 
	`SSL_CTX_£t_Ž£xt_¡©us_¬g
(
s¦
->
ùx
, 
¡­Ë
);

185  
NGX_OK
;

186 
	}
}

189 
ngx_št_t


190 
	$ngx_s¦_¡­lšg_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
fže
)

192 
BIO
 *
bio
;

193 
Ën
;

194 
u_ch¬
 *
p
, *
buf
;

195 
OCSP_RESPONSE
 *
»¥Ú£
;

196 
ngx_s¦_¡­lšg_t
 *
¡­Ë
;

198 
¡­Ë
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_¡­lšg_šdex
);

200 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, 
fže
, 1è!ð
NGX_OK
) {

201  
NGX_ERROR
;

204 
bio
 = 
	`BIO_Ãw_fže
((*è
fže
->
d©a
, "r");

205 ià(
bio
 =ð
NULL
) {

206 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

207 "BIO_Ãw_fže(\"%s\"èçžed", 
fže
->
d©a
);

208  
NGX_ERROR
;

211 
»¥Ú£
 = 
	`d2i_OCSP_RESPONSE_bio
(
bio
, 
NULL
);

212 ià(
»¥Ú£
 =ð
NULL
) {

213 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

214 "d2i_OCSP_RESPONSE_bio(\"%s\"èçžed", 
fže
->
d©a
);

215 
	`BIO_ä“
(
bio
);

216  
NGX_ERROR
;

219 
Ën
 = 
	`i2d_OCSP_RESPONSE
(
»¥Ú£
, 
NULL
);

220 ià(
Ën
 <= 0) {

221 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

222 "i2d_OCSP_RESPONSE(\"%s\"èçžed", 
fže
->
d©a
);

223 
çžed
;

226 
buf
 = 
	`ngx_®loc
(
Ën
, 
s¦
->
log
);

227 ià(
buf
 =ð
NULL
) {

228 
çžed
;

231 
p
 = 
buf
;

232 
Ën
 = 
	`i2d_OCSP_RESPONSE
(
»¥Ú£
, &
p
);

233 ià(
Ën
 <= 0) {

234 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

235 "i2d_OCSP_RESPONSE(\"%s\"èçžed", 
fže
->
d©a
);

236 
	`ngx_ä“
(
buf
);

237 
çžed
;

240 
	`OCSP_RESPONSE_ä“
(
»¥Ú£
);

241 
	`BIO_ä“
(
bio
);

243 
¡­Ë
->¡­Ë.
d©a
 = 
buf
;

244 
¡­Ë
->¡­Ë.
Ën
 =†en;

246  
NGX_OK
;

248 
çžed
:

250 
	`OCSP_RESPONSE_ä“
(
»¥Ú£
);

251 
	`BIO_ä“
(
bio
);

253  
NGX_ERROR
;

254 
	}
}

257 
ngx_št_t


258 
	$ngx_s¦_¡­lšg_issu”
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
)

260 
i
, 
n
, 
rc
;

261 
X509
 *
û¹
, *
issu”
;

262 
X509_STORE
 *
¡Üe
;

263 
X509_STORE_CTX
 *
¡Üe_ùx
;

264 
	`STACK_OF
(
X509
è*
chaš
;

265 
ngx_s¦_¡­lšg_t
 *
¡­Ë
;

267 
¡­Ë
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_¡­lšg_šdex
);

268 
û¹
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_û¹ifiÿ‹_šdex
);

270 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10001000L

271 
	`SSL_CTX_g‘_exŒa_chaš_û¹s
(
s¦
->
ùx
, &
chaš
);

273 
chaš
 = 
s¦
->
ùx
->
exŒa_û¹s
;

276 
n
 = 
	`sk_X509_num
(
chaš
);

278 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
s¦
->
log
, 0,

279 "SSL g‘ issu”: %dƒxŒ¨û¹s", 
n
);

281 
i
 = 0; i < 
n
; i++) {

282 
issu”
 = 
	`sk_X509_v®ue
(
chaš
, 
i
);

283 ià(
	`X509_check_issued
(
issu”
, 
û¹
è=ð
X509_V_OK
) {

284 
	`CRYPTO_add
(&
issu”
->
»ã»nûs
, 1, 
CRYPTO_LOCK_X509
);

286 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
s¦
->
log
, 0,

287 "SSL g‘ issu”: found %°šƒxŒ¨û¹s", 
issu”
);

289 
¡­Ë
->
û¹
 = cert;

290 
¡­Ë
->
issu”
 = issuer;

292  
NGX_OK
;

296 
¡Üe
 = 
	`SSL_CTX_g‘_û¹_¡Üe
(
s¦
->
ùx
);

297 ià(
¡Üe
 =ð
NULL
) {

298 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

300  
NGX_ERROR
;

303 
¡Üe_ùx
 = 
	`X509_STORE_CTX_Ãw
();

304 ià(
¡Üe_ùx
 =ð
NULL
) {

305 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

307  
NGX_ERROR
;

310 ià(
	`X509_STORE_CTX_š™
(
¡Üe_ùx
, 
¡Üe
, 
NULL
, NULL) == 0) {

311 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

313  
NGX_ERROR
;

316 
rc
 = 
	`X509_STORE_CTX_g‘1_issu”
(&
issu”
, 
¡Üe_ùx
, 
û¹
);

318 ià(
rc
 == -1) {

319 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
s¦
->
log
, 0,

321 
	`X509_STORE_CTX_ä“
(
¡Üe_ùx
);

322  
NGX_ERROR
;

325 ià(
rc
 == 0) {

326 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
s¦
->
log
, 0,

328 
	`X509_STORE_CTX_ä“
(
¡Üe_ùx
);

329  
NGX_DECLINED
;

332 
	`X509_STORE_CTX_ä“
(
¡Üe_ùx
);

334 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
s¦
->
log
, 0,

335 "SSL g‘ issu”: found %°š c”ˆ¡Üe", 
issu”
);

337 
¡­Ë
->
û¹
 = cert;

338 
¡­Ë
->
issu”
 = issuer;

340  
NGX_OK
;

341 
	}
}

344 
ngx_št_t


345 
	$ngx_s¦_¡­lšg_»¥Úd”
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
»¥Úd”
)

347 
ngx_u¾_t
 
u
;

348 *
s
;

349 
ngx_s¦_¡­lšg_t
 *
¡­Ë
;

350 
	`STACK_OF
(
OPENSSL_STRING
è*
aŸ
;

352 
¡­Ë
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_¡­lšg_šdex
);

354 ià(
»¥Úd”
->
Ën
 == 0) {

358 
aŸ
 = 
	`X509_g‘1_oc¥
(
¡­Ë
->
û¹
);

359 ià(
aŸ
 =ð
NULL
) {

360 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
s¦
->
log
, 0,

363  
NGX_DECLINED
;

366 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10000000L

367 
s
 = 
	`sk_OPENSSL_STRING_v®ue
(
aŸ
, 0);

369 
s
 = 
	`sk_v®ue
(
aŸ
, 0);

371 ià(
s
 =ð
NULL
) {

372 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
s¦
->
log
, 0,

375 
	`X509_emaž_ä“
(
aŸ
);

376  
NGX_DECLINED
;

379 
»¥Úd”
->
Ën
 = 
	`ngx_¡¾’
(
s
);

380 
»¥Úd”
->
d©a
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,„e¥Úd”->
Ën
);

381 ià(
»¥Úd”
->
d©a
 =ð
NULL
) {

382 
	`X509_emaž_ä“
(
aŸ
);

383  
NGX_ERROR
;

386 
	`ngx_memýy
(
»¥Úd”
->
d©a
, 
s
,„e¥Úd”->
Ën
);

387 
	`X509_emaž_ä“
(
aŸ
);

390 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

392 
u
.
u¾
 = *
»¥Úd”
;

393 
u
.
deçuÉ_pÜt
 = 80;

394 
u
.
uri_·¹
 = 1;

396 ià(
u
.
u¾
.
Ën
 > 7

397 && 
	`ngx_¡ºÿ£cmp
(
u
.
u¾
.
d©a
, (
u_ch¬
 *) "http://", 7) == 0)

399 
u
.
u¾
.
Ën
 -= 7;

400 
u
.
u¾
.
d©a
 += 7;

403 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
s¦
->
log
, 0,

405 "šv®id URL…»fix iÀOCSP„e¥Úd” \"%V\"", &
u
.
u¾
);

406  
NGX_DECLINED
;

409 ià(
	`ngx_·r£_u¾
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

410 ià(
u
.
”r
) {

411 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
s¦
->
log
, 0,

413 "% š OCSP„e¥Úd” \"%V\"", 
u
.
”r
, &u.
u¾
);

414  
NGX_DECLINED
;

417  
NGX_ERROR
;

420 
¡­Ë
->
addrs
 = 
u
.addrs;

421 
¡­Ë
->
ho¡
 = 
u
.host;

422 
¡­Ë
->
uri
 = 
u
.uri;

423 
¡­Ë
->
pÜt
 = 
u
.port;

425 ià(
¡­Ë
->
uri
.
Ën
 == 0) {

426 
	`ngx_¡r_£t
(&
¡­Ë
->
uri
, "/");

429  
NGX_OK
;

430 
	}
}

433 
ngx_št_t


434 
	$ngx_s¦_¡­lšg_»sÞv”
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
,

435 
ngx_»sÞv”_t
 *
»sÞv”
, 
ngx_m£c_t
 
»sÞv”_timeout
)

437 
ngx_s¦_¡­lšg_t
 *
¡­Ë
;

439 
¡­Ë
 = 
	`SSL_CTX_g‘_ex_d©a
(
s¦
->
ùx
, 
ngx_s¦_¡­lšg_šdex
);

441 
¡­Ë
->
»sÞv”
 =„esolver;

442 
¡­Ë
->
»sÞv”_timeout
 =„esolver_timeout;

444  
NGX_OK
;

445 
	}
}

449 
	$ngx_s¦_û¹ifiÿ‹_¡©us_ÿÎback
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
, *
d©a
)

451 
rc
;

452 
u_ch¬
 *
p
;

453 
ngx_cÚÃùiÚ_t
 *
c
;

454 
ngx_s¦_¡­lšg_t
 *
¡­Ë
;

456 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
(
s¦_cÚn
);

458 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

461 
¡­Ë
 = 
d©a
;

462 
rc
 = 
SSL_TLSEXT_ERR_NOACK
;

464 ià(
¡­Ë
->¡­Ë.
Ën
) {

467 
p
 = 
	`OPENSSL_m®loc
(
¡­Ë
->¡­Ë.
Ën
);

468 ià(
p
 =ð
NULL
) {

469 
	`ngx_s¦_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "OPENSSL_malloc() failed");

470  
SSL_TLSEXT_ERR_NOACK
;

473 
	`ngx_memýy
(
p
, 
¡­Ë
->¡­Ë.
d©a
, s¶e->¡­Ë.
Ën
);

475 
	`SSL_£t_Ž£xt_¡©us_oc¥_»¥
(
s¦_cÚn
, 
p
, 
¡­Ë
->¡­Ë.
Ën
);

477 
rc
 = 
SSL_TLSEXT_ERR_OK
;

480 
	`ngx_s¦_¡­lšg_upd©e
(
¡­Ë
);

482  
rc
;

483 
	}
}

487 
	$ngx_s¦_¡­lšg_upd©e
(
ngx_s¦_¡­lšg_t
 *
¡­Ë
)

489 
ngx_s¦_oc¥_ùx_t
 *
ùx
;

491 ià(
¡­Ë
->
ho¡
.
Ën
 == 0

492 || 
¡­Ë
->
lßdšg
 || s¶e->
v®id
 >ð
	`ngx_time
())

497 
¡­Ë
->
lßdšg
 = 1;

499 
ùx
 = 
	`ngx_s¦_oc¥_¡¬t
();

500 ià(
ùx
 =ð
NULL
) {

504 
ùx
->
û¹
 = 
¡­Ë
->cert;

505 
ùx
->
issu”
 = 
¡­Ë
->issuer;

507 
ùx
->
addrs
 = 
¡­Ë
->addrs;

508 
ùx
->
ho¡
 = 
¡­Ë
->host;

509 
ùx
->
uri
 = 
¡­Ë
->uri;

510 
ùx
->
pÜt
 = 
¡­Ë
->port;

511 
ùx
->
timeout
 = 
¡­Ë
->timeout;

513 
ùx
->
»sÞv”
 = 
¡­Ë
->resolver;

514 
ùx
->
»sÞv”_timeout
 = 
¡­Ë
->resolver_timeout;

516 
ùx
->
hªdËr
 = 
ngx_s¦_¡­lšg_oc¥_hªdËr
;

517 
ùx
->
d©a
 = 
¡­Ë
;

519 
	`ngx_s¦_oc¥_»que¡
(
ùx
);

522 
	}
}

526 
	$ngx_s¦_¡­lšg_oc¥_hªdËr
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

528 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090707fL

531 
u_ch¬
 *
p
;

532 
n
;

533 
size_t
 
Ën
;

534 
ngx_¡r_t
 
»¥Ú£
;

535 
X509_STORE
 *
¡Üe
;

536 
	`STACK_OF
(
X509
è*
chaš
;

537 
OCSP_CERTID
 *
id
;

538 
OCSP_RESPONSE
 *
oc¥
;

539 
OCSP_BASICRESP
 *
basic
;

540 
ngx_s¦_¡­lšg_t
 *
¡­Ë
;

541 
ASN1_GENERALIZEDTIME
 *
thisupd©e
, *
Ãxtupd©e
;

543 
¡­Ë
 = 
ùx
->
d©a
;

544 
oc¥
 = 
NULL
;

545 
basic
 = 
NULL
;

546 
id
 = 
NULL
;

548 ià(
ùx
->
code
 != 200) {

549 
”rÜ
;

554 
Ën
 = 
ùx
->
»¥Ú£
->
Ï¡
 - ctx->»¥Ú£->
pos
;

555 
p
 = 
ùx
->
»¥Ú£
->
pos
;

557 
oc¥
 = 
	`d2i_OCSP_RESPONSE
(
NULL
, &
p
, 
Ën
);

558 ià(
oc¥
 =ð
NULL
) {

559 
	`ngx_s¦_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

561 
”rÜ
;

564 
n
 = 
	`OCSP_»¥Ú£_¡©us
(
oc¥
);

566 ià(
n
 !ð
OCSP_RESPONSE_STATUS_SUCCESSFUL
) {

567 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

569 
n
, 
	`OCSP_»¥Ú£_¡©us_¡r
(n));

570 
”rÜ
;

573 
basic
 = 
	`OCSP_»¥Ú£_g‘1_basic
(
oc¥
);

574 ià(
basic
 =ð
NULL
) {

575 
	`ngx_s¦_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

577 
”rÜ
;

580 
¡Üe
 = 
	`SSL_CTX_g‘_û¹_¡Üe
(
¡­Ë
->
s¦_ùx
);

581 ià(
¡Üe
 =ð
NULL
) {

582 
	`ngx_s¦_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 0,

584 
”rÜ
;

587 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10001000L

588 
	`SSL_CTX_g‘_exŒa_chaš_û¹s
(
¡­Ë
->
s¦_ùx
, &
chaš
);

590 
chaš
 = 
¡­Ë
->
s¦_ùx
->
exŒa_û¹s
;

593 ià(
	`OCSP_basic_v”ify
(
basic
, 
chaš
, 
¡Üe
,

594 
¡­Ë
->
v”ify
 ? 
OCSP_TRUSTOTHER
 : 
OCSP_NOVERIFY
)

597 
	`ngx_s¦_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

599 
”rÜ
;

602 
id
 = 
	`OCSP_û¹_to_id
(
NULL
, 
ùx
->
û¹
, ctx->
issu”
);

603 ià(
id
 =ð
NULL
) {

604 
	`ngx_s¦_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 0,

606 
”rÜ
;

609 ià(
	`OCSP_»¥_fšd_¡©us
(
basic
, 
id
, &
n
, 
NULL
, NULL,

610 &
thisupd©e
, &
Ãxtupd©e
)

613 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

615 
”rÜ
;

618 ià(
n
 !ð
V_OCSP_CERTSTATUS_GOOD
) {

619 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

621 
	`OCSP_û¹_¡©us_¡r
(
n
));

622 
”rÜ
;

625 ià(
	`OCSP_check_v®id™y
(
thisupd©e
, 
Ãxtupd©e
, 300, -1) != 1) {

626 
	`ngx_s¦_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

628 
”rÜ
;

631 
	`OCSP_CERTID_ä“
(
id
);

632 
	`OCSP_BASICRESP_ä“
(
basic
);

633 
	`OCSP_RESPONSE_ä“
(
oc¥
);

637 
»¥Ú£
.
Ën
 =†en;

638 
»¥Ú£
.
d©a
 = 
	`ngx_®loc
Ôe¥Ú£.
Ën
, 
ùx
->
log
);

640 ià(
»¥Ú£
.
d©a
 =ð
NULL
) {

641 
dÚe
;

644 
	`ngx_memýy
(
»¥Ú£
.
d©a
, 
ùx
->»¥Ú£->
pos
,„e¥Ú£.
Ën
);

646 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

648 
	`OCSP_û¹_¡©us_¡r
(
n
), 
»¥Ú£
.
Ën
);

650 ià(
¡­Ë
->¡­Ë.
d©a
) {

651 
	`ngx_ä“
(
¡­Ë
->¡­Ë.
d©a
);

654 
¡­Ë
->¡­Ë = 
»¥Ú£
;

656 
dÚe
:

658 
¡­Ë
->
lßdšg
 = 0;

659 
¡­Ë
->
v®id
 = 
	`ngx_time
() + 3600;

661 
	`ngx_s¦_oc¥_dÚe
(
ùx
);

664 
”rÜ
:

666 
¡­Ë
->
lßdšg
 = 0;

667 
¡­Ë
->
v®id
 = 
	`ngx_time
() + 300;

669 ià(
id
) {

670 
	`OCSP_CERTID_ä“
(
id
);

673 ià(
basic
) {

674 
	`OCSP_BASICRESP_ä“
(
basic
);

677 ià(
oc¥
) {

678 
	`OCSP_RESPONSE_ä“
(
oc¥
);

681 
	`ngx_s¦_oc¥_dÚe
(
ùx
);

682 
	}
}

686 
	$ngx_s¦_¡­lšg_þ—nup
(*
d©a
)

688 
ngx_s¦_¡­lšg_t
 *
¡­Ë
 = 
d©a
;

690 ià(
¡­Ë
->
issu”
) {

691 
	`X509_ä“
(
¡­Ë
->
issu”
);

694 ià(
¡­Ë
->¡­Ë.
d©a
) {

695 
	`ngx_ä“
(
¡­Ë
->¡­Ë.
d©a
);

697 
	}
}

700 
ngx_s¦_oc¥_ùx_t
 *

701 
	$ngx_s¦_oc¥_¡¬t
()

703 
ngx_log_t
 *
log
;

704 
ngx_poÞ_t
 *
poÞ
;

705 
ngx_s¦_oc¥_ùx_t
 *
ùx
;

707 
poÞ
 = 
	`ngx_ü—‹_poÞ
(2048, 
ngx_cyþe
->
log
);

708 ià(
poÞ
 =ð
NULL
) {

709  
NULL
;

712 
ùx
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_s¦_oc¥_ùx_t
));

713 ià(
ùx
 =ð
NULL
) {

714 
	`ngx_de¡roy_poÞ
(
poÞ
);

715  
NULL
;

718 
log
 = 
	`ngx_·Îoc
(
poÞ
, (
ngx_log_t
));

719 ià(
log
 =ð
NULL
) {

720 
	`ngx_de¡roy_poÞ
(
poÞ
);

721  
NULL
;

724 
ùx
->
poÞ
 =…ool;

726 *
log
 = *
ùx
->
poÞ
->log;

728 
ùx
->
poÞ
->
log
 =†og;

729 
ùx
->
log
 =†og;

731 
log
->
hªdËr
 = 
ngx_s¦_oc¥_log_”rÜ
;

732 
log
->
d©a
 = 
ùx
;

733 
log
->
aùiÚ
 = "requesting certificate status";

735  
ùx
;

736 
	}
}

740 
	$ngx_s¦_oc¥_dÚe
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

742 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

745 ià(
ùx
->
³”
.
cÚÃùiÚ
) {

746 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

749 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

750 
	}
}

754 
	$ngx_s¦_oc¥_”rÜ
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

756 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

759 
ùx
->
code
 = 0;

760 
ùx
->
	`hªdËr
(ctx);

761 
	}
}

765 
	$ngx_s¦_oc¥_»que¡
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

767 
ngx_»sÞv”_ùx_t
 *
»sÞve
, 
‹mp
;

769 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

772 ià(
	`ngx_s¦_oc¥_ü—‹_»que¡
(
ùx
è!ð
NGX_OK
) {

773 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

777 ià(
ùx
->
»sÞv”
) {

780 
‹mp
.
Çme
 = 
ùx
->
ho¡
;

782 
»sÞve
 = 
	`ngx_»sÞve_¡¬t
(
ùx
->
»sÞv”
, &
‹mp
);

783 ià(
»sÞve
 =ð
NULL
) {

784 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

788 ià(
»sÞve
 =ð
NGX_NO_RESOLVER
) {

789 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
ùx
->
log
, 0,

790 "nØ»sÞv” defšedØ»sÞv%V", &
ùx
->
ho¡
);

791 
cÚÃù
;

794 
»sÞve
->
Çme
 = 
ùx
->
ho¡
;

795 
»sÞve
->
hªdËr
 = 
ngx_s¦_oc¥_»sÞve_hªdËr
;

796 
»sÞve
->
d©a
 = 
ùx
;

797 
»sÞve
->
timeout
 = 
ùx
->
»sÞv”_timeout
;

799 ià(
	`ngx_»sÞve_Çme
(
»sÞve
è!ð
NGX_OK
) {

800 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

807 
cÚÃù
:

809 
	`ngx_s¦_oc¥_cÚÃù
(
ùx
);

810 
	}
}

814 
	$ngx_s¦_oc¥_»sÞve_hªdËr
(
ngx_»sÞv”_ùx_t
 *
»sÞve
)

816 
ngx_s¦_oc¥_ùx_t
 *
ùx
 = 
»sÞve
->
d©a
;

818 
u_ch¬
 *
p
;

819 
size_t
 
Ën
;

820 
š_pÜt_t
 
pÜt
;

821 
sockËn_t
 
sockËn
;

822 
ngx_ušt_t
 
i
;

823 
sockaddr
 *sockaddr;

825 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

828 ià(
»sÞve
->
¡©e
) {

829 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

831 &
»sÞve
->
Çme
,„esÞve->
¡©e
,

832 
	`ngx_»sÞv”_¡»¼Ü
(
»sÞve
->
¡©e
));

833 
çžed
;

836 #ià(
NGX_DEBUG
)

838 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

839 
ngx_¡r_t
 
addr
;

841 
addr
.
d©a
 = 
‹xt
;

843 
i
 = 0; i < 
»sÞve
->
Çddrs
; i++) {

844 
addr
.
Ën
 = 
	`ngx_sock_ÁÝ
(
»sÞve
->
addrs
[
i
].
sockaddr
,

845 
»sÞve
->
addrs
[
i
].
sockËn
,

846 
‹xt
, 
NGX_SOCKADDR_STRLEN
, 0);

848 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

849 "Çmwa »sÞvedØ%V", &
addr
);

855 
ùx
->
Çddrs
 = 
»sÞve
->naddrs;

856 
ùx
->
addrs
 = 
	`ngx_pÿÎoc
(ùx->
poÞ
, ctx->
Çddrs
 * (
ngx_addr_t
));

858 ià(
ùx
->
addrs
 =ð
NULL
) {

859 
çžed
;

862 
pÜt
 = 
	`htÚs
(
ùx
->port);

864 
i
 = 0; i < 
»sÞve
->
Çddrs
; i++) {

866 
sockËn
 = 
»sÞve
->
addrs
[
i
].socklen;

868 
sockaddr
 = 
	`ngx_·Îoc
(
ùx
->
poÞ
, 
sockËn
);

869 ià(
sockaddr
 =ð
NULL
) {

870 
çžed
;

873 
	`ngx_memýy
(
sockaddr
, 
»sÞve
->
addrs
[
i
].sockaddr, 
sockËn
);

875 
sockaddr
->
§_çmžy
) {

876 #ià(
NGX_HAVE_INET6
)

877 
AF_INET6
:

878 ((
sockaddr_š6
 *è
sockaddr
)->
sš6_pÜt
 = 
pÜt
;

882 ((
sockaddr_š
 *è
sockaddr
)->
sš_pÜt
 = 
pÜt
;

885 
ùx
->
addrs
[
i
].
sockaddr
 = sockaddr;

886 
ùx
->
addrs
[
i
].
sockËn
 = socklen;

888 
p
 = 
	`ngx_²®loc
(
ùx
->
poÞ
, 
NGX_SOCKADDR_STRLEN
);

889 ià(
p
 =ð
NULL
) {

890 
çžed
;

893 
Ën
 = 
	`ngx_sock_ÁÝ
(
sockaddr
, 
sockËn
, 
p
, 
NGX_SOCKADDR_STRLEN
, 1);

895 
ùx
->
addrs
[
i
].
Çme
.
Ën
 =†en;

896 
ùx
->
addrs
[
i
].
Çme
.
d©a
 = 
p
;

899 
	`ngx_»sÞve_Çme_dÚe
(
»sÞve
);

901 
	`ngx_s¦_oc¥_cÚÃù
(
ùx
);

904 
çžed
:

906 
	`ngx_»sÞve_Çme_dÚe
(
»sÞve
);

907 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

908 
	}
}

912 
	$ngx_s¦_oc¥_cÚÃù
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

914 
ngx_št_t
 
rc
;

916 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

921 
ùx
->
³”
.
sockaddr
 = ctx->
addrs
[0].sockaddr;

922 
ùx
->
³”
.
sockËn
 = ctx->
addrs
[0].socklen;

923 
ùx
->
³”
.
Çme
 = &ùx->
addrs
[0].name;

924 
ùx
->
³”
.
g‘
 = 
ngx_ev’t_g‘_³”
;

925 
ùx
->
³”
.
log
 = ctx->log;

926 
ùx
->
³”
.
log_”rÜ
 = 
NGX_ERROR_ERR
;

928 
rc
 = 
	`ngx_ev’t_cÚÃù_³”
(&
ùx
->
³”
);

930 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

933 ià(
rc
 =ð
NGX_ERROR
 ||„ø=ð
NGX_BUSY
 ||„ø=ð
NGX_DECLINED
) {

934 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

938 
ùx
->
³”
.
cÚÃùiÚ
->
d©a
 = ctx;

939 
ùx
->
³”
.
cÚÃùiÚ
->
poÞ
 = ctx->pool;

941 
ùx
->
³”
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_s¦_oc¥_»ad_hªdËr
;

942 
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_s¦_oc¥_wr™e_hªdËr
;

944 
ùx
->
´oûss
 = 
ngx_s¦_oc¥_´oûss_¡©us_lše
;

946 
	`ngx_add_tim”
(
ùx
->
³”
.
cÚÃùiÚ
->
»ad
, ctx->
timeout
);

947 
	`ngx_add_tim”
(
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
, ctx->
timeout
);

949 ià(
rc
 =ð
NGX_OK
) {

950 
	`ngx_s¦_oc¥_wr™e_hªdËr
(
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
);

953 
	}
}

957 
	$ngx_s¦_oc¥_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
)

959 
ssize_t
 
n
, 
size
;

960 
ngx_cÚÃùiÚ_t
 *
c
;

961 
ngx_s¦_oc¥_ùx_t
 *
ùx
;

963 
c
 = 
wev
->
d©a
;

964 
ùx
 = 
c
->
d©a
;

966 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
wev
->
log
, 0,

969 ià(
wev
->
timedout
) {

970 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
wev
->
log
, 
NGX_ETIMEDOUT
,

972 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

976 
size
 = 
ùx
->
»que¡
->
Ï¡
 - ctx->»que¡->
pos
;

978 
n
 = 
	`ngx_£nd
(
c
, 
ùx
->
»que¡
->
pos
, 
size
);

980 ià(
n
 =ð
NGX_ERROR
) {

981 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

985 ià(
n
 > 0) {

986 
ùx
->
»que¡
->
pos
 +ð
n
;

988 ià(
n
 =ð
size
) {

989 
wev
->
hªdËr
 = 
ngx_s¦_oc¥_dummy_hªdËr
;

991 ià(
wev
->
tim”_£t
) {

992 
	`ngx_d–_tim”
(
wev
);

995 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 0è!ð
NGX_OK
) {

996 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

1003 ià(!
wev
->
tim”_£t
) {

1004 
	`ngx_add_tim”
(
wev
, 
ùx
->
timeout
);

1006 
	}
}

1010 
	$ngx_s¦_oc¥_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
)

1012 
ssize_t
 
n
, 
size
;

1013 
ngx_št_t
 
rc
;

1014 
ngx_s¦_oc¥_ùx_t
 *
ùx
;

1015 
ngx_cÚÃùiÚ_t
 *
c
;

1017 
c
 = 
»v
->
d©a
;

1018 
ùx
 = 
c
->
d©a
;

1020 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
»v
->
log
, 0,

1023 ià(
»v
->
timedout
) {

1024 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
»v
->
log
, 
NGX_ETIMEDOUT
,

1026 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

1030 ià(
ùx
->
»¥Ú£
 =ð
NULL
) {

1031 
ùx
->
»¥Ú£
 = 
	`ngx_ü—‹_‹mp_buf
(ùx->
poÞ
, 16384);

1032 ià(
ùx
->
»¥Ú£
 =ð
NULL
) {

1033 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

1040 
size
 = 
ùx
->
»¥Ú£
->
’d
 - ctx->»¥Ú£->
Ï¡
;

1042 
n
 = 
	`ngx_»cv
(
c
, 
ùx
->
»¥Ú£
->
Ï¡
, 
size
);

1044 ià(
n
 > 0) {

1045 
ùx
->
»¥Ú£
->
Ï¡
 +ð
n
;

1047 
rc
 = 
ùx
->
	`´oûss
(ctx);

1049 ià(
rc
 =ð
NGX_ERROR
) {

1050 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

1057 ià(
n
 =ð
NGX_AGAIN
) {

1059 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

1060 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

1069 
ùx
->
dÚe
 = 1;

1071 
rc
 = 
ùx
->
	`´oûss
(ctx);

1073 ià(
rc
 =ð
NGX_DONE
) {

1078 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

1081 
	`ngx_s¦_oc¥_”rÜ
(
ùx
);

1082 
	}
}

1086 
	$ngx_s¦_oc¥_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
)

1088 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

1090 
	}
}

1093 
ngx_št_t


1094 
	$ngx_s¦_oc¥_ü—‹_»que¡
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

1096 
Ën
;

1097 
u_ch¬
 *
p
;

1098 
ušŒ_t
 
esÿ³
;

1099 
ngx_¡r_t
 
bš¬y
, 
ba£64
;

1100 
ngx_buf_t
 *
b
;

1101 
OCSP_CERTID
 *
id
;

1102 
OCSP_REQUEST
 *
oc¥
;

1104 
oc¥
 = 
	`OCSP_REQUEST_Ãw
();

1105 ià(
oc¥
 =ð
NULL
) {

1106 
	`ngx_s¦_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 0,

1108  
NGX_ERROR
;

1111 
id
 = 
	`OCSP_û¹_to_id
(
NULL
, 
ùx
->
û¹
, ctx->
issu”
);

1112 ià(
id
 =ð
NULL
) {

1113 
	`ngx_s¦_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 0,

1115 
çžed
;

1118 ià(
	`OCSP_»que¡_add0_id
(
oc¥
, 
id
è=ð
NULL
) {

1119 
	`ngx_s¦_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 0,

1121 
çžed
;

1124 
Ën
 = 
	`i2d_OCSP_REQUEST
(
oc¥
, 
NULL
);

1125 ià(
Ën
 <= 0) {

1126 
	`ngx_s¦_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 0,

1128 
çžed
;

1131 
bš¬y
.
Ën
 =†en;

1132 
bš¬y
.
d©a
 = 
	`ngx_·Îoc
(
ùx
->
poÞ
, 
Ën
);

1133 ià(
bš¬y
.
d©a
 =ð
NULL
) {

1134 
çžed
;

1137 
p
 = 
bš¬y
.
d©a
;

1138 
Ën
 = 
	`i2d_OCSP_REQUEST
(
oc¥
, &
p
);

1139 ià(
Ën
 <= 0) {

1140 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
ùx
->
log
, 0,

1142 
çžed
;

1145 
ba£64
.
Ën
 = 
	`ngx_ba£64_’coded_Ëngth
(
bš¬y
.len);

1146 
ba£64
.
d©a
 = 
	`ngx_·Îoc
(
ùx
->
poÞ
, ba£64.
Ën
);

1147 ià(
ba£64
.
d©a
 =ð
NULL
) {

1148 
çžed
;

1151 
	`ngx_’code_ba£64
(&
ba£64
, &
bš¬y
);

1153 
esÿ³
 = 
	`ngx_esÿ³_uri
(
NULL
, 
ba£64
.
d©a
, ba£64.
Ën
,

1154 
NGX_ESCAPE_URI_COMPONENT
);

1156 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

1158 
ba£64
.
Ën
, 
esÿ³
);

1160 
Ën
 = ("GET "è- 1 + 
ùx
->
uri
.len + ("/") - 1

1161 + 
ba£64
.
Ën
 + 2 * 
esÿ³
 + (" HTTP/1.0" 
CRLF
) - 1

1162 + ("Ho¡: "è- 1 + 
ùx
->
ho¡
.
Ën
 + (
CRLF
) - 1

1163 + (
CRLF
) - 1;

1165 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
ùx
->
poÞ
, 
Ën
);

1166 ià(
b
 =ð
NULL
) {

1167 
çžed
;

1170 
p
 = 
b
->
Ï¡
;

1172 
p
 = 
	`ngx_ýymem
(p, "GET ", ("GET ") - 1);

1173 
p
 = 
	`ngx_ýymem
Õ, 
ùx
->
uri
.
d©a
, ctx->uri.
Ën
);

1175 ià(
ùx
->
uri
.
d©a
[ùx->uri.
Ën
 - 1] != '/') {

1176 *
p
++ = '/';

1179 ià(
esÿ³
 == 0) {

1180 
p
 = 
	`ngx_ýymem
Õ, 
ba£64
.
d©a
, ba£64.
Ën
);

1183 
p
 = (
u_ch¬
 *è
	`ngx_esÿ³_uri
Õ, 
ba£64
.
d©a
, ba£64.
Ën
,

1184 
NGX_ESCAPE_URI_COMPONENT
);

1187 
p
 = 
	`ngx_ýymem
Õ, " HTTP/1.0" 
CRLF
, (" HTTP/1.0" CRLF) - 1);

1188 
p
 = 
	`ngx_ýymem
(p, "Host: ", ("Host: ") - 1);

1189 
p
 = 
	`ngx_ýymem
Õ, 
ùx
->
ho¡
.
d©a
, ctx->ho¡.
Ën
);

1190 *
p
++ = 
CR
; *p++ = 
LF
;

1193 *
p
++ = 
CR
; *p++ = 
LF
;

1195 
b
->
Ï¡
 = 
p
;

1196 
ùx
->
»que¡
 = 
b
;

1198 
	`OCSP_REQUEST_ä“
(
oc¥
);

1200  
NGX_OK
;

1202 
çžed
:

1204 
	`OCSP_REQUEST_ä“
(
oc¥
);

1206  
NGX_ERROR
;

1207 
	}
}

1210 
ngx_št_t


1211 
	$ngx_s¦_oc¥_´oûss_¡©us_lše
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

1213 
ngx_št_t
 
rc
;

1215 
rc
 = 
	`ngx_s¦_oc¥_·r£_¡©us_lše
(
ùx
);

1217 ià(
rc
 =ð
NGX_OK
) {

1219 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

1221 
ùx
->
»¥Ú£
->
pos
 - ctx->»¥Ú£->
¡¬t
,

1222 
ùx
->
»¥Ú£
->
¡¬t
);

1225 
ùx
->
´oûss
 = 
ngx_s¦_oc¥_´oûss_h—d”s
;

1226  
ùx
->
	`´oûss
(ctx);

1229 ià(
rc
 =ð
NGX_AGAIN
) {

1230  
NGX_AGAIN
;

1235 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

1238  
NGX_ERROR
;

1239 
	}
}

1242 
ngx_št_t


1243 
	$ngx_s¦_oc¥_·r£_¡©us_lše
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

1245 
u_ch¬
 
ch
;

1246 
u_ch¬
 *
p
;

1247 
ngx_buf_t
 *
b
;

1249 
sw_¡¬t
 = 0,

1250 
sw_H
,

1251 
sw_HT
,

1252 
sw_HTT
,

1253 
sw_HTTP
,

1254 
sw_fœ¡_majÜ_dig™
,

1255 
sw_majÜ_dig™
,

1256 
sw_fœ¡_mšÜ_dig™
,

1257 
sw_mšÜ_dig™
,

1258 
sw_¡©us
,

1259 
sw_¥aû_aá”_¡©us
,

1260 
sw_¡©us_‹xt
,

1261 
sw_®mo¡_dÚe


1262 } 
¡©e
;

1264 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

1267 
¡©e
 = 
ùx
->state;

1268 
b
 = 
ùx
->
»¥Ú£
;

1270 
p
 = 
b
->
pos
;… < b->
Ï¡
;…++) {

1271 
ch
 = *
p
;

1273 
¡©e
) {

1276 
sw_¡¬t
:

1277 
ch
) {

1279 
¡©e
 = 
sw_H
;

1282  
NGX_ERROR
;

1286 
sw_H
:

1287 
ch
) {

1289 
¡©e
 = 
sw_HT
;

1292  
NGX_ERROR
;

1296 
sw_HT
:

1297 
ch
) {

1299 
¡©e
 = 
sw_HTT
;

1302  
NGX_ERROR
;

1306 
sw_HTT
:

1307 
ch
) {

1309 
¡©e
 = 
sw_HTTP
;

1312  
NGX_ERROR
;

1316 
sw_HTTP
:

1317 
ch
) {

1319 
¡©e
 = 
sw_fœ¡_majÜ_dig™
;

1322  
NGX_ERROR
;

1327 
sw_fœ¡_majÜ_dig™
:

1328 ià(
ch
 < '1' || ch > '9') {

1329  
NGX_ERROR
;

1332 
¡©e
 = 
sw_majÜ_dig™
;

1336 
sw_majÜ_dig™
:

1337 ià(
ch
 == '.') {

1338 
¡©e
 = 
sw_fœ¡_mšÜ_dig™
;

1342 ià(
ch
 < '0' || ch > '9') {

1343  
NGX_ERROR
;

1349 
sw_fœ¡_mšÜ_dig™
:

1350 ià(
ch
 < '0' || ch > '9') {

1351  
NGX_ERROR
;

1354 
¡©e
 = 
sw_mšÜ_dig™
;

1358 
sw_mšÜ_dig™
:

1359 ià(
ch
 == ' ') {

1360 
¡©e
 = 
sw_¡©us
;

1364 ià(
ch
 < '0' || ch > '9') {

1365  
NGX_ERROR
;

1371 
sw_¡©us
:

1372 ià(
ch
 == ' ') {

1376 ià(
ch
 < '0' || ch > '9') {

1377  
NGX_ERROR
;

1380 
ùx
->
code
 = ctx->cod* 10 + 
ch
 - '0';

1382 ià(++
ùx
->
couÁ
 == 3) {

1383 
¡©e
 = 
sw_¥aû_aá”_¡©us
;

1389 
sw_¥aû_aá”_¡©us
:

1390 
ch
) {

1392 
¡©e
 = 
sw_¡©us_‹xt
;

1395 
¡©e
 = 
sw_¡©us_‹xt
;

1397 
CR
:

1398 
¡©e
 = 
sw_®mo¡_dÚe
;

1400 
LF
:

1401 
dÚe
;

1403  
NGX_ERROR
;

1408 
sw_¡©us_‹xt
:

1409 
ch
) {

1410 
CR
:

1411 
¡©e
 = 
sw_®mo¡_dÚe
;

1413 
LF
:

1414 
dÚe
;

1419 
sw_®mo¡_dÚe
:

1420 
ch
) {

1421 
LF
:

1422 
dÚe
;

1424  
NGX_ERROR
;

1429 
b
->
pos
 = 
p
;

1430 
ùx
->
¡©e
 = state;

1432  
NGX_AGAIN
;

1434 
dÚe
:

1436 
b
->
pos
 = 
p
 + 1;

1437 
ùx
->
¡©e
 = 
sw_¡¬t
;

1439  
NGX_OK
;

1440 
	}
}

1443 
ngx_št_t


1444 
	$ngx_s¦_oc¥_´oûss_h—d”s
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

1446 
size_t
 
Ën
;

1447 
ngx_št_t
 
rc
;

1449 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

1453 
rc
 = 
	`ngx_s¦_oc¥_·r£_h—d”_lše
(
ùx
);

1455 ià(
rc
 =ð
NGX_OK
) {

1457 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

1459 
ùx
->
h—d”_Çme_’d
 - ctx->
h—d”_Çme_¡¬t
,

1460 
ùx
->
h—d”_Çme_¡¬t
,

1461 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
,

1462 
ùx
->
h—d”_¡¬t
);

1464 
Ën
 = 
ùx
->
h—d”_Çme_’d
 - ctx->
h—d”_Çme_¡¬t
;

1466 ià(
Ën
 == ("Content-Type") - 1

1467 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

1468 (
u_ch¬
 *) "Content-Type",

1472 
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

1474 ià(
Ën
 != ("application/ocsp-response") - 1

1475 || 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_¡¬t
,

1476 (
u_ch¬
 *) "application/ocsp-response",

1480 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

1483 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
,

1484 
ùx
->
h—d”_¡¬t
);

1485  
NGX_ERROR
;

1496 ià(
rc
 =ð
NGX_DONE
) {

1500 ià(
rc
 =ð
NGX_AGAIN
) {

1501  
NGX_AGAIN
;

1506 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
log
, 0,

1509  
NGX_ERROR
;

1512 
ùx
->
´oûss
 = 
ngx_s¦_oc¥_´oûss_body
;

1513  
ùx
->
	`´oûss
(ctx);

1514 
	}
}

1516 
ngx_št_t


1517 
	$ngx_s¦_oc¥_·r£_h—d”_lše
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

1519 
u_ch¬
 
c
, 
ch
, *
p
;

1521 
sw_¡¬t
 = 0,

1522 
sw_Çme
,

1523 
sw_¥aû_befÜe_v®ue
,

1524 
sw_v®ue
,

1525 
sw_¥aû_aá”_v®ue
,

1526 
sw_®mo¡_dÚe
,

1527 
sw_h—d”_®mo¡_dÚe


1528 } 
¡©e
;

1530 
¡©e
 = 
ùx
->state;

1532 
p
 = 
ùx
->
»¥Ú£
->
pos
;… < ctx->»¥Ú£->
Ï¡
;…++) {

1533 
ch
 = *
p
;

1536 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

1537 "s:%d in:'%02Xd:%c'", 
¡©e
, 
ch
, ch);

1540 
¡©e
) {

1543 
sw_¡¬t
:

1545 
ch
) {

1546 
CR
:

1547 
ùx
->
h—d”_’d
 = 
p
;

1548 
¡©e
 = 
sw_h—d”_®mo¡_dÚe
;

1550 
LF
:

1551 
ùx
->
h—d”_’d
 = 
p
;

1552 
h—d”_dÚe
;

1554 
¡©e
 = 
sw_Çme
;

1555 
ùx
->
h—d”_Çme_¡¬t
 = 
p
;

1557 
c
 = (
u_ch¬
è(
ch
 | 0x20);

1558 ià(
c
 >= 'a' && c <= 'z') {

1562 ià(
ch
 >= '0' && ch <= '9') {

1566  
NGX_ERROR
;

1571 
sw_Çme
:

1572 
c
 = (
u_ch¬
è(
ch
 | 0x20);

1573 ià(
c
 >= 'a' && c <= 'z') {

1577 ià(
ch
 == ':') {

1578 
ùx
->
h—d”_Çme_’d
 = 
p
;

1579 
¡©e
 = 
sw_¥aû_befÜe_v®ue
;

1583 ià(
ch
 == '-') {

1587 ià(
ch
 >= '0' && ch <= '9') {

1591 ià(
ch
 =ð
CR
) {

1592 
ùx
->
h—d”_Çme_’d
 = 
p
;

1593 
ùx
->
h—d”_¡¬t
 = 
p
;

1594 
ùx
->
h—d”_’d
 = 
p
;

1595 
¡©e
 = 
sw_®mo¡_dÚe
;

1599 ià(
ch
 =ð
LF
) {

1600 
ùx
->
h—d”_Çme_’d
 = 
p
;

1601 
ùx
->
h—d”_¡¬t
 = 
p
;

1602 
ùx
->
h—d”_’d
 = 
p
;

1603 
dÚe
;

1606  
NGX_ERROR
;

1609 
sw_¥aû_befÜe_v®ue
:

1610 
ch
) {

1613 
CR
:

1614 
ùx
->
h—d”_¡¬t
 = 
p
;

1615 
ùx
->
h—d”_’d
 = 
p
;

1616 
¡©e
 = 
sw_®mo¡_dÚe
;

1618 
LF
:

1619 
ùx
->
h—d”_¡¬t
 = 
p
;

1620 
ùx
->
h—d”_’d
 = 
p
;

1621 
dÚe
;

1623 
ùx
->
h—d”_¡¬t
 = 
p
;

1624 
¡©e
 = 
sw_v®ue
;

1630 
sw_v®ue
:

1631 
ch
) {

1633 
ùx
->
h—d”_’d
 = 
p
;

1634 
¡©e
 = 
sw_¥aû_aá”_v®ue
;

1636 
CR
:

1637 
ùx
->
h—d”_’d
 = 
p
;

1638 
¡©e
 = 
sw_®mo¡_dÚe
;

1640 
LF
:

1641 
ùx
->
h—d”_’d
 = 
p
;

1642 
dÚe
;

1647 
sw_¥aû_aá”_v®ue
:

1648 
ch
) {

1651 
CR
:

1652 
¡©e
 = 
sw_®mo¡_dÚe
;

1654 
LF
:

1655 
dÚe
;

1657 
¡©e
 = 
sw_v®ue
;

1663 
sw_®mo¡_dÚe
:

1664 
ch
) {

1665 
LF
:

1666 
dÚe
;

1668  
NGX_ERROR
;

1672 
sw_h—d”_®mo¡_dÚe
:

1673 
ch
) {

1674 
LF
:

1675 
h—d”_dÚe
;

1677  
NGX_ERROR
;

1682 
ùx
->
»¥Ú£
->
pos
 = 
p
;

1683 
ùx
->
¡©e
 = state;

1685  
NGX_AGAIN
;

1687 
dÚe
:

1689 
ùx
->
»¥Ú£
->
pos
 = 
p
 + 1;

1690 
ùx
->
¡©e
 = 
sw_¡¬t
;

1692  
NGX_OK
;

1694 
h—d”_dÚe
:

1696 
ùx
->
»¥Ú£
->
pos
 = 
p
 + 1;

1697 
ùx
->
¡©e
 = 
sw_¡¬t
;

1699  
NGX_DONE
;

1700 
	}
}

1703 
ngx_št_t


1704 
	$ngx_s¦_oc¥_´oûss_body
(
ngx_s¦_oc¥_ùx_t
 *
ùx
)

1706 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ùx
->
log
, 0,

1709 ià(
ùx
->
dÚe
) {

1710 
ùx
->
	`hªdËr
(ctx);

1711  
NGX_DONE
;

1714  
NGX_AGAIN
;

1715 
	}
}

1718 
u_ch¬
 *

1719 
	$ngx_s¦_oc¥_log_”rÜ
(
ngx_log_t
 *
log
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
)

1721 
u_ch¬
 *
p
;

1722 
ngx_s¦_oc¥_ùx_t
 *
ùx
;

1724 
p
 = 
buf
;

1726 ià(
log
->
aùiÚ
) {

1727 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, " whž%s", 
log
->
aùiÚ
);

1728 
Ën
 -ð
p
 - 
buf
;

1731 
ùx
 = 
log
->
d©a
;

1733 ià(
ùx
) {

1734 
p
 = 
	`ngx_¢´štf
Õ, 
Ën
, ",„e¥Úd”: %V", &
ùx
->
ho¡
);

1737  
p
;

1738 
	}
}

1744 
ngx_št_t


1745 
	$ngx_s¦_¡­lšg
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
, 
ngx_¡r_t
 *
fže
,

1746 
ngx_¡r_t
 *
»¥Úd”
, 
ngx_ušt_t
 
v”ify
)

1748 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
s¦
->
log
, 0,

1751  
NGX_OK
;

1752 
	}
}

1754 
ngx_št_t


1755 
	$ngx_s¦_¡­lšg_»sÞv”
(
ngx_cÚf_t
 *
cf
, 
ngx_s¦_t
 *
s¦
,

1756 
ngx_»sÞv”_t
 *
»sÞv”
, 
ngx_m£c_t
 
»sÞv”_timeout
)

1758  
NGX_OK
;

1759 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_pipe.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ev’t_pe.h
>

14 
ngx_št_t
 
ngx_ev’t_pe_»ad_up¡»am
(
ngx_ev’t_pe_t
 *
p
);

15 
ngx_št_t
 
ngx_ev’t_pe_wr™e_to_down¡»am
(
ngx_ev’t_pe_t
 *
p
);

17 
ngx_št_t
 
ngx_ev’t_pe_wr™e_chaš_to_‹mp_fže
(
ngx_ev’t_pe_t
 *
p
);

18 
ngx_šlše
 
ngx_ev’t_pe_»move_shadow_lšks
(
ngx_buf_t
 *
buf
);

19 
ngx_št_t
 
ngx_ev’t_pe_d¿š_chašs
(
ngx_ev’t_pe_t
 *
p
);

22 
ngx_št_t


23 
	$ngx_ev’t_pe
(
ngx_ev’t_pe_t
 *
p
, 
ngx_št_t
 
do_wr™e
)

25 
u_št
 
æags
;

26 
ngx_št_t
 
rc
;

27 
ngx_ev’t_t
 *
»v
, *
wev
;

30 ià(
do_wr™e
) {

31 
p
->
log
->
aùiÚ
 = "sendingo client";

33 
rc
 = 
	`ngx_ev’t_pe_wr™e_to_down¡»am
(
p
);

35 ià(
rc
 =ð
NGX_ABORT
) {

36  
NGX_ABORT
;

39 ià(
rc
 =ð
NGX_BUSY
) {

40  
NGX_OK
;

44 
p
->
»ad
 = 0;

45 
p
->
up¡»am_blocked
 = 0;

47 
p
->
log
->
aùiÚ
 = "reading upstream";

49 ià(
	`ngx_ev’t_pe_»ad_up¡»am
(
p
è=ð
NGX_ABORT
) {

50  
NGX_ABORT
;

53 ià(!
p
->
»ad
 && !p->
up¡»am_blocked
) {

57 
do_wr™e
 = 1;

60 ià(
p
->
up¡»am
->
fd
 !ð(
ngx_sock‘_t
) -1) {

61 
»v
 = 
p
->
up¡»am
->
»ad
;

63 
æags
 = (
»v
->
eof
 ||„ev->
”rÜ
è? 
NGX_CLOSE_EVENT
 : 0;

65 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 
æags
è!ð
NGX_OK
) {

66  
NGX_ABORT
;

69 ià(!
»v
->
d–ayed
) {

70 ià(
»v
->
aùive
 && !»v->
»ady
) {

71 
	`ngx_add_tim”
(
»v
, 
p
->
»ad_timeout
);

73 } ià(
»v
->
tim”_£t
) {

74 
	`ngx_d–_tim”
(
»v
);

79 ià(
p
->
down¡»am
->
fd
 !ð(
ngx_sock‘_t
) -1

80 && 
p
->
down¡»am
->
d©a
 =ðp->
ouut_ùx
)

82 
wev
 = 
p
->
down¡»am
->
wr™e
;

83 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 
p
->
£nd_low©
è!ð
NGX_OK
) {

84  
NGX_ABORT
;

87 ià(!
wev
->
d–ayed
) {

88 ià(
wev
->
aùive
 && !wev->
»ady
) {

89 
	`ngx_add_tim”
(
wev
, 
p
->
£nd_timeout
);

91 } ià(
wev
->
tim”_£t
) {

92 
	`ngx_d–_tim”
(
wev
);

97  
NGX_OK
;

98 
	}
}

101 
ngx_št_t


102 
	$ngx_ev’t_pe_»ad_up¡»am
(
ngx_ev’t_pe_t
 *
p
)

104 
off_t
 
lim™
;

105 
ssize_t
 
n
, 
size
;

106 
ngx_št_t
 
rc
;

107 
ngx_buf_t
 *
b
;

108 
ngx_m£c_t
 
d–ay
;

109 
ngx_chaš_t
 *
chaš
, *
þ
, *
Ê
;

111 ià(
p
->
up¡»am_eof
 ||…->
up¡»am_”rÜ
 ||…->
up¡»am_dÚe
) {

112  
NGX_OK
;

115 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

116 "p»ad up¡»am: %d", 
p
->
up¡»am
->
»ad
->
»ady
);

120 ià(
p
->
up¡»am_eof
 ||…->
up¡»am_”rÜ
 ||…->
up¡»am_dÚe
) {

124 ià(
p
->
´”—d_bufs
 =ð
NULL
 && !p->
up¡»am
->
»ad
->
»ady
) {

128 ià(
p
->
´”—d_bufs
) {

132 
chaš
 = 
p
->
´”—d_bufs
;

133 
p
->
´”—d_bufs
 = 
NULL
;

134 
n
 = 
p
->
´”—d_size
;

136 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

137 "p´”—d: %z", 
n
);

139 ià(
n
) {

140 
p
->
»ad
 = 1;

145 #ià(
NGX_HAVE_KQUEUE
)

153 ià(
p
->
up¡»am
->
»ad
->
avažabË
 == 0

154 && 
p
->
up¡»am
->
»ad
->
³ndšg_eof
)

156 
p
->
up¡»am
->
»ad
->
»ady
 = 0;

157 
p
->
up¡»am
->
»ad
->
eof
 = 1;

158 
p
->
up¡»am_eof
 = 1;

159 
p
->
»ad
 = 1;

161 ià(
p
->
up¡»am
->
»ad
->
kq_”ºo
) {

162 
p
->
up¡»am
->
»ad
->
”rÜ
 = 1;

163 
p
->
up¡»am_”rÜ
 = 1;

164 
p
->
up¡»am_eof
 = 0;

166 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
p
->
log
,

167 
p
->
up¡»am
->
»ad
->
kq_”ºo
,

176 ià(
p
->
lim™_¿‹
) {

177 ià(
p
->
up¡»am
->
»ad
->
d–ayed
) {

181 
lim™
 = (
off_t
è
p
->
lim™_¿‹
 * (
	`ngx_time
(è-…->
¡¬t_£c
 + 1)

182 - 
p
->
»ad_Ëngth
;

184 ià(
lim™
 <= 0) {

185 
p
->
up¡»am
->
»ad
->
d–ayed
 = 1;

186 
d–ay
 = (
ngx_m£c_t
è(- 
lim™
 * 1000 / 
p
->
lim™_¿‹
 + 1);

187 
	`ngx_add_tim”
(
p
->
up¡»am
->
»ad
, 
d–ay
);

192 
lim™
 = 0;

195 ià(
p
->
ä“_¿w_bufs
) {

199 
chaš
 = 
p
->
ä“_¿w_bufs
;

200 ià(
p
->
sšgË_buf
) {

201 
p
->
ä“_¿w_bufs
 =…->ä“_¿w_bufs->
Ãxt
;

202 
chaš
->
Ãxt
 = 
NULL
;

204 
p
->
ä“_¿w_bufs
 = 
NULL
;

207 } ià(
p
->
®loÿ‹d
 <…->
bufs
.
num
) {

211 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
p
->
poÞ
,…->
bufs
.
size
);

212 ià(
b
 =ð
NULL
) {

213  
NGX_ABORT
;

216 
p
->
®loÿ‹d
++;

218 
chaš
 = 
	`ngx_®loc_chaš_lšk
(
p
->
poÞ
);

219 ià(
chaš
 =ð
NULL
) {

220  
NGX_ABORT
;

223 
chaš
->
buf
 = 
b
;

224 
chaš
->
Ãxt
 = 
NULL
;

226 } ià(!
p
->
ÿch—bË


227 && 
p
->
down¡»am
->
d©a
 =ðp->
ouut_ùx


228 && 
p
->
down¡»am
->
wr™e
->
»ady


229 && !
p
->
down¡»am
->
wr™e
->
d–ayed
)

236 
p
->
up¡»am_blocked
 = 1;

238 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

243 } ià(
p
->
ÿch—bË


244 || 
p
->
‹mp_fže
->
off£t
 <…->
max_‹mp_fže_size
)

252 
rc
 = 
	`ngx_ev’t_pe_wr™e_chaš_to_‹mp_fže
(
p
);

254 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

255 "p‹m°off£t: %O", 
p
->
‹mp_fže
->
off£t
);

257 ià(
rc
 =ð
NGX_BUSY
) {

261 ià(
rc
 =ð
NGX_AGAIN
) {

262 ià(
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT


263 && 
p
->
up¡»am
->
»ad
->
aùive


264 && 
p
->
up¡»am
->
»ad
->
»ady
)

266 ià(
	`ngx_d–_ev’t
(
p
->
up¡»am
->
»ad
, 
NGX_READ_EVENT
, 0)

267 =ð
NGX_ERROR
)

269  
NGX_ABORT
;

274 ià(
rc
 !ð
NGX_OK
) {

275  
rc
;

278 
chaš
 = 
p
->
ä“_¿w_bufs
;

279 ià(
p
->
sšgË_buf
) {

280 
p
->
ä“_¿w_bufs
 =…->ä“_¿w_bufs->
Ãxt
;

281 
chaš
->
Ãxt
 = 
NULL
;

283 
p
->
ä“_¿w_bufs
 = 
NULL
;

290 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

296 
n
 = 
p
->
up¡»am
->
	`»cv_chaš
Õ->up¡»am, 
chaš
, 
lim™
);

298 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

299 "p»cv chaš: %z", 
n
);

301 ià(
p
->
ä“_¿w_bufs
) {

302 
chaš
->
Ãxt
 = 
p
->
ä“_¿w_bufs
;

304 
p
->
ä“_¿w_bufs
 = 
chaš
;

306 ià(
n
 =ð
NGX_ERROR
) {

307 
p
->
up¡»am_”rÜ
 = 1;

308  
NGX_ERROR
;

311 ià(
n
 =ð
NGX_AGAIN
) {

312 ià(
p
->
sšgË_buf
) {

313 
	`ngx_ev’t_pe_»move_shadow_lšks
(
chaš
->
buf
);

319 
p
->
»ad
 = 1;

321 ià(
n
 == 0) {

322 
p
->
up¡»am_eof
 = 1;

327 
d–ay
 = 
p
->
lim™_¿‹
 ? (
ngx_m£c_t
è
n
 * 1000 /…->limit_rate : 0;

329 
p
->
»ad_Ëngth
 +ð
n
;

330 
þ
 = 
chaš
;

331 
p
->
ä“_¿w_bufs
 = 
NULL
;

333 
þ
 && 
n
 > 0) {

335 
	`ngx_ev’t_pe_»move_shadow_lšks
(
þ
->
buf
);

337 
size
 = 
þ
->
buf
->
’d
 - cl->buf->
Ï¡
;

339 ià(
n
 >ð
size
) {

340 
þ
->
buf
->
Ï¡
 = cl->buf->
’d
;

342  
þ
->
buf
->
num
 = 
p
->num++;

344 ià(
p
->
	`šput_fž‹r
Õ, 
þ
->
buf
è=ð
NGX_ERROR
) {

345  
NGX_ABORT
;

348 
n
 -ð
size
;

349 
Ê
 = 
þ
;

350 
þ
 = cl->
Ãxt
;

351 
	`ngx_ä“_chaš
(
p
->
poÞ
, 
Ê
);

354 
þ
->
buf
->
Ï¡
 +ð
n
;

355 
n
 = 0;

359 ià(
þ
) {

360 
Ê
 = 
þ
;†n->
Ãxt
;†n =†n->next) { }

362 
Ê
->
Ãxt
 = 
p
->
ä“_¿w_bufs
;

363 
p
->
ä“_¿w_bufs
 = 
þ
;

366 ià(
d–ay
 > 0) {

367 
p
->
up¡»am
->
»ad
->
d–ayed
 = 1;

368 
	`ngx_add_tim”
(
p
->
up¡»am
->
»ad
, 
d–ay
);

373 #ià(
NGX_DEBUG
)

375 
þ
 = 
p
->
busy
; cl; cÈðþ->
Ãxt
) {

376 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

380 (
þ
->
buf
->
shadow
 ? 1 : 0),

381 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

382 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

383 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

384 
þ
->
buf
->
fže_pos
,

385 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

388 
þ
 = 
p
->
out
; cl; cÈðþ->
Ãxt
) {

389 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

393 (
þ
->
buf
->
shadow
 ? 1 : 0),

394 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

395 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

396 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

397 
þ
->
buf
->
fže_pos
,

398 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

401 
þ
 = 
p
->
š
; cl; cÈðþ->
Ãxt
) {

402 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

406 (
þ
->
buf
->
shadow
 ? 1 : 0),

407 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

408 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

409 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

410 
þ
->
buf
->
fže_pos
,

411 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

414 
þ
 = 
p
->
ä“_¿w_bufs
; cl; cÈðþ->
Ãxt
) {

415 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

419 (
þ
->
buf
->
shadow
 ? 1 : 0),

420 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

421 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

422 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

423 
þ
->
buf
->
fže_pos
,

424 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

427 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

428 "pËngth: %O", 
p
->
Ëngth
);

432 ià(
p
->
ä“_¿w_bufs
 &&…->
Ëngth
 != -1) {

433 
þ
 = 
p
->
ä“_¿w_bufs
;

435 ià(
þ
->
buf
->
Ï¡
 - cl->buf->
pos
 >ð
p
->
Ëngth
) {

437 
p
->
ä“_¿w_bufs
 = 
þ
->
Ãxt
;

439  
þ
->
buf
->
num
 = 
p
->num++;

441 ià(
p
->
	`šput_fž‹r
Õ, 
þ
->
buf
è=ð
NGX_ERROR
) {

442  
NGX_ABORT
;

445 
	`ngx_ä“_chaš
(
p
->
poÞ
, 
þ
);

449 ià(
p
->
Ëngth
 == 0) {

450 
p
->
up¡»am_dÚe
 = 1;

451 
p
->
»ad
 = 1;

454 ià((
p
->
up¡»am_eof
 ||…->
up¡»am_”rÜ
è&&…->
ä“_¿w_bufs
) {

456  
p
->
ä“_¿w_bufs
->
buf
->
num
 =…->num++;

458 ià(
p
->
	`šput_fž‹r
Õ,…->
ä“_¿w_bufs
->
buf
è=ð
NGX_ERROR
) {

459  
NGX_ABORT
;

462 
p
->
ä“_¿w_bufs
 =…->ä“_¿w_bufs->
Ãxt
;

464 ià(
p
->
ä“_bufs
 &&…->
buf_to_fže
 =ð
NULL
) {

465 
þ
 = 
p
->
ä“_¿w_bufs
; cl; cÈðþ->
Ãxt
) {

466 ià(
þ
->
buf
->
shadow
 =ð
NULL
) {

467 
	`ngx_pä“
(
p
->
poÞ
, 
þ
->
buf
->
¡¬t
);

473 ià(
p
->
ÿch—bË
 && (p->
š
 ||…->
buf_to_fže
)) {

475 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

478 ià(
	`ngx_ev’t_pe_wr™e_chaš_to_‹mp_fže
(
p
è=ð
NGX_ABORT
) {

479  
NGX_ABORT
;

483  
NGX_OK
;

484 
	}
}

487 
ngx_št_t


488 
	$ngx_ev’t_pe_wr™e_to_down¡»am
(
ngx_ev’t_pe_t
 *
p
)

490 
u_ch¬
 *
´ev
;

491 
size_t
 
bsize
;

492 
ngx_št_t
 
rc
;

493 
ngx_ušt_t
 
æush
, 
æushed
, 
´ev_Ï¡_shadow
;

494 
ngx_chaš_t
 *
out
, **
Î
, *
þ
;

495 
ngx_cÚÃùiÚ_t
 *
down¡»am
;

497 
down¡»am
 = 
p
->downstream;

499 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

500 "pwr™down¡»am: %d", 
down¡»am
->
wr™e
->
»ady
);

502 
æushed
 = 0;

505 ià(
p
->
down¡»am_”rÜ
) {

506  
	`ngx_ev’t_pe_d¿š_chašs
(
p
);

509 ià(
p
->
up¡»am_eof
 ||…->
up¡»am_”rÜ
 ||…->
up¡»am_dÚe
) {

513 
þ
 = 
p
->
busy
; cl; cÈðþ->
Ãxt
) {

514 
þ
->
buf
->
»cyþed
 = 0;

517 ià(
p
->
out
) {

518 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

521 
þ
 = 
p
->
out
; cl; cÈðþ->
Ãxt
) {

522 
þ
->
buf
->
»cyþed
 = 0;

525 
rc
 = 
p
->
	`ouut_fž‹r
Õ->
ouut_ùx
,…->
out
);

527 ià(
rc
 =ð
NGX_ERROR
) {

528 
p
->
down¡»am_”rÜ
 = 1;

529  
	`ngx_ev’t_pe_d¿š_chašs
(
p
);

532 
p
->
out
 = 
NULL
;

535 ià(
p
->
š
) {

536 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

539 
þ
 = 
p
->
š
; cl; cÈðþ->
Ãxt
) {

540 
þ
->
buf
->
»cyþed
 = 0;

543 
rc
 = 
p
->
	`ouut_fž‹r
Õ->
ouut_ùx
,…->
š
);

545 ià(
rc
 =ð
NGX_ERROR
) {

546 
p
->
down¡»am_”rÜ
 = 1;

547  
	`ngx_ev’t_pe_d¿š_chašs
(
p
);

550 
p
->
š
 = 
NULL
;

553 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

558 
p
->
down¡»am_dÚe
 = 1;

562 ià(
down¡»am
->
d©a
 !ð
p
->
ouut_ùx


563 || !
down¡»am
->
wr™e
->
»ady


564 || 
down¡»am
->
wr™e
->
d–ayed
)

571 
´ev
 = 
NULL
;

572 
bsize
 = 0;

574 
þ
 = 
p
->
busy
; cl; cÈðþ->
Ãxt
) {

576 ià(
þ
->
buf
->
»cyþed
) {

577 ià(
´ev
 =ð
þ
->
buf
->
¡¬t
) {

581 
bsize
 +ð
þ
->
buf
->
’d
 - cl->buf->
¡¬t
;

582 
´ev
 = 
þ
->
buf
->
¡¬t
;

586 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

587 "pwr™busy: %uz", 
bsize
);

589 
out
 = 
NULL
;

591 ià(
bsize
 >ð(
size_t
è
p
->
busy_size
) {

592 
æush
 = 1;

593 
æush
;

596 
æush
 = 0;

597 
Î
 = 
NULL
;

598 
´ev_Ï¡_shadow
 = 1;

601 ià(
p
->
out
) {

602 
þ
 = 
p
->
out
;

604 ià(
þ
->
buf
->
»cyþed
) {

605 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
p
->
log
, 0,

609 
p
->
out
 =…->out->
Ãxt
;

611 } ià(!
p
->
ÿch—bË
 &&…->
š
) {

612 
þ
 = 
p
->
š
;

614 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

616 
þ
->
buf
->
Ï¡_shadow
,

617 
þ
->
buf
->
pos
,

618 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
);

620 ià(
þ
->
buf
->
»cyþed
 && 
´ev_Ï¡_shadow
) {

621 ià(
bsize
 + 
þ
->
buf
->
’d
 - cl->buf->
¡¬t
 > 
p
->
busy_size
) {

622 
æush
 = 1;

626 
bsize
 +ð
þ
->
buf
->
’d
 - cl->buf->
¡¬t
;

629 
´ev_Ï¡_shadow
 = 
þ
->
buf
->
Ï¡_shadow
;

631 
p
->
š
 =…->š->
Ãxt
;

637 
þ
->
Ãxt
 = 
NULL
;

639 ià(
out
) {

640 *
Î
 = 
þ
;

642 
out
 = 
þ
;

644 
Î
 = &
þ
->
Ãxt
;

647 
æush
:

649 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

650 "pwr™e: out:%p, f:%d", 
out
, 
æush
);

652 ià(
out
 =ð
NULL
) {

654 ià(!
æush
) {

659 ià(
æushed
++ > 10) {

660  
NGX_BUSY
;

664 
rc
 = 
p
->
	`ouut_fž‹r
Õ->
ouut_ùx
, 
out
);

666 
	`ngx_chaš_upd©e_chašs
(
p
->
poÞ
, &p->
ä“
, &p->
busy
, &
out
,…->
g
);

668 ià(
rc
 =ð
NGX_ERROR
) {

669 
p
->
down¡»am_”rÜ
 = 1;

670  
	`ngx_ev’t_pe_d¿š_chašs
(
p
);

673 
þ
 = 
p
->
ä“
; cl; cÈðþ->
Ãxt
) {

675 ià(
þ
->
buf
->
‹mp_fže
) {

676 ià(
p
->
ÿch—bË
 || !p->
cyþic_‹mp_fže
) {

682 ià(
þ
->
buf
->
fže_Ï¡
 =ð
p
->
‹mp_fže
->
off£t
) {

683 
p
->
‹mp_fže
->
off£t
 = 0;

691 ià(
þ
->
buf
->
Ï¡_shadow
) {

692 ià(
	`ngx_ev’t_pe_add_ä“_buf
(
p
, 
þ
->
buf
->
shadow
è!ð
NGX_OK
) {

693  
NGX_ABORT
;

696 
þ
->
buf
->
Ï¡_shadow
 = 0;

699 
þ
->
buf
->
shadow
 = 
NULL
;

703  
NGX_OK
;

704 
	}
}

707 
ngx_št_t


708 
	$ngx_ev’t_pe_wr™e_chaš_to_‹mp_fže
(
ngx_ev’t_pe_t
 *
p
)

710 
ssize_t
 
size
, 
bsize
, 
n
;

711 
ngx_buf_t
 *
b
;

712 
ngx_ušt_t
 
´ev_Ï¡_shadow
;

713 
ngx_chaš_t
 *
þ
, *
Ž
, *
Ãxt
, *
out
, **
Î
, **
Ï¡_out
, **
Ï¡_ä“
, 
æ
;

715 ià(
p
->
buf_to_fže
) {

716 
æ
.
buf
 = 
p
->
buf_to_fže
;

717 
æ
.
Ãxt
 = 
p
->
š
;

718 
out
 = &
æ
;

721 
out
 = 
p
->
š
;

724 ià(!
p
->
ÿch—bË
) {

726 
size
 = 0;

727 
þ
 = 
out
;

728 
Î
 = 
NULL
;

729 
´ev_Ï¡_shadow
 = 1;

731 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

732 "poff£t: %O", 
p
->
‹mp_fže
->
off£t
);

735 
bsize
 = 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

737 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

739 
þ
->
buf
->
Ï¡_shadow
, cl->buf->
¡¬t
,

740 
þ
->
buf
->
pos
, 
bsize
);

742 ià(
´ev_Ï¡_shadow


743 && ((
size
 + 
bsize
 > 
p
->
‹mp_fže_wr™e_size
)

744 || (
p
->
‹mp_fže
->
off£t
 + 
size
 + 
bsize


745 > 
p
->
max_‹mp_fže_size
)))

750 
´ev_Ï¡_shadow
 = 
þ
->
buf
->
Ï¡_shadow
;

752 
size
 +ð
bsize
;

753 
Î
 = &
þ
->
Ãxt
;

754 
þ
 = cl->
Ãxt
;

756 } 
þ
);

758 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0, "size: %z", 
size
);

760 ià(
Î
 =ð
NULL
) {

761  
NGX_BUSY
;

764 ià(
þ
) {

765 
p
->
š
 = 
þ
;

766 *
Î
 = 
NULL
;

769 
p
->
š
 = 
NULL
;

770 
p
->
Ï¡_š
 = &p->
š
;

774 
p
->
š
 = 
NULL
;

775 
p
->
Ï¡_š
 = &p->
š
;

778 
n
 = 
	`ngx_wr™e_chaš_to_‹mp_fže
(
p
->
‹mp_fže
, 
out
);

780 ià(
n
 =ð
NGX_ERROR
) {

781  
NGX_ABORT
;

784 ià(
p
->
buf_to_fže
) {

785 
p
->
‹mp_fže
->
off£t
 =…->
buf_to_fže
->
Ï¡
 -…->buf_to_fže->
pos
;

786 
n
 -ð
p
->
buf_to_fže
->
Ï¡
 -…->buf_to_fže->
pos
;

787 
p
->
buf_to_fže
 = 
NULL
;

788 
out
 = out->
Ãxt
;

791 ià(
n
 > 0) {

794 ià(
p
->
out
) {

795 
þ
 = 
p
->
out
; cl->
Ãxt
; cl = cl->next) { }

797 
b
 = 
þ
->
buf
;

799 ià(
b
->
fže_Ï¡
 =ð
p
->
‹mp_fže
->
off£t
) {

800 
p
->
‹mp_fže
->
off£t
 +ð
n
;

801 
b
->
fže_Ï¡
 = 
p
->
‹mp_fže
->
off£t
;

802 
ä“
;

805 
Ï¡_out
 = &
þ
->
Ãxt
;

808 
Ï¡_out
 = &
p
->
out
;

811 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
p
->
poÞ
, &p->
ä“
);

812 ià(
þ
 =ð
NULL
) {

813  
NGX_ABORT
;

816 
b
 = 
þ
->
buf
;

818 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

820 
b
->
g
 = 
p
->tag;

822 
b
->
fže
 = &
p
->
‹mp_fže
->file;

823 
b
->
fže_pos
 = 
p
->
‹mp_fže
->
off£t
;

824 
p
->
‹mp_fže
->
off£t
 +ð
n
;

825 
b
->
fže_Ï¡
 = 
p
->
‹mp_fže
->
off£t
;

827 
b
->
š_fže
 = 1;

828 
b
->
‹mp_fže
 = 1;

830 *
Ï¡_out
 = 
þ
;

833 
ä“
:

835 
Ï¡_ä“
 = &
p
->
ä“_¿w_bufs
;

836 *
Ï¡_ä“
 !ð
NULL
;

837 
Ï¡_ä“
 = &(*Ï¡_ä“)->
Ãxt
)

842 
þ
 = 
out
; cl; cÈð
Ãxt
) {

843 
Ãxt
 = 
þ
->next;

845 
þ
->
Ãxt
 = 
p
->
ä“
;

846 
p
->
ä“
 = 
þ
;

848 
b
 = 
þ
->
buf
;

850 ià(
b
->
Ï¡_shadow
) {

852 
Ž
 = 
	`ngx_®loc_chaš_lšk
(
p
->
poÞ
);

853 ià(
Ž
 =ð
NULL
) {

854  
NGX_ABORT
;

857 
Ž
->
buf
 = 
b
->
shadow
;

858 
Ž
->
Ãxt
 = 
NULL
;

860 *
Ï¡_ä“
 = 
Ž
;

861 
Ï¡_ä“
 = &
Ž
->
Ãxt
;

863 
b
->
shadow
->
pos
 = b->shadow->
¡¬t
;

864 
b
->
shadow
->
Ï¡
 = b->shadow->
¡¬t
;

866 
	`ngx_ev’t_pe_»move_shadow_lšks
(
b
->
shadow
);

870  
NGX_OK
;

871 
	}
}

876 
ngx_št_t


877 
	$ngx_ev’t_pe_cÝy_šput_fž‹r
(
ngx_ev’t_pe_t
 *
p
, 
ngx_buf_t
 *
buf
)

879 
ngx_buf_t
 *
b
;

880 
ngx_chaš_t
 *
þ
;

882 ià(
buf
->
pos
 =ðbuf->
Ï¡
) {

883  
NGX_OK
;

886 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
p
->
poÞ
, &p->
ä“
);

887 ià(
þ
 =ð
NULL
) {

888  
NGX_ERROR
;

891 
b
 = 
þ
->
buf
;

893 
	`ngx_memýy
(
b
, 
buf
, (
ngx_buf_t
));

894 
b
->
shadow
 = 
buf
;

895 
b
->
g
 = 
p
->tag;

896 
b
->
Ï¡_shadow
 = 1;

897 
b
->
»cyþed
 = 1;

898 
buf
->
shadow
 = 
b
;

900 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0, "špuˆbuà#%d", 
b
->
num
);

902 ià(
p
->
š
) {

903 *
p
->
Ï¡_š
 = 
þ
;

905 
p
->
š
 = 
þ
;

907 
p
->
Ï¡_š
 = &
þ
->
Ãxt
;

909 ià(
p
->
Ëngth
 == -1) {

910  
NGX_OK
;

913 
p
->
Ëngth
 -ð
b
->
Ï¡
 - b->
pos
;

915  
NGX_OK
;

916 
	}
}

919 
ngx_šlše
 

920 
	$ngx_ev’t_pe_»move_shadow_lšks
(
ngx_buf_t
 *
buf
)

922 
ngx_buf_t
 *
b
, *
Ãxt
;

924 
b
 = 
buf
->
shadow
;

926 ià(
b
 =ð
NULL
) {

930 !
b
->
Ï¡_shadow
) {

931 
Ãxt
 = 
b
->
shadow
;

933 
b
->
‹mpÜ¬y
 = 0;

934 
b
->
»cyþed
 = 0;

936 
b
->
shadow
 = 
NULL
;

937 
b
 = 
Ãxt
;

940 
b
->
‹mpÜ¬y
 = 0;

941 
b
->
»cyþed
 = 0;

942 
b
->
Ï¡_shadow
 = 0;

944 
b
->
shadow
 = 
NULL
;

946 
buf
->
shadow
 = 
NULL
;

947 
	}
}

950 
ngx_št_t


951 
	$ngx_ev’t_pe_add_ä“_buf
(
ngx_ev’t_pe_t
 *
p
, 
ngx_buf_t
 *
b
)

953 
ngx_chaš_t
 *
þ
;

955 
þ
 = 
	`ngx_®loc_chaš_lšk
(
p
->
poÞ
);

956 ià(
þ
 =ð
NULL
) {

957  
NGX_ERROR
;

960 ià(
p
->
buf_to_fže
 && 
b
->
¡¬t
 ==…->buf_to_file->start) {

961 
b
->
pos
 = 
p
->
buf_to_fže
->
Ï¡
;

962 
b
->
Ï¡
 = 
p
->
buf_to_fže
->last;

965 
b
->
pos
 = b->
¡¬t
;

966 
b
->
Ï¡
 = b->
¡¬t
;

969 
b
->
shadow
 = 
NULL
;

971 
þ
->
buf
 = 
b
;

973 ià(
p
->
ä“_¿w_bufs
 =ð
NULL
) {

974 
p
->
ä“_¿w_bufs
 = 
þ
;

975 
þ
->
Ãxt
 = 
NULL
;

977  
NGX_OK
;

980 ià(
p
->
ä“_¿w_bufs
->
buf
->
pos
 =ðp->ä“_¿w_bufs->buf->
Ï¡
) {

984 
þ
->
Ãxt
 = 
p
->
ä“_¿w_bufs
;

985 
p
->
ä“_¿w_bufs
 = 
þ
;

987  
NGX_OK
;

992 
þ
->
Ãxt
 = 
p
->
ä“_¿w_bufs
->next;

993 
p
->
ä“_¿w_bufs
->
Ãxt
 = 
þ
;

995  
NGX_OK
;

996 
	}
}

999 
ngx_št_t


1000 
	$ngx_ev’t_pe_d¿š_chašs
(
ngx_ev’t_pe_t
 *
p
)

1002 
ngx_chaš_t
 *
þ
, *
Ž
;

1005 ià(
p
->
busy
) {

1006 
þ
 = 
p
->
busy
;

1007 
p
->
busy
 = 
NULL
;

1009 } ià(
p
->
out
) {

1010 
þ
 = 
p
->
out
;

1011 
p
->
out
 = 
NULL
;

1013 } ià(
p
->
š
) {

1014 
þ
 = 
p
->
š
;

1015 
p
->
š
 = 
NULL
;

1018  
NGX_OK
;

1021 
þ
) {

1022 ià(
þ
->
buf
->
Ï¡_shadow
) {

1023 ià(
	`ngx_ev’t_pe_add_ä“_buf
(
p
, 
þ
->
buf
->
shadow
è!ð
NGX_OK
) {

1024  
NGX_ABORT
;

1027 
þ
->
buf
->
Ï¡_shadow
 = 0;

1030 
þ
->
buf
->
shadow
 = 
NULL
;

1031 
Ž
 = 
þ
->
Ãxt
;

1032 
þ
->
Ãxt
 = 
p
->
ä“
;

1033 
p
->
ä“
 = 
þ
;

1034 
þ
 = 
Ž
;

1037 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_posted.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_queue_t
 
	gngx_po¡ed_acû±_ev’ts
;

14 
ngx_queue_t
 
	gngx_po¡ed_ev’ts
;

18 
	$ngx_ev’t_´oûss_po¡ed
(
ngx_cyþe_t
 *
cyþe
, 
ngx_queue_t
 *
po¡ed
)

20 
ngx_queue_t
 *
q
;

21 
ngx_ev’t_t
 *
ev
;

23 !
	`ngx_queue_em±y
(
po¡ed
)) {

25 
q
 = 
	`ngx_queue_h—d
(
po¡ed
);

26 
ev
 = 
	`ngx_queue_d©a
(
q
, 
ngx_ev’t_t
, 
queue
);

28 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

29 "po¡edƒv’ˆ%p", 
ev
);

31 
	`ngx_d–‘e_po¡ed_ev’t
(
ev
);

33 
ev
->
	`hªdËr
(ev);

35 
	}
}

	@/home/wuhong/github/google/ngx_google/src/event/ngx_event_timer.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_rbŒ“_t
 
	gngx_ev’t_tim”_rbŒ“
;

14 
ngx_rbŒ“_node_t
 
	gngx_ev’t_tim”_£Áš–
;

22 
ngx_št_t


23 
	$ngx_ev’t_tim”_š™
(
ngx_log_t
 *
log
)

25 
	`ngx_rbŒ“_š™
(&
ngx_ev’t_tim”_rbŒ“
, &
ngx_ev’t_tim”_£Áš–
,

26 
ngx_rbŒ“_š£¹_tim”_v®ue
);

28  
NGX_OK
;

29 
	}
}

32 
ngx_m£c_t


33 
	$ngx_ev’t_fšd_tim”
()

35 
ngx_m£c_št_t
 
tim”
;

36 
ngx_rbŒ“_node_t
 *
node
, *
roÙ
, *
£Áš–
;

38 ià(
ngx_ev’t_tim”_rbŒ“
.
roÙ
 =ð&
ngx_ev’t_tim”_£Áš–
) {

39  
NGX_TIMER_INFINITE
;

42 
roÙ
 = 
ngx_ev’t_tim”_rbŒ“
.root;

43 
£Áš–
 = 
ngx_ev’t_tim”_rbŒ“
.sentinel;

45 
node
 = 
	`ngx_rbŒ“_mš
(
roÙ
, 
£Áš–
);

47 
tim”
 = (
ngx_m£c_št_t
è(
node
->
key
 - 
ngx_cu¼’t_m£c
);

49  (
ngx_m£c_t
è(
tim”
 > 0 ?imer : 0);

50 
	}
}

54 
	$ngx_ev’t_expœe_tim”s
()

56 
ngx_ev’t_t
 *
ev
;

57 
ngx_rbŒ“_node_t
 *
node
, *
roÙ
, *
£Áš–
;

59 
£Áš–
 = 
ngx_ev’t_tim”_rbŒ“
.sentinel;

62 
roÙ
 = 
ngx_ev’t_tim”_rbŒ“
.root;

64 ià(
roÙ
 =ð
£Áš–
) {

68 
node
 = 
	`ngx_rbŒ“_mš
(
roÙ
, 
£Áš–
);

72 ià((
ngx_m£c_št_t
è(
node
->
key
 - 
ngx_cu¼’t_m£c
) > 0) {

76 
ev
 = (
ngx_ev’t_t
 *è((*è
node
 - 
	`off£tof
Ògx_ev’t_t, 
tim”
));

78 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

80 
	`ngx_ev’t_id’t
(
ev
->
d©a
),ƒv->
tim”
.
key
);

82 
	`ngx_rbŒ“_d–‘e
(&
ngx_ev’t_tim”_rbŒ“
, &
ev
->
tim”
);

84 #ià(
NGX_DEBUG
)

85 
ev
->
tim”
.
Ëá
 = 
NULL
;

86 
ev
->
tim”
.
right
 = 
NULL
;

87 
ev
->
tim”
.
·»Á
 = 
NULL
;

90 
ev
->
tim”_£t
 = 0;

92 
ev
->
timedout
 = 1;

94 
ev
->
	`hªdËr
(ev);

96 
	}
}

100 
	$ngx_ev’t_ÿnûl_tim”s
()

102 
ngx_ev’t_t
 *
ev
;

103 
ngx_rbŒ“_node_t
 *
node
, *
roÙ
, *
£Áš–
;

105 
£Áš–
 = 
ngx_ev’t_tim”_rbŒ“
.sentinel;

108 
roÙ
 = 
ngx_ev’t_tim”_rbŒ“
.root;

110 ià(
roÙ
 =ð
£Áš–
) {

114 
node
 = 
	`ngx_rbŒ“_mš
(
roÙ
, 
£Áš–
);

116 
ev
 = (
ngx_ev’t_t
 *è((*è
node
 - 
	`off£tof
Ògx_ev’t_t, 
tim”
));

118 ià(!
ev
->
ÿnûÏbË
) {

122 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

124 
	`ngx_ev’t_id’t
(
ev
->
d©a
),ƒv->
tim”
.
key
);

126 
	`ngx_rbŒ“_d–‘e
(&
ngx_ev’t_tim”_rbŒ“
, &
ev
->
tim”
);

128 #ià(
NGX_DEBUG
)

129 
ev
->
tim”
.
Ëá
 = 
NULL
;

130 
ev
->
tim”
.
right
 = 
NULL
;

131 
ev
->
tim”
.
·»Á
 = 
NULL
;

134 
ev
->
tim”_£t
 = 0;

136 
ev
->
	`hªdËr
(ev);

138 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_access_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
š_addr_t
 
	mmask
;

15 
š_addr_t
 
	maddr
;

16 
ngx_ušt_t
 
	md’y
;

17 } 
	tngx_h‰p_acûss_ruË_t
;

19 #ià(
NGX_HAVE_INET6
)

22 
š6_addr
 
	maddr
;

23 
š6_addr
 
	mmask
;

24 
ngx_ušt_t
 
	md’y
;

25 } 
	tngx_h‰p_acûss_ruË6_t
;

29 #ià(
NGX_HAVE_UNIX_DOMAIN
)

32 
ngx_ušt_t
 
	md’y
;

33 } 
	tngx_h‰p_acûss_ruË_un_t
;

38 
ngx_¬¿y_t
 *
	mruËs
;

39 #ià(
NGX_HAVE_INET6
)

40 
ngx_¬¿y_t
 *
	mruËs6
;

42 #ià(
NGX_HAVE_UNIX_DOMAIN
)

43 
ngx_¬¿y_t
 *
	mruËs_un
;

45 } 
	tngx_h‰p_acûss_loc_cÚf_t
;

48 
ngx_št_t
 
ngx_h‰p_acûss_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

49 
ngx_št_t
 
ngx_h‰p_acûss_š‘
(
ngx_h‰p_»que¡_t
 *
r
,

50 
ngx_h‰p_acûss_loc_cÚf_t
 *
®cf
, 
š_addr_t
 
addr
);

51 #ià(
NGX_HAVE_INET6
)

52 
ngx_št_t
 
ngx_h‰p_acûss_š‘6
(
ngx_h‰p_»que¡_t
 *
r
,

53 
ngx_h‰p_acûss_loc_cÚf_t
 *
®cf
, 
u_ch¬
 *
p
);

55 #ià(
NGX_HAVE_UNIX_DOMAIN
)

56 
ngx_št_t
 
ngx_h‰p_acûss_unix
(
ngx_h‰p_»que¡_t
 *
r
,

57 
ngx_h‰p_acûss_loc_cÚf_t
 *
®cf
);

59 
ngx_št_t
 
ngx_h‰p_acûss_found
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
d’y
);

60 *
ngx_h‰p_acûss_ruË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

61 *
cÚf
);

62 *
ngx_h‰p_acûss_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

63 *
ngx_h‰p_acûss_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

64 *
·»Á
, *
chžd
);

65 
ngx_št_t
 
ngx_h‰p_acûss_š™
(
ngx_cÚf_t
 *
cf
);

68 
ngx_commªd_t
 
	gngx_h‰p_acûss_commªds
[] = {

70 { 
ngx_¡ršg
("allow"),

71 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LMT_CONF


72 |
NGX_CONF_TAKE1
,

73 
ngx_h‰p_acûss_ruË
,

74 
NGX_HTTP_LOC_CONF_OFFSET
,

76 
NULL
 },

78 { 
ngx_¡ršg
("deny"),

79 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LMT_CONF


80 |
NGX_CONF_TAKE1
,

81 
ngx_h‰p_acûss_ruË
,

82 
NGX_HTTP_LOC_CONF_OFFSET
,

84 
NULL
 },

86 
ngx_nuÎ_commªd


91 
ngx_h‰p_moduË_t
 
	gngx_h‰p_acûss_moduË_ùx
 = {

92 
NULL
,

93 
ngx_h‰p_acûss_š™
,

95 
NULL
,

96 
NULL
,

98 
NULL
,

99 
NULL
,

101 
ngx_h‰p_acûss_ü—‹_loc_cÚf
,

102 
ngx_h‰p_acûss_m”ge_loc_cÚf


106 
ngx_moduË_t
 
	gngx_h‰p_acûss_moduË
 = {

107 
NGX_MODULE_V1
,

108 &
ngx_h‰p_acûss_moduË_ùx
,

109 
ngx_h‰p_acûss_commªds
,

110 
NGX_HTTP_MODULE
,

111 
NULL
,

112 
NULL
,

113 
NULL
,

114 
NULL
,

115 
NULL
,

116 
NULL
,

117 
NULL
,

118 
NGX_MODULE_V1_PADDING


122 
ngx_št_t


123 
	$ngx_h‰p_acûss_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

125 
sockaddr_š
 *
sš
;

126 
ngx_h‰p_acûss_loc_cÚf_t
 *
®cf
;

127 #ià(
NGX_HAVE_INET6
)

128 
u_ch¬
 *
p
;

129 
š_addr_t
 
addr
;

130 
sockaddr_š6
 *
sš6
;

133 
®cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_acûss_moduË
);

135 
r
->
cÚÃùiÚ
->
sockaddr
->
§_çmžy
) {

137 
AF_INET
:

138 ià(
®cf
->
ruËs
) {

139 
sš
 = (
sockaddr_š
 *è
r
->
cÚÃùiÚ
->
sockaddr
;

140  
	`ngx_h‰p_acûss_š‘
(
r
, 
®cf
, 
sš
->
sš_addr
.
s_addr
);

144 #ià(
NGX_HAVE_INET6
)

146 
AF_INET6
:

147 
sš6
 = (
sockaddr_š6
 *è
r
->
cÚÃùiÚ
->
sockaddr
;

148 
p
 = 
sš6
->
sš6_addr
.
s6_addr
;

150 ià(
®cf
->
ruËs
 && 
	`IN6_IS_ADDR_V4MAPPED
(&
sš6
->
sš6_addr
)) {

151 
addr
 = 
p
[12] << 24;

152 
addr
 +ð
p
[13] << 16;

153 
addr
 +ð
p
[14] << 8;

154 
addr
 +ð
p
[15];

155  
	`ngx_h‰p_acûss_š‘
(
r
, 
®cf
, 
	`htÚl
(
addr
));

158 ià(
®cf
->
ruËs6
) {

159  
	`ngx_h‰p_acûss_š‘6
(
r
, 
®cf
, 
p
);

166 #ià(
NGX_HAVE_UNIX_DOMAIN
)

168 
AF_UNIX
:

169 ià(
®cf
->
ruËs_un
) {

170  
	`ngx_h‰p_acûss_unix
(
r
, 
®cf
);

178  
NGX_DECLINED
;

179 
	}
}

182 
ngx_št_t


183 
	$ngx_h‰p_acûss_š‘
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_acûss_loc_cÚf_t
 *
®cf
,

184 
š_addr_t
 
addr
)

186 
ngx_ušt_t
 
i
;

187 
ngx_h‰p_acûss_ruË_t
 *
ruË
;

189 
ruË
 = 
®cf
->
ruËs
->
–ts
;

190 
i
 = 0; i < 
®cf
->
ruËs
->
ÃÉs
; i++) {

192 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

194 
addr
, 
ruË
[
i
].
mask
,„ule[i].addr);

196 ià((
addr
 & 
ruË
[
i
].
mask
) ==„ule[i].addr) {

197  
	`ngx_h‰p_acûss_found
(
r
, 
ruË
[
i
].
d’y
);

201  
NGX_DECLINED
;

202 
	}
}

205 #ià(
NGX_HAVE_INET6
)

207 
ngx_št_t


208 
	$ngx_h‰p_acûss_š‘6
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_acûss_loc_cÚf_t
 *
®cf
,

209 
u_ch¬
 *
p
)

211 
ngx_ušt_t
 
n
;

212 
ngx_ušt_t
 
i
;

213 
ngx_h‰p_acûss_ruË6_t
 *
ruË6
;

215 
ruË6
 = 
®cf
->
ruËs6
->
–ts
;

216 
i
 = 0; i < 
®cf
->
ruËs6
->
ÃÉs
; i++) {

218 #ià(
NGX_DEBUG
)

220 
size_t
 
þ
, 
ml
, 
®
;

221 
u_ch¬
 
ù
[
NGX_INET6_ADDRSTRLEN
];

222 
u_ch¬
 
mt
[
NGX_INET6_ADDRSTRLEN
];

223 
u_ch¬
 
©
[
NGX_INET6_ADDRSTRLEN
];

225 
þ
 = 
	`ngx_š‘6_ÁÝ
(
p
, 
ù
, 
NGX_INET6_ADDRSTRLEN
);

226 
ml
 = 
	`ngx_š‘6_ÁÝ
(
ruË6
[
i
].
mask
.
s6_addr
, 
mt
, 
NGX_INET6_ADDRSTRLEN
);

227 
®
 = 
	`ngx_š‘6_ÁÝ
(
ruË6
[
i
].
addr
.
s6_addr
, 
©
, 
NGX_INET6_ADDRSTRLEN
);

229 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

230 "acûss: %* %* %*s", 
þ
, 
ù
, 
ml
, 
mt
, 
®
, 
©
);

234 
n
 = 0;‚ < 16;‚++) {

235 ià((
p
[
n
] & 
ruË6
[
i
].
mask
.
s6_addr
[n]è!ðruË6[i].
addr
.s6_addr[n]) {

236 
Ãxt
;

240  
	`ngx_h‰p_acûss_found
(
r
, 
ruË6
[
i
].
d’y
);

242 
Ãxt
:

246  
NGX_DECLINED
;

247 
	}
}

252 #ià(
NGX_HAVE_UNIX_DOMAIN
)

254 
ngx_št_t


255 
	$ngx_h‰p_acûss_unix
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_acûss_loc_cÚf_t
 *
®cf
)

257 
ngx_ušt_t
 
i
;

258 
ngx_h‰p_acûss_ruË_un_t
 *
ruË_un
;

260 
ruË_un
 = 
®cf
->
ruËs_un
->
–ts
;

261 
i
 = 0; i < 
®cf
->
ruËs_un
->
ÃÉs
; i++) {

265  
	`ngx_h‰p_acûss_found
(
r
, 
ruË_un
[
i
].
d’y
);

269  
NGX_DECLINED
;

270 
	}
}

275 
ngx_št_t


276 
	$ngx_h‰p_acûss_found
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
d’y
)

278 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

280 ià(
d’y
) {

281 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

283 ià(
þcf
->
§tisfy
 =ð
NGX_HTTP_SATISFY_ALL
) {

284 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

288  
NGX_HTTP_FORBIDDEN
;

291  
NGX_OK
;

292 
	}
}

296 
	$ngx_h‰p_acûss_ruË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

298 
ngx_h‰p_acûss_loc_cÚf_t
 *
®cf
 = 
cÚf
;

300 
ngx_št_t
 
rc
;

301 
ngx_ušt_t
 
®l
;

302 
ngx_¡r_t
 *
v®ue
;

303 
ngx_cidr_t
 
cidr
;

304 
ngx_h‰p_acûss_ruË_t
 *
ruË
;

305 #ià(
NGX_HAVE_INET6
)

306 
ngx_h‰p_acûss_ruË6_t
 *
ruË6
;

308 #ià(
NGX_HAVE_UNIX_DOMAIN
)

309 
ngx_h‰p_acûss_ruË_un_t
 *
ruË_un
;

312 
	`ngx_memz”o
(&
cidr
, (
ngx_cidr_t
));

314 
v®ue
 = 
cf
->
¬gs
->
–ts
;

316 
®l
 = (
v®ue
[1].
Ën
 =ð3 && 
	`ngx_¡rcmp
(v®ue[1].
d©a
, "all") == 0);

318 ià(!
®l
) {

320 #ià(
NGX_HAVE_UNIX_DOMAIN
)

322 ià(
v®ue
[1].
Ën
 =ð5 && 
	`ngx_¡rcmp
(v®ue[1].
d©a
, "unix:") == 0) {

323 
cidr
.
çmžy
 = 
AF_UNIX
;

324 
rc
 = 
NGX_OK
;

327 
rc
 = 
	`ngx_±ocidr
(&
v®ue
[1], &
cidr
);

331 
rc
 = 
	`ngx_±ocidr
(&
v®ue
[1], &
cidr
);

334 ià(
rc
 =ð
NGX_ERROR
) {

335 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

336 "šv®id…¬am‘” \"%V\"", &
v®ue
[1]);

337  
NGX_CONF_ERROR
;

340 ià(
rc
 =ð
NGX_DONE
) {

341 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

342 "low‡dd»s b™ oà%V‡» m—nšgËss", &
v®ue
[1]);

346 ià(
cidr
.
çmžy
 =ð
AF_INET
 || 
®l
) {

348 ià(
®cf
->
ruËs
 =ð
NULL
) {

349 
®cf
->
ruËs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4,

350 (
ngx_h‰p_acûss_ruË_t
));

351 ià(
®cf
->
ruËs
 =ð
NULL
) {

352  
NGX_CONF_ERROR
;

356 
ruË
 = 
	`ngx_¬¿y_push
(
®cf
->
ruËs
);

357 ià(
ruË
 =ð
NULL
) {

358  
NGX_CONF_ERROR
;

361 
ruË
->
mask
 = 
cidr
.
u
.
š
.mask;

362 
ruË
->
addr
 = 
cidr
.
u
.
š
.addr;

363 
ruË
->
d’y
 = (
v®ue
[0].
d©a
[0] == 'd') ? 1 : 0;

366 #ià(
NGX_HAVE_INET6
)

367 ià(
cidr
.
çmžy
 =ð
AF_INET6
 || 
®l
) {

369 ià(
®cf
->
ruËs6
 =ð
NULL
) {

370 
®cf
->
ruËs6
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4,

371 (
ngx_h‰p_acûss_ruË6_t
));

372 ià(
®cf
->
ruËs6
 =ð
NULL
) {

373  
NGX_CONF_ERROR
;

377 
ruË6
 = 
	`ngx_¬¿y_push
(
®cf
->
ruËs6
);

378 ià(
ruË6
 =ð
NULL
) {

379  
NGX_CONF_ERROR
;

382 
ruË6
->
mask
 = 
cidr
.
u
.
š6
.mask;

383 
ruË6
->
addr
 = 
cidr
.
u
.
š6
.addr;

384 
ruË6
->
d’y
 = (
v®ue
[0].
d©a
[0] == 'd') ? 1 : 0;

388 #ià(
NGX_HAVE_UNIX_DOMAIN
)

389 ià(
cidr
.
çmžy
 =ð
AF_UNIX
 || 
®l
) {

391 ià(
®cf
->
ruËs_un
 =ð
NULL
) {

392 
®cf
->
ruËs_un
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1,

393 (
ngx_h‰p_acûss_ruË_un_t
));

394 ià(
®cf
->
ruËs_un
 =ð
NULL
) {

395  
NGX_CONF_ERROR
;

399 
ruË_un
 = 
	`ngx_¬¿y_push
(
®cf
->
ruËs_un
);

400 ià(
ruË_un
 =ð
NULL
) {

401  
NGX_CONF_ERROR
;

404 
ruË_un
->
d’y
 = (
v®ue
[0].
d©a
[0] == 'd') ? 1 : 0;

408  
NGX_CONF_OK
;

409 
	}
}

413 
	$ngx_h‰p_acûss_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

415 
ngx_h‰p_acûss_loc_cÚf_t
 *
cÚf
;

417 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_acûss_loc_cÚf_t
));

418 ià(
cÚf
 =ð
NULL
) {

419  
NULL
;

422  
cÚf
;

423 
	}
}

427 
	$ngx_h‰p_acûss_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

429 
ngx_h‰p_acûss_loc_cÚf_t
 *
´ev
 = 
·»Á
;

430 
ngx_h‰p_acûss_loc_cÚf_t
 *
cÚf
 = 
chžd
;

432 ià(
cÚf
->
ruËs
 =ð
NULL


433 #ià(
NGX_HAVE_INET6
)

434 && 
cÚf
->
ruËs6
 =ð
NULL


436 #ià(
NGX_HAVE_UNIX_DOMAIN
)

437 && 
cÚf
->
ruËs_un
 =ð
NULL


440 
cÚf
->
ruËs
 = 
´ev
->rules;

441 #ià(
NGX_HAVE_INET6
)

442 
cÚf
->
ruËs6
 = 
´ev
->rules6;

444 #ià(
NGX_HAVE_UNIX_DOMAIN
)

445 
cÚf
->
ruËs_un
 = 
´ev
->rules_un;

449  
NGX_CONF_OK
;

450 
	}
}

453 
ngx_št_t


454 
	$ngx_h‰p_acûss_š™
(
ngx_cÚf_t
 *
cf
)

456 
ngx_h‰p_hªdËr_±
 *
h
;

457 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

459 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

461 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_ACCESS_PHASE
].
hªdËrs
);

462 ià(
h
 =ð
NULL
) {

463  
NGX_ERROR
;

466 *
h
 = 
ngx_h‰p_acûss_hªdËr
;

468  
NGX_OK
;

469 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_addition_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_¡r_t
 
	mbefÜe_body
;

15 
ngx_¡r_t
 
	maá”_body
;

17 
ngx_hash_t
 
	mty³s
;

18 
ngx_¬¿y_t
 *
	mty³s_keys
;

19 } 
	tngx_h‰p_add™iÚ_cÚf_t
;

23 
ngx_ušt_t
 
	mbefÜe_body_£Á
;

24 } 
	tngx_h‰p_add™iÚ_ùx_t
;

27 *
ngx_h‰p_add™iÚ_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

28 *
ngx_h‰p_add™iÚ_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

29 *
chžd
);

30 
ngx_št_t
 
ngx_h‰p_add™iÚ_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

33 
ngx_commªd_t
 
	gngx_h‰p_add™iÚ_commªds
[] = {

35 { 
ngx_¡ršg
("add_before_body"),

36 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

37 
ngx_cÚf_£t_¡r_¦Ù
,

38 
NGX_HTTP_LOC_CONF_OFFSET
,

39 
off£tof
(
ngx_h‰p_add™iÚ_cÚf_t
, 
befÜe_body
),

40 
NULL
 },

42 { 
ngx_¡ršg
("add_after_body"),

43 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

44 
ngx_cÚf_£t_¡r_¦Ù
,

45 
NGX_HTTP_LOC_CONF_OFFSET
,

46 
off£tof
(
ngx_h‰p_add™iÚ_cÚf_t
, 
aá”_body
),

47 
NULL
 },

49 { 
ngx_¡ršg
("addition_types"),

50 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

51 
ngx_h‰p_ty³s_¦Ù
,

52 
NGX_HTTP_LOC_CONF_OFFSET
,

53 
off£tof
(
ngx_h‰p_add™iÚ_cÚf_t
, 
ty³s_keys
),

54 &
ngx_h‰p_html_deçuÉ_ty³s
[0] },

56 
ngx_nuÎ_commªd


60 
ngx_h‰p_moduË_t
 
	gngx_h‰p_add™iÚ_fž‹r_moduË_ùx
 = {

61 
NULL
,

62 
ngx_h‰p_add™iÚ_fž‹r_š™
,

64 
NULL
,

65 
NULL
,

67 
NULL
,

68 
NULL
,

70 
ngx_h‰p_add™iÚ_ü—‹_cÚf
,

71 
ngx_h‰p_add™iÚ_m”ge_cÚf


75 
ngx_moduË_t
 
	gngx_h‰p_add™iÚ_fž‹r_moduË
 = {

76 
NGX_MODULE_V1
,

77 &
ngx_h‰p_add™iÚ_fž‹r_moduË_ùx
,

78 
ngx_h‰p_add™iÚ_commªds
,

79 
NGX_HTTP_MODULE
,

80 
NULL
,

81 
NULL
,

82 
NULL
,

83 
NULL
,

84 
NULL
,

85 
NULL
,

86 
NULL
,

87 
NGX_MODULE_V1_PADDING


91 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

92 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

95 
ngx_št_t


96 
	$ngx_h‰p_add™iÚ_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

98 
ngx_h‰p_add™iÚ_ùx_t
 *
ùx
;

99 
ngx_h‰p_add™iÚ_cÚf_t
 *
cÚf
;

101 ià(
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_OK
 ||„ !ðr->
maš
) {

102  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

105 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_add™iÚ_fž‹r_moduË
);

107 ià(
cÚf
->
befÜe_body
.
Ën
 =ð0 && cÚf->
aá”_body
.len == 0) {

108  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

111 ià(
	`ngx_h‰p_‹¡_cÚ‹Á_ty³
(
r
, &
cÚf
->
ty³s
è=ð
NULL
) {

112  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

115 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_add™iÚ_ùx_t
));

116 ià(
ùx
 =ð
NULL
) {

117  
NGX_ERROR
;

120 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_add™iÚ_fž‹r_moduË
);

122 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
r
);

123 
	`ngx_h‰p_þ—r_acû±_¿nges
(
r
);

124 
	`ngx_h‰p_w—k_‘ag
(
r
);

126  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

127 
	}
}

130 
ngx_št_t


131 
	$ngx_h‰p_add™iÚ_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

133 
ngx_št_t
 
rc
;

134 
ngx_ušt_t
 
Ï¡
;

135 
ngx_chaš_t
 *
þ
;

136 
ngx_h‰p_»que¡_t
 *
¤
;

137 
ngx_h‰p_add™iÚ_ùx_t
 *
ùx
;

138 
ngx_h‰p_add™iÚ_cÚf_t
 *
cÚf
;

140 ià(
š
 =ð
NULL
 || 
r
->
h—d”_Úly
) {

141  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

144 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_add™iÚ_fž‹r_moduË
);

146 ià(
ùx
 =ð
NULL
) {

147  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

150 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_add™iÚ_fž‹r_moduË
);

152 ià(!
ùx
->
befÜe_body_£Á
) {

153 
ùx
->
befÜe_body_£Á
 = 1;

155 ià(
cÚf
->
befÜe_body
.
Ën
) {

156 ià(
	`ngx_h‰p_sub»que¡
(
r
, &
cÚf
->
befÜe_body
, 
NULL
, &
¤
, NULL, 0)

157 !ð
NGX_OK
)

159  
NGX_ERROR
;

164 ià(
cÚf
->
aá”_body
.
Ën
 == 0) {

165 
	`ngx_h‰p_£t_ùx
(
r
, 
NULL
, 
ngx_h‰p_add™iÚ_fž‹r_moduË
);

166  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

169 
Ï¡
 = 0;

171 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

172 ià(
þ
->
buf
->
Ï¡_buf
) {

173 
þ
->
buf
->
Ï¡_buf
 = 0;

174 
þ
->
buf
->
sync
 = 1;

175 
Ï¡
 = 1;

179 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

181 ià(
rc
 =ð
NGX_ERROR
 || !
Ï¡
 || 
cÚf
->
aá”_body
.
Ën
 == 0) {

182  
rc
;

185 ià(
	`ngx_h‰p_sub»que¡
(
r
, &
cÚf
->
aá”_body
, 
NULL
, &
¤
, NULL, 0)

186 !ð
NGX_OK
)

188  
NGX_ERROR
;

191 
	`ngx_h‰p_£t_ùx
(
r
, 
NULL
, 
ngx_h‰p_add™iÚ_fž‹r_moduË
);

193  
	`ngx_h‰p_£nd_¥ecŸl
(
r
, 
NGX_HTTP_LAST
);

194 
	}
}

197 
ngx_št_t


198 
	$ngx_h‰p_add™iÚ_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

200 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

201 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_add™iÚ_h—d”_fž‹r
;

203 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

204 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_add™iÚ_body_fž‹r
;

206  
NGX_OK
;

207 
	}
}

211 
	$ngx_h‰p_add™iÚ_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

213 
ngx_h‰p_add™iÚ_cÚf_t
 *
cÚf
;

215 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_add™iÚ_cÚf_t
));

216 ià(
cÚf
 =ð
NULL
) {

217  
NULL
;

229  
cÚf
;

230 
	}
}

234 
	$ngx_h‰p_add™iÚ_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

236 
ngx_h‰p_add™iÚ_cÚf_t
 *
´ev
 = 
·»Á
;

237 
ngx_h‰p_add™iÚ_cÚf_t
 *
cÚf
 = 
chžd
;

239 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
befÜe_body
, 
´ev
->before_body, "");

240 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
aá”_body
, 
´ev
->after_body, "");

242 ià(
	`ngx_h‰p_m”ge_ty³s
(
cf
, &
cÚf
->
ty³s_keys
, &cÚf->
ty³s
,

243 &
´ev
->
ty³s_keys
, &´ev->
ty³s
,

244 
ngx_h‰p_html_deçuÉ_ty³s
)

245 !ð
NGX_OK
)

247  
NGX_CONF_ERROR
;

250  
NGX_CONF_OK
;

251 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_auth_basic_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngx_üy±.h
>

14 
	#NGX_HTTP_AUTH_BUF_SIZE
 2048

	)

18 
ngx_¡r_t
 
	m·sswd
;

19 } 
	tngx_h‰p_auth_basic_ùx_t
;

23 
ngx_h‰p_com¶ex_v®ue_t
 *
	m»®m
;

24 
ngx_h‰p_com¶ex_v®ue_t
 
	mu£r_fže
;

25 } 
	tngx_h‰p_auth_basic_loc_cÚf_t
;

28 
ngx_št_t
 
ngx_h‰p_auth_basic_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

29 
ngx_št_t
 
ngx_h‰p_auth_basic_üy±_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

30 
ngx_h‰p_auth_basic_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·sswd
,‚gx_¡r_ˆ*
»®m
);

31 
ngx_št_t
 
ngx_h‰p_auth_basic_£t_»®m
(
ngx_h‰p_»que¡_t
 *
r
,

32 
ngx_¡r_t
 *
»®m
);

33 
ngx_h‰p_auth_basic_þo£
(
ngx_fže_t
 *
fže
);

34 *
ngx_h‰p_auth_basic_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

35 *
ngx_h‰p_auth_basic_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

36 *
·»Á
, *
chžd
);

37 
ngx_št_t
 
ngx_h‰p_auth_basic_š™
(
ngx_cÚf_t
 *
cf
);

38 *
ngx_h‰p_auth_basic_u£r_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

39 *
cÚf
);

42 
ngx_commªd_t
 
	gngx_h‰p_auth_basic_commªds
[] = {

44 { 
ngx_¡ršg
("auth_basic"),

45 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LMT_CONF


46 |
NGX_CONF_TAKE1
,

47 
ngx_h‰p_£t_com¶ex_v®ue_¦Ù
,

48 
NGX_HTTP_LOC_CONF_OFFSET
,

49 
off£tof
(
ngx_h‰p_auth_basic_loc_cÚf_t
, 
»®m
),

50 
NULL
 },

52 { 
ngx_¡ršg
("auth_basic_user_file"),

53 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LMT_CONF


54 |
NGX_CONF_TAKE1
,

55 
ngx_h‰p_auth_basic_u£r_fže
,

56 
NGX_HTTP_LOC_CONF_OFFSET
,

57 
off£tof
(
ngx_h‰p_auth_basic_loc_cÚf_t
, 
u£r_fže
),

58 
NULL
 },

60 
ngx_nuÎ_commªd


64 
ngx_h‰p_moduË_t
 
	gngx_h‰p_auth_basic_moduË_ùx
 = {

65 
NULL
,

66 
ngx_h‰p_auth_basic_š™
,

68 
NULL
,

69 
NULL
,

71 
NULL
,

72 
NULL
,

74 
ngx_h‰p_auth_basic_ü—‹_loc_cÚf
,

75 
ngx_h‰p_auth_basic_m”ge_loc_cÚf


79 
ngx_moduË_t
 
	gngx_h‰p_auth_basic_moduË
 = {

80 
NGX_MODULE_V1
,

81 &
ngx_h‰p_auth_basic_moduË_ùx
,

82 
ngx_h‰p_auth_basic_commªds
,

83 
NGX_HTTP_MODULE
,

84 
NULL
,

85 
NULL
,

86 
NULL
,

87 
NULL
,

88 
NULL
,

89 
NULL
,

90 
NULL
,

91 
NGX_MODULE_V1_PADDING


95 
ngx_št_t


96 
	$ngx_h‰p_auth_basic_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

98 
off_t
 
off£t
;

99 
ssize_t
 
n
;

100 
ngx_fd_t
 
fd
;

101 
ngx_št_t
 
rc
;

102 
ngx_”r_t
 
”r
;

103 
ngx_¡r_t
 
pwd
, 
»®m
, 
u£r_fže
;

104 
ngx_ušt_t
 
i
, 
Ëv–
, 
logš
, 
Ëá
, 
·sswd
;

105 
ngx_fže_t
 
fže
;

106 
ngx_h‰p_auth_basic_ùx_t
 *
ùx
;

107 
ngx_h‰p_auth_basic_loc_cÚf_t
 *
®cf
;

108 
u_ch¬
 
buf
[
NGX_HTTP_AUTH_BUF_SIZE
];

110 
sw_logš
,

111 
sw_·sswd
,

112 
sw_sk


113 } 
¡©e
;

115 
®cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_auth_basic_moduË
);

117 ià(
®cf
->
»®m
 =ð
NULL
 ||‡lcf->
u£r_fže
.
v®ue
.
d©a
 == NULL) {

118  
NGX_DECLINED
;

121 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
®cf
->
»®m
, &»®mè!ð
NGX_OK
) {

122  
NGX_ERROR
;

125 ià(
»®m
.
Ën
 =ð3 && 
	`ngx_¡ºcmp
Ô—lm.
d©a
, "off", 3) == 0) {

126  
NGX_DECLINED
;

129 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_auth_basic_moduË
);

131 ià(
ùx
) {

132  
	`ngx_h‰p_auth_basic_üy±_hªdËr
(
r
, 
ùx
, &ùx->
·sswd
,

133 &
»®m
);

136 
rc
 = 
	`ngx_h‰p_auth_basic_u£r
(
r
);

138 ià(
rc
 =ð
NGX_DECLINED
) {

140 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

143  
	`ngx_h‰p_auth_basic_£t_»®m
(
r
, &
»®m
);

146 ià(
rc
 =ð
NGX_ERROR
) {

147  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

150 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
®cf
->
u£r_fže
, &u£r_fžeè!ð
NGX_OK
) {

151  
NGX_ERROR
;

154 
fd
 = 
	`ngx_Ý’_fže
(
u£r_fže
.
d©a
, 
NGX_FILE_RDONLY
, 
NGX_FILE_OPEN
, 0);

156 ià(
fd
 =ð
NGX_INVALID_FILE
) {

157 
”r
 = 
ngx_”ºo
;

159 ià(
”r
 =ð
NGX_ENOENT
) {

160 
Ëv–
 = 
NGX_LOG_ERR
;

161 
rc
 = 
NGX_HTTP_FORBIDDEN
;

164 
Ëv–
 = 
NGX_LOG_CRIT
;

165 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

168 
	`ngx_log_”rÜ
(
Ëv–
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

169 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
u£r_fže
.
d©a
);

171  
rc
;

174 
	`ngx_memz”o
(&
fže
, (
ngx_fže_t
));

176 
fže
.
fd
 = fd;

177 
fže
.
Çme
 = 
u£r_fže
;

178 
fže
.
log
 = 
r
->
cÚÃùiÚ
->log;

180 
¡©e
 = 
sw_logš
;

181 
·sswd
 = 0;

182 
logš
 = 0;

183 
Ëá
 = 0;

184 
off£t
 = 0;

187 
i
 = 
Ëá
;

189 
n
 = 
	`ngx_»ad_fže
(&
fže
, 
buf
 + 
Ëá
, 
NGX_HTTP_AUTH_BUF_SIZE
 -†eft,

190 
off£t
);

192 ià(
n
 =ð
NGX_ERROR
) {

193 
	`ngx_h‰p_auth_basic_þo£
(&
fže
);

194  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

197 ià(
n
 == 0) {

201 
i
 = 
Ëá
; i <†eá + 
n
; i++) {

202 
¡©e
) {

204 
sw_logš
:

205 ià(
logš
 == 0) {

207 ià(
buf
[
i
] =ð'#' || buf[i] =ð
CR
) {

208 
¡©e
 = 
sw_sk
;

212 ià(
buf
[
i
] =ð
LF
) {

217 ià(
buf
[
i
] !ð
r
->
h—d”s_š
.
u£r
.
d©a
[
logš
]) {

218 
¡©e
 = 
sw_sk
;

222 ià(
logš
 =ð
r
->
h—d”s_š
.
u£r
.
Ën
) {

223 
¡©e
 = 
sw_·sswd
;

224 
·sswd
 = 
i
 + 1;

227 
logš
++;

231 
sw_·sswd
:

232 ià(
buf
[
i
] =ð
LF
 || buf[i] =ð
CR
 || buf[i] == ':') {

233 
buf
[
i
] = '\0';

235 
	`ngx_h‰p_auth_basic_þo£
(&
fže
);

237 
pwd
.
Ën
 = 
i
 - 
·sswd
;

238 
pwd
.
d©a
 = &
buf
[
·sswd
];

240  
	`ngx_h‰p_auth_basic_üy±_hªdËr
(
r
, 
NULL
, &
pwd
,

241 &
»®m
);

246 
sw_sk
:

247 ià(
buf
[
i
] =ð
LF
) {

248 
¡©e
 = 
sw_logš
;

249 
logš
 = 0;

256 ià(
¡©e
 =ð
sw_·sswd
) {

257 
Ëá
 =†eá + 
n
 - 
·sswd
;

258 
	`ngx_memmove
(
buf
, &buf[
·sswd
], 
Ëá
);

259 
·sswd
 = 0;

262 
Ëá
 = 0;

265 
off£t
 +ð
n
;

268 
	`ngx_h‰p_auth_basic_þo£
(&
fže
);

270 ià(
¡©e
 =ð
sw_·sswd
) {

271 
pwd
.
Ën
 = 
i
 - 
·sswd
;

272 
pwd
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,…wd.
Ën
 + 1);

273 ià(
pwd
.
d©a
 =ð
NULL
) {

274  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

277 
	`ngx_ýy¡º
(
pwd
.
d©a
, &
buf
[
·sswd
],…wd.
Ën
 + 1);

279  
	`ngx_h‰p_auth_basic_üy±_hªdËr
(
r
, 
NULL
, &
pwd
, &
»®m
);

282 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

284 &
r
->
h—d”s_š
.
u£r
, &
u£r_fže
);

286  
	`ngx_h‰p_auth_basic_£t_»®m
(
r
, &
»®m
);

287 
	}
}

290 
ngx_št_t


291 
	$ngx_h‰p_auth_basic_üy±_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

292 
ngx_h‰p_auth_basic_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·sswd
,‚gx_¡r_ˆ*
»®m
)

294 
ngx_št_t
 
rc
;

295 
u_ch¬
 *
’üy±ed
;

297 
rc
 = 
	`ngx_üy±
(
r
->
poÞ
,„->
h—d”s_š
.
·sswd
.
d©a
,…asswd->data,

298 &
’üy±ed
);

300 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

302 
rc
, &
r
->
h—d”s_š
.
u£r
, 
·sswd
->
d©a
);

304 ià(
rc
 =ð
NGX_OK
) {

305 ià(
	`ngx_¡rcmp
(
’üy±ed
, 
·sswd
->
d©a
) == 0) {

306  
NGX_OK
;

309 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

310 "’üy±ed: \"%s\"", 
’üy±ed
);

312 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

314 &
r
->
h—d”s_š
.
u£r
);

316  
	`ngx_h‰p_auth_basic_£t_»®m
(
r
, 
»®m
);

319 ià(
rc
 =ð
NGX_ERROR
) {

320  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

325 ià(
ùx
 =ð
NULL
) {

326 
ùx
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_auth_basic_ùx_t
));

327 ià(
ùx
 =ð
NULL
) {

328  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

331 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_auth_basic_moduË
);

333 
ùx
->
·sswd
.
Ën
 =…asswd->len;

334 
·sswd
->
Ën
++;

336 
ùx
->
·sswd
.
d©a
 = 
	`ngx_p¡rdup
(
r
->
poÞ
,…asswd);

337 ià(
ùx
->
·sswd
.
d©a
 =ð
NULL
) {

338  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

345  
rc
;

346 
	}
}

349 
ngx_št_t


350 
	$ngx_h‰p_auth_basic_£t_»®m
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
»®m
)

352 
size_t
 
Ën
;

353 
u_ch¬
 *
basic
, *
p
;

355 
r
->
h—d”s_out
.
www_auth’tiÿ‹
 = 
	`ngx_li¡_push
(&r->h—d”s_out.
h—d”s
);

356 ià(
r
->
h—d”s_out
.
www_auth’tiÿ‹
 =ð
NULL
) {

357  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

360 
Ën
 = ("Basiø»®m=\"\""è- 1 + 
»®m
->len;

362 
basic
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

363 ià(
basic
 =ð
NULL
) {

364  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

367 
p
 = 
	`ngx_ýymem
(
basic
, "Basic„ealm=\"", ("Basic„ealm=\"") - 1);

368 
p
 = 
	`ngx_ýymem
Õ, 
»®m
->
d©a
,„—lm->
Ën
);

369 *
p
 = '"';

371 
r
->
h—d”s_out
.
www_auth’tiÿ‹
->
hash
 = 1;

372 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
www_auth’tiÿ‹
->
key
, "WWW-Authenticate");

373 
r
->
h—d”s_out
.
www_auth’tiÿ‹
->
v®ue
.
d©a
 = 
basic
;

374 
r
->
h—d”s_out
.
www_auth’tiÿ‹
->
v®ue
.
Ën
 =†en;

376  
NGX_HTTP_UNAUTHORIZED
;

377 
	}
}

380 
	$ngx_h‰p_auth_basic_þo£
(
ngx_fže_t
 *
fže
)

382 ià(
	`ngx_þo£_fže
(
fže
->
fd
è=ð
NGX_FILE_ERROR
) {

383 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
fže
->
log
, 
ngx_”ºo
,

384 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fže
->
Çme
.
d©a
);

386 
	}
}

390 
	$ngx_h‰p_auth_basic_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

392 
ngx_h‰p_auth_basic_loc_cÚf_t
 *
cÚf
;

394 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_auth_basic_loc_cÚf_t
));

395 ià(
cÚf
 =ð
NULL
) {

396  
NULL
;

399  
cÚf
;

400 
	}
}

404 
	$ngx_h‰p_auth_basic_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

406 
ngx_h‰p_auth_basic_loc_cÚf_t
 *
´ev
 = 
·»Á
;

407 
ngx_h‰p_auth_basic_loc_cÚf_t
 *
cÚf
 = 
chžd
;

409 ià(
cÚf
->
»®m
 =ð
NULL
) {

410 
cÚf
->
»®m
 = 
´ev
->realm;

413 ià(
cÚf
->
u£r_fže
.
v®ue
.
d©a
 =ð
NULL
) {

414 
cÚf
->
u£r_fže
 = 
´ev
->user_file;

417  
NGX_CONF_OK
;

418 
	}
}

421 
ngx_št_t


422 
	$ngx_h‰p_auth_basic_š™
(
ngx_cÚf_t
 *
cf
)

424 
ngx_h‰p_hªdËr_±
 *
h
;

425 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

427 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

429 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_ACCESS_PHASE
].
hªdËrs
);

430 ià(
h
 =ð
NULL
) {

431  
NGX_ERROR
;

434 *
h
 = 
ngx_h‰p_auth_basic_hªdËr
;

436  
NGX_OK
;

437 
	}
}

441 
	$ngx_h‰p_auth_basic_u£r_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

443 
ngx_h‰p_auth_basic_loc_cÚf_t
 *
®cf
 = 
cÚf
;

445 
ngx_¡r_t
 *
v®ue
;

446 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

448 ià(
®cf
->
u£r_fže
.
v®ue
.
d©a
) {

452 
v®ue
 = 
cf
->
¬gs
->
–ts
;

454 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

456 
ccv
.
cf
 = cf;

457 
ccv
.
v®ue
 = &value[1];

458 
ccv
.
com¶ex_v®ue
 = &
®cf
->
u£r_fže
;

459 
ccv
.
z”o
 = 1;

460 
ccv
.
cÚf_´efix
 = 1;

462 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

463  
NGX_CONF_ERROR
;

466  
NGX_CONF_OK
;

467 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_auth_request_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_¡r_t
 
	muri
;

15 
ngx_¬¿y_t
 *
	mv¬s
;

16 } 
	tngx_h‰p_auth_»que¡_cÚf_t
;

20 
ngx_ušt_t
 
	mdÚe
;

21 
ngx_ušt_t
 
	m¡©us
;

22 
ngx_h‰p_»que¡_t
 *
	msub»que¡
;

23 } 
	tngx_h‰p_auth_»que¡_ùx_t
;

27 
ngx_št_t
 
	mšdex
;

28 
ngx_h‰p_com¶ex_v®ue_t
 
	mv®ue
;

29 
ngx_h‰p_£t_v¬ŸbË_±
 
	m£t_hªdËr
;

30 } 
	tngx_h‰p_auth_»que¡_v¬ŸbË_t
;

33 
ngx_št_t
 
ngx_h‰p_auth_»que¡_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

34 
ngx_št_t
 
ngx_h‰p_auth_»que¡_dÚe
(
ngx_h‰p_»que¡_t
 *
r
,

35 *
d©a
, 
ngx_št_t
 
rc
);

36 
ngx_št_t
 
ngx_h‰p_auth_»que¡_£t_v¬ŸbËs
(
ngx_h‰p_»que¡_t
 *
r
,

37 
ngx_h‰p_auth_»que¡_cÚf_t
 *
¬cf
, 
ngx_h‰p_auth_»que¡_ùx_t
 *
ùx
);

38 
ngx_št_t
 
ngx_h‰p_auth_»que¡_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

39 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

40 *
ngx_h‰p_auth_»que¡_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

41 *
ngx_h‰p_auth_»que¡_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
,

42 *
·»Á
, *
chžd
);

43 
ngx_št_t
 
ngx_h‰p_auth_»que¡_š™
(
ngx_cÚf_t
 *
cf
);

44 *
ngx_h‰p_auth_»que¡
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

45 *
cÚf
);

46 *
ngx_h‰p_auth_»que¡_£t
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

47 *
cÚf
);

50 
ngx_commªd_t
 
	gngx_h‰p_auth_»que¡_commªds
[] = {

52 { 
ngx_¡ršg
("auth_request"),

53 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

54 
ngx_h‰p_auth_»que¡
,

55 
NGX_HTTP_LOC_CONF_OFFSET
,

57 
NULL
 },

59 { 
ngx_¡ršg
("auth_request_set"),

60 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

61 
ngx_h‰p_auth_»que¡_£t
,

62 
NGX_HTTP_LOC_CONF_OFFSET
,

64 
NULL
 },

66 
ngx_nuÎ_commªd


70 
ngx_h‰p_moduË_t
 
	gngx_h‰p_auth_»que¡_moduË_ùx
 = {

71 
NULL
,

72 
ngx_h‰p_auth_»que¡_š™
,

74 
NULL
,

75 
NULL
,

77 
NULL
,

78 
NULL
,

80 
ngx_h‰p_auth_»que¡_ü—‹_cÚf
,

81 
ngx_h‰p_auth_»que¡_m”ge_cÚf


85 
ngx_moduË_t
 
	gngx_h‰p_auth_»que¡_moduË
 = {

86 
NGX_MODULE_V1
,

87 &
ngx_h‰p_auth_»que¡_moduË_ùx
,

88 
ngx_h‰p_auth_»que¡_commªds
,

89 
NGX_HTTP_MODULE
,

90 
NULL
,

91 
NULL
,

92 
NULL
,

93 
NULL
,

94 
NULL
,

95 
NULL
,

96 
NULL
,

97 
NGX_MODULE_V1_PADDING


101 
ngx_št_t


102 
	$ngx_h‰p_auth_»que¡_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

104 
ngx_bË_–t_t
 *
h
, *
ho
;

105 
ngx_h‰p_»que¡_t
 *
¤
;

106 
ngx_h‰p_po¡_sub»que¡_t
 *
ps
;

107 
ngx_h‰p_auth_»que¡_ùx_t
 *
ùx
;

108 
ngx_h‰p_auth_»que¡_cÚf_t
 *
¬cf
;

110 
¬cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_auth_»que¡_moduË
);

112 ià(
¬cf
->
uri
.
Ën
 == 0) {

113  
NGX_DECLINED
;

116 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

119 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_auth_»que¡_moduË
);

121 ià(
ùx
 !ð
NULL
) {

122 ià(!
ùx
->
dÚe
) {

123  
NGX_AGAIN
;

131 ià(
	`ngx_h‰p_auth_»que¡_£t_v¬ŸbËs
(
r
, 
¬cf
, 
ùx
è!ð
NGX_OK
) {

132  
NGX_ERROR
;

137 ià(
ùx
->
¡©us
 =ð
NGX_HTTP_FORBIDDEN
) {

138  
ùx
->
¡©us
;

141 ià(
ùx
->
¡©us
 =ð
NGX_HTTP_UNAUTHORIZED
) {

142 
¤
 = 
ùx
->
sub»que¡
;

144 
h
 = 
¤
->
h—d”s_out
.
www_auth’tiÿ‹
;

146 ià(!
h
 && 
¤
->
up¡»am
) {

147 
h
 = 
¤
->
up¡»am
->
h—d”s_š
.
www_auth’tiÿ‹
;

150 ià(
h
) {

151 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

152 ià(
ho
 =ð
NULL
) {

153  
NGX_ERROR
;

156 *
ho
 = *
h
;

158 
r
->
h—d”s_out
.
www_auth’tiÿ‹
 = 
ho
;

161  
ùx
->
¡©us
;

164 ià(
ùx
->
¡©us
 >ð
NGX_HTTP_OK


165 && 
ùx
->
¡©us
 < 
NGX_HTTP_SPECIAL_RESPONSE
)

167  
NGX_OK
;

170 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

171 "auth„eque¡ uÃx³ùed stus: %d", 
ùx
->
¡©us
);

173  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

176 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_auth_»que¡_ùx_t
));

177 ià(
ùx
 =ð
NULL
) {

178  
NGX_ERROR
;

181 
ps
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_po¡_sub»que¡_t
));

182 ià(
ps
 =ð
NULL
) {

183  
NGX_ERROR
;

186 
ps
->
hªdËr
 = 
ngx_h‰p_auth_»que¡_dÚe
;

187 
ps
->
d©a
 = 
ùx
;

189 ià(
	`ngx_h‰p_sub»que¡
(
r
, &
¬cf
->
uri
, 
NULL
, &
¤
, 
ps
,

190 
NGX_HTTP_SUBREQUEST_WAITED
)

191 !ð
NGX_OK
)

193  
NGX_ERROR
;

201 
¤
->
»que¡_body
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_»que¡_body_t
));

202 ià(
¤
->
»que¡_body
 =ð
NULL
) {

203  
NGX_ERROR
;

206 
¤
->
h—d”_Úly
 = 1;

208 
ùx
->
sub»que¡
 = 
¤
;

210 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_auth_»que¡_moduË
);

212  
NGX_AGAIN
;

213 
	}
}

216 
ngx_št_t


217 
	$ngx_h‰p_auth_»que¡_dÚe
(
ngx_h‰p_»que¡_t
 *
r
, *
d©a
, 
ngx_št_t
 
rc
)

219 
ngx_h‰p_auth_»que¡_ùx_t
 *
ùx
 = 
d©a
;

221 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

222 "auth„eque¡ dÚs:%d", 
r
->
h—d”s_out
.
¡©us
);

224 
ùx
->
dÚe
 = 1;

225 
ùx
->
¡©us
 = 
r
->
h—d”s_out
.status;

227  
rc
;

228 
	}
}

231 
ngx_št_t


232 
	$ngx_h‰p_auth_»que¡_£t_v¬ŸbËs
(
ngx_h‰p_»que¡_t
 *
r
,

233 
ngx_h‰p_auth_»que¡_cÚf_t
 *
¬cf
, 
ngx_h‰p_auth_»que¡_ùx_t
 *
ùx
)

235 
ngx_¡r_t
 
v®
;

236 
ngx_h‰p_v¬ŸbË_t
 *
v
;

237 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

238 
ngx_h‰p_auth_»que¡_v¬ŸbË_t
 *
av
, *
Ï¡
;

239 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

241 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

244 ià(
¬cf
->
v¬s
 =ð
NULL
) {

245  
NGX_OK
;

248 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

249 
v
 = 
cmcf
->
v¬ŸbËs
.
–ts
;

251 
av
 = 
¬cf
->
v¬s
->
–ts
;

252 
Ï¡
 = 
av
 + 
¬cf
->
v¬s
->
ÃÉs
;

254 
av
 < 
Ï¡
) {

260 
vv
 = &
r
->
v¬ŸbËs
[
av
->
šdex
];

262 ià(
	`ngx_h‰p_com¶ex_v®ue
(
ùx
->
sub»que¡
, &
av
->
v®ue
, &
v®
)

263 !ð
NGX_OK
)

265  
NGX_ERROR
;

268 
vv
->
v®id
 = 1;

269 
vv
->
nÙ_found
 = 0;

270 
vv
->
d©a
 = 
v®
.data;

271 
vv
->
Ën
 = 
v®
.len;

273 ià(
av
->
£t_hªdËr
) {

279 
av
->
	`£t_hªdËr
(
r
, 
vv
, 
v
[av->
šdex
].
d©a
);

282 
av
++;

285  
NGX_OK
;

286 
	}
}

289 
ngx_št_t


290 
	$ngx_h‰p_auth_»que¡_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

291 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

293 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

296 
v
->
nÙ_found
 = 1;

298  
NGX_OK
;

299 
	}
}

303 
	$ngx_h‰p_auth_»que¡_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

305 
ngx_h‰p_auth_»que¡_cÚf_t
 *
cÚf
;

307 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_auth_»que¡_cÚf_t
));

308 ià(
cÚf
 =ð
NULL
) {

309  
NULL
;

318 
cÚf
->
v¬s
 = 
NGX_CONF_UNSET_PTR
;

320  
cÚf
;

321 
	}
}

325 
	$ngx_h‰p_auth_»que¡_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

327 
ngx_h‰p_auth_»que¡_cÚf_t
 *
´ev
 = 
·»Á
;

328 
ngx_h‰p_auth_»que¡_cÚf_t
 *
cÚf
 = 
chžd
;

330 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
uri
, 
´ev
->uri, "");

331 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
v¬s
, 
´ev
->v¬s, 
NULL
);

333  
NGX_CONF_OK
;

334 
	}
}

337 
ngx_št_t


338 
	$ngx_h‰p_auth_»que¡_š™
(
ngx_cÚf_t
 *
cf
)

340 
ngx_h‰p_hªdËr_±
 *
h
;

341 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

343 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

345 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_ACCESS_PHASE
].
hªdËrs
);

346 ià(
h
 =ð
NULL
) {

347  
NGX_ERROR
;

350 *
h
 = 
ngx_h‰p_auth_»que¡_hªdËr
;

352  
NGX_OK
;

353 
	}
}

357 
	$ngx_h‰p_auth_»que¡
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

359 
ngx_h‰p_auth_»que¡_cÚf_t
 *
¬cf
 = 
cÚf
;

361 
ngx_¡r_t
 *
v®ue
;

363 ià(
¬cf
->
uri
.
d©a
 !ð
NULL
) {

367 
v®ue
 = 
cf
->
¬gs
->
–ts
;

369 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

370 
¬cf
->
uri
.
Ën
 = 0;

371 
¬cf
->
uri
.
d©a
 = (
u_ch¬
 *) "";

373  
NGX_CONF_OK
;

376 
¬cf
->
uri
 = 
v®ue
[1];

378  
NGX_CONF_OK
;

379 
	}
}

383 
	$ngx_h‰p_auth_»que¡_£t
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

385 
ngx_h‰p_auth_»que¡_cÚf_t
 *
¬cf
 = 
cÚf
;

387 
ngx_¡r_t
 *
v®ue
;

388 
ngx_h‰p_v¬ŸbË_t
 *
v
;

389 
ngx_h‰p_auth_»que¡_v¬ŸbË_t
 *
av
;

390 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

392 
v®ue
 = 
cf
->
¬gs
->
–ts
;

394 ià(
v®ue
[1].
d©a
[0] != '$') {

395 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

396 "šv®id v¬ŸbË‚am\"%V\"", &
v®ue
[1]);

397  
NGX_CONF_ERROR
;

400 
v®ue
[1].
Ën
--;

401 
v®ue
[1].
d©a
++;

403 ià(
¬cf
->
v¬s
 =ð
NGX_CONF_UNSET_PTR
) {

404 
¬cf
->
v¬s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1,

405 (
ngx_h‰p_auth_»que¡_v¬ŸbË_t
));

406 ià(
¬cf
->
v¬s
 =ð
NULL
) {

407  
NGX_CONF_ERROR
;

411 
av
 = 
	`ngx_¬¿y_push
(
¬cf
->
v¬s
);

412 ià(
av
 =ð
NULL
) {

413  
NGX_CONF_ERROR
;

416 
v
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v®ue
[1], 
NGX_HTTP_VAR_CHANGEABLE
);

417 ià(
v
 =ð
NULL
) {

418  
NGX_CONF_ERROR
;

421 
av
->
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, &
v®ue
[1]);

422 ià(
av
->
šdex
 =ð
NGX_ERROR
) {

423  
NGX_CONF_ERROR
;

426 ià(
v
->
g‘_hªdËr
 =ð
NULL
) {

427 
v
->
g‘_hªdËr
 = 
ngx_h‰p_auth_»que¡_v¬ŸbË
;

428 
v
->
d©a
 = (
ušŒ_t
è
av
;

431 
av
->
£t_hªdËr
 = 
v
->set_handler;

433 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

435 
ccv
.
cf
 = cf;

436 
ccv
.
v®ue
 = &value[2];

437 
ccv
.
com¶ex_v®ue
 = &
av
->
v®ue
;

439 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

440  
NGX_CONF_ERROR
;

443  
NGX_CONF_OK
;

444 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_autoindex_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

16 
ngx_buf_t
 *
	mbuf
;

17 
size_t
 
	msize
;

18 
ngx_poÞ_t
 *
	mpoÞ
;

19 
size_t
 
	m®loc_size
;

20 
ngx_chaš_t
 **
	mÏ¡_out
;

21 } 
	tngx_h‰p_autošdex_ùx_t
;

27 
ngx_¡r_t
 
	mÇme
;

28 
size_t
 
	mutf_Ën
;

29 
size_t
 
	mesÿ³
;

30 
size_t
 
	mesÿ³_html
;

32 
	mdœ
:1;

34 
time_t
 
	mmtime
;

35 
off_t
 
	msize
;

36 } 
	tngx_h‰p_autošdex_’Œy_t
;

40 
ngx_æag_t
 
	m’abË
;

41 
ngx_æag_t
 
	mloÿÉime
;

42 
ngx_æag_t
 
	mexaù_size
;

43 } 
	tngx_h‰p_autošdex_loc_cÚf_t
;

46 
	#NGX_HTTP_AUTOINDEX_PREALLOCATE
 50

	)

48 
	#NGX_HTTP_AUTOINDEX_NAME_LEN
 50

	)

51 
ngx_libc_cdeþ
 
ngx_h‰p_autošdex_cmp_’Œ›s
(cÚ¡ *
Úe
,

52 cÚ¡ *
two
);

53 
ngx_št_t
 
ngx_h‰p_autošdex_”rÜ
(
ngx_h‰p_»que¡_t
 *
r
,

54 
ngx_dœ_t
 *
dœ
, 
ngx_¡r_t
 *
Çme
);

55 
ngx_št_t
 
ngx_h‰p_autošdex_š™
(
ngx_cÚf_t
 *
cf
);

56 *
ngx_h‰p_autošdex_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

57 *
ngx_h‰p_autošdex_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

58 *
·»Á
, *
chžd
);

61 
ngx_commªd_t
 
	gngx_h‰p_autošdex_commªds
[] = {

63 { 
ngx_¡ršg
("autoindex"),

64 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

65 
ngx_cÚf_£t_æag_¦Ù
,

66 
NGX_HTTP_LOC_CONF_OFFSET
,

67 
off£tof
(
ngx_h‰p_autošdex_loc_cÚf_t
, 
’abË
),

68 
NULL
 },

70 { 
ngx_¡ršg
("autoindex_localtime"),

71 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

72 
ngx_cÚf_£t_æag_¦Ù
,

73 
NGX_HTTP_LOC_CONF_OFFSET
,

74 
off£tof
(
ngx_h‰p_autošdex_loc_cÚf_t
, 
loÿÉime
),

75 
NULL
 },

77 { 
ngx_¡ršg
("autoindex_exact_size"),

78 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

79 
ngx_cÚf_£t_æag_¦Ù
,

80 
NGX_HTTP_LOC_CONF_OFFSET
,

81 
off£tof
(
ngx_h‰p_autošdex_loc_cÚf_t
, 
exaù_size
),

82 
NULL
 },

84 
ngx_nuÎ_commªd


88 
ngx_h‰p_moduË_t
 
	gngx_h‰p_autošdex_moduË_ùx
 = {

89 
NULL
,

90 
ngx_h‰p_autošdex_š™
,

92 
NULL
,

93 
NULL
,

95 
NULL
,

96 
NULL
,

98 
ngx_h‰p_autošdex_ü—‹_loc_cÚf
,

99 
ngx_h‰p_autošdex_m”ge_loc_cÚf


103 
ngx_moduË_t
 
	gngx_h‰p_autošdex_moduË
 = {

104 
NGX_MODULE_V1
,

105 &
ngx_h‰p_autošdex_moduË_ùx
,

106 
ngx_h‰p_autošdex_commªds
,

107 
NGX_HTTP_MODULE
,

108 
NULL
,

109 
NULL
,

110 
NULL
,

111 
NULL
,

112 
NULL
,

113 
NULL
,

114 
NULL
,

115 
NGX_MODULE_V1_PADDING


119 
u_ch¬
 
	gt™Ë
[] =

120 "<html>" 
CRLF


125 
u_ch¬
 
	gh—d”
[] =

126 "</t™Ë></h—d>" 
CRLF


127 "<body bgcÞÜ=\"wh™e\">" 
CRLF


131 
u_ch¬
 
	gž
[] =

132 "</body>" 
CRLF


133 "</html>" 
CRLF


137 
ngx_št_t


138 
	$ngx_h‰p_autošdex_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

140 
u_ch¬
 *
Ï¡
, *
fž’ame
, 
sÿË
;

141 
off_t
 
Ëngth
;

142 
size_t
 
Ën
, 
ch¬_Ën
, 
esÿ³_html
, 
®loÿ‹d
, 
roÙ
;

143 
ngx_tm_t
 
tm
;

144 
ngx_”r_t
 
”r
;

145 
ngx_buf_t
 *
b
;

146 
ngx_št_t
 
rc
, 
size
;

147 
ngx_¡r_t
 
·th
;

148 
ngx_dœ_t
 
dœ
;

149 
ngx_ušt_t
 
i
, 
Ëv–
, 
utf8
;

150 
ngx_poÞ_t
 *
poÞ
;

151 
ngx_time_t
 *

;

152 
ngx_chaš_t
 
out
;

153 
ngx_¬¿y_t
 
’Œ›s
;

154 
ngx_h‰p_autošdex_’Œy_t
 *
’Œy
;

155 
ngx_h‰p_autošdex_loc_cÚf_t
 *
®cf
;

157 *
mÚths
[] = { "Jan", "Feb", "Mar", "Apr", "May", "Jun",

160 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] != '/') {

161  
NGX_DECLINED
;

164 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
))) {

165  
NGX_DECLINED
;

168 
®cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_autošdex_moduË
);

170 ià(!
®cf
->
’abË
) {

171  
NGX_DECLINED
;

176 
Ï¡
 = 
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
,

177 
NGX_HTTP_AUTOINDEX_PREALLOCATE
);

178 ià(
Ï¡
 =ð
NULL
) {

179  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

182 
®loÿ‹d
 = 
·th
.
Ën
;

183 
·th
.
Ën
 = 
Ï¡
 -…©h.
d©a
;

184 ià(
·th
.
Ën
 > 1) {

185 
·th
.
Ën
--;

187 
·th
.
d©a
[·th.
Ën
] = '\0';

189 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

190 "h‰°autošdex: \"%s\"", 
·th
.
d©a
);

192 ià(
	`ngx_Ý’_dœ
(&
·th
, &
dœ
è=ð
NGX_ERROR
) {

193 
”r
 = 
ngx_”ºo
;

195 ià(
”r
 =ð
NGX_ENOENT


196 || 
”r
 =ð
NGX_ENOTDIR


197 || 
”r
 =ð
NGX_ENAMETOOLONG
)

199 
Ëv–
 = 
NGX_LOG_ERR
;

200 
rc
 = 
NGX_HTTP_NOT_FOUND
;

202 } ià(
”r
 =ð
NGX_EACCES
) {

203 
Ëv–
 = 
NGX_LOG_ERR
;

204 
rc
 = 
NGX_HTTP_FORBIDDEN
;

207 
Ëv–
 = 
NGX_LOG_CRIT
;

208 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

211 
	`ngx_log_”rÜ
(
Ëv–
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

212 
ngx_Ý’_dœ_n
 " \"%s\" fažed", 
·th
.
d©a
);

214  
rc
;

217 #ià(
NGX_SUPPRESS_WARN
)

220 
	`ngx_memz”o
(&
’Œ›s
, (
ngx_¬¿y_t
));

225 
poÞ
 = 
r
->pool;

227 ià(
	`ngx_¬¿y_š™
(&
’Œ›s
, 
poÞ
, 40, (
ngx_h‰p_autošdex_’Œy_t
))

228 !ð
NGX_OK
)

230  
	`ngx_h‰p_autošdex_”rÜ
(
r
, &
dœ
, &
·th
);

233 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_OK
;

234 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = ("text/html") - 1;

235 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
cÚ‹Á_ty³
, "text/html");

236 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

238 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

240 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

241 ià(
	`ngx_þo£_dœ
(&
dœ
è=ð
NGX_ERROR
) {

242 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

243 
ngx_þo£_dœ_n
 " \"%V\" fažed", &
·th
);

246  
rc
;

249 
fž’ame
 = 
·th
.
d©a
;

250 
fž’ame
[
·th
.
Ën
] = '/';

252 ià(
r
->
h—d”s_out
.
ch¬£t
.
Ën
 == 5

253 && 
	`ngx_¡ºÿ£cmp
(
r
->
h—d”s_out
.
ch¬£t
.
d©a
, (
u_ch¬
 *) "utf-8", 5)

256 
utf8
 = 1;

259 
utf8
 = 0;

263 
	`ngx_£t_”ºo
(0);

265 ià(
	`ngx_»ad_dœ
(&
dœ
è=ð
NGX_ERROR
) {

266 
”r
 = 
ngx_”ºo
;

268 ià(
”r
 !ð
NGX_ENOMOREFILES
) {

269 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

270 
ngx_»ad_dœ_n
 " \"%V\" fažed", &
·th
);

271  
	`ngx_h‰p_autošdex_”rÜ
(
r
, &
dœ
, &
·th
);

277 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

278 "h‰°autošdex fže: \"%s\"", 
	`ngx_de_Çme
(&
dœ
));

280 
Ën
 = 
	`ngx_de_Çm–’
(&
dœ
);

282 ià(
	`ngx_de_Çme
(&
dœ
)[0] == '.') {

286 ià(!
dœ
.
v®id_šfo
) {

290 ià(
·th
.
Ën
 + 1 +†’ + 1 > 
®loÿ‹d
) {

291 
®loÿ‹d
 = 
·th
.
Ën
 + 1 +†en + 1

292 + 
NGX_HTTP_AUTOINDEX_PREALLOCATE
;

294 
fž’ame
 = 
	`ngx_²®loc
(
poÞ
, 
®loÿ‹d
);

295 ià(
fž’ame
 =ð
NULL
) {

296  
	`ngx_h‰p_autošdex_”rÜ
(
r
, &
dœ
, &
·th
);

299 
Ï¡
 = 
	`ngx_ýy¡º
(
fž’ame
, 
·th
.
d©a
,…©h.
Ën
 + 1);

300 *
Ï¡
++ = '/';

303 
	`ngx_ýy¡º
(
Ï¡
, 
	`ngx_de_Çme
(&
dœ
), 
Ën
 + 1);

305 ià(
	`ngx_de_šfo
(
fž’ame
, &
dœ
è=ð
NGX_FILE_ERROR
) {

306 
”r
 = 
ngx_”ºo
;

308 ià(
”r
 !ð
NGX_ENOENT
 &&ƒ¼ !ð
NGX_ELOOP
) {

309 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

310 
ngx_de_šfo_n
 " \"%s\" fažed", 
fž’ame
);

312 ià(
”r
 =ð
NGX_EACCES
) {

316  
	`ngx_h‰p_autošdex_”rÜ
(
r
, &
dœ
, &
·th
);

319 ià(
	`ngx_de_lšk_šfo
(
fž’ame
, &
dœ
è=ð
NGX_FILE_ERROR
) {

320 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

321 
ngx_de_lšk_šfo_n
 " \"%s\" failed",

322 
fž’ame
);

323  
	`ngx_h‰p_autošdex_”rÜ
(
r
, &
dœ
, &
·th
);

328 
’Œy
 = 
	`ngx_¬¿y_push
(&
’Œ›s
);

329 ià(
’Œy
 =ð
NULL
) {

330  
	`ngx_h‰p_autošdex_”rÜ
(
r
, &
dœ
, &
·th
);

333 
’Œy
->
Çme
.
Ën
 =†en;

335 
’Œy
->
Çme
.
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
 + 1);

336 ià(
’Œy
->
Çme
.
d©a
 =ð
NULL
) {

337  
	`ngx_h‰p_autošdex_”rÜ
(
r
, &
dœ
, &
·th
);

340 
	`ngx_ýy¡º
(
’Œy
->
Çme
.
d©a
, 
	`ngx_de_Çme
(&
dœ
), 
Ën
 + 1);

342 
’Œy
->
esÿ³
 = 2 * 
	`ngx_esÿ³_uri
(
NULL
, 
	`ngx_de_Çme
(&
dœ
), 
Ën
,

343 
NGX_ESCAPE_URI_COMPONENT
);

345 
’Œy
->
esÿ³_html
 = 
	`ngx_esÿ³_html
(
NULL
,ƒÁry->
Çme
.
d©a
,

346 
’Œy
->
Çme
.
Ën
);

348 ià(
utf8
) {

349 
’Œy
->
utf_Ën
 = 
	`ngx_utf8_Ëngth
ÓÁry->
Çme
.
d©a
,ƒÁry->Çme.
Ën
);

351 
’Œy
->
utf_Ën
 = 
Ën
;

354 
’Œy
->
dœ
 = 
	`ngx_de_is_dœ
(&dir);

355 
’Œy
->
mtime
 = 
	`ngx_de_mtime
(&
dœ
);

356 
’Œy
->
size
 = 
	`ngx_de_size
(&
dœ
);

359 ià(
	`ngx_þo£_dœ
(&
dœ
è=ð
NGX_ERROR
) {

360 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

361 
ngx_þo£_dœ_n
 " \"%V\" fažed", &
·th
);

364 
esÿ³_html
 = 
	`ngx_esÿ³_html
(
NULL
, 
r
->
uri
.
d©a
,„->uri.
Ën
);

366 
Ën
 = (
t™Ë
) - 1

367 + 
r
->
uri
.
Ën
 + 
esÿ³_html


368 + (
h—d”
) - 1

369 + 
r
->
uri
.
Ën
 + 
esÿ³_html


371 + ("<hr><´e><¨h»f=\"../\">../</a>" 
CRLF
) - 1

373 + (
ž
) - 1;

375 
’Œy
 = 
’Œ›s
.
–ts
;

376 
i
 = 0; i < 
’Œ›s
.
ÃÉs
; i++) {

377 
Ën
 += ("<a href=\"") - 1

378 + 
’Œy
[
i
].
Çme
.
Ën
 +ƒÁry[i].
esÿ³


381 + 
’Œy
[
i
].
Çme
.
Ën
 -ƒÁry[i].
utf_Ën


382 + 
’Œy
[
i
].
esÿ³_html


383 + 
NGX_HTTP_AUTOINDEX_NAME_LEN
 + ("&gt;") - 2

390 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
Ën
);

391 ià(
b
 =ð
NULL
) {

392  
NGX_ERROR
;

395 ià(
’Œ›s
.
ÃÉs
 > 1) {

396 
	`ngx_qsÜt
(
’Œy
, (
size_t
è
’Œ›s
.
ÃÉs
,

397 (
ngx_h‰p_autošdex_’Œy_t
),

398 
ngx_h‰p_autošdex_cmp_’Œ›s
);

401 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
t™Ë
, (title) - 1);

403 ià(
esÿ³_html
) {

404 
b
->
Ï¡
 = (
u_ch¬
 *è
	`ngx_esÿ³_html
(b->Ï¡, 
r
->
uri
.
d©a
,„->uri.
Ën
);

405 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
h—d”
, (header) - 1);

406 
b
->
Ï¡
 = (
u_ch¬
 *è
	`ngx_esÿ³_html
(b->Ï¡, 
r
->
uri
.
d©a
,„->uri.
Ën
);

409 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
r
->
uri
.
d©a
,„->uri.
Ën
);

410 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
h—d”
, (header) - 1);

411 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
r
->
uri
.
d©a
,„->uri.
Ën
);

414 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "</h1>", ("</h1>") - 1);

416 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, "<hr><´e><¨h»f=\"../\">../</a>" 
CRLF
,

417 ("<hr><´e><¨h»f=\"../\">../</a>" 
CRLF
) - 1);

419 

 = 
	`ngx_timeofday
();

421 
i
 = 0; i < 
’Œ›s
.
ÃÉs
; i++) {

422 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "<a href=\"", ("<a href=\"") - 1);

424 ià(
’Œy
[
i
].
esÿ³
) {

425 
	`ngx_esÿ³_uri
(
b
->
Ï¡
, 
’Œy
[
i
].
Çme
.
d©a
,ƒÁry[i].Çme.
Ën
,

426 
NGX_ESCAPE_URI_COMPONENT
);

428 
b
->
Ï¡
 +ð
’Œy
[
i
].
Çme
.
Ën
 +ƒÁry[i].
esÿ³
;

431 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
’Œy
[
i
].
Çme
.
d©a
,

432 
’Œy
[
i
].
Çme
.
Ën
);

435 ià(
’Œy
[
i
].
dœ
) {

436 *
b
->
Ï¡
++ = '/';

439 *
b
->
Ï¡
++ = '"';

440 *
b
->
Ï¡
++ = '>';

442 
Ën
 = 
’Œy
[
i
].
utf_Ën
;

444 ià(
’Œy
[
i
].
Çme
.
Ën
 !=†en) {

445 ià(
Ën
 > 
NGX_HTTP_AUTOINDEX_NAME_LEN
) {

446 
ch¬_Ën
 = 
NGX_HTTP_AUTOINDEX_NAME_LEN
 - 3 + 1;

449 
ch¬_Ën
 = 
NGX_HTTP_AUTOINDEX_NAME_LEN
 + 1;

452 
Ï¡
 = 
b
->last;

453 
b
->
Ï¡
 = 
	`ngx_utf8_ýy¡º
(b->Ï¡, 
’Œy
[
i
].
Çme
.
d©a
,

454 
ch¬_Ën
, 
’Œy
[
i
].
Çme
.
Ën
 + 1);

456 ià(
’Œy
[
i
].
esÿ³_html
) {

457 
b
->
Ï¡
 = (
u_ch¬
 *è
	`ngx_esÿ³_html
Öa¡, 
’Œy
[
i
].
Çme
.
d©a
,

458 
b
->
Ï¡
 -†ast);

461 
Ï¡
 = 
b
->last;

464 ià(
’Œy
[
i
].
esÿ³_html
) {

465 ià(
Ën
 > 
NGX_HTTP_AUTOINDEX_NAME_LEN
) {

466 
ch¬_Ën
 = 
NGX_HTTP_AUTOINDEX_NAME_LEN
 - 3;

469 
ch¬_Ën
 = 
Ën
;

472 
b
->
Ï¡
 = (
u_ch¬
 *è
	`ngx_esÿ³_html
(b->last,

473 
’Œy
[
i
].
Çme
.
d©a
, 
ch¬_Ën
);

474 
Ï¡
 = 
b
->last;

477 
b
->
Ï¡
 = 
	`ngx_ýy¡º
(b->Ï¡, 
’Œy
[
i
].
Çme
.
d©a
,

478 
NGX_HTTP_AUTOINDEX_NAME_LEN
 + 1);

479 
Ï¡
 = 
b
->last - 3;

483 ià(
Ën
 > 
NGX_HTTP_AUTOINDEX_NAME_LEN
) {

484 
b
->
Ï¡
 = 
	`ngx_ýymem
(last, "..&gt;</a>", ("..&gt;</a>") - 1);

487 ià(
’Œy
[
i
].
dœ
 && 
NGX_HTTP_AUTOINDEX_NAME_LEN
 - 
Ën
 > 0) {

488 *
b
->
Ï¡
++ = '/';

489 
Ën
++;

492 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "</a>", ("</a>") - 1);

494 ià(
NGX_HTTP_AUTOINDEX_NAME_LEN
 - 
Ën
 > 0) {

495 
	`ngx_mem£t
(
b
->
Ï¡
, ' ', 
NGX_HTTP_AUTOINDEX_NAME_LEN
 - 
Ën
);

496 
b
->
Ï¡
 +ð
NGX_HTTP_AUTOINDEX_NAME_LEN
 - 
Ën
;

500 *
b
->
Ï¡
++ = ' ';

502 
	`ngx_gmtime
(
’Œy
[
i
].
mtime
 + 

->
gmtoff
 * 60 * 
®cf
->
loÿÉime
, &
tm
);

504 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->last, "%02d-%s-%d %02d:%02d ",

505 
tm
.
ngx_tm_mday
,

506 
mÚths
[
tm
.
ngx_tm_mÚ
 - 1],

507 
tm
.
ngx_tm_y—r
,

508 
tm
.
ngx_tm_hour
,

509 
tm
.
ngx_tm_mš
);

511 ià(
®cf
->
exaù_size
) {

512 ià(
’Œy
[
i
].
dœ
) {

513 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, " -",

516 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, "%19O", 
’Œy
[
i
].
size
);

520 ià(
’Œy
[
i
].
dœ
) {

521 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, " -",

525 
Ëngth
 = 
’Œy
[
i
].
size
;

527 ià(
Ëngth
 > 1024 * 1024 * 1024 - 1) {

528 
size
 = (
ngx_št_t
è(
Ëngth
 / (1024 * 1024 * 1024));

529 ià((
Ëngth
 % (1024 * 1024 * 1024))

532 
size
++;

534 
sÿË
 = 'G';

536 } ià(
Ëngth
 > 1024 * 1024 - 1) {

537 
size
 = (
ngx_št_t
è(
Ëngth
 / (1024 * 1024));

538 ià((
Ëngth
 % (1024 * 1024)) > (1024 * 1024 / 2 - 1)) {

539 
size
++;

541 
sÿË
 = 'M';

543 } ià(
Ëngth
 > 9999) {

544 
size
 = (
ngx_št_t
è(
Ëngth
 / 1024);

545 ià(
Ëngth
 % 1024 > 511) {

546 
size
++;

548 
sÿË
 = 'K';

551 
size
 = (
ngx_št_t
è
Ëngth
;

552 
sÿË
 = '\0';

555 ià(
sÿË
) {

556 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, "%6i%c", 
size
, 
sÿË
);

559 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, " %6i", 
size
);

564 *
b
->
Ï¡
++ = 
CR
;

565 *
b
->
Ï¡
++ = 
LF
;

570 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "</pre><hr>", ("</pre><hr>") - 1);

572 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
ž
, (tail) - 1);

574 ià(
r
 =ðr->
maš
) {

575 
b
->
Ï¡_buf
 = 1;

578 
b
->
Ï¡_š_chaš
 = 1;

580 
out
.
buf
 = 
b
;

581 
out
.
Ãxt
 = 
NULL
;

583  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

584 
	}
}

587 
ngx_libc_cdeþ


588 
	$ngx_h‰p_autošdex_cmp_’Œ›s
(cÚ¡ *
Úe
, cÚ¡ *
two
)

590 
ngx_h‰p_autošdex_’Œy_t
 *
fœ¡
 = (ngx_h‰p_autošdex_’Œy_ˆ*è
Úe
;

591 
ngx_h‰p_autošdex_’Œy_t
 *
£cÚd
 = (ngx_h‰p_autošdex_’Œy_ˆ*è
two
;

593 ià(
fœ¡
->
dœ
 && !
£cÚd
->dir) {

598 ià(!
fœ¡
->
dœ
 && 
£cÚd
->dir) {

603  (è
	`ngx_¡rcmp
(
fœ¡
->
Çme
.
d©a
, 
£cÚd
->name.data);

604 
	}
}

609 
ngx_buf_t
 *

610 
	$ngx_h‰p_autošdex_®loc
(
ngx_h‰p_autošdex_ùx_t
 *
ùx
, 
size_t
 
size
)

612 
ngx_chaš_t
 *
þ
;

614 ià(
ùx
->
buf
) {

616 ià((
size_t
è(
ùx
->
buf
->
’d
 - ctx->buf->
Ï¡
è>ð
size
) {

617  
ùx
->
buf
;

620 
ùx
->
size
 +ðùx->
buf
->
Ï¡
 - ctx->buf->
pos
;

623 
ùx
->
buf
 = 
	`ngx_ü—‹_‹mp_buf
(ùx->
poÞ
, ctx->
®loc_size
);

624 ià(
ùx
->
buf
 =ð
NULL
) {

625  
NULL
;

628 
þ
 = 
	`ngx_®loc_chaš_lšk
(
ùx
->
poÞ
);

629 ià(
þ
 =ð
NULL
) {

630  
NULL
;

633 
þ
->
buf
 = 
ùx
->buf;

634 
þ
->
Ãxt
 = 
NULL
;

636 *
ùx
->
Ï¡_out
 = 
þ
;

637 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

639  
ùx
->
buf
;

640 
	}
}

645 
ngx_št_t


646 
	$ngx_h‰p_autošdex_”rÜ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_dœ_t
 *
dœ
, 
ngx_¡r_t
 *
Çme
)

648 ià(
	`ngx_þo£_dœ
(
dœ
è=ð
NGX_ERROR
) {

649 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

650 
ngx_þo£_dœ_n
 " \"%V\" fažed", 
Çme
);

653  
r
->
h—d”_£Á
 ? 
NGX_ERROR
 : 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

654 
	}
}

658 
	$ngx_h‰p_autošdex_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

660 
ngx_h‰p_autošdex_loc_cÚf_t
 *
cÚf
;

662 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_autošdex_loc_cÚf_t
));

663 ià(
cÚf
 =ð
NULL
) {

664  
NULL
;

667 
cÚf
->
’abË
 = 
NGX_CONF_UNSET
;

668 
cÚf
->
loÿÉime
 = 
NGX_CONF_UNSET
;

669 
cÚf
->
exaù_size
 = 
NGX_CONF_UNSET
;

671  
cÚf
;

672 
	}
}

676 
	$ngx_h‰p_autošdex_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

678 
ngx_h‰p_autošdex_loc_cÚf_t
 *
´ev
 = 
·»Á
;

679 
ngx_h‰p_autošdex_loc_cÚf_t
 *
cÚf
 = 
chžd
;

681 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

682 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
loÿÉime
, 
´ev
->localtime, 0);

683 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
exaù_size
, 
´ev
->exact_size, 1);

685  
NGX_CONF_OK
;

686 
	}
}

689 
ngx_št_t


690 
	$ngx_h‰p_autošdex_š™
(
ngx_cÚf_t
 *
cf
)

692 
ngx_h‰p_hªdËr_±
 *
h
;

693 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

695 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

697 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_CONTENT_PHASE
].
hªdËrs
);

698 ià(
h
 =ð
NULL
) {

699  
NGX_ERROR
;

702 *
h
 = 
ngx_h‰p_autošdex_hªdËr
;

704  
NGX_OK
;

705 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_browser_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

20 
	#NGX_HTTP_MODERN_BROWSER
 0

	)

21 
	#NGX_HTTP_ANCIENT_BROWSER
 1

	)

25 
u_ch¬
 
	mbrow£r
[12];

26 
size_t
 
	msk
;

27 
size_t
 
	madd
;

28 
u_ch¬
 
	mÇme
[12];

29 } 
	tngx_h‰p_mod”n_brow£r_mask_t
;

33 
ngx_ušt_t
 
	mv”siÚ
;

34 
size_t
 
	msk
;

35 
size_t
 
	madd
;

36 
u_ch¬
 
	mÇme
[12];

37 } 
	tngx_h‰p_mod”n_brow£r_t
;

41 
ngx_¡r_t
 
	mÇme
;

42 
ngx_h‰p_g‘_v¬ŸbË_±
 
	mhªdËr
;

43 
ušŒ_t
 
	md©a
;

44 } 
	tngx_h‰p_brow£r_v¬ŸbË_t
;

48 
ngx_¬¿y_t
 *
	mmod”n_brow£rs
;

49 
ngx_¬¿y_t
 *
	mªc›Á_brow£rs
;

50 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
	mmod”n_brow£r_v®ue
;

51 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
	mªc›Á_brow£r_v®ue
;

53 
	mmod”n_uÆi¡ed_brow£rs
:1;

54 
	mÃtsÿ³4
:1;

55 } 
	tngx_h‰p_brow£r_cÚf_t
;

58 
ngx_št_t
 
ngx_h‰p_ms›_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

59 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

60 
ngx_št_t
 
ngx_h‰p_brow£r_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

61 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

63 
ngx_ušt_t
 
ngx_h‰p_brow£r
(
ngx_h‰p_»que¡_t
 *
r
,

64 
ngx_h‰p_brow£r_cÚf_t
 *
cf
);

66 
ngx_št_t
 
ngx_h‰p_brow£r_add_v¬ŸbË
(
ngx_cÚf_t
 *
cf
);

67 *
ngx_h‰p_brow£r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

68 *
ngx_h‰p_brow£r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

69 *
chžd
);

70 
ngx_libc_cdeþ
 
ngx_h‰p_mod”n_brow£r_sÜt
(cÚ¡ *
Úe
,

71 cÚ¡ *
two
);

72 *
ngx_h‰p_mod”n_brow£r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

73 *
cÚf
);

74 *
ngx_h‰p_ªc›Á_brow£r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

75 *
cÚf
);

76 *
ngx_h‰p_mod”n_brow£r_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

77 *
cÚf
);

78 *
ngx_h‰p_ªc›Á_brow£r_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

79 *
cÚf
);

82 
ngx_commªd_t
 
	gngx_h‰p_brow£r_commªds
[] = {

84 { 
ngx_¡ršg
("modern_browser"),

85 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE12
,

86 
ngx_h‰p_mod”n_brow£r
,

87 
NGX_HTTP_LOC_CONF_OFFSET
,

89 
NULL
 },

91 { 
ngx_¡ršg
("ancient_browser"),

92 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

93 
ngx_h‰p_ªc›Á_brow£r
,

94 
NGX_HTTP_LOC_CONF_OFFSET
,

96 
NULL
 },

98 { 
ngx_¡ršg
("modern_browser_value"),

99 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

100 
ngx_h‰p_mod”n_brow£r_v®ue
,

101 
NGX_HTTP_LOC_CONF_OFFSET
,

103 
NULL
 },

105 { 
ngx_¡ršg
("ancient_browser_value"),

106 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

107 
ngx_h‰p_ªc›Á_brow£r_v®ue
,

108 
NGX_HTTP_LOC_CONF_OFFSET
,

110 
NULL
 },

112 
ngx_nuÎ_commªd


116 
ngx_h‰p_moduË_t
 
	gngx_h‰p_brow£r_moduË_ùx
 = {

117 
ngx_h‰p_brow£r_add_v¬ŸbË
,

118 
NULL
,

120 
NULL
,

121 
NULL
,

123 
NULL
,

124 
NULL
,

126 
ngx_h‰p_brow£r_ü—‹_cÚf
,

127 
ngx_h‰p_brow£r_m”ge_cÚf


131 
ngx_moduË_t
 
	gngx_h‰p_brow£r_moduË
 = {

132 
NGX_MODULE_V1
,

133 &
ngx_h‰p_brow£r_moduË_ùx
,

134 
ngx_h‰p_brow£r_commªds
,

135 
NGX_HTTP_MODULE
,

136 
NULL
,

137 
NULL
,

138 
NULL
,

139 
NULL
,

140 
NULL
,

141 
NULL
,

142 
NULL
,

143 
NGX_MODULE_V1_PADDING


147 
ngx_h‰p_mod”n_brow£r_mask_t
 
	gngx_h‰p_mod”n_brow£r_masks
[] = {

221 
ngx_h‰p_brow£r_v¬ŸbË_t
 
	gngx_h‰p_brow£rs
[] = {

222 { 
ngx_¡ršg
("ms›"), 
ngx_h‰p_ms›_v¬ŸbË
, 0 },

223 { 
ngx_¡ršg
("mod”n_brow£r"), 
ngx_h‰p_brow£r_v¬ŸbË
,

224 
NGX_HTTP_MODERN_BROWSER
 },

225 { 
ngx_¡ršg
("ªc›Á_brow£r"), 
ngx_h‰p_brow£r_v¬ŸbË
,

226 
NGX_HTTP_ANCIENT_BROWSER
 },

227 { 
ngx_nuÎ_¡ršg
, 
NULL
, 0 }

231 
ngx_št_t


232 
	$ngx_h‰p_brow£r_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

233 
ušŒ_t
 
d©a
)

235 
ngx_ušt_t
 
rc
;

236 
ngx_h‰p_brow£r_cÚf_t
 *
cf
;

238 
cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_brow£r_moduË
);

240 
rc
 = 
	`ngx_h‰p_brow£r
(
r
, 
cf
);

242 ià(
d©a
 =ð
NGX_HTTP_MODERN_BROWSER
 && 
rc
 == NGX_HTTP_MODERN_BROWSER) {

243 *
v
 = *
cf
->
mod”n_brow£r_v®ue
;

244  
NGX_OK
;

247 ià(
d©a
 =ð
NGX_HTTP_ANCIENT_BROWSER
 && 
rc
 == NGX_HTTP_ANCIENT_BROWSER) {

248 *
v
 = *
cf
->
ªc›Á_brow£r_v®ue
;

249  
NGX_OK
;

252 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

253  
NGX_OK
;

254 
	}
}

257 
ngx_ušt_t


258 
	$ngx_h‰p_brow£r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_brow£r_cÚf_t
 *
cf
)

260 
size_t
 
Ën
;

261 
u_ch¬
 *
Çme
, *
ua
, *
Ï¡
, 
c
;

262 
ngx_¡r_t
 *
ªc›Á
;

263 
ngx_ušt_t
 
i
, 
v”siÚ
, 
v”
, 
sÿË
;

264 
ngx_h‰p_mod”n_brow£r_t
 *
mod”n
;

266 ià(
r
->
h—d”s_š
.
u£r_ag’t
 =ð
NULL
) {

267 ià(
cf
->
mod”n_uÆi¡ed_brow£rs
) {

268  
NGX_HTTP_MODERN_BROWSER
;

271  
NGX_HTTP_ANCIENT_BROWSER
;

274 
ua
 = 
r
->
h—d”s_š
.
u£r_ag’t
->
v®ue
.
d©a
;

275 
Ën
 = 
r
->
h—d”s_š
.
u£r_ag’t
->
v®ue
.len;

276 
Ï¡
 = 
ua
 + 
Ën
;

278 ià(
cf
->
mod”n_brow£rs
) {

279 
mod”n
 = 
cf
->
mod”n_brow£rs
->
–ts
;

281 
i
 = 0; i < 
cf
->
mod”n_brow£rs
->
ÃÉs
; i++) {

282 
Çme
 = 
ua
 + 
mod”n
[
i
].
sk
;

284 ià(
Çme
 >ð
Ï¡
) {

288 
Çme
 = (
u_ch¬
 *è
	`ngx_¡r¡r
Òame, 
mod”n
[
i
].name);

290 ià(
Çme
 =ð
NULL
) {

294 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

295 "brow£r: \"%s\"", 
Çme
);

297 
Çme
 +ð
mod”n
[
i
].
add
;

299 ià(
Çme
 >ð
Ï¡
) {

303 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

304 "v”siÚ: \"%ui\" \"%s\"", 
mod”n
[
i
].
v”siÚ
, 
Çme
);

306 
v”siÚ
 = 0;

307 
v”
 = 0;

308 
sÿË
 = 1000000;

310 
Çme
 < 
Ï¡
) {

312 
c
 = *
Çme
++;

314 ià(
c
 >= '0' && c <= '9') {

315 
v”
 = v” * 10 + (
c
 - '0');

319 ià(
c
 == '.') {

320 
v”siÚ
 +ð
v”
 * 
sÿË
;

322 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

324 
mod”n
[
i
].
v”siÚ
, version);

326 ià(
v”siÚ
 > 
mod”n
[
i
].version) {

327  
NGX_HTTP_MODERN_BROWSER
;

330 
v”
 = 0;

331 
sÿË
 /= 100;

338 
v”siÚ
 +ð
v”
 * 
sÿË
;

340 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

342 
mod”n
[
i
].
v”siÚ
, version);

344 ià(
v”siÚ
 >ð
mod”n
[
i
].version) {

345  
NGX_HTTP_MODERN_BROWSER
;

348  
NGX_HTTP_ANCIENT_BROWSER
;

351 ià(!
cf
->
mod”n_uÆi¡ed_brow£rs
) {

352  
NGX_HTTP_ANCIENT_BROWSER
;

356 ià(
cf
->
Ãtsÿ³4
) {

357 ià(
Ën
 > ("Mozilla/4.72 ") - 1

358 && 
	`ngx_¡ºcmp
(
ua
, "Mozilla/", ("Mozilla/") - 1) == 0

359 && 
ua
[8] > '0' && ua[8] < '5')

361  
NGX_HTTP_ANCIENT_BROWSER
;

365 ià(
cf
->
ªc›Á_brow£rs
) {

366 
ªc›Á
 = 
cf
->
ªc›Á_brow£rs
->
–ts
;

368 
i
 = 0; i < 
cf
->
ªc›Á_brow£rs
->
ÃÉs
; i++) {

369 ià(
Ën
 >ð
ªc›Á
[
i
].len

370 && 
	`ngx_¡r¡r
(
ua
, 
ªc›Á
[
i
].
d©a
è!ð
NULL
)

372  
NGX_HTTP_ANCIENT_BROWSER
;

377 ià(
cf
->
mod”n_uÆi¡ed_brow£rs
) {

378  
NGX_HTTP_MODERN_BROWSER
;

381  
NGX_HTTP_ANCIENT_BROWSER
;

382 
	}
}

385 
ngx_št_t


386 
	$ngx_h‰p_ms›_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

387 
ušŒ_t
 
d©a
)

389 ià(
r
->
h—d”s_š
.
ms›
) {

390 *
v
 = 
ngx_h‰p_v¬ŸbË_Œue_v®ue
;

391  
NGX_OK
;

394 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

395  
NGX_OK
;

396 
	}
}

399 
ngx_št_t


400 
	$ngx_h‰p_brow£r_add_v¬ŸbË
(
ngx_cÚf_t
 *
cf
)

402 
ngx_h‰p_brow£r_v¬ŸbË_t
 *
v¬
;

403 
ngx_h‰p_v¬ŸbË_t
 *
v
;

405 
v¬
 = 
ngx_h‰p_brow£rs
; v¬->
Çme
.
Ën
; var++) {

407 
v
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v¬
->
Çme
, 
NGX_HTTP_VAR_CHANGEABLE
);

408 ià(
v
 =ð
NULL
) {

409  
NGX_ERROR
;

412 
v
->
g‘_hªdËr
 = 
v¬
->
hªdËr
;

413 
v
->
d©a
 = 
v¬
->data;

416  
NGX_OK
;

417 
	}
}

421 
	$ngx_h‰p_brow£r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

423 
ngx_h‰p_brow£r_cÚf_t
 *
cÚf
;

425 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_brow£r_cÚf_t
));

426 ià(
cÚf
 =ð
NULL
) {

427  
NULL
;

442  
cÚf
;

443 
	}
}

447 
	$ngx_h‰p_brow£r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

449 
ngx_h‰p_brow£r_cÚf_t
 *
´ev
 = 
·»Á
;

450 
ngx_h‰p_brow£r_cÚf_t
 *
cÚf
 = 
chžd
;

452 
ngx_ušt_t
 
i
, 
n
;

453 
ngx_h‰p_mod”n_brow£r_t
 *
brow£rs
, *
Ý”a
;

461 ià(
cÚf
->
mod”n_brow£rs
 =ð
NULL
 && cÚf->
mod”n_uÆi¡ed_brow£rs
 == 0) {

462 
cÚf
->
mod”n_brow£rs
 = 
´ev
->modern_browsers;

463 
cÚf
->
mod”n_uÆi¡ed_brow£rs
 = 
´ev
->modern_unlisted_browsers;

465 } ià(
cÚf
->
mod”n_brow£rs
 !ð
NULL
) {

466 
brow£rs
 = 
cÚf
->
mod”n_brow£rs
->
–ts
;

468 
i
 = 0; i < 
cÚf
->
mod”n_brow£rs
->
ÃÉs
; i++) {

469 ià(
brow£rs
[
i
].
sk
 == 0) {

470 
found
;

479 
Ý”a
 = 
	`ngx_¬¿y_push
(
cÚf
->
mod”n_brow£rs
);

480 ià(
Ý”a
 =ð
NULL
) {

481  
NGX_CONF_ERROR
;

484 
Ý”a
->
sk
 = 0;

485 
Ý”a
->
v”siÚ
 = 4001000000U;

487 
brow£rs
 = 
cÚf
->
mod”n_brow£rs
->
–ts
;

489 
found
:

491 
	`ngx_qsÜt
(
brow£rs
, (
size_t
è
cÚf
->
mod”n_brow£rs
->
ÃÉs
,

492 (
ngx_h‰p_mod”n_brow£r_t
),

493 
ngx_h‰p_mod”n_brow£r_sÜt
);

495 
i
 = 0; i < 
cÚf
->
mod”n_brow£rs
->
ÃÉs
; i++) {

496 
n
 = 
brow£rs
[
i
].
sk
;

498 
brow£rs
[
i
].
sk
 = 
ngx_h‰p_mod”n_brow£r_masks
[
n
].skip;

499 
brow£rs
[
i
].
add
 = 
ngx_h‰p_mod”n_brow£r_masks
[
n
].add;

500 (è
	`ngx_ýy¡º
(
brow£rs
[
i
].
Çme
,

501 
ngx_h‰p_mod”n_brow£r_masks
[
n
].
Çme
, 12);

505 ià(
cÚf
->
ªc›Á_brow£rs
 =ð
NULL
 && cÚf->
Ãtsÿ³4
 == 0) {

506 
cÚf
->
ªc›Á_brow£rs
 = 
´ev
->ancient_browsers;

507 
cÚf
->
Ãtsÿ³4
 = 
´ev
->netscape4;

510 ià(
cÚf
->
mod”n_brow£r_v®ue
 =ð
NULL
) {

511 
cÚf
->
mod”n_brow£r_v®ue
 = 
´ev
->modern_browser_value;

514 ià(
cÚf
->
mod”n_brow£r_v®ue
 =ð
NULL
) {

515 
cÚf
->
mod”n_brow£r_v®ue
 = &
ngx_h‰p_v¬ŸbË_Œue_v®ue
;

518 ià(
cÚf
->
ªc›Á_brow£r_v®ue
 =ð
NULL
) {

519 
cÚf
->
ªc›Á_brow£r_v®ue
 = 
´ev
->ancient_browser_value;

522 ià(
cÚf
->
ªc›Á_brow£r_v®ue
 =ð
NULL
) {

523 
cÚf
->
ªc›Á_brow£r_v®ue
 = &
ngx_h‰p_v¬ŸbË_Œue_v®ue
;

526  
NGX_CONF_OK
;

527 
	}
}

530 
ngx_libc_cdeþ


531 
	$ngx_h‰p_mod”n_brow£r_sÜt
(cÚ¡ *
Úe
, cÚ¡ *
two
)

533 
ngx_h‰p_mod”n_brow£r_t
 *
fœ¡
 = (ngx_h‰p_mod”n_brow£r_ˆ*è
Úe
;

534 
ngx_h‰p_mod”n_brow£r_t
 *
£cÚd
 = (ngx_h‰p_mod”n_brow£r_ˆ*è
two
;

536  (
fœ¡
->
sk
 - 
£cÚd
->skip);

537 
	}
}

541 
	$ngx_h‰p_mod”n_brow£r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

543 
ngx_h‰p_brow£r_cÚf_t
 *
bcf
 = 
cÚf
;

545 
u_ch¬
 
c
;

546 
ngx_¡r_t
 *
v®ue
;

547 
ngx_ušt_t
 
i
, 
n
, 
v”siÚ
, 
v”
, 
sÿË
;

548 
ngx_h‰p_mod”n_brow£r_t
 *
brow£r
;

549 
ngx_h‰p_mod”n_brow£r_mask_t
 *
mask
;

551 
v®ue
 = 
cf
->
¬gs
->
–ts
;

553 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

554 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "unlisted") == 0) {

555 
bcf
->
mod”n_uÆi¡ed_brow£rs
 = 1;

556  
NGX_CONF_OK
;

559  
NGX_CONF_ERROR
;

562 ià(
bcf
->
mod”n_brow£rs
 =ð
NULL
) {

563 
bcf
->
mod”n_brow£rs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 5,

564 (
ngx_h‰p_mod”n_brow£r_t
));

565 ià(
bcf
->
mod”n_brow£rs
 =ð
NULL
) {

566  
NGX_CONF_ERROR
;

570 
brow£r
 = 
	`ngx_¬¿y_push
(
bcf
->
mod”n_brow£rs
);

571 ià(
brow£r
 =ð
NULL
) {

572  
NGX_CONF_ERROR
;

575 
mask
 = 
ngx_h‰p_mod”n_brow£r_masks
;

577 
n
 = 0; 
mask
[n].
brow£r
[0] != '\0';‚++) {

578 ià(
	`ngx_¡rÿ£cmp
(
mask
[
n
].
brow£r
, 
v®ue
[1].
d©a
) == 0) {

579 
found
;

583 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

584 "unknowÀbrow£¸Çm\"%V\"", &
v®ue
[1]);

586  
NGX_CONF_ERROR
;

588 
found
:

596 
brow£r
->
sk
 = 
n
;

598 
v”siÚ
 = 0;

599 
v”
 = 0;

600 
sÿË
 = 1000000;

602 
i
 = 0; i < 
v®ue
[2].
Ën
; i++) {

604 
c
 = 
v®ue
[2].
d©a
[
i
];

606 ià(
c
 >= '0' && c <= '9') {

607 
v”
 = v” * 10 + (
c
 - '0');

611 ià(
c
 == '.') {

612 
v”siÚ
 +ð
v”
 * 
sÿË
;

613 
v”
 = 0;

614 
sÿË
 /= 100;

618 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

619 "šv®id brow£¸v”siÚ \"%V\"", &
v®ue
[2]);

621  
NGX_CONF_ERROR
;

624 
v”siÚ
 +ð
v”
 * 
sÿË
;

626 
brow£r
->
v”siÚ
 = version;

628  
NGX_CONF_OK
;

629 
	}
}

633 
	$ngx_h‰p_ªc›Á_brow£r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

635 
ngx_h‰p_brow£r_cÚf_t
 *
bcf
 = 
cÚf
;

637 
ngx_¡r_t
 *
v®ue
, *
brow£r
;

638 
ngx_ušt_t
 
i
;

640 
v®ue
 = 
cf
->
¬gs
->
–ts
;

642 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

643 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "netscape4") == 0) {

644 
bcf
->
Ãtsÿ³4
 = 1;

648 ià(
bcf
->
ªc›Á_brow£rs
 =ð
NULL
) {

649 
bcf
->
ªc›Á_brow£rs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4,

650 (
ngx_¡r_t
));

651 ià(
bcf
->
ªc›Á_brow£rs
 =ð
NULL
) {

652  
NGX_CONF_ERROR
;

656 
brow£r
 = 
	`ngx_¬¿y_push
(
bcf
->
ªc›Á_brow£rs
);

657 ià(
brow£r
 =ð
NULL
) {

658  
NGX_CONF_ERROR
;

661 *
brow£r
 = 
v®ue
[
i
];

664  
NGX_CONF_OK
;

665 
	}
}

669 
	$ngx_h‰p_mod”n_brow£r_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

671 
ngx_h‰p_brow£r_cÚf_t
 *
bcf
 = 
cÚf
;

673 
ngx_¡r_t
 *
v®ue
;

675 
bcf
->
mod”n_brow£r_v®ue
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,

676 (
ngx_h‰p_v¬ŸbË_v®ue_t
));

677 ià(
bcf
->
mod”n_brow£r_v®ue
 =ð
NULL
) {

678  
NGX_CONF_ERROR
;

681 
v®ue
 = 
cf
->
¬gs
->
–ts
;

683 
bcf
->
mod”n_brow£r_v®ue
->
Ën
 = 
v®ue
[1].len;

684 
bcf
->
mod”n_brow£r_v®ue
->
v®id
 = 1;

685 
bcf
->
mod”n_brow£r_v®ue
->
no_ÿch—bË
 = 0;

686 
bcf
->
mod”n_brow£r_v®ue
->
nÙ_found
 = 0;

687 
bcf
->
mod”n_brow£r_v®ue
->
d©a
 = 
v®ue
[1].data;

689  
NGX_CONF_OK
;

690 
	}
}

694 
	$ngx_h‰p_ªc›Á_brow£r_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

696 
ngx_h‰p_brow£r_cÚf_t
 *
bcf
 = 
cÚf
;

698 
ngx_¡r_t
 *
v®ue
;

700 
bcf
->
ªc›Á_brow£r_v®ue
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,

701 (
ngx_h‰p_v¬ŸbË_v®ue_t
));

702 ià(
bcf
->
ªc›Á_brow£r_v®ue
 =ð
NULL
) {

703  
NGX_CONF_ERROR
;

706 
v®ue
 = 
cf
->
¬gs
->
–ts
;

708 
bcf
->
ªc›Á_brow£r_v®ue
->
Ën
 = 
v®ue
[1].len;

709 
bcf
->
ªc›Á_brow£r_v®ue
->
v®id
 = 1;

710 
bcf
->
ªc›Á_brow£r_v®ue
->
no_ÿch—bË
 = 0;

711 
bcf
->
ªc›Á_brow£r_v®ue
->
nÙ_found
 = 0;

712 
bcf
->
ªc›Á_brow£r_v®ue
->
d©a
 = 
v®ue
[1].data;

714  
NGX_CONF_OK
;

715 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_charset_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
	#NGX_HTTP_CHARSET_OFF
 -2

	)

14 
	#NGX_HTTP_NO_CHARSET
 -3

	)

15 
	#NGX_HTTP_CHARSET_VAR
 0x10000

	)

18 
	#NGX_UTF_LEN
 4

	)

20 
	#NGX_HTML_ENTITY_LEN
 (("&#1114111;"è- 1)

	)

24 
u_ch¬
 **
	mbËs
;

25 
ngx_¡r_t
 
	mÇme
;

27 
	mËngth
:16;

28 
	mutf8
:1;

29 } 
	tngx_h‰p_ch¬£t_t
;

33 
ngx_št_t
 
	m¤c
;

34 
ngx_št_t
 
	md¡
;

35 } 
	tngx_h‰p_ch¬£t_»code_t
;

39 
ngx_št_t
 
	m¤c
;

40 
ngx_št_t
 
	md¡
;

41 
u_ch¬
 *
	m¤c2d¡
;

42 
u_ch¬
 *
	md¡2¤c
;

43 } 
	tngx_h‰p_ch¬£t_bËs_t
;

47 
ngx_¬¿y_t
 
	mch¬£ts
;

48 
ngx_¬¿y_t
 
	mbËs
;

49 
ngx_¬¿y_t
 
	m»codes
;

50 } 
	tngx_h‰p_ch¬£t_maš_cÚf_t
;

54 
ngx_št_t
 
	mch¬£t
;

55 
ngx_št_t
 
	msourû_ch¬£t
;

56 
ngx_æag_t
 
	mov”ride_ch¬£t
;

58 
ngx_hash_t
 
	mty³s
;

59 
ngx_¬¿y_t
 *
	mty³s_keys
;

60 } 
	tngx_h‰p_ch¬£t_loc_cÚf_t
;

64 
u_ch¬
 *
	mbË
;

65 
ngx_št_t
 
	mch¬£t
;

66 
ngx_¡r_t
 
	mch¬£t_Çme
;

68 
ngx_chaš_t
 *
	mbusy
;

69 
ngx_chaš_t
 *
	mä“_bufs
;

70 
ngx_chaš_t
 *
	mä“_bufãrs
;

72 
size_t
 
	m§ved_Ën
;

73 
u_ch¬
 
	m§ved
[
NGX_UTF_LEN
];

75 
	mËngth
:16;

76 
	mäom_utf8
:1;

77 
	mto_utf8
:1;

78 } 
	tngx_h‰p_ch¬£t_ùx_t
;

82 
ngx_h‰p_ch¬£t_bËs_t
 *
	mbË
;

83 
ngx_h‰p_ch¬£t_t
 *
	mch¬£t
;

84 
ngx_ušt_t
 
	mch¬aù”s
;

85 } 
	tngx_h‰p_ch¬£t_cÚf_ùx_t
;

88 
ngx_št_t
 
ngx_h‰p_de¡š©iÚ_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
,

89 
ngx_¡r_t
 *
Çme
);

90 
ngx_št_t
 
ngx_h‰p_maš_»que¡_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
,

91 
ngx_¡r_t
 *
Çme
);

92 
ngx_št_t
 
ngx_h‰p_sourû_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
,

93 
ngx_¡r_t
 *
Çme
);

94 
ngx_št_t
 
ngx_h‰p_g‘_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
Çme
);

95 
ngx_šlše
 
ngx_h‰p_£t_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
,

96 
ngx_¡r_t
 *
ch¬£t
);

97 
ngx_št_t
 
ngx_h‰p_ch¬£t_ùx
(
ngx_h‰p_»que¡_t
 *
r
,

98 
ngx_h‰p_ch¬£t_t
 *
ch¬£ts
, 
ngx_št_t
 
ch¬£t
,‚gx_št_ˆ
sourû_ch¬£t
);

99 
ngx_ušt_t
 
ngx_h‰p_ch¬£t_»code
(
ngx_buf_t
 *
b
, 
u_ch¬
 *
bË
);

100 
ngx_chaš_t
 *
ngx_h‰p_ch¬£t_»code_äom_utf8
(
ngx_poÞ_t
 *
poÞ
,

101 
ngx_buf_t
 *
buf
, 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
);

102 
ngx_chaš_t
 *
ngx_h‰p_ch¬£t_»code_to_utf8
(
ngx_poÞ_t
 *
poÞ
,

103 
ngx_buf_t
 *
buf
, 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
);

105 
ngx_chaš_t
 *
ngx_h‰p_ch¬£t_g‘_buf
(
ngx_poÞ_t
 *
poÞ
,

106 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
);

107 
ngx_chaš_t
 *
ngx_h‰p_ch¬£t_g‘_bufãr
(
ngx_poÞ_t
 *
poÞ
,

108 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
, 
size_t
 
size
);

110 *
ngx_h‰p_ch¬£t_m­_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

111 *
cÚf
);

112 *
ngx_h‰p_ch¬£t_m­
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
,

113 *
cÚf
);

115 *
ngx_h‰p_£t_ch¬£t_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

116 *
cÚf
);

117 
ngx_št_t
 
ngx_h‰p_add_ch¬£t
(
ngx_¬¿y_t
 *
ch¬£ts
, 
ngx_¡r_t
 *
Çme
);

119 *
ngx_h‰p_ch¬£t_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

120 *
ngx_h‰p_ch¬£t_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

121 *
ngx_h‰p_ch¬£t_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

122 *
·»Á
, *
chžd
);

123 
ngx_št_t
 
ngx_h‰p_ch¬£t_po¡cÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
);

126 
ngx_¡r_t
 
	gngx_h‰p_ch¬£t_deçuÉ_ty³s
[] = {

127 
ngx_¡ršg
("text/html"),

128 
ngx_¡ršg
("text/xml"),

129 
ngx_¡ršg
("text/plain"),

130 
ngx_¡ršg
("text/vnd.wap.wml"),

131 
ngx_¡ršg
("application/javascript"),

132 
ngx_¡ršg
("application/rss+xml"),

133 
ngx_nuÎ_¡ršg


137 
ngx_commªd_t
 
	gngx_h‰p_ch¬£t_fž‹r_commªds
[] = {

139 { 
ngx_¡ršg
("charset"),

140 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF


141 |
NGX_HTTP_LIF_CONF
|
NGX_CONF_TAKE1
,

142 
ngx_h‰p_£t_ch¬£t_¦Ù
,

143 
NGX_HTTP_LOC_CONF_OFFSET
,

144 
off£tof
(
ngx_h‰p_ch¬£t_loc_cÚf_t
, 
ch¬£t
),

145 
NULL
 },

147 { 
ngx_¡ršg
("source_charset"),

148 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF


149 |
NGX_HTTP_LIF_CONF
|
NGX_CONF_TAKE1
,

150 
ngx_h‰p_£t_ch¬£t_¦Ù
,

151 
NGX_HTTP_LOC_CONF_OFFSET
,

152 
off£tof
(
ngx_h‰p_ch¬£t_loc_cÚf_t
, 
sourû_ch¬£t
),

153 
NULL
 },

155 { 
ngx_¡ršg
("override_charset"),

156 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF


157 |
NGX_HTTP_LIF_CONF
|
NGX_CONF_FLAG
,

158 
ngx_cÚf_£t_æag_¦Ù
,

159 
NGX_HTTP_LOC_CONF_OFFSET
,

160 
off£tof
(
ngx_h‰p_ch¬£t_loc_cÚf_t
, 
ov”ride_ch¬£t
),

161 
NULL
 },

163 { 
ngx_¡ršg
("charset_types"),

164 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

165 
ngx_h‰p_ty³s_¦Ù
,

166 
NGX_HTTP_LOC_CONF_OFFSET
,

167 
off£tof
(
ngx_h‰p_ch¬£t_loc_cÚf_t
, 
ty³s_keys
),

168 &
ngx_h‰p_ch¬£t_deçuÉ_ty³s
[0] },

170 { 
ngx_¡ršg
("charset_map"),

171 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_TAKE2
,

172 
ngx_h‰p_ch¬£t_m­_block
,

173 
NGX_HTTP_MAIN_CONF_OFFSET
,

175 
NULL
 },

177 
ngx_nuÎ_commªd


181 
ngx_h‰p_moduË_t
 
	gngx_h‰p_ch¬£t_fž‹r_moduË_ùx
 = {

182 
NULL
,

183 
ngx_h‰p_ch¬£t_po¡cÚfigu¿tiÚ
,

185 
ngx_h‰p_ch¬£t_ü—‹_maš_cÚf
,

186 
NULL
,

188 
NULL
,

189 
NULL
,

191 
ngx_h‰p_ch¬£t_ü—‹_loc_cÚf
,

192 
ngx_h‰p_ch¬£t_m”ge_loc_cÚf


196 
ngx_moduË_t
 
	gngx_h‰p_ch¬£t_fž‹r_moduË
 = {

197 
NGX_MODULE_V1
,

198 &
ngx_h‰p_ch¬£t_fž‹r_moduË_ùx
,

199 
ngx_h‰p_ch¬£t_fž‹r_commªds
,

200 
NGX_HTTP_MODULE
,

201 
NULL
,

202 
NULL
,

203 
NULL
,

204 
NULL
,

205 
NULL
,

206 
NULL
,

207 
NULL
,

208 
NGX_MODULE_V1_PADDING


212 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

213 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

216 
ngx_št_t


217 
	$ngx_h‰p_ch¬£t_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

219 
ngx_št_t
 
ch¬£t
, 
sourû_ch¬£t
;

220 
ngx_¡r_t
 
d¡
, 
¤c
;

221 
ngx_h‰p_ch¬£t_t
 *
ch¬£ts
;

222 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
;

224 ià(
r
 =ðr->
maš
) {

225 
ch¬£t
 = 
	`ngx_h‰p_de¡š©iÚ_ch¬£t
(
r
, &
d¡
);

228 
ch¬£t
 = 
	`ngx_h‰p_maš_»que¡_ch¬£t
(
r
, &
d¡
);

231 ià(
ch¬£t
 =ð
NGX_ERROR
) {

232  
NGX_ERROR
;

235 ià(
ch¬£t
 =ð
NGX_DECLINED
) {

236  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

241 
sourû_ch¬£t
 = 
	`ngx_h‰p_sourû_ch¬£t
(
r
, &
¤c
);

243 ià(
sourû_ch¬£t
 =ð
NGX_ERROR
) {

244  
NGX_ERROR
;

252 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

253 "ch¬£t: \"%V\" > \"%V\"", &
¤c
, &
d¡
);

255 ià(
sourû_ch¬£t
 =ð
NGX_HTTP_CHARSET_OFF
) {

256 
	`ngx_h‰p_£t_ch¬£t
(
r
, &
d¡
);

258  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

261 ià(
ch¬£t
 =ð
NGX_HTTP_NO_CHARSET


262 || 
sourû_ch¬£t
 =ð
NGX_HTTP_NO_CHARSET
)

264 ià(
sourû_ch¬£t
 !ð
ch¬£t


265 || 
	`ngx_¡ºÿ£cmp
(
d¡
.
d©a
, 
¤c
.d©a, d¡.
Ën
) != 0)

267 
no_ch¬£t_m­
;

270 
	`ngx_h‰p_£t_ch¬£t
(
r
, &
d¡
);

272  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

275 ià(
sourû_ch¬£t
 =ð
ch¬£t
) {

276 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 =„->h—d”s_out.
cÚ‹Á_ty³_Ën
;

278 
	`ngx_h‰p_£t_ch¬£t
(
r
, &
d¡
);

280  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

285 ià(
r
->
h—d”s_out
.
cÚ‹Á_’codšg


286 && 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
->
v®ue
.
Ën
)

288  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

291 
mcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

292 
ch¬£ts
 = 
mcf
->ch¬£ts.
–ts
;

294 ià(
ch¬£ts
[
sourû_ch¬£t
].
bËs
 =ð
NULL


295 || 
ch¬£ts
[
sourû_ch¬£t
].
bËs
[
ch¬£t
] =ð
NULL
)

297 
no_ch¬£t_m­
;

300 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 =„->h—d”s_out.
cÚ‹Á_ty³_Ën
;

302 
	`ngx_h‰p_£t_ch¬£t
(
r
, &
d¡
);

304  
	`ngx_h‰p_ch¬£t_ùx
(
r
, 
ch¬£ts
, 
ch¬£t
, 
sourû_ch¬£t
);

306 
no_ch¬£t_m­
:

308 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

310 &
¤c
, &
d¡
);

312  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

313 
	}
}

316 
ngx_št_t


317 
	$ngx_h‰p_de¡š©iÚ_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
Çme
)

319 
ngx_št_t
 
ch¬£t
;

320 
ngx_h‰p_ch¬£t_t
 *
ch¬£ts
;

321 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

322 
ngx_h‰p_ch¬£t_loc_cÚf_t
 *
mlcf
;

323 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
;

325 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 == 0) {

326  
NGX_DECLINED
;

329 ià(
r
->
h—d”s_out
.
ov”ride_ch¬£t


330 && 
r
->
h—d”s_out
.
ov”ride_ch¬£t
->
Ën
)

332 *
Çme
 = *
r
->
h—d”s_out
.
ov”ride_ch¬£t
;

334 
ch¬£t
 = 
	`ngx_h‰p_g‘_ch¬£t
(
r
, 
Çme
);

336 ià(
ch¬£t
 !ð
NGX_HTTP_NO_CHARSET
) {

337  
ch¬£t
;

340 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

341 "unknowÀch¬£ˆ\"%V\"Øov”ride", 
Çme
);

343  
NGX_DECLINED
;

346 
mlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

347 
ch¬£t
 = 
mlcf
->charset;

349 ià(
ch¬£t
 =ð
NGX_HTTP_CHARSET_OFF
) {

350  
NGX_DECLINED
;

353 ià(
r
->
h—d”s_out
.
ch¬£t
.
Ën
) {

354 ià(
mlcf
->
ov”ride_ch¬£t
 == 0) {

355  
NGX_DECLINED
;

359 ià(
	`ngx_h‰p_‹¡_cÚ‹Á_ty³
(
r
, &
mlcf
->
ty³s
è=ð
NULL
) {

360  
NGX_DECLINED
;

364 ià(
ch¬£t
 < 
NGX_HTTP_CHARSET_VAR
) {

365 
mcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

366 
ch¬£ts
 = 
mcf
->ch¬£ts.
–ts
;

367 *
Çme
 = 
ch¬£ts
[
ch¬£t
].name;

368  
ch¬£t
;

371 
vv
 = 
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
r
, 
ch¬£t
 - 
NGX_HTTP_CHARSET_VAR
);

373 ià(
vv
 =ð
NULL
 || vv->
nÙ_found
) {

374  
NGX_ERROR
;

377 
Çme
->
Ën
 = 
vv
->len;

378 
Çme
->
d©a
 = 
vv
->data;

380  
	`ngx_h‰p_g‘_ch¬£t
(
r
, 
Çme
);

381 
	}
}

384 
ngx_št_t


385 
	$ngx_h‰p_maš_»que¡_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
¤c
)

387 
ngx_št_t
 
ch¬£t
;

388 
ngx_¡r_t
 *
maš_ch¬£t
;

389 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
;

391 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
->
maš
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

393 ià(
ùx
) {

394 *
¤c
 = 
ùx
->
ch¬£t_Çme
;

395  
ùx
->
ch¬£t
;

398 
maš_ch¬£t
 = &
r
->
maš
->
h—d”s_out
.
ch¬£t
;

400 ià(
maš_ch¬£t
->
Ën
 == 0) {

401  
NGX_DECLINED
;

404 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_ch¬£t_ùx_t
));

405 ià(
ùx
 =ð
NULL
) {

406  
NGX_ERROR
;

409 
	`ngx_h‰p_£t_ùx
(
r
->
maš
, 
ùx
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

411 
ch¬£t
 = 
	`ngx_h‰p_g‘_ch¬£t
(
r
, 
maš_ch¬£t
);

413 
ùx
->
ch¬£t
 = charset;

414 
ùx
->
ch¬£t_Çme
 = *
maš_ch¬£t
;

415 *
¤c
 = *
maš_ch¬£t
;

417  
ch¬£t
;

418 
	}
}

421 
ngx_št_t


422 
	$ngx_h‰p_sourû_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
Çme
)

424 
ngx_št_t
 
ch¬£t
;

425 
ngx_h‰p_ch¬£t_t
 *
ch¬£ts
;

426 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

427 
ngx_h‰p_ch¬£t_loc_cÚf_t
 *
lcf
;

428 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
;

430 ià(
r
->
h—d”s_out
.
ch¬£t
.
Ën
) {

431 *
Çme
 = 
r
->
h—d”s_out
.
ch¬£t
;

432  
	`ngx_h‰p_g‘_ch¬£t
(
r
, 
Çme
);

435 
lcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

437 
ch¬£t
 = 
lcf
->
sourû_ch¬£t
;

439 ià(
ch¬£t
 =ð
NGX_HTTP_CHARSET_OFF
) {

440 
Çme
->
Ën
 = 0;

441  
ch¬£t
;

444 ià(
ch¬£t
 < 
NGX_HTTP_CHARSET_VAR
) {

445 
mcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

446 
ch¬£ts
 = 
mcf
->ch¬£ts.
–ts
;

447 *
Çme
 = 
ch¬£ts
[
ch¬£t
].name;

448  
ch¬£t
;

451 
vv
 = 
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
r
, 
ch¬£t
 - 
NGX_HTTP_CHARSET_VAR
);

453 ià(
vv
 =ð
NULL
 || vv->
nÙ_found
) {

454  
NGX_ERROR
;

457 
Çme
->
Ën
 = 
vv
->len;

458 
Çme
->
d©a
 = 
vv
->data;

460  
	`ngx_h‰p_g‘_ch¬£t
(
r
, 
Çme
);

461 
	}
}

464 
ngx_št_t


465 
	$ngx_h‰p_g‘_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
Çme
)

467 
ngx_ušt_t
 
i
, 
n
;

468 
ngx_h‰p_ch¬£t_t
 *
ch¬£t
;

469 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
;

471 
mcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

473 
ch¬£t
 = 
mcf
->
ch¬£ts
.
–ts
;

474 
n
 = 
mcf
->
ch¬£ts
.
ÃÉs
;

476 
i
 = 0; i < 
n
; i++) {

477 ià(
ch¬£t
[
i
].
Çme
.
Ën
 !=‚ame->len) {

481 ià(
	`ngx_¡ºÿ£cmp
(
ch¬£t
[
i
].
Çme
.
d©a
,‚ame->d©a,‚ame->
Ën
) == 0) {

482  
i
;

486  
NGX_HTTP_NO_CHARSET
;

487 
	}
}

490 
ngx_šlše
 

491 
	$ngx_h‰p_£t_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
ch¬£t
)

493 ià(
r
 !ðr->
maš
) {

497 ià(
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_MOVED_PERMANENTLY


498 || 
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_MOVED_TEMPORARILY
)

505 
r
->
h—d”s_out
.
ch¬£t
.
Ën
 = 0;

509 
r
->
h—d”s_out
.
ch¬£t
 = *charset;

510 
	}
}

513 
ngx_št_t


514 
	$ngx_h‰p_ch¬£t_ùx
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ch¬£t_t
 *
ch¬£ts
,

515 
ngx_št_t
 
ch¬£t
,‚gx_št_ˆ
sourû_ch¬£t
)

517 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
;

519 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_ch¬£t_ùx_t
));

520 ià(
ùx
 =ð
NULL
) {

521  
NGX_ERROR
;

524 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

526 
ùx
->
bË
 = 
ch¬£ts
[
sourû_ch¬£t
].
bËs
[
ch¬£t
];

527 
ùx
->
ch¬£t
 = charset;

528 
ùx
->
ch¬£t_Çme
 = 
ch¬£ts
[
ch¬£t
].
Çme
;

529 
ùx
->
Ëngth
 = 
ch¬£ts
[
ch¬£t
].length;

530 
ùx
->
äom_utf8
 = 
ch¬£ts
[
sourû_ch¬£t
].
utf8
;

531 
ùx
->
to_utf8
 = 
ch¬£ts
[
ch¬£t
].
utf8
;

533 
r
->
fž‹r_Ãed_š_memÜy
 = 1;

535 ià((
ùx
->
to_utf8
 || ctx->
äom_utf8
è&& 
r
 =ðr->
maš
) {

536 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
r
);

539 
r
->
fž‹r_Ãed_‹mpÜ¬y
 = 1;

542  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

543 
	}
}

546 
ngx_št_t


547 
	$ngx_h‰p_ch¬£t_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

549 
ngx_št_t
 
rc
;

550 
ngx_buf_t
 *
b
;

551 
ngx_chaš_t
 *
þ
, *
out
, **
Î
;

552 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
;

554 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

556 ià(
ùx
 =ð
NULL
 || ctx->
bË
 == NULL) {

557  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

560 ià((
ùx
->
to_utf8
 || ctx->
äom_utf8
è|| ctx->
busy
) {

562 
out
 = 
NULL
;

563 
Î
 = &
out
;

565 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

566 
b
 = 
þ
->
buf
;

568 ià(
	`ngx_buf_size
(
b
) == 0) {

570 *
Î
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

571 ià(*
Î
 =ð
NULL
) {

572  
NGX_ERROR
;

575 (*
Î
)->
buf
 = 
b
;

576 (*
Î
)->
Ãxt
 = 
NULL
;

578 
Î
 = &(*Î)->
Ãxt
;

583 ià(
ùx
->
to_utf8
) {

584 *
Î
 = 
	`ngx_h‰p_ch¬£t_»code_to_utf8
(
r
->
poÞ
, 
b
, 
ùx
);

587 *
Î
 = 
	`ngx_h‰p_ch¬£t_»code_äom_utf8
(
r
->
poÞ
, 
b
, 
ùx
);

590 ià(*
Î
 =ð
NULL
) {

591  
NGX_ERROR
;

594 *
Î
) {

595 
Î
 = &(*Î)->
Ãxt
;

599 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
out
);

601 ià(
out
) {

602 ià(
ùx
->
busy
 =ð
NULL
) {

603 
ùx
->
busy
 = 
out
;

606 
þ
 = 
ùx
->
busy
; cl->
Ãxt
; cl = cl->next) { }

607 
þ
->
Ãxt
 = 
out
;

611 
ùx
->
busy
) {

613 
þ
 = 
ùx
->
busy
;

614 
b
 = 
þ
->
buf
;

616 ià(
	`ngx_buf_size
(
b
) != 0) {

620 
ùx
->
busy
 = 
þ
->
Ãxt
;

622 ià(
b
->
g
 !ð(
ngx_buf_g_t
è&
ngx_h‰p_ch¬£t_fž‹r_moduË
) {

626 ià(
b
->
shadow
) {

627 
b
->
shadow
->
pos
 = b->shadow->
Ï¡
;

630 ià(
b
->
pos
) {

631 
þ
->
Ãxt
 = 
ùx
->
ä“_bufãrs
;

632 
ùx
->
ä“_bufãrs
 = 
þ
;

636 
þ
->
Ãxt
 = 
ùx
->
ä“_bufs
;

637 
ùx
->
ä“_bufs
 = 
þ
;

640  
rc
;

643 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

644 (è
	`ngx_h‰p_ch¬£t_»code
(
þ
->
buf
, 
ùx
->
bË
);

647  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

648 
	}
}

651 
ngx_ušt_t


652 
	$ngx_h‰p_ch¬£t_»code
(
ngx_buf_t
 *
b
, 
u_ch¬
 *
bË
)

654 
u_ch¬
 *
p
, *
Ï¡
;

656 
Ï¡
 = 
b
->last;

658 
p
 = 
b
->
pos
;… < 
Ï¡
;…++) {

660 ià(*
p
 !ð
bË
[*p]) {

661 
»code
;

667 
»code
:

670 ià(*
p
 !ð
bË
[*p]) {

671 *
p
 = 
bË
[*p];

674 
p
++;

676 } 
p
 < 
Ï¡
);

678 
b
->
š_fže
 = 0;

681 
	}
}

684 
ngx_chaš_t
 *

685 
	$ngx_h‰p_ch¬£t_»code_äom_utf8
(
ngx_poÞ_t
 *
poÞ
, 
ngx_buf_t
 *
buf
,

686 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
)

688 
size_t
 
Ën
, 
size
;

689 
u_ch¬
 
c
, *
p
, *
¤c
, *
d¡
, *
§ved
, **
bË
;

690 
ušt32_t
 
n
;

691 
ngx_buf_t
 *
b
;

692 
ngx_ušt_t
 
i
;

693 
ngx_chaš_t
 *
out
, *
þ
, **
Î
;

695 
¤c
 = 
buf
->
pos
;

697 ià(
ùx
->
§ved_Ën
 == 0) {

699  ; 
¤c
 < 
buf
->
Ï¡
; src++) {

701 ià(*
¤c
 < 0x80) {

705 
Ën
 = 
¤c
 - 
buf
->
pos
;

707 ià(
Ën
 > 512) {

708 
out
 = 
	`ngx_h‰p_ch¬£t_g‘_buf
(
poÞ
, 
ùx
);

709 ià(
out
 =ð
NULL
) {

710  
NULL
;

713 
b
 = 
out
->
buf
;

715 
b
->
‹mpÜ¬y
 = 
buf
->temporary;

716 
b
->
memÜy
 = 
buf
->memory;

717 
b
->
mm­
 = 
buf
->mmap;

718 
b
->
æush
 = 
buf
->flush;

720 
b
->
pos
 = 
buf
->pos;

721 
b
->
Ï¡
 = 
¤c
;

723 
out
->
buf
 = 
b
;

724 
out
->
Ãxt
 = 
NULL
;

726 
size
 = 
buf
->
Ï¡
 - 
¤c
;

728 
§ved
 = 
¤c
;

729 
n
 = 
	`ngx_utf8_decode
(&
§ved
, 
size
);

731 ià(
n
 == 0xfffffffe) {

734 
	`ngx_memýy
(
ùx
->
§ved
, 
¤c
, 
size
);

735 
ùx
->
§ved_Ën
 = 
size
;

737 
b
->
shadow
 = 
buf
;

739  
out
;

743 
out
 = 
NULL
;

744 
size
 = 
Ën
 + 
buf
->
Ï¡
 - 
¤c
;

745 
¤c
 = 
buf
->
pos
;

748 ià(
size
 < 
NGX_HTML_ENTITY_LEN
) {

749 
size
 +ð
NGX_HTML_ENTITY_LEN
;

752 
þ
 = 
	`ngx_h‰p_ch¬£t_g‘_bufãr
(
poÞ
, 
ùx
, 
size
);

753 ià(
þ
 =ð
NULL
) {

754  
NULL
;

757 ià(
out
) {

758 
out
->
Ãxt
 = 
þ
;

761 
out
 = 
þ
;

764 
b
 = 
þ
->
buf
;

765 
d¡
 = 
b
->
pos
;

767 
»code
;

770 
out
 = 
	`ngx_®loc_chaš_lšk
(
poÞ
);

771 ià(
out
 =ð
NULL
) {

772  
NULL
;

775 
out
->
buf
 = buf;

776 
out
->
Ãxt
 = 
NULL
;

778  
out
;

783 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
poÞ
->
log
, 0,

784 "h‰°ch¬£ˆutà§ved: %z", 
ùx
->
§ved_Ën
);

786 
p
 = 
¤c
;

788 
i
 = 
ùx
->
§ved_Ën
; i < 
NGX_UTF_LEN
; i++) {

789 
ùx
->
§ved
[
i
] = *
p
++;

791 ià(
p
 =ð
buf
->
Ï¡
) {

796 
§ved
 = 
ùx
->saved;

797 
n
 = 
	`ngx_utf8_decode
(&
§ved
, 
i
);

799 
c
 = '\0';

801 ià(
n
 < 0x10000) {

802 
bË
 = (
u_ch¬
 **è
ùx
->table;

803 
p
 = 
bË
[
n
 >> 8];

805 ià(
p
) {

806 
c
 = 
p
[
n
 & 0xff];

809 } ià(
n
 == 0xfffffffe) {

813 ià(
i
 < 
NGX_UTF_LEN
) {

814 
out
 = 
	`ngx_h‰p_ch¬£t_g‘_buf
(
poÞ
, 
ùx
);

815 ià(
out
 =ð
NULL
) {

816  
NULL
;

819 
b
 = 
out
->
buf
;

821 
b
->
pos
 = 
buf
->pos;

822 
b
->
Ï¡
 = 
buf
->last;

823 
b
->
sync
 = 1;

824 
b
->
shadow
 = 
buf
;

826 
	`ngx_memýy
(&
ùx
->
§ved
[ùx->
§ved_Ën
], 
¤c
, 
i
);

827 
ùx
->
§ved_Ën
 +ð
i
;

829  
out
;

833 
size
 = 
buf
->
Ï¡
 - buf->
pos
;

835 ià(
size
 < 
NGX_HTML_ENTITY_LEN
) {

836 
size
 +ð
NGX_HTML_ENTITY_LEN
;

839 
þ
 = 
	`ngx_h‰p_ch¬£t_g‘_bufãr
(
poÞ
, 
ùx
, 
size
);

840 ià(
þ
 =ð
NULL
) {

841  
NULL
;

844 
out
 = 
þ
;

846 
b
 = 
þ
->
buf
;

847 
d¡
 = 
b
->
pos
;

849 ià(
c
) {

850 *
d¡
++ = 
c
;

852 } ià(
n
 == 0xfffffffe) {

853 *
d¡
++ = '?';

855 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
poÞ
->
log
, 0,

858 
§ved
 = &
ùx
->§ved[
NGX_UTF_LEN
];

860 } ià(
n
 > 0x10ffff) {

861 *
d¡
++ = '?';

863 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
poÞ
->
log
, 0,

867 
d¡
 = 
	`ngx_¥rštf
(d¡, "&#%uD;", 
n
);

870 
¤c
 +ð(
§ved
 - 
ùx
->§vedè- ctx->
§ved_Ën
;

871 
ùx
->
§ved_Ën
 = 0;

873 
»code
:

875 
Î
 = &
þ
->
Ãxt
;

877 
bË
 = (
u_ch¬
 **è
ùx
->table;

879 
¤c
 < 
buf
->
Ï¡
) {

881 ià((
size_t
è(
b
->
’d
 - 
d¡
è< 
NGX_HTML_ENTITY_LEN
) {

882 
b
->
Ï¡
 = 
d¡
;

884 
size
 = 
buf
->
Ï¡
 - 
¤c
 + 
NGX_HTML_ENTITY_LEN
;

886 
þ
 = 
	`ngx_h‰p_ch¬£t_g‘_bufãr
(
poÞ
, 
ùx
, 
size
);

887 ià(
þ
 =ð
NULL
) {

888  
NULL
;

891 *
Î
 = 
þ
;

892 
Î
 = &
þ
->
Ãxt
;

894 
b
 = 
þ
->
buf
;

895 
d¡
 = 
b
->
pos
;

898 ià(*
¤c
 < 0x80) {

899 *
d¡
++ = *
¤c
++;

903 
Ën
 = 
buf
->
Ï¡
 - 
¤c
;

905 
n
 = 
	`ngx_utf8_decode
(&
¤c
, 
Ën
);

907 ià(
n
 < 0x10000) {

909 
p
 = 
bË
[
n
 >> 8];

911 ià(
p
) {

912 
c
 = 
p
[
n
 & 0xff];

914 ià(
c
) {

915 *
d¡
++ = 
c
;

920 
d¡
 = 
	`ngx_¥rštf
(d¡, "&#%uD;", 
n
);

925 ià(
n
 == 0xfffffffe) {

928 
	`ngx_memýy
(
ùx
->
§ved
, 
¤c
, 
Ën
);

929 
ùx
->
§ved_Ën
 = 
Ën
;

931 ià(
b
->
pos
 =ð
d¡
) {

932 
b
->
sync
 = 1;

933 
b
->
‹mpÜ¬y
 = 0;

939 ià(
n
 > 0x10ffff) {

940 *
d¡
++ = '?';

942 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
poÞ
->
log
, 0,

950 
d¡
 = 
	`ngx_¥rštf
(d¡, "&#%uD;", 
n
);

953 
b
->
Ï¡
 = 
d¡
;

955 
b
->
Ï¡_buf
 = 
buf
->last_buf;

956 
b
->
Ï¡_š_chaš
 = 
buf
->last_in_chain;

957 
b
->
æush
 = 
buf
->flush;

959 
b
->
shadow
 = 
buf
;

961  
out
;

962 
	}
}

965 
ngx_chaš_t
 *

966 
	$ngx_h‰p_ch¬£t_»code_to_utf8
(
ngx_poÞ_t
 *
poÞ
, 
ngx_buf_t
 *
buf
,

967 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
)

969 
size_t
 
Ën
, 
size
;

970 
u_ch¬
 *
p
, *
¤c
, *
d¡
, *
bË
;

971 
ngx_buf_t
 *
b
;

972 
ngx_chaš_t
 *
out
, *
þ
, **
Î
;

974 
bË
 = 
ùx
->table;

976 
¤c
 = 
buf
->
pos
; srø< buf->
Ï¡
; src++) {

977 ià(
bË
[*
¤c
 * 
NGX_UTF_LEN
] == '\1') {

981 
»code
;

984 
out
 = 
	`ngx_®loc_chaš_lšk
(
poÞ
);

985 ià(
out
 =ð
NULL
) {

986  
NULL
;

989 
out
->
buf
 = buf;

990 
out
->
Ãxt
 = 
NULL
;

992  
out
;

994 
»code
:

1001 
Ën
 = 
¤c
 - 
buf
->
pos
;

1003 ià(
Ën
 > 512) {

1004 
out
 = 
	`ngx_h‰p_ch¬£t_g‘_buf
(
poÞ
, 
ùx
);

1005 ià(
out
 =ð
NULL
) {

1006  
NULL
;

1009 
b
 = 
out
->
buf
;

1011 
b
->
‹mpÜ¬y
 = 
buf
->temporary;

1012 
b
->
memÜy
 = 
buf
->memory;

1013 
b
->
mm­
 = 
buf
->mmap;

1014 
b
->
æush
 = 
buf
->flush;

1016 
b
->
pos
 = 
buf
->pos;

1017 
b
->
Ï¡
 = 
¤c
;

1019 
out
->
buf
 = 
b
;

1020 
out
->
Ãxt
 = 
NULL
;

1022 
size
 = 
buf
->
Ï¡
 - 
¤c
;

1023 
size
 = siz/ 2 + siz/ 2 * 
ùx
->
Ëngth
;

1026 
out
 = 
NULL
;

1028 
size
 = 
buf
->
Ï¡
 - 
¤c
;

1029 
size
 = 
Ën
 + siz/ 2 + siz/ 2 * 
ùx
->
Ëngth
;

1031 
¤c
 = 
buf
->
pos
;

1034 
þ
 = 
	`ngx_h‰p_ch¬£t_g‘_bufãr
(
poÞ
, 
ùx
, 
size
);

1035 ià(
þ
 =ð
NULL
) {

1036  
NULL
;

1039 ià(
out
) {

1040 
out
->
Ãxt
 = 
þ
;

1043 
out
 = 
þ
;

1046 
Î
 = &
þ
->
Ãxt
;

1048 
b
 = 
þ
->
buf
;

1049 
d¡
 = 
b
->
pos
;

1051 
¤c
 < 
buf
->
Ï¡
) {

1053 
p
 = &
bË
[*
¤c
++ * 
NGX_UTF_LEN
];

1054 
Ën
 = *
p
++;

1056 ià((
size_t
è(
b
->
’d
 - 
d¡
è< 
Ën
) {

1057 
b
->
Ï¡
 = 
d¡
;

1059 
size
 = 
buf
->
Ï¡
 - 
¤c
;

1060 
size
 = 
Ën
 + siz/ 2 + siz/ 2 * 
ùx
->
Ëngth
;

1062 
þ
 = 
	`ngx_h‰p_ch¬£t_g‘_bufãr
(
poÞ
, 
ùx
, 
size
);

1063 ià(
þ
 =ð
NULL
) {

1064  
NULL
;

1067 *
Î
 = 
þ
;

1068 
Î
 = &
þ
->
Ãxt
;

1070 
b
 = 
þ
->
buf
;

1071 
d¡
 = 
b
->
pos
;

1074 
Ën
) {

1075 *
d¡
++ = *
p
++;

1076 
Ën
--;

1080 
b
->
Ï¡
 = 
d¡
;

1082 
b
->
Ï¡_buf
 = 
buf
->last_buf;

1083 
b
->
Ï¡_š_chaš
 = 
buf
->last_in_chain;

1084 
b
->
æush
 = 
buf
->flush;

1086 
b
->
shadow
 = 
buf
;

1088  
out
;

1089 
	}
}

1092 
ngx_chaš_t
 *

1093 
	$ngx_h‰p_ch¬£t_g‘_buf
(
ngx_poÞ_t
 *
poÞ
, 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
)

1095 
ngx_chaš_t
 *
þ
;

1097 
þ
 = 
ùx
->
ä“_bufs
;

1099 ià(
þ
) {

1100 
ùx
->
ä“_bufs
 = 
þ
->
Ãxt
;

1102 
þ
->
buf
->
shadow
 = 
NULL
;

1103 
þ
->
Ãxt
 = 
NULL
;

1105  
þ
;

1108 
þ
 = 
	`ngx_®loc_chaš_lšk
(
poÞ
);

1109 ià(
þ
 =ð
NULL
) {

1110  
NULL
;

1113 
þ
->
buf
 = 
	`ngx_ÿÎoc_buf
(
poÞ
);

1114 ià(
þ
->
buf
 =ð
NULL
) {

1115  
NULL
;

1118 
þ
->
Ãxt
 = 
NULL
;

1120 
þ
->
buf
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_ch¬£t_fž‹r_moduË
;

1122  
þ
;

1123 
	}
}

1126 
ngx_chaš_t
 *

1127 
	$ngx_h‰p_ch¬£t_g‘_bufãr
(
ngx_poÞ_t
 *
poÞ
, 
ngx_h‰p_ch¬£t_ùx_t
 *
ùx
,

1128 
size_t
 
size
)

1130 
ngx_buf_t
 *
b
;

1131 
ngx_chaš_t
 *
þ
, **
Î
;

1133 
Î
 = &
ùx
->
ä“_bufãrs
, 
þ
 = ctx->free_buffers;

1134 
þ
;

1135 
Î
 = &
þ
->
Ãxt
, cl = cl->next)

1137 
b
 = 
þ
->
buf
;

1139 ià((
size_t
è(
b
->
’d
 - b->
¡¬t
è>ð
size
) {

1140 *
Î
 = 
þ
->
Ãxt
;

1141 
þ
->
Ãxt
 = 
NULL
;

1143 
b
->
pos
 = b->
¡¬t
;

1144 
b
->
‹mpÜ¬y
 = 1;

1145 
b
->
shadow
 = 
NULL
;

1147  
þ
;

1151 
þ
 = 
	`ngx_®loc_chaš_lšk
(
poÞ
);

1152 ià(
þ
 =ð
NULL
) {

1153  
NULL
;

1156 
þ
->
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
poÞ
, 
size
);

1157 ià(
þ
->
buf
 =ð
NULL
) {

1158  
NULL
;

1161 
þ
->
Ãxt
 = 
NULL
;

1163 
þ
->
buf
->
‹mpÜ¬y
 = 1;

1164 
þ
->
buf
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_ch¬£t_fž‹r_moduË
;

1166  
þ
;

1167 
	}
}

1171 
	$ngx_h‰p_ch¬£t_m­_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1173 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
 = 
cÚf
;

1175 *
rv
;

1176 
u_ch¬
 *
p
, *
d¡2¤c
, **
µ
;

1177 
ngx_št_t
 
¤c
, 
d¡
;

1178 
ngx_ušt_t
 
i
, 
n
;

1179 
ngx_¡r_t
 *
v®ue
;

1180 
ngx_cÚf_t
 
pvcf
;

1181 
ngx_h‰p_ch¬£t_t
 *
ch¬£t
;

1182 
ngx_h‰p_ch¬£t_bËs_t
 *
bË
;

1183 
ngx_h‰p_ch¬£t_cÚf_ùx_t
 
ùx
;

1185 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1187 
¤c
 = 
	`ngx_h‰p_add_ch¬£t
(&
mcf
->
ch¬£ts
, &
v®ue
[1]);

1188 ià(
¤c
 =ð
NGX_ERROR
) {

1189  
NGX_CONF_ERROR
;

1192 
d¡
 = 
	`ngx_h‰p_add_ch¬£t
(&
mcf
->
ch¬£ts
, &
v®ue
[2]);

1193 ià(
d¡
 =ð
NGX_ERROR
) {

1194  
NGX_CONF_ERROR
;

1197 ià(
¤c
 =ð
d¡
) {

1198 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1200 "\"%V\"‡nd \"%V\"", &
v®ue
[1], &value[2]);

1201  
NGX_CONF_ERROR
;

1204 
bË
 = 
mcf
->
bËs
.
–ts
;

1205 
i
 = 0; i < 
mcf
->
bËs
.
ÃÉs
; i++) {

1206 ià((
¤c
 =ð
bË
->¤ø&& 
d¡
 ==able->dst)

1207 || (
¤c
 =ð
bË
->
d¡
 && dst ==able->src))

1209 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1211 "\"%V\"‡nd \"%V\"", &
v®ue
[1], &value[2]);

1212  
NGX_CONF_ERROR
;

1216 
bË
 = 
	`ngx_¬¿y_push
(&
mcf
->
bËs
);

1217 ià(
bË
 =ð
NULL
) {

1218  
NGX_CONF_ERROR
;

1221 
bË
->
¤c
 = src;

1222 
bË
->
d¡
 = dst;

1224 ià(
	`ngx_¡rÿ£cmp
(
v®ue
[2].
d©a
, (
u_ch¬
 *) "utf-8") == 0) {

1225 
bË
->
¤c2d¡
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, 256 * 
NGX_UTF_LEN
);

1226 ià(
bË
->
¤c2d¡
 =ð
NULL
) {

1227  
NGX_CONF_ERROR
;

1230 
bË
->
d¡2¤c
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, 256 * (*));

1231 ià(
bË
->
d¡2¤c
 =ð
NULL
) {

1232  
NGX_CONF_ERROR
;

1235 
d¡2¤c
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, 256);

1236 ià(
d¡2¤c
 =ð
NULL
) {

1237  
NGX_CONF_ERROR
;

1240 
µ
 = (
u_ch¬
 **è&
bË
->
d¡2¤c
[0];

1241 
µ
[0] = 
d¡2¤c
;

1243 
i
 = 0; i < 128; i++) {

1244 
p
 = &
bË
->
¤c2d¡
[
i
 * 
NGX_UTF_LEN
];

1245 
p
[0] = '\1';

1246 
p
[1] = (
u_ch¬
è
i
;

1247 
d¡2¤c
[
i
] = (
u_ch¬
) i;

1250  ; 
i
 < 256; i++) {

1251 
p
 = &
bË
->
¤c2d¡
[
i
 * 
NGX_UTF_LEN
];

1252 
p
[0] = '\1';

1253 
p
[1] = '?';

1257 
bË
->
¤c2d¡
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, 256);

1258 ià(
bË
->
¤c2d¡
 =ð
NULL
) {

1259  
NGX_CONF_ERROR
;

1262 
bË
->
d¡2¤c
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, 256);

1263 ià(
bË
->
d¡2¤c
 =ð
NULL
) {

1264  
NGX_CONF_ERROR
;

1267 
i
 = 0; i < 128; i++) {

1268 
bË
->
¤c2d¡
[
i
] = (
u_ch¬
) i;

1269 
bË
->
d¡2¤c
[
i
] = (
u_ch¬
) i;

1272  ; 
i
 < 256; i++) {

1273 
bË
->
¤c2d¡
[
i
] = '?';

1274 
bË
->
d¡2¤c
[
i
] = '?';

1278 
ch¬£t
 = 
mcf
->
ch¬£ts
.
–ts
;

1280 
ùx
.
bË
 =able;

1281 
ùx
.
ch¬£t
 = &ch¬£t[
d¡
];

1282 
ùx
.
ch¬aù”s
 = 0;

1284 
pvcf
 = *
cf
;

1285 
cf
->
ùx
 = &ctx;

1286 
cf
->
hªdËr
 = 
ngx_h‰p_ch¬£t_m­
;

1287 
cf
->
hªdËr_cÚf
 = 
cÚf
;

1289 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

1291 *
cf
 = 
pvcf
;

1293 ià(
ùx
.
ch¬aù”s
) {

1294 
n
 = 
ùx
.
ch¬£t
->
Ëngth
;

1295 
ùx
.
ch¬£t
->
Ëngth
 /ðùx.
ch¬aù”s
;

1297 ià(((
n
 * 10è/ 
ùx
.
ch¬aù”s
) % 10 > 4) {

1298 
ùx
.
ch¬£t
->
Ëngth
++;

1302  
rv
;

1303 
	}
}

1307 
	$ngx_h‰p_ch¬£t_m­
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
, *
cÚf
)

1309 
u_ch¬
 *
p
, *
d¡2¤c
, **
µ
;

1310 
ušt32_t
 
n
;

1311 
ngx_št_t
 
¤c
, 
d¡
;

1312 
ngx_¡r_t
 *
v®ue
;

1313 
ngx_ušt_t
 
i
;

1314 
ngx_h‰p_ch¬£t_bËs_t
 *
bË
;

1315 
ngx_h‰p_ch¬£t_cÚf_ùx_t
 *
ùx
;

1317 ià(
cf
->
¬gs
->
ÃÉs
 != 2) {

1318 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "invalid…arameters‚umber");

1319  
NGX_CONF_ERROR
;

1322 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1324 
¤c
 = 
	`ngx_hextoi
(
v®ue
[0].
d©a
, v®ue[0].
Ën
);

1325 ià(
¤c
 =ð
NGX_ERROR
 || src > 255) {

1326 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1327 "šv®id v®u\"%V\"", &
v®ue
[0]);

1328  
NGX_CONF_ERROR
;

1331 
ùx
 = 
cf
->ctx;

1332 
bË
 = 
ùx
->table;

1334 ià(
ùx
->
ch¬£t
->
utf8
) {

1335 
p
 = &
bË
->
¤c2d¡
[
¤c
 * 
NGX_UTF_LEN
];

1337 *
p
++ = (
u_ch¬
è(
v®ue
[1].
Ën
 / 2);

1339 
i
 = 0; i < 
v®ue
[1].
Ën
; i += 2) {

1340 
d¡
 = 
	`ngx_hextoi
(&
v®ue
[1].
d©a
[
i
], 2);

1341 ià(
d¡
 =ð
NGX_ERROR
 || dst > 255) {

1342 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1343 "šv®id v®u\"%V\"", &
v®ue
[1]);

1344  
NGX_CONF_ERROR
;

1347 *
p
++ = (
u_ch¬
è
d¡
;

1350 
i
 /= 2;

1352 
ùx
->
ch¬£t
->
Ëngth
 +ð
i
;

1353 
ùx
->
ch¬aù”s
++;

1355 
p
 = &
bË
->
¤c2d¡
[
¤c
 * 
NGX_UTF_LEN
] + 1;

1357 
n
 = 
	`ngx_utf8_decode
(&
p
, 
i
);

1359 ià(
n
 > 0xffff) {

1360 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1361 "šv®id v®u\"%V\"", &
v®ue
[1]);

1362  
NGX_CONF_ERROR
;

1365 
µ
 = (
u_ch¬
 **è&
bË
->
d¡2¤c
[0];

1367 
d¡2¤c
 = 
µ
[
n
 >> 8];

1369 ià(
d¡2¤c
 =ð
NULL
) {

1370 
d¡2¤c
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, 256);

1371 ià(
d¡2¤c
 =ð
NULL
) {

1372  
NGX_CONF_ERROR
;

1375 
µ
[
n
 >> 8] = 
d¡2¤c
;

1378 
d¡2¤c
[
n
 & 0xff] = (
u_ch¬
è
¤c
;

1381 
d¡
 = 
	`ngx_hextoi
(
v®ue
[1].
d©a
, v®ue[1].
Ën
);

1382 ià(
d¡
 =ð
NGX_ERROR
 || dst > 255) {

1383 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1384 "šv®id v®u\"%V\"", &
v®ue
[1]);

1385  
NGX_CONF_ERROR
;

1388 
bË
->
¤c2d¡
[
¤c
] = (
u_ch¬
è
d¡
;

1389 
bË
->
d¡2¤c
[
d¡
] = (
u_ch¬
è
¤c
;

1392  
NGX_CONF_OK
;

1393 
	}
}

1397 
	$ngx_h‰p_£t_ch¬£t_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1399 *
p
 = 
cÚf
;

1401 
ngx_št_t
 *
ý
;

1402 
ngx_¡r_t
 *
v®ue
, 
v¬
;

1403 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
;

1405 
ý
 = (
ngx_št_t
 *è(
p
 + 
cmd
->
off£t
);

1407 ià(*
ý
 !ð
NGX_CONF_UNSET
) {

1411 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1413 ià(
cmd
->
off£t
 =ð
	`off£tof
(
ngx_h‰p_ch¬£t_loc_cÚf_t
, 
ch¬£t
)

1414 && 
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0)

1416 *
ý
 = 
NGX_HTTP_CHARSET_OFF
;

1417  
NGX_CONF_OK
;

1421 ià(
v®ue
[1].
d©a
[0] == '$') {

1422 
v¬
.
Ën
 = 
v®ue
[1].len - 1;

1423 
v¬
.
d©a
 = 
v®ue
[1].data + 1;

1425 *
ý
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, &
v¬
);

1427 ià(*
ý
 =ð
NGX_ERROR
) {

1428  
NGX_CONF_ERROR
;

1431 *
ý
 +ð
NGX_HTTP_CHARSET_VAR
;

1433  
NGX_CONF_OK
;

1436 
mcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
,

1437 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

1439 *
ý
 = 
	`ngx_h‰p_add_ch¬£t
(&
mcf
->
ch¬£ts
, &
v®ue
[1]);

1440 ià(*
ý
 =ð
NGX_ERROR
) {

1441  
NGX_CONF_ERROR
;

1444  
NGX_CONF_OK
;

1445 
	}
}

1448 
ngx_št_t


1449 
	$ngx_h‰p_add_ch¬£t
(
ngx_¬¿y_t
 *
ch¬£ts
, 
ngx_¡r_t
 *
Çme
)

1451 
ngx_ušt_t
 
i
;

1452 
ngx_h‰p_ch¬£t_t
 *
c
;

1454 
c
 = 
ch¬£ts
->
–ts
;

1455 
i
 = 0; i < 
ch¬£ts
->
ÃÉs
; i++) {

1456 ià(
Çme
->
Ën
 !ð
c
[
i
].name.len) {

1460 ià(
	`ngx_¡rÿ£cmp
(
Çme
->
d©a
, 
c
[
i
].name.data) == 0) {

1465 ià(
i
 < 
ch¬£ts
->
ÃÉs
) {

1466  
i
;

1469 
c
 = 
	`ngx_¬¿y_push
(
ch¬£ts
);

1470 ià(
c
 =ð
NULL
) {

1471  
NGX_ERROR
;

1474 
c
->
bËs
 = 
NULL
;

1475 
c
->
Çme
 = *name;

1476 
c
->
Ëngth
 = 0;

1478 ià(
	`ngx_¡rÿ£cmp
(
Çme
->
d©a
, (
u_ch¬
 *) "utf-8") == 0) {

1479 
c
->
utf8
 = 1;

1482 
c
->
utf8
 = 0;

1485  
i
;

1486 
	}
}

1490 
	$ngx_h‰p_ch¬£t_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

1492 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
;

1494 
mcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_ch¬£t_maš_cÚf_t
));

1495 ià(
mcf
 =ð
NULL
) {

1496  
NULL
;

1499 ià(
	`ngx_¬¿y_š™
(&
mcf
->
ch¬£ts
, 
cf
->
poÞ
, 2, (
ngx_h‰p_ch¬£t_t
))

1500 !ð
NGX_OK
)

1502  
NULL
;

1505 ià(
	`ngx_¬¿y_š™
(&
mcf
->
bËs
, 
cf
->
poÞ
, 1,

1506 (
ngx_h‰p_ch¬£t_bËs_t
))

1507 !ð
NGX_OK
)

1509  
NULL
;

1512 ià(
	`ngx_¬¿y_š™
(&
mcf
->
»codes
, 
cf
->
poÞ
, 2,

1513 (
ngx_h‰p_ch¬£t_»code_t
))

1514 !ð
NGX_OK
)

1516  
NULL
;

1519  
mcf
;

1520 
	}
}

1524 
	$ngx_h‰p_ch¬£t_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

1526 
ngx_h‰p_ch¬£t_loc_cÚf_t
 *
lcf
;

1528 
lcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_ch¬£t_loc_cÚf_t
));

1529 ià(
lcf
 =ð
NULL
) {

1530  
NULL
;

1540 
lcf
->
ch¬£t
 = 
NGX_CONF_UNSET
;

1541 
lcf
->
sourû_ch¬£t
 = 
NGX_CONF_UNSET
;

1542 
lcf
->
ov”ride_ch¬£t
 = 
NGX_CONF_UNSET
;

1544  
lcf
;

1545 
	}
}

1549 
	$ngx_h‰p_ch¬£t_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1551 
ngx_h‰p_ch¬£t_loc_cÚf_t
 *
´ev
 = 
·»Á
;

1552 
ngx_h‰p_ch¬£t_loc_cÚf_t
 *
cÚf
 = 
chžd
;

1554 
ngx_ušt_t
 
i
;

1555 
ngx_h‰p_ch¬£t_»code_t
 *
»code
;

1556 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
;

1558 ià(
	`ngx_h‰p_m”ge_ty³s
(
cf
, &
cÚf
->
ty³s_keys
, &cÚf->
ty³s
,

1559 &
´ev
->
ty³s_keys
, &´ev->
ty³s
,

1560 
ngx_h‰p_ch¬£t_deçuÉ_ty³s
)

1561 !ð
NGX_OK
)

1563  
NGX_CONF_ERROR
;

1566 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
ov”ride_ch¬£t
, 
´ev
->override_charset, 0);

1567 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
ch¬£t
, 
´ev
->ch¬£t, 
NGX_HTTP_CHARSET_OFF
);

1568 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
sourû_ch¬£t
, 
´ev
->source_charset,

1569 
NGX_HTTP_CHARSET_OFF
);

1571 ià(
cÚf
->
ch¬£t
 =ð
NGX_HTTP_CHARSET_OFF


1572 || 
cÚf
->
sourû_ch¬£t
 =ð
NGX_HTTP_CHARSET_OFF


1573 || 
cÚf
->
ch¬£t
 =ðcÚf->
sourû_ch¬£t
)

1575  
NGX_CONF_OK
;

1578 ià(
cÚf
->
sourû_ch¬£t
 >ð
NGX_HTTP_CHARSET_VAR


1579 || 
cÚf
->
ch¬£t
 >ð
NGX_HTTP_CHARSET_VAR
)

1581  
NGX_CONF_OK
;

1584 
mcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
,

1585 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

1586 
»code
 = 
mcf
->
»codes
.
–ts
;

1587 
i
 = 0; i < 
mcf
->
»codes
.
ÃÉs
; i++) {

1588 ià(
cÚf
->
sourû_ch¬£t
 =ð
»code
[
i
].
¤c


1589 && 
cÚf
->
ch¬£t
 =ð
»code
[
i
].
d¡
)

1591  
NGX_CONF_OK
;

1595 
»code
 = 
	`ngx_¬¿y_push
(&
mcf
->
»codes
);

1596 ià(
»code
 =ð
NULL
) {

1597  
NGX_CONF_ERROR
;

1600 
»code
->
¤c
 = 
cÚf
->
sourû_ch¬£t
;

1601 
»code
->
d¡
 = 
cÚf
->
ch¬£t
;

1603  
NGX_CONF_OK
;

1604 
	}
}

1607 
ngx_št_t


1608 
	$ngx_h‰p_ch¬£t_po¡cÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
)

1610 
u_ch¬
 **
¤c
, **
d¡
;

1611 
ngx_št_t
 
c
;

1612 
ngx_ušt_t
 
i
, 
t
;

1613 
ngx_h‰p_ch¬£t_t
 *
ch¬£t
;

1614 
ngx_h‰p_ch¬£t_»code_t
 *
»code
;

1615 
ngx_h‰p_ch¬£t_bËs_t
 *
bËs
;

1616 
ngx_h‰p_ch¬£t_maš_cÚf_t
 *
mcf
;

1618 
mcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
,

1619 
ngx_h‰p_ch¬£t_fž‹r_moduË
);

1621 
»code
 = 
mcf
->
»codes
.
–ts
;

1622 
bËs
 = 
mcf
->bËs.
–ts
;

1623 
ch¬£t
 = 
mcf
->
ch¬£ts
.
–ts
;

1625 
i
 = 0; i < 
mcf
->
»codes
.
ÃÉs
; i++) {

1627 
c
 = 
»code
[
i
].
¤c
;

1629 
t
 = 0; < 
mcf
->
bËs
.
ÃÉs
;++) {

1631 ià(
c
 =ð
bËs
[
t
].
¤c
 && 
»code
[
i
].
d¡
 ==ables[t].dst) {

1632 
Ãxt
;

1635 ià(
c
 =ð
bËs
[
t
].
d¡
 && 
»code
[
i
].d¡ =ðbËs[t].
¤c
) {

1636 
Ãxt
;

1640 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

1642 &
ch¬£t
[
c
].
Çme
, &ch¬£t[
»code
[
i
].
d¡
].name);

1643  
NGX_ERROR
;

1645 
Ãxt
:

1650 
t
 = 0; < 
mcf
->
bËs
.
ÃÉs
;++) {

1652 
¤c
 = 
ch¬£t
[
bËs
[
t
].src].tables;

1654 ià(
¤c
 =ð
NULL
) {

1655 
¤c
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
u_ch¬
 *è* 
mcf
->
ch¬£ts
.
ÃÉs
);

1656 ià(
¤c
 =ð
NULL
) {

1657  
NGX_ERROR
;

1660 
ch¬£t
[
bËs
[
t
].
¤c
].tables = src;

1663 
d¡
 = 
ch¬£t
[
bËs
[
t
].dst].tables;

1665 ià(
d¡
 =ð
NULL
) {

1666 
d¡
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
u_ch¬
 *è* 
mcf
->
ch¬£ts
.
ÃÉs
);

1667 ià(
d¡
 =ð
NULL
) {

1668  
NGX_ERROR
;

1671 
ch¬£t
[
bËs
[
t
].
d¡
].tables = dst;

1674 
¤c
[
bËs
[
t
].
d¡
] =abËs[t].
¤c2d¡
;

1675 
d¡
[
bËs
[
t
].
¤c
] =abËs[t].
d¡2¤c
;

1678 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

1679 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_ch¬£t_h—d”_fž‹r
;

1681 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

1682 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_ch¬£t_body_fž‹r
;

1684  
NGX_OK
;

1685 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_chunked_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_chaš_t
 *
	mä“
;

15 
ngx_chaš_t
 *
	mbusy
;

16 } 
	tngx_h‰p_chunked_fž‹r_ùx_t
;

19 
ngx_št_t
 
ngx_h‰p_chunked_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

22 
ngx_h‰p_moduË_t
 
	gngx_h‰p_chunked_fž‹r_moduË_ùx
 = {

23 
NULL
,

24 
ngx_h‰p_chunked_fž‹r_š™
,

26 
NULL
,

27 
NULL
,

29 
NULL
,

30 
NULL
,

32 
NULL
,

33 
NULL


37 
ngx_moduË_t
 
	gngx_h‰p_chunked_fž‹r_moduË
 = {

38 
NGX_MODULE_V1
,

39 &
ngx_h‰p_chunked_fž‹r_moduË_ùx
,

40 
NULL
,

41 
NGX_HTTP_MODULE
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NGX_MODULE_V1_PADDING


53 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

54 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

57 
ngx_št_t


58 
	$ngx_h‰p_chunked_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

60 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

61 
ngx_h‰p_chunked_fž‹r_ùx_t
 *
ùx
;

63 ià(
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_NOT_MODIFIED


64 || 
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_NO_CONTENT


65 || 
r
->
h—d”s_out
.
¡©us
 < 
NGX_HTTP_OK


66 || 
r
 !ðr->
maš


67 || (
r
->
m‘hod
 & 
NGX_HTTP_HEAD
))

69  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

72 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 == -1) {

73 ià(
r
->
h‰p_v”siÚ
 < 
NGX_HTTP_VERSION_11
) {

74 
r
->
k“·live
 = 0;

77 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

79 ià(
þcf
->
chunked_Œªsãr_’codšg
) {

80 
r
->
chunked
 = 1;

82 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
,

83 (
ngx_h‰p_chunked_fž‹r_ùx_t
));

84 ià(
ùx
 =ð
NULL
) {

85  
NGX_ERROR
;

88 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_chunked_fž‹r_moduË
);

91 
r
->
k“·live
 = 0;

96  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

97 
	}
}

100 
ngx_št_t


101 
	$ngx_h‰p_chunked_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

103 
u_ch¬
 *
chunk
;

104 
off_t
 
size
;

105 
ngx_št_t
 
rc
;

106 
ngx_buf_t
 *
b
;

107 
ngx_chaš_t
 *
out
, *
þ
, *
Ž
, **
Î
;

108 
ngx_h‰p_chunked_fž‹r_ùx_t
 *
ùx
;

110 ià(
š
 =ð
NULL
 || !
r
->
chunked
 ||„->
h—d”_Úly
) {

111  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

114 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_chunked_fž‹r_moduË
);

116 
out
 = 
NULL
;

117 
Î
 = &
out
;

119 
size
 = 0;

120 
þ
 = 
š
;

123 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

124 "h‰°chunk: %d", 
	`ngx_buf_size
(
þ
->
buf
));

126 
size
 +ð
	`ngx_buf_size
(
þ
->
buf
);

128 ià(
þ
->
buf
->
æush


129 || 
þ
->
buf
->
sync


130 || 
	`ngx_buf_š_memÜy
(
þ
->
buf
)

131 || 
þ
->
buf
->
š_fže
)

133 
Ž
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

134 ià(
Ž
 =ð
NULL
) {

135  
NGX_ERROR
;

138 
Ž
->
buf
 = 
þ
->buf;

139 *
Î
 = 
Ž
;

140 
Î
 = &
Ž
->
Ãxt
;

143 ià(
þ
->
Ãxt
 =ð
NULL
) {

147 
þ
 = cl->
Ãxt
;

150 ià(
size
) {

151 
Ž
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
ùx
->
ä“
);

152 ià(
Ž
 =ð
NULL
) {

153  
NGX_ERROR
;

156 
b
 = 
Ž
->
buf
;

157 
chunk
 = 
b
->
¡¬t
;

159 ià(
chunk
 =ð
NULL
) {

162 
chunk
 = 
	`ngx_·Îoc
(
r
->
poÞ
, ("0000000000000000" 
CRLF
) - 1);

163 ià(
chunk
 =ð
NULL
) {

164  
NGX_ERROR
;

167 
b
->
¡¬t
 = 
chunk
;

168 
b
->
’d
 = 
chunk
 + ("0000000000000000" 
CRLF
) - 1;

171 
b
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_chunked_fž‹r_moduË
;

172 
b
->
memÜy
 = 0;

173 
b
->
‹mpÜ¬y
 = 1;

174 
b
->
pos
 = 
chunk
;

175 
b
->
Ï¡
 = 
	`ngx_¥rštf
(
chunk
, "%xO" 
CRLF
, 
size
);

177 
Ž
->
Ãxt
 = 
out
;

178 
out
 = 
Ž
;

181 ià(
þ
->
buf
->
Ï¡_buf
) {

182 
Ž
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
ùx
->
ä“
);

183 ià(
Ž
 =ð
NULL
) {

184  
NGX_ERROR
;

187 
b
 = 
Ž
->
buf
;

189 
b
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_chunked_fž‹r_moduË
;

190 
b
->
‹mpÜ¬y
 = 0;

191 
b
->
memÜy
 = 1;

192 
b
->
Ï¡_buf
 = 1;

193 
b
->
pos
 = (
u_ch¬
 *è
CRLF
 "0" CRLF CRLF;

194 
b
->
Ï¡
 = b->
pos
 + 7;

196 
þ
->
buf
->
Ï¡_buf
 = 0;

198 *
Î
 = 
Ž
;

200 ià(
size
 == 0) {

201 
b
->
pos
 += 2;

204 } ià(
size
 > 0) {

205 
Ž
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
ùx
->
ä“
);

206 ià(
Ž
 =ð
NULL
) {

207  
NGX_ERROR
;

210 
b
 = 
Ž
->
buf
;

212 
b
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_chunked_fž‹r_moduË
;

213 
b
->
‹mpÜ¬y
 = 0;

214 
b
->
memÜy
 = 1;

215 
b
->
pos
 = (
u_ch¬
 *è
CRLF
;

216 
b
->
Ï¡
 = b->
pos
 + 2;

218 *
Î
 = 
Ž
;

221 *
Î
 = 
NULL
;

224 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
out
);

226 
	`ngx_chaš_upd©e_chašs
(
r
->
poÞ
, &
ùx
->
ä“
, &ùx->
busy
, &
out
,

227 (
ngx_buf_g_t
è&
ngx_h‰p_chunked_fž‹r_moduË
);

229  
rc
;

230 
	}
}

233 
ngx_št_t


234 
	$ngx_h‰p_chunked_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

236 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

237 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_chunked_h—d”_fž‹r
;

239 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

240 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_chunked_body_fž‹r
;

242  
NGX_OK
;

243 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_dav_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
	#NGX_HTTP_DAV_OFF
 2

	)

16 
	#NGX_HTTP_DAV_NO_DEPTH
 -3

	)

17 
	#NGX_HTTP_DAV_INVALID_DEPTH
 -2

	)

18 
	#NGX_HTTP_DAV_INFINITY_DEPTH
 -1

	)

22 
ngx_ušt_t
 
	mm‘hods
;

23 
ngx_ušt_t
 
	macûss
;

24 
ngx_ušt_t
 
	mmš_d–‘e_d•th
;

25 
ngx_æag_t
 
	mü—‹_fuÎ_put_·th
;

26 } 
	tngx_h‰p_dav_loc_cÚf_t
;

30 
ngx_¡r_t
 
	m·th
;

31 
size_t
 
	mËn
;

32 } 
	tngx_h‰p_dav_cÝy_ùx_t
;

35 
ngx_št_t
 
ngx_h‰p_dav_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

37 
ngx_h‰p_dav_put_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

39 
ngx_št_t
 
ngx_h‰p_dav_d–‘e_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

40 
ngx_št_t
 
ngx_h‰p_dav_d–‘e_·th
(
ngx_h‰p_»que¡_t
 *
r
,

41 
ngx_¡r_t
 *
·th
, 
ngx_ušt_t
 
dœ
);

42 
ngx_št_t
 
ngx_h‰p_dav_d–‘e_dœ
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
);

43 
ngx_št_t
 
ngx_h‰p_dav_d–‘e_fže
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
);

44 
ngx_št_t
 
ngx_h‰p_dav_noÝ
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
);

46 
ngx_št_t
 
ngx_h‰p_dav_mkcÞ_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

47 
ngx_h‰p_dav_loc_cÚf_t
 *
dlcf
);

49 
ngx_št_t
 
ngx_h‰p_dav_cÝy_move_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

50 
ngx_št_t
 
ngx_h‰p_dav_cÝy_dœ
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
);

51 
ngx_št_t
 
ngx_h‰p_dav_cÝy_dœ_time
(
ngx_Œ“_ùx_t
 *
ùx
,

52 
ngx_¡r_t
 *
·th
);

53 
ngx_št_t
 
ngx_h‰p_dav_cÝy_Œ“_fže
(
ngx_Œ“_ùx_t
 *
ùx
,

54 
ngx_¡r_t
 *
·th
);

56 
ngx_št_t
 
ngx_h‰p_dav_d•th
(
ngx_h‰p_»que¡_t
 *
r
,‚gx_št_ˆ
dæt
);

57 
ngx_št_t
 
ngx_h‰p_dav_”rÜ
(
ngx_log_t
 *
log
, 
ngx_”r_t
 
”r
,

58 
ngx_št_t
 
nÙ_found
, *
çžed
, 
u_ch¬
 *
·th
);

59 
ngx_št_t
 
ngx_h‰p_dav_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
·th
);

60 *
ngx_h‰p_dav_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

61 *
ngx_h‰p_dav_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

62 *
·»Á
, *
chžd
);

63 
ngx_št_t
 
ngx_h‰p_dav_š™
(
ngx_cÚf_t
 *
cf
);

66 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_dav_m‘hods_mask
[] = {

67 { 
ngx_¡ršg
("off"), 
NGX_HTTP_DAV_OFF
 },

68 { 
ngx_¡ršg
("put"), 
NGX_HTTP_PUT
 },

69 { 
ngx_¡ršg
("d–‘e"), 
NGX_HTTP_DELETE
 },

70 { 
ngx_¡ršg
("mkcÞ"), 
NGX_HTTP_MKCOL
 },

71 { 
ngx_¡ršg
("cÝy"), 
NGX_HTTP_COPY
 },

72 { 
ngx_¡ršg
("move"), 
NGX_HTTP_MOVE
 },

73 { 
ngx_nuÎ_¡ršg
, 0 }

77 
ngx_commªd_t
 
	gngx_h‰p_dav_commªds
[] = {

79 { 
ngx_¡ršg
("dav_methods"),

80 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

81 
ngx_cÚf_£t_b™mask_¦Ù
,

82 
NGX_HTTP_LOC_CONF_OFFSET
,

83 
off£tof
(
ngx_h‰p_dav_loc_cÚf_t
, 
m‘hods
),

84 &
ngx_h‰p_dav_m‘hods_mask
 },

86 { 
ngx_¡ršg
("create_full_put_path"),

87 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

88 
ngx_cÚf_£t_æag_¦Ù
,

89 
NGX_HTTP_LOC_CONF_OFFSET
,

90 
off£tof
(
ngx_h‰p_dav_loc_cÚf_t
, 
ü—‹_fuÎ_put_·th
),

91 
NULL
 },

93 { 
ngx_¡ršg
("min_delete_depth"),

94 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

95 
ngx_cÚf_£t_num_¦Ù
,

96 
NGX_HTTP_LOC_CONF_OFFSET
,

97 
off£tof
(
ngx_h‰p_dav_loc_cÚf_t
, 
mš_d–‘e_d•th
),

98 
NULL
 },

100 { 
ngx_¡ršg
("dav_access"),

101 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE123
,

102 
ngx_cÚf_£t_acûss_¦Ù
,

103 
NGX_HTTP_LOC_CONF_OFFSET
,

104 
off£tof
(
ngx_h‰p_dav_loc_cÚf_t
, 
acûss
),

105 
NULL
 },

107 
ngx_nuÎ_commªd


111 
ngx_h‰p_moduË_t
 
	gngx_h‰p_dav_moduË_ùx
 = {

112 
NULL
,

113 
ngx_h‰p_dav_š™
,

115 
NULL
,

116 
NULL
,

118 
NULL
,

119 
NULL
,

121 
ngx_h‰p_dav_ü—‹_loc_cÚf
,

122 
ngx_h‰p_dav_m”ge_loc_cÚf


126 
ngx_moduË_t
 
	gngx_h‰p_dav_moduË
 = {

127 
NGX_MODULE_V1
,

128 &
ngx_h‰p_dav_moduË_ùx
,

129 
ngx_h‰p_dav_commªds
,

130 
NGX_HTTP_MODULE
,

131 
NULL
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NULL
,

137 
NULL
,

138 
NGX_MODULE_V1_PADDING


142 
ngx_št_t


143 
	$ngx_h‰p_dav_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

145 
ngx_št_t
 
rc
;

146 
ngx_h‰p_dav_loc_cÚf_t
 *
dlcf
;

148 
dlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_dav_moduË
);

150 ià(!(
r
->
m‘hod
 & 
dlcf
->
m‘hods
)) {

151  
NGX_DECLINED
;

154 
r
->
m‘hod
) {

156 
NGX_HTTP_PUT
:

158 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] == '/') {

159 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

161  
NGX_HTTP_CONFLICT
;

164 
r
->
»que¡_body_š_fže_Úly
 = 1;

165 
r
->
»que¡_body_š_³rsi¡’t_fže
 = 1;

166 
r
->
»que¡_body_š_þ—n_fže
 = 1;

167 
r
->
»que¡_body_fže_group_acûss
 = 1;

168 
r
->
»que¡_body_fže_log_Ëv–
 = 0;

170 
rc
 = 
	`ngx_h‰p_»ad_þ›Á_»que¡_body
(
r
, 
ngx_h‰p_dav_put_hªdËr
);

172 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

173  
rc
;

176  
NGX_DONE
;

178 
NGX_HTTP_DELETE
:

180  
	`ngx_h‰p_dav_d–‘e_hªdËr
(
r
);

182 
NGX_HTTP_MKCOL
:

184  
	`ngx_h‰p_dav_mkcÞ_hªdËr
(
r
, 
dlcf
);

186 
NGX_HTTP_COPY
:

188  
	`ngx_h‰p_dav_cÝy_move_hªdËr
(
r
);

190 
NGX_HTTP_MOVE
:

192  
	`ngx_h‰p_dav_cÝy_move_hªdËr
(
r
);

195  
NGX_DECLINED
;

196 
	}
}

200 
	$ngx_h‰p_dav_put_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

202 
size_t
 
roÙ
;

203 
time_t
 
d©e
;

204 
ngx_¡r_t
 *
‹mp
, 
·th
;

205 
ngx_ušt_t
 
¡©us
;

206 
ngx_fže_šfo_t
 
fi
;

207 
ngx_ext_»Çme_fže_t
 
ext
;

208 
ngx_h‰p_dav_loc_cÚf_t
 *
dlcf
;

210 ià(
r
->
»que¡_body
 =ð
NULL
 ||„->»que¡_body->
‹mp_fže
 == NULL) {

211 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

215 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0è=ð
NULL
) {

216 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

220 
·th
.
Ën
--;

222 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

223 "h‰°puˆfž’ame: \"%s\"", 
·th
.
d©a
);

225 
‹mp
 = &
r
->
»que¡_body
->
‹mp_fže
->
fže
.
Çme
;

227 ià(
	`ngx_fže_šfo
(
·th
.
d©a
, &
fi
è=ð
NGX_FILE_ERROR
) {

228 
¡©us
 = 
NGX_HTTP_CREATED
;

231 
¡©us
 = 
NGX_HTTP_NO_CONTENT
;

233 ià(
	`ngx_is_dœ
(&
fi
)) {

234 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 
NGX_EISDIR
,

235 "\"%s\" could‚Ù bü—‹d", 
·th
.
d©a
);

237 ià(
	`ngx_d–‘e_fže
(
‹mp
->
d©a
è=ð
NGX_FILE_ERROR
) {

238 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

239 
ngx_d–‘e_fže_n
 " \"%s\" failed",

240 
‹mp
->
d©a
);

243 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_CONFLICT
);

248 
dlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_dav_moduË
);

250 
ext
.
acûss
 = 
dlcf
->access;

251 
ext
.
·th_acûss
 = 
dlcf
->
acûss
;

252 
ext
.
time
 = -1;

253 
ext
.
ü—‹_·th
 = 
dlcf
->
ü—‹_fuÎ_put_·th
;

254 
ext
.
d–‘e_fže
 = 1;

255 
ext
.
log
 = 
r
->
cÚÃùiÚ
->log;

257 ià(
r
->
h—d”s_š
.
d©e
) {

258 
d©e
 = 
	`ngx_h‰p_·r£_time
(
r
->
h—d”s_š
.d©e->
v®ue
.
d©a
,

259 
r
->
h—d”s_š
.
d©e
->
v®ue
.
Ën
);

261 ià(
d©e
 !ð
NGX_ERROR
) {

262 
ext
.
time
 = 
d©e
;

263 
ext
.
fd
 = 
r
->
»que¡_body
->
‹mp_fže
->
fže
.fd;

267 ià(
	`ngx_ext_»Çme_fže
(
‹mp
, &
·th
, &
ext
è!ð
NGX_OK
) {

268 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

272 ià(
¡©us
 =ð
NGX_HTTP_CREATED
) {

273 ià(
	`ngx_h‰p_dav_loÿtiÚ
(
r
, 
·th
.
d©a
è!ð
NGX_OK
) {

274 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

278 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 0;

281 
r
->
h—d”s_out
.
¡©us
 = status;

282 
r
->
h—d”_Úly
 = 1;

284 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
	`ngx_h‰p_£nd_h—d”
(r));

286 
	}
}

289 
ngx_št_t


290 
	$ngx_h‰p_dav_d–‘e_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

292 
size_t
 
roÙ
;

293 
ngx_”r_t
 
”r
;

294 
ngx_št_t
 
rc
, 
d•th
;

295 
ngx_ušt_t
 
i
, 
d
, 
dœ
;

296 
ngx_¡r_t
 
·th
;

297 
ngx_fže_šfo_t
 
fi
;

298 
ngx_h‰p_dav_loc_cÚf_t
 *
dlcf
;

300 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 > 0) {

301 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

303  
NGX_HTTP_UNSUPPORTED_MEDIA_TYPE
;

306 
dlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_dav_moduË
);

308 ià(
dlcf
->
mš_d–‘e_d•th
) {

309 
d
 = 0;

311 
i
 = 0; i < 
r
->
uri
.
Ën
; ) {

312 ià(
r
->
uri
.
d©a
[
i
++] == '/') {

313 ià(++
d
 >ð
dlcf
->
mš_d–‘e_d•th
 && 
i
 < 
r
->
uri
.
Ën
) {

314 
ok
;

319 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

320 "šsuffic›Á URI d•th:%˜tØDELETE", 
d
);

321  
NGX_HTTP_CONFLICT
;

324 
ok
:

326 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0è=ð
NULL
) {

327  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

330 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

331 "h‰°d–‘fž’ame: \"%s\"", 
·th
.
d©a
);

333 ià(
	`ngx_lšk_šfo
(
·th
.
d©a
, &
fi
è=ð
NGX_FILE_ERROR
) {

334 
”r
 = 
ngx_”ºo
;

336 
rc
 = (
”r
 =ð
NGX_ENOTDIR
è? 
NGX_HTTP_CONFLICT
 : 
NGX_HTTP_NOT_FOUND
;

338  
	`ngx_h‰p_dav_”rÜ
(
r
->
cÚÃùiÚ
->
log
, 
”r
,

339 
rc
, 
ngx_lšk_šfo_n
, 
·th
.
d©a
);

342 ià(
	`ngx_is_dœ
(&
fi
)) {

344 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] != '/') {

345 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 
NGX_EISDIR
,

346 "DELETE \"%s\" fažed", 
·th
.
d©a
);

347  
NGX_HTTP_CONFLICT
;

350 
d•th
 = 
	`ngx_h‰p_dav_d•th
(
r
, 
NGX_HTTP_DAV_INFINITY_DEPTH
);

352 ià(
d•th
 !ð
NGX_HTTP_DAV_INFINITY_DEPTH
) {

353 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

355  
NGX_HTTP_BAD_REQUEST
;

358 
·th
.
Ën
 -= 2;

360 
dœ
 = 1;

369 
d•th
 = 
	`ngx_h‰p_dav_d•th
(
r
, 0);

371 ià(
d•th
 !ð0 && d•th !ð
NGX_HTTP_DAV_INFINITY_DEPTH
) {

372 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

374  
NGX_HTTP_BAD_REQUEST
;

377 
dœ
 = 0;

380 
rc
 = 
	`ngx_h‰p_dav_d–‘e_·th
(
r
, &
·th
, 
dœ
);

382 ià(
rc
 =ð
NGX_OK
) {

383  
NGX_HTTP_NO_CONTENT
;

386  
rc
;

387 
	}
}

390 
ngx_št_t


391 
	$ngx_h‰p_dav_d–‘e_·th
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
·th
, 
ngx_ušt_t
 
dœ
)

393 *
çžed
;

394 
ngx_Œ“_ùx_t
 
Œ“
;

396 ià(
dœ
) {

398 
Œ“
.
š™_hªdËr
 = 
NULL
;

399 
Œ“
.
fže_hªdËr
 = 
ngx_h‰p_dav_d–‘e_fže
;

400 
Œ“
.
´e_Œ“_hªdËr
 = 
ngx_h‰p_dav_noÝ
;

401 
Œ“
.
po¡_Œ“_hªdËr
 = 
ngx_h‰p_dav_d–‘e_dœ
;

402 
Œ“
.
¥ec_hªdËr
 = 
ngx_h‰p_dav_d–‘e_fže
;

403 
Œ“
.
d©a
 = 
NULL
;

404 
Œ“
.
®loc
 = 0;

405 
Œ“
.
log
 = 
r
->
cÚÃùiÚ
->log;

409 ià(
	`ngx_w®k_Œ“
(&
Œ“
, 
·th
è!ð
NGX_OK
) {

410  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

413 ià(
	`ngx_d–‘e_dœ
(
·th
->
d©a
è!ð
NGX_FILE_ERROR
) {

414  
NGX_OK
;

417 
çžed
 = 
ngx_d–‘e_dœ_n
;

421 ià(
	`ngx_d–‘e_fže
(
·th
->
d©a
è!ð
NGX_FILE_ERROR
) {

422  
NGX_OK
;

425 
çžed
 = 
ngx_d–‘e_fže_n
;

428  
	`ngx_h‰p_dav_”rÜ
(
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

429 
NGX_HTTP_NOT_FOUND
, 
çžed
, 
·th
->
d©a
);

430 
	}
}

433 
ngx_št_t


434 
	$ngx_h‰p_dav_d–‘e_dœ
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

436 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

437 "h‰°d–‘dœ: \"%s\"", 
·th
->
d©a
);

439 ià(
	`ngx_d–‘e_dœ
(
·th
->
d©a
è=ð
NGX_FILE_ERROR
) {

443 (è
	`ngx_h‰p_dav_”rÜ
(
ùx
->
log
, 
ngx_”ºo
, 0, 
ngx_d–‘e_dœ_n
,

444 
·th
->
d©a
);

447  
NGX_OK
;

448 
	}
}

451 
ngx_št_t


452 
	$ngx_h‰p_dav_d–‘e_fže
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

454 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

455 "h‰°d–‘fže: \"%s\"", 
·th
->
d©a
);

457 ià(
	`ngx_d–‘e_fže
(
·th
->
d©a
è=ð
NGX_FILE_ERROR
) {

461 (è
	`ngx_h‰p_dav_”rÜ
(
ùx
->
log
, 
ngx_”ºo
, 0, 
ngx_d–‘e_fže_n
,

462 
·th
->
d©a
);

465  
NGX_OK
;

466 
	}
}

469 
ngx_št_t


470 
	$ngx_h‰p_dav_noÝ
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

472  
NGX_OK
;

473 
	}
}

476 
ngx_št_t


477 
	$ngx_h‰p_dav_mkcÞ_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_dav_loc_cÚf_t
 *
dlcf
)

479 
u_ch¬
 *
p
;

480 
size_t
 
roÙ
;

481 
ngx_¡r_t
 
·th
;

483 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 > 0) {

484 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

486  
NGX_HTTP_UNSUPPORTED_MEDIA_TYPE
;

489 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] != '/') {

490 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

492  
NGX_HTTP_CONFLICT
;

495 
p
 = 
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0);

496 ià(
p
 =ð
NULL
) {

497  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

500 *(
p
 - 1) = '\0';

501 
r
->
uri
.
Ën
--;

503 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

504 "h‰°mkcÞ…©h: \"%s\"", 
·th
.
d©a
);

506 ià(
	`ngx_ü—‹_dœ
(
·th
.
d©a
, 
	`ngx_dœ_acûss
(
dlcf
->
acûss
))

507 !ð
NGX_FILE_ERROR
)

509 ià(
	`ngx_h‰p_dav_loÿtiÚ
(
r
, 
·th
.
d©a
è!ð
NGX_OK
) {

510  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

513  
NGX_HTTP_CREATED
;

516  
	`ngx_h‰p_dav_”rÜ
(
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

517 
NGX_HTTP_CONFLICT
, 
ngx_ü—‹_dœ_n
, 
·th
.
d©a
);

518 
	}
}

521 
ngx_št_t


522 
	$ngx_h‰p_dav_cÝy_move_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

524 
u_ch¬
 *
p
, *
ho¡
, *
Ï¡
, 
ch
;

525 
size_t
 
Ën
, 
roÙ
;

526 
ngx_”r_t
 
”r
;

527 
ngx_št_t
 
rc
, 
d•th
;

528 
ngx_ušt_t
 
ov”wr™e
, 
¦ash
, 
dœ
, 
æags
;

529 
ngx_¡r_t
 
·th
, 
uri
, 
duri
, 
¬gs
;

530 
ngx_Œ“_ùx_t
 
Œ“
;

531 
ngx_cÝy_fže_t
 
cf
;

532 
ngx_fže_šfo_t
 
fi
;

533 
ngx_bË_–t_t
 *
de¡
, *
ov”
;

534 
ngx_ext_»Çme_fže_t
 
ext
;

535 
ngx_h‰p_dav_cÝy_ùx_t
 
cÝy
;

536 
ngx_h‰p_dav_loc_cÚf_t
 *
dlcf
;

538 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 > 0) {

539  
NGX_HTTP_UNSUPPORTED_MEDIA_TYPE
;

542 
de¡
 = 
r
->
h—d”s_š
.
de¡š©iÚ
;

544 ià(
de¡
 =ð
NULL
) {

545 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

547  
NGX_HTTP_BAD_REQUEST
;

550 
p
 = 
de¡
->
v®ue
.
d©a
;

552 ià(
p
[0] == '/') {

553 
Ï¡
 = 
p
 + 
de¡
->
v®ue
.
Ën
;

554 
de¡š©iÚ_dÚe
;

557 
Ën
 = 
r
->
h—d”s_š
.
£rv”
.len;

559 ià(
Ën
 == 0) {

560 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

562  
NGX_HTTP_BAD_REQUEST
;

565 #ià(
NGX_HTTP_SSL
)

567 ià(
r
->
cÚÃùiÚ
->
s¦
) {

568 ià(
	`ngx_¡ºcmp
(
de¡
->
v®ue
.
d©a
, "https://", ("https://") - 1)

571 
šv®id_de¡š©iÚ
;

574 
ho¡
 = 
de¡
->
v®ue
.
d©a
 + ("https://") - 1;

579 ià(
	`ngx_¡ºcmp
(
de¡
->
v®ue
.
d©a
, "http://", ("http://") - 1)

582 
šv®id_de¡š©iÚ
;

585 
ho¡
 = 
de¡
->
v®ue
.
d©a
 + ("http://") - 1;

588 ià(
	`ngx_¡ºcmp
(
ho¡
, 
r
->
h—d”s_š
.
£rv”
.
d©a
, 
Ën
) != 0) {

589 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

592 &
de¡
->
v®ue
);

593  
NGX_HTTP_BAD_REQUEST
;

596 
Ï¡
 = 
de¡
->
v®ue
.
d©a
 + de¡->v®ue.
Ën
;

598 
p
 = 
ho¡
 + 
Ën
;… < 
Ï¡
;…++) {

599 ià(*
p
 == '/') {

600 
de¡š©iÚ_dÚe
;

604 
šv®id_de¡š©iÚ
:

606 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

608 &
de¡
->
v®ue
);

609  
NGX_HTTP_BAD_REQUEST
;

611 
de¡š©iÚ_dÚe
:

613 
duri
.
Ën
 = 
Ï¡
 - 
p
;

614 
duri
.
d©a
 = 
p
;

615 
æags
 = 
NGX_HTTP_LOG_UNSAFE
;

617 ià(
	`ngx_h‰p_·r£_un§ã_uri
(
r
, &
duri
, &
¬gs
, &
æags
è!ð
NGX_OK
) {

618 
šv®id_de¡š©iÚ
;

621 ià((
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] =ð'/' && *(
Ï¡
 - 1) != '/')

622 || (
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] !ð'/' && *(
Ï¡
 - 1) == '/'))

624 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

627 &
r
->
uri
, &
de¡
->
v®ue
);

628  
NGX_HTTP_CONFLICT
;

631 
d•th
 = 
	`ngx_h‰p_dav_d•th
(
r
, 
NGX_HTTP_DAV_INFINITY_DEPTH
);

633 ià(
d•th
 !ð
NGX_HTTP_DAV_INFINITY_DEPTH
) {

635 ià(
r
->
m‘hod
 =ð
NGX_HTTP_COPY
) {

636 ià(
d•th
 != 0) {

637 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

639  
NGX_HTTP_BAD_REQUEST
;

643 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

645  
NGX_HTTP_BAD_REQUEST
;

649 
ov”
 = 
r
->
h—d”s_š
.
ov”wr™e
;

651 ià(
ov”
) {

652 ià(
ov”
->
v®ue
.
Ën
 == 1) {

653 
ch
 = 
ov”
->
v®ue
.
d©a
[0];

655 ià(
ch
 == 'T' || ch == 't') {

656 
ov”wr™e
 = 1;

657 
ov”wr™e_dÚe
;

660 ià(
ch
 == 'F' || ch == 'f') {

661 
ov”wr™e
 = 0;

662 
ov”wr™e_dÚe
;

667 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

669 &
ov”
->
v®ue
);

670  
NGX_HTTP_BAD_REQUEST
;

673 
ov”wr™e
 = 1;

675 
ov”wr™e_dÚe
:

677 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0è=ð
NULL
) {

678  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

681 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

682 "h‰°cÝy from: \"%s\"", 
·th
.
d©a
);

684 
uri
 = 
r
->uri;

685 
r
->
uri
 = 
duri
;

687 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
cÝy
.
·th
, &
roÙ
, 0è=ð
NULL
) {

688  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

691 
r
->
uri
 = uri;

693 
cÝy
.
·th
.
Ën
--;

695 ià(
cÝy
.
·th
.
d©a
[cÝy.·th.
Ën
 - 1] == '/') {

696 
¦ash
 = 1;

697 
cÝy
.
·th
.
Ën
--;

698 
cÝy
.
·th
.
d©a
[cÝy.·th.
Ën
] = '\0';

701 
¦ash
 = 0;

704 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

705 "h‰°cÝyo: \"%s\"", 
cÝy
.
·th
.
d©a
);

707 ià(
	`ngx_lšk_šfo
(
cÝy
.
·th
.
d©a
, &
fi
è=ð
NGX_FILE_ERROR
) {

708 
”r
 = 
ngx_”ºo
;

710 ià(
”r
 !ð
NGX_ENOENT
) {

711  
	`ngx_h‰p_dav_”rÜ
(
r
->
cÚÃùiÚ
->
log
, 
”r
,

712 
NGX_HTTP_NOT_FOUND
, 
ngx_lšk_šfo_n
,

713 
cÝy
.
·th
.
d©a
);

718 
ov”wr™e
 = 0;

719 
dœ
 = 0;

725 ià(
	`ngx_is_dœ
(&
fi
è&& !
¦ash
) {

726 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

728 &
r
->
uri
, &r->
m‘hod_Çme
, &
de¡
->
v®ue
);

729  
NGX_HTTP_CONFLICT
;

732 ià(!
ov”wr™e
) {

733 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 
NGX_EEXIST
,

734 "\"%s\" could‚Ù bü—‹d", 
cÝy
.
·th
.
d©a
);

735  
NGX_HTTP_PRECONDITION_FAILED
;

738 
dœ
 = 
	`ngx_is_dœ
(&
fi
);

741 ià(
	`ngx_lšk_šfo
(
·th
.
d©a
, &
fi
è=ð
NGX_FILE_ERROR
) {

742  
	`ngx_h‰p_dav_”rÜ
(
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

743 
NGX_HTTP_NOT_FOUND
, 
ngx_lšk_šfo_n
,

744 
·th
.
d©a
);

747 ià(
	`ngx_is_dœ
(&
fi
)) {

749 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] != '/') {

750 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

751 "\"%V\" i cÞËùiÚ", &
r
->
uri
);

752  
NGX_HTTP_BAD_REQUEST
;

755 ià(
ov”wr™e
) {

756 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

757 "h‰°d–‘e: \"%s\"", 
cÝy
.
·th
.
d©a
);

759 
rc
 = 
	`ngx_h‰p_dav_d–‘e_·th
(
r
, &
cÝy
.
·th
, 
dœ
);

761 ià(
rc
 !ð
NGX_OK
) {

762  
rc
;

767 ià(
	`ngx_is_dœ
(&
fi
)) {

769 
·th
.
Ën
 -= 2;

771 ià(
r
->
m‘hod
 =ð
NGX_HTTP_MOVE
) {

772 ià(
	`ngx_»Çme_fže
(
·th
.
d©a
, 
cÝy
.·th.d©aè!ð
NGX_FILE_ERROR
) {

773  
NGX_HTTP_CREATED
;

777 ià(
	`ngx_ü—‹_dœ
(
cÝy
.
·th
.
d©a
, 
	`ngx_fže_acûss
(&
fi
))

778 =ð
NGX_FILE_ERROR
)

780  
	`ngx_h‰p_dav_”rÜ
(
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

781 
NGX_HTTP_NOT_FOUND
,

782 
ngx_ü—‹_dœ_n
, 
cÝy
.
·th
.
d©a
);

785 
cÝy
.
Ën
 = 
·th
.len;

787 
Œ“
.
š™_hªdËr
 = 
NULL
;

788 
Œ“
.
fže_hªdËr
 = 
ngx_h‰p_dav_cÝy_Œ“_fže
;

789 
Œ“
.
´e_Œ“_hªdËr
 = 
ngx_h‰p_dav_cÝy_dœ
;

790 
Œ“
.
po¡_Œ“_hªdËr
 = 
ngx_h‰p_dav_cÝy_dœ_time
;

791 
Œ“
.
¥ec_hªdËr
 = 
ngx_h‰p_dav_noÝ
;

792 
Œ“
.
d©a
 = &
cÝy
;

793 
Œ“
.
®loc
 = 0;

794 
Œ“
.
log
 = 
r
->
cÚÃùiÚ
->log;

796 ià(
	`ngx_w®k_Œ“
(&
Œ“
, &
·th
è=ð
NGX_OK
) {

798 ià(
r
->
m‘hod
 =ð
NGX_HTTP_MOVE
) {

799 
rc
 = 
	`ngx_h‰p_dav_d–‘e_·th
(
r
, &
·th
, 1);

801 ià(
rc
 !ð
NGX_OK
) {

802  
rc
;

806  
NGX_HTTP_CREATED
;

811 ià(
r
->
m‘hod
 =ð
NGX_HTTP_MOVE
) {

813 
dlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_dav_moduË
);

815 
ext
.
acûss
 = 0;

816 
ext
.
·th_acûss
 = 
dlcf
->
acûss
;

817 
ext
.
time
 = -1;

818 
ext
.
ü—‹_·th
 = 1;

819 
ext
.
d–‘e_fže
 = 0;

820 
ext
.
log
 = 
r
->
cÚÃùiÚ
->log;

822 ià(
	`ngx_ext_»Çme_fže
(&
·th
, &
cÝy
.·th, &
ext
è=ð
NGX_OK
) {

823  
NGX_HTTP_NO_CONTENT
;

826  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

829 
dlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_dav_moduË
);

831 
cf
.
size
 = 
	`ngx_fže_size
(&
fi
);

832 
cf
.
buf_size
 = 0;

833 
cf
.
acûss
 = 
dlcf
->access;

834 
cf
.
time
 = 
	`ngx_fže_mtime
(&
fi
);

835 
cf
.
log
 = 
r
->
cÚÃùiÚ
->log;

837 ià(
	`ngx_cÝy_fže
(
·th
.
d©a
, 
cÝy
.·th.d©a, &
cf
è=ð
NGX_OK
) {

838  
NGX_HTTP_NO_CONTENT
;

842  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

843 
	}
}

846 
ngx_št_t


847 
	$ngx_h‰p_dav_cÝy_dœ
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

849 
u_ch¬
 *
p
, *
dœ
;

850 
size_t
 
Ën
;

851 
ngx_h‰p_dav_cÝy_ùx_t
 *
cÝy
;

853 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

854 "h‰°cÝy dœ: \"%s\"", 
·th
->
d©a
);

856 
cÝy
 = 
ùx
->
d©a
;

858 
Ën
 = 
cÝy
->
·th
.len +…ath->len;

860 
dœ
 = 
	`ngx_®loc
(
Ën
 + 1, 
ùx
->
log
);

861 ià(
dœ
 =ð
NULL
) {

862  
NGX_ABORT
;

865 
p
 = 
	`ngx_ýymem
(
dœ
, 
cÝy
->
·th
.
d©a
, cÝy->·th.
Ën
);

866 (è
	`ngx_ýy¡º
(
p
, 
·th
->
d©a
 + 
cÝy
->
Ën
,…ath->len - copy->len + 1);

868 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

869 "h‰°cÝy dœo: \"%s\"", 
dœ
);

871 ià(
	`ngx_ü—‹_dœ
(
dœ
, 
	`ngx_dœ_acûss
(
ùx
->
acûss
)è=ð
NGX_FILE_ERROR
) {

872 (è
	`ngx_h‰p_dav_”rÜ
(
ùx
->
log
, 
ngx_”ºo
, 0, 
ngx_ü—‹_dœ_n
,

873 
dœ
);

876 
	`ngx_ä“
(
dœ
);

878  
NGX_OK
;

879 
	}
}

882 
ngx_št_t


883 
	$ngx_h‰p_dav_cÝy_dœ_time
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

885 
u_ch¬
 *
p
, *
dœ
;

886 
size_t
 
Ën
;

887 
ngx_h‰p_dav_cÝy_ùx_t
 *
cÝy
;

889 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

890 "h‰°cÝy dœime: \"%s\"", 
·th
->
d©a
);

892 
cÝy
 = 
ùx
->
d©a
;

894 
Ën
 = 
cÝy
->
·th
.len +…ath->len;

896 
dœ
 = 
	`ngx_®loc
(
Ën
 + 1, 
ùx
->
log
);

897 ià(
dœ
 =ð
NULL
) {

898  
NGX_ABORT
;

901 
p
 = 
	`ngx_ýymem
(
dœ
, 
cÝy
->
·th
.
d©a
, cÝy->·th.
Ën
);

902 (è
	`ngx_ýy¡º
(
p
, 
·th
->
d©a
 + 
cÝy
->
Ën
,…ath->len - copy->len + 1);

904 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

905 "h‰°cÝy dœimto: \"%s\"", 
dœ
);

907 #ià(
NGX_WIN32
)

909 
ngx_fd_t
 
fd
;

911 
fd
 = 
	`ngx_Ý’_fže
(
dœ
, 
NGX_FILE_RDWR
, 
NGX_FILE_OPEN
, 0);

913 ià(
fd
 =ð
NGX_INVALID_FILE
) {

914 (è
	`ngx_h‰p_dav_”rÜ
(
ùx
->
log
, 
ngx_”ºo
, 0, 
ngx_Ý’_fže_n
, 
dœ
);

915 
çžed
;

918 ià(
	`ngx_£t_fže_time
(
NULL
, 
fd
, 
ùx
->
mtime
è!ð
NGX_OK
) {

919 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ùx
->
log
, 
ngx_”ºo
,

920 
ngx_£t_fže_time_n
 " \"%s\" fažed", 
dœ
);

923 ià(
	`ngx_þo£_fže
(
fd
è=ð
NGX_FILE_ERROR
) {

924 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ùx
->
log
, 
ngx_”ºo
,

925 
ngx_þo£_fže_n
 " \"%s\" fažed", 
dœ
);

929 
çžed
:

933 ià(
	`ngx_£t_fže_time
(
dœ
, 0, 
ùx
->
mtime
è!ð
NGX_OK
) {

934 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ùx
->
log
, 
ngx_”ºo
,

935 
ngx_£t_fže_time_n
 " \"%s\" fažed", 
dœ
);

940 
	`ngx_ä“
(
dœ
);

942  
NGX_OK
;

943 
	}
}

946 
ngx_št_t


947 
	$ngx_h‰p_dav_cÝy_Œ“_fže
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

949 
u_ch¬
 *
p
, *
fže
;

950 
size_t
 
Ën
;

951 
ngx_cÝy_fže_t
 
cf
;

952 
ngx_h‰p_dav_cÝy_ùx_t
 *
cÝy
;

954 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

955 "h‰°cÝy fže: \"%s\"", 
·th
->
d©a
);

957 
cÝy
 = 
ùx
->
d©a
;

959 
Ën
 = 
cÝy
->
·th
.len +…ath->len;

961 
fže
 = 
	`ngx_®loc
(
Ën
 + 1, 
ùx
->
log
);

962 ià(
fže
 =ð
NULL
) {

963  
NGX_ABORT
;

966 
p
 = 
	`ngx_ýymem
(
fže
, 
cÝy
->
·th
.
d©a
, cÝy->·th.
Ën
);

967 (è
	`ngx_ýy¡º
(
p
, 
·th
->
d©a
 + 
cÝy
->
Ën
,…ath->len - copy->len + 1);

969 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

970 "h‰°cÝy fžto: \"%s\"", 
fže
);

972 
cf
.
size
 = 
ùx
->size;

973 
cf
.
buf_size
 = 0;

974 
cf
.
acûss
 = 
ùx
->access;

975 
cf
.
time
 = 
ùx
->
mtime
;

976 
cf
.
log
 = 
ùx
->log;

978 (è
	`ngx_cÝy_fže
(
·th
->
d©a
, 
fže
, &
cf
);

980 
	`ngx_ä“
(
fže
);

982  
NGX_OK
;

983 
	}
}

986 
ngx_št_t


987 
	$ngx_h‰p_dav_d•th
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
dæt
)

989 
ngx_bË_–t_t
 *
d•th
;

991 
d•th
 = 
r
->
h—d”s_š
.depth;

993 ià(
d•th
 =ð
NULL
) {

994  
dæt
;

997 ià(
d•th
->
v®ue
.
Ën
 == 1) {

999 ià(
d•th
->
v®ue
.
d©a
[0] == '0') {

1003 ià(
d•th
->
v®ue
.
d©a
[0] == '1') {

1009 ià(
d•th
->
v®ue
.
Ën
 == ("infinity") - 1

1010 && 
	`ngx_¡rcmp
(
d•th
->
v®ue
.
d©a
, "infinity") == 0)

1012  
NGX_HTTP_DAV_INFINITY_DEPTH
;

1016 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1018 &
d•th
->
v®ue
);

1020  
NGX_HTTP_DAV_INVALID_DEPTH
;

1021 
	}
}

1024 
ngx_št_t


1025 
	$ngx_h‰p_dav_”rÜ
(
ngx_log_t
 *
log
, 
ngx_”r_t
 
”r
, 
ngx_št_t
 
nÙ_found
,

1026 *
çžed
, 
u_ch¬
 *
·th
)

1028 
ngx_št_t
 
rc
;

1029 
ngx_ušt_t
 
Ëv–
;

1031 ià(
”r
 =ð
NGX_ENOENT
 ||ƒ¼ =ð
NGX_ENOTDIR
 ||ƒ¼ =ð
NGX_ENAMETOOLONG
) {

1032 
Ëv–
 = 
NGX_LOG_ERR
;

1033 
rc
 = 
nÙ_found
;

1035 } ià(
”r
 =ð
NGX_EACCES
 ||ƒ¼ =ð
NGX_EPERM
) {

1036 
Ëv–
 = 
NGX_LOG_ERR
;

1037 
rc
 = 
NGX_HTTP_FORBIDDEN
;

1039 } ià(
”r
 =ð
NGX_EEXIST
) {

1040 
Ëv–
 = 
NGX_LOG_ERR
;

1041 
rc
 = 
NGX_HTTP_NOT_ALLOWED
;

1043 } ià(
”r
 =ð
NGX_ENOSPC
) {

1044 
Ëv–
 = 
NGX_LOG_CRIT
;

1045 
rc
 = 
NGX_HTTP_INSUFFICIENT_STORAGE
;

1048 
Ëv–
 = 
NGX_LOG_CRIT
;

1049 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1052 
	`ngx_log_”rÜ
(
Ëv–
, 
log
, 
”r
, "% \"%s\" fažed", 
çžed
, 
·th
);

1054  
rc
;

1055 
	}
}

1058 
ngx_št_t


1059 
	$ngx_h‰p_dav_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
·th
)

1061 
u_ch¬
 *
loÿtiÚ
;

1062 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1064 
r
->
h—d”s_out
.
loÿtiÚ
 = 
	`ngx_·Îoc
Ô->
poÞ
, (
ngx_bË_–t_t
));

1065 ià(
r
->
h—d”s_out
.
loÿtiÚ
 =ð
NULL
) {

1066  
NGX_ERROR
;

1069 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1071 ià(!
þcf
->
®Ÿs
 && clcf->
roÙ_Ëngths
 =ð
NULL
) {

1072 
loÿtiÚ
 = 
·th
 + 
þcf
->
roÙ
.
Ën
;

1075 
loÿtiÚ
 = 
	`ngx_²®loc
(
r
->
poÞ
,„->
uri
.
Ën
);

1076 ià(
loÿtiÚ
 =ð
NULL
) {

1077  
NGX_ERROR
;

1080 
	`ngx_memýy
(
loÿtiÚ
, 
r
->
uri
.
d©a
,„->uri.
Ën
);

1088 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
 =„->
uri
.len;

1089 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
 =†ocation;

1091  
NGX_OK
;

1092 
	}
}

1096 
	$ngx_h‰p_dav_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

1098 
ngx_h‰p_dav_loc_cÚf_t
 *
cÚf
;

1100 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_dav_loc_cÚf_t
));

1101 ià(
cÚf
 =ð
NULL
) {

1102  
NULL
;

1111 
cÚf
->
mš_d–‘e_d•th
 = 
NGX_CONF_UNSET_UINT
;

1112 
cÚf
->
acûss
 = 
NGX_CONF_UNSET_UINT
;

1113 
cÚf
->
ü—‹_fuÎ_put_·th
 = 
NGX_CONF_UNSET
;

1115  
cÚf
;

1116 
	}
}

1120 
	$ngx_h‰p_dav_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1122 
ngx_h‰p_dav_loc_cÚf_t
 *
´ev
 = 
·»Á
;

1123 
ngx_h‰p_dav_loc_cÚf_t
 *
cÚf
 = 
chžd
;

1125 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
m‘hods
, 
´ev
->methods,

1126 (
NGX_CONF_BITMASK_SET
|
NGX_HTTP_DAV_OFF
));

1128 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
mš_d–‘e_d•th
,

1129 
´ev
->
mš_d–‘e_d•th
, 0);

1131 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
acûss
, 
´ev
->access, 0600);

1133 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
ü—‹_fuÎ_put_·th
,

1134 
´ev
->
ü—‹_fuÎ_put_·th
, 0);

1136  
NGX_CONF_OK
;

1137 
	}
}

1140 
ngx_št_t


1141 
	$ngx_h‰p_dav_š™
(
ngx_cÚf_t
 *
cf
)

1143 
ngx_h‰p_hªdËr_±
 *
h
;

1144 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

1146 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

1148 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_CONTENT_PHASE
].
hªdËrs
);

1149 ià(
h
 =ð
NULL
) {

1150  
NGX_ERROR
;

1153 *
h
 = 
ngx_h‰p_dav_hªdËr
;

1155  
NGX_OK
;

1156 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_degradation_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
size_t
 
	msbrk_size
;

15 } 
	tngx_h‰p_deg¿d©iÚ_maš_cÚf_t
;

19 
ngx_ušt_t
 
	mdeg¿de
;

20 } 
	tngx_h‰p_deg¿d©iÚ_loc_cÚf_t
;

23 
ngx_cÚf_’um_t
 
	gngx_h‰p_deg¿de
[] = {

24 { 
ngx_¡ršg
("204"), 204 },

25 { 
ngx_¡ršg
("444"), 444 },

26 { 
ngx_nuÎ_¡ršg
, 0 }

30 *
ngx_h‰p_deg¿d©iÚ_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

31 *
ngx_h‰p_deg¿d©iÚ_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

32 *
ngx_h‰p_deg¿d©iÚ_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

33 *
chžd
);

34 *
ngx_h‰p_deg¿d©iÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

35 *
cÚf
);

36 
ngx_št_t
 
ngx_h‰p_deg¿d©iÚ_š™
(
ngx_cÚf_t
 *
cf
);

39 
ngx_commªd_t
 
	gngx_h‰p_deg¿d©iÚ_commªds
[] = {

41 { 
ngx_¡ršg
("degradation"),

42 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

43 
ngx_h‰p_deg¿d©iÚ
,

44 
NGX_HTTP_MAIN_CONF_OFFSET
,

46 
NULL
 },

48 { 
ngx_¡ršg
("degrade"),

49 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

50 
ngx_cÚf_£t_’um_¦Ù
,

51 
NGX_HTTP_LOC_CONF_OFFSET
,

52 
off£tof
(
ngx_h‰p_deg¿d©iÚ_loc_cÚf_t
, 
deg¿de
),

53 &
ngx_h‰p_deg¿de
 },

55 
ngx_nuÎ_commªd


59 
ngx_h‰p_moduË_t
 
	gngx_h‰p_deg¿d©iÚ_moduË_ùx
 = {

60 
NULL
,

61 
ngx_h‰p_deg¿d©iÚ_š™
,

63 
ngx_h‰p_deg¿d©iÚ_ü—‹_maš_cÚf
,

64 
NULL
,

66 
NULL
,

67 
NULL
,

69 
ngx_h‰p_deg¿d©iÚ_ü—‹_loc_cÚf
,

70 
ngx_h‰p_deg¿d©iÚ_m”ge_loc_cÚf


74 
ngx_moduË_t
 
	gngx_h‰p_deg¿d©iÚ_moduË
 = {

75 
NGX_MODULE_V1
,

76 &
ngx_h‰p_deg¿d©iÚ_moduË_ùx
,

77 
ngx_h‰p_deg¿d©iÚ_commªds
,

78 
NGX_HTTP_MODULE
,

79 
NULL
,

80 
NULL
,

81 
NULL
,

82 
NULL
,

83 
NULL
,

84 
NULL
,

85 
NULL
,

86 
NGX_MODULE_V1_PADDING


90 
ngx_št_t


91 
	$ngx_h‰p_deg¿d©iÚ_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

93 
ngx_h‰p_deg¿d©iÚ_loc_cÚf_t
 *
dlcf
;

95 
dlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_deg¿d©iÚ_moduË
);

97 ià(
dlcf
->
deg¿de
 && 
	`ngx_h‰p_deg¿ded
(
r
)) {

98  
dlcf
->
deg¿de
;

101  
NGX_DECLINED
;

102 
	}
}

105 
ngx_ušt_t


106 
	$ngx_h‰p_deg¿ded
(
ngx_h‰p_»que¡_t
 *
r
)

108 
time_t
 
now
;

109 
ngx_ušt_t
 
log
;

110 
size_t
 
sbrk_size
;

111 
time_t
 
sbrk_time
;

112 
ngx_h‰p_deg¿d©iÚ_maš_cÚf_t
 *
dmcf
;

114 
dmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_deg¿d©iÚ_moduË
);

116 ià(
dmcf
->
sbrk_size
) {

118 
log
 = 0;

119 
now
 = 
	`ngx_time
();

123 ià(
now
 !ð
sbrk_time
) {

132 
sbrk_size
 = (
size_t
è
	`sbrk
(0è- ((
ušŒ_t
è
ngx_·Îoc
 & ~0x3FFFFF);

133 
sbrk_time
 = 
now
;

134 
log
 = 1;

139 ià(
sbrk_size
 >ð
dmcf
->sbrk_size) {

140 ià(
log
) {

141 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
r
->
cÚÃùiÚ
->
log
, 0,

143 
sbrk_size
 / (1024 * 1024));

151 
	}
}

155 
	$ngx_h‰p_deg¿d©iÚ_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

157 
ngx_h‰p_deg¿d©iÚ_maš_cÚf_t
 *
dmcf
;

159 
dmcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_deg¿d©iÚ_maš_cÚf_t
));

160 ià(
dmcf
 =ð
NULL
) {

161  
NULL
;

164  
dmcf
;

165 
	}
}

169 
	$ngx_h‰p_deg¿d©iÚ_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

171 
ngx_h‰p_deg¿d©iÚ_loc_cÚf_t
 *
cÚf
;

173 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_deg¿d©iÚ_loc_cÚf_t
));

174 ià(
cÚf
 =ð
NULL
) {

175  
NULL
;

178 
cÚf
->
deg¿de
 = 
NGX_CONF_UNSET_UINT
;

180  
cÚf
;

181 
	}
}

185 
	$ngx_h‰p_deg¿d©iÚ_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

187 
ngx_h‰p_deg¿d©iÚ_loc_cÚf_t
 *
´ev
 = 
·»Á
;

188 
ngx_h‰p_deg¿d©iÚ_loc_cÚf_t
 *
cÚf
 = 
chžd
;

190 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
deg¿de
, 
´ev
->degrade, 0);

192  
NGX_CONF_OK
;

193 
	}
}

197 
	$ngx_h‰p_deg¿d©iÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

199 
ngx_h‰p_deg¿d©iÚ_maš_cÚf_t
 *
dmcf
 = 
cÚf
;

201 
ngx_¡r_t
 *
v®ue
, 
s
;

203 
v®ue
 = 
cf
->
¬gs
->
–ts
;

205 ià(
	`ngx_¡ºcmp
(
v®ue
[1].
d©a
, "sbrk=", 5) == 0) {

207 
s
.
Ën
 = 
v®ue
[1].len - 5;

208 
s
.
d©a
 = 
v®ue
[1].data + 5;

210 
dmcf
->
sbrk_size
 = 
	`ngx_·r£_size
(&
s
);

211 ià(
dmcf
->
sbrk_size
 =ð(
size_t
è
NGX_ERROR
) {

212 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

213 "šv®id sbrk siz\"%V\"", &
v®ue
[1]);

214  
NGX_CONF_ERROR
;

217  
NGX_CONF_OK
;

220 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

221 "šv®id…¬am‘” \"%V\"", &
v®ue
[1]);

223  
NGX_CONF_ERROR
;

224 
	}
}

227 
ngx_št_t


228 
	$ngx_h‰p_deg¿d©iÚ_š™
(
ngx_cÚf_t
 *
cf
)

230 
ngx_h‰p_hªdËr_±
 *
h
;

231 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

233 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

235 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_PREACCESS_PHASE
].
hªdËrs
);

236 ià(
h
 =ð
NULL
) {

237  
NGX_ERROR
;

240 *
h
 = 
ngx_h‰p_deg¿d©iÚ_hªdËr
;

242  
NGX_OK
;

243 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_empty_gif_module.c

7 
	~<ngx_cÚfig.h
>

8 
	~<ngx_cÜe.h
>

9 
	~<ngx_h‰p.h
>

12 *
ngx_h‰p_em±y_gif
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

13 *
cÚf
);

15 
ngx_commªd_t
 
	gngx_h‰p_em±y_gif_commªds
[] = {

17 { 
ngx_¡ršg
("empty_gif"),

18 
NGX_HTTP_LOC_CONF
|
NGX_CONF_NOARGS
,

19 
ngx_h‰p_em±y_gif
,

22 
NULL
 },

24 
ngx_nuÎ_commªd


30 
u_ch¬
 
	gngx_em±y_gif
[] = {

78 
ngx_h‰p_moduË_t
 
	gngx_h‰p_em±y_gif_moduË_ùx
 = {

79 
NULL
,

80 
NULL
,

82 
NULL
,

83 
NULL
,

85 
NULL
,

86 
NULL
,

88 
NULL
,

89 
NULL


93 
ngx_moduË_t
 
	gngx_h‰p_em±y_gif_moduË
 = {

94 
NGX_MODULE_V1
,

95 &
ngx_h‰p_em±y_gif_moduË_ùx
,

96 
ngx_h‰p_em±y_gif_commªds
,

97 
NGX_HTTP_MODULE
,

98 
NULL
,

99 
NULL
,

100 
NULL
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NGX_MODULE_V1_PADDING


109 
ngx_¡r_t
 
	gngx_h‰p_gif_ty³
 = 
ngx_¡ršg
("image/gif");

112 
ngx_št_t


113 
	$ngx_h‰p_em±y_gif_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

115 
ngx_h‰p_com¶ex_v®ue_t
 
cv
;

117 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
))) {

118  
NGX_HTTP_NOT_ALLOWED
;

121 
	`ngx_memz”o
(&
cv
, (
ngx_h‰p_com¶ex_v®ue_t
));

123 
cv
.
v®ue
.
Ën
 = (
ngx_em±y_gif
);

124 
cv
.
v®ue
.
d©a
 = 
ngx_em±y_gif
;

125 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = 23349600;

127  
	`ngx_h‰p_£nd_»¥Ú£
(
r
, 
NGX_HTTP_OK
, &
ngx_h‰p_gif_ty³
, &
cv
);

128 
	}
}

132 
	$ngx_h‰p_em±y_gif
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

134 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

136 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

137 
þcf
->
hªdËr
 = 
ngx_h‰p_em±y_gif_hªdËr
;

139  
NGX_CONF_OK
;

140 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_fastcgi_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_¬¿y_t
 *
	mæushes
;

15 
ngx_¬¿y_t
 *
	mËngths
;

16 
ngx_¬¿y_t
 *
	mv®ues
;

17 
ngx_ušt_t
 
	mnumb”
;

18 
ngx_hash_t
 
	mhash
;

19 } 
	tngx_h‰p_ç¡cgi_·¿ms_t
;

23 
ngx_h‰p_up¡»am_cÚf_t
 
	mup¡»am
;

25 
ngx_¡r_t
 
	mšdex
;

27 
ngx_h‰p_ç¡cgi_·¿ms_t
 
	m·¿ms
;

28 #ià(
NGX_HTTP_CACHE
)

29 
ngx_h‰p_ç¡cgi_·¿ms_t
 
	m·¿ms_ÿche
;

32 
ngx_¬¿y_t
 *
	m·¿ms_sourû
;

33 
ngx_¬¿y_t
 *
	mÿtch_¡d”r
;

35 
ngx_¬¿y_t
 *
	mç¡cgi_Ëngths
;

36 
ngx_¬¿y_t
 *
	mç¡cgi_v®ues
;

38 
ngx_æag_t
 
	mk“p_cÚn
;

40 #ià(
NGX_HTTP_CACHE
)

41 
ngx_h‰p_com¶ex_v®ue_t
 
	mÿche_key
;

44 #ià(
NGX_PCRE
)

45 
ngx_»gex_t
 *
	m¥l™_»gex
;

46 
ngx_¡r_t
 
	m¥l™_Çme
;

48 } 
	tngx_h‰p_ç¡cgi_loc_cÚf_t
;

52 
	mngx_h‰p_ç¡cgi_¡_v”siÚ
 = 0,

53 
	mngx_h‰p_ç¡cgi_¡_ty³
,

54 
	mngx_h‰p_ç¡cgi_¡_»que¡_id_hi
,

55 
	mngx_h‰p_ç¡cgi_¡_»que¡_id_lo
,

56 
	mngx_h‰p_ç¡cgi_¡_cÚ‹Á_Ëngth_hi
,

57 
	mngx_h‰p_ç¡cgi_¡_cÚ‹Á_Ëngth_lo
,

58 
	mngx_h‰p_ç¡cgi_¡_·ddšg_Ëngth
,

59 
	mngx_h‰p_ç¡cgi_¡_»£rved
,

60 
	mngx_h‰p_ç¡cgi_¡_d©a
,

61 
	mngx_h‰p_ç¡cgi_¡_·ddšg


62 } 
	tngx_h‰p_ç¡cgi_¡©e_e
;

66 
u_ch¬
 *
	m¡¬t
;

67 
u_ch¬
 *
	m’d
;

68 } 
	tngx_h‰p_ç¡cgi_¥l™_·¹_t
;

72 
ngx_h‰p_ç¡cgi_¡©e_e
 
	m¡©e
;

73 
u_ch¬
 *
	mpos
;

74 
u_ch¬
 *
	mÏ¡
;

75 
ngx_ušt_t
 
	mty³
;

76 
size_t
 
	mËngth
;

77 
size_t
 
	m·ddšg
;

79 
	mç¡cgi_¡dout
:1;

80 
	mÏrge_¡d”r
:1;

82 
ngx_¬¿y_t
 *
	m¥l™_·¹s
;

84 
ngx_¡r_t
 
	msüt_Çme
;

85 
ngx_¡r_t
 
	m·th_šfo
;

86 } 
	tngx_h‰p_ç¡cgi_ùx_t
;

89 
	#NGX_HTTP_FASTCGI_RESPONDER
 1

	)

91 
	#NGX_HTTP_FASTCGI_KEEP_CONN
 1

	)

93 
	#NGX_HTTP_FASTCGI_BEGIN_REQUEST
 1

	)

94 
	#NGX_HTTP_FASTCGI_ABORT_REQUEST
 2

	)

95 
	#NGX_HTTP_FASTCGI_END_REQUEST
 3

	)

96 
	#NGX_HTTP_FASTCGI_PARAMS
 4

	)

97 
	#NGX_HTTP_FASTCGI_STDIN
 5

	)

98 
	#NGX_HTTP_FASTCGI_STDOUT
 6

	)

99 
	#NGX_HTTP_FASTCGI_STDERR
 7

	)

100 
	#NGX_HTTP_FASTCGI_DATA
 8

	)

104 
u_ch¬
 
	mv”siÚ
;

105 
u_ch¬
 
	mty³
;

106 
u_ch¬
 
	m»que¡_id_hi
;

107 
u_ch¬
 
	m»que¡_id_lo
;

108 
u_ch¬
 
	mcÚ‹Á_Ëngth_hi
;

109 
u_ch¬
 
	mcÚ‹Á_Ëngth_lo
;

110 
u_ch¬
 
	m·ddšg_Ëngth
;

111 
u_ch¬
 
	m»£rved
;

112 } 
	tngx_h‰p_ç¡cgi_h—d”_t
;

116 
u_ch¬
 
	mrÞe_hi
;

117 
u_ch¬
 
	mrÞe_lo
;

118 
u_ch¬
 
	mæags
;

119 
u_ch¬
 
	m»£rved
[5];

120 } 
	tngx_h‰p_ç¡cgi_begš_»que¡_t
;

124 
u_ch¬
 
	mv”siÚ
;

125 
u_ch¬
 
	mty³
;

126 
u_ch¬
 
	m»que¡_id_hi
;

127 
u_ch¬
 
	m»que¡_id_lo
;

128 } 
	tngx_h‰p_ç¡cgi_h—d”_sm®l_t
;

132 
ngx_h‰p_ç¡cgi_h—d”_t
 
	mh0
;

133 
ngx_h‰p_ç¡cgi_begš_»que¡_t
 
	mbr
;

134 
ngx_h‰p_ç¡cgi_h—d”_sm®l_t
 
	mh1
;

135 } 
	tngx_h‰p_ç¡cgi_»que¡_¡¬t_t
;

138 
ngx_št_t
 
ngx_h‰p_ç¡cgi_ev®
(
ngx_h‰p_»que¡_t
 *
r
,

139 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
);

140 #ià(
NGX_HTTP_CACHE
)

141 
ngx_št_t
 
ngx_h‰p_ç¡cgi_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
);

143 
ngx_št_t
 
ngx_h‰p_ç¡cgi_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

144 
ngx_št_t
 
ngx_h‰p_ç¡cgi_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

145 
ngx_št_t
 
ngx_h‰p_ç¡cgi_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

146 
ngx_št_t
 
ngx_h‰p_ç¡cgi_šput_fž‹r_š™
(*
d©a
);

147 
ngx_št_t
 
ngx_h‰p_ç¡cgi_šput_fž‹r
(
ngx_ev’t_pe_t
 *
p
,

148 
ngx_buf_t
 *
buf
);

149 
ngx_št_t
 
ngx_h‰p_ç¡cgi_nÚ_bufã»d_fž‹r
(*
d©a
,

150 
ssize_t
 
by‹s
);

151 
ngx_št_t
 
ngx_h‰p_ç¡cgi_´oûss_»cÜd
(
ngx_h‰p_»que¡_t
 *
r
,

152 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
);

153 
ngx_h‰p_ç¡cgi_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

154 
ngx_h‰p_ç¡cgi_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

155 
ngx_št_t
 
rc
);

157 
ngx_št_t
 
ngx_h‰p_ç¡cgi_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

158 *
ngx_h‰p_ç¡cgi_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

159 *
ngx_h‰p_ç¡cgi_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

160 *
·»Á
, *
chžd
);

161 
ngx_št_t
 
ngx_h‰p_ç¡cgi_š™_·¿ms
(
ngx_cÚf_t
 *
cf
,

162 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
cÚf
, 
ngx_h‰p_ç¡cgi_·¿ms_t
 *
·¿ms
,

163 
ngx_keyv®_t
 *
deçuÉ_·¿ms
);

165 
ngx_št_t
 
ngx_h‰p_ç¡cgi_süt_Çme_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

166 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

167 
ngx_št_t
 
ngx_h‰p_ç¡cgi_·th_šfo_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

168 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

169 
ngx_h‰p_ç¡cgi_ùx_t
 *
ngx_h‰p_ç¡cgi_¥l™
(
ngx_h‰p_»que¡_t
 *
r
,

170 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
);

172 *
ngx_h‰p_ç¡cgi_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

173 *
cÚf
);

174 *
ngx_h‰p_ç¡cgi_¥l™_·th_šfo
(
ngx_cÚf_t
 *
cf
,

175 
ngx_commªd_t
 *
cmd
, *
cÚf
);

176 *
ngx_h‰p_ç¡cgi_¡Üe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

177 *
cÚf
);

178 #ià(
NGX_HTTP_CACHE
)

179 *
ngx_h‰p_ç¡cgi_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

180 *
cÚf
);

181 *
ngx_h‰p_ç¡cgi_ÿche_key
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

182 *
cÚf
);

185 *
ngx_h‰p_ç¡cgi_low©_check
(
ngx_cÚf_t
 *
cf
, *
po¡
,

186 *
d©a
);

189 
ngx_cÚf_po¡_t
 
	gngx_h‰p_ç¡cgi_low©_po¡
 =

190 { 
ngx_h‰p_ç¡cgi_low©_check
 };

193 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_ç¡cgi_Ãxt_up¡»am_masks
[] = {

194 { 
ngx_¡ršg
("”rÜ"), 
NGX_HTTP_UPSTREAM_FT_ERROR
 },

195 { 
ngx_¡ršg
("timeout"), 
NGX_HTTP_UPSTREAM_FT_TIMEOUT
 },

196 { 
ngx_¡ršg
("šv®id_h—d”"), 
NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
 },

197 { 
ngx_¡ršg
("h‰p_500"), 
NGX_HTTP_UPSTREAM_FT_HTTP_500
 },

198 { 
ngx_¡ršg
("h‰p_503"), 
NGX_HTTP_UPSTREAM_FT_HTTP_503
 },

199 { 
ngx_¡ršg
("h‰p_403"), 
NGX_HTTP_UPSTREAM_FT_HTTP_403
 },

200 { 
ngx_¡ršg
("h‰p_404"), 
NGX_HTTP_UPSTREAM_FT_HTTP_404
 },

201 { 
ngx_¡ršg
("upd©šg"), 
NGX_HTTP_UPSTREAM_FT_UPDATING
 },

202 { 
ngx_¡ršg
("off"), 
NGX_HTTP_UPSTREAM_FT_OFF
 },

203 { 
ngx_nuÎ_¡ršg
, 0 }

207 
ngx_moduË_t
 
	gngx_h‰p_ç¡cgi_moduË
;

210 
ngx_commªd_t
 
	gngx_h‰p_ç¡cgi_commªds
[] = {

212 { 
ngx_¡ršg
("fastcgi_pass"),

213 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF
|
NGX_CONF_TAKE1
,

214 
ngx_h‰p_ç¡cgi_·ss
,

215 
NGX_HTTP_LOC_CONF_OFFSET
,

217 
NULL
 },

219 { 
ngx_¡ršg
("fastcgi_index"),

220 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

221 
ngx_cÚf_£t_¡r_¦Ù
,

222 
NGX_HTTP_LOC_CONF_OFFSET
,

223 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
šdex
),

224 
NULL
 },

226 { 
ngx_¡ršg
("fastcgi_split_path_info"),

227 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

228 
ngx_h‰p_ç¡cgi_¥l™_·th_šfo
,

229 
NGX_HTTP_LOC_CONF_OFFSET
,

231 
NULL
 },

233 { 
ngx_¡ršg
("fastcgi_store"),

234 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

235 
ngx_h‰p_ç¡cgi_¡Üe
,

236 
NGX_HTTP_LOC_CONF_OFFSET
,

238 
NULL
 },

240 { 
ngx_¡ršg
("fastcgi_store_access"),

241 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE123
,

242 
ngx_cÚf_£t_acûss_¦Ù
,

243 
NGX_HTTP_LOC_CONF_OFFSET
,

244 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
¡Üe_acûss
),

245 
NULL
 },

247 { 
ngx_¡ršg
("fastcgi_buffering"),

248 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

249 
ngx_cÚf_£t_æag_¦Ù
,

250 
NGX_HTTP_LOC_CONF_OFFSET
,

251 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
bufãršg
),

252 
NULL
 },

254 { 
ngx_¡ršg
("fastcgi_ignore_client_abort"),

255 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

256 
ngx_cÚf_£t_æag_¦Ù
,

257 
NGX_HTTP_LOC_CONF_OFFSET
,

258 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ignÜe_þ›Á_abÜt
),

259 
NULL
 },

261 { 
ngx_¡ršg
("fastcgi_bind"),

262 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

263 
ngx_h‰p_up¡»am_bšd_£t_¦Ù
,

264 
NGX_HTTP_LOC_CONF_OFFSET
,

265 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
loÿl
),

266 
NULL
 },

268 { 
ngx_¡ršg
("fastcgi_connect_timeout"),

269 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

270 
ngx_cÚf_£t_m£c_¦Ù
,

271 
NGX_HTTP_LOC_CONF_OFFSET
,

272 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
cÚÃù_timeout
),

273 
NULL
 },

275 { 
ngx_¡ršg
("fastcgi_send_timeout"),

276 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

277 
ngx_cÚf_£t_m£c_¦Ù
,

278 
NGX_HTTP_LOC_CONF_OFFSET
,

279 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
£nd_timeout
),

280 
NULL
 },

282 { 
ngx_¡ršg
("fastcgi_send_lowat"),

283 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

284 
ngx_cÚf_£t_size_¦Ù
,

285 
NGX_HTTP_LOC_CONF_OFFSET
,

286 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
£nd_low©
),

287 &
ngx_h‰p_ç¡cgi_low©_po¡
 },

289 { 
ngx_¡ršg
("fastcgi_buffer_size"),

290 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

291 
ngx_cÚf_£t_size_¦Ù
,

292 
NGX_HTTP_LOC_CONF_OFFSET
,

293 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
bufãr_size
),

294 
NULL
 },

296 { 
ngx_¡ršg
("fastcgi_pass_request_headers"),

297 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

298 
ngx_cÚf_£t_æag_¦Ù
,

299 
NGX_HTTP_LOC_CONF_OFFSET
,

300 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
·ss_»que¡_h—d”s
),

301 
NULL
 },

303 { 
ngx_¡ršg
("fastcgi_pass_request_body"),

304 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

305 
ngx_cÚf_£t_æag_¦Ù
,

306 
NGX_HTTP_LOC_CONF_OFFSET
,

307 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
·ss_»que¡_body
),

308 
NULL
 },

310 { 
ngx_¡ršg
("fastcgi_intercept_errors"),

311 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

312 
ngx_cÚf_£t_æag_¦Ù
,

313 
NGX_HTTP_LOC_CONF_OFFSET
,

314 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
š‹rû±_”rÜs
),

315 
NULL
 },

317 { 
ngx_¡ršg
("fastcgi_read_timeout"),

318 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

319 
ngx_cÚf_£t_m£c_¦Ù
,

320 
NGX_HTTP_LOC_CONF_OFFSET
,

321 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
»ad_timeout
),

322 
NULL
 },

324 { 
ngx_¡ršg
("fastcgi_buffers"),

325 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

326 
ngx_cÚf_£t_bufs_¦Ù
,

327 
NGX_HTTP_LOC_CONF_OFFSET
,

328 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
bufs
),

329 
NULL
 },

331 { 
ngx_¡ršg
("fastcgi_busy_buffers_size"),

332 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

333 
ngx_cÚf_£t_size_¦Ù
,

334 
NGX_HTTP_LOC_CONF_OFFSET
,

335 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
busy_bufãrs_size_cÚf
),

336 
NULL
 },

338 { 
ngx_¡ršg
("fastcgi_force_ranges"),

339 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

340 
ngx_cÚf_£t_æag_¦Ù
,

341 
NGX_HTTP_LOC_CONF_OFFSET
,

342 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
fÜû_¿nges
),

343 
NULL
 },

345 { 
ngx_¡ršg
("fastcgi_limit_rate"),

346 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

347 
ngx_cÚf_£t_size_¦Ù
,

348 
NGX_HTTP_LOC_CONF_OFFSET
,

349 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
lim™_¿‹
),

350 
NULL
 },

352 #ià(
NGX_HTTP_CACHE
)

354 { 
ngx_¡ršg
("fastcgi_cache"),

355 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

356 
ngx_h‰p_ç¡cgi_ÿche
,

357 
NGX_HTTP_LOC_CONF_OFFSET
,

359 
NULL
 },

361 { 
ngx_¡ršg
("fastcgi_cache_key"),

362 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

363 
ngx_h‰p_ç¡cgi_ÿche_key
,

364 
NGX_HTTP_LOC_CONF_OFFSET
,

366 
NULL
 },

368 { 
ngx_¡ršg
("fastcgi_cache_path"),

369 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_2MORE
,

370 
ngx_h‰p_fže_ÿche_£t_¦Ù
,

373 &
ngx_h‰p_ç¡cgi_moduË
 },

375 { 
ngx_¡ršg
("fastcgi_cache_bypass"),

376 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

377 
ngx_h‰p_£t_´ediÿ‹_¦Ù
,

378 
NGX_HTTP_LOC_CONF_OFFSET
,

379 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_by·ss
),

380 
NULL
 },

382 { 
ngx_¡ršg
("fastcgi_no_cache"),

383 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

384 
ngx_h‰p_£t_´ediÿ‹_¦Ù
,

385 
NGX_HTTP_LOC_CONF_OFFSET
,

386 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
no_ÿche
),

387 
NULL
 },

389 { 
ngx_¡ršg
("fastcgi_cache_valid"),

390 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

391 
ngx_h‰p_fže_ÿche_v®id_£t_¦Ù
,

392 
NGX_HTTP_LOC_CONF_OFFSET
,

393 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_v®id
),

394 
NULL
 },

396 { 
ngx_¡ršg
("fastcgi_cache_min_uses"),

397 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

398 
ngx_cÚf_£t_num_¦Ù
,

399 
NGX_HTTP_LOC_CONF_OFFSET
,

400 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_mš_u£s
),

401 
NULL
 },

403 { 
ngx_¡ršg
("fastcgi_cache_use_stale"),

404 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

405 
ngx_cÚf_£t_b™mask_¦Ù
,

406 
NGX_HTTP_LOC_CONF_OFFSET
,

407 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_u£_¡®e
),

408 &
ngx_h‰p_ç¡cgi_Ãxt_up¡»am_masks
 },

410 { 
ngx_¡ršg
("fastcgi_cache_methods"),

411 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

412 
ngx_cÚf_£t_b™mask_¦Ù
,

413 
NGX_HTTP_LOC_CONF_OFFSET
,

414 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_m‘hods
),

415 &
ngx_h‰p_up¡»am_ÿche_m‘hod_mask
 },

417 { 
ngx_¡ršg
("fastcgi_cache_lock"),

418 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

419 
ngx_cÚf_£t_æag_¦Ù
,

420 
NGX_HTTP_LOC_CONF_OFFSET
,

421 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock
),

422 
NULL
 },

424 { 
ngx_¡ršg
("fastcgi_cache_lock_timeout"),

425 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

426 
ngx_cÚf_£t_m£c_¦Ù
,

427 
NGX_HTTP_LOC_CONF_OFFSET
,

428 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock_timeout
),

429 
NULL
 },

431 { 
ngx_¡ršg
("fastcgi_cache_lock_age"),

432 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

433 
ngx_cÚf_£t_m£c_¦Ù
,

434 
NGX_HTTP_LOC_CONF_OFFSET
,

435 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock_age
),

436 
NULL
 },

438 { 
ngx_¡ršg
("fastcgi_cache_revalidate"),

439 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

440 
ngx_cÚf_£t_æag_¦Ù
,

441 
NGX_HTTP_LOC_CONF_OFFSET
,

442 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ÿche_»v®id©e
),

443 
NULL
 },

447 { 
ngx_¡ršg
("fastcgi_temp_path"),

448 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1234
,

449 
ngx_cÚf_£t_·th_¦Ù
,

450 
NGX_HTTP_LOC_CONF_OFFSET
,

451 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
‹mp_·th
),

452 
NULL
 },

454 { 
ngx_¡ršg
("fastcgi_max_temp_file_size"),

455 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

456 
ngx_cÚf_£t_size_¦Ù
,

457 
NGX_HTTP_LOC_CONF_OFFSET
,

458 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
max_‹mp_fže_size_cÚf
),

459 
NULL
 },

461 { 
ngx_¡ršg
("fastcgi_temp_file_write_size"),

462 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

463 
ngx_cÚf_£t_size_¦Ù
,

464 
NGX_HTTP_LOC_CONF_OFFSET
,

465 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
‹mp_fže_wr™e_size_cÚf
),

466 
NULL
 },

468 { 
ngx_¡ršg
("fastcgi_next_upstream"),

469 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

470 
ngx_cÚf_£t_b™mask_¦Ù
,

471 
NGX_HTTP_LOC_CONF_OFFSET
,

472 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am
),

473 &
ngx_h‰p_ç¡cgi_Ãxt_up¡»am_masks
 },

475 { 
ngx_¡ršg
("fastcgi_next_upstream_tries"),

476 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

477 
ngx_cÚf_£t_num_¦Ù
,

478 
NGX_HTTP_LOC_CONF_OFFSET
,

479 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_Œ›s
),

480 
NULL
 },

482 { 
ngx_¡ršg
("fastcgi_next_upstream_timeout"),

483 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

484 
ngx_cÚf_£t_m£c_¦Ù
,

485 
NGX_HTTP_LOC_CONF_OFFSET
,

486 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_timeout
),

487 
NULL
 },

489 { 
ngx_¡ršg
("fastcgi_param"),

490 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE23
,

491 
ngx_h‰p_up¡»am_·¿m_£t_¦Ù
,

492 
NGX_HTTP_LOC_CONF_OFFSET
,

493 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
·¿ms_sourû
),

494 
NULL
 },

496 { 
ngx_¡ršg
("fastcgi_pass_header"),

497 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

498 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

499 
NGX_HTTP_LOC_CONF_OFFSET
,

500 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
·ss_h—d”s
),

501 
NULL
 },

503 { 
ngx_¡ršg
("fastcgi_hide_header"),

504 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

505 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

506 
NGX_HTTP_LOC_CONF_OFFSET
,

507 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
hide_h—d”s
),

508 
NULL
 },

510 { 
ngx_¡ršg
("fastcgi_ignore_headers"),

511 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

512 
ngx_cÚf_£t_b™mask_¦Ù
,

513 
NGX_HTTP_LOC_CONF_OFFSET
,

514 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
up¡»am
.
ignÜe_h—d”s
),

515 &
ngx_h‰p_up¡»am_ignÜe_h—d”s_masks
 },

517 { 
ngx_¡ršg
("fastcgi_catch_stderr"),

518 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

519 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

520 
NGX_HTTP_LOC_CONF_OFFSET
,

521 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
ÿtch_¡d”r
),

522 
NULL
 },

524 { 
ngx_¡ršg
("fastcgi_keep_conn"),

525 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

526 
ngx_cÚf_£t_æag_¦Ù
,

527 
NGX_HTTP_LOC_CONF_OFFSET
,

528 
off£tof
(
ngx_h‰p_ç¡cgi_loc_cÚf_t
, 
k“p_cÚn
),

529 
NULL
 },

531 
ngx_nuÎ_commªd


535 
ngx_h‰p_moduË_t
 
	gngx_h‰p_ç¡cgi_moduË_ùx
 = {

536 
ngx_h‰p_ç¡cgi_add_v¬ŸbËs
,

537 
NULL
,

539 
NULL
,

540 
NULL
,

542 
NULL
,

543 
NULL
,

545 
ngx_h‰p_ç¡cgi_ü—‹_loc_cÚf
,

546 
ngx_h‰p_ç¡cgi_m”ge_loc_cÚf


550 
ngx_moduË_t
 
	gngx_h‰p_ç¡cgi_moduË
 = {

551 
NGX_MODULE_V1
,

552 &
ngx_h‰p_ç¡cgi_moduË_ùx
,

553 
ngx_h‰p_ç¡cgi_commªds
,

554 
NGX_HTTP_MODULE
,

555 
NULL
,

556 
NULL
,

557 
NULL
,

558 
NULL
,

559 
NULL
,

560 
NULL
,

561 
NULL
,

562 
NGX_MODULE_V1_PADDING


566 
ngx_h‰p_ç¡cgi_»que¡_¡¬t_t
 
	gngx_h‰p_ç¡cgi_»que¡_¡¬t
 = {

568 
NGX_HTTP_FASTCGI_BEGIN_REQUEST
,

572 (
ngx_h‰p_ç¡cgi_begš_»que¡_t
),

577 
NGX_HTTP_FASTCGI_RESPONDER
,

582 
NGX_HTTP_FASTCGI_PARAMS
,

589 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_ç¡cgi_v¬s
[] = {

591 { 
ngx_¡ršg
("ç¡cgi_süt_Çme"), 
NULL
,

592 
ngx_h‰p_ç¡cgi_süt_Çme_v¬ŸbË
, 0,

593 
NGX_HTTP_VAR_NOCACHEABLE
|
NGX_HTTP_VAR_NOHASH
, 0 },

595 { 
ngx_¡ršg
("ç¡cgi_·th_šfo"), 
NULL
,

596 
ngx_h‰p_ç¡cgi_·th_šfo_v¬ŸbË
, 0,

597 
NGX_HTTP_VAR_NOCACHEABLE
|
NGX_HTTP_VAR_NOHASH
, 0 },

599 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

603 
ngx_¡r_t
 
	gngx_h‰p_ç¡cgi_hide_h—d”s
[] = {

604 
ngx_¡ršg
("Status"),

605 
ngx_¡ršg
("X-Accel-Expires"),

606 
ngx_¡ršg
("X-Accel-Redirect"),

607 
ngx_¡ršg
("X-Accel-Limit-Rate"),

608 
ngx_¡ršg
("X-Accel-Buffering"),

609 
ngx_¡ršg
("X-Accel-Charset"),

610 
ngx_nuÎ_¡ršg


614 #ià(
NGX_HTTP_CACHE
)

616 
ngx_keyv®_t
 
	gngx_h‰p_ç¡cgi_ÿche_h—d”s
[] = {

617 { 
ngx_¡ršg
("HTTP_IF_MODIFIED_SINCE"),

618 
ngx_¡ršg
("$upstream_cache_last_modified") },

619 { 
ngx_¡ršg
("HTTP_IF_UNMODIFIED_SINCE"),‚gx_string("") },

620 { 
ngx_¡ršg
("HTTP_IF_NONE_MATCH"),‚gx_string("$upstream_cache_etag") },

621 { 
ngx_¡ršg
("HTTP_IF_MATCH"),‚gx_string("") },

622 { 
ngx_¡ršg
("HTTP_RANGE"),‚gx_string("") },

623 { 
ngx_¡ršg
("HTTP_IF_RANGE"),‚gx_string("") },

624 { 
ngx_nuÎ_¡ršg
,‚gx_null_string }

630 
ngx_·th_š™_t
 
	gngx_h‰p_ç¡cgi_‹mp_·th
 = {

631 
ngx_¡ršg
(
NGX_HTTP_FASTCGI_TEMP_PATH
), { 1, 2, 0 }

635 
ngx_št_t


636 
	$ngx_h‰p_ç¡cgi_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

638 
ngx_št_t
 
rc
;

639 
ngx_h‰p_up¡»am_t
 *
u
;

640 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
;

641 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
;

643 ià(
	`ngx_h‰p_up¡»am_ü—‹
(
r
è!ð
NGX_OK
) {

644  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

647 
f
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_ç¡cgi_ùx_t
));

648 ià(
f
 =ð
NULL
) {

649  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

652 
	`ngx_h‰p_£t_ùx
(
r
, 
f
, 
ngx_h‰p_ç¡cgi_moduË
);

654 
æcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

656 ià(
æcf
->
ç¡cgi_Ëngths
) {

657 ià(
	`ngx_h‰p_ç¡cgi_ev®
(
r
, 
æcf
è!ð
NGX_OK
) {

658  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

662 
u
 = 
r
->
up¡»am
;

664 
	`ngx_¡r_£t
(&
u
->
schema
, "fastcgi://");

665 
u
->
ouut
.
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_ç¡cgi_moduË
;

667 
u
->
cÚf
 = &
æcf
->
up¡»am
;

669 #ià(
NGX_HTTP_CACHE
)

670 
u
->
ü—‹_key
 = 
ngx_h‰p_ç¡cgi_ü—‹_key
;

672 
u
->
ü—‹_»que¡
 = 
ngx_h‰p_ç¡cgi_ü—‹_»que¡
;

673 
u
->
»š™_»que¡
 = 
ngx_h‰p_ç¡cgi_»š™_»que¡
;

674 
u
->
´oûss_h—d”
 = 
ngx_h‰p_ç¡cgi_´oûss_h—d”
;

675 
u
->
abÜt_»que¡
 = 
ngx_h‰p_ç¡cgi_abÜt_»que¡
;

676 
u
->
fš®ize_»que¡
 = 
ngx_h‰p_ç¡cgi_fš®ize_»que¡
;

677 
r
->
¡©e
 = 0;

679 
u
->
bufãršg
 = 
æcf
->
up¡»am
.buffering;

681 
u
->
pe
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_ev’t_pe_t
));

682 ià(
u
->
pe
 =ð
NULL
) {

683  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

686 
u
->
pe
->
šput_fž‹r
 = 
ngx_h‰p_ç¡cgi_šput_fž‹r
;

687 
u
->
pe
->
šput_ùx
 = 
r
;

689 
u
->
šput_fž‹r_š™
 = 
ngx_h‰p_ç¡cgi_šput_fž‹r_š™
;

690 
u
->
šput_fž‹r
 = 
ngx_h‰p_ç¡cgi_nÚ_bufã»d_fž‹r
;

691 
u
->
šput_fž‹r_ùx
 = 
r
;

693 
rc
 = 
	`ngx_h‰p_»ad_þ›Á_»que¡_body
(
r
, 
ngx_h‰p_up¡»am_š™
);

695 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

696  
rc
;

699  
NGX_DONE
;

700 
	}
}

703 
ngx_št_t


704 
	$ngx_h‰p_ç¡cgi_ev®
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
)

706 
ngx_u¾_t
 
u¾
;

707 
ngx_h‰p_up¡»am_t
 *
u
;

709 
	`ngx_memz”o
(&
u¾
, (
ngx_u¾_t
));

711 ià(
	`ngx_h‰p_süt_run
(
r
, &
u¾
.u¾, 
æcf
->
ç¡cgi_Ëngths
->
–ts
, 0,

712 
æcf
->
ç¡cgi_v®ues
->
–ts
)

713 =ð
NULL
)

715  
NGX_ERROR
;

718 
u¾
.
no_»sÞve
 = 1;

720 ià(
	`ngx_·r£_u¾
(
r
->
poÞ
, &
u¾
è!ð
NGX_OK
) {

721 ià(
u¾
.
”r
) {

722 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

723 "% š up¡»am \"%V\"", 
u¾
.
”r
, &url.url);

726  
NGX_ERROR
;

729 
u
 = 
r
->
up¡»am
;

731 
u
->
»sÞved
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_»sÞved_t
));

732 ià(
u
->
»sÞved
 =ð
NULL
) {

733  
NGX_ERROR
;

736 ià(
u¾
.
addrs
 && u¾.addrs[0].
sockaddr
) {

737 
u
->
»sÞved
->
sockaddr
 = 
u¾
.
addrs
[0].sockaddr;

738 
u
->
»sÞved
->
sockËn
 = 
u¾
.
addrs
[0].socklen;

739 
u
->
»sÞved
->
Çddrs
 = 1;

740 
u
->
»sÞved
->
ho¡
 = 
u¾
.
addrs
[0].
Çme
;

743 
u
->
»sÞved
->
ho¡
 = 
u¾
.host;

744 
u
->
»sÞved
->
pÜt
 = 
u¾
.port;

745 
u
->
»sÞved
->
no_pÜt
 = 
u¾
.no_port;

748  
NGX_OK
;

749 
	}
}

752 #ià(
NGX_HTTP_CACHE
)

754 
ngx_št_t


755 
	$ngx_h‰p_ç¡cgi_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
)

757 
ngx_¡r_t
 *
key
;

758 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
;

760 
key
 = 
	`ngx_¬¿y_push
(&
r
->
ÿche
->
keys
);

761 ià(
key
 =ð
NULL
) {

762  
NGX_ERROR
;

765 
æcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

767 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
æcf
->
ÿche_key
, 
key
è!ð
NGX_OK
) {

768  
NGX_ERROR
;

771  
NGX_OK
;

772 
	}
}

777 
ngx_št_t


778 
	$ngx_h‰p_ç¡cgi_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

780 
off_t
 
fže_pos
;

781 
u_ch¬
 
ch
, *
pos
, *
lowÿ£_key
;

782 
size_t
 
size
, 
Ën
, 
key_Ën
, 
v®_Ën
, 
·ddšg
,

783 
®loÿ‹d
;

784 
ngx_ušt_t
 
i
, 
n
, 
Ãxt
, 
hash
, 
sk_em±y
, 
h—d”_·¿ms
;

785 
ngx_buf_t
 *
b
;

786 
ngx_chaš_t
 *
þ
, *
body
;

787 
ngx_li¡_·¹_t
 *
·¹
;

788 
ngx_bË_–t_t
 *
h—d”
, **
ignÜed
;

789 
ngx_h‰p_süt_code_±
 
code
;

790 
ngx_h‰p_süt_’gše_t
 
e
, 
Ë
;

791 
ngx_h‰p_ç¡cgi_h—d”_t
 *
h
;

792 
ngx_h‰p_ç¡cgi_·¿ms_t
 *
·¿ms
;

793 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
;

794 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

796 
Ën
 = 0;

797 
h—d”_·¿ms
 = 0;

798 
ignÜed
 = 
NULL
;

800 
æcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

802 #ià(
NGX_HTTP_CACHE
)

803 
·¿ms
 = 
r
->
up¡»am
->
ÿch—bË
 ? &
æcf
->
·¿ms_ÿche
 : &flcf->params;

805 
·¿ms
 = &
æcf
->params;

808 ià(
·¿ms
->
Ëngths
) {

809 
	`ngx_memz”o
(&
Ë
, (
ngx_h‰p_süt_’gše_t
));

811 
	`ngx_h‰p_süt_æush_no_ÿch—bË_v¬ŸbËs
(
r
, 
·¿ms
->
æushes
);

812 
Ë
.
æushed
 = 1;

814 
Ë
.

 = 
·¿ms
->
Ëngths
->
–ts
;

815 
Ë
.
»que¡
 = 
r
;

817 *(
ušŒ_t
 *è
Ë
.

) {

819 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

820 
key_Ën
 = 
	`lcode
(&
Ë
);

822 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

823 
sk_em±y
 = 
	`lcode
(&
Ë
);

825 
v®_Ën
 = 0; *(
ušŒ_t
 *è
Ë
.

; v®_ËÀ+ð
	`lcode
(&le)) {

826 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

828 
Ë
.

 +ð(
ušŒ_t
);

830 ià(
sk_em±y
 && 
v®_Ën
 == 0) {

834 
Ën
 +ð1 + 
key_Ën
 + ((
v®_Ën
 > 127) ? 4 : 1) + val_len;

838 ià(
æcf
->
up¡»am
.
·ss_»que¡_h—d”s
) {

840 
®loÿ‹d
 = 0;

841 
lowÿ£_key
 = 
NULL
;

843 ià(
·¿ms
->
numb”
) {

844 
n
 = 0;

845 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

847 
·¹
) {

848 
n
 +ð
·¹
->
ÃÉs
;

849 
·¹
 =…¬t->
Ãxt
;

852 
ignÜed
 = 
	`ngx_·Îoc
(
r
->
poÞ
, 
n
 * (*));

853 ià(
ignÜed
 =ð
NULL
) {

854  
NGX_ERROR
;

858 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

859 
h—d”
 = 
·¹
->
–ts
;

861 
i
 = 0; ; i++) {

863 ià(
i
 >ð
·¹
->
ÃÉs
) {

864 ià(
·¹
->
Ãxt
 =ð
NULL
) {

868 
·¹
 =…¬t->
Ãxt
;

869 
h—d”
 = 
·¹
->
–ts
;

870 
i
 = 0;

873 ià(
·¿ms
->
numb”
) {

874 ià(
®loÿ‹d
 < 
h—d”
[
i
].
key
.
Ën
) {

875 
®loÿ‹d
 = 
h—d”
[
i
].
key
.
Ën
 + 16;

876 
lowÿ£_key
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
®loÿ‹d
);

877 ià(
lowÿ£_key
 =ð
NULL
) {

878  
NGX_ERROR
;

882 
hash
 = 0;

884 
n
 = 0;‚ < 
h—d”
[
i
].
key
.
Ën
;‚++) {

885 
ch
 = 
h—d”
[
i
].
key
.
d©a
[
n
];

887 ià(
ch
 >= 'A' && ch <= 'Z') {

888 
ch
 |= 0x20;

890 } ià(
ch
 == '-') {

891 
ch
 = '_';

894 
hash
 = 
	`ngx_hash
(hash, 
ch
);

895 
lowÿ£_key
[
n
] = 
ch
;

898 ià(
	`ngx_hash_fšd
(&
·¿ms
->
hash
, hash, 
lowÿ£_key
, 
n
)) {

899 
ignÜed
[
h—d”_·¿ms
++] = &
h—d”
[
i
];

903 
n
 += ("HTTP_") - 1;

906 
n
 = ("HTTP_"è- 1 + 
h—d”
[
i
].
key
.
Ën
;

909 
Ën
 +ð((
n
 > 127è? 4 : 1è+ ((
h—d”
[
i
].
v®ue
.len > 127) ? 4 : 1)

910 + 
n
 + 
h—d”
[
i
].
v®ue
.
Ën
;

915 ià(
Ën
 > 65535) {

916 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

917 "ç¡cg˜»que¡„ecÜd i toØbig: %uz", 
Ën
);

918  
NGX_ERROR
;

922 
·ddšg
 = 8 - 
Ën
 % 8;

923 
·ddšg
 = (padding == 8) ? 0 :…adding;

926 
size
 = (
ngx_h‰p_ç¡cgi_h—d”_t
)

927 + (
ngx_h‰p_ç¡cgi_begš_»que¡_t
)

929 + (
ngx_h‰p_ç¡cgi_h—d”_t
)

930 + 
Ën
 + 
·ddšg


931 + (
ngx_h‰p_ç¡cgi_h—d”_t
)

933 + (
ngx_h‰p_ç¡cgi_h—d”_t
);

936 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
size
);

937 ià(
b
 =ð
NULL
) {

938  
NGX_ERROR
;

941 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

942 ià(
þ
 =ð
NULL
) {

943  
NGX_ERROR
;

946 
þ
->
buf
 = 
b
;

948 
ngx_h‰p_ç¡cgi_»que¡_¡¬t
.
br
.
æags
 =

949 
æcf
->
k“p_cÚn
 ? 
NGX_HTTP_FASTCGI_KEEP_CONN
 : 0;

951 
	`ngx_memýy
(
b
->
pos
, &
ngx_h‰p_ç¡cgi_»que¡_¡¬t
,

952 (
ngx_h‰p_ç¡cgi_»que¡_¡¬t_t
));

954 
h
 = (
ngx_h‰p_ç¡cgi_h—d”_t
 *)

955 (
b
->
pos
 + (
ngx_h‰p_ç¡cgi_h—d”_t
)

956 + (
ngx_h‰p_ç¡cgi_begš_»que¡_t
));

958 
h
->
cÚ‹Á_Ëngth_hi
 = (
u_ch¬
è((
Ën
 >> 8) & 0xff);

959 
h
->
cÚ‹Á_Ëngth_lo
 = (
u_ch¬
è(
Ën
 & 0xff);

960 
h
->
·ddšg_Ëngth
 = (
u_ch¬
è
·ddšg
;

961 
h
->
»£rved
 = 0;

963 
b
->
Ï¡
 = b->
pos
 + (
ngx_h‰p_ç¡cgi_h—d”_t
)

964 + (
ngx_h‰p_ç¡cgi_begš_»que¡_t
)

965 + (
ngx_h‰p_ç¡cgi_h—d”_t
);

968 ià(
·¿ms
->
Ëngths
) {

969 
	`ngx_memz”o
(&
e
, (
ngx_h‰p_süt_’gše_t
));

971 
e
.

 = 
·¿ms
->
v®ues
->
–ts
;

972 
e
.
pos
 = 
b
->
Ï¡
;

973 
e
.
»que¡
 = 
r
;

974 
e
.
æushed
 = 1;

976 
Ë
.

 = 
·¿ms
->
Ëngths
->
–ts
;

978 *(
ušŒ_t
 *è
Ë
.

) {

980 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

981 
key_Ën
 = (
u_ch¬
è
	`lcode
(&
Ë
);

983 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

984 
sk_em±y
 = 
	`lcode
(&
Ë
);

986 
v®_Ën
 = 0; *(
ušŒ_t
 *è
Ë
.

; v®_ËÀ+ð
	`lcode
(&le)) {

987 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

989 
Ë
.

 +ð(
ušŒ_t
);

991 ià(
sk_em±y
 && 
v®_Ën
 == 0) {

992 
e
.
sk
 = 1;

994 *(
ušŒ_t
 *è
e
.

) {

995 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

996 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

998 
e
.

 +ð(
ušŒ_t
);

1000 
e
.
sk
 = 0;

1005 *
e
.
pos
++ = (
u_ch¬
è
key_Ën
;

1007 ià(
v®_Ën
 > 127) {

1008 *
e
.
pos
++ = (
u_ch¬
è(((
v®_Ën
 >> 24) & 0x7f) | 0x80);

1009 *
e
.
pos
++ = (
u_ch¬
è((
v®_Ën
 >> 16) & 0xff);

1010 *
e
.
pos
++ = (
u_ch¬
è((
v®_Ën
 >> 8) & 0xff);

1011 *
e
.
pos
++ = (
u_ch¬
è(
v®_Ën
 & 0xff);

1014 *
e
.
pos
++ = (
u_ch¬
è
v®_Ën
;

1017 *(
ušŒ_t
 *è
e
.

) {

1018 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

1019 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

1021 
e
.

 +ð(
ušŒ_t
);

1023 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1025 
key_Ën
, 
e
.
pos
 - (key_ËÀ+ 
v®_Ën
),

1026 
v®_Ën
, 
e
.
pos
 - val_len);

1029 
b
->
Ï¡
 = 
e
.
pos
;

1033 ià(
æcf
->
up¡»am
.
·ss_»que¡_h—d”s
) {

1035 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

1036 
h—d”
 = 
·¹
->
–ts
;

1038 
i
 = 0; ; i++) {

1040 ià(
i
 >ð
·¹
->
ÃÉs
) {

1041 ià(
·¹
->
Ãxt
 =ð
NULL
) {

1045 
·¹
 =…¬t->
Ãxt
;

1046 
h—d”
 = 
·¹
->
–ts
;

1047 
i
 = 0;

1050 
n
 = 0;‚ < 
h—d”_·¿ms
;‚++) {

1051 ià(&
h—d”
[
i
] =ð
ignÜed
[
n
]) {

1052 
Ãxt
;

1056 
key_Ën
 = ("HTTP_"è- 1 + 
h—d”
[
i
].
key
.
Ën
;

1057 ià(
key_Ën
 > 127) {

1058 *
b
->
Ï¡
++ = (
u_ch¬
è(((
key_Ën
 >> 24) & 0x7f) | 0x80);

1059 *
b
->
Ï¡
++ = (
u_ch¬
è((
key_Ën
 >> 16) & 0xff);

1060 *
b
->
Ï¡
++ = (
u_ch¬
è((
key_Ën
 >> 8) & 0xff);

1061 *
b
->
Ï¡
++ = (
u_ch¬
è(
key_Ën
 & 0xff);

1064 *
b
->
Ï¡
++ = (
u_ch¬
è
key_Ën
;

1067 
v®_Ën
 = 
h—d”
[
i
].
v®ue
.
Ën
;

1068 ià(
v®_Ën
 > 127) {

1069 *
b
->
Ï¡
++ = (
u_ch¬
è(((
v®_Ën
 >> 24) & 0x7f) | 0x80);

1070 *
b
->
Ï¡
++ = (
u_ch¬
è((
v®_Ën
 >> 16) & 0xff);

1071 *
b
->
Ï¡
++ = (
u_ch¬
è((
v®_Ën
 >> 8) & 0xff);

1072 *
b
->
Ï¡
++ = (
u_ch¬
è(
v®_Ën
 & 0xff);

1075 *
b
->
Ï¡
++ = (
u_ch¬
è
v®_Ën
;

1078 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "HTTP_", ("HTTP_") - 1);

1080 
n
 = 0;‚ < 
h—d”
[
i
].
key
.
Ën
;‚++) {

1081 
ch
 = 
h—d”
[
i
].
key
.
d©a
[
n
];

1083 ià(
ch
 >= 'a' && ch <= 'z') {

1084 
ch
 &= ~0x20;

1086 } ià(
ch
 == '-') {

1087 
ch
 = '_';

1090 *
b
->
Ï¡
++ = 
ch
;

1093 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
h—d”
[
i
].
v®ue
.
d©a
, 
v®_Ën
);

1095 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1097 
key_Ën
, 
b
->
Ï¡
 - (key_ËÀ+ 
v®_Ën
),

1098 
v®_Ën
, 
b
->
Ï¡
 - val_len);

1099 
Ãxt
:

1106 ià(
·ddšg
) {

1107 
	`ngx_memz”o
(
b
->
Ï¡
, 
·ddšg
);

1108 
b
->
Ï¡
 +ð
·ddšg
;

1112 
h
 = (
ngx_h‰p_ç¡cgi_h—d”_t
 *è
b
->
Ï¡
;

1113 
b
->
Ï¡
 +ð(
ngx_h‰p_ç¡cgi_h—d”_t
);

1115 
h
->
v”siÚ
 = 1;

1116 
h
->
ty³
 = 
NGX_HTTP_FASTCGI_PARAMS
;

1117 
h
->
»que¡_id_hi
 = 0;

1118 
h
->
»que¡_id_lo
 = 1;

1119 
h
->
cÚ‹Á_Ëngth_hi
 = 0;

1120 
h
->
cÚ‹Á_Ëngth_lo
 = 0;

1121 
h
->
·ddšg_Ëngth
 = 0;

1122 
h
->
»£rved
 = 0;

1124 
h
 = (
ngx_h‰p_ç¡cgi_h—d”_t
 *è
b
->
Ï¡
;

1125 
b
->
Ï¡
 +ð(
ngx_h‰p_ç¡cgi_h—d”_t
);

1127 ià(
æcf
->
up¡»am
.
·ss_»que¡_body
) {

1128 
body
 = 
r
->
up¡»am
->
»que¡_bufs
;

1129 
r
->
up¡»am
->
»que¡_bufs
 = 
þ
;

1131 #ià(
NGX_SUPPRESS_WARN
)

1132 
fže_pos
 = 0;

1133 
pos
 = 
NULL
;

1136 
body
) {

1138 ià(
body
->
buf
->
š_fže
) {

1139 
fže_pos
 = 
body
->
buf
->file_pos;

1142 
pos
 = 
body
->
buf
->pos;

1145 
Ãxt
 = 0;

1148 
b
 = 
	`ngx_®loc_buf
(
r
->
poÞ
);

1149 ià(
b
 =ð
NULL
) {

1150  
NGX_ERROR
;

1153 
	`ngx_memýy
(
b
, 
body
->
buf
, (
ngx_buf_t
));

1155 ià(
body
->
buf
->
š_fže
) {

1156 
b
->
fže_pos
 = file_pos;

1157 
fže_pos
 += 32 * 1024;

1159 ià(
fže_pos
 >ð
body
->
buf
->
fže_Ï¡
) {

1160 
fže_pos
 = 
body
->
buf
->
fže_Ï¡
;

1161 
Ãxt
 = 1;

1164 
b
->
fže_Ï¡
 = 
fže_pos
;

1165 
Ën
 = (
ngx_ušt_t
è(
fže_pos
 - 
b
->file_pos);

1168 
b
->
pos
 =…os;

1169 
b
->
¡¬t
 = 
pos
;

1170 
pos
 += 32 * 1024;

1172 ià(
pos
 >ð
body
->
buf
->
Ï¡
) {

1173 
pos
 = 
body
->
buf
->
Ï¡
;

1174 
Ãxt
 = 1;

1177 
b
->
Ï¡
 = 
pos
;

1178 
Ën
 = (
ngx_ušt_t
è(
pos
 - 
b
->pos);

1181 
·ddšg
 = 8 - 
Ën
 % 8;

1182 
·ddšg
 = (padding == 8) ? 0 :…adding;

1184 
h
->
v”siÚ
 = 1;

1185 
h
->
ty³
 = 
NGX_HTTP_FASTCGI_STDIN
;

1186 
h
->
»que¡_id_hi
 = 0;

1187 
h
->
»que¡_id_lo
 = 1;

1188 
h
->
cÚ‹Á_Ëngth_hi
 = (
u_ch¬
è((
Ën
 >> 8) & 0xff);

1189 
h
->
cÚ‹Á_Ëngth_lo
 = (
u_ch¬
è(
Ën
 & 0xff);

1190 
h
->
·ddšg_Ëngth
 = (
u_ch¬
è
·ddšg
;

1191 
h
->
»£rved
 = 0;

1193 
þ
->
Ãxt
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

1194 ià(
þ
->
Ãxt
 =ð
NULL
) {

1195  
NGX_ERROR
;

1198 
þ
 = cl->
Ãxt
;

1199 
þ
->
buf
 = 
b
;

1201 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
,

1202 (
ngx_h‰p_ç¡cgi_h—d”_t
)

1203 + 
·ddšg
);

1204 ià(
b
 =ð
NULL
) {

1205  
NGX_ERROR
;

1208 ià(
·ddšg
) {

1209 
	`ngx_memz”o
(
b
->
Ï¡
, 
·ddšg
);

1210 
b
->
Ï¡
 +ð
·ddšg
;

1213 
h
 = (
ngx_h‰p_ç¡cgi_h—d”_t
 *è
b
->
Ï¡
;

1214 
b
->
Ï¡
 +ð(
ngx_h‰p_ç¡cgi_h—d”_t
);

1216 
þ
->
Ãxt
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

1217 ià(
þ
->
Ãxt
 =ð
NULL
) {

1218  
NGX_ERROR
;

1221 
þ
 = cl->
Ãxt
;

1222 
þ
->
buf
 = 
b
;

1224 } !
Ãxt
);

1226 
body
 = body->
Ãxt
;

1230 
r
->
up¡»am
->
»que¡_bufs
 = 
þ
;

1233 
h
->
v”siÚ
 = 1;

1234 
h
->
ty³
 = 
NGX_HTTP_FASTCGI_STDIN
;

1235 
h
->
»que¡_id_hi
 = 0;

1236 
h
->
»que¡_id_lo
 = 1;

1237 
h
->
cÚ‹Á_Ëngth_hi
 = 0;

1238 
h
->
cÚ‹Á_Ëngth_lo
 = 0;

1239 
h
->
·ddšg_Ëngth
 = 0;

1240 
h
->
»£rved
 = 0;

1242 
þ
->
Ãxt
 = 
NULL
;

1244  
NGX_OK
;

1245 
	}
}

1248 
ngx_št_t


1249 
	$ngx_h‰p_ç¡cgi_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

1251 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
;

1253 
f
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

1255 ià(
f
 =ð
NULL
) {

1256  
NGX_OK
;

1259 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_v”siÚ
;

1260 
f
->
ç¡cgi_¡dout
 = 0;

1261 
f
->
Ïrge_¡d”r
 = 0;

1263 ià(
f
->
¥l™_·¹s
) {

1264 
f
->
¥l™_·¹s
->
ÃÉs
 = 0;

1267 
r
->
¡©e
 = 0;

1269  
NGX_OK
;

1270 
	}
}

1273 
ngx_št_t


1274 
	$ngx_h‰p_ç¡cgi_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

1276 
u_ch¬
 *
p
, *
msg
, *
¡¬t
, *
Ï¡
,

1277 *
·¹_¡¬t
, *
·¹_’d
;

1278 
size_t
 
size
;

1279 
ngx_¡r_t
 *
¡©us_lše
, *
·‰”n
;

1280 
ngx_št_t
 
rc
, 
¡©us
;

1281 
ngx_buf_t
 
buf
;

1282 
ngx_ušt_t
 
i
;

1283 
ngx_bË_–t_t
 *
h
;

1284 
ngx_h‰p_up¡»am_t
 *
u
;

1285 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
;

1286 
ngx_h‰p_up¡»am_h—d”_t
 *
hh
;

1287 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
;

1288 
ngx_h‰p_ç¡cgi_¥l™_·¹_t
 *
·¹
;

1289 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

1291 
f
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

1293 
umcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_up¡»am_moduË
);

1295 
u
 = 
r
->
up¡»am
;

1299 ià(
f
->
¡©e
 < 
ngx_h‰p_ç¡cgi_¡_d©a
) {

1301 
f
->
pos
 = 
u
->
bufãr
.pos;

1302 
f
->
Ï¡
 = 
u
->
bufãr
.last;

1304 
rc
 = 
	`ngx_h‰p_ç¡cgi_´oûss_»cÜd
(
r
, 
f
);

1306 
u
->
bufãr
.
pos
 = 
f
->pos;

1307 
u
->
bufãr
.
Ï¡
 = 
f
->last;

1309 ià(
rc
 =ð
NGX_AGAIN
) {

1310  
NGX_AGAIN
;

1313 ià(
rc
 =ð
NGX_ERROR
) {

1314  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1317 ià(
f
->
ty³
 !ð
NGX_HTTP_FASTCGI_STDOUT


1318 && 
f
->
ty³
 !ð
NGX_HTTP_FASTCGI_STDERR
)

1320 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1322 
f
->
ty³
);

1324  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1327 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_STDOUT
 && f->
Ëngth
 == 0) {

1328 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1331  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1335 ià(
f
->
¡©e
 =ð
ngx_h‰p_ç¡cgi_¡_·ddšg
) {

1337 ià(
u
->
bufãr
.
pos
 + 
f
->
·ddšg
 < u->bufãr.
Ï¡
) {

1338 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_v”siÚ
;

1339 
u
->
bufãr
.
pos
 +ð
f
->
·ddšg
;

1344 ià(
u
->
bufãr
.
pos
 + 
f
->
·ddšg
 =ðu->bufãr.
Ï¡
) {

1345 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_v”siÚ
;

1346 
u
->
bufãr
.
pos
 = u->bufãr.
Ï¡
;

1348  
NGX_AGAIN
;

1351 
f
->
·ddšg
 -ð
u
->
bufãr
.
Ï¡
 - u->bufãr.
pos
;

1352 
u
->
bufãr
.
pos
 = u->bufãr.
Ï¡
;

1354  
NGX_AGAIN
;

1360 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_STDERR
) {

1362 ià(
f
->
Ëngth
) {

1363 
msg
 = 
u
->
bufãr
.
pos
;

1365 ià(
u
->
bufãr
.
pos
 + 
f
->
Ëngth
 <ðu->bufãr.
Ï¡
) {

1366 
u
->
bufãr
.
pos
 +ð
f
->
Ëngth
;

1367 
f
->
Ëngth
 = 0;

1368 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

1371 
f
->
Ëngth
 -ð
u
->
bufãr
.
Ï¡
 - u->bufãr.
pos
;

1372 
u
->
bufãr
.
pos
 = u->bufãr.
Ï¡
;

1375 
p
 = 
u
->
bufãr
.
pos
 - 1; 
msg
 <…;…--) {

1376 ià(*
p
 !ð
LF
 && *°!ð
CR
 && *p != '.' && *p != ' ') {

1381 
p
++;

1383 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1384 "Fa¡CGI s’ˆš std”r: \"%*s\"", 
p
 - 
msg
, msg);

1386 
æcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

1388 ià(
æcf
->
ÿtch_¡d”r
) {

1389 
·‰”n
 = 
æcf
->
ÿtch_¡d”r
->
–ts
;

1391 
i
 = 0; i < 
æcf
->
ÿtch_¡d”r
->
ÃÉs
; i++) {

1392 ià(
	`ngx_¡º¡r
(
msg
, (*è
·‰”n
[
i
].
d©a
,

1393 
p
 - 
msg
)

1394 !ð
NULL
)

1396  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1401 ià(
u
->
bufãr
.
pos
 =ðu->bufãr.
Ï¡
) {

1403 ià(!
f
->
ç¡cgi_¡dout
) {

1410 #ià(
NGX_HTTP_CACHE
)

1411 ià(
r
->
ÿche
) {

1412 
u
->
bufãr
.
pos
 = u->bufãr.
¡¬t


1413 + 
r
->
ÿche
->
h—d”_¡¬t
;

1415 
u
->
bufãr
.
pos
 = u->bufãr.
¡¬t
;

1418 
u
->
bufãr
.
pos
 = u->bufãr.
¡¬t
;

1420 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
;

1421 
f
->
Ïrge_¡d”r
 = 1;

1424  
NGX_AGAIN
;

1428 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

1437 #ià(
NGX_HTTP_CACHE
)

1439 ià(
f
->
Ïrge_¡d”r
 && 
r
->
ÿche
) {

1440 
u_ch¬
 *
¡¬t
;

1441 
ssize_t
 
Ën
;

1442 
ngx_h‰p_ç¡cgi_h—d”_t
 *
fh
;

1444 
¡¬t
 = 
u
->
bufãr
.¡¬ˆ+ 
r
->
ÿche
->
h—d”_¡¬t
;

1446 
Ën
 = 
u
->
bufãr
.
pos
 - 
¡¬t
 - 2 * (
ngx_h‰p_ç¡cgi_h—d”_t
);

1456 ià(
Ën
 >= 0) {

1457 
fh
 = (
ngx_h‰p_ç¡cgi_h—d”_t
 *è
¡¬t
;

1458 
fh
->
v”siÚ
 = 1;

1459 
fh
->
ty³
 = 
NGX_HTTP_FASTCGI_STDERR
;

1460 
fh
->
»que¡_id_hi
 = 0;

1461 
fh
->
»que¡_id_lo
 = 1;

1462 
fh
->
cÚ‹Á_Ëngth_hi
 = (
u_ch¬
è((
Ën
 >> 8) & 0xff);

1463 
fh
->
cÚ‹Á_Ëngth_lo
 = (
u_ch¬
è(
Ën
 & 0xff);

1464 
fh
->
·ddšg_Ëngth
 = 0;

1465 
fh
->
»£rved
 = 0;

1468 
r
->
ÿche
->
h—d”_¡¬t
 +ð
u
->
bufãr
.
pos
 - 
¡¬t


1469 - (
ngx_h‰p_ç¡cgi_h—d”_t
);

1472 
f
->
Ïrge_¡d”r
 = 0;

1477 
f
->
ç¡cgi_¡dout
 = 1;

1479 
¡¬t
 = 
u
->
bufãr
.
pos
;

1481 ià(
u
->
bufãr
.
pos
 + 
f
->
Ëngth
 < u->bufãr.
Ï¡
) {

1488 
Ï¡
 = 
u
->
bufãr
.last;

1489 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
 + 
f
->
Ëngth
;

1492 
Ï¡
 = 
NULL
;

1497 
·¹_¡¬t
 = 
u
->
bufãr
.
pos
;

1498 
·¹_’d
 = 
u
->
bufãr
.
Ï¡
;

1500 
rc
 = 
	`ngx_h‰p_·r£_h—d”_lše
(
r
, &
u
->
bufãr
, 1);

1502 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1503 "h‰°ç¡cg˜·r£r: %d", 
rc
);

1505 ià(
rc
 =ð
NGX_AGAIN
) {

1509 ià(
rc
 =ð
NGX_OK
) {

1513 
h
 = 
	`ngx_li¡_push
(&
u
->
h—d”s_š
.
h—d”s
);

1514 ià(
h
 =ð
NULL
) {

1515  
NGX_ERROR
;

1518 ià(
f
->
¥l™_·¹s
 && f->¥l™_·¹s->
ÃÉs
) {

1520 
·¹
 = 
f
->
¥l™_·¹s
->
–ts
;

1521 
size
 = 
u
->
bufãr
.
pos
 - 
·¹_¡¬t
;

1523 
i
 = 0; i < 
f
->
¥l™_·¹s
->
ÃÉs
; i++) {

1524 
size
 +ð
·¹
[
i
].
’d
 -…¬t[i].
¡¬t
;

1527 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
size
);

1528 ià(
p
 =ð
NULL
) {

1529  
NGX_ERROR
;

1532 
buf
.
pos
 = 
p
;

1534 
i
 = 0; i < 
f
->
¥l™_·¹s
->
ÃÉs
; i++) {

1535 
p
 = 
	`ngx_ýymem
Õ, 
·¹
[
i
].
¡¬t
,

1536 
·¹
[
i
].
’d
 -…¬t[i].
¡¬t
);

1539 
p
 = 
	`ngx_ýymem
Õ, 
·¹_¡¬t
, 
u
->
bufãr
.
pos
 -…art_start);

1541 
buf
.
Ï¡
 = 
p
;

1543 
f
->
¥l™_·¹s
->
ÃÉs
 = 0;

1545 
rc
 = 
	`ngx_h‰p_·r£_h—d”_lše
(
r
, &
buf
, 1);

1547 ià(
rc
 !ð
NGX_OK
) {

1548 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

1551  
NGX_ERROR
;

1554 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

1555 
h
->
key
.
d©a
 = 
r
->
h—d”_Çme_¡¬t
;

1556 
h
->
key
.
d©a
[h->key.
Ën
] = '\0';

1558 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

1559 
h
->
v®ue
.
d©a
 = 
r
->
h—d”_¡¬t
;

1560 
h
->
v®ue
.
d©a
[h->v®ue.
Ën
] = '\0';

1562 
h
->
lowÿ£_key
 = 
	`ngx_²®loc
(
r
->
poÞ
, h->
key
.
Ën
);

1563 ià(
h
->
lowÿ£_key
 =ð
NULL
) {

1564  
NGX_ERROR
;

1569 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

1570 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

1572 
h
->
key
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

1573 
h
->
key
.
Ën
 + 1 + h->
v®ue
.len + 1

1574 + 
h
->
key
.
Ën
);

1575 ià(
h
->
key
.
d©a
 =ð
NULL
) {

1576  
NGX_ERROR
;

1579 
h
->
v®ue
.
d©a
 = h->
key
.d©¨+ h->key.
Ën
 + 1;

1580 
h
->
lowÿ£_key
 = h->
key
.
d©a
 + h->key.
Ën
 + 1

1581 + 
h
->
v®ue
.
Ën
 + 1;

1583 
	`ngx_memýy
(
h
->
key
.
d©a
, 
r
->
h—d”_Çme_¡¬t
, h->key.
Ën
);

1584 
h
->
key
.
d©a
[h->key.
Ën
] = '\0';

1585 
	`ngx_memýy
(
h
->
v®ue
.
d©a
, 
r
->
h—d”_¡¬t
, h->v®ue.
Ën
);

1586 
h
->
v®ue
.
d©a
[h->v®ue.
Ën
] = '\0';

1589 
h
->
hash
 = 
r
->
h—d”_hash
;

1591 ià(
h
->
key
.
Ën
 =ð
r
->
lowÿ£_šdex
) {

1592 
	`ngx_memýy
(
h
->
lowÿ£_key
, 
r
->
lowÿ£_h—d”
, h->
key
.
Ën
);

1595 
	`ngx_¡¾ow
(
h
->
lowÿ£_key
, h->
key
.
d©a
, h->key.
Ën
);

1598 
hh
 = 
	`ngx_hash_fšd
(&
umcf
->
h—d”s_š_hash
, 
h
->
hash
,

1599 
h
->
lowÿ£_key
, h->
key
.
Ën
);

1601 ià(
hh
 && hh->
	`hªdËr
(
r
, 
h
, hh->
off£t
è!ð
NGX_OK
) {

1602  
NGX_ERROR
;

1605 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1607 &
h
->
key
, &h->
v®ue
);

1609 ià(
u
->
bufãr
.
pos
 < u->bufãr.
Ï¡
) {

1618 ià(
rc
 =ð
NGX_HTTP_PARSE_HEADER_DONE
) {

1622 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1625 ià(
u
->
h—d”s_š
.
¡©us
) {

1626 
¡©us_lše
 = &
u
->
h—d”s_š
.
¡©us
->
v®ue
;

1628 
¡©us
 = 
	`ngx_©oi
(
¡©us_lše
->
d©a
, 3);

1630 ià(
¡©us
 =ð
NGX_ERROR
) {

1631 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1633 
¡©us_lše
);

1634  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1637 
u
->
h—d”s_š
.
¡©us_n
 = 
¡©us
;

1638 
u
->
h—d”s_š
.
¡©us_lše
 = *status_line;

1640 } ià(
u
->
h—d”s_š
.
loÿtiÚ
) {

1641 
u
->
h—d”s_š
.
¡©us_n
 = 302;

1642 
	`ngx_¡r_£t
(&
u
->
h—d”s_š
.
¡©us_lše
,

1646 
u
->
h—d”s_š
.
¡©us_n
 = 200;

1647 
	`ngx_¡r_£t
(&
u
->
h—d”s_š
.
¡©us_lše
, "200 OK");

1650 ià(
u
->
¡©e
 && u->¡©e->
¡©us
 == 0) {

1651 
u
->
¡©e
->
¡©us
 = u->
h—d”s_š
.
¡©us_n
;

1659 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1662  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1665 ià(
Ï¡
) {

1666 
u
->
bufãr
.
Ï¡
 =†ast;

1669 
f
->
Ëngth
 -ð
u
->
bufãr
.
pos
 - 
¡¬t
;

1671 ià(
f
->
Ëngth
 == 0) {

1672 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

1675 ià(
rc
 =ð
NGX_HTTP_PARSE_HEADER_DONE
) {

1676  
NGX_OK
;

1679 ià(
rc
 =ð
NGX_OK
) {

1685 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1688 ià(
f
->
¥l™_·¹s
 =ð
NULL
) {

1689 
f
->
¥l™_·¹s
 = 
	`ngx_¬¿y_ü—‹
(
r
->
poÞ
, 1,

1690 (
ngx_h‰p_ç¡cgi_¥l™_·¹_t
));

1691 ià(
f
->
¥l™_·¹s
 =ð
NULL
) {

1692  
NGX_ERROR
;

1696 
·¹
 = 
	`ngx_¬¿y_push
(
f
->
¥l™_·¹s
);

1697 ià(
·¹
 =ð
NULL
) {

1698  
NGX_ERROR
;

1701 
·¹
->
¡¬t
 = 
·¹_¡¬t
;

1702 
·¹
->
’d
 = 
·¹_’d
;

1704 ià(
u
->
bufãr
.
pos
 < u->bufãr.
Ï¡
) {

1708  
NGX_AGAIN
;

1710 
	}
}

1713 
ngx_št_t


1714 
	$ngx_h‰p_ç¡cgi_šput_fž‹r_š™
(*
d©a
)

1716 
ngx_h‰p_»que¡_t
 *
r
 = 
d©a
;

1717 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
;

1719 
æcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

1721 
r
->
up¡»am
->
pe
->
Ëngth
 = 
æcf
->
k“p_cÚn
 ?

1722 (
off_t
è(
ngx_h‰p_ç¡cgi_h—d”_t
) : -1;

1724  
NGX_OK
;

1725 
	}
}

1728 
ngx_št_t


1729 
	$ngx_h‰p_ç¡cgi_šput_fž‹r
(
ngx_ev’t_pe_t
 *
p
, 
ngx_buf_t
 *
buf
)

1731 
u_ch¬
 *
m
, *
msg
;

1732 
ngx_št_t
 
rc
;

1733 
ngx_buf_t
 *
b
, **
´ev
;

1734 
ngx_chaš_t
 *
þ
;

1735 
ngx_h‰p_»que¡_t
 *
r
;

1736 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
;

1737 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
;

1739 ià(
buf
->
pos
 =ðbuf->
Ï¡
) {

1740  
NGX_OK
;

1743 
r
 = 
p
->
šput_ùx
;

1744 
f
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

1745 
æcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

1747 
b
 = 
NULL
;

1748 
´ev
 = &
buf
->
shadow
;

1750 
f
->
pos
 = 
buf
->pos;

1751 
f
->
Ï¡
 = 
buf
->last;

1754 ià(
f
->
¡©e
 < 
ngx_h‰p_ç¡cgi_¡_d©a
) {

1756 
rc
 = 
	`ngx_h‰p_ç¡cgi_´oûss_»cÜd
(
r
, 
f
);

1758 ià(
rc
 =ð
NGX_AGAIN
) {

1762 ià(
rc
 =ð
NGX_ERROR
) {

1763  
NGX_ERROR
;

1766 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_STDOUT
 && f->
Ëngth
 == 0) {

1767 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

1769 ià(!
æcf
->
k“p_cÚn
) {

1770 
p
->
up¡»am_dÚe
 = 1;

1773 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
p
->
log
, 0,

1779 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_END_REQUEST
) {

1781 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
p
->
log
, 0,

1784 ià(!
æcf
->
k“p_cÚn
) {

1785 
p
->
up¡»am_dÚe
 = 1;

1794 ià(
f
->
¡©e
 =ð
ngx_h‰p_ç¡cgi_¡_·ddšg
) {

1796 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_END_REQUEST
) {

1798 ià(
f
->
pos
 + f->
·ddšg
 < f->
Ï¡
) {

1799 
p
->
up¡»am_dÚe
 = 1;

1803 ià(
f
->
pos
 + f->
·ddšg
 =ðf->
Ï¡
) {

1804 
p
->
up¡»am_dÚe
 = 1;

1805 
r
->
up¡»am
->
k“·live
 = 1;

1809 
f
->
·ddšg
 -ðf->
Ï¡
 - f->
pos
;

1814 ià(
f
->
pos
 + f->
·ddšg
 < f->
Ï¡
) {

1815 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_v”siÚ
;

1816 
f
->
pos
 +ðf->
·ddšg
;

1821 ià(
f
->
pos
 + f->
·ddšg
 =ðf->
Ï¡
) {

1822 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_v”siÚ
;

1827 
f
->
·ddšg
 -ðf->
Ï¡
 - f->
pos
;

1835 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_STDERR
) {

1837 ià(
f
->
Ëngth
) {

1839 ià(
f
->
pos
 =ðf->
Ï¡
) {

1843 
msg
 = 
f
->
pos
;

1845 ià(
f
->
pos
 + f->
Ëngth
 <ðf->
Ï¡
) {

1846 
f
->
pos
 +ðf->
Ëngth
;

1847 
f
->
Ëngth
 = 0;

1848 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

1851 
f
->
Ëngth
 -ðf->
Ï¡
 - f->
pos
;

1852 
f
->
pos
 = f->
Ï¡
;

1855 
m
 = 
f
->
pos
 - 1; 
msg
 < m; m--) {

1856 ià(*
m
 !ð
LF
 && *m !ð
CR
 && *m != '.' && *m != ' ') {

1861 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
p
->
log
, 0,

1863 
m
 + 1 - 
msg
, msg);

1866 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

1872 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_END_REQUEST
) {

1874 ià(
f
->
pos
 + f->
Ëngth
 <ðf->
Ï¡
) {

1875 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

1876 
f
->
pos
 +ðf->
Ëngth
;

1881 
f
->
Ëngth
 -ðf->
Ï¡
 - f->
pos
;

1889 ià(
f
->
pos
 =ðf->
Ï¡
) {

1893 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
p
->
poÞ
, &p->
ä“
);

1894 ià(
þ
 =ð
NULL
) {

1895  
NGX_ERROR
;

1898 
b
 = 
þ
->
buf
;

1900 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

1902 
b
->
pos
 = 
f
->pos;

1903 
b
->
¡¬t
 = 
buf
->start;

1904 
b
->
’d
 = 
buf
->end;

1905 
b
->
g
 = 
p
->tag;

1906 
b
->
‹mpÜ¬y
 = 1;

1907 
b
->
»cyþed
 = 1;

1909 *
´ev
 = 
b
;

1910 
´ev
 = &
b
->
shadow
;

1912 ià(
p
->
š
) {

1913 *
p
->
Ï¡_š
 = 
þ
;

1915 
p
->
š
 = 
þ
;

1917 
p
->
Ï¡_š
 = &
þ
->
Ãxt
;

1920  
b
->
num
 = 
buf
->num;

1922 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

1923 "špuˆbuà#%d %p", 
b
->
num
, b->
pos
);

1925 ià(
f
->
pos
 + f->
Ëngth
 <ðf->
Ï¡
) {

1926 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

1927 
f
->
pos
 +ðf->
Ëngth
;

1928 
b
->
Ï¡
 = 
f
->
pos
;

1933 
f
->
Ëngth
 -ðf->
Ï¡
 - f->
pos
;

1935 
b
->
Ï¡
 = 
f
->last;

1941 ià(
æcf
->
k“p_cÚn
) {

1945 ià(
f
->
¡©e
 < 
ngx_h‰p_ç¡cgi_¡_d©a
) {

1946 
p
->
Ëngth
 = 1;

1948 } ià(
f
->
¡©e
 =ð
ngx_h‰p_ç¡cgi_¡_·ddšg
) {

1949 
p
->
Ëngth
 = 
f
->
·ddšg
;

1954 
p
->
Ëngth
 = 
f
->length;

1958 ià(
b
) {

1959 
b
->
shadow
 = 
buf
;

1960 
b
->
Ï¡_shadow
 = 1;

1962 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

1963 "špuˆbuà%°%z", 
b
->
pos
, b->
Ï¡
 - b->pos);

1965  
NGX_OK
;

1970 ià(
	`ngx_ev’t_pe_add_ä“_buf
(
p
, 
buf
è!ð
NGX_OK
) {

1971  
NGX_ERROR
;

1974  
NGX_OK
;

1975 
	}
}

1978 
ngx_št_t


1979 
	$ngx_h‰p_ç¡cgi_nÚ_bufã»d_fž‹r
(*
d©a
, 
ssize_t
 
by‹s
)

1981 
u_ch¬
 *
m
, *
msg
;

1982 
ngx_št_t
 
rc
;

1983 
ngx_buf_t
 *
b
, *
buf
;

1984 
ngx_chaš_t
 *
þ
, **
Î
;

1985 
ngx_h‰p_»que¡_t
 *
r
;

1986 
ngx_h‰p_up¡»am_t
 *
u
;

1987 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
;

1989 
r
 = 
d©a
;

1990 
f
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

1992 
u
 = 
r
->
up¡»am
;

1993 
buf
 = &
u
->
bufãr
;

1995 
buf
->
pos
 = buf->
Ï¡
;

1996 
buf
->
Ï¡
 +ð
by‹s
;

1998 
þ
 = 
u
->
out_bufs
, 
Î
 = &u->out_bufs; cl; cÈðþ->
Ãxt
) {

1999 
Î
 = &
þ
->
Ãxt
;

2002 
f
->
pos
 = 
buf
->pos;

2003 
f
->
Ï¡
 = 
buf
->last;

2006 ià(
f
->
¡©e
 < 
ngx_h‰p_ç¡cgi_¡_d©a
) {

2008 
rc
 = 
	`ngx_h‰p_ç¡cgi_´oûss_»cÜd
(
r
, 
f
);

2010 ià(
rc
 =ð
NGX_AGAIN
) {

2014 ià(
rc
 =ð
NGX_ERROR
) {

2015  
NGX_ERROR
;

2018 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_STDOUT
 && f->
Ëngth
 == 0) {

2019 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

2021 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2028 ià(
f
->
¡©e
 =ð
ngx_h‰p_ç¡cgi_¡_·ddšg
) {

2030 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_END_REQUEST
) {

2032 ià(
f
->
pos
 + f->
·ddšg
 < f->
Ï¡
) {

2033 
u
->
Ëngth
 = 0;

2037 ià(
f
->
pos
 + f->
·ddšg
 =ðf->
Ï¡
) {

2038 
u
->
Ëngth
 = 0;

2039 
u
->
k“·live
 = 1;

2043 
f
->
·ddšg
 -ðf->
Ï¡
 - f->
pos
;

2048 ià(
f
->
pos
 + f->
·ddšg
 < f->
Ï¡
) {

2049 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_v”siÚ
;

2050 
f
->
pos
 +ðf->
·ddšg
;

2055 ià(
f
->
pos
 + f->
·ddšg
 =ðf->
Ï¡
) {

2056 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_v”siÚ
;

2061 
f
->
·ddšg
 -ðf->
Ï¡
 - f->
pos
;

2069 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_STDERR
) {

2071 ià(
f
->
Ëngth
) {

2073 ià(
f
->
pos
 =ðf->
Ï¡
) {

2077 
msg
 = 
f
->
pos
;

2079 ià(
f
->
pos
 + f->
Ëngth
 <ðf->
Ï¡
) {

2080 
f
->
pos
 +ðf->
Ëngth
;

2081 
f
->
Ëngth
 = 0;

2082 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

2085 
f
->
Ëngth
 -ðf->
Ï¡
 - f->
pos
;

2086 
f
->
pos
 = f->
Ï¡
;

2089 
m
 = 
f
->
pos
 - 1; 
msg
 < m; m--) {

2090 ià(*
m
 !ð
LF
 && *m !ð
CR
 && *m != '.' && *m != ' ') {

2095 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2097 
m
 + 1 - 
msg
, msg);

2100 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

2106 ià(
f
->
ty³
 =ð
NGX_HTTP_FASTCGI_END_REQUEST
) {

2108 ià(
f
->
pos
 + f->
Ëngth
 <ðf->
Ï¡
) {

2109 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

2110 
f
->
pos
 +ðf->
Ëngth
;

2115 
f
->
Ëngth
 -ðf->
Ï¡
 - f->
pos
;

2123 ià(
f
->
pos
 =ðf->
Ï¡
) {

2127 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
u
->
ä“_bufs
);

2128 ià(
þ
 =ð
NULL
) {

2129  
NGX_ERROR
;

2132 *
Î
 = 
þ
;

2133 
Î
 = &
þ
->
Ãxt
;

2135 
b
 = 
þ
->
buf
;

2137 
b
->
æush
 = 1;

2138 
b
->
memÜy
 = 1;

2140 
b
->
pos
 = 
f
->pos;

2141 
b
->
g
 = 
u
->
ouut
.tag;

2143 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2144 "h‰°ç¡cg˜ouuˆbuà%p", 
b
->
pos
);

2146 ià(
f
->
pos
 + f->
Ëngth
 <ðf->
Ï¡
) {

2147 
f
->
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg
;

2148 
f
->
pos
 +ðf->
Ëngth
;

2149 
b
->
Ï¡
 = 
f
->
pos
;

2154 
f
->
Ëngth
 -ðf->
Ï¡
 - f->
pos
;

2155 
b
->
Ï¡
 = 
f
->last;

2162 ià(
r
->
sub»que¡_š_memÜy
) {

2164 
þ
 = 
u
->
out_bufs
;

2166 ià(
þ
) {

2167 
buf
->
pos
 = 
þ
->buf->pos;

2170 
buf
->
Ï¡
 = buf->
pos
;

2172 
þ
 = 
u
->
out_bufs
; cl; cÈðþ->
Ãxt
) {

2173 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2175 
þ
->
buf
->
pos
, cl->buf->
Ï¡
, 
	`ngx_buf_size
(cl->buf));

2177 ià(
buf
->
Ï¡
 =ð
þ
->buf->
pos
) {

2178 
buf
->
Ï¡
 = 
þ
->buf->last;

2182 
buf
->
Ï¡
 = 
	`ngx_movemem
(buf->Ï¡, 
þ
->buf->
pos
,

2183 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
);

2185 
þ
->
buf
->
pos
 = buf->
Ï¡
 - (cl->buf->last - cl->buf->pos);

2186 
þ
->
buf
->
Ï¡
 = buf->last;

2190  
NGX_OK
;

2191 
	}
}

2194 
ngx_št_t


2195 
	$ngx_h‰p_ç¡cgi_´oûss_»cÜd
(
ngx_h‰p_»que¡_t
 *
r
,

2196 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
)

2198 
u_ch¬
 
ch
, *
p
;

2199 
ngx_h‰p_ç¡cgi_¡©e_e
 
¡©e
;

2201 
¡©e
 = 
f
->state;

2203 
p
 = 
f
->
pos
;… < f->
Ï¡
;…++) {

2205 
ch
 = *
p
;

2207 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2208 "h‰°ç¡cg˜»cÜd by‹: %02Xd", 
ch
);

2210 
¡©e
) {

2212 
ngx_h‰p_ç¡cgi_¡_v”siÚ
:

2213 ià(
ch
 != 1) {

2214 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2216 "´ÙocÞ v”siÚ: %d", 
ch
);

2217  
NGX_ERROR
;

2219 
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_ty³
;

2222 
ngx_h‰p_ç¡cgi_¡_ty³
:

2223 
ch
) {

2224 
NGX_HTTP_FASTCGI_STDOUT
:

2225 
NGX_HTTP_FASTCGI_STDERR
:

2226 
NGX_HTTP_FASTCGI_END_REQUEST
:

2227 
f
->
ty³
 = (
ngx_ušt_t
è
ch
;

2230 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2232 "»cÜdy³: %d", 
ch
);

2233  
NGX_ERROR
;

2236 
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_»que¡_id_hi
;

2241 
ngx_h‰p_ç¡cgi_¡_»que¡_id_hi
:

2242 ià(
ch
 != 0) {

2243 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2245 "»que¡ id high by‹: %d", 
ch
);

2246  
NGX_ERROR
;

2248 
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_»que¡_id_lo
;

2251 
ngx_h‰p_ç¡cgi_¡_»que¡_id_lo
:

2252 ià(
ch
 != 1) {

2253 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2255 "»que¡ id†ow by‹: %d", 
ch
);

2256  
NGX_ERROR
;

2258 
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_cÚ‹Á_Ëngth_hi
;

2261 
ngx_h‰p_ç¡cgi_¡_cÚ‹Á_Ëngth_hi
:

2262 
f
->
Ëngth
 = 
ch
 << 8;

2263 
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_cÚ‹Á_Ëngth_lo
;

2266 
ngx_h‰p_ç¡cgi_¡_cÚ‹Á_Ëngth_lo
:

2267 
f
->
Ëngth
 |ð(
size_t
è
ch
;

2268 
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_·ddšg_Ëngth
;

2271 
ngx_h‰p_ç¡cgi_¡_·ddšg_Ëngth
:

2272 
f
->
·ddšg
 = (
size_t
è
ch
;

2273 
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_»£rved
;

2276 
ngx_h‰p_ç¡cgi_¡_»£rved
:

2277 
¡©e
 = 
ngx_h‰p_ç¡cgi_¡_d©a
;

2279 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2280 "h‰°ç¡cg˜»cÜd†’gth: %z", 
f
->
Ëngth
);

2282 
f
->
pos
 = 
p
 + 1;

2283 
f
->
¡©e
 = state;

2285  
NGX_OK
;

2288 
ngx_h‰p_ç¡cgi_¡_d©a
:

2289 
ngx_h‰p_ç¡cgi_¡_·ddšg
:

2294 
f
->
¡©e
 = state;

2296  
NGX_AGAIN
;

2297 
	}
}

2301 
	$ngx_h‰p_ç¡cgi_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

2303 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2307 
	}
}

2311 
	$ngx_h‰p_ç¡cgi_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

2313 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2317 
	}
}

2320 
ngx_št_t


2321 
	$ngx_h‰p_ç¡cgi_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

2323 
ngx_h‰p_v¬ŸbË_t
 *
v¬
, *
v
;

2325 
v
 = 
ngx_h‰p_ç¡cgi_v¬s
; v->
Çme
.
Ën
; v++) {

2326 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

2327 ià(
v¬
 =ð
NULL
) {

2328  
NGX_ERROR
;

2331 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

2332 
v¬
->
d©a
 = 
v
->data;

2335  
NGX_OK
;

2336 
	}
}

2340 
	$ngx_h‰p_ç¡cgi_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

2342 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
cÚf
;

2344 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_ç¡cgi_loc_cÚf_t
));

2345 ià(
cÚf
 =ð
NULL
) {

2346  
NULL
;

2367 
cÚf
->
up¡»am
.
¡Üe
 = 
NGX_CONF_UNSET
;

2368 
cÚf
->
up¡»am
.
¡Üe_acûss
 = 
NGX_CONF_UNSET_UINT
;

2369 
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
 = 
NGX_CONF_UNSET_UINT
;

2370 
cÚf
->
up¡»am
.
bufãršg
 = 
NGX_CONF_UNSET
;

2371 
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
 = 
NGX_CONF_UNSET
;

2372 
cÚf
->
up¡»am
.
fÜû_¿nges
 = 
NGX_CONF_UNSET
;

2374 
cÚf
->
up¡»am
.
loÿl
 = 
NGX_CONF_UNSET_PTR
;

2376 
cÚf
->
up¡»am
.
cÚÃù_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2377 
cÚf
->
up¡»am
.
£nd_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2378 
cÚf
->
up¡»am
.
»ad_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2379 
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2381 
cÚf
->
up¡»am
.
£nd_low©
 = 
NGX_CONF_UNSET_SIZE
;

2382 
cÚf
->
up¡»am
.
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

2383 
cÚf
->
up¡»am
.
lim™_¿‹
 = 
NGX_CONF_UNSET_SIZE
;

2385 
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

2386 
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

2387 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

2389 
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
 = 
NGX_CONF_UNSET
;

2390 
cÚf
->
up¡»am
.
·ss_»que¡_body
 = 
NGX_CONF_UNSET
;

2392 #ià(
NGX_HTTP_CACHE
)

2393 
cÚf
->
up¡»am
.
ÿche
 = 
NGX_CONF_UNSET_PTR
;

2394 
cÚf
->
up¡»am
.
ÿche_mš_u£s
 = 
NGX_CONF_UNSET_UINT
;

2395 
cÚf
->
up¡»am
.
ÿche_by·ss
 = 
NGX_CONF_UNSET_PTR
;

2396 
cÚf
->
up¡»am
.
no_ÿche
 = 
NGX_CONF_UNSET_PTR
;

2397 
cÚf
->
up¡»am
.
ÿche_v®id
 = 
NGX_CONF_UNSET_PTR
;

2398 
cÚf
->
up¡»am
.
ÿche_lock
 = 
NGX_CONF_UNSET
;

2399 
cÚf
->
up¡»am
.
ÿche_lock_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2400 
cÚf
->
up¡»am
.
ÿche_lock_age
 = 
NGX_CONF_UNSET_MSEC
;

2401 
cÚf
->
up¡»am
.
ÿche_»v®id©e
 = 
NGX_CONF_UNSET
;

2404 
cÚf
->
up¡»am
.
hide_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

2405 
cÚf
->
up¡»am
.
·ss_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

2407 
cÚf
->
up¡»am
.
š‹rû±_”rÜs
 = 
NGX_CONF_UNSET
;

2410 
cÚf
->
up¡»am
.
cyþic_‹mp_fže
 = 0;

2412 
cÚf
->
up¡»am
.
chªge_bufãršg
 = 1;

2414 
cÚf
->
ÿtch_¡d”r
 = 
NGX_CONF_UNSET_PTR
;

2416 
cÚf
->
k“p_cÚn
 = 
NGX_CONF_UNSET
;

2418 
	`ngx_¡r_£t
(&
cÚf
->
up¡»am
.
moduË
, "fastcgi");

2420  
cÚf
;

2421 
	}
}

2425 
	$ngx_h‰p_ç¡cgi_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

2427 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
´ev
 = 
·»Á
;

2428 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
cÚf
 = 
chžd
;

2430 
size_t
 
size
;

2431 
ngx_št_t
 
rc
;

2432 
ngx_hash_š™_t
 
hash
;

2433 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2435 ià(
cÚf
->
up¡»am
.
¡Üe
 != 0) {

2436 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
¡Üe
,

2437 
´ev
->
up¡»am
.
¡Üe
, 0);

2439 ià(
cÚf
->
up¡»am
.
¡Üe_Ëngths
 =ð
NULL
) {

2440 
cÚf
->
up¡»am
.
¡Üe_Ëngths
 = 
´ev
->upstream.store_lengths;

2441 
cÚf
->
up¡»am
.
¡Üe_v®ues
 = 
´ev
->upstream.store_values;

2445 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
¡Üe_acûss
,

2446 
´ev
->
up¡»am
.
¡Üe_acûss
, 0600);

2448 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
,

2449 
´ev
->
up¡»am
.
Ãxt_up¡»am_Œ›s
, 0);

2451 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
bufãršg
,

2452 
´ev
->
up¡»am
.
bufãršg
, 1);

2454 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
,

2455 
´ev
->
up¡»am
.
ignÜe_þ›Á_abÜt
, 0);

2457 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
fÜû_¿nges
,

2458 
´ev
->
up¡»am
.
fÜû_¿nges
, 0);

2460 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
loÿl
,

2461 
´ev
->
up¡»am
.
loÿl
, 
NULL
);

2463 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
cÚÃù_timeout
,

2464 
´ev
->
up¡»am
.
cÚÃù_timeout
, 60000);

2466 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
£nd_timeout
,

2467 
´ev
->
up¡»am
.
£nd_timeout
, 60000);

2469 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
»ad_timeout
,

2470 
´ev
->
up¡»am
.
»ad_timeout
, 60000);

2472 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
,

2473 
´ev
->
up¡»am
.
Ãxt_up¡»am_timeout
, 0);

2475 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
£nd_low©
,

2476 
´ev
->
up¡»am
.
£nd_low©
, 0);

2478 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
bufãr_size
,

2479 
´ev
->
up¡»am
.
bufãr_size
,

2480 (
size_t
è
ngx_·gesize
);

2482 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
lim™_¿‹
,

2483 
´ev
->
up¡»am
.
lim™_¿‹
, 0);

2486 
	`ngx_cÚf_m”ge_bufs_v®ue
(
cÚf
->
up¡»am
.
bufs
, 
´ev
->upstream.bufs,

2487 8, 
ngx_·gesize
);

2489 ià(
cÚf
->
up¡»am
.
bufs
.
num
 < 2) {

2490 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2492  
NGX_CONF_ERROR
;

2496 
size
 = 
cÚf
->
up¡»am
.
bufãr_size
;

2497 ià(
size
 < 
cÚf
->
up¡»am
.
bufs
.size) {

2498 
size
 = 
cÚf
->
up¡»am
.
bufs
.size;

2502 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
,

2503 
´ev
->
up¡»am
.
busy_bufãrs_size_cÚf
,

2504 
NGX_CONF_UNSET_SIZE
);

2506 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

2507 
cÚf
->
up¡»am
.
busy_bufãrs_size
 = 2 * 
size
;

2509 
cÚf
->
up¡»am
.
busy_bufãrs_size
 =

2510 
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
;

2513 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size
 < 
size
) {

2514 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2519  
NGX_CONF_ERROR
;

2522 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size


2523 > (
cÚf
->
up¡»am
.
bufs
.
num
 - 1è* cÚf->up¡»am.bufs.
size
)

2525 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2529  
NGX_CONF_ERROR
;

2533 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
,

2534 
´ev
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
,

2535 
NGX_CONF_UNSET_SIZE
);

2537 ià(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

2538 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 = 2 * 
size
;

2540 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 =

2541 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
;

2544 ià(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 < 
size
) {

2545 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2550  
NGX_CONF_ERROR
;

2554 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
,

2555 
´ev
->
up¡»am
.
max_‹mp_fže_size_cÚf
,

2556 
NGX_CONF_UNSET_SIZE
);

2558 ià(
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

2559 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 = 1024 * 1024 * 1024;

2561 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 =

2562 
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
;

2565 ià(
cÚf
->
up¡»am
.
max_‹mp_fže_size
 != 0

2566 && 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 < 
size
)

2568 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2574  
NGX_CONF_ERROR
;

2578 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
ignÜe_h—d”s
,

2579 
´ev
->
up¡»am
.
ignÜe_h—d”s
,

2580 
NGX_CONF_BITMASK_SET
);

2583 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am
,

2584 
´ev
->
up¡»am
.
Ãxt_up¡»am
,

2585 (
NGX_CONF_BITMASK_SET


2586 |
NGX_HTTP_UPSTREAM_FT_ERROR


2587 |
NGX_HTTP_UPSTREAM_FT_TIMEOUT
));

2589 ià(
cÚf
->
up¡»am
.
Ãxt_up¡»am
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

2590 
cÚf
->
up¡»am
.
Ãxt_up¡»am
 = 
NGX_CONF_BITMASK_SET


2591 |
NGX_HTTP_UPSTREAM_FT_OFF
;

2594 ià(
	`ngx_cÚf_m”ge_·th_v®ue
(
cf
, &
cÚf
->
up¡»am
.
‹mp_·th
,

2595 
´ev
->
up¡»am
.
‹mp_·th
,

2596 &
ngx_h‰p_ç¡cgi_‹mp_·th
)

2597 !ð
NGX_OK
)

2599  
NGX_CONF_ERROR
;

2602 #ià(
NGX_HTTP_CACHE
)

2604 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche
,

2605 
´ev
->
up¡»am
.
ÿche
, 
NULL
);

2607 ià(
cÚf
->
up¡»am
.
ÿche
 && cÚf->up¡»am.ÿche->
d©a
 =ð
NULL
) {

2608 
ngx_shm_zÚe_t
 *
shm_zÚe
;

2610 
shm_zÚe
 = 
cÚf
->
up¡»am
.
ÿche
;

2612 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2614 &
shm_zÚe
->
shm
.
Çme
);

2616  
NGX_CONF_ERROR
;

2619 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
ÿche_mš_u£s
,

2620 
´ev
->
up¡»am
.
ÿche_mš_u£s
, 1);

2622 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
,

2623 
´ev
->
up¡»am
.
ÿche_u£_¡®e
,

2624 (
NGX_CONF_BITMASK_SET


2625 |
NGX_HTTP_UPSTREAM_FT_OFF
));

2627 ià(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

2628 
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 = 
NGX_CONF_BITMASK_SET


2629 |
NGX_HTTP_UPSTREAM_FT_OFF
;

2632 ià(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_ERROR
) {

2633 
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 |ð
NGX_HTTP_UPSTREAM_FT_NOLIVE
;

2636 ià(
cÚf
->
up¡»am
.
ÿche_m‘hods
 == 0) {

2637 
cÚf
->
up¡»am
.
ÿche_m‘hods
 = 
´ev
->upstream.cache_methods;

2640 
cÚf
->
up¡»am
.
ÿche_m‘hods
 |ð
NGX_HTTP_GET
|
NGX_HTTP_HEAD
;

2642 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche_by·ss
,

2643 
´ev
->
up¡»am
.
ÿche_by·ss
, 
NULL
);

2645 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
no_ÿche
,

2646 
´ev
->
up¡»am
.
no_ÿche
, 
NULL
);

2648 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche_v®id
,

2649 
´ev
->
up¡»am
.
ÿche_v®id
, 
NULL
);

2651 ià(
cÚf
->
ÿche_key
.
v®ue
.
d©a
 =ð
NULL
) {

2652 
cÚf
->
ÿche_key
 = 
´ev
->cache_key;

2655 ià(
cÚf
->
up¡»am
.
ÿche
 && cÚf->
ÿche_key
.
v®ue
.
d©a
 =ð
NULL
) {

2656 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

2660 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock
,

2661 
´ev
->
up¡»am
.
ÿche_lock
, 0);

2663 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock_timeout
,

2664 
´ev
->
up¡»am
.
ÿche_lock_timeout
, 5000);

2666 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock_age
,

2667 
´ev
->
up¡»am
.
ÿche_lock_age
, 5000);

2669 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ÿche_»v®id©e
,

2670 
´ev
->
up¡»am
.
ÿche_»v®id©e
, 0);

2674 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
,

2675 
´ev
->
up¡»am
.
·ss_»que¡_h—d”s
, 1);

2676 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
·ss_»que¡_body
,

2677 
´ev
->
up¡»am
.
·ss_»que¡_body
, 1);

2679 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
š‹rû±_”rÜs
,

2680 
´ev
->
up¡»am
.
š‹rû±_”rÜs
, 0);

2682 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
ÿtch_¡d”r
, 
´ev
->ÿtch_¡d”r, 
NULL
);

2684 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
k“p_cÚn
, 
´ev
->keep_conn, 0);

2687 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
šdex
, 
´ev
->index, "");

2689 
hash
.
max_size
 = 512;

2690 
hash
.
buck‘_size
 = 
	`ngx_®ign
(64, 
ngx_ÿch–še_size
);

2691 
hash
.
Çme
 = "fastcgi_hide_headers_hash";

2693 ià(
	`ngx_h‰p_up¡»am_hide_h—d”s_hash
(
cf
, &
cÚf
->
up¡»am
,

2694 &
´ev
->
up¡»am
, 
ngx_h‰p_ç¡cgi_hide_h—d”s
, &
hash
)

2695 !ð
NGX_OK
)

2697  
NGX_CONF_ERROR
;

2700 ià(
cÚf
->
up¡»am
.up¡»am =ð
NULL
) {

2701 
cÚf
->
up¡»am
.up¡»am = 
´ev
->upstream.upstream;

2704 ià(
cÚf
->
ç¡cgi_Ëngths
 =ð
NULL
) {

2705 
cÚf
->
ç¡cgi_Ëngths
 = 
´ev
->fastcgi_lengths;

2706 
cÚf
->
ç¡cgi_v®ues
 = 
´ev
->fastcgi_values;

2709 ià(
cÚf
->
up¡»am
.up¡»am || cÚf->
ç¡cgi_Ëngths
) {

2710 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

2711 ià(
þcf
->
hªdËr
 =ð
NULL
 && clcf->
lmt_exýt
) {

2712 
þcf
->
hªdËr
 = 
ngx_h‰p_ç¡cgi_hªdËr
;

2716 #ià(
NGX_PCRE
)

2717 ià(
cÚf
->
¥l™_»gex
 =ð
NULL
) {

2718 
cÚf
->
¥l™_»gex
 = 
´ev
->split_regex;

2719 
cÚf
->
¥l™_Çme
 = 
´ev
->split_name;

2723 ià(
cÚf
->
·¿ms_sourû
 =ð
NULL
) {

2724 
cÚf
->
·¿ms
 = 
´ev
->params;

2725 #ià(
NGX_HTTP_CACHE
)

2726 
cÚf
->
·¿ms_ÿche
 = 
´ev
->params_cache;

2728 
cÚf
->
·¿ms_sourû
 = 
´ev
->params_source;

2731 
rc
 = 
	`ngx_h‰p_ç¡cgi_š™_·¿ms
(
cf
, 
cÚf
, &cÚf->
·¿ms
, 
NULL
);

2732 ià(
rc
 !ð
NGX_OK
) {

2733  
NGX_CONF_ERROR
;

2736 #ià(
NGX_HTTP_CACHE
)

2738 ià(
cÚf
->
up¡»am
.
ÿche
) {

2739 
rc
 = 
	`ngx_h‰p_ç¡cgi_š™_·¿ms
(
cf
, 
cÚf
, &cÚf->
·¿ms_ÿche
,

2740 
ngx_h‰p_ç¡cgi_ÿche_h—d”s
);

2741 ià(
rc
 !ð
NGX_OK
) {

2742  
NGX_CONF_ERROR
;

2748  
NGX_CONF_OK
;

2749 
	}
}

2752 
ngx_št_t


2753 
	$ngx_h‰p_ç¡cgi_š™_·¿ms
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
cÚf
,

2754 
ngx_h‰p_ç¡cgi_·¿ms_t
 *
·¿ms
, 
ngx_keyv®_t
 *
deçuÉ_·¿ms
)

2756 
u_ch¬
 *
p
;

2757 
size_t
 
size
;

2758 
ušŒ_t
 *
code
;

2759 
ngx_ušt_t
 
i
, 
n¤c
;

2760 
ngx_¬¿y_t
 
h—d”s_Çmes
, 
·¿ms_m”ged
;

2761 
ngx_keyv®_t
 *
h
;

2762 
ngx_hash_key_t
 *
hk
;

2763 
ngx_hash_š™_t
 
hash
;

2764 
ngx_h‰p_up¡»am_·¿m_t
 *
¤c
, *
s
;

2765 
ngx_h‰p_süt_compže_t
 
sc
;

2766 
ngx_h‰p_süt_cÝy_code_t
 *
cÝy
;

2768 ià(
·¿ms
->
hash
.
buck‘s
) {

2769  
NGX_OK
;

2772 ià(
cÚf
->
·¿ms_sourû
 =ð
NULL
 && 
deçuÉ_·¿ms
 == NULL) {

2773 
·¿ms
->
hash
.
buck‘s
 = (*) 1;

2774  
NGX_OK
;

2777 
·¿ms
->
Ëngths
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 64, 1);

2778 ià(
·¿ms
->
Ëngths
 =ð
NULL
) {

2779  
NGX_ERROR
;

2782 
·¿ms
->
v®ues
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 512, 1);

2783 ià(
·¿ms
->
v®ues
 =ð
NULL
) {

2784  
NGX_ERROR
;

2787 ià(
	`ngx_¬¿y_š™
(&
h—d”s_Çmes
, 
cf
->
‹mp_poÞ
, 4, (
ngx_hash_key_t
))

2788 !ð
NGX_OK
)

2790  
NGX_ERROR
;

2793 ià(
cÚf
->
·¿ms_sourû
) {

2794 
¤c
 = 
cÚf
->
·¿ms_sourû
->
–ts
;

2795 
n¤c
 = 
cÚf
->
·¿ms_sourû
->
ÃÉs
;

2798 
¤c
 = 
NULL
;

2799 
n¤c
 = 0;

2802 ià(
deçuÉ_·¿ms
) {

2803 ià(
	`ngx_¬¿y_š™
(&
·¿ms_m”ged
, 
cf
->
‹mp_poÞ
, 4,

2804 (
ngx_h‰p_up¡»am_·¿m_t
))

2805 !ð
NGX_OK
)

2807  
NGX_ERROR
;

2810 
i
 = 0; i < 
n¤c
; i++) {

2812 
s
 = 
	`ngx_¬¿y_push
(&
·¿ms_m”ged
);

2813 ià(
s
 =ð
NULL
) {

2814  
NGX_ERROR
;

2817 *
s
 = 
¤c
[
i
];

2820 
h
 = 
deçuÉ_·¿ms
;

2822 
h
->
key
.
Ën
) {

2824 
¤c
 = 
·¿ms_m”ged
.
–ts
;

2825 
n¤c
 = 
·¿ms_m”ged
.
ÃÉs
;

2827 
i
 = 0; i < 
n¤c
; i++) {

2828 ià(
	`ngx_¡rÿ£cmp
(
h
->
key
.
d©a
, 
¤c
[
i
].key.data) == 0) {

2829 
Ãxt
;

2833 
s
 = 
	`ngx_¬¿y_push
(&
·¿ms_m”ged
);

2834 ià(
s
 =ð
NULL
) {

2835  
NGX_ERROR
;

2838 
s
->
key
 = 
h
->key;

2839 
s
->
v®ue
 = 
h
->value;

2840 
s
->
sk_em±y
 = 1;

2842 
Ãxt
:

2844 
h
++;

2847 
¤c
 = 
·¿ms_m”ged
.
–ts
;

2848 
n¤c
 = 
·¿ms_m”ged
.
ÃÉs
;

2851 
i
 = 0; i < 
n¤c
; i++) {

2853 ià(
¤c
[
i
].
key
.
Ën
 > ("HTTP_") - 1

2854 && 
	`ngx_¡ºcmp
(
¤c
[
i
].
key
.
d©a
, "HTTP_", ("HTTP_") - 1) == 0)

2856 
hk
 = 
	`ngx_¬¿y_push
(&
h—d”s_Çmes
);

2857 ià(
hk
 =ð
NULL
) {

2858  
NGX_ERROR
;

2861 
hk
->
key
.
Ën
 = 
¤c
[
i
].key.len - 5;

2862 
hk
->
key
.
d©a
 = 
¤c
[
i
].key.data + 5;

2863 
hk
->
key_hash
 = 
	`ngx_hash_key_lc
(hk->
key
.
d©a
, hk->key.
Ën
);

2864 
hk
->
v®ue
 = (*) 1;

2866 ià(
¤c
[
i
].
v®ue
.
Ën
 == 0) {

2871 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
,

2872 (
ngx_h‰p_süt_cÝy_code_t
));

2873 ià(
cÝy
 =ð
NULL
) {

2874  
NGX_ERROR
;

2877 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_cÝy_Ën_code
;

2878 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len;

2880 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
,

2881 (
ngx_h‰p_süt_cÝy_code_t
));

2882 ià(
cÝy
 =ð
NULL
) {

2883  
NGX_ERROR
;

2886 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_cÝy_Ën_code
;

2887 
cÝy
->
Ën
 = 
¤c
[
i
].
sk_em±y
;

2890 
size
 = ((
ngx_h‰p_süt_cÝy_code_t
)

2891 + 
¤c
[
i
].
key
.
Ën
 + (
ušŒ_t
) - 1)

2892 & ~((
ušŒ_t
) - 1);

2894 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
v®ues
, 
size
);

2895 ià(
cÝy
 =ð
NULL
) {

2896  
NGX_ERROR
;

2899 
cÝy
->
code
 = 
ngx_h‰p_süt_cÝy_code
;

2900 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len;

2902 
p
 = (
u_ch¬
 *è
cÝy
 + (
ngx_h‰p_süt_cÝy_code_t
);

2903 
	`ngx_memýy
(
p
, 
¤c
[
i
].
key
.
d©a
, src[i].key.
Ën
);

2906 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

2908 
sc
.
cf
 = cf;

2909 
sc
.
sourû
 = &
¤c
[
i
].
v®ue
;

2910 
sc
.
æushes
 = &
·¿ms
->flushes;

2911 
sc
.
Ëngths
 = &
·¿ms
->lengths;

2912 
sc
.
v®ues
 = &
·¿ms
->values;

2914 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

2915  
NGX_ERROR
;

2918 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
, (
ušŒ_t
));

2919 ià(
code
 =ð
NULL
) {

2920  
NGX_ERROR
;

2923 *
code
 = (
ušŒ_t
è
NULL
;

2926 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
v®ues
, (
ušŒ_t
));

2927 ià(
code
 =ð
NULL
) {

2928  
NGX_ERROR
;

2931 *
code
 = (
ušŒ_t
è
NULL
;

2934 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
, (
ušŒ_t
));

2935 ià(
code
 =ð
NULL
) {

2936  
NGX_ERROR
;

2939 *
code
 = (
ušŒ_t
è
NULL
;

2941 
·¿ms
->
numb”
 = 
h—d”s_Çmes
.
ÃÉs
;

2943 
hash
.hash = &
·¿ms
->hash;

2944 
hash
.
key
 = 
ngx_hash_key_lc
;

2945 
hash
.
max_size
 = 512;

2946 
hash
.
buck‘_size
 = 64;

2947 
hash
.
Çme
 = "fastcgi_params_hash";

2948 
hash
.
poÞ
 = 
cf
->pool;

2949 
hash
.
‹mp_poÞ
 = 
NULL
;

2951  
	`ngx_hash_š™
(&
hash
, 
h—d”s_Çmes
.
–ts
, h—d”s_Çmes.
ÃÉs
);

2952 
	}
}

2955 
ngx_št_t


2956 
	$ngx_h‰p_ç¡cgi_süt_Çme_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

2957 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2959 
u_ch¬
 *
p
;

2960 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
;

2961 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
;

2963 
æcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

2965 
f
 = 
	`ngx_h‰p_ç¡cgi_¥l™
(
r
, 
æcf
);

2967 ià(
f
 =ð
NULL
) {

2968  
NGX_ERROR
;

2971 ià(
f
->
süt_Çme
.
Ën
 == 0

2972 || 
f
->
süt_Çme
.
d©a
[f->süt_Çme.
Ën
 - 1] != '/')

2974 
v
->
Ën
 = 
f
->
süt_Çme
.len;

2975 
v
->
v®id
 = 1;

2976 
v
->
no_ÿch—bË
 = 0;

2977 
v
->
nÙ_found
 = 0;

2978 
v
->
d©a
 = 
f
->
süt_Çme
.data;

2980  
NGX_OK
;

2983 
v
->
Ën
 = 
f
->
süt_Çme
.ËÀ+ 
æcf
->
šdex
.len;

2985 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, v->
Ën
);

2986 ià(
v
->
d©a
 =ð
NULL
) {

2987  
NGX_ERROR
;

2990 
p
 = 
	`ngx_cÝy
(
v
->
d©a
, 
f
->
süt_Çme
.d©a, f->süt_Çme.
Ën
);

2991 
	`ngx_memýy
(
p
, 
æcf
->
šdex
.
d©a
, flcf->šdex.
Ën
);

2993  
NGX_OK
;

2994 
	}
}

2997 
ngx_št_t


2998 
	$ngx_h‰p_ç¡cgi_·th_šfo_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

2999 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

3001 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
;

3002 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
;

3004 
æcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

3006 
f
 = 
	`ngx_h‰p_ç¡cgi_¥l™
(
r
, 
æcf
);

3008 ià(
f
 =ð
NULL
) {

3009  
NGX_ERROR
;

3012 
v
->
Ën
 = 
f
->
·th_šfo
.len;

3013 
v
->
v®id
 = 1;

3014 
v
->
no_ÿch—bË
 = 0;

3015 
v
->
nÙ_found
 = 0;

3016 
v
->
d©a
 = 
f
->
·th_šfo
.data;

3018  
NGX_OK
;

3019 
	}
}

3022 
ngx_h‰p_ç¡cgi_ùx_t
 *

3023 
	$ngx_h‰p_ç¡cgi_¥l™
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
)

3025 
ngx_h‰p_ç¡cgi_ùx_t
 *
f
;

3026 #ià(
NGX_PCRE
)

3027 
ngx_št_t
 
n
;

3028 
ÿ±u»s
[(1 + 2) * 3];

3030 
f
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

3032 ià(
f
 =ð
NULL
) {

3033 
f
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_ç¡cgi_ùx_t
));

3034 ià(
f
 =ð
NULL
) {

3035  
NULL
;

3038 
	`ngx_h‰p_£t_ùx
(
r
, 
f
, 
ngx_h‰p_ç¡cgi_moduË
);

3041 ià(
f
->
süt_Çme
.
Ën
) {

3042  
f
;

3045 ià(
æcf
->
¥l™_»gex
 =ð
NULL
) {

3046 
f
->
süt_Çme
 = 
r
->
uri
;

3047  
f
;

3050 
n
 = 
	`ngx_»gex_exec
(
æcf
->
¥l™_»gex
, &
r
->
uri
, 
ÿ±u»s
, (1 + 2) * 3);

3052 ià(
n
 >= 0) {

3053 
f
->
süt_Çme
.
Ën
 = 
ÿ±u»s
[3] - captures[2];

3054 
f
->
süt_Çme
.
d©a
 = 
r
->
uri
.d©¨+ 
ÿ±u»s
[2];

3056 
f
->
·th_šfo
.
Ën
 = 
ÿ±u»s
[5] - captures[4];

3057 
f
->
·th_šfo
.
d©a
 = 
r
->
uri
.d©¨+ 
ÿ±u»s
[4];

3059  
f
;

3062 ià(
n
 =ð
NGX_REGEX_NO_MATCHED
) {

3063 
f
->
süt_Çme
 = 
r
->
uri
;

3064  
f
;

3067 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

3068 
ngx_»gex_exec_n
 " failed: %i on \"%V\" using \"%V\"",

3069 
n
, &
r
->
uri
, &
æcf
->
¥l™_Çme
);

3070  
NULL
;

3074 
f
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ç¡cgi_moduË
);

3076 ià(
f
 =ð
NULL
) {

3077 
f
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_ç¡cgi_ùx_t
));

3078 ià(
f
 =ð
NULL
) {

3079  
NULL
;

3082 
	`ngx_h‰p_£t_ùx
(
r
, 
f
, 
ngx_h‰p_ç¡cgi_moduË
);

3085 
f
->
süt_Çme
 = 
r
->
uri
;

3087  
f
;

3090 
	}
}

3094 
	$ngx_h‰p_ç¡cgi_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3096 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
 = 
cÚf
;

3098 
ngx_u¾_t
 
u
;

3099 
ngx_¡r_t
 *
v®ue
, *
u¾
;

3100 
ngx_ušt_t
 
n
;

3101 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3102 
ngx_h‰p_süt_compže_t
 
sc
;

3104 ià(
æcf
->
up¡»am
.up¡»am || flcf->
ç¡cgi_Ëngths
) {

3108 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

3110 
þcf
->
hªdËr
 = 
ngx_h‰p_ç¡cgi_hªdËr
;

3112 ià(
þcf
->
Çme
.
d©a
[þcf->Çme.
Ën
 - 1] == '/') {

3113 
þcf
->
auto_»dœeù
 = 1;

3116 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3118 
u¾
 = &
v®ue
[1];

3120 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(
u¾
);

3122 ià(
n
) {

3124 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

3126 
sc
.
cf
 = cf;

3127 
sc
.
sourû
 = 
u¾
;

3128 
sc
.
Ëngths
 = &
æcf
->
ç¡cgi_Ëngths
;

3129 
sc
.
v®ues
 = &
æcf
->
ç¡cgi_v®ues
;

3130 
sc
.
v¬ŸbËs
 = 
n
;

3131 
sc
.
com¶‘e_Ëngths
 = 1;

3132 
sc
.
com¶‘e_v®ues
 = 1;

3134 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

3135  
NGX_CONF_ERROR
;

3138  
NGX_CONF_OK
;

3141 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

3143 
u
.
u¾
 = 
v®ue
[1];

3144 
u
.
no_»sÞve
 = 1;

3146 
æcf
->
up¡»am
.up¡»am = 
	`ngx_h‰p_up¡»am_add
(
cf
, &
u
, 0);

3147 ià(
æcf
->
up¡»am
.up¡»am =ð
NULL
) {

3148  
NGX_CONF_ERROR
;

3151  
NGX_CONF_OK
;

3152 
	}
}

3156 
	$ngx_h‰p_ç¡cgi_¥l™_·th_šfo
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3158 #ià(
NGX_PCRE
)

3159 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
 = 
cÚf
;

3161 
ngx_¡r_t
 *
v®ue
;

3162 
ngx_»gex_compže_t
 
rc
;

3163 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

3165 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3167 
æcf
->
¥l™_Çme
 = 
v®ue
[1];

3169 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

3171 
rc
.
·‰”n
 = 
v®ue
[1];

3172 
rc
.
poÞ
 = 
cf
->pool;

3173 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

3174 
rc
.
”r
.
d©a
 = 
”r¡r
;

3176 ià(
	`ngx_»gex_compže
(&
rc
è!ð
NGX_OK
) {

3177 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "%V", &
rc
.
”r
);

3178  
NGX_CONF_ERROR
;

3181 ià(
rc
.
ÿ±u»s
 != 2) {

3182 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3183 "·‰”À\"%V\" mu¡ hav2 c­tu»s", &
v®ue
[1]);

3184  
NGX_CONF_ERROR
;

3187 
æcf
->
¥l™_»gex
 = 
rc
.
»gex
;

3189  
NGX_CONF_OK
;

3193 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3194 "\"%V\"„equœe PCRE†ib¿ry", &
cmd
->
Çme
);

3195  
NGX_CONF_ERROR
;

3198 
	}
}

3202 
	$ngx_h‰p_ç¡cgi_¡Üe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3204 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
 = 
cÚf
;

3206 
ngx_¡r_t
 *
v®ue
;

3207 
ngx_h‰p_süt_compže_t
 
sc
;

3209 ià(
æcf
->
up¡»am
.
¡Üe
 !ð
NGX_CONF_UNSET


3210 || 
æcf
->
up¡»am
.
¡Üe_Ëngths
)

3215 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3217 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

3218 
æcf
->
up¡»am
.
¡Üe
 = 0;

3219  
NGX_CONF_OK
;

3222 #ià(
NGX_HTTP_CACHE
)

3224 ià(
æcf
->
up¡»am
.
ÿche
 !ð
NGX_CONF_UNSET_PTR


3225 && 
æcf
->
up¡»am
.
ÿche
 !ð
NULL
)

3232 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "on") == 0) {

3233 
æcf
->
up¡»am
.
¡Üe
 = 1;

3234  
NGX_CONF_OK
;

3238 
v®ue
[1].
Ën
++;

3240 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

3242 
sc
.
cf
 = cf;

3243 
sc
.
sourû
 = &
v®ue
[1];

3244 
sc
.
Ëngths
 = &
æcf
->
up¡»am
.
¡Üe_Ëngths
;

3245 
sc
.
v®ues
 = &
æcf
->
up¡»am
.
¡Üe_v®ues
;

3246 
sc
.
v¬ŸbËs
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
v®ue
[1]);

3247 
sc
.
com¶‘e_Ëngths
 = 1;

3248 
sc
.
com¶‘e_v®ues
 = 1;

3250 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

3251  
NGX_CONF_ERROR
;

3254  
NGX_CONF_OK
;

3255 
	}
}

3258 #ià(
NGX_HTTP_CACHE
)

3261 
	$ngx_h‰p_ç¡cgi_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3263 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
 = 
cÚf
;

3265 
ngx_¡r_t
 *
v®ue
;

3267 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3269 ià(
æcf
->
up¡»am
.
ÿche
 !ð
NGX_CONF_UNSET_PTR
) {

3273 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

3274 
æcf
->
up¡»am
.
ÿche
 = 
NULL
;

3275  
NGX_CONF_OK
;

3278 ià(
æcf
->
up¡»am
.
¡Üe
 > 0 || flcf->up¡»am.
¡Üe_Ëngths
) {

3282 
æcf
->
up¡»am
.
ÿche
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
v®ue
[1], 0,

3283 &
ngx_h‰p_ç¡cgi_moduË
);

3284 ià(
æcf
->
up¡»am
.
ÿche
 =ð
NULL
) {

3285  
NGX_CONF_ERROR
;

3288  
NGX_CONF_OK
;

3289 
	}
}

3293 
	$ngx_h‰p_ç¡cgi_ÿche_key
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3295 
ngx_h‰p_ç¡cgi_loc_cÚf_t
 *
æcf
 = 
cÚf
;

3297 
ngx_¡r_t
 *
v®ue
;

3298 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

3300 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3302 ià(
æcf
->
ÿche_key
.
v®ue
.
d©a
) {

3306 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

3308 
ccv
.
cf
 = cf;

3309 
ccv
.
v®ue
 = &value[1];

3310 
ccv
.
com¶ex_v®ue
 = &
æcf
->
ÿche_key
;

3312 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

3313  
NGX_CONF_ERROR
;

3316  
NGX_CONF_OK
;

3317 
	}
}

3323 
	$ngx_h‰p_ç¡cgi_low©_check
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

3325 #ià(
NGX_FREEBSD
)

3326 
ssize_t
 *
Å
 = 
d©a
;

3328 ià((
u_lÚg
è*
Å
 >ð
ngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
) {

3329 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3332 
ngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
);

3334  
NGX_CONF_ERROR
;

3337 #–ià!(
NGX_HAVE_SO_SNDLOWAT
)

3338 
ssize_t
 *
Å
 = 
d©a
;

3340 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

3343 *
Å
 = 0;

3347  
NGX_CONF_OK
;

3348 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_flv_module.c

7 
	~<ngx_cÚfig.h
>

8 
	~<ngx_cÜe.h
>

9 
	~<ngx_h‰p.h
>

12 *
ngx_h‰p_æv
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

14 
ngx_commªd_t
 
	gngx_h‰p_æv_commªds
[] = {

16 { 
ngx_¡ršg
("flv"),

17 
NGX_HTTP_LOC_CONF
|
NGX_CONF_NOARGS
,

18 
ngx_h‰p_æv
,

21 
NULL
 },

23 
ngx_nuÎ_commªd


27 
u_ch¬
 
	gngx_æv_h—d”
[] = "FLV\x1\x5\0\0\0\x9\0\0\0\0";

30 
ngx_h‰p_moduË_t
 
	gngx_h‰p_æv_moduË_ùx
 = {

31 
NULL
,

32 
NULL
,

34 
NULL
,

35 
NULL
,

37 
NULL
,

38 
NULL
,

40 
NULL
,

41 
NULL


45 
ngx_moduË_t
 
	gngx_h‰p_æv_moduË
 = {

46 
NGX_MODULE_V1
,

47 &
ngx_h‰p_æv_moduË_ùx
,

48 
ngx_h‰p_æv_commªds
,

49 
NGX_HTTP_MODULE
,

50 
NULL
,

51 
NULL
,

52 
NULL
,

53 
NULL
,

54 
NULL
,

55 
NULL
,

56 
NULL
,

57 
NGX_MODULE_V1_PADDING


61 
ngx_št_t


62 
	$ngx_h‰p_æv_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

64 
u_ch¬
 *
Ï¡
;

65 
off_t
 
¡¬t
, 
Ën
;

66 
size_t
 
roÙ
;

67 
ngx_št_t
 
rc
;

68 
ngx_ušt_t
 
Ëv–
, 
i
;

69 
ngx_¡r_t
 
·th
, 
v®ue
;

70 
ngx_log_t
 *
log
;

71 
ngx_buf_t
 *
b
;

72 
ngx_chaš_t
 
out
[2];

73 
ngx_Ý’_fže_šfo_t
 
of
;

74 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

76 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
))) {

77  
NGX_HTTP_NOT_ALLOWED
;

80 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] == '/') {

81  
NGX_DECLINED
;

84 
rc
 = 
	`ngx_h‰p_disÿrd_»que¡_body
(
r
);

86 ià(
rc
 !ð
NGX_OK
) {

87  
rc
;

90 
Ï¡
 = 
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0);

91 ià(
Ï¡
 =ð
NULL
) {

92  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

95 
log
 = 
r
->
cÚÃùiÚ
->log;

97 
·th
.
Ën
 = 
Ï¡
 -…©h.
d©a
;

99 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0,

100 "h‰°æv fž’ame: \"%V\"", &
·th
);

102 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

104 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

106 
of
.
»ad_ah—d
 = 
þcf
->read_ahead;

107 
of
.
dœeùio
 = 
þcf
->directio;

108 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

109 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

110 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

111 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

113 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
·th
, &
of
è!ð
NGX_OK
) {

114  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

117 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
·th
, &
of
, 
r
->
poÞ
)

118 !ð
NGX_OK
)

120 
of
.
”r
) {

123  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

125 
NGX_ENOENT
:

126 
NGX_ENOTDIR
:

127 
NGX_ENAMETOOLONG
:

129 
Ëv–
 = 
NGX_LOG_ERR
;

130 
rc
 = 
NGX_HTTP_NOT_FOUND
;

133 
NGX_EACCES
:

134 #ià(
NGX_HAVE_OPENAT
)

135 
NGX_EMLINK
:

136 
NGX_ELOOP
:

139 
Ëv–
 = 
NGX_LOG_ERR
;

140 
rc
 = 
NGX_HTTP_FORBIDDEN
;

145 
Ëv–
 = 
NGX_LOG_CRIT
;

146 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

150 ià(
rc
 !ð
NGX_HTTP_NOT_FOUND
 || 
þcf
->
log_nÙ_found
) {

151 
	`ngx_log_”rÜ
(
Ëv–
, 
log
, 
of
.
”r
,

152 "% \"%s\" fažed", 
of
.
çžed
, 
·th
.
d©a
);

155  
rc
;

158 ià(!
of
.
is_fže
) {

160 ià(
	`ngx_þo£_fže
(
of
.
fd
è=ð
NGX_FILE_ERROR
) {

161 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

162 
ngx_þo£_fže_n
 " \"%s\" fažed", 
·th
.
d©a
);

165  
NGX_DECLINED
;

168 
r
->
roÙ_‹¡ed
 = !r->
”rÜ_·ge
;

170 
¡¬t
 = 0;

171 
Ën
 = 
of
.
size
;

172 
i
 = 1;

174 ià(
r
->
¬gs
.
Ën
) {

176 ià(
	`ngx_h‰p_¬g
(
r
, (
u_ch¬
 *è"¡¬t", 5, &
v®ue
è=ð
NGX_OK
) {

178 
¡¬t
 = 
	`ngx_©oof
(
v®ue
.
d©a
, v®ue.
Ën
);

180 ià(
¡¬t
 =ð
NGX_ERROR
 || s¹ >ð
Ën
) {

181 
¡¬t
 = 0;

184 ià(
¡¬t
) {

185 
Ën
 = (
ngx_æv_h—d”
è- 1 +†’ - 
¡¬t
;

186 
i
 = 0;

191 
log
->
aùiÚ
 = "sending flvo client";

193 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_OK
;

194 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
Ën
;

195 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = 
of
.
mtime
;

197 ià(
	`ngx_h‰p_£t_‘ag
(
r
è!ð
NGX_OK
) {

198  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

201 ià(
	`ngx_h‰p_£t_cÚ‹Á_ty³
(
r
è!ð
NGX_OK
) {

202  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

205 ià(
i
 == 0) {

206 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

207 ià(
b
 =ð
NULL
) {

208  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

211 
b
->
pos
 = 
ngx_æv_h—d”
;

212 
b
->
Ï¡
 = 
ngx_æv_h—d”
 + (ngx_flv_header) - 1;

213 
b
->
memÜy
 = 1;

215 
out
[0].
buf
 = 
b
;

216 
out
[0].
Ãxt
 = &out[1];

220 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

221 ià(
b
 =ð
NULL
) {

222  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

225 
b
->
fže
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_fže_t
));

226 ià(
b
->
fže
 =ð
NULL
) {

227  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

230 
r
->
®low_¿nges
 = 1;

232 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

234 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

235  
rc
;

238 
b
->
fže_pos
 = 
¡¬t
;

239 
b
->
fže_Ï¡
 = 
of
.
size
;

241 
b
->
š_fže
 = b->
fže_Ï¡
 ? 1: 0;

242 
b
->
Ï¡_buf
 = (
r
 =ðr->
maš
) ? 1 : 0;

243 
b
->
Ï¡_š_chaš
 = 1;

245 
b
->
fže
->
fd
 = 
of
.fd;

246 
b
->
fže
->
Çme
 = 
·th
;

247 
b
->
fže
->
log
 =†og;

248 
b
->
fže
->
dœeùio
 = 
of
.
is_dœeùio
;

250 
out
[1].
buf
 = 
b
;

251 
out
[1].
Ãxt
 = 
NULL
;

253  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
[
i
]);

254 
	}
}

258 
	$ngx_h‰p_æv
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

260 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

262 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

263 
þcf
->
hªdËr
 = 
ngx_h‰p_æv_hªdËr
;

265  
NGX_CONF_OK
;

266 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_geo_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
	mv®ue
;

15 
u_shÜt
 
	m¡¬t
;

16 
u_shÜt
 
	m’d
;

17 } 
	tngx_h‰p_geo_¿nge_t
;

21 
ngx_¿dix_Œ“_t
 *
	mŒ“
;

22 #ià(
NGX_HAVE_INET6
)

23 
ngx_¿dix_Œ“_t
 *
	mŒ“6
;

25 } 
	tngx_h‰p_geo_Œ“s_t
;

29 
ngx_h‰p_geo_¿nge_t
 **
	mlow
;

30 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
	mdeçuÉ_v®ue
;

31 } 
	tngx_h‰p_geo_high_¿nges_t
;

35 
ngx_¡r_node_t
 
	m¢
;

36 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
	mv®ue
;

37 
size_t
 
	moff£t
;

38 } 
	tngx_h‰p_geo_v¬ŸbË_v®ue_node_t
;

42 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
	mv®ue
;

43 
ngx_¡r_t
 *
	mÃt
;

44 
ngx_h‰p_geo_high_¿nges_t
 
	mhigh
;

45 
ngx_¿dix_Œ“_t
 *
	mŒ“
;

46 #ià(
NGX_HAVE_INET6
)

47 
ngx_¿dix_Œ“_t
 *
	mŒ“6
;

49 
ngx_rbŒ“_t
 
	mrbŒ“
;

50 
ngx_rbŒ“_node_t
 
	m£Áš–
;

51 
ngx_¬¿y_t
 *
	m´ox›s
;

52 
ngx_poÞ_t
 *
	mpoÞ
;

53 
ngx_poÞ_t
 *
	m‹mp_poÞ
;

55 
size_t
 
	md©a_size
;

57 
ngx_¡r_t
 
	mšþude_Çme
;

58 
ngx_ušt_t
 
	mšþudes
;

59 
ngx_ušt_t
 
	m’Œ›s
;

61 
	m¿nges
:1;

62 
	moutside_’Œ›s
:1;

63 
	m®low_bš¬y_šþude
:1;

64 
	mbš¬y_šþude
:1;

65 
	m´oxy_»cursive
:1;

66 } 
	tngx_h‰p_geo_cÚf_ùx_t
;

71 
ngx_h‰p_geo_Œ“s_t
 
	mŒ“s
;

72 
ngx_h‰p_geo_high_¿nges_t
 
	mhigh
;

73 } 
	mu
;

75 
ngx_¬¿y_t
 *
	m´ox›s
;

76 
	m´oxy_»cursive
:1;

78 
ngx_št_t
 
	mšdex
;

79 } 
	tngx_h‰p_geo_ùx_t
;

82 
ngx_št_t
 
ngx_h‰p_geo_addr
(
ngx_h‰p_»que¡_t
 *
r
,

83 
ngx_h‰p_geo_ùx_t
 *
ùx
, 
ngx_addr_t
 *
addr
);

84 
ngx_št_t
 
ngx_h‰p_geo_»®_addr
(
ngx_h‰p_»que¡_t
 *
r
,

85 
ngx_h‰p_geo_ùx_t
 *
ùx
, 
ngx_addr_t
 *
addr
);

86 *
ngx_h‰p_geo_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

87 *
ngx_h‰p_geo
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
, *
cÚf
);

88 *
ngx_h‰p_geo_¿nge
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

89 
ngx_¡r_t
 *
v®ue
);

90 *
ngx_h‰p_geo_add_¿nge
(
ngx_cÚf_t
 *
cf
,

91 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
, 
š_addr_t
 
¡¬t
, in_addr_ˆ
’d
);

92 
ngx_ušt_t
 
ngx_h‰p_geo_d–‘e_¿nge
(
ngx_cÚf_t
 *
cf
,

93 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
, 
š_addr_t
 
¡¬t
, in_addr_ˆ
’d
);

94 *
ngx_h‰p_geo_cidr
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

95 
ngx_¡r_t
 *
v®ue
);

96 *
ngx_h‰p_geo_cidr_add
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

97 
ngx_cidr_t
 *
cidr
, 
ngx_¡r_t
 *
v®ue
,‚gx_¡r_ˆ*
Ãt
);

98 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
ngx_h‰p_geo_v®ue
(
ngx_cÚf_t
 *
cf
,

99 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
v®ue
);

100 *
ngx_h‰p_geo_add_´oxy
(
ngx_cÚf_t
 *
cf
,

101 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
, 
ngx_cidr_t
 *
cidr
);

102 
ngx_št_t
 
ngx_h‰p_geo_cidr_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
Ãt
,

103 
ngx_cidr_t
 *
cidr
);

104 *
ngx_h‰p_geo_šþude
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

105 
ngx_¡r_t
 *
Çme
);

106 
ngx_št_t
 
ngx_h‰p_geo_šþude_bš¬y_ba£
(
ngx_cÚf_t
 *
cf
,

107 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
Çme
);

108 
ngx_h‰p_geo_ü—‹_bš¬y_ba£
(
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
);

109 
u_ch¬
 *
ngx_h‰p_geo_cÝy_v®ues
(u_ch¬ *
ba£
, u_ch¬ *
p
,

110 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
);

113 
ngx_commªd_t
 
	gngx_h‰p_geo_commªds
[] = {

115 { 
ngx_¡ršg
("geo"),

116 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_TAKE12
,

117 
ngx_h‰p_geo_block
,

118 
NGX_HTTP_MAIN_CONF_OFFSET
,

120 
NULL
 },

122 
ngx_nuÎ_commªd


126 
ngx_h‰p_moduË_t
 
	gngx_h‰p_geo_moduË_ùx
 = {

127 
NULL
,

128 
NULL
,

130 
NULL
,

131 
NULL
,

133 
NULL
,

134 
NULL
,

136 
NULL
,

137 
NULL


141 
ngx_moduË_t
 
	gngx_h‰p_geo_moduË
 = {

142 
NGX_MODULE_V1
,

143 &
ngx_h‰p_geo_moduË_ùx
,

144 
ngx_h‰p_geo_commªds
,

145 
NGX_HTTP_MODULE
,

146 
NULL
,

147 
NULL
,

148 
NULL
,

149 
NULL
,

150 
NULL
,

151 
NULL
,

152 
NULL
,

153 
NGX_MODULE_V1_PADDING


158 
u_ch¬
 
	mGEORNG
[6];

159 
u_ch¬
 
	mv”siÚ
;

160 
u_ch¬
 
	m±r_size
;

161 
ušt32_t
 
	m’dŸÂess
;

162 
ušt32_t
 
	müc32
;

163 } 
	tngx_h‰p_geo_h—d”_t
;

166 
ngx_h‰p_geo_h—d”_t
 
	gngx_h‰p_geo_h—d”
 = {

173 
ngx_št_t


174 
	$ngx_h‰p_geo_cidr_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

175 
ušŒ_t
 
d©a
)

177 
ngx_h‰p_geo_ùx_t
 *
ùx
 = (ngx_h‰p_geo_ùx_ˆ*è
d©a
;

179 
š_addr_t
 
šaddr
;

180 
ngx_addr_t
 
addr
;

181 
sockaddr_š
 *
sš
;

182 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

183 #ià(
NGX_HAVE_INET6
)

184 
u_ch¬
 *
p
;

185 
š6_addr
 *
šaddr6
;

188 ià(
	`ngx_h‰p_geo_addr
(
r
, 
ùx
, &
addr
è!ð
NGX_OK
) {

189 
vv
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *)

190 
	`ngx_¿dix32Œ“_fšd
(
ùx
->
u
.
Œ“s
.
Œ“
, 
INADDR_NONE
);

191 
dÚe
;

194 
addr
.
sockaddr
->
§_çmžy
) {

196 #ià(
NGX_HAVE_INET6
)

197 
AF_INET6
:

198 
šaddr6
 = &((
sockaddr_š6
 *è
addr
.
sockaddr
)->
sš6_addr
;

199 
p
 = 
šaddr6
->
s6_addr
;

201 ià(
	`IN6_IS_ADDR_V4MAPPED
(
šaddr6
)) {

202 
šaddr
 = 
p
[12] << 24;

203 
šaddr
 +ð
p
[13] << 16;

204 
šaddr
 +ð
p
[14] << 8;

205 
šaddr
 +ð
p
[15];

207 
vv
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *)

208 
	`ngx_¿dix32Œ“_fšd
(
ùx
->
u
.
Œ“s
.
Œ“
, 
šaddr
);

211 
vv
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *)

212 
	`ngx_¿dix128Œ“_fšd
(
ùx
->
u
.
Œ“s
.
Œ“6
, 
p
);

219 
sš
 = (
sockaddr_š
 *è
addr
.
sockaddr
;

220 
šaddr
 = 
	`Áohl
(
sš
->
sš_addr
.
s_addr
);

222 
vv
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *)

223 
	`ngx_¿dix32Œ“_fšd
(
ùx
->
u
.
Œ“s
.
Œ“
, 
šaddr
);

228 
dÚe
:

230 *
v
 = *
vv
;

232 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

233 "h‰°geo: %v", 
v
);

235  
NGX_OK
;

236 
	}
}

239 
ngx_št_t


240 
	$ngx_h‰p_geo_¿nge_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

241 
ušŒ_t
 
d©a
)

243 
ngx_h‰p_geo_ùx_t
 *
ùx
 = (ngx_h‰p_geo_ùx_ˆ*è
d©a
;

245 
š_addr_t
 
šaddr
;

246 
ngx_addr_t
 
addr
;

247 
ngx_ušt_t
 
n
;

248 
sockaddr_š
 *
sš
;

249 
ngx_h‰p_geo_¿nge_t
 *
¿nge
;

250 #ià(
NGX_HAVE_INET6
)

251 
u_ch¬
 *
p
;

252 
š6_addr
 *
šaddr6
;

255 *
v
 = *
ùx
->
u
.
high
.
deçuÉ_v®ue
;

257 ià(
	`ngx_h‰p_geo_addr
(
r
, 
ùx
, &
addr
è=ð
NGX_OK
) {

259 
addr
.
sockaddr
->
§_çmžy
) {

261 #ià(
NGX_HAVE_INET6
)

262 
AF_INET6
:

263 
šaddr6
 = &((
sockaddr_š6
 *è
addr
.
sockaddr
)->
sš6_addr
;

265 ià(
	`IN6_IS_ADDR_V4MAPPED
(
šaddr6
)) {

266 
p
 = 
šaddr6
->
s6_addr
;

268 
šaddr
 = 
p
[12] << 24;

269 
šaddr
 +ð
p
[13] << 16;

270 
šaddr
 +ð
p
[14] << 8;

271 
šaddr
 +ð
p
[15];

274 
šaddr
 = 
INADDR_NONE
;

281 
sš
 = (
sockaddr_š
 *è
addr
.
sockaddr
;

282 
šaddr
 = 
	`Áohl
(
sš
->
sš_addr
.
s_addr
);

287 
šaddr
 = 
INADDR_NONE
;

290 ià(
ùx
->
u
.
high
.
low
) {

291 
¿nge
 = 
ùx
->
u
.
high
.
low
[
šaddr
 >> 16];

293 ià(
¿nge
) {

294 
n
 = 
šaddr
 & 0xffff;

296 ià(
n
 >ð(
ngx_ušt_t
è
¿nge
->
¡¬t


297 && 
n
 <ð(
ngx_ušt_t
è
¿nge
->
’d
)

299 *
v
 = *
¿nge
->
v®ue
;

302 } (++
¿nge
)->
v®ue
);

306 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

307 "h‰°geo: %v", 
v
);

309  
NGX_OK
;

310 
	}
}

313 
ngx_št_t


314 
	$ngx_h‰p_geo_addr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_geo_ùx_t
 *
ùx
,

315 
ngx_addr_t
 *
addr
)

317 
ngx_¬¿y_t
 *
xfwd
;

319 ià(
	`ngx_h‰p_geo_»®_addr
(
r
, 
ùx
, 
addr
è!ð
NGX_OK
) {

320  
NGX_ERROR
;

323 
xfwd
 = &
r
->
h—d”s_š
.
x_fÜw¬ded_fÜ
;

325 ià(
xfwd
->
ÃÉs
 > 0 && 
ùx
->
´ox›s
 !ð
NULL
) {

326 (è
	`ngx_h‰p_g‘_fÜw¬ded_addr
(
r
, 
addr
, 
xfwd
, 
NULL
,

327 
ùx
->
´ox›s
, ctx->
´oxy_»cursive
);

330  
NGX_OK
;

331 
	}
}

334 
ngx_št_t


335 
	$ngx_h‰p_geo_»®_addr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_geo_ùx_t
 *
ùx
,

336 
ngx_addr_t
 *
addr
)

338 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
;

340 ià(
ùx
->
šdex
 == -1) {

341 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

342 "h‰°geØ¡¬‹d: %V", &
r
->
cÚÃùiÚ
->
addr_‹xt
);

344 
addr
->
sockaddr
 = 
r
->
cÚÃùiÚ
->sockaddr;

345 
addr
->
sockËn
 = 
r
->
cÚÃùiÚ
->socklen;

348  
NGX_OK
;

351 
v
 = 
	`ngx_h‰p_g‘_æushed_v¬ŸbË
(
r
, 
ùx
->
šdex
);

353 ià(
v
 =ð
NULL
 || v->
nÙ_found
) {

354 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

357  
NGX_ERROR
;

360 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

361 "h‰°geØ¡¬‹d: %v", 
v
);

363 ià(
	`ngx_·r£_addr
(
r
->
poÞ
, 
addr
, 
v
->
d©a
, v->
Ën
è=ð
NGX_OK
) {

364  
NGX_OK
;

367  
NGX_ERROR
;

368 
	}
}

372 
	$ngx_h‰p_geo_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

374 *
rv
;

375 
size_t
 
Ën
;

376 
ngx_¡r_t
 *
v®ue
, 
Çme
;

377 
ngx_ušt_t
 
i
;

378 
ngx_cÚf_t
 
§ve
;

379 
ngx_poÞ_t
 *
poÞ
;

380 
ngx_¬¿y_t
 *
a
;

381 
ngx_h‰p_v¬ŸbË_t
 *
v¬
;

382 
ngx_h‰p_geo_ùx_t
 *
geo
;

383 
ngx_h‰p_geo_cÚf_ùx_t
 
ùx
;

384 #ià(
NGX_HAVE_INET6
)

385 
š6_addr
 
z”o
;

388 
v®ue
 = 
cf
->
¬gs
->
–ts
;

390 
geo
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_geo_ùx_t
));

391 ià(
geo
 =ð
NULL
) {

392  
NGX_CONF_ERROR
;

395 
Çme
 = 
v®ue
[1];

397 ià(
Çme
.
d©a
[0] != '$') {

398 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

399 "šv®id v¬ŸbË‚am\"%V\"", &
Çme
);

400  
NGX_CONF_ERROR
;

403 
Çme
.
Ën
--;

404 
Çme
.
d©a
++;

406 ià(
cf
->
¬gs
->
ÃÉs
 == 3) {

408 
geo
->
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, &
Çme
);

409 ià(
geo
->
šdex
 =ð
NGX_ERROR
) {

410  
NGX_CONF_ERROR
;

413 
Çme
 = 
v®ue
[2];

415 ià(
Çme
.
d©a
[0] != '$') {

416 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

417 "šv®id v¬ŸbË‚am\"%V\"", &
Çme
);

418  
NGX_CONF_ERROR
;

421 
Çme
.
Ën
--;

422 
Çme
.
d©a
++;

425 
geo
->
šdex
 = -1;

428 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
Çme
, 
NGX_HTTP_VAR_CHANGEABLE
);

429 ià(
v¬
 =ð
NULL
) {

430  
NGX_CONF_ERROR
;

433 
poÞ
 = 
	`ngx_ü—‹_poÞ
(
NGX_DEFAULT_POOL_SIZE
, 
cf
->
log
);

434 ià(
poÞ
 =ð
NULL
) {

435  
NGX_CONF_ERROR
;

438 
	`ngx_memz”o
(&
ùx
, (
ngx_h‰p_geo_cÚf_ùx_t
));

440 
ùx
.
‹mp_poÞ
 = 
	`ngx_ü—‹_poÞ
(
NGX_DEFAULT_POOL_SIZE
, 
cf
->
log
);

441 ià(
ùx
.
‹mp_poÞ
 =ð
NULL
) {

442  
NGX_CONF_ERROR
;

445 
	`ngx_rbŒ“_š™
(&
ùx
.
rbŒ“
, &ùx.
£Áš–
, 
ngx_¡r_rbŒ“_š£¹_v®ue
);

447 
ùx
.
poÞ
 = 
cf
->pool;

448 
ùx
.
d©a_size
 = (
ngx_h‰p_geo_h—d”_t
)

449 + (
ngx_h‰p_v¬ŸbË_v®ue_t
)

450 + 0x10000 * (
ngx_h‰p_geo_¿nge_t
 *);

451 
ùx
.
®low_bš¬y_šþude
 = 1;

453 
§ve
 = *
cf
;

454 
cf
->
poÞ
 =…ool;

455 
cf
->
ùx
 = &ctx;

456 
cf
->
hªdËr
 = 
ngx_h‰p_geo
;

457 
cf
->
hªdËr_cÚf
 = 
cÚf
;

459 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

461 *
cf
 = 
§ve
;

463 
geo
->
´ox›s
 = 
ùx
.proxies;

464 
geo
->
´oxy_»cursive
 = 
ùx
.proxy_recursive;

466 ià(
ùx
.
¿nges
) {

468 ià(
ùx
.
high
.
low
 && !ùx.
bš¬y_šþude
) {

469 
i
 = 0; i < 0x10000; i++) {

470 
a
 = (
ngx_¬¿y_t
 *è
ùx
.
high
.
low
[
i
];

472 ià(
a
 =ð
NULL
 ||‡->
ÃÉs
 == 0) {

476 
Ën
 = 
a
->
ÃÉs
 * (
ngx_h‰p_geo_¿nge_t
);

478 
ùx
.
high
.
low
[
i
] = 
	`ngx_·Îoc
(
cf
->
poÞ
, 
Ën
 + (*));

479 ià(
ùx
.
high
.
low
[
i
] =ð
NULL
) {

480  
NGX_CONF_ERROR
;

483 
	`ngx_memýy
(
ùx
.
high
.
low
[
i
], 
a
->
–ts
, 
Ën
);

484 
ùx
.
high
.
low
[
i
][
a
->
ÃÉs
].
v®ue
 = 
NULL
;

485 
ùx
.
d©a_size
 +ð
Ën
 + (*);

488 ià(
ùx
.
®low_bš¬y_šþude


489 && !
ùx
.
outside_’Œ›s


490 && 
ùx
.
’Œ›s
 > 100000

491 && 
ùx
.
šþudes
 == 1)

493 
	`ngx_h‰p_geo_ü—‹_bš¬y_ba£
(&
ùx
);

497 ià(
ùx
.
high
.
deçuÉ_v®ue
 =ð
NULL
) {

498 
ùx
.
high
.
deçuÉ_v®ue
 = &
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

501 
geo
->
u
.
high
 = 
ùx
.high;

503 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_geo_¿nge_v¬ŸbË
;

504 
v¬
->
d©a
 = (
ušŒ_t
è
geo
;

506 
	`ngx_de¡roy_poÞ
(
ùx
.
‹mp_poÞ
);

507 
	`ngx_de¡roy_poÞ
(
poÞ
);

510 ià(
ùx
.
Œ“
 =ð
NULL
) {

511 
ùx
.
Œ“
 = 
	`ngx_¿dix_Œ“_ü—‹
(
cf
->
poÞ
, -1);

512 ià(
ùx
.
Œ“
 =ð
NULL
) {

513  
NGX_CONF_ERROR
;

517 
geo
->
u
.
Œ“s
.
Œ“
 = 
ùx
.tree;

519 #ià(
NGX_HAVE_INET6
)

520 ià(
ùx
.
Œ“6
 =ð
NULL
) {

521 
ùx
.
Œ“6
 = 
	`ngx_¿dix_Œ“_ü—‹
(
cf
->
poÞ
, -1);

522 ià(
ùx
.
Œ“6
 =ð
NULL
) {

523  
NGX_CONF_ERROR
;

527 
geo
->
u
.
Œ“s
.
Œ“6
 = 
ùx
.tree6;

530 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_geo_cidr_v¬ŸbË
;

531 
v¬
->
d©a
 = (
ušŒ_t
è
geo
;

533 
	`ngx_de¡roy_poÞ
(
ùx
.
‹mp_poÞ
);

534 
	`ngx_de¡roy_poÞ
(
poÞ
);

536 ià(
	`ngx_¿dix32Œ“_š£¹
(
ùx
.
Œ“
, 0, 0,

537 (
ušŒ_t
è&
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
)

538 =ð
NGX_ERROR
)

540  
NGX_CONF_ERROR
;

545 #ià(
NGX_HAVE_INET6
)

546 ià(
	`ngx_¿dix128Œ“_š£¹
(
ùx
.
Œ“6
, 
z”o
.
s6_addr
, zero.s6_addr,

547 (
ušŒ_t
è&
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
)

548 =ð
NGX_ERROR
)

550  
NGX_CONF_ERROR
;

555  
rv
;

556 
	}
}

560 
	$ngx_h‰p_geo
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
, *
cÚf
)

562 *
rv
;

563 
ngx_¡r_t
 *
v®ue
;

564 
ngx_cidr_t
 
cidr
;

565 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
;

567 
ùx
 = 
cf
->ctx;

569 
v®ue
 = 
cf
->
¬gs
->
–ts
;

571 ià(
cf
->
¬gs
->
ÃÉs
 == 1) {

573 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "ranges") == 0) {

575 ià(
ùx
->
Œ“


576 #ià(
NGX_HAVE_INET6
)

577 || 
ùx
->
Œ“6


581 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

584 
çžed
;

587 
ùx
->
¿nges
 = 1;

589 
rv
 = 
NGX_CONF_OK
;

591 
dÚe
;

594 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "proxy_recursive") == 0) {

595 
ùx
->
´oxy_»cursive
 = 1;

596 
rv
 = 
NGX_CONF_OK
;

597 
dÚe
;

601 ià(
cf
->
¬gs
->
ÃÉs
 != 2) {

602 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

604 
çžed
;

607 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "include") == 0) {

609 
rv
 = 
	`ngx_h‰p_geo_šþude
(
cf
, 
ùx
, &
v®ue
[1]);

611 
dÚe
;

613 } ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "proxy") == 0) {

615 ià(
	`ngx_h‰p_geo_cidr_v®ue
(
cf
, &
v®ue
[1], &
cidr
è!ð
NGX_OK
) {

616 
çžed
;

619 
rv
 = 
	`ngx_h‰p_geo_add_´oxy
(
cf
, 
ùx
, &
cidr
);

621 
dÚe
;

624 ià(
ùx
->
¿nges
) {

625 
rv
 = 
	`ngx_h‰p_geo_¿nge
(
cf
, 
ùx
, 
v®ue
);

628 
rv
 = 
	`ngx_h‰p_geo_cidr
(
cf
, 
ùx
, 
v®ue
);

631 
dÚe
:

633 
	`ngx_»£t_poÞ
(
cf
->
poÞ
);

635  
rv
;

637 
çžed
:

639 
	`ngx_»£t_poÞ
(
cf
->
poÞ
);

641  
NGX_CONF_ERROR
;

642 
	}
}

646 
	$ngx_h‰p_geo_¿nge
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

647 
ngx_¡r_t
 *
v®ue
)

649 
u_ch¬
 *
p
, *
Ï¡
;

650 
š_addr_t
 
¡¬t
, 
’d
;

651 
ngx_¡r_t
 *
Ãt
;

652 
ngx_ušt_t
 
d–
;

654 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "default") == 0) {

656 ià(
ùx
->
high
.
deçuÉ_v®ue
) {

657 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

659 &
v®ue
[1], 
ùx
->
high
.
deçuÉ_v®ue
);

662 
ùx
->
high
.
deçuÉ_v®ue
 = 
	`ngx_h‰p_geo_v®ue
(
cf
, ctx, &
v®ue
[1]);

663 ià(
ùx
->
high
.
deçuÉ_v®ue
 =ð
NULL
) {

664  
NGX_CONF_ERROR
;

667  
NGX_CONF_OK
;

670 ià(
ùx
->
bš¬y_šþude
) {

671 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

673 
ùx
->
šþude_Çme
.
d©a
);

674  
NGX_CONF_ERROR
;

677 ià(
ùx
->
high
.
low
 =ð
NULL
) {

678 
ùx
->
high
.
low
 = 
	`ngx_pÿÎoc
(ùx->
poÞ
,

679 0x10000 * (
ngx_h‰p_geo_¿nge_t
 *));

680 ià(
ùx
->
high
.
low
 =ð
NULL
) {

681  
NGX_CONF_ERROR
;

685 
ùx
->
’Œ›s
++;

686 
ùx
->
outside_’Œ›s
 = 1;

688 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "delete") == 0) {

689 
Ãt
 = &
v®ue
[1];

690 
d–
 = 1;

693 
Ãt
 = &
v®ue
[0];

694 
d–
 = 0;

697 
Ï¡
 = 
Ãt
->
d©a
 +‚‘->
Ën
;

699 
p
 = 
	`ngx_¡¾chr
(
Ãt
->
d©a
, 
Ï¡
, '-');

701 ià(
p
 =ð
NULL
) {

702 
šv®id
;

705 
¡¬t
 = 
	`ngx_š‘_addr
(
Ãt
->
d©a
, 
p
 -‚et->data);

707 ià(
¡¬t
 =ð
INADDR_NONE
) {

708 
šv®id
;

711 
¡¬t
 = 
	`Áohl
(start);

713 
p
++;

715 
’d
 = 
	`ngx_š‘_addr
(
p
, 
Ï¡
 -…);

717 ià(
’d
 =ð
INADDR_NONE
) {

718 
šv®id
;

721 
’d
 = 
	`Áohl
(end);

723 ià(
¡¬t
 > 
’d
) {

724 
šv®id
;

727 ià(
d–
) {

728 ià(
	`ngx_h‰p_geo_d–‘e_¿nge
(
cf
, 
ùx
, 
¡¬t
, 
’d
)) {

729 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

730 "nØadd»s ¿ng\"%V\"Ød–‘e", 
Ãt
);

733  
NGX_CONF_OK
;

736 
ùx
->
v®ue
 = 
	`ngx_h‰p_geo_v®ue
(
cf
, ctx, &value[1]);

738 ià(
ùx
->
v®ue
 =ð
NULL
) {

739  
NGX_CONF_ERROR
;

742 
ùx
->
Ãt
 =‚et;

744  
	`ngx_h‰p_geo_add_¿nge
(
cf
, 
ùx
, 
¡¬t
, 
’d
);

746 
šv®id
:

748 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "šv®id„ªg\"%V\"", 
Ãt
);

750  
NGX_CONF_ERROR
;

751 
	}
}

757 
	$ngx_h‰p_geo_add_¿nge
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

758 
š_addr_t
 
¡¬t
, in_addr_ˆ
’d
)

760 
š_addr_t
 
n
;

761 
ngx_ušt_t
 
h
, 
i
, 
s
, 
e
;

762 
ngx_¬¿y_t
 *
a
;

763 
ngx_h‰p_geo_¿nge_t
 *
¿nge
;

765 
n
 = 
¡¬t
;‚ <ð
’d
;‚ = (n + 0x10000) & 0xffff0000) {

767 
h
 = 
n
 >> 16;

769 ià(
n
 =ð
¡¬t
) {

770 
s
 = 
n
 & 0xffff;

772 
s
 = 0;

775 ià((
n
 | 0xffffè> 
’d
) {

776 
e
 = 
’d
 & 0xffff;

779 
e
 = 0xffff;

782 
a
 = (
ngx_¬¿y_t
 *è
ùx
->
high
.
low
[
h
];

784 ià(
a
 =ð
NULL
) {

785 
a
 = 
	`ngx_¬¿y_ü—‹
(
ùx
->
‹mp_poÞ
, 64,

786 (
ngx_h‰p_geo_¿nge_t
));

787 ià(
a
 =ð
NULL
) {

788  
NGX_CONF_ERROR
;

791 
ùx
->
high
.
low
[
h
] = (
ngx_h‰p_geo_¿nge_t
 *è
a
;

794 
i
 = 
a
->
ÃÉs
;

795 
¿nge
 = 
a
->
–ts
;

797 
i
) {

799 
i
--;

801 ià(
e
 < (
ngx_ušt_t
è
¿nge
[
i
].
¡¬t
) {

805 ià(
s
 > (
ngx_ušt_t
è
¿nge
[
i
].
’d
) {

809 
¿nge
 = 
	`ngx_¬¿y_push
(
a
);

810 ià(
¿nge
 =ð
NULL
) {

811  
NGX_CONF_ERROR
;

814 
¿nge
 = 
a
->
–ts
;

816 
	`ngx_memmove
(&
¿nge
[
i
 + 2], &range[i + 1],

817 (
a
->
ÃÉs
 - 2 - 
i
è* (
ngx_h‰p_geo_¿nge_t
));

819 
¿nge
[
i
 + 1].
¡¬t
 = (
u_shÜt
è
s
;

820 
¿nge
[
i
 + 1].
’d
 = (
u_shÜt
è
e
;

821 
¿nge
[
i
 + 1].
v®ue
 = 
ùx
->value;

823 
Ãxt
;

826 ià(
s
 =ð(
ngx_ušt_t
è
¿nge
[
i
].
¡¬t


827 && 
e
 =ð(
ngx_ušt_t
è
¿nge
[
i
].
’d
)

829 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

831 
ùx
->
Ãt
, ctx->
v®ue
, 
¿nge
[
i
].value);

833 
¿nge
[
i
].
v®ue
 = 
ùx
->value;

835 
Ãxt
;

838 ià(
s
 > (
ngx_ušt_t
è
¿nge
[
i
].
¡¬t


839 && 
e
 < (
ngx_ušt_t
è
¿nge
[
i
].
’d
)

843 
¿nge
 = 
	`ngx_¬¿y_push
(
a
);

844 ià(
¿nge
 =ð
NULL
) {

845  
NGX_CONF_ERROR
;

848 
¿nge
 = 
	`ngx_¬¿y_push
(
a
);

849 ià(
¿nge
 =ð
NULL
) {

850  
NGX_CONF_ERROR
;

853 
¿nge
 = 
a
->
–ts
;

855 
	`ngx_memmove
(&
¿nge
[
i
 + 3], &range[i + 1],

856 (
a
->
ÃÉs
 - 3 - 
i
è* (
ngx_h‰p_geo_¿nge_t
));

858 
¿nge
[
i
 + 2].
¡¬t
 = (
u_shÜt
è(
e
 + 1);

859 
¿nge
[
i
 + 2].
’d
 =„ange[i].end;

860 
¿nge
[
i
 + 2].
v®ue
 =„ange[i].value;

862 
¿nge
[
i
 + 1].
¡¬t
 = (
u_shÜt
è
s
;

863 
¿nge
[
i
 + 1].
’d
 = (
u_shÜt
è
e
;

864 
¿nge
[
i
 + 1].
v®ue
 = 
ùx
->value;

866 
¿nge
[
i
].
’d
 = (
u_shÜt
è(
s
 - 1);

868 
Ãxt
;

871 ià(
s
 =ð(
ngx_ušt_t
è
¿nge
[
i
].
¡¬t


872 && 
e
 < (
ngx_ušt_t
è
¿nge
[
i
].
’d
)

876 
¿nge
 = 
	`ngx_¬¿y_push
(
a
);

877 ià(
¿nge
 =ð
NULL
) {

878  
NGX_CONF_ERROR
;

881 
¿nge
 = 
a
->
–ts
;

883 
	`ngx_memmove
(&
¿nge
[
i
 + 1], &range[i],

884 (
a
->
ÃÉs
 - 1 - 
i
è* (
ngx_h‰p_geo_¿nge_t
));

886 
¿nge
[
i
 + 1].
¡¬t
 = (
u_shÜt
è(
e
 + 1);

888 
¿nge
[
i
].
¡¬t
 = (
u_shÜt
è
s
;

889 
¿nge
[
i
].
’d
 = (
u_shÜt
è
e
;

890 
¿nge
[
i
].
v®ue
 = 
ùx
->value;

892 
Ãxt
;

895 ià(
s
 > (
ngx_ušt_t
è
¿nge
[
i
].
¡¬t


896 && 
e
 =ð(
ngx_ušt_t
è
¿nge
[
i
].
’d
)

900 
¿nge
 = 
	`ngx_¬¿y_push
(
a
);

901 ià(
¿nge
 =ð
NULL
) {

902  
NGX_CONF_ERROR
;

905 
¿nge
 = 
a
->
–ts
;

907 
	`ngx_memmove
(&
¿nge
[
i
 + 2], &range[i + 1],

908 (
a
->
ÃÉs
 - 2 - 
i
è* (
ngx_h‰p_geo_¿nge_t
));

910 
¿nge
[
i
 + 1].
¡¬t
 = (
u_shÜt
è
s
;

911 
¿nge
[
i
 + 1].
’d
 = (
u_shÜt
è
e
;

912 
¿nge
[
i
 + 1].
v®ue
 = 
ùx
->value;

914 
¿nge
[
i
].
’d
 = (
u_shÜt
è(
s
 - 1);

916 
Ãxt
;

919 
s
 = (
ngx_ušt_t
è
¿nge
[
i
].
¡¬t
;

920 
e
 = (
ngx_ušt_t
è
¿nge
[
i
].
’d
;

922 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

924 
ùx
->
Ãt
,

925 
h
 >> 8, h & 0xff, 
s
 >> 8, s & 0xff,

926 
h
 >> 8, h & 0xff, 
e
 >> 8,ƒ & 0xff);

928  
NGX_CONF_ERROR
;

933 
¿nge
 = 
	`ngx_¬¿y_push
(
a
);

934 ià(
¿nge
 =ð
NULL
) {

935  
NGX_CONF_ERROR
;

938 
¿nge
->
¡¬t
 = (
u_shÜt
è
s
;

939 
¿nge
->
’d
 = (
u_shÜt
è
e
;

940 
¿nge
->
v®ue
 = 
ùx
->value;

942 
Ãxt
:

947  
NGX_CONF_OK
;

948 
	}
}

951 
ngx_ušt_t


952 
	$ngx_h‰p_geo_d–‘e_¿nge
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

953 
š_addr_t
 
¡¬t
, in_addr_ˆ
’d
)

955 
š_addr_t
 
n
;

956 
ngx_ušt_t
 
h
, 
i
, 
s
, 
e
, 
w¬n
;

957 
ngx_¬¿y_t
 *
a
;

958 
ngx_h‰p_geo_¿nge_t
 *
¿nge
;

960 
w¬n
 = 0;

962 
n
 = 
¡¬t
;‚ <ð
’d
;‚ += 0x10000) {

964 
h
 = 
n
 >> 16;

966 ià(
n
 =ð
¡¬t
) {

967 
s
 = 
n
 & 0xffff;

969 
s
 = 0;

972 ià((
n
 | 0xffffè> 
’d
) {

973 
e
 = 
’d
 & 0xffff;

976 
e
 = 0xffff;

979 
a
 = (
ngx_¬¿y_t
 *è
ùx
->
high
.
low
[
h
];

981 ià(
a
 =ð
NULL
) {

982 
w¬n
 = 1;

986 
¿nge
 = 
a
->
–ts
;

987 
i
 = 0; i < 
a
->
ÃÉs
; i++) {

989 ià(
s
 =ð(
ngx_ušt_t
è
¿nge
[
i
].
¡¬t


990 && 
e
 =ð(
ngx_ušt_t
è
¿nge
[
i
].
’d
)

992 
	`ngx_memmove
(&
¿nge
[
i
], &range[i + 1],

993 (
a
->
ÃÉs
 - 1 - 
i
è* (
ngx_h‰p_geo_¿nge_t
));

995 
a
->
ÃÉs
--;

1000 ià(
s
 !ð(
ngx_ušt_t
è
¿nge
[
i
].
¡¬t


1001 && 
e
 !ð(
ngx_ušt_t
è
¿nge
[
i
].
’d
)

1006 
w¬n
 = 1;

1010  
w¬n
;

1011 
	}
}

1015 
	$ngx_h‰p_geo_cidr
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

1016 
ngx_¡r_t
 *
v®ue
)

1018 *
rv
;

1019 
ngx_št_t
 
rc
, 
d–
;

1020 
ngx_¡r_t
 *
Ãt
;

1021 
ngx_cidr_t
 
cidr
;

1023 ià(
ùx
->
Œ“
 =ð
NULL
) {

1024 
ùx
->
Œ“
 = 
	`ngx_¿dix_Œ“_ü—‹
(ùx->
poÞ
, -1);

1025 ià(
ùx
->
Œ“
 =ð
NULL
) {

1026  
NGX_CONF_ERROR
;

1030 #ià(
NGX_HAVE_INET6
)

1031 ià(
ùx
->
Œ“6
 =ð
NULL
) {

1032 
ùx
->
Œ“6
 = 
	`ngx_¿dix_Œ“_ü—‹
(ùx->
poÞ
, -1);

1033 ià(
ùx
->
Œ“6
 =ð
NULL
) {

1034  
NGX_CONF_ERROR
;

1039 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "default") == 0) {

1040 
cidr
.
çmžy
 = 
AF_INET
;

1041 
cidr
.
u
.
š
.
addr
 = 0;

1042 
cidr
.
u
.
š
.
mask
 = 0;

1044 
rv
 = 
	`ngx_h‰p_geo_cidr_add
(
cf
, 
ùx
, &
cidr
, &
v®ue
[1], &value[0]);

1046 ià(
rv
 !ð
NGX_CONF_OK
) {

1047  
rv
;

1050 #ià(
NGX_HAVE_INET6
)

1051 
cidr
.
çmžy
 = 
AF_INET6
;

1052 
	`ngx_memz”o
(&
cidr
.
u
.
š6
, (
ngx_š6_cidr_t
));

1054 
rv
 = 
	`ngx_h‰p_geo_cidr_add
(
cf
, 
ùx
, &
cidr
, &
v®ue
[1], &value[0]);

1056 ià(
rv
 !ð
NGX_CONF_OK
) {

1057  
rv
;

1061  
NGX_CONF_OK
;

1064 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "delete") == 0) {

1065 
Ãt
 = &
v®ue
[1];

1066 
d–
 = 1;

1069 
Ãt
 = &
v®ue
[0];

1070 
d–
 = 0;

1073 ià(
	`ngx_h‰p_geo_cidr_v®ue
(
cf
, 
Ãt
, &
cidr
è!ð
NGX_OK
) {

1074  
NGX_CONF_ERROR
;

1077 ià(
cidr
.
çmžy
 =ð
AF_INET
) {

1078 
cidr
.
u
.
š
.
addr
 = 
	`Áohl
(cidr.u.in.addr);

1079 
cidr
.
u
.
š
.
mask
 = 
	`Áohl
(cidr.u.in.mask);

1082 ià(
d–
) {

1083 
cidr
.
çmžy
) {

1085 #ià(
NGX_HAVE_INET6
)

1086 
AF_INET6
:

1087 
rc
 = 
	`ngx_¿dix128Œ“_d–‘e
(
ùx
->
Œ“6
,

1088 
cidr
.
u
.
š6
.
addr
.
s6_addr
,

1089 
cidr
.
u
.
š6
.
mask
.
s6_addr
);

1094 
rc
 = 
	`ngx_¿dix32Œ“_d–‘e
(
ùx
->
Œ“
, 
cidr
.
u
.
š
.
addr
,

1095 
cidr
.
u
.
š
.
mask
);

1099 ià(
rc
 !ð
NGX_OK
) {

1100 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1101 "nØÃtwÜk \"%V\"Ød–‘e", 
Ãt
);

1104  
NGX_CONF_OK
;

1107  
	`ngx_h‰p_geo_cidr_add
(
cf
, 
ùx
, &
cidr
, &
v®ue
[1], 
Ãt
);

1108 
	}
}

1112 
	$ngx_h‰p_geo_cidr_add
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

1113 
ngx_cidr_t
 *
cidr
, 
ngx_¡r_t
 *
v®ue
,‚gx_¡r_ˆ*
Ãt
)

1115 
ngx_št_t
 
rc
;

1116 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®
, *
Þd
;

1118 
v®
 = 
	`ngx_h‰p_geo_v®ue
(
cf
, 
ùx
, 
v®ue
);

1120 ià(
v®
 =ð
NULL
) {

1121  
NGX_CONF_ERROR
;

1124 
cidr
->
çmžy
) {

1126 #ià(
NGX_HAVE_INET6
)

1127 
AF_INET6
:

1128 
rc
 = 
	`ngx_¿dix128Œ“_š£¹
(
ùx
->
Œ“6
, 
cidr
->
u
.
š6
.
addr
.
s6_addr
,

1129 
cidr
->
u
.
š6
.
mask
.
s6_addr
,

1130 (
ušŒ_t
è
v®
);

1132 ià(
rc
 =ð
NGX_OK
) {

1133  
NGX_CONF_OK
;

1136 ià(
rc
 =ð
NGX_ERROR
) {

1137  
NGX_CONF_ERROR
;

1142 
Þd
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *)

1143 
	`ngx_¿dix128Œ“_fšd
(
ùx
->
Œ“6
,

1144 
cidr
->
u
.
š6
.
addr
.
s6_addr
);

1146 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1148 
Ãt
, 
v®
, 
Þd
);

1150 
rc
 = 
	`ngx_¿dix128Œ“_d–‘e
(
ùx
->
Œ“6
,

1151 
cidr
->
u
.
š6
.
addr
.
s6_addr
,

1152 
cidr
->
u
.
š6
.
mask
.
s6_addr
);

1154 ià(
rc
 =ð
NGX_ERROR
) {

1155 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "invalid„adixree");

1156  
NGX_CONF_ERROR
;

1159 
rc
 = 
	`ngx_¿dix128Œ“_š£¹
(
ùx
->
Œ“6
, 
cidr
->
u
.
š6
.
addr
.
s6_addr
,

1160 
cidr
->
u
.
š6
.
mask
.
s6_addr
,

1161 (
ušŒ_t
è
v®
);

1167 
rc
 = 
	`ngx_¿dix32Œ“_š£¹
(
ùx
->
Œ“
, 
cidr
->
u
.
š
.
addr
,

1168 
cidr
->
u
.
š
.
mask
, (
ušŒ_t
è
v®
);

1170 ià(
rc
 =ð
NGX_OK
) {

1171  
NGX_CONF_OK
;

1174 ià(
rc
 =ð
NGX_ERROR
) {

1175  
NGX_CONF_ERROR
;

1180 
Þd
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *)

1181 
	`ngx_¿dix32Œ“_fšd
(
ùx
->
Œ“
, 
cidr
->
u
.
š
.
addr
);

1183 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1185 
Ãt
, 
v®
, 
Þd
);

1187 
rc
 = 
	`ngx_¿dix32Œ“_d–‘e
(
ùx
->
Œ“
,

1188 
cidr
->
u
.
š
.
addr
, cidr->u.š.
mask
);

1190 ià(
rc
 =ð
NGX_ERROR
) {

1191 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "invalid„adixree");

1192  
NGX_CONF_ERROR
;

1195 
rc
 = 
	`ngx_¿dix32Œ“_š£¹
(
ùx
->
Œ“
, 
cidr
->
u
.
š
.
addr
,

1196 
cidr
->
u
.
š
.
mask
, (
ušŒ_t
è
v®
);

1201 ià(
rc
 =ð
NGX_OK
) {

1202  
NGX_CONF_OK
;

1205  
NGX_CONF_ERROR
;

1206 
	}
}

1209 
ngx_h‰p_v¬ŸbË_v®ue_t
 *

1210 
	$ngx_h‰p_geo_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

1211 
ngx_¡r_t
 *
v®ue
)

1213 
ušt32_t
 
hash
;

1214 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®
;

1215 
ngx_h‰p_geo_v¬ŸbË_v®ue_node_t
 *
gvvn
;

1217 
hash
 = 
	`ngx_üc32_lÚg
(
v®ue
->
d©a
, v®ue->
Ën
);

1219 
gvvn
 = (
ngx_h‰p_geo_v¬ŸbË_v®ue_node_t
 *)

1220 
	`ngx_¡r_rbŒ“_lookup
(&
ùx
->
rbŒ“
, 
v®ue
, 
hash
);

1222 ià(
gvvn
) {

1223  
gvvn
->
v®ue
;

1226 
v®
 = 
	`ngx_·Îoc
(
ùx
->
poÞ
, (
ngx_h‰p_v¬ŸbË_v®ue_t
));

1227 ià(
v®
 =ð
NULL
) {

1228  
NULL
;

1231 
v®
->
Ën
 = 
v®ue
->len;

1232 
v®
->
d©a
 = 
	`ngx_p¡rdup
(
ùx
->
poÞ
, 
v®ue
);

1233 ià(
v®
->
d©a
 =ð
NULL
) {

1234  
NULL
;

1237 
v®
->
v®id
 = 1;

1238 
v®
->
no_ÿch—bË
 = 0;

1239 
v®
->
nÙ_found
 = 0;

1241 
gvvn
 = 
	`ngx_·Îoc
(
ùx
->
‹mp_poÞ
,

1242 (
ngx_h‰p_geo_v¬ŸbË_v®ue_node_t
));

1243 ià(
gvvn
 =ð
NULL
) {

1244  
NULL
;

1247 
gvvn
->
¢
.
node
.
key
 = 
hash
;

1248 
gvvn
->
¢
.
¡r
.
Ën
 = 
v®
->len;

1249 
gvvn
->
¢
.
¡r
.
d©a
 = 
v®
->data;

1250 
gvvn
->
v®ue
 = 
v®
;

1251 
gvvn
->
off£t
 = 0;

1253 
	`ngx_rbŒ“_š£¹
(&
ùx
->
rbŒ“
, &
gvvn
->
¢
.
node
);

1255 
ùx
->
d©a_size
 +ð
	`ngx_®ign
((
ngx_h‰p_v¬ŸbË_v®ue_t
è+ 
v®ue
->
Ën
,

1258  
v®
;

1259 
	}
}

1263 
	$ngx_h‰p_geo_add_´oxy
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

1264 
ngx_cidr_t
 *
cidr
)

1266 
ngx_cidr_t
 *
c
;

1268 ià(
ùx
->
´ox›s
 =ð
NULL
) {

1269 
ùx
->
´ox›s
 = 
	`ngx_¬¿y_ü—‹
(ùx->
poÞ
, 4, (
ngx_cidr_t
));

1270 ià(
ùx
->
´ox›s
 =ð
NULL
) {

1271  
NGX_CONF_ERROR
;

1275 
c
 = 
	`ngx_¬¿y_push
(
ùx
->
´ox›s
);

1276 ià(
c
 =ð
NULL
) {

1277  
NGX_CONF_ERROR
;

1280 *
c
 = *
cidr
;

1282  
NGX_CONF_OK
;

1283 
	}
}

1286 
ngx_št_t


1287 
	$ngx_h‰p_geo_cidr_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
Ãt
, 
ngx_cidr_t
 *
cidr
)

1289 
ngx_št_t
 
rc
;

1291 ià(
	`ngx_¡rcmp
(
Ãt
->
d©a
, "255.255.255.255") == 0) {

1292 
cidr
->
çmžy
 = 
AF_INET
;

1293 
cidr
->
u
.
š
.
addr
 = 0xffffffff;

1294 
cidr
->
u
.
š
.
mask
 = 0xffffffff;

1296  
NGX_OK
;

1299 
rc
 = 
	`ngx_±ocidr
(
Ãt
, 
cidr
);

1301 ià(
rc
 =ð
NGX_ERROR
) {

1302 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "šv®id‚‘wÜk \"%V\"", 
Ãt
);

1303  
NGX_ERROR
;

1306 ià(
rc
 =ð
NGX_DONE
) {

1307 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1308 "low‡dd»s b™ oà%V‡» m—nšgËss", 
Ãt
);

1311  
NGX_OK
;

1312 
	}
}

1316 
	$ngx_h‰p_geo_šþude
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

1317 
ngx_¡r_t
 *
Çme
)

1319 *
rv
;

1320 
ngx_¡r_t
 
fže
;

1322 
fže
.
Ën
 = 
Çme
->len + 4;

1323 
fže
.
d©a
 = 
	`ngx_²®loc
(
ùx
->
‹mp_poÞ
, 
Çme
->
Ën
 + 5);

1324 ià(
fže
.
d©a
 =ð
NULL
) {

1325  
NGX_CONF_ERROR
;

1328 
	`ngx_¥rštf
(
fže
.
d©a
, "%V.bš%Z", 
Çme
);

1330 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
fže
, 1è!ð
NGX_OK
) {

1331  
NGX_CONF_ERROR
;

1334 ià(
ùx
->
¿nges
) {

1335 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cf
->
log
, 0, "šþud%s", 
fže
.
d©a
);

1337 
	`ngx_h‰p_geo_šþude_bš¬y_ba£
(
cf
, 
ùx
, &
fže
)) {

1338 
NGX_OK
:

1339  
NGX_CONF_OK
;

1340 
NGX_ERROR
:

1341  
NGX_CONF_ERROR
;

1347 
fže
.
Ën
 -= 4;

1348 
fže
.
d©a
[fže.
Ën
] = '\0';

1350 
ùx
->
šþude_Çme
 = 
fže
;

1352 ià(
ùx
->
outside_’Œ›s
) {

1353 
ùx
->
®low_bš¬y_šþude
 = 0;

1356 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cf
->
log
, 0, "šþud%s", 
fže
.
d©a
);

1358 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, &
fže
);

1360 
ùx
->
šþudes
++;

1361 
ùx
->
outside_’Œ›s
 = 0;

1363  
rv
;

1364 
	}
}

1367 
ngx_št_t


1368 
	$ngx_h‰p_geo_šþude_bš¬y_ba£
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
,

1369 
ngx_¡r_t
 *
Çme
)

1371 
u_ch¬
 *
ba£
, 
ch
;

1372 
time_t
 
mtime
;

1373 
size_t
 
size
, 
Ën
;

1374 
ssize_t
 
n
;

1375 
ušt32_t
 
üc32
;

1376 
ngx_”r_t
 
”r
;

1377 
ngx_št_t
 
rc
;

1378 
ngx_ušt_t
 
i
;

1379 
ngx_fže_t
 
fže
;

1380 
ngx_fže_šfo_t
 
fi
;

1381 
ngx_h‰p_geo_¿nge_t
 *
¿nge
, **
¿nges
;

1382 
ngx_h‰p_geo_h—d”_t
 *
h—d”
;

1383 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

1385 
	`ngx_memz”o
(&
fže
, (
ngx_fže_t
));

1386 
fže
.
Çme
 = *name;

1387 
fže
.
log
 = 
cf
->log;

1389 
fže
.
fd
 = 
	`ngx_Ý’_fže
(
Çme
->
d©a
, 
NGX_FILE_RDONLY
, 0, 0);

1390 ià(
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

1391 
”r
 = 
ngx_”ºo
;

1392 ià(
”r
 !ð
NGX_ENOENT
) {

1393 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
, 
”r
,

1394 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
Çme
->
d©a
);

1396  
NGX_DECLINED
;

1399 ià(
ùx
->
outside_’Œ›s
) {

1400 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1402 
Çme
->
d©a
);

1403 
rc
 = 
NGX_ERROR
;

1404 
dÚe
;

1407 ià(
ùx
->
bš¬y_šþude
) {

1408 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1410 
Çme
->
d©a
, 
ùx
->
šþude_Çme
.data);

1411 
rc
 = 
NGX_ERROR
;

1412 
dÚe
;

1415 ià(
	`ngx_fd_šfo
(
fže
.
fd
, &
fi
è=ð
NGX_FILE_ERROR
) {

1416 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
, 
ngx_”ºo
,

1417 
ngx_fd_šfo_n
 " \"%s\" fažed", 
Çme
->
d©a
);

1418 
çžed
;

1421 
size
 = (
size_t
è
	`ngx_fže_size
(&
fi
);

1422 
mtime
 = 
	`ngx_fže_mtime
(&
fi
);

1424 
ch
 = 
Çme
->
d©a
[Çme->
Ën
 - 4];

1425 
Çme
->
d©a
[Çme->
Ën
 - 4] = '\0';

1427 ià(
	`ngx_fže_šfo
(
Çme
->
d©a
, &
fi
è=ð
NGX_FILE_ERROR
) {

1428 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
, 
ngx_”ºo
,

1429 
ngx_fže_šfo_n
 " \"%s\" fažed", 
Çme
->
d©a
);

1430 
çžed
;

1433 
Çme
->
d©a
[Çme->
Ën
 - 4] = 
ch
;

1435 ià(
mtime
 < 
	`ngx_fže_mtime
(&
fi
)) {

1436 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1437 "¡®bš¬y geØ¿ngba£ \"%s\"", 
Çme
->
d©a
);

1438 
çžed
;

1441 
ba£
 = 
	`ngx_·Îoc
(
ùx
->
poÞ
, 
size
);

1442 ià(
ba£
 =ð
NULL
) {

1443 
çžed
;

1446 
n
 = 
	`ngx_»ad_fže
(&
fže
, 
ba£
, 
size
, 0);

1448 ià(
n
 =ð
NGX_ERROR
) {

1449 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
, 
ngx_”ºo
,

1450 
ngx_»ad_fže_n
 " \"%s\" fažed", 
Çme
->
d©a
);

1451 
çžed
;

1454 ià((
size_t
è
n
 !ð
size
) {

1455 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_CRIT
, 
cf
, 0,

1456 
ngx_»ad_fže_n
 " \"%s\"„eturned only %z bytes instead of %z",

1457 
Çme
->
d©a
, 
n
, 
size
);

1458 
çžed
;

1461 
h—d”
 = (
ngx_h‰p_geo_h—d”_t
 *è
ba£
;

1463 ià(
size
 < 16 || 
	`ngx_memcmp
(&
ngx_h‰p_geo_h—d”
, 
h—d”
, 12) != 0) {

1464 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1465 "šcom·tibË bš¬y geØ¿ngba£ \"%s\"", 
Çme
->
d©a
);

1466 
çžed
;

1469 
	`ngx_üc32_š™
(
üc32
);

1471 
vv
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *è(
ba£
 + (
ngx_h‰p_geo_h—d”_t
));

1473 
vv
->
d©a
) {

1474 
Ën
 = 
	`ngx_®ign
((
ngx_h‰p_v¬ŸbË_v®ue_t
è+ 
vv
->len,

1476 
	`ngx_üc32_upd©e
(&
üc32
, (
u_ch¬
 *è
vv
, 
Ën
);

1477 
vv
->
d©a
 +ð(
size_t
è
ba£
;

1478 
vv
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *è((
u_ch¬
 *èvv + 
Ën
);

1480 
	`ngx_üc32_upd©e
(&
üc32
, (
u_ch¬
 *è
vv
, (
ngx_h‰p_v¬ŸbË_v®ue_t
));

1481 
vv
++;

1483 
¿nges
 = (
ngx_h‰p_geo_¿nge_t
 **è
vv
;

1485 
i
 = 0; i < 0x10000; i++) {

1486 
	`ngx_üc32_upd©e
(&
üc32
, (
u_ch¬
 *è&
¿nges
[
i
], (*));

1487 ià(
¿nges
[
i
]) {

1488 
¿nges
[
i
] = (
ngx_h‰p_geo_¿nge_t
 *)

1489 ((
u_ch¬
 *è
¿nges
[
i
] + (
size_t
è
ba£
);

1493 
¿nge
 = (
ngx_h‰p_geo_¿nge_t
 *è&
¿nges
[0x10000];

1495 (
u_ch¬
 *è
¿nge
 < 
ba£
 + 
size
) {

1496 
¿nge
->
v®ue
) {

1497 
	`ngx_üc32_upd©e
(&
üc32
, (
u_ch¬
 *è
¿nge
,

1498 (
ngx_h‰p_geo_¿nge_t
));

1499 
¿nge
->
v®ue
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *)

1500 ((
u_ch¬
 *è
¿nge
->
v®ue
 + (
size_t
è
ba£
);

1501 
¿nge
++;

1503 
	`ngx_üc32_upd©e
(&
üc32
, (
u_ch¬
 *è
¿nge
, (*));

1504 
¿nge
 = (
ngx_h‰p_geo_¿nge_t
 *è((
u_ch¬
 *)„ange + (*));

1507 
	`ngx_üc32_fš®
(
üc32
);

1509 ià(
üc32
 !ð
h—d”
->crc32) {

1510 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1511 "CRC32 mism©ch iÀbš¬y geØ¿ngba£ \"%s\"", 
Çme
->
d©a
);

1512 
çžed
;

1515 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_NOTICE
, 
cf
, 0,

1516 "usšg bš¬y geØ¿ngba£ \"%s\"", 
Çme
->
d©a
);

1518 
ùx
->
šþude_Çme
 = *
Çme
;

1519 
ùx
->
bš¬y_šþude
 = 1;

1520 
ùx
->
high
.
low
 = 
¿nges
;

1521 
rc
 = 
NGX_OK
;

1523 
dÚe
;

1525 
çžed
:

1527 
rc
 = 
NGX_DECLINED
;

1529 
dÚe
:

1531 ià(
	`ngx_þo£_fže
(
fže
.
fd
è=ð
NGX_FILE_ERROR
) {

1532 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_”ºo
,

1533 
ngx_þo£_fže_n
 " \"%s\" fažed", 
Çme
->
d©a
);

1536  
rc
;

1537 
	}
}

1541 
	$ngx_h‰p_geo_ü—‹_bš¬y_ba£
(
ngx_h‰p_geo_cÚf_ùx_t
 *
ùx
)

1543 
u_ch¬
 *
p
;

1544 
ušt32_t
 
hash
;

1545 
ngx_¡r_t
 
s
;

1546 
ngx_ušt_t
 
i
;

1547 
ngx_fže_m­pšg_t
 
fm
;

1548 
ngx_h‰p_geo_¿nge_t
 *
r
, *
¿nge
, **
¿nges
;

1549 
ngx_h‰p_geo_h—d”_t
 *
h—d”
;

1550 
ngx_h‰p_geo_v¬ŸbË_v®ue_node_t
 *
gvvn
;

1552 
fm
.
Çme
 = 
	`ngx_²®loc
(
ùx
->
‹mp_poÞ
, ctx->
šþude_Çme
.
Ën
 + 5);

1553 ià(
fm
.
Çme
 =ð
NULL
) {

1557 
	`ngx_¥rštf
(
fm
.
Çme
, "%V.bš%Z", &
ùx
->
šþude_Çme
);

1559 
fm
.
size
 = 
ùx
->
d©a_size
;

1560 
fm
.
log
 = 
ùx
->
poÞ
->log;

1562 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
fm
.
log
, 0,

1563 "ü—tšg bš¬y geØ¿ngba£ \"%s\"", 
fm
.
Çme
);

1565 ià(
	`ngx_ü—‹_fže_m­pšg
(&
fm
è!ð
NGX_OK
) {

1569 
p
 = 
	`ngx_ýymem
(
fm
.
addr
, &
ngx_h‰p_geo_h—d”
,

1570 (
ngx_h‰p_geo_h—d”_t
));

1572 
p
 = 
	`ngx_h‰p_geo_cÝy_v®ues
(
fm
.
addr
,…, 
ùx
->
rbŒ“
.
roÙ
,

1573 
ùx
->
rbŒ“
.
£Áš–
);

1575 
p
 +ð(
ngx_h‰p_v¬ŸbË_v®ue_t
);

1577 
¿nges
 = (
ngx_h‰p_geo_¿nge_t
 **è
p
;

1579 
p
 +ð0x10000 * (
ngx_h‰p_geo_¿nge_t
 *);

1581 
i
 = 0; i < 0x10000; i++) {

1582 
r
 = 
ùx
->
high
.
low
[
i
];

1583 ià(
r
 =ð
NULL
) {

1587 
¿nge
 = (
ngx_h‰p_geo_¿nge_t
 *è
p
;

1588 
¿nges
[
i
] = (
ngx_h‰p_geo_¿nge_t
 *è(
p
 - (
u_ch¬
 *è
fm
.
addr
);

1591 
s
.
Ën
 = 
r
->
v®ue
->len;

1592 
s
.
d©a
 = 
r
->
v®ue
->data;

1593 
hash
 = 
	`ngx_üc32_lÚg
(
s
.
d©a
, s.
Ën
);

1594 
gvvn
 = (
ngx_h‰p_geo_v¬ŸbË_v®ue_node_t
 *)

1595 
	`ngx_¡r_rbŒ“_lookup
(&
ùx
->
rbŒ“
, &
s
, 
hash
);

1597 
¿nge
->
v®ue
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *è
gvvn
->
off£t
;

1598 
¿nge
->
¡¬t
 = 
r
->start;

1599 
¿nge
->
’d
 = 
r
->end;

1600 
¿nge
++;

1602 } (++
r
)->
v®ue
);

1604 
¿nge
->
v®ue
 = 
NULL
;

1606 
p
 = (
u_ch¬
 *è
¿nge
 + (*);

1609 
h—d”
 = 
fm
.
addr
;

1610 
h—d”
->
üc32
 = 
	`ngx_üc32_lÚg
((
u_ch¬
 *è
fm
.
addr


1611 + (
ngx_h‰p_geo_h—d”_t
),

1612 
fm
.
size
 - (
ngx_h‰p_geo_h—d”_t
));

1614 
	`ngx_þo£_fže_m­pšg
(&
fm
);

1615 
	}
}

1618 
u_ch¬
 *

1619 
	$ngx_h‰p_geo_cÝy_v®ues
(
u_ch¬
 *
ba£
, u_ch¬ *
p
, 
ngx_rbŒ“_node_t
 *
node
,

1620 
ngx_rbŒ“_node_t
 *
£Áš–
)

1622 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

1623 
ngx_h‰p_geo_v¬ŸbË_v®ue_node_t
 *
gvvn
;

1625 ià(
node
 =ð
£Áš–
) {

1626  
p
;

1629 
gvvn
 = (
ngx_h‰p_geo_v¬ŸbË_v®ue_node_t
 *è
node
;

1630 
gvvn
->
off£t
 = 
p
 - 
ba£
;

1632 
vv
 = (
ngx_h‰p_v¬ŸbË_v®ue_t
 *è
p
;

1633 *
vv
 = *
gvvn
->
v®ue
;

1634 
p
 +ð(
ngx_h‰p_v¬ŸbË_v®ue_t
);

1635 
vv
->
d©a
 = (
u_ch¬
 *è(
p
 - 
ba£
);

1637 
p
 = 
	`ngx_ýymem
Õ, 
gvvn
->
¢
.
¡r
.
d©a
, gvvn->¢.¡r.
Ën
);

1639 
p
 = 
	`ngx_®ign_±r
(p, (*));

1641 
p
 = 
	`ngx_h‰p_geo_cÝy_v®ues
(
ba£
,…, 
node
->
Ëá
, 
£Áš–
);

1643  
	`ngx_h‰p_geo_cÝy_v®ues
(
ba£
, 
p
, 
node
->
right
, 
£Áš–
);

1644 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_geoip_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

12 
	~<GeoIP.h
>

13 
	~<GeoIPC™y.h
>

16 
	#NGX_GEOIP_COUNTRY_CODE
 0

	)

17 
	#NGX_GEOIP_COUNTRY_CODE3
 1

	)

18 
	#NGX_GEOIP_COUNTRY_NAME
 2

	)

22 
GeoIP
 *
	mcouÁry
;

23 
GeoIP
 *
	mÜg
;

24 
GeoIP
 *
	mc™y
;

25 
ngx_¬¿y_t
 *
	m´ox›s
;

26 
ngx_æag_t
 
	m´oxy_»cursive
;

27 #ià(
NGX_HAVE_GEOIP_V6
)

28 
	mcouÁry_v6
:1;

29 
	mÜg_v6
:1;

30 
	mc™y_v6
:1;

32 } 
	tngx_h‰p_geo_cÚf_t
;

36 
ngx_¡r_t
 *
	mÇme
;

37 
ušŒ_t
 
	md©a
;

38 } 
	tngx_h‰p_geo_v¬_t
;

41 cÚ¡ *(*
	tngx_h‰p_geo_v¬ŸbË_hªdËr_±
)(
	tGeoIP
 *,

42 
	tu_lÚg
 
	taddr
);

45 
ngx_h‰p_geo_v¬ŸbË_hªdËr_±
 
	gngx_h‰p_geo_couÁry_funùiÚs
[] = {

46 
GeoIP_couÁry_code_by_num
,

47 
GeoIP_couÁry_code3_by_num
,

48 
GeoIP_couÁry_Çme_by_num
,

52 #ià(
NGX_HAVE_GEOIP_V6
)

54 cÚ¡ *(*
	tngx_h‰p_geo_v¬ŸbË_hªdËr_v6_±
)(
	tGeoIP
 *,

55 
	tgeov6_t
 
	taddr
);

58 
ngx_h‰p_geo_v¬ŸbË_hªdËr_v6_±
 
	gngx_h‰p_geo_couÁry_v6_funùiÚs
[] = {

59 
GeoIP_couÁry_code_by_num_v6
,

60 
GeoIP_couÁry_code3_by_num_v6
,

61 
GeoIP_couÁry_Çme_by_num_v6
,

67 
ngx_št_t
 
ngx_h‰p_geo_couÁry_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

68 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

69 
ngx_št_t
 
ngx_h‰p_geo_Üg_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

70 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

71 
ngx_št_t
 
ngx_h‰p_geo_c™y_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

72 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

73 
ngx_št_t
 
ngx_h‰p_geo_»giÚ_Çme_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

74 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

75 
ngx_št_t
 
ngx_h‰p_geo_c™y_æßt_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

76 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

77 
ngx_št_t
 
ngx_h‰p_geo_c™y_št_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

78 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

79 
GeoIPRecÜd
 *
ngx_h‰p_geo_g‘_c™y_»cÜd
(
ngx_h‰p_»que¡_t
 *
r
);

81 
ngx_št_t
 
ngx_h‰p_geo_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

82 *
ngx_h‰p_geo_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

83 *
ngx_h‰p_geo_š™_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
);

84 *
ngx_h‰p_geo_couÁry
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

85 *
cÚf
);

86 *
ngx_h‰p_geo_Üg
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

87 *
cÚf
);

88 *
ngx_h‰p_geo_c™y
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

89 *
cÚf
);

90 *
ngx_h‰p_geo_´oxy
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

91 *
cÚf
);

92 
ngx_št_t
 
ngx_h‰p_geo_cidr_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
Ãt
,

93 
ngx_cidr_t
 *
cidr
);

94 
ngx_h‰p_geo_þ—nup
(*
d©a
);

97 
ngx_commªd_t
 
	gngx_h‰p_geo_commªds
[] = {

99 { 
ngx_¡ršg
("geoip_country"),

100 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE12
,

101 
ngx_h‰p_geo_couÁry
,

102 
NGX_HTTP_MAIN_CONF_OFFSET
,

104 
NULL
 },

106 { 
ngx_¡ršg
("geoip_org"),

107 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE12
,

108 
ngx_h‰p_geo_Üg
,

109 
NGX_HTTP_MAIN_CONF_OFFSET
,

111 
NULL
 },

113 { 
ngx_¡ršg
("geoip_city"),

114 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE12
,

115 
ngx_h‰p_geo_c™y
,

116 
NGX_HTTP_MAIN_CONF_OFFSET
,

118 
NULL
 },

120 { 
ngx_¡ršg
("geoip_proxy"),

121 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

122 
ngx_h‰p_geo_´oxy
,

123 
NGX_HTTP_MAIN_CONF_OFFSET
,

125 
NULL
 },

127 { 
ngx_¡ršg
("geoip_proxy_recursive"),

128 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_FLAG
,

129 
ngx_cÚf_£t_æag_¦Ù
,

130 
NGX_HTTP_MAIN_CONF_OFFSET
,

131 
off£tof
(
ngx_h‰p_geo_cÚf_t
, 
´oxy_»cursive
),

132 
NULL
 },

134 
ngx_nuÎ_commªd


138 
ngx_h‰p_moduË_t
 
	gngx_h‰p_geo_moduË_ùx
 = {

139 
ngx_h‰p_geo_add_v¬ŸbËs
,

140 
NULL
,

142 
ngx_h‰p_geo_ü—‹_cÚf
,

143 
ngx_h‰p_geo_š™_cÚf
,

145 
NULL
,

146 
NULL
,

148 
NULL
,

149 
NULL


153 
ngx_moduË_t
 
	gngx_h‰p_geo_moduË
 = {

154 
NGX_MODULE_V1
,

155 &
ngx_h‰p_geo_moduË_ùx
,

156 
ngx_h‰p_geo_commªds
,

157 
NGX_HTTP_MODULE
,

158 
NULL
,

159 
NULL
,

160 
NULL
,

161 
NULL
,

162 
NULL
,

163 
NULL
,

164 
NULL
,

165 
NGX_MODULE_V1_PADDING


169 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_geo_v¬s
[] = {

171 { 
ngx_¡ršg
("geo_couÁry_code"), 
NULL
,

172 
ngx_h‰p_geo_couÁry_v¬ŸbË
,

173 
NGX_GEOIP_COUNTRY_CODE
, 0, 0 },

175 { 
ngx_¡ršg
("geo_couÁry_code3"), 
NULL
,

176 
ngx_h‰p_geo_couÁry_v¬ŸbË
,

177 
NGX_GEOIP_COUNTRY_CODE3
, 0, 0 },

179 { 
ngx_¡ršg
("geo_couÁry_Çme"), 
NULL
,

180 
ngx_h‰p_geo_couÁry_v¬ŸbË
,

181 
NGX_GEOIP_COUNTRY_NAME
, 0, 0 },

183 { 
ngx_¡ršg
("geo_Üg"), 
NULL
,

184 
ngx_h‰p_geo_Üg_v¬ŸbË
,

187 { 
ngx_¡ršg
("geo_c™y_cÚtš’t_code"), 
NULL
,

188 
ngx_h‰p_geo_c™y_v¬ŸbË
,

189 
off£tof
(
GeoIPRecÜd
, 
cÚtš’t_code
), 0, 0 },

191 { 
ngx_¡ršg
("geo_c™y_couÁry_code"), 
NULL
,

192 
ngx_h‰p_geo_c™y_v¬ŸbË
,

193 
off£tof
(
GeoIPRecÜd
, 
couÁry_code
), 0, 0 },

195 { 
ngx_¡ršg
("geo_c™y_couÁry_code3"), 
NULL
,

196 
ngx_h‰p_geo_c™y_v¬ŸbË
,

197 
off£tof
(
GeoIPRecÜd
, 
couÁry_code3
), 0, 0 },

199 { 
ngx_¡ršg
("geo_c™y_couÁry_Çme"), 
NULL
,

200 
ngx_h‰p_geo_c™y_v¬ŸbË
,

201 
off£tof
(
GeoIPRecÜd
, 
couÁry_Çme
), 0, 0 },

203 { 
ngx_¡ršg
("geo_»giÚ"), 
NULL
,

204 
ngx_h‰p_geo_c™y_v¬ŸbË
,

205 
off£tof
(
GeoIPRecÜd
, 
»giÚ
), 0, 0 },

207 { 
ngx_¡ršg
("geo_»giÚ_Çme"), 
NULL
,

208 
ngx_h‰p_geo_»giÚ_Çme_v¬ŸbË
,

211 { 
ngx_¡ršg
("geo_c™y"), 
NULL
,

212 
ngx_h‰p_geo_c™y_v¬ŸbË
,

213 
off£tof
(
GeoIPRecÜd
, 
c™y
), 0, 0 },

215 { 
ngx_¡ršg
("geo_po¡®_code"), 
NULL
,

216 
ngx_h‰p_geo_c™y_v¬ŸbË
,

217 
off£tof
(
GeoIPRecÜd
, 
po¡®_code
), 0, 0 },

219 { 
ngx_¡ršg
("geo_Ït™ude"), 
NULL
,

220 
ngx_h‰p_geo_c™y_æßt_v¬ŸbË
,

221 
off£tof
(
GeoIPRecÜd
, 
Ït™ude
), 0, 0 },

223 { 
ngx_¡ršg
("geo_lÚg™ude"), 
NULL
,

224 
ngx_h‰p_geo_c™y_æßt_v¬ŸbË
,

225 
off£tof
(
GeoIPRecÜd
, 
lÚg™ude
), 0, 0 },

227 { 
ngx_¡ršg
("geo_dma_code"), 
NULL
,

228 
ngx_h‰p_geo_c™y_št_v¬ŸbË
,

229 
off£tof
(
GeoIPRecÜd
, 
dma_code
), 0, 0 },

231 { 
ngx_¡ršg
("geo_¬—_code"), 
NULL
,

232 
ngx_h‰p_geo_c™y_št_v¬ŸbË
,

233 
off£tof
(
GeoIPRecÜd
, 
¬—_code
), 0, 0 },

235 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

239 
u_lÚg


240 
	$ngx_h‰p_geo_addr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_geo_cÚf_t
 *
gcf
)

242 
ngx_addr_t
 
addr
;

243 
ngx_¬¿y_t
 *
xfwd
;

244 
sockaddr_š
 *
sš
;

246 
addr
.
sockaddr
 = 
r
->
cÚÃùiÚ
->sockaddr;

247 
addr
.
sockËn
 = 
r
->
cÚÃùiÚ
->socklen;

250 
xfwd
 = &
r
->
h—d”s_š
.
x_fÜw¬ded_fÜ
;

252 ià(
xfwd
->
ÃÉs
 > 0 && 
gcf
->
´ox›s
 !ð
NULL
) {

253 (è
	`ngx_h‰p_g‘_fÜw¬ded_addr
(
r
, &
addr
, 
xfwd
, 
NULL
,

254 
gcf
->
´ox›s
, gcf->
´oxy_»cursive
);

257 #ià(
NGX_HAVE_INET6
)

259 ià(
addr
.
sockaddr
->
§_çmžy
 =ð
AF_INET6
) {

260 
u_ch¬
 *
p
;

261 
š_addr_t
 
šaddr
;

262 
š6_addr
 *
šaddr6
;

264 
šaddr6
 = &((
sockaddr_š6
 *è
addr
.
sockaddr
)->
sš6_addr
;

266 ià(
	`IN6_IS_ADDR_V4MAPPED
(
šaddr6
)) {

267 
p
 = 
šaddr6
->
s6_addr
;

269 
šaddr
 = 
p
[12] << 24;

270 
šaddr
 +ð
p
[13] << 16;

271 
šaddr
 +ð
p
[14] << 8;

272 
šaddr
 +ð
p
[15];

274  
šaddr
;

280 ià(
addr
.
sockaddr
->
§_çmžy
 !ð
AF_INET
) {

281  
INADDR_NONE
;

284 
sš
 = (
sockaddr_š
 *è
addr
.
sockaddr
;

285  
	`Áohl
(
sš
->
sš_addr
.
s_addr
);

286 
	}
}

289 #ià(
NGX_HAVE_GEOIP_V6
)

291 
geov6_t


292 
	$ngx_h‰p_geo_addr_v6
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_geo_cÚf_t
 *
gcf
)

294 
ngx_addr_t
 
addr
;

295 
ngx_¬¿y_t
 *
xfwd
;

296 
š_addr_t
 
addr4
;

297 
š6_addr
 
addr6
;

298 
sockaddr_š
 *
sš
;

299 
sockaddr_š6
 *
sš6
;

301 
addr
.
sockaddr
 = 
r
->
cÚÃùiÚ
->sockaddr;

302 
addr
.
sockËn
 = 
r
->
cÚÃùiÚ
->socklen;

305 
xfwd
 = &
r
->
h—d”s_š
.
x_fÜw¬ded_fÜ
;

307 ià(
xfwd
->
ÃÉs
 > 0 && 
gcf
->
´ox›s
 !ð
NULL
) {

308 (è
	`ngx_h‰p_g‘_fÜw¬ded_addr
(
r
, &
addr
, 
xfwd
, 
NULL
,

309 
gcf
->
´ox›s
, gcf->
´oxy_»cursive
);

312 
addr
.
sockaddr
->
§_çmžy
) {

314 
AF_INET
:

316 
sš
 = (
sockaddr_š
 *è
addr
.
sockaddr
;

317 
addr4
 = 
	`Áohl
(
sš
->
sš_addr
.
s_addr
);

319 
	`ngx_memz”o
(&
addr6
, (
š6_addr
));

320 
addr6
.
s6_addr
[10] = 0xff;

321 
addr6
.
s6_addr
[11] = 0xff;

322 
addr6
.
s6_addr
[12] = 
addr4
 >> 24;

323 
addr6
.
s6_addr
[13] = 
addr4
 >> 16;

324 
addr6
.
s6_addr
[14] = 
addr4
 >> 8;

325 
addr6
.
s6_addr
[15] = 
addr4
;

326  
addr6
;

328 
AF_INET6
:

329 
sš6
 = (
sockaddr_š6
 *è
addr
.
sockaddr
;

330  
sš6
->
sš6_addr
;

333  
š6addr_ªy
;

335 
	}
}

340 
ngx_št_t


341 
	$ngx_h‰p_geo_couÁry_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

342 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

344 
ngx_h‰p_geo_v¬ŸbË_hªdËr_±
 
hªdËr
 =

345 
ngx_h‰p_geo_couÁry_funùiÚs
[
d©a
];

346 #ià(
NGX_HAVE_GEOIP_V6
)

347 
ngx_h‰p_geo_v¬ŸbË_hªdËr_v6_±
 
hªdËr_v6
 =

348 
ngx_h‰p_geo_couÁry_v6_funùiÚs
[
d©a
];

351 cÚ¡ *
v®
;

352 
ngx_h‰p_geo_cÚf_t
 *
gcf
;

354 
gcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_geo_moduË
);

356 ià(
gcf
->
couÁry
 =ð
NULL
) {

357 
nÙ_found
;

360 #ià(
NGX_HAVE_GEOIP_V6
)

361 
v®
 = 
gcf
->
couÁry_v6


362 ? 
	`hªdËr_v6
(
gcf
->
couÁry
, 
	`ngx_h‰p_geo_addr_v6
(
r
, gcf))

363 : 
	`hªdËr
(
gcf
->
couÁry
, 
	`ngx_h‰p_geo_addr
(
r
, gcf));

365 
v®
 = 
	`hªdËr
(
gcf
->
couÁry
, 
	`ngx_h‰p_geo_addr
(
r
, gcf));

368 ià(
v®
 =ð
NULL
) {

369 
nÙ_found
;

372 
v
->
Ën
 = 
	`ngx_¡¾’
(
v®
);

373 
v
->
v®id
 = 1;

374 
v
->
no_ÿch—bË
 = 0;

375 
v
->
nÙ_found
 = 0;

376 
v
->
d©a
 = (
u_ch¬
 *è
v®
;

378  
NGX_OK
;

380 
nÙ_found
:

382 
v
->
nÙ_found
 = 1;

384  
NGX_OK
;

385 
	}
}

388 
ngx_št_t


389 
	$ngx_h‰p_geo_Üg_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

390 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

392 
size_t
 
Ën
;

393 *
v®
;

394 
ngx_h‰p_geo_cÚf_t
 *
gcf
;

396 
gcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_geo_moduË
);

398 ià(
gcf
->
Üg
 =ð
NULL
) {

399 
nÙ_found
;

402 #ià(
NGX_HAVE_GEOIP_V6
)

403 
v®
 = 
gcf
->
Üg_v6


404 ? 
	`GeoIP_Çme_by_num_v6
(
gcf
->
Üg
,

405 
	`ngx_h‰p_geo_addr_v6
(
r
, 
gcf
))

406 : 
	`GeoIP_Çme_by_num
(
gcf
->
Üg
,

407 
	`ngx_h‰p_geo_addr
(
r
, 
gcf
));

409 
v®
 = 
	`GeoIP_Çme_by_num
(
gcf
->
Üg
, 
	`ngx_h‰p_geo_addr
(
r
, gcf));

412 ià(
v®
 =ð
NULL
) {

413 
nÙ_found
;

416 
Ën
 = 
	`ngx_¡¾’
(
v®
);

417 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

418 ià(
v
->
d©a
 =ð
NULL
) {

419 
	`ngx_ä“
(
v®
);

420  
NGX_ERROR
;

423 
	`ngx_memýy
(
v
->
d©a
, 
v®
, 
Ën
);

425 
v
->
Ën
 =†en;

426 
v
->
v®id
 = 1;

427 
v
->
no_ÿch—bË
 = 0;

428 
v
->
nÙ_found
 = 0;

430 
	`ngx_ä“
(
v®
);

432  
NGX_OK
;

434 
nÙ_found
:

436 
v
->
nÙ_found
 = 1;

438  
NGX_OK
;

439 
	}
}

442 
ngx_št_t


443 
	$ngx_h‰p_geo_c™y_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

444 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

446 *
v®
;

447 
size_t
 
Ën
;

448 
GeoIPRecÜd
 *
gr
;

450 
gr
 = 
	`ngx_h‰p_geo_g‘_c™y_»cÜd
(
r
);

451 ià(
gr
 =ð
NULL
) {

452 
nÙ_found
;

455 
v®
 = *(**è((*è
gr
 + 
d©a
);

456 ià(
v®
 =ð
NULL
) {

457 
no_v®ue
;

460 
Ën
 = 
	`ngx_¡¾’
(
v®
);

461 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

462 ià(
v
->
d©a
 =ð
NULL
) {

463 
	`GeoIPRecÜd_d–‘e
(
gr
);

464  
NGX_ERROR
;

467 
	`ngx_memýy
(
v
->
d©a
, 
v®
, 
Ën
);

469 
v
->
Ën
 =†en;

470 
v
->
v®id
 = 1;

471 
v
->
no_ÿch—bË
 = 0;

472 
v
->
nÙ_found
 = 0;

474 
	`GeoIPRecÜd_d–‘e
(
gr
);

476  
NGX_OK
;

478 
no_v®ue
:

480 
	`GeoIPRecÜd_d–‘e
(
gr
);

482 
nÙ_found
:

484 
v
->
nÙ_found
 = 1;

486  
NGX_OK
;

487 
	}
}

490 
ngx_št_t


491 
	$ngx_h‰p_geo_»giÚ_Çme_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

492 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

494 
size_t
 
Ën
;

495 cÚ¡ *
v®
;

496 
GeoIPRecÜd
 *
gr
;

498 
gr
 = 
	`ngx_h‰p_geo_g‘_c™y_»cÜd
(
r
);

499 ià(
gr
 =ð
NULL
) {

500 
nÙ_found
;

503 
v®
 = 
	`GeoIP_»giÚ_Çme_by_code
(
gr
->
couÁry_code
, gr->
»giÚ
);

505 
	`GeoIPRecÜd_d–‘e
(
gr
);

507 ià(
v®
 =ð
NULL
) {

508 
nÙ_found
;

511 
Ën
 = 
	`ngx_¡¾’
(
v®
);

512 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

513 ià(
v
->
d©a
 =ð
NULL
) {

514  
NGX_ERROR
;

517 
	`ngx_memýy
(
v
->
d©a
, 
v®
, 
Ën
);

519 
v
->
Ën
 =†en;

520 
v
->
v®id
 = 1;

521 
v
->
no_ÿch—bË
 = 0;

522 
v
->
nÙ_found
 = 0;

524  
NGX_OK
;

526 
nÙ_found
:

528 
v
->
nÙ_found
 = 1;

530  
NGX_OK
;

531 
	}
}

534 
ngx_št_t


535 
	$ngx_h‰p_geo_c™y_æßt_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

536 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

538 
v®
;

539 
GeoIPRecÜd
 *
gr
;

541 
gr
 = 
	`ngx_h‰p_geo_g‘_c™y_»cÜd
(
r
);

542 ià(
gr
 =ð
NULL
) {

543 
v
->
nÙ_found
 = 1;

544  
NGX_OK
;

547 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_INT64_LEN
 + 5);

548 ià(
v
->
d©a
 =ð
NULL
) {

549 
	`GeoIPRecÜd_d–‘e
(
gr
);

550  
NGX_ERROR
;

553 
v®
 = *(*è((*è
gr
 + 
d©a
);

555 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%.4f", 
v®
) - v->data;

556 
v
->
v®id
 = 1;

557 
v
->
no_ÿch—bË
 = 0;

558 
v
->
nÙ_found
 = 0;

560 
	`GeoIPRecÜd_d–‘e
(
gr
);

562  
NGX_OK
;

563 
	}
}

566 
ngx_št_t


567 
	$ngx_h‰p_geo_c™y_št_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

568 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

570 
v®
;

571 
GeoIPRecÜd
 *
gr
;

573 
gr
 = 
	`ngx_h‰p_geo_g‘_c™y_»cÜd
(
r
);

574 ià(
gr
 =ð
NULL
) {

575 
v
->
nÙ_found
 = 1;

576  
NGX_OK
;

579 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_INT64_LEN
);

580 ià(
v
->
d©a
 =ð
NULL
) {

581 
	`GeoIPRecÜd_d–‘e
(
gr
);

582  
NGX_ERROR
;

585 
v®
 = *(*è((*è
gr
 + 
d©a
);

587 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%d", 
v®
) - v->data;

588 
v
->
v®id
 = 1;

589 
v
->
no_ÿch—bË
 = 0;

590 
v
->
nÙ_found
 = 0;

592 
	`GeoIPRecÜd_d–‘e
(
gr
);

594  
NGX_OK
;

595 
	}
}

598 
GeoIPRecÜd
 *

599 
	$ngx_h‰p_geo_g‘_c™y_»cÜd
(
ngx_h‰p_»que¡_t
 *
r
)

601 
ngx_h‰p_geo_cÚf_t
 *
gcf
;

603 
gcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_geo_moduË
);

605 ià(
gcf
->
c™y
) {

606 #ià(
NGX_HAVE_GEOIP_V6
)

607  
gcf
->
c™y_v6


608 ? 
	`GeoIP_»cÜd_by_num_v6
(
gcf
->
c™y
,

609 
	`ngx_h‰p_geo_addr_v6
(
r
, 
gcf
))

610 : 
	`GeoIP_»cÜd_by_num
(
gcf
->
c™y
,

611 
	`ngx_h‰p_geo_addr
(
r
, 
gcf
));

613  
	`GeoIP_»cÜd_by_num
(
gcf
->
c™y
, 
	`ngx_h‰p_geo_addr
(
r
, gcf));

617  
NULL
;

618 
	}
}

621 
ngx_št_t


622 
	$ngx_h‰p_geo_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

624 
ngx_h‰p_v¬ŸbË_t
 *
v¬
, *
v
;

626 
v
 = 
ngx_h‰p_geo_v¬s
; v->
Çme
.
Ën
; v++) {

627 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

628 ià(
v¬
 =ð
NULL
) {

629  
NGX_ERROR
;

632 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

633 
v¬
->
d©a
 = 
v
->data;

636  
NGX_OK
;

637 
	}
}

641 
	$ngx_h‰p_geo_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

643 
ngx_poÞ_þ—nup_t
 *
þn
;

644 
ngx_h‰p_geo_cÚf_t
 *
cÚf
;

646 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_geo_cÚf_t
));

647 ià(
cÚf
 =ð
NULL
) {

648  
NULL
;

651 
cÚf
->
´oxy_»cursive
 = 
NGX_CONF_UNSET
;

653 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

654 ià(
þn
 =ð
NULL
) {

655  
NULL
;

658 
þn
->
hªdËr
 = 
ngx_h‰p_geo_þ—nup
;

659 
þn
->
d©a
 = 
cÚf
;

661  
cÚf
;

662 
	}
}

666 
	$ngx_h‰p_geo_š™_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
)

668 
ngx_h‰p_geo_cÚf_t
 *
gcf
 = 
cÚf
;

670 
	`ngx_cÚf_š™_v®ue
(
gcf
->
´oxy_»cursive
, 0);

672  
NGX_CONF_OK
;

673 
	}
}

677 
	$ngx_h‰p_geo_couÁry
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

679 
ngx_h‰p_geo_cÚf_t
 *
gcf
 = 
cÚf
;

681 
ngx_¡r_t
 *
v®ue
;

683 ià(
gcf
->
couÁry
) {

687 
v®ue
 = 
cf
->
¬gs
->
–ts
;

689 
gcf
->
couÁry
 = 
	`GeoIP_Ý’
((*è
v®ue
[1].
d©a
, 
GEOIP_MEMORY_CACHE
);

691 ià(
gcf
->
couÁry
 =ð
NULL
) {

692 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

693 "GeoIP_Ý’(\"%V\"èçžed", &
v®ue
[1]);

695  
NGX_CONF_ERROR
;

698 ià(
cf
->
¬gs
->
ÃÉs
 == 3) {

699 ià(
	`ngx_¡rcmp
(
v®ue
[2].
d©a
, "utf8") == 0) {

700 
	`GeoIP_£t_ch¬£t
(
gcf
->
couÁry
, 
GEOIP_CHARSET_UTF8
);

703 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

704 "šv®id…¬am‘” \"%V\"", &
v®ue
[2]);

705  
NGX_CONF_ERROR
;

709 
gcf
->
couÁry
->
d©aba£Ty³
) {

711 
GEOIP_COUNTRY_EDITION
:

713  
NGX_CONF_OK
;

715 #ià(
NGX_HAVE_GEOIP_V6
)

716 
GEOIP_COUNTRY_EDITION_V6
:

718 
gcf
->
couÁry_v6
 = 1;

719  
NGX_CONF_OK
;

723 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

725 &
v®ue
[1], 
gcf
->
couÁry
->
d©aba£Ty³
);

726  
NGX_CONF_ERROR
;

728 
	}
}

732 
	$ngx_h‰p_geo_Üg
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

734 
ngx_h‰p_geo_cÚf_t
 *
gcf
 = 
cÚf
;

736 
ngx_¡r_t
 *
v®ue
;

738 ià(
gcf
->
Üg
) {

742 
v®ue
 = 
cf
->
¬gs
->
–ts
;

744 
gcf
->
Üg
 = 
	`GeoIP_Ý’
((*è
v®ue
[1].
d©a
, 
GEOIP_MEMORY_CACHE
);

746 ià(
gcf
->
Üg
 =ð
NULL
) {

747 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

748 "GeoIP_Ý’(\"%V\"èçžed", &
v®ue
[1]);

750  
NGX_CONF_ERROR
;

753 ià(
cf
->
¬gs
->
ÃÉs
 == 3) {

754 ià(
	`ngx_¡rcmp
(
v®ue
[2].
d©a
, "utf8") == 0) {

755 
	`GeoIP_£t_ch¬£t
(
gcf
->
Üg
, 
GEOIP_CHARSET_UTF8
);

758 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

759 "šv®id…¬am‘” \"%V\"", &
v®ue
[2]);

760  
NGX_CONF_ERROR
;

764 
gcf
->
Üg
->
d©aba£Ty³
) {

766 
GEOIP_ISP_EDITION
:

767 
GEOIP_ORG_EDITION
:

768 
GEOIP_DOMAIN_EDITION
:

769 
GEOIP_ASNUM_EDITION
:

771  
NGX_CONF_OK
;

773 #ià(
NGX_HAVE_GEOIP_V6
)

774 
GEOIP_ISP_EDITION_V6
:

775 
GEOIP_ORG_EDITION_V6
:

776 
GEOIP_DOMAIN_EDITION_V6
:

777 
GEOIP_ASNUM_EDITION_V6
:

779 
gcf
->
Üg_v6
 = 1;

780  
NGX_CONF_OK
;

784 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

786 &
v®ue
[1], 
gcf
->
Üg
->
d©aba£Ty³
);

787  
NGX_CONF_ERROR
;

789 
	}
}

793 
	$ngx_h‰p_geo_c™y
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

795 
ngx_h‰p_geo_cÚf_t
 *
gcf
 = 
cÚf
;

797 
ngx_¡r_t
 *
v®ue
;

799 ià(
gcf
->
c™y
) {

803 
v®ue
 = 
cf
->
¬gs
->
–ts
;

805 
gcf
->
c™y
 = 
	`GeoIP_Ý’
((*è
v®ue
[1].
d©a
, 
GEOIP_MEMORY_CACHE
);

807 ià(
gcf
->
c™y
 =ð
NULL
) {

808 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

809 "GeoIP_Ý’(\"%V\"èçžed", &
v®ue
[1]);

811  
NGX_CONF_ERROR
;

814 ià(
cf
->
¬gs
->
ÃÉs
 == 3) {

815 ià(
	`ngx_¡rcmp
(
v®ue
[2].
d©a
, "utf8") == 0) {

816 
	`GeoIP_£t_ch¬£t
(
gcf
->
c™y
, 
GEOIP_CHARSET_UTF8
);

819 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

820 "šv®id…¬am‘” \"%V\"", &
v®ue
[2]);

821  
NGX_CONF_ERROR
;

825 
gcf
->
c™y
->
d©aba£Ty³
) {

827 
GEOIP_CITY_EDITION_REV0
:

828 
GEOIP_CITY_EDITION_REV1
:

830  
NGX_CONF_OK
;

832 #ià(
NGX_HAVE_GEOIP_V6
)

833 
GEOIP_CITY_EDITION_REV0_V6
:

834 
GEOIP_CITY_EDITION_REV1_V6
:

836 
gcf
->
c™y_v6
 = 1;

837  
NGX_CONF_OK
;

841 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

843 &
v®ue
[1], 
gcf
->
c™y
->
d©aba£Ty³
);

844  
NGX_CONF_ERROR
;

846 
	}
}

850 
	$ngx_h‰p_geo_´oxy
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

852 
ngx_h‰p_geo_cÚf_t
 *
gcf
 = 
cÚf
;

854 
ngx_¡r_t
 *
v®ue
;

855 
ngx_cidr_t
 
cidr
, *
c
;

857 
v®ue
 = 
cf
->
¬gs
->
–ts
;

859 ià(
	`ngx_h‰p_geo_cidr_v®ue
(
cf
, &
v®ue
[1], &
cidr
è!ð
NGX_OK
) {

860  
NGX_CONF_ERROR
;

863 ià(
gcf
->
´ox›s
 =ð
NULL
) {

864 
gcf
->
´ox›s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4, (
ngx_cidr_t
));

865 ià(
gcf
->
´ox›s
 =ð
NULL
) {

866  
NGX_CONF_ERROR
;

870 
c
 = 
	`ngx_¬¿y_push
(
gcf
->
´ox›s
);

871 ià(
c
 =ð
NULL
) {

872  
NGX_CONF_ERROR
;

875 *
c
 = 
cidr
;

877  
NGX_CONF_OK
;

878 
	}
}

880 
ngx_št_t


881 
	$ngx_h‰p_geo_cidr_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
Ãt
, 
ngx_cidr_t
 *
cidr
)

883 
ngx_št_t
 
rc
;

885 ià(
	`ngx_¡rcmp
(
Ãt
->
d©a
, "255.255.255.255") == 0) {

886 
cidr
->
çmžy
 = 
AF_INET
;

887 
cidr
->
u
.
š
.
addr
 = 0xffffffff;

888 
cidr
->
u
.
š
.
mask
 = 0xffffffff;

890  
NGX_OK
;

893 
rc
 = 
	`ngx_±ocidr
(
Ãt
, 
cidr
);

895 ià(
rc
 =ð
NGX_ERROR
) {

896 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "šv®id‚‘wÜk \"%V\"", 
Ãt
);

897  
NGX_ERROR
;

900 ià(
rc
 =ð
NGX_DONE
) {

901 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

902 "low‡dd»s b™ oà%V‡» m—nšgËss", 
Ãt
);

905  
NGX_OK
;

906 
	}
}

910 
	$ngx_h‰p_geo_þ—nup
(*
d©a
)

912 
ngx_h‰p_geo_cÚf_t
 *
gcf
 = 
d©a
;

914 ià(
gcf
->
couÁry
) {

915 
	`GeoIP_d–‘e
(
gcf
->
couÁry
);

918 ià(
gcf
->
Üg
) {

919 
	`GeoIP_d–‘e
(
gcf
->
Üg
);

922 ià(
gcf
->
c™y
) {

923 
	`GeoIP_d–‘e
(
gcf
->
c™y
);

925 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_gunzip_filter_module.c

9 
	~<ngx_cÚfig.h
>

10 
	~<ngx_cÜe.h
>

11 
	~<ngx_h‰p.h
>

13 
	~<zlib.h
>

17 
ngx_æag_t
 
	m’abË
;

18 
ngx_bufs_t
 
	mbufs
;

19 } 
	tngx_h‰p_gunz_cÚf_t
;

23 
ngx_chaš_t
 *
	mš
;

24 
ngx_chaš_t
 *
	mä“
;

25 
ngx_chaš_t
 *
	mbusy
;

26 
ngx_chaš_t
 *
	mout
;

27 
ngx_chaš_t
 **
	mÏ¡_out
;

29 
ngx_buf_t
 *
	mš_buf
;

30 
ngx_buf_t
 *
	mout_buf
;

31 
ngx_št_t
 
	mbufs
;

33 
	m¡¬‹d
:1;

34 
	mæush
:4;

35 
	m»do
:1;

36 
	mdÚe
:1;

37 
	mnomem
:1;

39 
z_¡»am
 
	mz¡»am
;

40 
ngx_h‰p_»que¡_t
 *
	m»que¡
;

41 } 
	tngx_h‰p_gunz_ùx_t
;

44 
ngx_št_t
 
ngx_h‰p_gunz_fž‹r_šæ©e_¡¬t
(
ngx_h‰p_»que¡_t
 *
r
,

45 
ngx_h‰p_gunz_ùx_t
 *
ùx
);

46 
ngx_št_t
 
ngx_h‰p_gunz_fž‹r_add_d©a
(
ngx_h‰p_»que¡_t
 *
r
,

47 
ngx_h‰p_gunz_ùx_t
 *
ùx
);

48 
ngx_št_t
 
ngx_h‰p_gunz_fž‹r_g‘_buf
(
ngx_h‰p_»que¡_t
 *
r
,

49 
ngx_h‰p_gunz_ùx_t
 *
ùx
);

50 
ngx_št_t
 
ngx_h‰p_gunz_fž‹r_šæ©e
(
ngx_h‰p_»que¡_t
 *
r
,

51 
ngx_h‰p_gunz_ùx_t
 *
ùx
);

52 
ngx_št_t
 
ngx_h‰p_gunz_fž‹r_šæ©e_’d
(
ngx_h‰p_»que¡_t
 *
r
,

53 
ngx_h‰p_gunz_ùx_t
 *
ùx
);

55 *
ngx_h‰p_gunz_fž‹r_®loc
(*
Ýaque
, 
u_št
 
™ems
,

56 
u_št
 
size
);

57 
ngx_h‰p_gunz_fž‹r_ä“
(*
Ýaque
, *
add»ss
);

59 
ngx_št_t
 
ngx_h‰p_gunz_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

60 *
ngx_h‰p_gunz_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

61 *
ngx_h‰p_gunz_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
,

62 *
·»Á
, *
chžd
);

65 
ngx_commªd_t
 
	gngx_h‰p_gunz_fž‹r_commªds
[] = {

67 { 
ngx_¡ršg
("gunzip"),

68 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

69 
ngx_cÚf_£t_æag_¦Ù
,

70 
NGX_HTTP_LOC_CONF_OFFSET
,

71 
off£tof
(
ngx_h‰p_gunz_cÚf_t
, 
’abË
),

72 
NULL
 },

74 { 
ngx_¡ršg
("gunzip_buffers"),

75 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

76 
ngx_cÚf_£t_bufs_¦Ù
,

77 
NGX_HTTP_LOC_CONF_OFFSET
,

78 
off£tof
(
ngx_h‰p_gunz_cÚf_t
, 
bufs
),

79 
NULL
 },

81 
ngx_nuÎ_commªd


85 
ngx_h‰p_moduË_t
 
	gngx_h‰p_gunz_fž‹r_moduË_ùx
 = {

86 
NULL
,

87 
ngx_h‰p_gunz_fž‹r_š™
,

89 
NULL
,

90 
NULL
,

92 
NULL
,

93 
NULL
,

95 
ngx_h‰p_gunz_ü—‹_cÚf
,

96 
ngx_h‰p_gunz_m”ge_cÚf


100 
ngx_moduË_t
 
	gngx_h‰p_gunz_fž‹r_moduË
 = {

101 
NGX_MODULE_V1
,

102 &
ngx_h‰p_gunz_fž‹r_moduË_ùx
,

103 
ngx_h‰p_gunz_fž‹r_commªds
,

104 
NGX_HTTP_MODULE
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NULL
,

110 
NULL
,

111 
NULL
,

112 
NGX_MODULE_V1_PADDING


116 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

117 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

120 
ngx_št_t


121 
	$ngx_h‰p_gunz_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

123 
ngx_h‰p_gunz_ùx_t
 *
ùx
;

124 
ngx_h‰p_gunz_cÚf_t
 *
cÚf
;

126 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gunz_fž‹r_moduË
);

132 ià(!
cÚf
->
’abË


133 || 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
 =ð
NULL


134 || 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
->
v®ue
.
Ën
 != 4

135 || 
	`ngx_¡ºÿ£cmp
(
r
->
h—d”s_out
.
cÚ‹Á_’codšg
->
v®ue
.
d©a
,

136 (
u_ch¬
 *) "gzip", 4) != 0)

138  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

141 
r
->
gz_v¬y
 = 1;

143 ià(!
r
->
gz_‹¡ed
) {

144 ià(
	`ngx_h‰p_gz_ok
(
r
è=ð
NGX_OK
) {

145  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

148 } ià(
r
->
gz_ok
) {

149  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

152 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_gunz_ùx_t
));

153 ià(
ùx
 =ð
NULL
) {

154  
NGX_ERROR
;

157 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_gunz_fž‹r_moduË
);

159 
ùx
->
»que¡
 = 
r
;

161 
r
->
fž‹r_Ãed_š_memÜy
 = 1;

163 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
->
hash
 = 0;

164 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
 = 
NULL
;

166 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
r
);

167 
	`ngx_h‰p_þ—r_acû±_¿nges
(
r
);

168 
	`ngx_h‰p_w—k_‘ag
(
r
);

170  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

171 
	}
}

174 
ngx_št_t


175 
	$ngx_h‰p_gunz_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

177 
rc
;

178 
ngx_ušt_t
 
æush
;

179 
ngx_chaš_t
 *
þ
;

180 
ngx_h‰p_gunz_ùx_t
 *
ùx
;

182 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_gunz_fž‹r_moduË
);

184 ià(
ùx
 =ð
NULL
 || ctx->
dÚe
) {

185  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

188 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

191 ià(!
ùx
->
¡¬‹d
) {

192 ià(
	`ngx_h‰p_gunz_fž‹r_šæ©e_¡¬t
(
r
, 
ùx
è!ð
NGX_OK
) {

193 
çžed
;

197 ià(
š
) {

198 ià(
	`ngx_chaš_add_cÝy
(
r
->
poÞ
, &
ùx
->
š
, inè!ð
NGX_OK
) {

199 
çžed
;

203 ià(
ùx
->
nomem
) {

207 ià(
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
NULL
è=ð
NGX_ERROR
) {

208 
çžed
;

211 
þ
 = 
NULL
;

213 
	`ngx_chaš_upd©e_chašs
(
r
->
poÞ
, &
ùx
->
ä“
, &ùx->
busy
, &
þ
,

214 (
ngx_buf_g_t
è&
ngx_h‰p_gunz_fž‹r_moduË
);

215 
ùx
->
nomem
 = 0;

216 
æush
 = 0;

219 
æush
 = 
ùx
->
busy
 ? 1 : 0;

230 
rc
 = 
	`ngx_h‰p_gunz_fž‹r_add_d©a
(
r
, 
ùx
);

232 ià(
rc
 =ð
NGX_DECLINED
) {

236 ià(
rc
 =ð
NGX_AGAIN
) {

243 
rc
 = 
	`ngx_h‰p_gunz_fž‹r_g‘_buf
(
r
, 
ùx
);

245 ià(
rc
 =ð
NGX_DECLINED
) {

249 ià(
rc
 =ð
NGX_ERROR
) {

250 
çžed
;

253 
rc
 = 
	`ngx_h‰p_gunz_fž‹r_šæ©e
(
r
, 
ùx
);

255 ià(
rc
 =ð
NGX_OK
) {

259 ià(
rc
 =ð
NGX_ERROR
) {

260 
çžed
;

266 ià(
ùx
->
out
 =ð
NULL
 && !
æush
) {

267  
ùx
->
busy
 ? 
NGX_AGAIN
 : 
NGX_OK
;

270 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
ùx
->
out
);

272 ià(
rc
 =ð
NGX_ERROR
) {

273 
çžed
;

276 
	`ngx_chaš_upd©e_chašs
(
r
->
poÞ
, &
ùx
->
ä“
, &ùx->
busy
, &ùx->
out
,

277 (
ngx_buf_g_t
è&
ngx_h‰p_gunz_fž‹r_moduË
);

278 
ùx
->
Ï¡_out
 = &ùx->
out
;

280 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

281 "gunz out: %p", 
ùx
->
out
);

283 
ùx
->
nomem
 = 0;

284 
æush
 = 0;

286 ià(
ùx
->
dÚe
) {

287  
rc
;

293 
çžed
:

295 
ùx
->
dÚe
 = 1;

297  
NGX_ERROR
;

298 
	}
}

301 
ngx_št_t


302 
	$ngx_h‰p_gunz_fž‹r_šæ©e_¡¬t
(
ngx_h‰p_»que¡_t
 *
r
,

303 
ngx_h‰p_gunz_ùx_t
 *
ùx
)

305 
rc
;

307 
ùx
->
z¡»am
.
Ãxt_š
 = 
Z_NULL
;

308 
ùx
->
z¡»am
.
avaž_š
 = 0;

310 
ùx
->
z¡»am
.
z®loc
 = 
ngx_h‰p_gunz_fž‹r_®loc
;

311 
ùx
->
z¡»am
.
zä“
 = 
ngx_h‰p_gunz_fž‹r_ä“
;

312 
ùx
->
z¡»am
.
Ýaque
 = ctx;

315 
rc
 = 
	`šæ©eIn™2
(&
ùx
->
z¡»am
, 
MAX_WBITS
 + 16);

317 ià(
rc
 !ð
Z_OK
) {

318 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

319 "šæ©eIn™2(èçžed: %d", 
rc
);

320  
NGX_ERROR
;

323 
ùx
->
¡¬‹d
 = 1;

325 
ùx
->
Ï¡_out
 = &ùx->
out
;

326 
ùx
->
æush
 = 
Z_NO_FLUSH
;

328  
NGX_OK
;

329 
	}
}

332 
ngx_št_t


333 
	$ngx_h‰p_gunz_fž‹r_add_d©a
(
ngx_h‰p_»que¡_t
 *
r
,

334 
ngx_h‰p_gunz_ùx_t
 *
ùx
)

336 ià(
ùx
->
z¡»am
.
avaž_š
 || ctx->
æush
 !ð
Z_NO_FLUSH
 || ctx->
»do
) {

337  
NGX_OK
;

340 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

341 "gunz in: %p", 
ùx
->
š
);

343 ià(
ùx
->
š
 =ð
NULL
) {

344  
NGX_DECLINED
;

347 
ùx
->
š_buf
 = ctx->
š
->
buf
;

348 
ùx
->
š
 = ctx->š->
Ãxt
;

350 
ùx
->
z¡»am
.
Ãxt_š
 = ctx->
š_buf
->
pos
;

351 
ùx
->
z¡»am
.
avaž_š
 = ctx->
š_buf
->
Ï¡
 - ctx->š_buf->
pos
;

353 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

355 
ùx
->
š_buf
,

356 
ùx
->
z¡»am
.
Ãxt_š
, ctx->z¡»am.
avaž_š
);

358 ià(
ùx
->
š_buf
->
Ï¡_buf
 || ctx->š_buf->
Ï¡_š_chaš
) {

359 
ùx
->
æush
 = 
Z_FINISH
;

361 } ià(
ùx
->
š_buf
->
æush
) {

362 
ùx
->
æush
 = 
Z_SYNC_FLUSH
;

364 } ià(
ùx
->
z¡»am
.
avaž_š
 == 0) {

366  
NGX_AGAIN
;

369  
NGX_OK
;

370 
	}
}

373 
ngx_št_t


374 
	$ngx_h‰p_gunz_fž‹r_g‘_buf
(
ngx_h‰p_»que¡_t
 *
r
,

375 
ngx_h‰p_gunz_ùx_t
 *
ùx
)

377 
ngx_h‰p_gunz_cÚf_t
 *
cÚf
;

379 ià(
ùx
->
z¡»am
.
avaž_out
) {

380  
NGX_OK
;

383 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gunz_fž‹r_moduË
);

385 ià(
ùx
->
ä“
) {

386 
ùx
->
out_buf
 = ctx->
ä“
->
buf
;

387 
ùx
->
ä“
 = ctx->ä“->
Ãxt
;

389 
ùx
->
out_buf
->
æush
 = 0;

391 } ià(
ùx
->
bufs
 < 
cÚf
->bufs.
num
) {

393 
ùx
->
out_buf
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
cÚf
->
bufs
.
size
);

394 ià(
ùx
->
out_buf
 =ð
NULL
) {

395  
NGX_ERROR
;

398 
ùx
->
out_buf
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_gunz_fž‹r_moduË
;

399 
ùx
->
out_buf
->
»cyþed
 = 1;

400 
ùx
->
bufs
++;

403 
ùx
->
nomem
 = 1;

404  
NGX_DECLINED
;

407 
ùx
->
z¡»am
.
Ãxt_out
 = ctx->
out_buf
->
pos
;

408 
ùx
->
z¡»am
.
avaž_out
 = 
cÚf
->
bufs
.
size
;

410  
NGX_OK
;

411 
	}
}

414 
ngx_št_t


415 
	$ngx_h‰p_gunz_fž‹r_šæ©e
(
ngx_h‰p_»que¡_t
 *
r
,

416 
ngx_h‰p_gunz_ùx_t
 *
ùx
)

418 
rc
;

419 
ngx_buf_t
 *
b
;

420 
ngx_chaš_t
 *
þ
;

422 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

424 
ùx
->
z¡»am
.
Ãxt_š
, ctx->z¡»am.
Ãxt_out
,

425 
ùx
->
z¡»am
.
avaž_š
, ctx->z¡»am.
avaž_out
,

426 
ùx
->
æush
, ctx->
»do
);

428 
rc
 = 
	`šæ©e
(&
ùx
->
z¡»am
, ctx->
æush
);

430 ià(
rc
 !ð
Z_OK
 &&„ø!ð
Z_STREAM_END
 &&„ø!ð
Z_BUF_ERROR
) {

431 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

432 "šæ©e(èçžed: %d, %d", 
ùx
->
æush
, 
rc
);

433  
NGX_ERROR
;

436 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

438 
ùx
->
z¡»am
.
Ãxt_š
, ctx->z¡»am.
Ãxt_out
,

439 
ùx
->
z¡»am
.
avaž_š
, ctx->z¡»am.
avaž_out
,

440 
rc
);

442 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

444 
ùx
->
š_buf
, ctx->š_buf->
pos
);

446 ià(
ùx
->
z¡»am
.
Ãxt_š
) {

447 
ùx
->
š_buf
->
pos
 = ctx->
z¡»am
.
Ãxt_š
;

449 ià(
ùx
->
z¡»am
.
avaž_š
 == 0) {

450 
ùx
->
z¡»am
.
Ãxt_š
 = 
NULL
;

454 
ùx
->
out_buf
->
Ï¡
 = ctx->
z¡»am
.
Ãxt_out
;

456 ià(
ùx
->
z¡»am
.
avaž_out
 == 0) {

460 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

461 ià(
þ
 =ð
NULL
) {

462  
NGX_ERROR
;

465 
þ
->
buf
 = 
ùx
->
out_buf
;

466 
þ
->
Ãxt
 = 
NULL
;

467 *
ùx
->
Ï¡_out
 = 
þ
;

468 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

470 
ùx
->
»do
 = 1;

472  
NGX_AGAIN
;

475 
ùx
->
»do
 = 0;

477 ià(
ùx
->
æush
 =ð
Z_SYNC_FLUSH
) {

479 
ùx
->
æush
 = 
Z_NO_FLUSH
;

481 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

482 ià(
þ
 =ð
NULL
) {

483  
NGX_ERROR
;

486 
b
 = 
ùx
->
out_buf
;

488 ià(
	`ngx_buf_size
(
b
) == 0) {

490 
b
 = 
	`ngx_ÿÎoc_buf
(
ùx
->
»que¡
->
poÞ
);

491 ià(
b
 =ð
NULL
) {

492  
NGX_ERROR
;

496 
ùx
->
z¡»am
.
avaž_out
 = 0;

499 
b
->
æush
 = 1;

501 
þ
->
buf
 = 
b
;

502 
þ
->
Ãxt
 = 
NULL
;

503 *
ùx
->
Ï¡_out
 = 
þ
;

504 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

506  
NGX_OK
;

509 ià(
ùx
->
æush
 =ð
Z_FINISH
 && ctx->
z¡»am
.
avaž_š
 == 0) {

511 ià(
rc
 !ð
Z_STREAM_END
) {

512 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

513 "šæ©e(è»tuºed %d oÀ»¥Ú£ƒnd", 
rc
);

514  
NGX_ERROR
;

517 ià(
	`ngx_h‰p_gunz_fž‹r_šæ©e_’d
(
r
, 
ùx
è!ð
NGX_OK
) {

518  
NGX_ERROR
;

521  
NGX_OK
;

524 ià(
rc
 =ð
Z_STREAM_END
 && 
ùx
->
z¡»am
.
avaž_š
 > 0) {

526 
rc
 = 
	`šæ©eRe£t
(&
ùx
->
z¡»am
);

528 ià(
rc
 !ð
Z_OK
) {

529 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

530 "šæ©eRe£t(èçžed: %d", 
rc
);

531  
NGX_ERROR
;

534 
ùx
->
»do
 = 1;

536  
NGX_AGAIN
;

539 ià(
ùx
->
š
 =ð
NULL
) {

541 
b
 = 
ùx
->
out_buf
;

543 ià(
	`ngx_buf_size
(
b
) == 0) {

544  
NGX_OK
;

547 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

548 ià(
þ
 =ð
NULL
) {

549  
NGX_ERROR
;

552 
ùx
->
z¡»am
.
avaž_out
 = 0;

554 
þ
->
buf
 = 
b
;

555 
þ
->
Ãxt
 = 
NULL
;

556 *
ùx
->
Ï¡_out
 = 
þ
;

557 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

559  
NGX_OK
;

562  
NGX_AGAIN
;

563 
	}
}

566 
ngx_št_t


567 
	$ngx_h‰p_gunz_fž‹r_šæ©e_’d
(
ngx_h‰p_»que¡_t
 *
r
,

568 
ngx_h‰p_gunz_ùx_t
 *
ùx
)

570 
rc
;

571 
ngx_buf_t
 *
b
;

572 
ngx_chaš_t
 *
þ
;

574 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

577 
rc
 = 
	`šæ©eEnd
(&
ùx
->
z¡»am
);

579 ià(
rc
 !ð
Z_OK
) {

580 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

581 "šæ©eEnd(èçžed: %d", 
rc
);

582  
NGX_ERROR
;

585 
b
 = 
ùx
->
out_buf
;

587 ià(
	`ngx_buf_size
(
b
) == 0) {

589 
b
 = 
	`ngx_ÿÎoc_buf
(
ùx
->
»que¡
->
poÞ
);

590 ià(
b
 =ð
NULL
) {

591  
NGX_ERROR
;

595 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

596 ià(
þ
 =ð
NULL
) {

597  
NGX_ERROR
;

600 
þ
->
buf
 = 
b
;

601 
þ
->
Ãxt
 = 
NULL
;

602 *
ùx
->
Ï¡_out
 = 
þ
;

603 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

605 
b
->
Ï¡_buf
 = (
r
 =ðr->
maš
) ? 1 : 0;

606 
b
->
Ï¡_š_chaš
 = 1;

607 
b
->
sync
 = 1;

609 
ùx
->
dÚe
 = 1;

611  
NGX_OK
;

612 
	}
}

616 
	$ngx_h‰p_gunz_fž‹r_®loc
(*
Ýaque
, 
u_št
 
™ems
, u_šˆ
size
)

618 
ngx_h‰p_gunz_ùx_t
 *
ùx
 = 
Ýaque
;

620 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

622 
™ems
, 
size
);

624  
	`ngx_·Îoc
(
ùx
->
»que¡
->
poÞ
, 
™ems
 * 
size
);

625 
	}
}

629 
	$ngx_h‰p_gunz_fž‹r_ä“
(*
Ýaque
, *
add»ss
)

632 
ngx_h‰p_gunz_ùx_t
 *
ùx
 = 
Ýaque
;

634 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

635 "gunz f»e: %p", 
add»ss
);

637 
	}
}

641 
	$ngx_h‰p_gunz_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

643 
ngx_h‰p_gunz_cÚf_t
 *
cÚf
;

645 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_gunz_cÚf_t
));

646 ià(
cÚf
 =ð
NULL
) {

647  
NULL
;

656 
cÚf
->
’abË
 = 
NGX_CONF_UNSET
;

658  
cÚf
;

659 
	}
}

663 
	$ngx_h‰p_gunz_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

665 
ngx_h‰p_gunz_cÚf_t
 *
´ev
 = 
·»Á
;

666 
ngx_h‰p_gunz_cÚf_t
 *
cÚf
 = 
chžd
;

668 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

670 
	`ngx_cÚf_m”ge_bufs_v®ue
(
cÚf
->
bufs
, 
´ev
->bufs,

671 (128 * 1024è/ 
ngx_·gesize
,‚gx_pagesize);

673  
NGX_CONF_OK
;

674 
	}
}

677 
ngx_št_t


678 
	$ngx_h‰p_gunz_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

680 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

681 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_gunz_h—d”_fž‹r
;

683 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

684 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_gunz_body_fž‹r
;

686  
NGX_OK
;

687 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_gzip_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

12 
	~<zlib.h
>

16 
ngx_æag_t
 
	m’abË
;

17 
ngx_æag_t
 
	mno_bufãr
;

19 
ngx_hash_t
 
	mty³s
;

21 
ngx_bufs_t
 
	mbufs
;

23 
size_t
 
	mpo¡pÚe_gzpšg
;

24 
ngx_št_t
 
	mËv–
;

25 
size_t
 
	mwb™s
;

26 
size_t
 
	mmemËv–
;

27 
ssize_t
 
	mmš_Ëngth
;

29 
ngx_¬¿y_t
 *
	mty³s_keys
;

30 } 
	tngx_h‰p_gz_cÚf_t
;

34 
ngx_chaš_t
 *
	mš
;

35 
ngx_chaš_t
 *
	mä“
;

36 
ngx_chaš_t
 *
	mbusy
;

37 
ngx_chaš_t
 *
	mout
;

38 
ngx_chaš_t
 **
	mÏ¡_out
;

40 
ngx_chaš_t
 *
	mcÝ›d
;

41 
ngx_chaš_t
 *
	mcÝy_buf
;

43 
ngx_buf_t
 *
	mš_buf
;

44 
ngx_buf_t
 *
	mout_buf
;

45 
ngx_št_t
 
	mbufs
;

47 *
	m´—Îoÿ‹d
;

48 *
	mä“_mem
;

49 
ngx_ušt_t
 
	m®loÿ‹d
;

51 
	mwb™s
;

52 
	mmemËv–
;

54 
	mæush
:4;

55 
	m»do
:1;

56 
	mdÚe
:1;

57 
	mnomem
:1;

58 
	mgzh—d”
:1;

59 
	mbufãršg
:1;

61 
size_t
 
	mzš
;

62 
size_t
 
	mzout
;

64 
ušt32_t
 
	müc32
;

65 
z_¡»am
 
	mz¡»am
;

66 
ngx_h‰p_»que¡_t
 *
	m»que¡
;

67 } 
	tngx_h‰p_gz_ùx_t
;

70 #ià(
NGX_HAVE_LITTLE_ENDIAN
 && 
NGX_HAVE_NONALIGNED
)

72 
	sgzŒaž”
 {

73 
ušt32_t
 
	müc32
;

74 
ušt32_t
 
	mzËn
;

79 
	sgzŒaž”
 {

80 
u_ch¬
 
	müc32
[4];

81 
u_ch¬
 
	mzËn
[4];

87 
ngx_h‰p_gz_fž‹r_memÜy
(
ngx_h‰p_»que¡_t
 *
r
,

88 
ngx_h‰p_gz_ùx_t
 *
ùx
);

89 
ngx_št_t
 
ngx_h‰p_gz_fž‹r_bufãr
(
ngx_h‰p_gz_ùx_t
 *
ùx
,

90 
ngx_chaš_t
 *
š
);

91 
ngx_št_t
 
ngx_h‰p_gz_fž‹r_deæ©e_¡¬t
(
ngx_h‰p_»que¡_t
 *
r
,

92 
ngx_h‰p_gz_ùx_t
 *
ùx
);

93 
ngx_št_t
 
ngx_h‰p_gz_fž‹r_gzh—d”
(
ngx_h‰p_»que¡_t
 *
r
,

94 
ngx_h‰p_gz_ùx_t
 *
ùx
);

95 
ngx_št_t
 
ngx_h‰p_gz_fž‹r_add_d©a
(
ngx_h‰p_»que¡_t
 *
r
,

96 
ngx_h‰p_gz_ùx_t
 *
ùx
);

97 
ngx_št_t
 
ngx_h‰p_gz_fž‹r_g‘_buf
(
ngx_h‰p_»que¡_t
 *
r
,

98 
ngx_h‰p_gz_ùx_t
 *
ùx
);

99 
ngx_št_t
 
ngx_h‰p_gz_fž‹r_deæ©e
(
ngx_h‰p_»que¡_t
 *
r
,

100 
ngx_h‰p_gz_ùx_t
 *
ùx
);

101 
ngx_št_t
 
ngx_h‰p_gz_fž‹r_deæ©e_’d
(
ngx_h‰p_»que¡_t
 *
r
,

102 
ngx_h‰p_gz_ùx_t
 *
ùx
);

104 *
ngx_h‰p_gz_fž‹r_®loc
(*
Ýaque
, 
u_št
 
™ems
,

105 
u_št
 
size
);

106 
ngx_h‰p_gz_fž‹r_ä“
(*
Ýaque
, *
add»ss
);

107 
ngx_h‰p_gz_fž‹r_ä“_cÝy_buf
(
ngx_h‰p_»que¡_t
 *
r
,

108 
ngx_h‰p_gz_ùx_t
 *
ùx
);

110 
ngx_št_t
 
ngx_h‰p_gz_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

111 
ngx_št_t
 
ngx_h‰p_gz_¿tio_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

112 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

114 
ngx_št_t
 
ngx_h‰p_gz_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

115 *
ngx_h‰p_gz_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

116 *
ngx_h‰p_gz_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
,

117 *
·»Á
, *
chžd
);

118 *
ngx_h‰p_gz_wšdow
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

119 *
ngx_h‰p_gz_hash
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

122 
ngx_cÚf_num_bounds_t
 
	gngx_h‰p_gz_comp_Ëv–_bounds
 = {

123 
ngx_cÚf_check_num_bounds
, 1, 9

126 
ngx_cÚf_po¡_hªdËr_±
 
	gngx_h‰p_gz_wšdow_p
 = 
ngx_h‰p_gz_wšdow
;

127 
ngx_cÚf_po¡_hªdËr_±
 
	gngx_h‰p_gz_hash_p
 = 
ngx_h‰p_gz_hash
;

130 
ngx_commªd_t
 
	gngx_h‰p_gz_fž‹r_commªds
[] = {

132 { 
ngx_¡ršg
("gzip"),

133 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


134 |
NGX_CONF_FLAG
,

135 
ngx_cÚf_£t_æag_¦Ù
,

136 
NGX_HTTP_LOC_CONF_OFFSET
,

137 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
’abË
),

138 
NULL
 },

140 { 
ngx_¡ršg
("gzip_buffers"),

141 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

142 
ngx_cÚf_£t_bufs_¦Ù
,

143 
NGX_HTTP_LOC_CONF_OFFSET
,

144 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
bufs
),

145 
NULL
 },

147 { 
ngx_¡ršg
("gzip_types"),

148 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

149 
ngx_h‰p_ty³s_¦Ù
,

150 
NGX_HTTP_LOC_CONF_OFFSET
,

151 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
ty³s_keys
),

152 &
ngx_h‰p_html_deçuÉ_ty³s
[0] },

154 { 
ngx_¡ršg
("gzip_comp_level"),

155 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

156 
ngx_cÚf_£t_num_¦Ù
,

157 
NGX_HTTP_LOC_CONF_OFFSET
,

158 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
Ëv–
),

159 &
ngx_h‰p_gz_comp_Ëv–_bounds
 },

161 { 
ngx_¡ršg
("gzip_window"),

162 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

163 
ngx_cÚf_£t_size_¦Ù
,

164 
NGX_HTTP_LOC_CONF_OFFSET
,

165 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
wb™s
),

166 &
ngx_h‰p_gz_wšdow_p
 },

168 { 
ngx_¡ršg
("gzip_hash"),

169 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

170 
ngx_cÚf_£t_size_¦Ù
,

171 
NGX_HTTP_LOC_CONF_OFFSET
,

172 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
memËv–
),

173 &
ngx_h‰p_gz_hash_p
 },

175 { 
ngx_¡ršg
("postpone_gzipping"),

176 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

177 
ngx_cÚf_£t_size_¦Ù
,

178 
NGX_HTTP_LOC_CONF_OFFSET
,

179 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
po¡pÚe_gzpšg
),

180 
NULL
 },

182 { 
ngx_¡ršg
("gzip_no_buffer"),

183 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

184 
ngx_cÚf_£t_æag_¦Ù
,

185 
NGX_HTTP_LOC_CONF_OFFSET
,

186 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
no_bufãr
),

187 
NULL
 },

189 { 
ngx_¡ršg
("gzip_min_length"),

190 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

191 
ngx_cÚf_£t_size_¦Ù
,

192 
NGX_HTTP_LOC_CONF_OFFSET
,

193 
off£tof
(
ngx_h‰p_gz_cÚf_t
, 
mš_Ëngth
),

194 
NULL
 },

196 
ngx_nuÎ_commªd


200 
ngx_h‰p_moduË_t
 
	gngx_h‰p_gz_fž‹r_moduË_ùx
 = {

201 
ngx_h‰p_gz_add_v¬ŸbËs
,

202 
ngx_h‰p_gz_fž‹r_š™
,

204 
NULL
,

205 
NULL
,

207 
NULL
,

208 
NULL
,

210 
ngx_h‰p_gz_ü—‹_cÚf
,

211 
ngx_h‰p_gz_m”ge_cÚf


215 
ngx_moduË_t
 
	gngx_h‰p_gz_fž‹r_moduË
 = {

216 
NGX_MODULE_V1
,

217 &
ngx_h‰p_gz_fž‹r_moduË_ùx
,

218 
ngx_h‰p_gz_fž‹r_commªds
,

219 
NGX_HTTP_MODULE
,

220 
NULL
,

221 
NULL
,

222 
NULL
,

223 
NULL
,

224 
NULL
,

225 
NULL
,

226 
NULL
,

227 
NGX_MODULE_V1_PADDING


231 
ngx_¡r_t
 
	gngx_h‰p_gz_¿tio
 = 
ngx_¡ršg
("gzip_ratio");

233 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

234 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

237 
ngx_št_t


238 
	$ngx_h‰p_gz_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

240 
ngx_bË_–t_t
 *
h
;

241 
ngx_h‰p_gz_ùx_t
 *
ùx
;

242 
ngx_h‰p_gz_cÚf_t
 *
cÚf
;

244 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gz_fž‹r_moduË
);

246 ià(!
cÚf
->
’abË


247 || (
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_OK


248 && 
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_FORBIDDEN


249 && 
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_NOT_FOUND
)

250 || (
r
->
h—d”s_out
.
cÚ‹Á_’codšg


251 && 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
->
v®ue
.
Ën
)

252 || (
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 != -1

253 && 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 < 
cÚf
->
mš_Ëngth
)

254 || 
	`ngx_h‰p_‹¡_cÚ‹Á_ty³
(
r
, &
cÚf
->
ty³s
è=ð
NULL


255 || 
r
->
h—d”_Úly
)

257  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

260 
r
->
gz_v¬y
 = 1;

262 #ià(
NGX_HTTP_DEGRADATION
)

264 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

266 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

268 ià(
þcf
->
gz_di§bË_deg¿d©iÚ
 && 
	`ngx_h‰p_deg¿ded
(
r
)) {

269  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

274 ià(!
r
->
gz_‹¡ed
) {

275 ià(
	`ngx_h‰p_gz_ok
(
r
è!ð
NGX_OK
) {

276  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

279 } ià(!
r
->
gz_ok
) {

280  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

283 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_gz_ùx_t
));

284 ià(
ùx
 =ð
NULL
) {

285  
NGX_ERROR
;

288 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_gz_fž‹r_moduË
);

290 
ùx
->
»que¡
 = 
r
;

291 
ùx
->
bufãršg
 = (
cÚf
->
po¡pÚe_gzpšg
 != 0);

293 
	`ngx_h‰p_gz_fž‹r_memÜy
(
r
, 
ùx
);

295 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

296 ià(
h
 =ð
NULL
) {

297  
NGX_ERROR
;

300 
h
->
hash
 = 1;

301 
	`ngx_¡r_£t
(&
h
->
key
, "Content-Encoding");

302 
	`ngx_¡r_£t
(&
h
->
v®ue
, "gzip");

303 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
 = 
h
;

305 
r
->
maš_fž‹r_Ãed_š_memÜy
 = 1;

307 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
r
);

308 
	`ngx_h‰p_þ—r_acû±_¿nges
(
r
);

309 
	`ngx_h‰p_w—k_‘ag
(
r
);

311  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

312 
	}
}

315 
ngx_št_t


316 
	$ngx_h‰p_gz_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

318 
rc
;

319 
ngx_ušt_t
 
æush
;

320 
ngx_chaš_t
 *
þ
;

321 
ngx_h‰p_gz_ùx_t
 *
ùx
;

323 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_gz_fž‹r_moduË
);

325 ià(
ùx
 =ð
NULL
 || ctx->
dÚe
 || 
r
->
h—d”_Úly
) {

326  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

329 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

332 ià(
ùx
->
bufãršg
) {

343 ià(
š
) {

344 
	`ngx_h‰p_gz_fž‹r_bufãr
(
ùx
, 
š
)) {

346 
NGX_OK
:

347  
NGX_OK
;

349 
NGX_DONE
:

350 
š
 = 
NULL
;

354 
çžed
;

358 
ùx
->
bufãršg
 = 0;

362 ià(
ùx
->
´—Îoÿ‹d
 =ð
NULL
) {

363 ià(
	`ngx_h‰p_gz_fž‹r_deæ©e_¡¬t
(
r
, 
ùx
è!ð
NGX_OK
) {

364 
çžed
;

368 ià(
š
) {

369 ià(
	`ngx_chaš_add_cÝy
(
r
->
poÞ
, &
ùx
->
š
, inè!ð
NGX_OK
) {

370 
çžed
;

373 
r
->
cÚÃùiÚ
->
bufã»d
 |ð
NGX_HTTP_GZIP_BUFFERED
;

376 ià(
ùx
->
nomem
) {

380 ià(
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
NULL
è=ð
NGX_ERROR
) {

381 
çžed
;

384 
þ
 = 
NULL
;

386 
	`ngx_chaš_upd©e_chašs
(
r
->
poÞ
, &
ùx
->
ä“
, &ùx->
busy
, &
þ
,

387 (
ngx_buf_g_t
è&
ngx_h‰p_gz_fž‹r_moduË
);

388 
ùx
->
nomem
 = 0;

389 
æush
 = 0;

392 
æush
 = 
ùx
->
busy
 ? 1 : 0;

403 
rc
 = 
	`ngx_h‰p_gz_fž‹r_add_d©a
(
r
, 
ùx
);

405 ià(
rc
 =ð
NGX_DECLINED
) {

409 ià(
rc
 =ð
NGX_AGAIN
) {

416 
rc
 = 
	`ngx_h‰p_gz_fž‹r_g‘_buf
(
r
, 
ùx
);

418 ià(
rc
 =ð
NGX_DECLINED
) {

422 ià(
rc
 =ð
NGX_ERROR
) {

423 
çžed
;

427 
rc
 = 
	`ngx_h‰p_gz_fž‹r_deæ©e
(
r
, 
ùx
);

429 ià(
rc
 =ð
NGX_OK
) {

433 ià(
rc
 =ð
NGX_ERROR
) {

434 
çžed
;

440 ià(
ùx
->
out
 =ð
NULL
 && !
æush
) {

441 
	`ngx_h‰p_gz_fž‹r_ä“_cÝy_buf
(
r
, 
ùx
);

443  
ùx
->
busy
 ? 
NGX_AGAIN
 : 
NGX_OK
;

446 ià(!
ùx
->
gzh—d”
) {

447 ià(
	`ngx_h‰p_gz_fž‹r_gzh—d”
(
r
, 
ùx
è!ð
NGX_OK
) {

448 
çžed
;

452 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
ùx
->
out
);

454 ià(
rc
 =ð
NGX_ERROR
) {

455 
çžed
;

458 
	`ngx_h‰p_gz_fž‹r_ä“_cÝy_buf
(
r
, 
ùx
);

460 
	`ngx_chaš_upd©e_chašs
(
r
->
poÞ
, &
ùx
->
ä“
, &ùx->
busy
, &ùx->
out
,

461 (
ngx_buf_g_t
è&
ngx_h‰p_gz_fž‹r_moduË
);

462 
ùx
->
Ï¡_out
 = &ùx->
out
;

464 
ùx
->
nomem
 = 0;

465 
æush
 = 0;

467 ià(
ùx
->
dÚe
) {

468  
rc
;

474 
çžed
:

476 
ùx
->
dÚe
 = 1;

478 ià(
ùx
->
´—Îoÿ‹d
) {

479 
	`deæ©eEnd
(&
ùx
->
z¡»am
);

481 
	`ngx_pä“
(
r
->
poÞ
, 
ùx
->
´—Îoÿ‹d
);

484 
	`ngx_h‰p_gz_fž‹r_ä“_cÝy_buf
(
r
, 
ùx
);

486  
NGX_ERROR
;

487 
	}
}

491 
	$ngx_h‰p_gz_fž‹r_memÜy
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_gz_ùx_t
 *
ùx
)

493 
wb™s
, 
memËv–
;

494 
ngx_h‰p_gz_cÚf_t
 *
cÚf
;

496 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gz_fž‹r_moduË
);

498 
wb™s
 = 
cÚf
->wbits;

499 
memËv–
 = 
cÚf
->memlevel;

501 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 > 0) {

505 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 < ((1 << (
wb™s
 - 1)) - 262)) {

506 
wb™s
--;

507 
memËv–
--;

510 ià(
memËv–
 < 1) {

511 
memËv–
 = 1;

515 
ùx
->
wb™s
 = wbits;

516 
ùx
->
memËv–
 = memlevel;

530 
ùx
->
®loÿ‹d
 = 8192 + (1 << (
wb™s
 + 2)è+ (1 << (
memËv–
 + 9));

531 
	}
}

534 
ngx_št_t


535 
	$ngx_h‰p_gz_fž‹r_bufãr
(
ngx_h‰p_gz_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
)

537 
size_t
 
size
, 
bufã»d
;

538 
ngx_buf_t
 *
b
, *
buf
;

539 
ngx_chaš_t
 *
þ
, **
Î
;

540 
ngx_h‰p_»que¡_t
 *
r
;

541 
ngx_h‰p_gz_cÚf_t
 *
cÚf
;

543 
r
 = 
ùx
->
»que¡
;

545 
r
->
cÚÃùiÚ
->
bufã»d
 |ð
NGX_HTTP_GZIP_BUFFERED
;

547 
bufã»d
 = 0;

548 
Î
 = &
ùx
->
š
;

550 
þ
 = 
ùx
->
š
; cl; cÈðþ->
Ãxt
) {

551 
bufã»d
 +ð
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

552 
Î
 = &
þ
->
Ãxt
;

555 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gz_fž‹r_moduË
);

557 
š
) {

558 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

559 ià(
þ
 =ð
NULL
) {

560  
NGX_ERROR
;

563 
b
 = 
š
->
buf
;

565 
size
 = 
b
->
Ï¡
 - b->
pos
;

566 
bufã»d
 +ð
size
;

568 ià(
b
->
æush
 || b->
Ï¡_buf
 || 
bufã»d
 > 
cÚf
->
po¡pÚe_gzpšg
) {

569 
ùx
->
bufãršg
 = 0;

572 ià(
ùx
->
bufãršg
 && 
size
) {

574 
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
size
);

575 ià(
buf
 =ð
NULL
) {

576  
NGX_ERROR
;

579 
buf
->
Ï¡
 = 
	`ngx_ýymem
(buf->
pos
, 
b
->pos, 
size
);

580 
b
->
pos
 = b->
Ï¡
;

582 
buf
->
Ï¡_buf
 = 
b
->last_buf;

583 
buf
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_gz_fž‹r_moduË
;

585 
þ
->
buf
 = buf;

588 
þ
->
buf
 = 
b
;

591 *
Î
 = 
þ
;

592 
Î
 = &
þ
->
Ãxt
;

593 
š
 = in->
Ãxt
;

596 *
Î
 = 
NULL
;

598  
ùx
->
bufãršg
 ? 
NGX_OK
 : 
NGX_DONE
;

599 
	}
}

602 
ngx_št_t


603 
	$ngx_h‰p_gz_fž‹r_deæ©e_¡¬t
(
ngx_h‰p_»que¡_t
 *
r
,

604 
ngx_h‰p_gz_ùx_t
 *
ùx
)

606 
rc
;

607 
ngx_h‰p_gz_cÚf_t
 *
cÚf
;

609 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gz_fž‹r_moduË
);

611 
ùx
->
´—Îoÿ‹d
 = 
	`ngx_·Îoc
(
r
->
poÞ
, ctx->
®loÿ‹d
);

612 ià(
ùx
->
´—Îoÿ‹d
 =ð
NULL
) {

613  
NGX_ERROR
;

616 
ùx
->
ä“_mem
 = ctx->
´—Îoÿ‹d
;

618 
ùx
->
z¡»am
.
z®loc
 = 
ngx_h‰p_gz_fž‹r_®loc
;

619 
ùx
->
z¡»am
.
zä“
 = 
ngx_h‰p_gz_fž‹r_ä“
;

620 
ùx
->
z¡»am
.
Ýaque
 = ctx;

622 
rc
 = 
	`deæ©eIn™2
(&
ùx
->
z¡»am
, (è
cÚf
->
Ëv–
, 
Z_DEFLATED
,

623 - 
ùx
->
wb™s
, ctx->
memËv–
, 
Z_DEFAULT_STRATEGY
);

625 ià(
rc
 !ð
Z_OK
) {

626 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

627 "deæ©eIn™2(èçžed: %d", 
rc
);

628  
NGX_ERROR
;

631 
ùx
->
Ï¡_out
 = &ùx->
out
;

632 
ùx
->
üc32
 = 
	`üc32
(0L, 
Z_NULL
, 0);

633 
ùx
->
æush
 = 
Z_NO_FLUSH
;

635  
NGX_OK
;

636 
	}
}

639 
ngx_št_t


640 
	$ngx_h‰p_gz_fž‹r_gzh—d”
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_gz_ùx_t
 *
ùx
)

642 
ngx_buf_t
 *
b
;

643 
ngx_chaš_t
 *
þ
;

644 
u_ch¬
 
gzh—d”
[10] =

645 { 0x1f, 0x8b, 
Z_DEFLATED
, 0, 0, 0, 0, 0, 0, 3 };

647 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

648 ià(
b
 =ð
NULL
) {

649  
NGX_ERROR
;

652 
b
->
memÜy
 = 1;

653 
b
->
pos
 = 
gzh—d”
;

654 
b
->
Ï¡
 = b->
pos
 + 10;

656 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

657 ià(
þ
 =ð
NULL
) {

658  
NGX_ERROR
;

661 
þ
->
buf
 = 
b
;

662 
þ
->
Ãxt
 = 
ùx
->
out
;

663 
ùx
->
out
 = 
þ
;

665 
ùx
->
gzh—d”
 = 1;

667  
NGX_OK
;

668 
	}
}

671 
ngx_št_t


672 
	$ngx_h‰p_gz_fž‹r_add_d©a
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_gz_ùx_t
 *
ùx
)

674 ià(
ùx
->
z¡»am
.
avaž_š
 || ctx->
æush
 !ð
Z_NO_FLUSH
 || ctx->
»do
) {

675  
NGX_OK
;

678 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

679 "gz in: %p", 
ùx
->
š
);

681 ià(
ùx
->
š
 =ð
NULL
) {

682  
NGX_DECLINED
;

685 ià(
ùx
->
cÝy_buf
) {

692 
ùx
->
cÝy_buf
->
Ãxt
 = ctx->
cÝ›d
;

693 
ùx
->
cÝ›d
 = ctx->
cÝy_buf
;

694 
ùx
->
cÝy_buf
 = 
NULL
;

697 
ùx
->
š_buf
 = ctx->
š
->
buf
;

699 ià(
ùx
->
š_buf
->
g
 =ð(
ngx_buf_g_t
è&
ngx_h‰p_gz_fž‹r_moduË
) {

700 
ùx
->
cÝy_buf
 = ctx->
š
;

703 
ùx
->
š
 = ctx->š->
Ãxt
;

705 
ùx
->
z¡»am
.
Ãxt_š
 = ctx->
š_buf
->
pos
;

706 
ùx
->
z¡»am
.
avaž_š
 = ctx->
š_buf
->
Ï¡
 - ctx->š_buf->
pos
;

708 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

710 
ùx
->
š_buf
,

711 
ùx
->
z¡»am
.
Ãxt_š
, ctx->z¡»am.
avaž_š
);

713 ià(
ùx
->
š_buf
->
Ï¡_buf
) {

714 
ùx
->
æush
 = 
Z_FINISH
;

716 } ià(
ùx
->
š_buf
->
æush
) {

717 
ùx
->
æush
 = 
Z_SYNC_FLUSH
;

720 ià(
ùx
->
z¡»am
.
avaž_š
) {

722 
ùx
->
üc32
 = 
	`üc32
(ùx->üc32, ctx->
z¡»am
.
Ãxt_š
,

723 
ùx
->
z¡»am
.
avaž_š
);

725 } ià(
ùx
->
æush
 =ð
Z_NO_FLUSH
) {

726  
NGX_AGAIN
;

729  
NGX_OK
;

730 
	}
}

733 
ngx_št_t


734 
	$ngx_h‰p_gz_fž‹r_g‘_buf
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_gz_ùx_t
 *
ùx
)

736 
ngx_h‰p_gz_cÚf_t
 *
cÚf
;

738 ià(
ùx
->
z¡»am
.
avaž_out
) {

739  
NGX_OK
;

742 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gz_fž‹r_moduË
);

744 ià(
ùx
->
ä“
) {

745 
ùx
->
out_buf
 = ctx->
ä“
->
buf
;

746 
ùx
->
ä“
 = ctx->ä“->
Ãxt
;

748 } ià(
ùx
->
bufs
 < 
cÚf
->bufs.
num
) {

750 
ùx
->
out_buf
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
cÚf
->
bufs
.
size
);

751 ià(
ùx
->
out_buf
 =ð
NULL
) {

752  
NGX_ERROR
;

755 
ùx
->
out_buf
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_gz_fž‹r_moduË
;

756 
ùx
->
out_buf
->
»cyþed
 = 1;

757 
ùx
->
bufs
++;

760 
ùx
->
nomem
 = 1;

761  
NGX_DECLINED
;

764 
ùx
->
z¡»am
.
Ãxt_out
 = ctx->
out_buf
->
pos
;

765 
ùx
->
z¡»am
.
avaž_out
 = 
cÚf
->
bufs
.
size
;

767  
NGX_OK
;

768 
	}
}

771 
ngx_št_t


772 
	$ngx_h‰p_gz_fž‹r_deæ©e
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_gz_ùx_t
 *
ùx
)

774 
rc
;

775 
ngx_buf_t
 *
b
;

776 
ngx_chaš_t
 *
þ
;

777 
ngx_h‰p_gz_cÚf_t
 *
cÚf
;

779 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

781 
ùx
->
z¡»am
.
Ãxt_š
, ctx->z¡»am.
Ãxt_out
,

782 
ùx
->
z¡»am
.
avaž_š
, ctx->z¡»am.
avaž_out
,

783 
ùx
->
æush
, ctx->
»do
);

785 
rc
 = 
	`deæ©e
(&
ùx
->
z¡»am
, ctx->
æush
);

787 ià(
rc
 !ð
Z_OK
 &&„ø!ð
Z_STREAM_END
 &&„ø!ð
Z_BUF_ERROR
) {

788 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

789 "deæ©e(èçžed: %d, %d", 
ùx
->
æush
, 
rc
);

790  
NGX_ERROR
;

793 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

795 
ùx
->
z¡»am
.
Ãxt_š
, ctx->z¡»am.
Ãxt_out
,

796 
ùx
->
z¡»am
.
avaž_š
, ctx->z¡»am.
avaž_out
,

797 
rc
);

799 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

801 
ùx
->
š_buf
, ctx->š_buf->
pos
);

803 ià(
ùx
->
z¡»am
.
Ãxt_š
) {

804 
ùx
->
š_buf
->
pos
 = ctx->
z¡»am
.
Ãxt_š
;

806 ià(
ùx
->
z¡»am
.
avaž_š
 == 0) {

807 
ùx
->
z¡»am
.
Ãxt_š
 = 
NULL
;

811 
ùx
->
out_buf
->
Ï¡
 = ctx->
z¡»am
.
Ãxt_out
;

813 ià(
ùx
->
z¡»am
.
avaž_out
 == 0) {

817 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

818 ià(
þ
 =ð
NULL
) {

819  
NGX_ERROR
;

822 
þ
->
buf
 = 
ùx
->
out_buf
;

823 
þ
->
Ãxt
 = 
NULL
;

824 *
ùx
->
Ï¡_out
 = 
þ
;

825 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

827 
ùx
->
»do
 = 1;

829  
NGX_AGAIN
;

832 
ùx
->
»do
 = 0;

834 ià(
ùx
->
æush
 =ð
Z_SYNC_FLUSH
) {

836 
ùx
->
æush
 = 
Z_NO_FLUSH
;

838 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

839 ià(
þ
 =ð
NULL
) {

840  
NGX_ERROR
;

843 
b
 = 
ùx
->
out_buf
;

845 ià(
	`ngx_buf_size
(
b
) == 0) {

847 
b
 = 
	`ngx_ÿÎoc_buf
(
ùx
->
»que¡
->
poÞ
);

848 ià(
b
 =ð
NULL
) {

849  
NGX_ERROR
;

853 
ùx
->
z¡»am
.
avaž_out
 = 0;

856 
b
->
æush
 = 1;

858 
þ
->
buf
 = 
b
;

859 
þ
->
Ãxt
 = 
NULL
;

860 *
ùx
->
Ï¡_out
 = 
þ
;

861 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

863 
r
->
cÚÃùiÚ
->
bufã»d
 &ð~
NGX_HTTP_GZIP_BUFFERED
;

865  
NGX_OK
;

868 ià(
rc
 =ð
Z_STREAM_END
) {

870 ià(
	`ngx_h‰p_gz_fž‹r_deæ©e_’d
(
r
, 
ùx
è!ð
NGX_OK
) {

871  
NGX_ERROR
;

874  
NGX_OK
;

877 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gz_fž‹r_moduË
);

879 ià(
cÚf
->
no_bufãr
 && 
ùx
->
š
 =ð
NULL
) {

881 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

882 ià(
þ
 =ð
NULL
) {

883  
NGX_ERROR
;

886 
þ
->
buf
 = 
ùx
->
out_buf
;

887 
þ
->
Ãxt
 = 
NULL
;

888 *
ùx
->
Ï¡_out
 = 
þ
;

889 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

891  
NGX_OK
;

894  
NGX_AGAIN
;

895 
	}
}

898 
ngx_št_t


899 
	$ngx_h‰p_gz_fž‹r_deæ©e_’d
(
ngx_h‰p_»que¡_t
 *
r
,

900 
ngx_h‰p_gz_ùx_t
 *
ùx
)

902 
rc
;

903 
ngx_buf_t
 *
b
;

904 
ngx_chaš_t
 *
þ
;

905 
gzŒaž”
 *
Œaž”
;

907 
ùx
->
zš
 = ctx->
z¡»am
.
tÙ®_š
;

908 
ùx
->
zout
 = 10 + ctx->
z¡»am
.
tÙ®_out
 + 8;

910 
rc
 = 
	`deæ©eEnd
(&
ùx
->
z¡»am
);

912 ià(
rc
 !ð
Z_OK
) {

913 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

914 "deæ©eEnd(èçžed: %d", 
rc
);

915  
NGX_ERROR
;

918 
	`ngx_pä“
(
r
->
poÞ
, 
ùx
->
´—Îoÿ‹d
);

920 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

921 ià(
þ
 =ð
NULL
) {

922  
NGX_ERROR
;

925 
þ
->
buf
 = 
ùx
->
out_buf
;

926 
þ
->
Ãxt
 = 
NULL
;

927 *
ùx
->
Ï¡_out
 = 
þ
;

928 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

930 ià(
ùx
->
z¡»am
.
avaž_out
 >= 8) {

931 
Œaž”
 = (
gzŒaž”
 *è
ùx
->
out_buf
->
Ï¡
;

932 
ùx
->
out_buf
->
Ï¡
 += 8;

933 
ùx
->
out_buf
->
Ï¡_buf
 = 1;

936 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 8);

937 ià(
b
 =ð
NULL
) {

938  
NGX_ERROR
;

941 
b
->
Ï¡_buf
 = 1;

943 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

944 ià(
þ
 =ð
NULL
) {

945  
NGX_ERROR
;

948 
þ
->
buf
 = 
b
;

949 
þ
->
Ãxt
 = 
NULL
;

950 *
ùx
->
Ï¡_out
 = 
þ
;

951 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

952 
Œaž”
 = (
gzŒaž”
 *è
b
->
pos
;

953 
b
->
Ï¡
 += 8;

956 #ià(
NGX_HAVE_LITTLE_ENDIAN
 && 
NGX_HAVE_NONALIGNED
)

958 
Œaž”
->
üc32
 = 
ùx
->crc32;

959 
Œaž”
->
zËn
 = 
ùx
->
zš
;

963 
Œaž”
->
üc32
[0] = (
u_ch¬
è(
ùx
->crc32 & 0xff);

964 
Œaž”
->
üc32
[1] = (
u_ch¬
è((
ùx
->crc32 >> 8) & 0xff);

965 
Œaž”
->
üc32
[2] = (
u_ch¬
è((
ùx
->crc32 >> 16) & 0xff);

966 
Œaž”
->
üc32
[3] = (
u_ch¬
è((
ùx
->crc32 >> 24) & 0xff);

968 
Œaž”
->
zËn
[0] = (
u_ch¬
è(
ùx
->
zš
 & 0xff);

969 
Œaž”
->
zËn
[1] = (
u_ch¬
è((
ùx
->
zš
 >> 8) & 0xff);

970 
Œaž”
->
zËn
[2] = (
u_ch¬
è((
ùx
->
zš
 >> 16) & 0xff);

971 
Œaž”
->
zËn
[3] = (
u_ch¬
è((
ùx
->
zš
 >> 24) & 0xff);

975 
ùx
->
z¡»am
.
avaž_š
 = 0;

976 
ùx
->
z¡»am
.
avaž_out
 = 0;

978 
ùx
->
dÚe
 = 1;

980 
r
->
cÚÃùiÚ
->
bufã»d
 &ð~
NGX_HTTP_GZIP_BUFFERED
;

982  
NGX_OK
;

983 
	}
}

987 
	$ngx_h‰p_gz_fž‹r_®loc
(*
Ýaque
, 
u_št
 
™ems
, u_šˆ
size
)

989 
ngx_h‰p_gz_ùx_t
 *
ùx
 = 
Ýaque
;

991 *
p
;

992 
ngx_ušt_t
 
®loc
;

994 
®loc
 = 
™ems
 * 
size
;

996 ià(
®loc
 % 512 != 0 &&‡lloc < 8192) {

1003 
®loc
 = 8192;

1006 ià(
®loc
 <ð
ùx
->
®loÿ‹d
) {

1007 
p
 = 
ùx
->
ä“_mem
;

1008 
ùx
->
ä“_mem
 +ð
®loc
;

1009 
ùx
->
®loÿ‹d
 -ð
®loc
;

1011 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1013 
™ems
, 
size
, 
®loc
, 
p
);

1015  
p
;

1018 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1020 
™ems
 * 
size
, 
ùx
->
®loÿ‹d
);

1022 
p
 = 
	`ngx_·Îoc
(
ùx
->
»que¡
->
poÞ
, 
™ems
 * 
size
);

1024  
p
;

1025 
	}
}

1029 
	$ngx_h‰p_gz_fž‹r_ä“
(*
Ýaque
, *
add»ss
)

1032 
ngx_h‰p_gz_ùx_t
 *
ùx
 = 
Ýaque
;

1034 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1035 "gz f»e: %p", 
add»ss
);

1037 
	}
}

1041 
	$ngx_h‰p_gz_fž‹r_ä“_cÝy_buf
(
ngx_h‰p_»que¡_t
 *
r
,

1042 
ngx_h‰p_gz_ùx_t
 *
ùx
)

1044 
ngx_chaš_t
 *
þ
;

1046 
þ
 = 
ùx
->
cÝ›d
; cl; cÈðþ->
Ãxt
) {

1047 
	`ngx_pä“
(
r
->
poÞ
, 
þ
->
buf
->
¡¬t
);

1050 
ùx
->
cÝ›d
 = 
NULL
;

1051 
	}
}

1054 
ngx_št_t


1055 
	$ngx_h‰p_gz_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

1057 
ngx_h‰p_v¬ŸbË_t
 *
v¬
;

1059 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
ngx_h‰p_gz_¿tio
, 
NGX_HTTP_VAR_NOHASH
);

1060 ià(
v¬
 =ð
NULL
) {

1061  
NGX_ERROR
;

1064 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_gz_¿tio_v¬ŸbË
;

1066  
NGX_OK
;

1067 
	}
}

1070 
ngx_št_t


1071 
	$ngx_h‰p_gz_¿tio_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

1072 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1074 
ngx_ušt_t
 
zšt
, 
zäac
;

1075 
ngx_h‰p_gz_ùx_t
 *
ùx
;

1077 
v
->
v®id
 = 1;

1078 
v
->
no_ÿch—bË
 = 0;

1079 
v
->
nÙ_found
 = 0;

1081 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_gz_fž‹r_moduË
);

1083 ià(
ùx
 =ð
NULL
 || ctx->
zout
 == 0) {

1084 
v
->
nÙ_found
 = 1;

1085  
NGX_OK
;

1088 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_INT32_LEN
 + 3);

1089 ià(
v
->
d©a
 =ð
NULL
) {

1090  
NGX_ERROR
;

1093 
zšt
 = (
ngx_ušt_t
è(
ùx
->
zš
 / ctx->
zout
);

1094 
zäac
 = (
ngx_ušt_t
è((
ùx
->
zš
 * 100 / ctx->
zout
) % 100);

1096 ià((
ùx
->
zš
 * 1000 / ctx->
zout
) % 10 > 4) {

1100 
zäac
++;

1102 ià(
zäac
 > 99) {

1103 
zšt
++;

1104 
zäac
 = 0;

1108 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%ui.%02ui", 
zšt
, 
zäac
) - v->data;

1110  
NGX_OK
;

1111 
	}
}

1115 
	$ngx_h‰p_gz_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

1117 
ngx_h‰p_gz_cÚf_t
 *
cÚf
;

1119 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_gz_cÚf_t
));

1120 ià(
cÚf
 =ð
NULL
) {

1121  
NULL
;

1132 
cÚf
->
’abË
 = 
NGX_CONF_UNSET
;

1133 
cÚf
->
no_bufãr
 = 
NGX_CONF_UNSET
;

1135 
cÚf
->
po¡pÚe_gzpšg
 = 
NGX_CONF_UNSET_SIZE
;

1136 
cÚf
->
Ëv–
 = 
NGX_CONF_UNSET
;

1137 
cÚf
->
wb™s
 = 
NGX_CONF_UNSET_SIZE
;

1138 
cÚf
->
memËv–
 = 
NGX_CONF_UNSET_SIZE
;

1139 
cÚf
->
mš_Ëngth
 = 
NGX_CONF_UNSET
;

1141  
cÚf
;

1142 
	}
}

1146 
	$ngx_h‰p_gz_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1148 
ngx_h‰p_gz_cÚf_t
 *
´ev
 = 
·»Á
;

1149 
ngx_h‰p_gz_cÚf_t
 *
cÚf
 = 
chžd
;

1151 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

1152 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
no_bufãr
, 
´ev
->no_buffer, 0);

1154 
	`ngx_cÚf_m”ge_bufs_v®ue
(
cÚf
->
bufs
, 
´ev
->bufs,

1155 (128 * 1024è/ 
ngx_·gesize
,‚gx_pagesize);

1157 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
po¡pÚe_gzpšg
, 
´ev
->postpone_gzipping,

1159 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
Ëv–
, 
´ev
->level, 1);

1160 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
wb™s
, 
´ev
->wb™s, 
MAX_WBITS
);

1161 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
memËv–
, 
´ev
->memlevel,

1162 
MAX_MEM_LEVEL
 - 1);

1163 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
mš_Ëngth
, 
´ev
->min_length, 20);

1165 ià(
	`ngx_h‰p_m”ge_ty³s
(
cf
, &
cÚf
->
ty³s_keys
, &cÚf->
ty³s
,

1166 &
´ev
->
ty³s_keys
, &´ev->
ty³s
,

1167 
ngx_h‰p_html_deçuÉ_ty³s
)

1168 !ð
NGX_OK
)

1170  
NGX_CONF_ERROR
;

1173  
NGX_CONF_OK
;

1174 
	}
}

1177 
ngx_št_t


1178 
	$ngx_h‰p_gz_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

1180 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

1181 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_gz_h—d”_fž‹r
;

1183 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

1184 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_gz_body_fž‹r
;

1186  
NGX_OK
;

1187 
	}
}

1191 
	$ngx_h‰p_gz_wšdow
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

1193 
size_t
 *
Å
 = 
d©a
;

1195 
size_t
 
wb™s
, 
wsize
;

1197 
wb™s
 = 15;

1199 
wsize
 = 32 * 1024; wsize > 256; wsize >>= 1) {

1201 ià(
wsize
 =ð*
Å
) {

1202 *
Å
 = 
wb™s
;

1204  
NGX_CONF_OK
;

1207 
wb™s
--;

1211 
	}
}

1215 
	$ngx_h‰p_gz_hash
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

1217 
size_t
 *
Å
 = 
d©a
;

1219 
size_t
 
memËv–
, 
hsize
;

1221 
memËv–
 = 9;

1223 
hsize
 = 128 * 1024; hsize > 256; hsize >>= 1) {

1225 ià(
hsize
 =ð*
Å
) {

1226 *
Å
 = 
memËv–
;

1228  
NGX_CONF_OK
;

1231 
memËv–
--;

1235 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_gzip_static_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
	#NGX_HTTP_GZIP_STATIC_OFF
 0

	)

14 
	#NGX_HTTP_GZIP_STATIC_ON
 1

	)

15 
	#NGX_HTTP_GZIP_STATIC_ALWAYS
 2

	)

19 
ngx_ušt_t
 
	m’abË
;

20 } 
	tngx_h‰p_gz_¡©ic_cÚf_t
;

23 
ngx_št_t
 
ngx_h‰p_gz_¡©ic_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

24 *
ngx_h‰p_gz_¡©ic_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

25 *
ngx_h‰p_gz_¡©ic_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

26 *
chžd
);

27 
ngx_št_t
 
ngx_h‰p_gz_¡©ic_š™
(
ngx_cÚf_t
 *
cf
);

30 
ngx_cÚf_’um_t
 
	gngx_h‰p_gz_¡©ic
[] = {

31 { 
ngx_¡ršg
("off"), 
NGX_HTTP_GZIP_STATIC_OFF
 },

32 { 
ngx_¡ršg
("Ú"), 
NGX_HTTP_GZIP_STATIC_ON
 },

33 { 
ngx_¡ršg
("®ways"), 
NGX_HTTP_GZIP_STATIC_ALWAYS
 },

34 { 
ngx_nuÎ_¡ršg
, 0 }

38 
ngx_commªd_t
 
	gngx_h‰p_gz_¡©ic_commªds
[] = {

40 { 
ngx_¡ršg
("gzip_static"),

41 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

42 
ngx_cÚf_£t_’um_¦Ù
,

43 
NGX_HTTP_LOC_CONF_OFFSET
,

44 
off£tof
(
ngx_h‰p_gz_¡©ic_cÚf_t
, 
’abË
),

45 &
ngx_h‰p_gz_¡©ic
 },

47 
ngx_nuÎ_commªd


51 
ngx_h‰p_moduË_t
 
	gngx_h‰p_gz_¡©ic_moduË_ùx
 = {

52 
NULL
,

53 
ngx_h‰p_gz_¡©ic_š™
,

55 
NULL
,

56 
NULL
,

58 
NULL
,

59 
NULL
,

61 
ngx_h‰p_gz_¡©ic_ü—‹_cÚf
,

62 
ngx_h‰p_gz_¡©ic_m”ge_cÚf


66 
ngx_moduË_t
 
	gngx_h‰p_gz_¡©ic_moduË
 = {

67 
NGX_MODULE_V1
,

68 &
ngx_h‰p_gz_¡©ic_moduË_ùx
,

69 
ngx_h‰p_gz_¡©ic_commªds
,

70 
NGX_HTTP_MODULE
,

71 
NULL
,

72 
NULL
,

73 
NULL
,

74 
NULL
,

75 
NULL
,

76 
NULL
,

77 
NULL
,

78 
NGX_MODULE_V1_PADDING


82 
ngx_št_t


83 
	$ngx_h‰p_gz_¡©ic_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

85 
u_ch¬
 *
p
;

86 
size_t
 
roÙ
;

87 
ngx_¡r_t
 
·th
;

88 
ngx_št_t
 
rc
;

89 
ngx_ušt_t
 
Ëv–
;

90 
ngx_log_t
 *
log
;

91 
ngx_buf_t
 *
b
;

92 
ngx_chaš_t
 
out
;

93 
ngx_bË_–t_t
 *
h
;

94 
ngx_Ý’_fže_šfo_t
 
of
;

95 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

96 
ngx_h‰p_gz_¡©ic_cÚf_t
 *
gzcf
;

98 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
))) {

99  
NGX_DECLINED
;

102 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] == '/') {

103  
NGX_DECLINED
;

106 
gzcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_gz_¡©ic_moduË
);

108 ià(
gzcf
->
’abË
 =ð
NGX_HTTP_GZIP_STATIC_OFF
) {

109  
NGX_DECLINED
;

112 ià(
gzcf
->
’abË
 =ð
NGX_HTTP_GZIP_STATIC_ON
) {

113 
rc
 = 
	`ngx_h‰p_gz_ok
(
r
);

117 
rc
 = 
NGX_OK
;

120 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

122 ià(!
þcf
->
gz_v¬y
 && 
rc
 !ð
NGX_OK
) {

123  
NGX_DECLINED
;

126 
log
 = 
r
->
cÚÃùiÚ
->log;

128 
p
 = 
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, (".gz") - 1);

129 ià(
p
 =ð
NULL
) {

130  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

133 *
p
++ = '.';

134 *
p
++ = 'g';

135 *
p
++ = 'z';

136 *
p
 = '\0';

138 
·th
.
Ën
 = 
p
 -…©h.
d©a
;

140 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0,

141 "h‰°fž’ame: \"%s\"", 
·th
.
d©a
);

143 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

145 
of
.
»ad_ah—d
 = 
þcf
->read_ahead;

146 
of
.
dœeùio
 = 
þcf
->directio;

147 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

148 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

149 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

150 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

152 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
·th
, &
of
è!ð
NGX_OK
) {

153  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

156 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
·th
, &
of
, 
r
->
poÞ
)

157 !ð
NGX_OK
)

159 
of
.
”r
) {

162  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

164 
NGX_ENOENT
:

165 
NGX_ENOTDIR
:

166 
NGX_ENAMETOOLONG
:

168  
NGX_DECLINED
;

170 
NGX_EACCES
:

171 #ià(
NGX_HAVE_OPENAT
)

172 
NGX_EMLINK
:

173 
NGX_ELOOP
:

176 
Ëv–
 = 
NGX_LOG_ERR
;

181 
Ëv–
 = 
NGX_LOG_CRIT
;

185 
	`ngx_log_”rÜ
(
Ëv–
, 
log
, 
of
.
”r
,

186 "% \"%s\" fažed", 
of
.
çžed
, 
·th
.
d©a
);

188  
NGX_DECLINED
;

191 ià(
gzcf
->
’abË
 =ð
NGX_HTTP_GZIP_STATIC_ON
) {

192 
r
->
gz_v¬y
 = 1;

194 ià(
rc
 !ð
NGX_OK
) {

195  
NGX_DECLINED
;

199 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0, "h‰°¡©iøfd: %d", 
of
.
fd
);

201 ià(
of
.
is_dœ
) {

202 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0, "http dir");

203  
NGX_DECLINED
;

206 #ià!(
NGX_WIN32
)

208 ià(!
of
.
is_fže
) {

209 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
log
, 0,

210 "\"%s\" i nÙ‡„eguÏ¸fže", 
·th
.
d©a
);

212  
NGX_HTTP_NOT_FOUND
;

217 
r
->
roÙ_‹¡ed
 = !r->
”rÜ_·ge
;

219 
rc
 = 
	`ngx_h‰p_disÿrd_»que¡_body
(
r
);

221 ià(
rc
 !ð
NGX_OK
) {

222  
rc
;

225 
log
->
aùiÚ
 = "sending„esponseo client";

227 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_OK
;

228 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
of
.
size
;

229 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = 
of
.
mtime
;

231 ià(
	`ngx_h‰p_£t_‘ag
(
r
è!ð
NGX_OK
) {

232  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

235 ià(
	`ngx_h‰p_£t_cÚ‹Á_ty³
(
r
è!ð
NGX_OK
) {

236  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

239 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

240 ià(
h
 =ð
NULL
) {

241  
NGX_ERROR
;

244 
h
->
hash
 = 1;

245 
	`ngx_¡r_£t
(&
h
->
key
, "Content-Encoding");

246 
	`ngx_¡r_£t
(&
h
->
v®ue
, "gzip");

247 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
 = 
h
;

251 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

252 ià(
b
 =ð
NULL
) {

253  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

256 
b
->
fže
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_fže_t
));

257 ià(
b
->
fže
 =ð
NULL
) {

258  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

261 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

263 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

264  
rc
;

267 
b
->
fže_pos
 = 0;

268 
b
->
fže_Ï¡
 = 
of
.
size
;

270 
b
->
š_fže
 = b->
fže_Ï¡
 ? 1 : 0;

271 
b
->
Ï¡_buf
 = (
r
 =ðr->
maš
) ? 1 : 0;

272 
b
->
Ï¡_š_chaš
 = 1;

274 
b
->
fže
->
fd
 = 
of
.fd;

275 
b
->
fže
->
Çme
 = 
·th
;

276 
b
->
fže
->
log
 =†og;

277 
b
->
fže
->
dœeùio
 = 
of
.
is_dœeùio
;

279 
out
.
buf
 = 
b
;

280 
out
.
Ãxt
 = 
NULL
;

282  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

283 
	}
}

287 
	$ngx_h‰p_gz_¡©ic_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

289 
ngx_h‰p_gz_¡©ic_cÚf_t
 *
cÚf
;

291 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_gz_¡©ic_cÚf_t
));

292 ià(
cÚf
 =ð
NULL
) {

293  
NULL
;

296 
cÚf
->
’abË
 = 
NGX_CONF_UNSET_UINT
;

298  
cÚf
;

299 
	}
}

303 
	$ngx_h‰p_gz_¡©ic_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

305 
ngx_h‰p_gz_¡©ic_cÚf_t
 *
´ev
 = 
·»Á
;

306 
ngx_h‰p_gz_¡©ic_cÚf_t
 *
cÚf
 = 
chžd
;

308 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
’abË
, 
´ev
->enable,

309 
NGX_HTTP_GZIP_STATIC_OFF
);

311  
NGX_CONF_OK
;

312 
	}
}

315 
ngx_št_t


316 
	$ngx_h‰p_gz_¡©ic_š™
(
ngx_cÚf_t
 *
cf
)

318 
ngx_h‰p_hªdËr_±
 *
h
;

319 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

321 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

323 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_CONTENT_PHASE
].
hªdËrs
);

324 ià(
h
 =ð
NULL
) {

325  
NGX_ERROR
;

328 *
h
 = 
ngx_h‰p_gz_¡©ic_hªdËr
;

330  
NGX_OK
;

331 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_headers_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_h‰p_h—d”_v®_s
 
	tngx_h‰p_h—d”_v®_t
;

15 
	$ngx_št_t
 (*
	tngx_h‰p_£t_h—d”_±
)(
	tngx_h‰p_»que¡_t
 *
	tr
,

16 
	tngx_h‰p_h—d”_v®_t
 *
	thv
, 
	tngx_¡r_t
 *
	tv®ue
);

20 
ngx_¡r_t
 
Çme
;

21 
ngx_ušt_t
 
off£t
;

22 
ngx_h‰p_£t_h—d”_±
 
hªdËr
;

23 } 
	tngx_h‰p_£t_h—d”_t
;

26 
	sngx_h‰p_h—d”_v®_s
 {

27 
ngx_h‰p_com¶ex_v®ue_t
 
v®ue
;

28 
ngx_¡r_t
 
key
;

29 
ngx_h‰p_£t_h—d”_±
 
hªdËr
;

30 
ngx_ušt_t
 
off£t
;

31 
ngx_ušt_t
 
®ways
;

36 
NGX_HTTP_EXPIRES_OFF
,

37 
NGX_HTTP_EXPIRES_EPOCH
,

38 
NGX_HTTP_EXPIRES_MAX
,

39 
NGX_HTTP_EXPIRES_ACCESS
,

40 
NGX_HTTP_EXPIRES_MODIFIED
,

41 
NGX_HTTP_EXPIRES_DAILY
,

42 
NGX_HTTP_EXPIRES_UNSET


43 } 
	tngx_h‰p_expœes_t
;

47 
ngx_h‰p_expœes_t
 
expœes
;

48 
time_t
 
expœes_time
;

49 
ngx_¬¿y_t
 *
h—d”s
;

50 } 
	tngx_h‰p_h—d”s_cÚf_t
;

53 
ngx_št_t
 
	`ngx_h‰p_£t_expœes
(
ngx_h‰p_»que¡_t
 *
r
,

54 
ngx_h‰p_h—d”s_cÚf_t
 *
cÚf
);

55 
ngx_št_t
 
	`ngx_h‰p_add_ÿche_cÚŒÞ
(
ngx_h‰p_»que¡_t
 *
r
,

56 
ngx_h‰p_h—d”_v®_t
 *
hv
, 
ngx_¡r_t
 *
v®ue
);

57 
ngx_št_t
 
	`ngx_h‰p_add_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

58 
ngx_h‰p_h—d”_v®_t
 *
hv
, 
ngx_¡r_t
 *
v®ue
);

59 
ngx_št_t
 
	`ngx_h‰p_£t_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
,

60 
ngx_h‰p_h—d”_v®_t
 *
hv
, 
ngx_¡r_t
 *
v®ue
);

61 
ngx_št_t
 
	`ngx_h‰p_£t_»¥Ú£_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

62 
ngx_h‰p_h—d”_v®_t
 *
hv
, 
ngx_¡r_t
 *
v®ue
);

64 *
	`ngx_h‰p_h—d”s_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

65 *
	`ngx_h‰p_h—d”s_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
,

66 *
·»Á
, *
chžd
);

67 
ngx_št_t
 
	`ngx_h‰p_h—d”s_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

68 *
	`ngx_h‰p_h—d”s_expœes
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

69 *
cÚf
);

70 *
	`ngx_h‰p_h—d”s_add
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

71 *
cÚf
);

74 
ngx_h‰p_£t_h—d”_t
 
ngx_h‰p_£t_h—d”s
[] = {

76 { 
	`ngx_¡ršg
("Cache-CÚŒÞ"), 0, 
ngx_h‰p_add_ÿche_cÚŒÞ
 },

78 { 
	`ngx_¡ršg
("Last-Modified"),

79 
	`off£tof
(
ngx_h‰p_h—d”s_out_t
, 
Ï¡_modif›d
),

80 
ngx_h‰p_£t_Ï¡_modif›d
 },

82 { 
	`ngx_¡ršg
("ETag"),

83 
	`off£tof
(
ngx_h‰p_h—d”s_out_t
, 
‘ag
),

84 
ngx_h‰p_£t_»¥Ú£_h—d”
 },

86 { 
ngx_nuÎ_¡ršg
, 0, 
NULL
 }

87 
	}
};

90 
ngx_commªd_t
 
	gngx_h‰p_h—d”s_fž‹r_commªds
[] = {

92 { 
ngx_¡ršg
("expires"),

93 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


94 |
NGX_CONF_TAKE12
,

95 
ngx_h‰p_h—d”s_expœes
,

96 
NGX_HTTP_LOC_CONF_OFFSET
,

98 
NULL
},

100 { 
ngx_¡ršg
("add_header"),

101 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


102 |
NGX_CONF_TAKE23
,

103 
ngx_h‰p_h—d”s_add
,

104 
NGX_HTTP_LOC_CONF_OFFSET
,

106 
NULL
},

108 
ngx_nuÎ_commªd


112 
ngx_h‰p_moduË_t
 
	gngx_h‰p_h—d”s_fž‹r_moduË_ùx
 = {

113 
NULL
,

114 
ngx_h‰p_h—d”s_fž‹r_š™
,

116 
NULL
,

117 
NULL
,

119 
NULL
,

120 
NULL
,

122 
ngx_h‰p_h—d”s_ü—‹_cÚf
,

123 
ngx_h‰p_h—d”s_m”ge_cÚf


127 
ngx_moduË_t
 
	gngx_h‰p_h—d”s_fž‹r_moduË
 = {

128 
NGX_MODULE_V1
,

129 &
ngx_h‰p_h—d”s_fž‹r_moduË_ùx
,

130 
ngx_h‰p_h—d”s_fž‹r_commªds
,

131 
NGX_HTTP_MODULE
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NULL
,

137 
NULL
,

138 
NULL
,

139 
NGX_MODULE_V1_PADDING


143 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

146 
ngx_št_t


147 
	$ngx_h‰p_h—d”s_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

149 
ngx_¡r_t
 
v®ue
;

150 
ngx_ušt_t
 
i
, 
§ã_¡©us
;

151 
ngx_h‰p_h—d”_v®_t
 *
h
;

152 
ngx_h‰p_h—d”s_cÚf_t
 *
cÚf
;

154 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_h—d”s_fž‹r_moduË
);

156 ià((
cÚf
->
expœes
 =ð
NGX_HTTP_EXPIRES_OFF
 && cÚf->
h—d”s
 =ð
NULL
)

157 || 
r
 !ðr->
maš
)

159  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

162 
r
->
h—d”s_out
.
¡©us
) {

164 
NGX_HTTP_OK
:

165 
NGX_HTTP_CREATED
:

166 
NGX_HTTP_NO_CONTENT
:

167 
NGX_HTTP_PARTIAL_CONTENT
:

168 
NGX_HTTP_MOVED_PERMANENTLY
:

169 
NGX_HTTP_MOVED_TEMPORARILY
:

170 
NGX_HTTP_SEE_OTHER
:

171 
NGX_HTTP_NOT_MODIFIED
:

172 
NGX_HTTP_TEMPORARY_REDIRECT
:

173 
§ã_¡©us
 = 1;

177 
§ã_¡©us
 = 0;

181 ià(
cÚf
->
expœes
 !ð
NGX_HTTP_EXPIRES_OFF
 && 
§ã_¡©us
) {

182 ià(
	`ngx_h‰p_£t_expœes
(
r
, 
cÚf
è!ð
NGX_OK
) {

183  
NGX_ERROR
;

187 ià(
cÚf
->
h—d”s
) {

188 
h
 = 
cÚf
->
h—d”s
->
–ts
;

189 
i
 = 0; i < 
cÚf
->
h—d”s
->
ÃÉs
; i++) {

191 ià(!
§ã_¡©us
 && !
h
[
i
].
®ways
) {

195 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
h
[
i
].
v®ue
, &v®ueè!ð
NGX_OK
) {

196  
NGX_ERROR
;

199 ià(
h
[
i
].
	`hªdËr
(
r
, &h[i], &
v®ue
è!ð
NGX_OK
) {

200  
NGX_ERROR
;

205  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

206 
	}
}

209 
ngx_št_t


210 
	$ngx_h‰p_£t_expœes
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_h—d”s_cÚf_t
 *
cÚf
)

212 
size_t
 
Ën
;

213 
time_t
 
now
, 
expœes_time
, 
max_age
;

214 
ngx_ušt_t
 
i
;

215 
ngx_bË_–t_t
 *
expœes
, *
cc
, **
cý
;

217 
expœes
 = 
r
->
h—d”s_out
.expires;

219 ià(
expœes
 =ð
NULL
) {

221 
expœes
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

222 ià(
expœes
 =ð
NULL
) {

223  
NGX_ERROR
;

226 
r
->
h—d”s_out
.
expœes
 =ƒxpires;

228 
expœes
->
hash
 = 1;

229 
	`ngx_¡r_£t
(&
expœes
->
key
, "Expires");

232 
Ën
 = ("Mon, 28 Sep 1970 06:00:00 GMT");

233 
expœes
->
v®ue
.
Ën
 =†en - 1;

235 
cý
 = 
r
->
h—d”s_out
.
ÿche_cÚŒÞ
.
–ts
;

237 ià(
cý
 =ð
NULL
) {

239 ià(
	`ngx_¬¿y_š™
(&
r
->
h—d”s_out
.
ÿche_cÚŒÞ
,„->
poÞ
,

240 1, (
ngx_bË_–t_t
 *))

241 !ð
NGX_OK
)

243  
NGX_ERROR
;

246 
cý
 = 
	`ngx_¬¿y_push
(&
r
->
h—d”s_out
.
ÿche_cÚŒÞ
);

247 ià(
cý
 =ð
NULL
) {

248  
NGX_ERROR
;

251 
cc
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

252 ià(
cc
 =ð
NULL
) {

253  
NGX_ERROR
;

256 
cc
->
hash
 = 1;

257 
	`ngx_¡r_£t
(&
cc
->
key
, "Cache-Control");

258 *
cý
 = 
cc
;

261 
i
 = 1; i < 
r
->
h—d”s_out
.
ÿche_cÚŒÞ
.
ÃÉs
; i++) {

262 
cý
[
i
]->
hash
 = 0;

265 
cc
 = 
cý
[0];

268 ià(
cÚf
->
expœes
 =ð
NGX_HTTP_EXPIRES_EPOCH
) {

269 
expœes
->
v®ue
.
d©a
 = (
u_ch¬
 *) "Thu, 01 Jan 1970 00:00:01 GMT";

270 
	`ngx_¡r_£t
(&
cc
->
v®ue
, "no-cache");

271  
NGX_OK
;

274 ià(
cÚf
->
expœes
 =ð
NGX_HTTP_EXPIRES_MAX
) {

275 
expœes
->
v®ue
.
d©a
 = (
u_ch¬
 *) "Thu, 31 Dec 2037 23:55:55 GMT";

277 
	`ngx_¡r_£t
(&
cc
->
v®ue
, "max-age=315360000");

278  
NGX_OK
;

281 
expœes
->
v®ue
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

282 ià(
expœes
->
v®ue
.
d©a
 =ð
NULL
) {

283  
NGX_ERROR
;

286 ià(
cÚf
->
expœes_time
 =ð0 && cÚf->
expœes
 !ð
NGX_HTTP_EXPIRES_DAILY
) {

287 
	`ngx_memýy
(
expœes
->
v®ue
.
d©a
, 
ngx_ÿched_h‰p_time
.data,

288 
ngx_ÿched_h‰p_time
.
Ën
 + 1);

289 
	`ngx_¡r_£t
(&
cc
->
v®ue
, "max-age=0");

290  
NGX_OK
;

293 
now
 = 
	`ngx_time
();

295 ià(
cÚf
->
expœes
 =ð
NGX_HTTP_EXPIRES_DAILY
) {

296 
expœes_time
 = 
	`ngx_Ãxt_time
(
cÚf
->expires_time);

297 
max_age
 = 
expœes_time
 - 
now
;

299 } ià(
cÚf
->
expœes
 =ð
NGX_HTTP_EXPIRES_ACCESS


300 || 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 == -1)

302 
expœes_time
 = 
now
 + 
cÚf
->expires_time;

303 
max_age
 = 
cÚf
->
expœes_time
;

306 
expœes_time
 = 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 + 
cÚf
->expires_time;

307 
max_age
 = 
expœes_time
 - 
now
;

310 
	`ngx_h‰p_time
(
expœes
->
v®ue
.
d©a
, 
expœes_time
);

312 ià(
cÚf
->
expœes_time
 < 0 || 
max_age
 < 0) {

313 
	`ngx_¡r_£t
(&
cc
->
v®ue
, "no-cache");

314  
NGX_OK
;

317 
cc
->
v®ue
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

318 ("max-age="è+ 
NGX_TIME_T_LEN
 + 1);

319 ià(
cc
->
v®ue
.
d©a
 =ð
NULL
) {

320  
NGX_ERROR
;

323 
cc
->
v®ue
.
Ën
 = 
	`ngx_¥rštf
(cc->v®ue.
d©a
, "max-age=%T", 
max_age
)

324 - 
cc
->
v®ue
.
d©a
;

326  
NGX_OK
;

327 
	}
}

330 
ngx_št_t


331 
	$ngx_h‰p_add_h—d”
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_h—d”_v®_t
 *
hv
,

332 
ngx_¡r_t
 *
v®ue
)

334 
ngx_bË_–t_t
 *
h
;

336 ià(
v®ue
->
Ën
) {

337 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

338 ià(
h
 =ð
NULL
) {

339  
NGX_ERROR
;

342 
h
->
hash
 = 1;

343 
h
->
key
 = 
hv
->key;

344 
h
->
v®ue
 = *value;

347  
NGX_OK
;

348 
	}
}

351 
ngx_št_t


352 
	$ngx_h‰p_add_ÿche_cÚŒÞ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_h—d”_v®_t
 *
hv
,

353 
ngx_¡r_t
 *
v®ue
)

355 
ngx_bË_–t_t
 *
cc
, **
cý
;

357 ià(
v®ue
->
Ën
 == 0) {

358  
NGX_OK
;

361 
cý
 = 
r
->
h—d”s_out
.
ÿche_cÚŒÞ
.
–ts
;

363 ià(
cý
 =ð
NULL
) {

365 ià(
	`ngx_¬¿y_š™
(&
r
->
h—d”s_out
.
ÿche_cÚŒÞ
,„->
poÞ
,

366 1, (
ngx_bË_–t_t
 *))

367 !ð
NGX_OK
)

369  
NGX_ERROR
;

373 
cý
 = 
	`ngx_¬¿y_push
(&
r
->
h—d”s_out
.
ÿche_cÚŒÞ
);

374 ià(
cý
 =ð
NULL
) {

375  
NGX_ERROR
;

378 
cc
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

379 ià(
cc
 =ð
NULL
) {

380  
NGX_ERROR
;

383 
cc
->
hash
 = 1;

384 
	`ngx_¡r_£t
(&
cc
->
key
, "Cache-Control");

385 
cc
->
v®ue
 = *value;

387 *
cý
 = 
cc
;

389  
NGX_OK
;

390 
	}
}

393 
ngx_št_t


394 
	$ngx_h‰p_£t_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_h—d”_v®_t
 *
hv
,

395 
ngx_¡r_t
 *
v®ue
)

397 ià(
	`ngx_h‰p_£t_»¥Ú£_h—d”
(
r
, 
hv
, 
v®ue
è!ð
NGX_OK
) {

398  
NGX_ERROR
;

401 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 =

402 (
v®ue
->
Ën
è? 
	`ngx_h‰p_·r£_time
(v®ue->
d©a
, value->len) : -1;

404  
NGX_OK
;

405 
	}
}

408 
ngx_št_t


409 
	$ngx_h‰p_£t_»¥Ú£_h—d”
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_h—d”_v®_t
 *
hv
,

410 
ngx_¡r_t
 *
v®ue
)

412 
ngx_bË_–t_t
 *
h
, **
Þd
;

414 
Þd
 = (
ngx_bË_–t_t
 **è((*è&
r
->
h—d”s_out
 + 
hv
->
off£t
);

416 ià(
v®ue
->
Ën
 == 0) {

417 ià(*
Þd
) {

418 (*
Þd
)->
hash
 = 0;

419 *
Þd
 = 
NULL
;

422  
NGX_OK
;

425 ià(*
Þd
) {

426 
h
 = *
Þd
;

429 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

430 ià(
h
 =ð
NULL
) {

431  
NGX_ERROR
;

434 *
Þd
 = 
h
;

437 
h
->
hash
 = 1;

438 
h
->
key
 = 
hv
->key;

439 
h
->
v®ue
 = *value;

441  
NGX_OK
;

442 
	}
}

446 
	$ngx_h‰p_h—d”s_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

448 
ngx_h‰p_h—d”s_cÚf_t
 *
cÚf
;

450 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_h—d”s_cÚf_t
));

451 ià(
cÚf
 =ð
NULL
) {

452  
NULL
;

462 
cÚf
->
expœes
 = 
NGX_HTTP_EXPIRES_UNSET
;

464  
cÚf
;

465 
	}
}

469 
	$ngx_h‰p_h—d”s_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

471 
ngx_h‰p_h—d”s_cÚf_t
 *
´ev
 = 
·»Á
;

472 
ngx_h‰p_h—d”s_cÚf_t
 *
cÚf
 = 
chžd
;

474 ià(
cÚf
->
expœes
 =ð
NGX_HTTP_EXPIRES_UNSET
) {

475 
cÚf
->
expœes
 = 
´ev
->expires;

476 
cÚf
->
expœes_time
 = 
´ev
->expires_time;

478 ià(
cÚf
->
expœes
 =ð
NGX_HTTP_EXPIRES_UNSET
) {

479 
cÚf
->
expœes
 = 
NGX_HTTP_EXPIRES_OFF
;

483 ià(
cÚf
->
h—d”s
 =ð
NULL
) {

484 
cÚf
->
h—d”s
 = 
´ev
->headers;

487  
NGX_CONF_OK
;

488 
	}
}

491 
ngx_št_t


492 
	$ngx_h‰p_h—d”s_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

494 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

495 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_h—d”s_fž‹r
;

497  
NGX_OK
;

498 
	}
}

502 
	$ngx_h‰p_h—d”s_expœes
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

504 
ngx_h‰p_h—d”s_cÚf_t
 *
hcf
 = 
cÚf
;

506 
ngx_ušt_t
 
mšus
, 
n
;

507 
ngx_¡r_t
 *
v®ue
;

509 ià(
hcf
->
expœes
 !ð
NGX_HTTP_EXPIRES_UNSET
) {

513 
v®ue
 = 
cf
->
¬gs
->
–ts
;

515 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

517 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "epoch") == 0) {

518 
hcf
->
expœes
 = 
NGX_HTTP_EXPIRES_EPOCH
;

519  
NGX_CONF_OK
;

522 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "max") == 0) {

523 
hcf
->
expœes
 = 
NGX_HTTP_EXPIRES_MAX
;

524  
NGX_CONF_OK
;

527 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

528 
hcf
->
expœes
 = 
NGX_HTTP_EXPIRES_OFF
;

529  
NGX_CONF_OK
;

532 
hcf
->
expœes
 = 
NGX_HTTP_EXPIRES_ACCESS
;

534 
n
 = 1;

538 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "modified") != 0) {

542 
hcf
->
expœes
 = 
NGX_HTTP_EXPIRES_MODIFIED
;

544 
n
 = 2;

547 ià(
v®ue
[
n
].
d©a
[0] == '@') {

548 
v®ue
[
n
].
d©a
++;

549 
v®ue
[
n
].
Ën
--;

550 
mšus
 = 0;

552 ià(
hcf
->
expœes
 =ð
NGX_HTTP_EXPIRES_MODIFIED
) {

556 
hcf
->
expœes
 = 
NGX_HTTP_EXPIRES_DAILY
;

558 } ià(
v®ue
[
n
].
d©a
[0] == '+') {

559 
v®ue
[
n
].
d©a
++;

560 
v®ue
[
n
].
Ën
--;

561 
mšus
 = 0;

563 } ià(
v®ue
[
n
].
d©a
[0] == '-') {

564 
v®ue
[
n
].
d©a
++;

565 
v®ue
[
n
].
Ën
--;

566 
mšus
 = 1;

569 
mšus
 = 0;

572 
hcf
->
expœes_time
 = 
	`ngx_·r£_time
(&
v®ue
[
n
], 1);

574 ià(
hcf
->
expœes_time
 =ð(
time_t
è
NGX_ERROR
) {

578 ià(
hcf
->
expœes
 =ð
NGX_HTTP_EXPIRES_DAILY


579 && 
hcf
->
expœes_time
 > 24 * 60 * 60)

584 ià(
mšus
) {

585 
hcf
->
expœes_time
 = - hcf->expires_time;

588  
NGX_CONF_OK
;

589 
	}
}

593 
	$ngx_h‰p_h—d”s_add
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

595 
ngx_h‰p_h—d”s_cÚf_t
 *
hcf
 = 
cÚf
;

597 
ngx_¡r_t
 *
v®ue
;

598 
ngx_ušt_t
 
i
;

599 
ngx_h‰p_h—d”_v®_t
 *
hv
;

600 
ngx_h‰p_£t_h—d”_t
 *
£t
;

601 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

603 
v®ue
 = 
cf
->
¬gs
->
–ts
;

605 ià(
hcf
->
h—d”s
 =ð
NULL
) {

606 
hcf
->
h—d”s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1,

607 (
ngx_h‰p_h—d”_v®_t
));

608 ià(
hcf
->
h—d”s
 =ð
NULL
) {

609  
NGX_CONF_ERROR
;

613 
hv
 = 
	`ngx_¬¿y_push
(
hcf
->
h—d”s
);

614 ià(
hv
 =ð
NULL
) {

615  
NGX_CONF_ERROR
;

618 
hv
->
key
 = 
v®ue
[1];

619 
hv
->
hªdËr
 = 
ngx_h‰p_add_h—d”
;

620 
hv
->
off£t
 = 0;

621 
hv
->
®ways
 = 0;

623 
£t
 = 
ngx_h‰p_£t_h—d”s
;

624 
i
 = 0; 
£t
[i].
Çme
.
Ën
; i++) {

625 ià(
	`ngx_¡rÿ£cmp
(
v®ue
[1].
d©a
, 
£t
[
i
].
Çme
.data) != 0) {

629 
hv
->
off£t
 = 
£t
[
i
].offset;

630 
hv
->
hªdËr
 = 
£t
[
i
].handler;

635 ià(
v®ue
[2].
Ën
 == 0) {

636 
	`ngx_memz”o
(&
hv
->
v®ue
, (
ngx_h‰p_com¶ex_v®ue_t
));

637  
NGX_CONF_OK
;

640 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

642 
ccv
.
cf
 = cf;

643 
ccv
.
v®ue
 = &value[2];

644 
ccv
.
com¶ex_v®ue
 = &
hv
->
v®ue
;

646 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

647  
NGX_CONF_ERROR
;

650 ià(
cf
->
¬gs
->
ÃÉs
 == 3) {

651  
NGX_CONF_OK
;

654 ià(
	`ngx_¡rcmp
(
v®ue
[3].
d©a
, "always") != 0) {

655 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

656 "šv®id…¬am‘” \"%V\"", &
v®ue
[3]);

657  
NGX_CONF_ERROR
;

660 
hv
->
®ways
 = 1;

662  
NGX_CONF_OK
;

663 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_image_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

12 
	~<gd.h
>

15 
	#NGX_HTTP_IMAGE_OFF
 0

	)

16 
	#NGX_HTTP_IMAGE_TEST
 1

	)

17 
	#NGX_HTTP_IMAGE_SIZE
 2

	)

18 
	#NGX_HTTP_IMAGE_RESIZE
 3

	)

19 
	#NGX_HTTP_IMAGE_CROP
 4

	)

20 
	#NGX_HTTP_IMAGE_ROTATE
 5

	)

23 
	#NGX_HTTP_IMAGE_START
 0

	)

24 
	#NGX_HTTP_IMAGE_READ
 1

	)

25 
	#NGX_HTTP_IMAGE_PROCESS
 2

	)

26 
	#NGX_HTTP_IMAGE_PASS
 3

	)

27 
	#NGX_HTTP_IMAGE_DONE
 4

	)

30 
	#NGX_HTTP_IMAGE_NONE
 0

	)

31 
	#NGX_HTTP_IMAGE_JPEG
 1

	)

32 
	#NGX_HTTP_IMAGE_GIF
 2

	)

33 
	#NGX_HTTP_IMAGE_PNG
 3

	)

36 
	#NGX_HTTP_IMAGE_BUFFERED
 0x08

	)

40 
ngx_ušt_t
 
	mfž‹r
;

41 
ngx_ušt_t
 
	mwidth
;

42 
ngx_ušt_t
 
	mheight
;

43 
ngx_ušt_t
 
	mªgË
;

44 
ngx_ušt_t
 
	mj³g_qu®™y
;

45 
ngx_ušt_t
 
	msh¬³n
;

47 
ngx_æag_t
 
	mŒª¥¬’cy
;

48 
ngx_æag_t
 
	mš‹¾aû
;

50 
ngx_h‰p_com¶ex_v®ue_t
 *
	mwcv
;

51 
ngx_h‰p_com¶ex_v®ue_t
 *
	mhcv
;

52 
ngx_h‰p_com¶ex_v®ue_t
 *
	macv
;

53 
ngx_h‰p_com¶ex_v®ue_t
 *
	mjqcv
;

54 
ngx_h‰p_com¶ex_v®ue_t
 *
	mshcv
;

56 
size_t
 
	mbufãr_size
;

57 } 
	tngx_h‰p_image_fž‹r_cÚf_t
;

61 
u_ch¬
 *
	mimage
;

62 
u_ch¬
 *
	mÏ¡
;

64 
size_t
 
	mËngth
;

66 
ngx_ušt_t
 
	mwidth
;

67 
ngx_ušt_t
 
	mheight
;

68 
ngx_ušt_t
 
	mmax_width
;

69 
ngx_ušt_t
 
	mmax_height
;

70 
ngx_ušt_t
 
	mªgË
;

72 
ngx_ušt_t
 
	mpha£
;

73 
ngx_ušt_t
 
	mty³
;

74 
ngx_ušt_t
 
	mfÜû
;

75 } 
	tngx_h‰p_image_fž‹r_ùx_t
;

78 
ngx_št_t
 
ngx_h‰p_image_£nd
(
ngx_h‰p_»que¡_t
 *
r
,

79 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
);

80 
ngx_ušt_t
 
ngx_h‰p_image_‹¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
);

81 
ngx_št_t
 
ngx_h‰p_image_»ad
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
);

82 
ngx_buf_t
 *
ngx_h‰p_image_´oûss
(
ngx_h‰p_»que¡_t
 *
r
);

83 
ngx_buf_t
 *
ngx_h‰p_image_jsÚ
(
ngx_h‰p_»que¡_t
 *
r
,

84 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
);

85 
ngx_buf_t
 *
ngx_h‰p_image_asis
(
ngx_h‰p_»que¡_t
 *
r
,

86 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
);

87 
ngx_h‰p_image_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_buf_t
 *
b
);

88 
ngx_št_t
 
ngx_h‰p_image_size
(
ngx_h‰p_»que¡_t
 *
r
,

89 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
);

91 
ngx_buf_t
 *
ngx_h‰p_image_»size
(
ngx_h‰p_»que¡_t
 *
r
,

92 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
);

93 
gdImagePŒ
 
ngx_h‰p_image_sourû
(
ngx_h‰p_»que¡_t
 *
r
,

94 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
);

95 
gdImagePŒ
 
ngx_h‰p_image_Ãw
(
ngx_h‰p_»que¡_t
 *
r
, 
w
, 
h
,

96 
cÞÜs
);

97 
u_ch¬
 *
ngx_h‰p_image_out
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
ty³
,

98 
gdImagePŒ
 
img
, *
size
);

99 
ngx_h‰p_image_þ—nup
(*
d©a
);

100 
ngx_ušt_t
 
ngx_h‰p_image_fž‹r_g‘_v®ue
(
ngx_h‰p_»que¡_t
 *
r
,

101 
ngx_h‰p_com¶ex_v®ue_t
 *
cv
, 
ngx_ušt_t
 
v
);

102 
ngx_ušt_t
 
ngx_h‰p_image_fž‹r_v®ue
(
ngx_¡r_t
 *
v®ue
);

105 *
ngx_h‰p_image_fž‹r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

106 *
ngx_h‰p_image_fž‹r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

107 *
chžd
);

108 *
ngx_h‰p_image_fž‹r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

109 *
cÚf
);

110 *
ngx_h‰p_image_fž‹r_j³g_qu®™y
(
ngx_cÚf_t
 *
cf
,

111 
ngx_commªd_t
 *
cmd
, *
cÚf
);

112 *
ngx_h‰p_image_fž‹r_sh¬³n
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

113 *
cÚf
);

114 
ngx_št_t
 
ngx_h‰p_image_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

117 
ngx_commªd_t
 
	gngx_h‰p_image_fž‹r_commªds
[] = {

119 { 
ngx_¡ršg
("image_filter"),

120 
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE123
,

121 
ngx_h‰p_image_fž‹r
,

122 
NGX_HTTP_LOC_CONF_OFFSET
,

124 
NULL
 },

126 { 
ngx_¡ršg
("image_filter_jpeg_quality"),

127 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

128 
ngx_h‰p_image_fž‹r_j³g_qu®™y
,

129 
NGX_HTTP_LOC_CONF_OFFSET
,

131 
NULL
 },

133 { 
ngx_¡ršg
("image_filter_sharpen"),

134 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

135 
ngx_h‰p_image_fž‹r_sh¬³n
,

136 
NGX_HTTP_LOC_CONF_OFFSET
,

138 
NULL
 },

140 { 
ngx_¡ršg
("image_filter_transparency"),

141 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

142 
ngx_cÚf_£t_æag_¦Ù
,

143 
NGX_HTTP_LOC_CONF_OFFSET
,

144 
off£tof
(
ngx_h‰p_image_fž‹r_cÚf_t
, 
Œª¥¬’cy
),

145 
NULL
 },

147 { 
ngx_¡ršg
("image_filter_interlace"),

148 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

149 
ngx_cÚf_£t_æag_¦Ù
,

150 
NGX_HTTP_LOC_CONF_OFFSET
,

151 
off£tof
(
ngx_h‰p_image_fž‹r_cÚf_t
, 
š‹¾aû
),

152 
NULL
 },

154 { 
ngx_¡ršg
("image_filter_buffer"),

155 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

156 
ngx_cÚf_£t_size_¦Ù
,

157 
NGX_HTTP_LOC_CONF_OFFSET
,

158 
off£tof
(
ngx_h‰p_image_fž‹r_cÚf_t
, 
bufãr_size
),

159 
NULL
 },

161 
ngx_nuÎ_commªd


165 
ngx_h‰p_moduË_t
 
	gngx_h‰p_image_fž‹r_moduË_ùx
 = {

166 
NULL
,

167 
ngx_h‰p_image_fž‹r_š™
,

169 
NULL
,

170 
NULL
,

172 
NULL
,

173 
NULL
,

175 
ngx_h‰p_image_fž‹r_ü—‹_cÚf
,

176 
ngx_h‰p_image_fž‹r_m”ge_cÚf


180 
ngx_moduË_t
 
	gngx_h‰p_image_fž‹r_moduË
 = {

181 
NGX_MODULE_V1
,

182 &
ngx_h‰p_image_fž‹r_moduË_ùx
,

183 
ngx_h‰p_image_fž‹r_commªds
,

184 
NGX_HTTP_MODULE
,

185 
NULL
,

186 
NULL
,

187 
NULL
,

188 
NULL
,

189 
NULL
,

190 
NULL
,

191 
NULL
,

192 
NGX_MODULE_V1_PADDING


196 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

197 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

200 
ngx_¡r_t
 
	gngx_h‰p_image_ty³s
[] = {

201 
ngx_¡ršg
("image/jpeg"),

202 
ngx_¡ršg
("image/gif"),

203 
ngx_¡ršg
("image/png")

207 
ngx_št_t


208 
	$ngx_h‰p_image_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

210 
off_t
 
Ën
;

211 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
;

212 
ngx_h‰p_image_fž‹r_cÚf_t
 *
cÚf
;

214 ià(
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_NOT_MODIFIED
) {

215  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

218 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

220 ià(
ùx
) {

221 
	`ngx_h‰p_£t_ùx
(
r
, 
NULL
, 
ngx_h‰p_image_fž‹r_moduË
);

222  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

225 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

227 ià(
cÚf
->
fž‹r
 =ð
NGX_HTTP_IMAGE_OFF
) {

228  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

231 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën


233 && 
	`ngx_¡ºÿ£cmp
(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
,

234 (
u_ch¬
 *) "multipart/x-mixed-replace",

238 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

241  
NGX_ERROR
;

244 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_image_fž‹r_ùx_t
));

245 ià(
ùx
 =ð
NULL
) {

246  
NGX_ERROR
;

249 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_image_fž‹r_moduË
);

251 
Ën
 = 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
;

253 ià(
Ën
 !ð-1 &&†’ > (
off_t
è
cÚf
->
bufãr_size
) {

254 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

255 "imagfž‹r:oØbig„e¥Ú£: %O", 
Ën
);

257  
NGX_HTTP_UNSUPPORTED_MEDIA_TYPE
;

260 ià(
Ën
 == -1) {

261 
ùx
->
Ëngth
 = 
cÚf
->
bufãr_size
;

264 
ùx
->
Ëngth
 = (
size_t
è
Ën
;

267 ià(
r
->
h—d”s_out
.
»äesh
) {

268 
r
->
h—d”s_out
.
»äesh
->
hash
 = 0;

271 
r
->
maš_fž‹r_Ãed_š_memÜy
 = 1;

272 
r
->
®low_¿nges
 = 0;

274  
NGX_OK
;

275 
	}
}

278 
ngx_št_t


279 
	$ngx_h‰p_image_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

281 
ngx_št_t
 
rc
;

282 
ngx_¡r_t
 *
ù
;

283 
ngx_chaš_t
 
out
;

284 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
;

285 
ngx_h‰p_image_fž‹r_cÚf_t
 *
cÚf
;

287 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0, "image filter");

289 ià(
š
 =ð
NULL
) {

290  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

293 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

295 ià(
ùx
 =ð
NULL
) {

296  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

299 
ùx
->
pha£
) {

301 
NGX_HTTP_IMAGE_START
:

303 
ùx
->
ty³
 = 
	`ngx_h‰p_image_‹¡
(
r
, 
š
);

305 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

307 ià(
ùx
->
ty³
 =ð
NGX_HTTP_IMAGE_NONE
) {

309 ià(
cÚf
->
fž‹r
 =ð
NGX_HTTP_IMAGE_SIZE
) {

310 
out
.
buf
 = 
	`ngx_h‰p_image_jsÚ
(
r
, 
NULL
);

312 ià(
out
.
buf
) {

313 
out
.
Ãxt
 = 
NULL
;

314 
ùx
->
pha£
 = 
NGX_HTTP_IMAGE_DONE
;

316  
	`ngx_h‰p_image_£nd
(
r
, 
ùx
, &
out
);

320  
	`ngx_h‰p_fž‹r_fš®ize_»que¡
(
r
,

321 &
ngx_h‰p_image_fž‹r_moduË
,

322 
NGX_HTTP_UNSUPPORTED_MEDIA_TYPE
);

327 
ù
 = &
ngx_h‰p_image_ty³s
[
ùx
->
ty³
 - 1];

328 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = 
ù
->
Ën
;

329 
r
->
h—d”s_out
.
cÚ‹Á_ty³
 = *
ù
;

330 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

332 ià(
cÚf
->
fž‹r
 =ð
NGX_HTTP_IMAGE_TEST
) {

333 
ùx
->
pha£
 = 
NGX_HTTP_IMAGE_PASS
;

335  
	`ngx_h‰p_image_£nd
(
r
, 
ùx
, 
š
);

338 
ùx
->
pha£
 = 
NGX_HTTP_IMAGE_READ
;

342 
NGX_HTTP_IMAGE_READ
:

344 
rc
 = 
	`ngx_h‰p_image_»ad
(
r
, 
š
);

346 ià(
rc
 =ð
NGX_AGAIN
) {

347  
NGX_OK
;

350 ià(
rc
 =ð
NGX_ERROR
) {

351  
	`ngx_h‰p_fž‹r_fš®ize_»que¡
(
r
,

352 &
ngx_h‰p_image_fž‹r_moduË
,

353 
NGX_HTTP_UNSUPPORTED_MEDIA_TYPE
);

358 
NGX_HTTP_IMAGE_PROCESS
:

360 
out
.
buf
 = 
	`ngx_h‰p_image_´oûss
(
r
);

362 ià(
out
.
buf
 =ð
NULL
) {

363  
	`ngx_h‰p_fž‹r_fš®ize_»que¡
(
r
,

364 &
ngx_h‰p_image_fž‹r_moduË
,

365 
NGX_HTTP_UNSUPPORTED_MEDIA_TYPE
);

368 
out
.
Ãxt
 = 
NULL
;

369 
ùx
->
pha£
 = 
NGX_HTTP_IMAGE_PASS
;

371  
	`ngx_h‰p_image_£nd
(
r
, 
ùx
, &
out
);

373 
NGX_HTTP_IMAGE_PASS
:

375  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

379 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
NULL
);

382  (
rc
 =ð
NGX_OK
è? 
NGX_ERROR
 :„c;

384 
	}
}

387 
ngx_št_t


388 
	$ngx_h‰p_image_£nd
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
,

389 
ngx_chaš_t
 *
š
)

391 
ngx_št_t
 
rc
;

393 
rc
 = 
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

395 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

396  
NGX_ERROR
;

399 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

401 ià(
ùx
->
pha£
 =ð
NGX_HTTP_IMAGE_DONE
) {

403  (
rc
 =ð
NGX_OK
è? 
NGX_ERROR
 :„c;

406  
rc
;

407 
	}
}

410 
ngx_ušt_t


411 
	$ngx_h‰p_image_‹¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

413 
u_ch¬
 *
p
;

415 
p
 = 
š
->
buf
->
pos
;

417 ià(
š
->
buf
->
Ï¡
 - 
p
 < 16) {

418  
NGX_HTTP_IMAGE_NONE
;

421 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

422 "imagfž‹r: \"%c%c\"", 
p
[0],…[1]);

424 ià(
p
[0] == 0xff &&…[1] == 0xd8) {

428  
NGX_HTTP_IMAGE_JPEG
;

430 } ià(
p
[0] == 'G' &&…[1] == 'I' &&…[2] == 'F' &&…[3] == '8'

431 && 
p
[5] == 'a')

433 ià(
p
[4] == '9' ||…[4] == '7') {

435  
NGX_HTTP_IMAGE_GIF
;

438 } ià(
p
[0] == 0x89 &&…[1] == 'P' &&…[2] == 'N' &&…[3] == 'G'

439 && 
p
[4] == 0x0d &&…[5] == 0x0a &&…[6] == 0x1a &&…[7] == 0x0a)

443  
NGX_HTTP_IMAGE_PNG
;

446  
NGX_HTTP_IMAGE_NONE
;

447 
	}
}

450 
ngx_št_t


451 
	$ngx_h‰p_image_»ad
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

453 
u_ch¬
 *
p
;

454 
size_t
 
size
, 
»¡
;

455 
ngx_buf_t
 *
b
;

456 
ngx_chaš_t
 *
þ
;

457 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
;

459 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

461 ià(
ùx
->
image
 =ð
NULL
) {

462 
ùx
->
image
 = 
	`ngx_·Îoc
(
r
->
poÞ
, ctx->
Ëngth
);

463 ià(
ùx
->
image
 =ð
NULL
) {

464  
NGX_ERROR
;

467 
ùx
->
Ï¡
 = ctx->
image
;

470 
p
 = 
ùx
->
Ï¡
;

472 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

474 
b
 = 
þ
->
buf
;

475 
size
 = 
b
->
Ï¡
 - b->
pos
;

477 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

478 "imagbuf: %uz", 
size
);

480 
»¡
 = 
ùx
->
image
 + ctx->
Ëngth
 - 
p
;

482 ià(
size
 > 
»¡
) {

483 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

485  
NGX_ERROR
;

488 
p
 = 
	`ngx_ýymem
Õ, 
b
->
pos
, 
size
);

489 
b
->
pos
 +ð
size
;

491 ià(
b
->
Ï¡_buf
) {

492 
ùx
->
Ï¡
 = 
p
;

493  
NGX_OK
;

497 
ùx
->
Ï¡
 = 
p
;

498 
r
->
cÚÃùiÚ
->
bufã»d
 |ð
NGX_HTTP_IMAGE_BUFFERED
;

500  
NGX_AGAIN
;

501 
	}
}

504 
ngx_buf_t
 *

505 
	$ngx_h‰p_image_´oûss
(
ngx_h‰p_»que¡_t
 *
r
)

507 
ngx_št_t
 
rc
;

508 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
;

509 
ngx_h‰p_image_fž‹r_cÚf_t
 *
cÚf
;

511 
r
->
cÚÃùiÚ
->
bufã»d
 &ð~
NGX_HTTP_IMAGE_BUFFERED
;

513 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

515 
rc
 = 
	`ngx_h‰p_image_size
(
r
, 
ùx
);

517 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

519 ià(
cÚf
->
fž‹r
 =ð
NGX_HTTP_IMAGE_SIZE
) {

520  
	`ngx_h‰p_image_jsÚ
(
r
, 
rc
 =ð
NGX_OK
 ? 
ùx
 : 
NULL
);

523 
ùx
->
ªgË
 = 
	`ngx_h‰p_image_fž‹r_g‘_v®ue
(
r
, 
cÚf
->
acv
, conf->angle);

525 ià(
cÚf
->
fž‹r
 =ð
NGX_HTTP_IMAGE_ROTATE
) {

527 ià(
ùx
->
ªgË
 != 90 && ctx->angle != 180 && ctx->angle != 270) {

528  
NULL
;

531  
	`ngx_h‰p_image_»size
(
r
, 
ùx
);

534 
ùx
->
max_width
 = 
	`ngx_h‰p_image_fž‹r_g‘_v®ue
(
r
, 
cÚf
->
wcv
, cÚf->
width
);

535 ià(
ùx
->
max_width
 == 0) {

536  
NULL
;

539 
ùx
->
max_height
 = 
	`ngx_h‰p_image_fž‹r_g‘_v®ue
(
r
, 
cÚf
->
hcv
,

540 
cÚf
->
height
);

541 ià(
ùx
->
max_height
 == 0) {

542  
NULL
;

545 ià(
rc
 =ð
NGX_OK


546 && 
ùx
->
width
 <ðùx->
max_width


547 && 
ùx
->
height
 <ðùx->
max_height


548 && 
ùx
->
ªgË
 == 0

549 && !
ùx
->
fÜû
)

551  
	`ngx_h‰p_image_asis
(
r
, 
ùx
);

554  
	`ngx_h‰p_image_»size
(
r
, 
ùx
);

555 
	}
}

558 
ngx_buf_t
 *

559 
	$ngx_h‰p_image_jsÚ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
)

561 
size_t
 
Ën
;

562 
ngx_buf_t
 *
b
;

564 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

565 ià(
b
 =ð
NULL
) {

566  
NULL
;

569 
b
->
memÜy
 = 1;

570 
b
->
Ï¡_buf
 = 1;

572 
	`ngx_h‰p_þ—n_h—d”
(
r
);

574 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_OK
;

575 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = ("application/json") - 1;

576 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
cÚ‹Á_ty³
, "application/json");

577 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

579 ià(
ùx
 =ð
NULL
) {

580 
b
->
pos
 = (
u_ch¬
 *è"{}" 
CRLF
;

581 
b
->
Ï¡
 = b->
pos
 + ("{}" 
CRLF
) - 1;

583 
	`ngx_h‰p_image_Ëngth
(
r
, 
b
);

585  
b
;

588 
Ën
 = ("{ \"img\" : "

589 "{ \"width\": , \"height\": , \"ty³\": \"j³g\" } }" 
CRLF
) - 1

590 + 2 * 
NGX_SIZE_T_LEN
;

592 
b
->
pos
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

593 ià(
b
->
pos
 =ð
NULL
) {

594  
NULL
;

597 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->
pos
,

601 " \"ty³\": \"%s\" } }" 
CRLF
,

602 
ùx
->
width
, ctx->
height
,

603 
ngx_h‰p_image_ty³s
[
ùx
->
ty³
 - 1].
d©a
 + 6);

605 
	`ngx_h‰p_image_Ëngth
(
r
, 
b
);

607  
b
;

608 
	}
}

611 
ngx_buf_t
 *

612 
	$ngx_h‰p_image_asis
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
)

614 
ngx_buf_t
 *
b
;

616 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

617 ià(
b
 =ð
NULL
) {

618  
NULL
;

621 
b
->
pos
 = 
ùx
->
image
;

622 
b
->
Ï¡
 = 
ùx
->last;

623 
b
->
memÜy
 = 1;

624 
b
->
Ï¡_buf
 = 1;

626 
	`ngx_h‰p_image_Ëngth
(
r
, 
b
);

628  
b
;

629 
	}
}

633 
	$ngx_h‰p_image_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_buf_t
 *
b
)

635 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
b
->
Ï¡
 - b->
pos
;

637 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
) {

638 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
->
hash
 = 0;

641 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 = 
NULL
;

642 
	}
}

645 
ngx_št_t


646 
	$ngx_h‰p_image_size
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
)

648 
u_ch¬
 *
p
, *
Ï¡
;

649 
size_t
 
Ën
, 
­p
;

650 
ngx_ušt_t
 
width
, 
height
;

652 
p
 = 
ùx
->
image
;

654 
ùx
->
ty³
) {

656 
NGX_HTTP_IMAGE_JPEG
:

658 
p
 += 2;

659 
Ï¡
 = 
ùx
->
image
 + ctx->
Ëngth
 - 10;

660 
width
 = 0;

661 
height
 = 0;

662 
­p
 = 0;

664 
p
 < 
Ï¡
) {

666 ià(
p
[0] == 0xff &&…[1] != 0xff) {

668 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

669 "JPEG: %02xd %02xd", 
p
[0],…[1]);

671 
p
++;

673 ià((*
p
 == 0xc0 || *p == 0xc1 || *p == 0xc2 || *p == 0xc3

674 || *
p
 == 0xc9 || *p == 0xca || *p == 0xcb)

675 && (
width
 =ð0 || 
height
 == 0))

677 
width
 = 
p
[6] * 256 +…[7];

678 
height
 = 
p
[4] * 256 +…[5];

681 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

682 "JPEG: %02xd %02xd", 
p
[1],…[2]);

684 
Ën
 = 
p
[1] * 256 +…[2];

686 ià(*
p
 >= 0xe1 && *p <= 0xef) {

688 
­p
 +ð
Ën
;

691 
p
 +ð
Ën
;

696 
p
++;

699 ià(
width
 =ð0 || 
height
 == 0) {

700  
NGX_DECLINED
;

703 ià(
ùx
->
Ëngth
 / 20 < 
­p
) {

705 
ùx
->
fÜû
 = 1;

706 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

707 "­°d©¨size: %uz", 
­p
);

712 
NGX_HTTP_IMAGE_GIF
:

714 ià(
ùx
->
Ëngth
 < 10) {

715  
NGX_DECLINED
;

718 
width
 = 
p
[7] * 256 +…[6];

719 
height
 = 
p
[9] * 256 +…[8];

723 
NGX_HTTP_IMAGE_PNG
:

725 ià(
ùx
->
Ëngth
 < 24) {

726  
NGX_DECLINED
;

729 
width
 = 
p
[18] * 256 +…[19];

730 
height
 = 
p
[22] * 256 +…[23];

736  
NGX_DECLINED
;

739 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

740 "imagsize: %d x %d", 
width
, 
height
);

742 
ùx
->
width
 = width;

743 
ùx
->
height
 = height;

745  
NGX_OK
;

746 
	}
}

749 
ngx_buf_t
 *

750 
	$ngx_h‰p_image_»size
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
)

752 
sx
, 
sy
, 
dx
, 
dy
, 
ox
, 
oy
, 
ax
, 
ay
, 
size
,

753 
cÞÜs
, 
·Ë‰e
, 
Œª¥¬’t
, 
sh¬³n
,

754 
»d
, 
g»’
, 
blue
, 
t
;

755 
u_ch¬
 *
out
;

756 
ngx_buf_t
 *
b
;

757 
ngx_ušt_t
 
»size
;

758 
gdImagePŒ
 
¤c
, 
d¡
;

759 
ngx_poÞ_þ—nup_t
 *
þn
;

760 
ngx_h‰p_image_fž‹r_cÚf_t
 *
cÚf
;

762 
¤c
 = 
	`ngx_h‰p_image_sourû
(
r
, 
ùx
);

764 ià(
¤c
 =ð
NULL
) {

765  
NULL
;

768 
sx
 = 
	`gdImageSX
(
¤c
);

769 
sy
 = 
	`gdImageSY
(
¤c
);

771 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

773 ià(!
ùx
->
fÜû


774 && 
ùx
->
ªgË
 == 0

775 && (
ngx_ušt_t
è
sx
 <ð
ùx
->
max_width


776 && (
ngx_ušt_t
è
sy
 <ð
ùx
->
max_height
)

778 
	`gdImageDe¡roy
(
¤c
);

779  
	`ngx_h‰p_image_asis
(
r
, 
ùx
);

782 
cÞÜs
 = 
	`gdImageCÞÜsTÙ®
(
¤c
);

784 ià(
cÞÜs
 && 
cÚf
->
Œª¥¬’cy
) {

785 
Œª¥¬’t
 = 
	`gdImageG‘T¿n¥¬’t
(
¤c
);

787 ià(
Œª¥¬’t
 != -1) {

788 
·Ë‰e
 = 
cÞÜs
;

789 
»d
 = 
	`gdImageRed
(
¤c
, 
Œª¥¬’t
);

790 
g»’
 = 
	`gdImageG»’
(
¤c
, 
Œª¥¬’t
);

791 
blue
 = 
	`gdImageBlue
(
¤c
, 
Œª¥¬’t
);

793 
Œª¥¬’t
;

797 
·Ë‰e
 = 0;

798 
Œª¥¬’t
 = -1;

799 
»d
 = 0;

800 
g»’
 = 0;

801 
blue
 = 0;

803 
Œª¥¬’t
:

805 
	`gdImageCÞÜT¿n¥¬’t
(
¤c
, -1);

807 
dx
 = 
sx
;

808 
dy
 = 
sy
;

810 ià(
cÚf
->
fž‹r
 =ð
NGX_HTTP_IMAGE_RESIZE
) {

812 ià((
ngx_ušt_t
è
dx
 > 
ùx
->
max_width
) {

813 
dy
 = dy * 
ùx
->
max_width
 / 
dx
;

814 
dy
 = dy ? dy : 1;

815 
dx
 = 
ùx
->
max_width
;

818 ià((
ngx_ušt_t
è
dy
 > 
ùx
->
max_height
) {

819 
dx
 = dx * 
ùx
->
max_height
 / 
dy
;

820 
dx
 = dx ? dx : 1;

821 
dy
 = 
ùx
->
max_height
;

824 
»size
 = 1;

826 } ià(
cÚf
->
fž‹r
 =ð
NGX_HTTP_IMAGE_ROTATE
) {

828 
»size
 = 0;

832 
»size
 = 0;

834 ià((è
dx
 / 
dy
 < (è
ùx
->
max_width
 / ctx->
max_height
) {

835 ià((
ngx_ušt_t
è
dx
 > 
ùx
->
max_width
) {

836 
dy
 = dy * 
ùx
->
max_width
 / 
dx
;

837 
dy
 = dy ? dy : 1;

838 
dx
 = 
ùx
->
max_width
;

839 
»size
 = 1;

843 ià((
ngx_ušt_t
è
dy
 > 
ùx
->
max_height
) {

844 
dx
 = dx * 
ùx
->
max_height
 / 
dy
;

845 
dx
 = dx ? dx : 1;

846 
dy
 = 
ùx
->
max_height
;

847 
»size
 = 1;

852 ià(
»size
) {

853 
d¡
 = 
	`ngx_h‰p_image_Ãw
(
r
, 
dx
, 
dy
, 
·Ë‰e
);

854 ià(
d¡
 =ð
NULL
) {

855 
	`gdImageDe¡roy
(
¤c
);

856  
NULL
;

859 ià(
cÞÜs
 == 0) {

860 
	`gdImageSaveAÍha
(
d¡
, 1);

861 
	`gdImageAÍhaBËndšg
(
d¡
, 0);

864 
	`gdImageCÝyRe§m¶ed
(
d¡
, 
¤c
, 0, 0, 0, 0, 
dx
, 
dy
, 
sx
, 
sy
);

866 ià(
cÞÜs
) {

867 
	`gdImageTrueCÞÜToP®‘‹
(
d¡
, 1, 256);

870 
	`gdImageDe¡roy
(
¤c
);

873 
d¡
 = 
¤c
;

876 ià(
ùx
->
ªgË
) {

877 
¤c
 = 
d¡
;

879 
ax
 = (
dx
 % 2 == 0) ? 1 : 0;

880 
ay
 = (
dy
 % 2 == 0) ? 1 : 0;

882 
ùx
->
ªgË
) {

886 
d¡
 = 
	`ngx_h‰p_image_Ãw
(
r
, 
dy
, 
dx
, 
·Ë‰e
);

887 ià(
d¡
 =ð
NULL
) {

888 
	`gdImageDe¡roy
(
¤c
);

889  
NULL
;

891 ià(
ùx
->
ªgË
 == 90) {

892 
ox
 = 
dy
 / 2 + 
ay
;

893 
oy
 = 
dx
 / 2 - 
ax
;

896 
ox
 = 
dy
 / 2 - 
ay
;

897 
oy
 = 
dx
 / 2 + 
ax
;

900 
	`gdImageCÝyRÙ©ed
(
d¡
, 
¤c
, 
ox
, 
oy
, 0, 0,

901 
dx
 + 
ax
, 
dy
 + 
ay
, 
ùx
->
ªgË
);

902 
	`gdImageDe¡roy
(
¤c
);

904 
t
 = 
dx
;

905 
dx
 = 
dy
;

906 
dy
 = 
t
;

910 
d¡
 = 
	`ngx_h‰p_image_Ãw
(
r
, 
dx
, 
dy
, 
·Ë‰e
);

911 ià(
d¡
 =ð
NULL
) {

912 
	`gdImageDe¡roy
(
¤c
);

913  
NULL
;

915 
	`gdImageCÝyRÙ©ed
(
d¡
, 
¤c
, 
dx
 / 2 - 
ax
, 
dy
 / 2 - 
ay
, 0, 0,

916 
dx
 + 
ax
, 
dy
 + 
ay
, 
ùx
->
ªgË
);

917 
	`gdImageDe¡roy
(
¤c
);

922 ià(
cÚf
->
fž‹r
 =ð
NGX_HTTP_IMAGE_CROP
) {

924 
¤c
 = 
d¡
;

926 ià((
ngx_ušt_t
è
dx
 > 
ùx
->
max_width
) {

927 
ox
 = 
dx
 - 
ùx
->
max_width
;

930 
ox
 = 0;

933 ià((
ngx_ušt_t
è
dy
 > 
ùx
->
max_height
) {

934 
oy
 = 
dy
 - 
ùx
->
max_height
;

937 
oy
 = 0;

940 ià(
ox
 || 
oy
) {

942 
d¡
 = 
	`ngx_h‰p_image_Ãw
(
r
, 
dx
 - 
ox
, 
dy
 - 
oy
, 
cÞÜs
);

944 ià(
d¡
 =ð
NULL
) {

945 
	`gdImageDe¡roy
(
¤c
);

946  
NULL
;

949 
ox
 /= 2;

950 
oy
 /= 2;

952 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

954 
dx
, 
dy
, 
ox
, 
oy
);

956 ià(
cÞÜs
 == 0) {

957 
	`gdImageSaveAÍha
(
d¡
, 1);

958 
	`gdImageAÍhaBËndšg
(
d¡
, 0);

961 
	`gdImageCÝy
(
d¡
, 
¤c
, 0, 0, 
ox
, 
oy
, 
dx
 - ox, 
dy
 - oy);

963 ià(
cÞÜs
) {

964 
	`gdImageTrueCÞÜToP®‘‹
(
d¡
, 1, 256);

967 
	`gdImageDe¡roy
(
¤c
);

971 ià(
Œª¥¬’t
 !ð-1 && 
cÞÜs
) {

972 
	`gdImageCÞÜT¿n¥¬’t
(
d¡
, 
	`gdImageCÞÜExaù
(d¡, 
»d
, 
g»’
, 
blue
));

975 
sh¬³n
 = 
	`ngx_h‰p_image_fž‹r_g‘_v®ue
(
r
, 
cÚf
->
shcv
, conf->sharpen);

976 ià(
sh¬³n
 > 0) {

977 
	`gdImageSh¬³n
(
d¡
, 
sh¬³n
);

980 
	`gdImageIÁ”Ïû
(
d¡
, (è
cÚf
->
š‹¾aû
);

982 
out
 = 
	`ngx_h‰p_image_out
(
r
, 
ùx
->
ty³
, 
d¡
, &
size
);

984 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

985 "image: %d x %d %d", 
sx
, 
sy
, 
cÞÜs
);

987 
	`gdImageDe¡roy
(
d¡
);

988 
	`ngx_pä“
(
r
->
poÞ
, 
ùx
->
image
);

990 ià(
out
 =ð
NULL
) {

991  
NULL
;

994 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
r
->
poÞ
, 0);

995 ià(
þn
 =ð
NULL
) {

996 
	`gdF»e
(
out
);

997  
NULL
;

1000 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

1001 ià(
b
 =ð
NULL
) {

1002 
	`gdF»e
(
out
);

1003  
NULL
;

1006 
þn
->
hªdËr
 = 
ngx_h‰p_image_þ—nup
;

1007 
þn
->
d©a
 = 
out
;

1009 
b
->
pos
 = 
out
;

1010 
b
->
Ï¡
 = 
out
 + 
size
;

1011 
b
->
memÜy
 = 1;

1012 
b
->
Ï¡_buf
 = 1;

1014 
	`ngx_h‰p_image_Ëngth
(
r
, 
b
);

1015 
	`ngx_h‰p_w—k_‘ag
(
r
);

1017  
b
;

1018 
	}
}

1021 
gdImagePŒ


1022 
	$ngx_h‰p_image_sourû
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_image_fž‹r_ùx_t
 *
ùx
)

1024 *
çžed
;

1025 
gdImagePŒ
 
img
;

1027 
img
 = 
NULL
;

1029 
ùx
->
ty³
) {

1031 
NGX_HTTP_IMAGE_JPEG
:

1032 
img
 = 
	`gdImageC»©eFromJ³gPŒ
(
ùx
->
Ëngth
, ctx->
image
);

1033 
çžed
 = "gdImageCreateFromJpegPtr() failed";

1036 
NGX_HTTP_IMAGE_GIF
:

1037 
img
 = 
	`gdImageC»©eFromGifPŒ
(
ùx
->
Ëngth
, ctx->
image
);

1038 
çžed
 = "gdImageCreateFromGifPtr() failed";

1041 
NGX_HTTP_IMAGE_PNG
:

1042 
img
 = 
	`gdImageC»©eFromPngPŒ
(
ùx
->
Ëngth
, ctx->
image
);

1043 
çžed
 = "gdImageCreateFromPngPtr() failed";

1047 
çžed
 = "unknown imageype";

1051 ià(
img
 =ð
NULL
) {

1052 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0, 
çžed
);

1055  
img
;

1056 
	}
}

1059 
gdImagePŒ


1060 
	$ngx_h‰p_image_Ãw
(
ngx_h‰p_»que¡_t
 *
r
, 
w
, 
h
, 
cÞÜs
)

1062 
gdImagePŒ
 
img
;

1064 ià(
cÞÜs
 == 0) {

1065 
img
 = 
	`gdImageC»©eTrueCÞÜ
(
w
, 
h
);

1067 ià(
img
 =ð
NULL
) {

1068 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1070  
NULL
;

1074 
img
 = 
	`gdImageC»©e
(
w
, 
h
);

1076 ià(
img
 =ð
NULL
) {

1077 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1079  
NULL
;

1083  
img
;

1084 
	}
}

1087 
u_ch¬
 *

1088 
	$ngx_h‰p_image_out
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
ty³
, 
gdImagePŒ
 
img
,

1089 *
size
)

1091 *
çžed
;

1092 
u_ch¬
 *
out
;

1093 
ngx_št_t
 
jq
;

1094 
ngx_h‰p_image_fž‹r_cÚf_t
 *
cÚf
;

1096 
out
 = 
NULL
;

1098 
ty³
) {

1100 
NGX_HTTP_IMAGE_JPEG
:

1101 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_image_fž‹r_moduË
);

1103 
jq
 = 
	`ngx_h‰p_image_fž‹r_g‘_v®ue
(
r
, 
cÚf
->
jqcv
, cÚf->
j³g_qu®™y
);

1104 ià(
jq
 <= 0) {

1105  
NULL
;

1108 
out
 = 
	`gdImageJ³gPŒ
(
img
, 
size
, 
jq
);

1109 
çžed
 = "gdImageJpegPtr() failed";

1112 
NGX_HTTP_IMAGE_GIF
:

1113 
out
 = 
	`gdImageGifPŒ
(
img
, 
size
);

1114 
çžed
 = "gdImageGifPtr() failed";

1117 
NGX_HTTP_IMAGE_PNG
:

1118 
out
 = 
	`gdImagePngPŒ
(
img
, 
size
);

1119 
çžed
 = "gdImagePngPtr() failed";

1123 
çžed
 = "unknown imageype";

1127 ià(
out
 =ð
NULL
) {

1128 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0, 
çžed
);

1131  
out
;

1132 
	}
}

1136 
	$ngx_h‰p_image_þ—nup
(*
d©a
)

1138 
	`gdF»e
(
d©a
);

1139 
	}
}

1142 
ngx_ušt_t


1143 
	$ngx_h‰p_image_fž‹r_g‘_v®ue
(
ngx_h‰p_»que¡_t
 *
r
,

1144 
ngx_h‰p_com¶ex_v®ue_t
 *
cv
, 
ngx_ušt_t
 
v
)

1146 
ngx_¡r_t
 
v®
;

1148 ià(
cv
 =ð
NULL
) {

1149  
v
;

1152 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
cv
, &
v®
è!ð
NGX_OK
) {

1156  
	`ngx_h‰p_image_fž‹r_v®ue
(&
v®
);

1157 
	}
}

1160 
ngx_ušt_t


1161 
	$ngx_h‰p_image_fž‹r_v®ue
(
ngx_¡r_t
 *
v®ue
)

1163 
ngx_št_t
 
n
;

1165 ià(
v®ue
->
Ën
 =ð1 && v®ue->
d©a
[0] == '-') {

1166  (
ngx_ušt_t
) -1;

1169 
n
 = 
	`ngx_©oi
(
v®ue
->
d©a
, v®ue->
Ën
);

1171 ià(
n
 > 0) {

1172  (
ngx_ušt_t
è
n
;

1176 
	}
}

1180 
	$ngx_h‰p_image_fž‹r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

1182 
ngx_h‰p_image_fž‹r_cÚf_t
 *
cÚf
;

1184 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_image_fž‹r_cÚf_t
));

1185 ià(
cÚf
 =ð
NULL
) {

1186  
NULL
;

1202 
cÚf
->
fž‹r
 = 
NGX_CONF_UNSET_UINT
;

1203 
cÚf
->
j³g_qu®™y
 = 
NGX_CONF_UNSET_UINT
;

1204 
cÚf
->
sh¬³n
 = 
NGX_CONF_UNSET_UINT
;

1205 
cÚf
->
Œª¥¬’cy
 = 
NGX_CONF_UNSET
;

1206 
cÚf
->
š‹¾aû
 = 
NGX_CONF_UNSET
;

1207 
cÚf
->
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

1209  
cÚf
;

1210 
	}
}

1214 
	$ngx_h‰p_image_fž‹r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1216 
ngx_h‰p_image_fž‹r_cÚf_t
 *
´ev
 = 
·»Á
;

1217 
ngx_h‰p_image_fž‹r_cÚf_t
 *
cÚf
 = 
chžd
;

1219 ià(
cÚf
->
fž‹r
 =ð
NGX_CONF_UNSET_UINT
) {

1221 ià(
´ev
->
fž‹r
 =ð
NGX_CONF_UNSET_UINT
) {

1222 
cÚf
->
fž‹r
 = 
NGX_HTTP_IMAGE_OFF
;

1225 
cÚf
->
fž‹r
 = 
´ev
->filter;

1226 
cÚf
->
width
 = 
´ev
->width;

1227 
cÚf
->
height
 = 
´ev
->height;

1228 
cÚf
->
ªgË
 = 
´ev
->angle;

1229 
cÚf
->
wcv
 = 
´ev
->wcv;

1230 
cÚf
->
hcv
 = 
´ev
->hcv;

1231 
cÚf
->
acv
 = 
´ev
->acv;

1235 ià(
cÚf
->
j³g_qu®™y
 =ð
NGX_CONF_UNSET_UINT
) {

1238 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
j³g_qu®™y
, 
´ev
->jpeg_quality, 75);

1240 ià(
cÚf
->
jqcv
 =ð
NULL
) {

1241 
cÚf
->
jqcv
 = 
´ev
->jqcv;

1245 ià(
cÚf
->
sh¬³n
 =ð
NGX_CONF_UNSET_UINT
) {

1246 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
sh¬³n
, 
´ev
->sharpen, 0);

1248 ià(
cÚf
->
shcv
 =ð
NULL
) {

1249 
cÚf
->
shcv
 = 
´ev
->shcv;

1253 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
Œª¥¬’cy
, 
´ev
->transparency, 1);

1255 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
š‹¾aû
, 
´ev
->interlace, 0);

1257 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
bufãr_size
, 
´ev
->buffer_size,

1260  
NGX_CONF_OK
;

1261 
	}
}

1265 
	$ngx_h‰p_image_fž‹r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1267 
ngx_h‰p_image_fž‹r_cÚf_t
 *
imcf
 = 
cÚf
;

1269 
ngx_¡r_t
 *
v®ue
;

1270 
ngx_št_t
 
n
;

1271 
ngx_ušt_t
 
i
;

1272 
ngx_h‰p_com¶ex_v®ue_t
 
cv
;

1273 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

1275 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1277 
i
 = 1;

1279 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

1280 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "off") == 0) {

1281 
imcf
->
fž‹r
 = 
NGX_HTTP_IMAGE_OFF
;

1283 } ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "test") == 0) {

1284 
imcf
->
fž‹r
 = 
NGX_HTTP_IMAGE_TEST
;

1286 } ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "size") == 0) {

1287 
imcf
->
fž‹r
 = 
NGX_HTTP_IMAGE_SIZE
;

1290 
çžed
;

1293  
NGX_CONF_OK
;

1295 } ià(
cf
->
¬gs
->
ÃÉs
 == 3) {

1297 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "rotate") == 0) {

1298 ià(
imcf
->
fž‹r
 !ð
NGX_HTTP_IMAGE_RESIZE


1299 && 
imcf
->
fž‹r
 !ð
NGX_HTTP_IMAGE_CROP
)

1301 
imcf
->
fž‹r
 = 
NGX_HTTP_IMAGE_ROTATE
;

1304 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

1306 
ccv
.
cf
 = cf;

1307 
ccv
.
v®ue
 = &v®ue[++
i
];

1308 
ccv
.
com¶ex_v®ue
 = &
cv
;

1310 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

1311  
NGX_CONF_ERROR
;

1314 ià(
cv
.
Ëngths
 =ð
NULL
) {

1315 
n
 = 
	`ngx_h‰p_image_fž‹r_v®ue
(&
v®ue
[
i
]);

1317 ià(
n
 != 90 &&‚ != 180 &&‚ != 270) {

1318 
çžed
;

1321 
imcf
->
ªgË
 = (
ngx_ušt_t
è
n
;

1324 
imcf
->
acv
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,

1325 (
ngx_h‰p_com¶ex_v®ue_t
));

1326 ià(
imcf
->
acv
 =ð
NULL
) {

1327  
NGX_CONF_ERROR
;

1330 *
imcf
->
acv
 = 
cv
;

1333  
NGX_CONF_OK
;

1336 
çžed
;

1340 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "resize") == 0) {

1341 
imcf
->
fž‹r
 = 
NGX_HTTP_IMAGE_RESIZE
;

1343 } ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "crop") == 0) {

1344 
imcf
->
fž‹r
 = 
NGX_HTTP_IMAGE_CROP
;

1347 
çžed
;

1350 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

1352 
ccv
.
cf
 = cf;

1353 
ccv
.
v®ue
 = &v®ue[++
i
];

1354 
ccv
.
com¶ex_v®ue
 = &
cv
;

1356 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

1357  
NGX_CONF_ERROR
;

1360 ià(
cv
.
Ëngths
 =ð
NULL
) {

1361 
n
 = 
	`ngx_h‰p_image_fž‹r_v®ue
(&
v®ue
[
i
]);

1363 ià(
n
 == 0) {

1364 
çžed
;

1367 
imcf
->
width
 = (
ngx_ušt_t
è
n
;

1370 
imcf
->
wcv
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_com¶ex_v®ue_t
));

1371 ià(
imcf
->
wcv
 =ð
NULL
) {

1372  
NGX_CONF_ERROR
;

1375 *
imcf
->
wcv
 = 
cv
;

1378 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

1380 
ccv
.
cf
 = cf;

1381 
ccv
.
v®ue
 = &v®ue[++
i
];

1382 
ccv
.
com¶ex_v®ue
 = &
cv
;

1384 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

1385  
NGX_CONF_ERROR
;

1388 ià(
cv
.
Ëngths
 =ð
NULL
) {

1389 
n
 = 
	`ngx_h‰p_image_fž‹r_v®ue
(&
v®ue
[
i
]);

1391 ià(
n
 == 0) {

1392 
çžed
;

1395 
imcf
->
height
 = (
ngx_ušt_t
è
n
;

1398 
imcf
->
hcv
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_com¶ex_v®ue_t
));

1399 ià(
imcf
->
hcv
 =ð
NULL
) {

1400  
NGX_CONF_ERROR
;

1403 *
imcf
->
hcv
 = 
cv
;

1406  
NGX_CONF_OK
;

1408 
çžed
:

1410 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "invalid…arameter \"%V\"",

1411 &
v®ue
[
i
]);

1413  
NGX_CONF_ERROR
;

1414 
	}
}

1418 
	$ngx_h‰p_image_fž‹r_j³g_qu®™y
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

1419 *
cÚf
)

1421 
ngx_h‰p_image_fž‹r_cÚf_t
 *
imcf
 = 
cÚf
;

1423 
ngx_¡r_t
 *
v®ue
;

1424 
ngx_št_t
 
n
;

1425 
ngx_h‰p_com¶ex_v®ue_t
 
cv
;

1426 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

1428 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1430 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

1432 
ccv
.
cf
 = cf;

1433 
ccv
.
v®ue
 = &value[1];

1434 
ccv
.
com¶ex_v®ue
 = &
cv
;

1436 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

1437  
NGX_CONF_ERROR
;

1440 ià(
cv
.
Ëngths
 =ð
NULL
) {

1441 
n
 = 
	`ngx_h‰p_image_fž‹r_v®ue
(&
v®ue
[1]);

1443 ià(
n
 <= 0) {

1444 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1445 "šv®id v®u\"%V\"", &
v®ue
[1]);

1446  
NGX_CONF_ERROR
;

1449 
imcf
->
j³g_qu®™y
 = (
ngx_ušt_t
è
n
;

1452 
imcf
->
jqcv
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_com¶ex_v®ue_t
));

1453 ià(
imcf
->
jqcv
 =ð
NULL
) {

1454  
NGX_CONF_ERROR
;

1457 *
imcf
->
jqcv
 = 
cv
;

1460  
NGX_CONF_OK
;

1461 
	}
}

1465 
	$ngx_h‰p_image_fž‹r_sh¬³n
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

1466 *
cÚf
)

1468 
ngx_h‰p_image_fž‹r_cÚf_t
 *
imcf
 = 
cÚf
;

1470 
ngx_¡r_t
 *
v®ue
;

1471 
ngx_št_t
 
n
;

1472 
ngx_h‰p_com¶ex_v®ue_t
 
cv
;

1473 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

1475 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1477 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

1479 
ccv
.
cf
 = cf;

1480 
ccv
.
v®ue
 = &value[1];

1481 
ccv
.
com¶ex_v®ue
 = &
cv
;

1483 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

1484  
NGX_CONF_ERROR
;

1487 ià(
cv
.
Ëngths
 =ð
NULL
) {

1488 
n
 = 
	`ngx_h‰p_image_fž‹r_v®ue
(&
v®ue
[1]);

1490 ià(
n
 < 0) {

1491 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1492 "šv®id v®u\"%V\"", &
v®ue
[1]);

1493  
NGX_CONF_ERROR
;

1496 
imcf
->
sh¬³n
 = (
ngx_ušt_t
è
n
;

1499 
imcf
->
shcv
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_com¶ex_v®ue_t
));

1500 ià(
imcf
->
shcv
 =ð
NULL
) {

1501  
NGX_CONF_ERROR
;

1504 *
imcf
->
shcv
 = 
cv
;

1507  
NGX_CONF_OK
;

1508 
	}
}

1511 
ngx_št_t


1512 
	$ngx_h‰p_image_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

1514 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

1515 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_image_h—d”_fž‹r
;

1517 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

1518 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_image_body_fž‹r
;

1520  
NGX_OK
;

1521 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_index_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_¡r_t
 
	mÇme
;

15 
ngx_¬¿y_t
 *
	mËngths
;

16 
ngx_¬¿y_t
 *
	mv®ues
;

17 } 
	tngx_h‰p_šdex_t
;

21 
ngx_¬¿y_t
 *
	mšdiûs
;

22 
size_t
 
	mmax_šdex_Ën
;

23 } 
	tngx_h‰p_šdex_loc_cÚf_t
;

26 
	#NGX_HTTP_DEFAULT_INDEX
 "šdex.html"

	)

29 
ngx_št_t
 
ngx_h‰p_šdex_‹¡_dœ
(
ngx_h‰p_»que¡_t
 *
r
,

30 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, 
u_ch¬
 *
·th
, u_ch¬ *
Ï¡
);

31 
ngx_št_t
 
ngx_h‰p_šdex_”rÜ
(
ngx_h‰p_»que¡_t
 *
r
,

32 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, 
u_ch¬
 *
fže
, 
ngx_”r_t
 
”r
);

34 
ngx_št_t
 
ngx_h‰p_šdex_š™
(
ngx_cÚf_t
 *
cf
);

35 *
ngx_h‰p_šdex_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

36 *
ngx_h‰p_šdex_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

37 *
·»Á
, *
chžd
);

38 *
ngx_h‰p_šdex_£t_šdex
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

39 *
cÚf
);

42 
ngx_commªd_t
 
	gngx_h‰p_šdex_commªds
[] = {

44 { 
ngx_¡ršg
("index"),

45 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

46 
ngx_h‰p_šdex_£t_šdex
,

47 
NGX_HTTP_LOC_CONF_OFFSET
,

49 
NULL
 },

51 
ngx_nuÎ_commªd


55 
ngx_h‰p_moduË_t
 
	gngx_h‰p_šdex_moduË_ùx
 = {

56 
NULL
,

57 
ngx_h‰p_šdex_š™
,

59 
NULL
,

60 
NULL
,

62 
NULL
,

63 
NULL
,

65 
ngx_h‰p_šdex_ü—‹_loc_cÚf
,

66 
ngx_h‰p_šdex_m”ge_loc_cÚf


70 
ngx_moduË_t
 
	gngx_h‰p_šdex_moduË
 = {

71 
NGX_MODULE_V1
,

72 &
ngx_h‰p_šdex_moduË_ùx
,

73 
ngx_h‰p_šdex_commªds
,

74 
NGX_HTTP_MODULE
,

75 
NULL
,

76 
NULL
,

77 
NULL
,

78 
NULL
,

79 
NULL
,

80 
NULL
,

81 
NULL
,

82 
NGX_MODULE_V1_PADDING


96 
ngx_št_t


97 
	$ngx_h‰p_šdex_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

99 
u_ch¬
 *
p
, *
Çme
;

100 
size_t
 
Ën
, 
roÙ
, 
»£rve
, 
®loÿ‹d
;

101 
ngx_št_t
 
rc
;

102 
ngx_¡r_t
 
·th
, 
uri
;

103 
ngx_ušt_t
 
i
, 
dœ_‹¡ed
;

104 
ngx_h‰p_šdex_t
 *
šdex
;

105 
ngx_Ý’_fže_šfo_t
 
of
;

106 
ngx_h‰p_süt_code_±
 
code
;

107 
ngx_h‰p_süt_’gše_t
 
e
;

108 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

109 
ngx_h‰p_šdex_loc_cÚf_t
 *
žcf
;

110 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

112 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] != '/') {

113  
NGX_DECLINED
;

116 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
|
NGX_HTTP_POST
))) {

117  
NGX_DECLINED
;

120 
žcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_šdex_moduË
);

121 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

123 
®loÿ‹d
 = 0;

124 
roÙ
 = 0;

125 
dœ_‹¡ed
 = 0;

126 
Çme
 = 
NULL
;

128 
·th
.
d©a
 = 
NULL
;

130 
šdex
 = 
žcf
->
šdiûs
->
–ts
;

131 
i
 = 0; i < 
žcf
->
šdiûs
->
ÃÉs
; i++) {

133 ià(
šdex
[
i
].
Ëngths
 =ð
NULL
) {

135 ià(
šdex
[
i
].
Çme
.
d©a
[0] == '/') {

136  
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
šdex
[
i
].
Çme
, &r->
¬gs
);

139 
»£rve
 = 
žcf
->
max_šdex_Ën
;

140 
Ën
 = 
šdex
[
i
].
Çme
.len;

143 
	`ngx_memz”o
(&
e
, (
ngx_h‰p_süt_’gše_t
));

145 
e
.

 = 
šdex
[
i
].
Ëngths
->
–ts
;

146 
e
.
»que¡
 = 
r
;

147 
e
.
æushed
 = 1;

150 
Ën
 = 1;

152 *(
ušŒ_t
 *è
e
.

) {

153 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
e
.

;

154 
Ën
 +ð
	`lcode
(&
e
);

159 
»£rve
 = 
Ën
 + 16;

162 ià(
»£rve
 > 
®loÿ‹d
) {

164 
Çme
 = 
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 
»£rve
);

165 ià(
Çme
 =ð
NULL
) {

166  
NGX_ERROR
;

169 
®loÿ‹d
 = 
·th
.
d©a
 +…©h.
Ën
 - 
Çme
;

172 ià(
šdex
[
i
].
v®ues
 =ð
NULL
) {

176 
	`ngx_memýy
(
Çme
, 
šdex
[
i
].Çme.
d©a
, index[i].Çme.
Ën
);

178 
·th
.
Ën
 = (
Çme
 + 
šdex
[
i
].Çme.ËÀ- 1è-…©h.
d©a
;

181 
e
.

 = 
šdex
[
i
].
v®ues
->
–ts
;

182 
e
.
pos
 = 
Çme
;

184 *(
ušŒ_t
 *è
e
.

) {

185 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

186 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

189 ià(*
Çme
 == '/') {

190 
uri
.
Ën
 =†en - 1;

191 
uri
.
d©a
 = 
Çme
;

192  
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
uri
, &r->
¬gs
);

195 
·th
.
Ën
 = 
e
.
pos
 -…©h.
d©a
;

197 *
e
.
pos
 = '\0';

200 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

201 "Ý’ index \"%V\"", &
·th
);

203 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

205 
of
.
»ad_ah—d
 = 
þcf
->read_ahead;

206 
of
.
dœeùio
 = 
þcf
->directio;

207 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

208 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

209 
of
.
‹¡_Úly
 = 1;

210 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

211 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

213 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
·th
, &
of
è!ð
NGX_OK
) {

214  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

217 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
·th
, &
of
, 
r
->
poÞ
)

218 !ð
NGX_OK
)

220 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 
of
.
”r
,

221 "% \"%s\" fažed", 
of
.
çžed
, 
·th
.
d©a
);

223 ià(
of
.
”r
 == 0) {

224  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

227 #ià(
NGX_HAVE_OPENAT
)

228 ià(
of
.
”r
 =ð
NGX_EMLINK


229 || 
of
.
”r
 =ð
NGX_ELOOP
)

231  
NGX_HTTP_FORBIDDEN
;

235 ià(
of
.
”r
 =ð
NGX_ENOTDIR


236 || 
of
.
”r
 =ð
NGX_ENAMETOOLONG


237 || 
of
.
”r
 =ð
NGX_EACCES
)

239  
	`ngx_h‰p_šdex_”rÜ
(
r
, 
þcf
, 
·th
.
d©a
, 
of
.
”r
);

242 ià(!
dœ_‹¡ed
) {

243 
rc
 = 
	`ngx_h‰p_šdex_‹¡_dœ
(
r
, 
þcf
, 
·th
.
d©a
, 
Çme
 - 1);

245 ià(
rc
 !ð
NGX_OK
) {

246  
rc
;

249 
dœ_‹¡ed
 = 1;

252 ià(
of
.
”r
 =ð
NGX_ENOENT
) {

256 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
of
.
”r
,

257 "% \"%s\" fažed", 
of
.
çžed
, 
·th
.
d©a
);

259  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

262 
uri
.
Ën
 = 
r
->uri.len +†en - 1;

264 ià(!
þcf
->
®Ÿs
) {

265 
uri
.
d©a
 = 
·th
.d©¨+ 
roÙ
;

268 
uri
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, uri.
Ën
);

269 ià(
uri
.
d©a
 =ð
NULL
) {

270  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

273 
p
 = 
	`ngx_cÝy
(
uri
.
d©a
, 
r
->uri.d©a,„->uri.
Ën
);

274 
	`ngx_memýy
(
p
, 
Çme
, 
Ën
 - 1);

277  
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
uri
, &r->
¬gs
);

280  
NGX_DECLINED
;

281 
	}
}

284 
ngx_št_t


285 
	$ngx_h‰p_šdex_‹¡_dœ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
,

286 
u_ch¬
 *
·th
, u_ch¬ *
Ï¡
)

288 
u_ch¬
 
c
;

289 
ngx_¡r_t
 
dœ
;

290 
ngx_Ý’_fže_šfo_t
 
of
;

292 
c
 = *
Ï¡
;

293 ià(
c
 !ð'/' || 
·th
 =ð
Ï¡
) {

295 
c
 = *(++
Ï¡
);

297 *
Ï¡
 = '\0';

299 
dœ
.
Ën
 = 
Ï¡
 - 
·th
;

300 
dœ
.
d©a
 = 
·th
;

302 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

303 "h‰°šdex check dœ: \"%V\"", &
dœ
);

305 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

307 
of
.
‹¡_dœ
 = 1;

308 
of
.
‹¡_Úly
 = 1;

309 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

310 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

312 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
dœ
, &
of
è!ð
NGX_OK
) {

313  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

316 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
dœ
, &
of
, 
r
->
poÞ
)

317 !ð
NGX_OK
)

319 ià(
of
.
”r
) {

321 #ià(
NGX_HAVE_OPENAT
)

322 ià(
of
.
”r
 =ð
NGX_EMLINK


323 || 
of
.
”r
 =ð
NGX_ELOOP
)

325  
NGX_HTTP_FORBIDDEN
;

329 ià(
of
.
”r
 =ð
NGX_ENOENT
) {

330 *
Ï¡
 = 
c
;

331  
	`ngx_h‰p_šdex_”rÜ
(
r
, 
þcf
, 
dœ
.
d©a
, 
NGX_ENOENT
);

334 ià(
of
.
”r
 =ð
NGX_EACCES
) {

336 *
Ï¡
 = 
c
;

344  
NGX_OK
;

347 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
of
.
”r
,

348 "% \"%s\" fažed", 
of
.
çžed
, 
dœ
.
d©a
);

351  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

354 *
Ï¡
 = 
c
;

356 ià(
of
.
is_dœ
) {

357  
NGX_OK
;

360 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

361 "\"%s\" i nÙ‡ dœeùÜy", 
dœ
.
d©a
);

363  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

364 
	}
}

367 
ngx_št_t


368 
	$ngx_h‰p_šdex_”rÜ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
,

369 
u_ch¬
 *
fže
, 
ngx_”r_t
 
”r
)

371 ià(
”r
 =ð
NGX_EACCES
) {

372 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

373 "\"%s\" i fÜbidd’", 
fže
);

375  
NGX_HTTP_FORBIDDEN
;

378 ià(
þcf
->
log_nÙ_found
) {

379 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

380 "\"%s\" i nÙ found", 
fže
);

383  
NGX_HTTP_NOT_FOUND
;

384 
	}
}

388 
	$ngx_h‰p_šdex_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

390 
ngx_h‰p_šdex_loc_cÚf_t
 *
cÚf
;

392 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_šdex_loc_cÚf_t
));

393 ià(
cÚf
 =ð
NULL
) {

394  
NULL
;

397 
cÚf
->
šdiûs
 = 
NULL
;

398 
cÚf
->
max_šdex_Ën
 = 0;

400  
cÚf
;

401 
	}
}

405 
	$ngx_h‰p_šdex_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

407 
ngx_h‰p_šdex_loc_cÚf_t
 *
´ev
 = 
·»Á
;

408 
ngx_h‰p_šdex_loc_cÚf_t
 *
cÚf
 = 
chžd
;

410 
ngx_h‰p_šdex_t
 *
šdex
;

412 ià(
cÚf
->
šdiûs
 =ð
NULL
) {

413 
cÚf
->
šdiûs
 = 
´ev
->indices;

414 
cÚf
->
max_šdex_Ën
 = 
´ev
->max_index_len;

417 ià(
cÚf
->
šdiûs
 =ð
NULL
) {

418 
cÚf
->
šdiûs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1, (
ngx_h‰p_šdex_t
));

419 ià(
cÚf
->
šdiûs
 =ð
NULL
) {

420  
NGX_CONF_ERROR
;

423 
šdex
 = 
	`ngx_¬¿y_push
(
cÚf
->
šdiûs
);

424 ià(
šdex
 =ð
NULL
) {

425  
NGX_CONF_ERROR
;

428 
šdex
->
Çme
.
Ën
 = (
NGX_HTTP_DEFAULT_INDEX
);

429 
šdex
->
Çme
.
d©a
 = (
u_ch¬
 *è
NGX_HTTP_DEFAULT_INDEX
;

430 
šdex
->
Ëngths
 = 
NULL
;

431 
šdex
->
v®ues
 = 
NULL
;

433 
cÚf
->
max_šdex_Ën
 = (
NGX_HTTP_DEFAULT_INDEX
);

435  
NGX_CONF_OK
;

438  
NGX_CONF_OK
;

439 
	}
}

442 
ngx_št_t


443 
	$ngx_h‰p_šdex_š™
(
ngx_cÚf_t
 *
cf
)

445 
ngx_h‰p_hªdËr_±
 *
h
;

446 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

448 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

450 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_CONTENT_PHASE
].
hªdËrs
);

451 ià(
h
 =ð
NULL
) {

452  
NGX_ERROR
;

455 *
h
 = 
ngx_h‰p_šdex_hªdËr
;

457  
NGX_OK
;

458 
	}
}

464 
	$ngx_h‰p_šdex_£t_šdex
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

466 
ngx_h‰p_šdex_loc_cÚf_t
 *
žcf
 = 
cÚf
;

468 
ngx_¡r_t
 *
v®ue
;

469 
ngx_ušt_t
 
i
, 
n
;

470 
ngx_h‰p_šdex_t
 *
šdex
;

471 
ngx_h‰p_süt_compže_t
 
sc
;

473 ià(
žcf
->
šdiûs
 =ð
NULL
) {

474 
žcf
->
šdiûs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 2, (
ngx_h‰p_šdex_t
));

475 ià(
žcf
->
šdiûs
 =ð
NULL
) {

476  
NGX_CONF_ERROR
;

480 
v®ue
 = 
cf
->
¬gs
->
–ts
;

482 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

484 ià(
v®ue
[
i
].
d©a
[0] =ð'/' && i !ð
cf
->
¬gs
->
ÃÉs
 - 1) {

485 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

490 ià(
v®ue
[
i
].
Ën
 == 0) {

491 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

493 &
v®ue
[1]);

494  
NGX_CONF_ERROR
;

497 
šdex
 = 
	`ngx_¬¿y_push
(
žcf
->
šdiûs
);

498 ià(
šdex
 =ð
NULL
) {

499  
NGX_CONF_ERROR
;

502 
šdex
->
Çme
.
Ën
 = 
v®ue
[
i
].len;

503 
šdex
->
Çme
.
d©a
 = 
v®ue
[
i
].data;

504 
šdex
->
Ëngths
 = 
NULL
;

505 
šdex
->
v®ues
 = 
NULL
;

507 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
v®ue
[
i
]);

509 ià(
n
 == 0) {

510 ià(
žcf
->
max_šdex_Ën
 < 
šdex
->
Çme
.
Ën
) {

511 
žcf
->
max_šdex_Ën
 = 
šdex
->
Çme
.
Ën
;

514 ià(
šdex
->
Çme
.
d©a
[0] == '/') {

519 
šdex
->
Çme
.
Ën
++;

524 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

526 
sc
.
cf
 = cf;

527 
sc
.
sourû
 = &
v®ue
[
i
];

528 
sc
.
Ëngths
 = &
šdex
->lengths;

529 
sc
.
v®ues
 = &
šdex
->values;

530 
sc
.
v¬ŸbËs
 = 
n
;

531 
sc
.
com¶‘e_Ëngths
 = 1;

532 
sc
.
com¶‘e_v®ues
 = 1;

534 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

535  
NGX_CONF_ERROR
;

539  
NGX_CONF_OK
;

540 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_limit_conn_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
u_ch¬
 
	mcÞÜ
;

15 
u_ch¬
 
	mËn
;

16 
u_shÜt
 
	mcÚn
;

17 
u_ch¬
 
	md©a
[1];

18 } 
	tngx_h‰p_lim™_cÚn_node_t
;

22 
ngx_shm_zÚe_t
 *
	mshm_zÚe
;

23 
ngx_rbŒ“_node_t
 *
	mnode
;

24 } 
	tngx_h‰p_lim™_cÚn_þ—nup_t
;

28 
ngx_rbŒ“_t
 *
	mrbŒ“
;

29 
ngx_h‰p_com¶ex_v®ue_t
 
	mkey
;

30 } 
	tngx_h‰p_lim™_cÚn_ùx_t
;

34 
ngx_shm_zÚe_t
 *
	mshm_zÚe
;

35 
ngx_ušt_t
 
	mcÚn
;

36 } 
	tngx_h‰p_lim™_cÚn_lim™_t
;

40 
ngx_¬¿y_t
 
	mlim™s
;

41 
ngx_ušt_t
 
	mlog_Ëv–
;

42 
ngx_ušt_t
 
	m¡©us_code
;

43 } 
	tngx_h‰p_lim™_cÚn_cÚf_t
;

46 
ngx_rbŒ“_node_t
 *
ngx_h‰p_lim™_cÚn_lookup
(
ngx_rbŒ“_t
 *
rbŒ“
,

47 
ngx_¡r_t
 *
key
, 
ušt32_t
 
hash
);

48 
ngx_h‰p_lim™_cÚn_þ—nup
(*
d©a
);

49 
ngx_šlše
 
ngx_h‰p_lim™_cÚn_þ—nup_®l
(
ngx_poÞ_t
 *
poÞ
);

51 *
ngx_h‰p_lim™_cÚn_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

52 *
ngx_h‰p_lim™_cÚn_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

53 *
chžd
);

54 *
ngx_h‰p_lim™_cÚn_zÚe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

55 *
cÚf
);

56 *
ngx_h‰p_lim™_cÚn
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

57 *
cÚf
);

58 
ngx_št_t
 
ngx_h‰p_lim™_cÚn_š™
(
ngx_cÚf_t
 *
cf
);

61 
ngx_cÚf_’um_t
 
	gngx_h‰p_lim™_cÚn_log_Ëv–s
[] = {

62 { 
ngx_¡ršg
("šfo"), 
NGX_LOG_INFO
 },

63 { 
ngx_¡ršg
("nÙiû"), 
NGX_LOG_NOTICE
 },

64 { 
ngx_¡ršg
("w¬n"), 
NGX_LOG_WARN
 },

65 { 
ngx_¡ršg
("”rÜ"), 
NGX_LOG_ERR
 },

66 { 
ngx_nuÎ_¡ršg
, 0 }

70 
ngx_cÚf_num_bounds_t
 
	gngx_h‰p_lim™_cÚn_¡©us_bounds
 = {

71 
ngx_cÚf_check_num_bounds
, 400, 599

75 
ngx_commªd_t
 
	gngx_h‰p_lim™_cÚn_commªds
[] = {

77 { 
ngx_¡ršg
("limit_conn_zone"),

78 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE2
,

79 
ngx_h‰p_lim™_cÚn_zÚe
,

82 
NULL
 },

84 { 
ngx_¡ršg
("limit_conn"),

85 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

86 
ngx_h‰p_lim™_cÚn
,

87 
NGX_HTTP_LOC_CONF_OFFSET
,

89 
NULL
 },

91 { 
ngx_¡ršg
("limit_conn_log_level"),

92 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

93 
ngx_cÚf_£t_’um_¦Ù
,

94 
NGX_HTTP_LOC_CONF_OFFSET
,

95 
off£tof
(
ngx_h‰p_lim™_cÚn_cÚf_t
, 
log_Ëv–
),

96 &
ngx_h‰p_lim™_cÚn_log_Ëv–s
 },

98 { 
ngx_¡ršg
("limit_conn_status"),

99 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

100 
ngx_cÚf_£t_num_¦Ù
,

101 
NGX_HTTP_LOC_CONF_OFFSET
,

102 
off£tof
(
ngx_h‰p_lim™_cÚn_cÚf_t
, 
¡©us_code
),

103 &
ngx_h‰p_lim™_cÚn_¡©us_bounds
 },

105 
ngx_nuÎ_commªd


109 
ngx_h‰p_moduË_t
 
	gngx_h‰p_lim™_cÚn_moduË_ùx
 = {

110 
NULL
,

111 
ngx_h‰p_lim™_cÚn_š™
,

113 
NULL
,

114 
NULL
,

116 
NULL
,

117 
NULL
,

119 
ngx_h‰p_lim™_cÚn_ü—‹_cÚf
,

120 
ngx_h‰p_lim™_cÚn_m”ge_cÚf


124 
ngx_moduË_t
 
	gngx_h‰p_lim™_cÚn_moduË
 = {

125 
NGX_MODULE_V1
,

126 &
ngx_h‰p_lim™_cÚn_moduË_ùx
,

127 
ngx_h‰p_lim™_cÚn_commªds
,

128 
NGX_HTTP_MODULE
,

129 
NULL
,

130 
NULL
,

131 
NULL
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NGX_MODULE_V1_PADDING


140 
ngx_št_t


141 
	$ngx_h‰p_lim™_cÚn_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

143 
size_t
 
n
;

144 
ušt32_t
 
hash
;

145 
ngx_¡r_t
 
key
;

146 
ngx_ušt_t
 
i
;

147 
ngx_¦ab_poÞ_t
 *
shpoÞ
;

148 
ngx_rbŒ“_node_t
 *
node
;

149 
ngx_poÞ_þ—nup_t
 *
þn
;

150 
ngx_h‰p_lim™_cÚn_ùx_t
 *
ùx
;

151 
ngx_h‰p_lim™_cÚn_node_t
 *
lc
;

152 
ngx_h‰p_lim™_cÚn_cÚf_t
 *
lccf
;

153 
ngx_h‰p_lim™_cÚn_lim™_t
 *
lim™s
;

154 
ngx_h‰p_lim™_cÚn_þ—nup_t
 *
lcþn
;

156 ià(
r
->
maš
->
lim™_cÚn_£t
) {

157  
NGX_DECLINED
;

160 
lccf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_lim™_cÚn_moduË
);

161 
lim™s
 = 
lccf
->lim™s.
–ts
;

163 
i
 = 0; i < 
lccf
->
lim™s
.
ÃÉs
; i++) {

164 
ùx
 = 
lim™s
[
i
].
shm_zÚe
->
d©a
;

166 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
ùx
->
key
, &keyè!ð
NGX_OK
) {

167  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

170 ià(
key
.
Ën
 == 0) {

174 ià(
key
.
Ën
 > 255) {

175 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

178 &
ùx
->
key
.
v®ue
, &key);

182 
r
->
maš
->
lim™_cÚn_£t
 = 1;

184 
hash
 = 
	`ngx_üc32_shÜt
(
key
.
d©a
, key.
Ën
);

186 
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
lim™s
[
i
].
shm_zÚe
->
shm
.
addr
;

188 
	`ngx_shmtx_lock
(&
shpoÞ
->
mu‹x
);

190 
node
 = 
	`ngx_h‰p_lim™_cÚn_lookup
(
ùx
->
rbŒ“
, &
key
, 
hash
);

192 ià(
node
 =ð
NULL
) {

194 
n
 = 
	`off£tof
(
ngx_rbŒ“_node_t
, 
cÞÜ
)

195 + 
	`off£tof
(
ngx_h‰p_lim™_cÚn_node_t
, 
d©a
)

196 + 
key
.
Ën
;

198 
node
 = 
	`ngx_¦ab_®loc_locked
(
shpoÞ
, 
n
);

200 ià(
node
 =ð
NULL
) {

201 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

202 
	`ngx_h‰p_lim™_cÚn_þ—nup_®l
(
r
->
poÞ
);

203  
lccf
->
¡©us_code
;

206 
lc
 = (
ngx_h‰p_lim™_cÚn_node_t
 *è&
node
->
cÞÜ
;

208 
node
->
key
 = 
hash
;

209 
lc
->
Ën
 = (
u_ch¬
è
key
.len;

210 
lc
->
cÚn
 = 1;

211 
	`ngx_memýy
(
lc
->
d©a
, 
key
.d©a, key.
Ën
);

213 
	`ngx_rbŒ“_š£¹
(
ùx
->
rbŒ“
, 
node
);

217 
lc
 = (
ngx_h‰p_lim™_cÚn_node_t
 *è&
node
->
cÞÜ
;

219 ià((
ngx_ušt_t
è
lc
->
cÚn
 >ð
lim™s
[
i
].conn) {

221 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

223 
	`ngx_log_”rÜ
(
lccf
->
log_Ëv–
, 
r
->
cÚÃùiÚ
->
log
, 0,

225 &
lim™s
[
i
].
shm_zÚe
->
shm
.
Çme
);

227 
	`ngx_h‰p_lim™_cÚn_þ—nup_®l
(
r
->
poÞ
);

228  
lccf
->
¡©us_code
;

231 
lc
->
cÚn
++;

234 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

235 "lim™ cÚn: %08XD %d", 
node
->
key
, 
lc
->
cÚn
);

237 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

239 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
r
->
poÞ
,

240 (
ngx_h‰p_lim™_cÚn_þ—nup_t
));

241 ià(
þn
 =ð
NULL
) {

242  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

245 
þn
->
hªdËr
 = 
ngx_h‰p_lim™_cÚn_þ—nup
;

246 
lcþn
 = 
þn
->
d©a
;

248 
lcþn
->
shm_zÚe
 = 
lim™s
[
i
].shm_zone;

249 
lcþn
->
node
 =‚ode;

252  
NGX_DECLINED
;

253 
	}
}

257 
	$ngx_h‰p_lim™_cÚn_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

258 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
)

260 
ngx_rbŒ“_node_t
 **
p
;

261 
ngx_h‰p_lim™_cÚn_node_t
 *
lú
, *
lút
;

265 ià(
node
->
key
 < 
‹mp
->key) {

267 
p
 = &
‹mp
->
Ëá
;

269 } ià(
node
->
key
 > 
‹mp
->key) {

271 
p
 = &
‹mp
->
right
;

275 
lú
 = (
ngx_h‰p_lim™_cÚn_node_t
 *è&
node
->
cÞÜ
;

276 
lút
 = (
ngx_h‰p_lim™_cÚn_node_t
 *è&
‹mp
->
cÞÜ
;

278 
p
 = (
	`ngx_memn2cmp
(
lú
->
d©a
, 
lút
->d©a,†ú->
Ën
,†cnt->len) < 0)

279 ? &
‹mp
->
Ëá
 : &‹mp->
right
;

282 ià(*
p
 =ð
£Áš–
) {

286 
‹mp
 = *
p
;

289 *
p
 = 
node
;

290 
node
->
·»Á
 = 
‹mp
;

291 
node
->
Ëá
 = 
£Áš–
;

292 
node
->
right
 = 
£Áš–
;

293 
	`ngx_rbt_»d
(
node
);

294 
	}
}

297 
ngx_rbŒ“_node_t
 *

298 
	$ngx_h‰p_lim™_cÚn_lookup
(
ngx_rbŒ“_t
 *
rbŒ“
, 
ngx_¡r_t
 *
key
, 
ušt32_t
 
hash
)

300 
ngx_št_t
 
rc
;

301 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

302 
ngx_h‰p_lim™_cÚn_node_t
 *
lú
;

304 
node
 = 
rbŒ“
->
roÙ
;

305 
£Áš–
 = 
rbŒ“
->sentinel;

307 
node
 !ð
£Áš–
) {

309 ià(
hash
 < 
node
->
key
) {

310 
node
 =‚ode->
Ëá
;

314 ià(
hash
 > 
node
->
key
) {

315 
node
 =‚ode->
right
;

321 
lú
 = (
ngx_h‰p_lim™_cÚn_node_t
 *è&
node
->
cÞÜ
;

323 
rc
 = 
	`ngx_memn2cmp
(
key
->
d©a
, 
lú
->d©a, key->
Ën
, (
size_t
)†cn->len);

325 ià(
rc
 == 0) {

326  
node
;

329 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

332  
NULL
;

333 
	}
}

337 
	$ngx_h‰p_lim™_cÚn_þ—nup
(*
d©a
)

339 
ngx_h‰p_lim™_cÚn_þ—nup_t
 *
lcþn
 = 
d©a
;

341 
ngx_¦ab_poÞ_t
 *
shpoÞ
;

342 
ngx_rbŒ“_node_t
 *
node
;

343 
ngx_h‰p_lim™_cÚn_ùx_t
 *
ùx
;

344 
ngx_h‰p_lim™_cÚn_node_t
 *
lc
;

346 
ùx
 = 
lcþn
->
shm_zÚe
->
d©a
;

347 
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
lcþn
->
shm_zÚe
->
shm
.
addr
;

348 
node
 = 
lcþn
->node;

349 
lc
 = (
ngx_h‰p_lim™_cÚn_node_t
 *è&
node
->
cÞÜ
;

351 
	`ngx_shmtx_lock
(&
shpoÞ
->
mu‹x
);

353 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
lcþn
->
shm_zÚe
->
shm
.
log
, 0,

354 "lim™ cÚÀþ—nup: %08XD %d", 
node
->
key
, 
lc
->
cÚn
);

356 
lc
->
cÚn
--;

358 ià(
lc
->
cÚn
 == 0) {

359 
	`ngx_rbŒ“_d–‘e
(
ùx
->
rbŒ“
, 
node
);

360 
	`ngx_¦ab_ä“_locked
(
shpoÞ
, 
node
);

363 
	`ngx_shmtx_uÆock
(&
shpoÞ
->
mu‹x
);

364 
	}
}

367 
ngx_šlše
 

368 
	$ngx_h‰p_lim™_cÚn_þ—nup_®l
(
ngx_poÞ_t
 *
poÞ
)

370 
ngx_poÞ_þ—nup_t
 *
þn
;

372 
þn
 = 
poÞ
->
þ—nup
;

374 
þn
 && cÊ->
hªdËr
 =ð
ngx_h‰p_lim™_cÚn_þ—nup
) {

375 
	`ngx_h‰p_lim™_cÚn_þ—nup
(
þn
->
d©a
);

376 
þn
 = cÊ->
Ãxt
;

379 
poÞ
->
þ—nup
 = 
þn
;

380 
	}
}

383 
ngx_št_t


384 
	$ngx_h‰p_lim™_cÚn_š™_zÚe
(
ngx_shm_zÚe_t
 *
shm_zÚe
, *
d©a
)

386 
ngx_h‰p_lim™_cÚn_ùx_t
 *
oùx
 = 
d©a
;

388 
size_t
 
Ën
;

389 
ngx_¦ab_poÞ_t
 *
shpoÞ
;

390 
ngx_rbŒ“_node_t
 *
£Áš–
;

391 
ngx_h‰p_lim™_cÚn_ùx_t
 *
ùx
;

393 
ùx
 = 
shm_zÚe
->
d©a
;

395 ià(
oùx
) {

396 ià(
ùx
->
key
.
v®ue
.
Ën
 !ð
oùx
->key.value.len

397 || 
	`ngx_¡ºcmp
(
ùx
->
key
.
v®ue
.
d©a
, 
oùx
->key.value.data,

398 
ùx
->
key
.
v®ue
.
Ën
)

401 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
shm_zÚe
->
shm
.
log
, 0,

404 &
shm_zÚe
->
shm
.
Çme
, &
ùx
->
key
.
v®ue
,

405 &
oùx
->
key
.
v®ue
);

406  
NGX_ERROR
;

409 
ùx
->
rbŒ“
 = 
oùx
->rbtree;

411  
NGX_OK
;

414 
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
shm_zÚe
->
shm
.
addr
;

416 ià(
shm_zÚe
->
shm
.
exi¡s
) {

417 
ùx
->
rbŒ“
 = 
shpoÞ
->
d©a
;

419  
NGX_OK
;

422 
ùx
->
rbŒ“
 = 
	`ngx_¦ab_®loc
(
shpoÞ
, (
ngx_rbŒ“_t
));

423 ià(
ùx
->
rbŒ“
 =ð
NULL
) {

424  
NGX_ERROR
;

427 
shpoÞ
->
d©a
 = 
ùx
->
rbŒ“
;

429 
£Áš–
 = 
	`ngx_¦ab_®loc
(
shpoÞ
, (
ngx_rbŒ“_node_t
));

430 ià(
£Áš–
 =ð
NULL
) {

431  
NGX_ERROR
;

434 
	`ngx_rbŒ“_š™
(
ùx
->
rbŒ“
, 
£Áš–
,

435 
ngx_h‰p_lim™_cÚn_rbŒ“_š£¹_v®ue
);

437 
Ën
 = (" iÀlim™_cÚn_zÚ\"\""è+ 
shm_zÚe
->
shm
.
Çme
.len;

439 
shpoÞ
->
log_ùx
 = 
	`ngx_¦ab_®loc
(shpoÞ, 
Ën
);

440 ià(
shpoÞ
->
log_ùx
 =ð
NULL
) {

441  
NGX_ERROR
;

444 
	`ngx_¥rštf
(
shpoÞ
->
log_ùx
, " in†imit_conn_zone \"%V\"%Z",

445 &
shm_zÚe
->
shm
.
Çme
);

447  
NGX_OK
;

448 
	}
}

452 
	$ngx_h‰p_lim™_cÚn_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

454 
ngx_h‰p_lim™_cÚn_cÚf_t
 *
cÚf
;

456 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_lim™_cÚn_cÚf_t
));

457 ià(
cÚf
 =ð
NULL
) {

458  
NULL
;

467 
cÚf
->
log_Ëv–
 = 
NGX_CONF_UNSET_UINT
;

468 
cÚf
->
¡©us_code
 = 
NGX_CONF_UNSET_UINT
;

470  
cÚf
;

471 
	}
}

475 
	$ngx_h‰p_lim™_cÚn_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

477 
ngx_h‰p_lim™_cÚn_cÚf_t
 *
´ev
 = 
·»Á
;

478 
ngx_h‰p_lim™_cÚn_cÚf_t
 *
cÚf
 = 
chžd
;

480 ià(
cÚf
->
lim™s
.
–ts
 =ð
NULL
) {

481 
cÚf
->
lim™s
 = 
´ev
->limits;

484 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
log_Ëv–
, 
´ev
->log_Ëv–, 
NGX_LOG_ERR
);

485 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
¡©us_code
, 
´ev
->status_code,

486 
NGX_HTTP_SERVICE_UNAVAILABLE
);

488  
NGX_CONF_OK
;

489 
	}
}

493 
	$ngx_h‰p_lim™_cÚn_zÚe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

495 
u_ch¬
 *
p
;

496 
ssize_t
 
size
;

497 
ngx_¡r_t
 *
v®ue
, 
Çme
, 
s
;

498 
ngx_ušt_t
 
i
;

499 
ngx_shm_zÚe_t
 *
shm_zÚe
;

500 
ngx_h‰p_lim™_cÚn_ùx_t
 *
ùx
;

501 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

503 
v®ue
 = 
cf
->
¬gs
->
–ts
;

505 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_lim™_cÚn_ùx_t
));

506 ià(
ùx
 =ð
NULL
) {

507  
NGX_CONF_ERROR
;

510 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

512 
ccv
.
cf
 = cf;

513 
ccv
.
v®ue
 = &value[1];

514 
ccv
.
com¶ex_v®ue
 = &
ùx
->
key
;

516 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

517  
NGX_CONF_ERROR
;

520 
size
 = 0;

521 
Çme
.
Ën
 = 0;

523 
i
 = 2; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

525 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "zone=", 5) == 0) {

527 
Çme
.
d©a
 = 
v®ue
[
i
].data + 5;

529 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(
Çme
.
d©a
, ':');

531 ià(
p
 =ð
NULL
) {

532 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

533 "šv®id zÚsiz\"%V\"", &
v®ue
[
i
]);

534  
NGX_CONF_ERROR
;

537 
Çme
.
Ën
 = 
p
 -‚ame.
d©a
;

539 
s
.
d©a
 = 
p
 + 1;

540 
s
.
Ën
 = 
v®ue
[
i
].
d©a
 + value[i].len - s.data;

542 
size
 = 
	`ngx_·r£_size
(&
s
);

544 ià(
size
 =ð
NGX_ERROR
) {

545 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

546 "šv®id zÚsiz\"%V\"", &
v®ue
[
i
]);

547  
NGX_CONF_ERROR
;

550 ià(
size
 < (
ssize_t
è(8 * 
ngx_·gesize
)) {

551 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

552 "zÚ\"%V\" i toØsm®l", &
v®ue
[
i
]);

553  
NGX_CONF_ERROR
;

559 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

560 "šv®id…¬am‘” \"%V\"", &
v®ue
[
i
]);

561  
NGX_CONF_ERROR
;

564 ià(
Çme
.
Ën
 == 0) {

565 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

567 &
cmd
->
Çme
);

568  
NGX_CONF_ERROR
;

571 
shm_zÚe
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
Çme
, 
size
,

572 &
ngx_h‰p_lim™_cÚn_moduË
);

573 ià(
shm_zÚe
 =ð
NULL
) {

574  
NGX_CONF_ERROR
;

577 ià(
shm_zÚe
->
d©a
) {

578 
ùx
 = 
shm_zÚe
->
d©a
;

580 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

582 &
cmd
->
Çme
, &Çme, &
ùx
->
key
.
v®ue
);

583  
NGX_CONF_ERROR
;

586 
shm_zÚe
->
š™
 = 
ngx_h‰p_lim™_cÚn_š™_zÚe
;

587 
shm_zÚe
->
d©a
 = 
ùx
;

589  
NGX_CONF_OK
;

590 
	}
}

594 
	$ngx_h‰p_lim™_cÚn
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

596 
ngx_shm_zÚe_t
 *
shm_zÚe
;

597 
ngx_h‰p_lim™_cÚn_cÚf_t
 *
lccf
 = 
cÚf
;

598 
ngx_h‰p_lim™_cÚn_lim™_t
 *
lim™
, *
lim™s
;

600 
ngx_¡r_t
 *
v®ue
;

601 
ngx_št_t
 
n
;

602 
ngx_ušt_t
 
i
;

604 
v®ue
 = 
cf
->
¬gs
->
–ts
;

606 
shm_zÚe
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
v®ue
[1], 0,

607 &
ngx_h‰p_lim™_cÚn_moduË
);

608 ià(
shm_zÚe
 =ð
NULL
) {

609  
NGX_CONF_ERROR
;

612 
lim™s
 = 
lccf
->lim™s.
–ts
;

614 ià(
lim™s
 =ð
NULL
) {

615 ià(
	`ngx_¬¿y_š™
(&
lccf
->
lim™s
, 
cf
->
poÞ
, 1,

616 (
ngx_h‰p_lim™_cÚn_lim™_t
))

617 !ð
NGX_OK
)

619  
NGX_CONF_ERROR
;

623 
i
 = 0; i < 
lccf
->
lim™s
.
ÃÉs
; i++) {

624 ià(
shm_zÚe
 =ð
lim™s
[
i
].shm_zone) {

629 
n
 = 
	`ngx_©oi
(
v®ue
[2].
d©a
, v®ue[2].
Ën
);

630 ià(
n
 <= 0) {

631 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

632 "šv®id‚umb” oàcÚÃùiÚ \"%V\"", &
v®ue
[2]);

633  
NGX_CONF_ERROR
;

636 ià(
n
 > 65535) {

637 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

639  
NGX_CONF_ERROR
;

642 
lim™
 = 
	`ngx_¬¿y_push
(&
lccf
->
lim™s
);

643 ià(
lim™
 =ð
NULL
) {

644  
NGX_CONF_ERROR
;

647 
lim™
->
cÚn
 = 
n
;

648 
lim™
->
shm_zÚe
 = shm_zone;

650  
NGX_CONF_OK
;

651 
	}
}

654 
ngx_št_t


655 
	$ngx_h‰p_lim™_cÚn_š™
(
ngx_cÚf_t
 *
cf
)

657 
ngx_h‰p_hªdËr_±
 *
h
;

658 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

660 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

662 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_PREACCESS_PHASE
].
hªdËrs
);

663 ià(
h
 =ð
NULL
) {

664  
NGX_ERROR
;

667 *
h
 = 
ngx_h‰p_lim™_cÚn_hªdËr
;

669  
NGX_OK
;

670 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_limit_req_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
u_ch¬
 
	mcÞÜ
;

15 
u_ch¬
 
	mdummy
;

16 
u_shÜt
 
	mËn
;

17 
ngx_queue_t
 
	mqueue
;

18 
ngx_m£c_t
 
	mÏ¡
;

20 
ngx_ušt_t
 
	mexûss
;

21 
ngx_ušt_t
 
	mcouÁ
;

22 
u_ch¬
 
	md©a
[1];

23 } 
	tngx_h‰p_lim™_»q_node_t
;

27 
ngx_rbŒ“_t
 
	mrbŒ“
;

28 
ngx_rbŒ“_node_t
 
	m£Áš–
;

29 
ngx_queue_t
 
	mqueue
;

30 } 
	tngx_h‰p_lim™_»q_shùx_t
;

34 
ngx_h‰p_lim™_»q_shùx_t
 *
	msh
;

35 
ngx_¦ab_poÞ_t
 *
	mshpoÞ
;

37 
ngx_ušt_t
 
	m¿‹
;

38 
ngx_h‰p_com¶ex_v®ue_t
 
	mkey
;

39 
ngx_h‰p_lim™_»q_node_t
 *
	mnode
;

40 } 
	tngx_h‰p_lim™_»q_ùx_t
;

44 
ngx_shm_zÚe_t
 *
	mshm_zÚe
;

46 
ngx_ušt_t
 
	mbur¡
;

47 
ngx_ušt_t
 
	mnod–ay
;

48 } 
	tngx_h‰p_lim™_»q_lim™_t
;

52 
ngx_¬¿y_t
 
	mlim™s
;

53 
ngx_ušt_t
 
	mlim™_log_Ëv–
;

54 
ngx_ušt_t
 
	md–ay_log_Ëv–
;

55 
ngx_ušt_t
 
	m¡©us_code
;

56 } 
	tngx_h‰p_lim™_»q_cÚf_t
;

59 
ngx_h‰p_lim™_»q_d–ay
(
ngx_h‰p_»que¡_t
 *
r
);

60 
ngx_št_t
 
ngx_h‰p_lim™_»q_lookup
(
ngx_h‰p_lim™_»q_lim™_t
 *
lim™
,

61 
ngx_ušt_t
 
hash
, 
ngx_¡r_t
 *
key
,‚gx_ušt_ˆ*
•
,‚gx_ušt_ˆ
accouÁ
);

62 
ngx_m£c_t
 
ngx_h‰p_lim™_»q_accouÁ
(
ngx_h‰p_lim™_»q_lim™_t
 *
lim™s
,

63 
ngx_ušt_t
 
n
,‚gx_ušt_ˆ*
•
, 
ngx_h‰p_lim™_»q_lim™_t
 **
lim™
);

64 
ngx_h‰p_lim™_»q_expœe
(
ngx_h‰p_lim™_»q_ùx_t
 *
ùx
,

65 
ngx_ušt_t
 
n
);

67 *
ngx_h‰p_lim™_»q_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

68 *
ngx_h‰p_lim™_»q_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

69 *
chžd
);

70 *
ngx_h‰p_lim™_»q_zÚe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

71 *
cÚf
);

72 *
ngx_h‰p_lim™_»q
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

73 *
cÚf
);

74 
ngx_št_t
 
ngx_h‰p_lim™_»q_š™
(
ngx_cÚf_t
 *
cf
);

77 
ngx_cÚf_’um_t
 
	gngx_h‰p_lim™_»q_log_Ëv–s
[] = {

78 { 
ngx_¡ršg
("šfo"), 
NGX_LOG_INFO
 },

79 { 
ngx_¡ršg
("nÙiû"), 
NGX_LOG_NOTICE
 },

80 { 
ngx_¡ršg
("w¬n"), 
NGX_LOG_WARN
 },

81 { 
ngx_¡ršg
("”rÜ"), 
NGX_LOG_ERR
 },

82 { 
ngx_nuÎ_¡ršg
, 0 }

86 
ngx_cÚf_num_bounds_t
 
	gngx_h‰p_lim™_»q_¡©us_bounds
 = {

87 
ngx_cÚf_check_num_bounds
, 400, 599

91 
ngx_commªd_t
 
	gngx_h‰p_lim™_»q_commªds
[] = {

93 { 
ngx_¡ršg
("limit_req_zone"),

94 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE3
,

95 
ngx_h‰p_lim™_»q_zÚe
,

98 
NULL
 },

100 { 
ngx_¡ršg
("limit_req"),

101 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE123
,

102 
ngx_h‰p_lim™_»q
,

103 
NGX_HTTP_LOC_CONF_OFFSET
,

105 
NULL
 },

107 { 
ngx_¡ršg
("limit_req_log_level"),

108 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

109 
ngx_cÚf_£t_’um_¦Ù
,

110 
NGX_HTTP_LOC_CONF_OFFSET
,

111 
off£tof
(
ngx_h‰p_lim™_»q_cÚf_t
, 
lim™_log_Ëv–
),

112 &
ngx_h‰p_lim™_»q_log_Ëv–s
 },

114 { 
ngx_¡ršg
("limit_req_status"),

115 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

116 
ngx_cÚf_£t_num_¦Ù
,

117 
NGX_HTTP_LOC_CONF_OFFSET
,

118 
off£tof
(
ngx_h‰p_lim™_»q_cÚf_t
, 
¡©us_code
),

119 &
ngx_h‰p_lim™_»q_¡©us_bounds
 },

121 
ngx_nuÎ_commªd


125 
ngx_h‰p_moduË_t
 
	gngx_h‰p_lim™_»q_moduË_ùx
 = {

126 
NULL
,

127 
ngx_h‰p_lim™_»q_š™
,

129 
NULL
,

130 
NULL
,

132 
NULL
,

133 
NULL
,

135 
ngx_h‰p_lim™_»q_ü—‹_cÚf
,

136 
ngx_h‰p_lim™_»q_m”ge_cÚf


140 
ngx_moduË_t
 
	gngx_h‰p_lim™_»q_moduË
 = {

141 
NGX_MODULE_V1
,

142 &
ngx_h‰p_lim™_»q_moduË_ùx
,

143 
ngx_h‰p_lim™_»q_commªds
,

144 
NGX_HTTP_MODULE
,

145 
NULL
,

146 
NULL
,

147 
NULL
,

148 
NULL
,

149 
NULL
,

150 
NULL
,

151 
NULL
,

152 
NGX_MODULE_V1_PADDING


156 
ngx_št_t


157 
	$ngx_h‰p_lim™_»q_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

159 
ušt32_t
 
hash
;

160 
ngx_¡r_t
 
key
;

161 
ngx_št_t
 
rc
;

162 
ngx_ušt_t
 
n
, 
exûss
;

163 
ngx_m£c_t
 
d–ay
;

164 
ngx_h‰p_lim™_»q_ùx_t
 *
ùx
;

165 
ngx_h‰p_lim™_»q_cÚf_t
 *
Ìcf
;

166 
ngx_h‰p_lim™_»q_lim™_t
 *
lim™
, *
lim™s
;

168 ià(
r
->
maš
->
lim™_»q_£t
) {

169  
NGX_DECLINED
;

172 
Ìcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_lim™_»q_moduË
);

173 
lim™s
 = 
Ìcf
->lim™s.
–ts
;

175 
exûss
 = 0;

177 
rc
 = 
NGX_DECLINED
;

179 #ià(
NGX_SUPPRESS_WARN
)

180 
lim™
 = 
NULL
;

183 
n
 = 0;‚ < 
Ìcf
->
lim™s
.
ÃÉs
;‚++) {

185 
lim™
 = &
lim™s
[
n
];

187 
ùx
 = 
lim™
->
shm_zÚe
->
d©a
;

189 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
ùx
->
key
, &keyè!ð
NGX_OK
) {

190  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

193 ià(
key
.
Ën
 == 0) {

197 ià(
key
.
Ën
 > 65535) {

198 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

201 &
ùx
->
key
.
v®ue
, &key);

205 
hash
 = 
	`ngx_üc32_shÜt
(
key
.
d©a
, key.
Ën
);

207 
	`ngx_shmtx_lock
(&
ùx
->
shpoÞ
->
mu‹x
);

209 
rc
 = 
	`ngx_h‰p_lim™_»q_lookup
(
lim™
, 
hash
, &
key
, &
exûss
,

210 (
n
 =ð
Ìcf
->
lim™s
.
ÃÉs
 - 1));

212 
	`ngx_shmtx_uÆock
(&
ùx
->
shpoÞ
->
mu‹x
);

214 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

216 
n
, 
rc
, 
exûss
 / 1000,ƒxcess % 1000);

218 ià(
rc
 !ð
NGX_AGAIN
) {

223 ià(
rc
 =ð
NGX_DECLINED
) {

224  
NGX_DECLINED
;

227 
r
->
maš
->
lim™_»q_£t
 = 1;

229 ià(
rc
 =ð
NGX_BUSY
 ||„ø=ð
NGX_ERROR
) {

231 ià(
rc
 =ð
NGX_BUSY
) {

232 
	`ngx_log_”rÜ
(
Ìcf
->
lim™_log_Ëv–
, 
r
->
cÚÃùiÚ
->
log
, 0,

234 
exûss
 / 1000,ƒxcess % 1000,

235 &
lim™
->
shm_zÚe
->
shm
.
Çme
);

238 
n
--) {

239 
ùx
 = 
lim™s
[
n
].
shm_zÚe
->
d©a
;

241 ià(
ùx
->
node
 =ð
NULL
) {

245 
	`ngx_shmtx_lock
(&
ùx
->
shpoÞ
->
mu‹x
);

247 
ùx
->
node
->
couÁ
--;

249 
	`ngx_shmtx_uÆock
(&
ùx
->
shpoÞ
->
mu‹x
);

251 
ùx
->
node
 = 
NULL
;

254  
Ìcf
->
¡©us_code
;

259 ià(
rc
 =ð
NGX_AGAIN
) {

260 
exûss
 = 0;

263 
d–ay
 = 
	`ngx_h‰p_lim™_»q_accouÁ
(
lim™s
, 
n
, &
exûss
, &
lim™
);

265 ià(!
d–ay
) {

266  
NGX_DECLINED
;

269 
	`ngx_log_”rÜ
(
Ìcf
->
d–ay_log_Ëv–
, 
r
->
cÚÃùiÚ
->
log
, 0,

271 
exûss
 / 1000,ƒxûs % 1000, &
lim™
->
shm_zÚe
->
shm
.
Çme
);

273 ià(
	`ngx_hªdË_»ad_ev’t
(
r
->
cÚÃùiÚ
->
»ad
, 0è!ð
NGX_OK
) {

274  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

277 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_‹¡_»adšg
;

278 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_lim™_»q_d–ay
;

279 
	`ngx_add_tim”
(
r
->
cÚÃùiÚ
->
wr™e
, 
d–ay
);

281  
NGX_AGAIN
;

282 
	}
}

286 
	$ngx_h‰p_lim™_»q_d–ay
(
ngx_h‰p_»que¡_t
 *
r
)

288 
ngx_ev’t_t
 *
wev
;

290 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

293 
wev
 = 
r
->
cÚÃùiÚ
->
wr™e
;

295 ià(!
wev
->
timedout
) {

297 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 0è!ð
NGX_OK
) {

298 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

304 
wev
->
timedout
 = 0;

306 ià(
	`ngx_hªdË_»ad_ev’t
(
r
->
cÚÃùiÚ
->
»ad
, 0è!ð
NGX_OK
) {

307 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

311 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_block_»adšg
;

312 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_cÜe_run_pha£s
;

314 
	`ngx_h‰p_cÜe_run_pha£s
(
r
);

315 
	}
}

319 
	$ngx_h‰p_lim™_»q_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

320 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
)

322 
ngx_rbŒ“_node_t
 **
p
;

323 
ngx_h‰p_lim™_»q_node_t
 *
Ìn
, *
ÌÁ
;

327 ià(
node
->
key
 < 
‹mp
->key) {

329 
p
 = &
‹mp
->
Ëá
;

331 } ià(
node
->
key
 > 
‹mp
->key) {

333 
p
 = &
‹mp
->
right
;

337 
Ìn
 = (
ngx_h‰p_lim™_»q_node_t
 *è&
node
->
cÞÜ
;

338 
ÌÁ
 = (
ngx_h‰p_lim™_»q_node_t
 *è&
‹mp
->
cÞÜ
;

340 
p
 = (
	`ngx_memn2cmp
(
Ìn
->
d©a
, 
ÌÁ
->d©a,†º->
Ën
,†rnt->len) < 0)

341 ? &
‹mp
->
Ëá
 : &‹mp->
right
;

344 ià(*
p
 =ð
£Áš–
) {

348 
‹mp
 = *
p
;

351 *
p
 = 
node
;

352 
node
->
·»Á
 = 
‹mp
;

353 
node
->
Ëá
 = 
£Áš–
;

354 
node
->
right
 = 
£Áš–
;

355 
	`ngx_rbt_»d
(
node
);

356 
	}
}

359 
ngx_št_t


360 
	$ngx_h‰p_lim™_»q_lookup
(
ngx_h‰p_lim™_»q_lim™_t
 *
lim™
, 
ngx_ušt_t
 
hash
,

361 
ngx_¡r_t
 *
key
, 
ngx_ušt_t
 *
•
,‚gx_ušt_ˆ
accouÁ
)

363 
size_t
 
size
;

364 
ngx_št_t
 
rc
, 
exûss
;

365 
ngx_time_t
 *

;

366 
ngx_m£c_t
 
now
;

367 
ngx_m£c_št_t
 
ms
;

368 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

369 
ngx_h‰p_lim™_»q_ùx_t
 *
ùx
;

370 
ngx_h‰p_lim™_»q_node_t
 *
Ì
;

372 

 = 
	`ngx_timeofday
();

373 
now
 = (
ngx_m£c_t
è(

->
£c
 * 1000 +p->
m£c
);

375 
ùx
 = 
lim™
->
shm_zÚe
->
d©a
;

377 
node
 = 
ùx
->
sh
->
rbŒ“
.
roÙ
;

378 
£Áš–
 = 
ùx
->
sh
->
rbŒ“
.sentinel;

380 
node
 !ð
£Áš–
) {

382 ià(
hash
 < 
node
->
key
) {

383 
node
 =‚ode->
Ëá
;

387 ià(
hash
 > 
node
->
key
) {

388 
node
 =‚ode->
right
;

394 
Ì
 = (
ngx_h‰p_lim™_»q_node_t
 *è&
node
->
cÞÜ
;

396 
rc
 = 
	`ngx_memn2cmp
(
key
->
d©a
, 
Ì
->d©a, key->
Ën
, (
size_t
)†r->len);

398 ià(
rc
 == 0) {

399 
	`ngx_queue_»move
(&
Ì
->
queue
);

400 
	`ngx_queue_š£¹_h—d
(&
ùx
->
sh
->
queue
, &
Ì
->queue);

402 
ms
 = (
ngx_m£c_št_t
è(
now
 - 
Ì
->
Ï¡
);

404 
exûss
 = 
Ì
->exûs - 
ùx
->
¿‹
 * 
	`ngx_abs
(
ms
) / 1000 + 1000;

406 ià(
exûss
 < 0) {

407 
exûss
 = 0;

410 *
•
 = 
exûss
;

412 ià((
ngx_ušt_t
è
exûss
 > 
lim™
->
bur¡
) {

413  
NGX_BUSY
;

416 ià(
accouÁ
) {

417 
Ì
->
exûss
 =ƒxcess;

418 
Ì
->
Ï¡
 = 
now
;

419  
NGX_OK
;

422 
Ì
->
couÁ
++;

424 
ùx
->
node
 = 
Ì
;

426  
NGX_AGAIN
;

429 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

432 *
•
 = 0;

434 
size
 = 
	`off£tof
(
ngx_rbŒ“_node_t
, 
cÞÜ
)

435 + 
	`off£tof
(
ngx_h‰p_lim™_»q_node_t
, 
d©a
)

436 + 
key
->
Ën
;

438 
	`ngx_h‰p_lim™_»q_expœe
(
ùx
, 1);

440 
node
 = 
	`ngx_¦ab_®loc_locked
(
ùx
->
shpoÞ
, 
size
);

442 ià(
node
 =ð
NULL
) {

443 
	`ngx_h‰p_lim™_»q_expœe
(
ùx
, 0);

445 
node
 = 
	`ngx_¦ab_®loc_locked
(
ùx
->
shpoÞ
, 
size
);

446 ià(
node
 =ð
NULL
) {

447 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

448 "could‚Ù‡Îoÿ‹‚ode%s", 
ùx
->
shpoÞ
->
log_ùx
);

449  
NGX_ERROR
;

453 
node
->
key
 = 
hash
;

455 
Ì
 = (
ngx_h‰p_lim™_»q_node_t
 *è&
node
->
cÞÜ
;

457 
Ì
->
Ën
 = (
u_shÜt
è
key
->len;

458 
Ì
->
exûss
 = 0;

460 
	`ngx_memýy
(
Ì
->
d©a
, 
key
->d©a, key->
Ën
);

462 
	`ngx_rbŒ“_š£¹
(&
ùx
->
sh
->
rbŒ“
, 
node
);

464 
	`ngx_queue_š£¹_h—d
(&
ùx
->
sh
->
queue
, &
Ì
->queue);

466 ià(
accouÁ
) {

467 
Ì
->
Ï¡
 = 
now
;

468 
Ì
->
couÁ
 = 0;

469  
NGX_OK
;

472 
Ì
->
Ï¡
 = 0;

473 
Ì
->
couÁ
 = 1;

475 
ùx
->
node
 = 
Ì
;

477  
NGX_AGAIN
;

478 
	}
}

481 
ngx_m£c_t


482 
	$ngx_h‰p_lim™_»q_accouÁ
(
ngx_h‰p_lim™_»q_lim™_t
 *
lim™s
, 
ngx_ušt_t
 
n
,

483 
ngx_ušt_t
 *
•
, 
ngx_h‰p_lim™_»q_lim™_t
 **
lim™
)

485 
ngx_št_t
 
exûss
;

486 
ngx_time_t
 *

;

487 
ngx_m£c_t
 
now
, 
d–ay
, 
max_d–ay
;

488 
ngx_m£c_št_t
 
ms
;

489 
ngx_h‰p_lim™_»q_ùx_t
 *
ùx
;

490 
ngx_h‰p_lim™_»q_node_t
 *
Ì
;

492 
exûss
 = *
•
;

494 ià(
exûss
 =ð0 || (*
lim™
)->
nod–ay
) {

495 
max_d–ay
 = 0;

498 
ùx
 = (*
lim™
)->
shm_zÚe
->
d©a
;

499 
max_d–ay
 = 
exûss
 * 1000 / 
ùx
->
¿‹
;

502 
n
--) {

503 
ùx
 = 
lim™s
[
n
].
shm_zÚe
->
d©a
;

504 
Ì
 = 
ùx
->
node
;

506 ià(
Ì
 =ð
NULL
) {

510 
	`ngx_shmtx_lock
(&
ùx
->
shpoÞ
->
mu‹x
);

512 

 = 
	`ngx_timeofday
();

514 
now
 = (
ngx_m£c_t
è(

->
£c
 * 1000 +p->
m£c
);

515 
ms
 = (
ngx_m£c_št_t
è(
now
 - 
Ì
->
Ï¡
);

517 
exûss
 = 
Ì
->exûs - 
ùx
->
¿‹
 * 
	`ngx_abs
(
ms
) / 1000 + 1000;

519 ià(
exûss
 < 0) {

520 
exûss
 = 0;

523 
Ì
->
Ï¡
 = 
now
;

524 
Ì
->
exûss
 =ƒxcess;

525 
Ì
->
couÁ
--;

527 
	`ngx_shmtx_uÆock
(&
ùx
->
shpoÞ
->
mu‹x
);

529 
ùx
->
node
 = 
NULL
;

531 ià(
lim™s
[
n
].
nod–ay
) {

535 
d–ay
 = 
exûss
 * 1000 / 
ùx
->
¿‹
;

537 ià(
d–ay
 > 
max_d–ay
) {

538 
max_d–ay
 = 
d–ay
;

539 *
•
 = 
exûss
;

540 *
lim™
 = &
lim™s
[
n
];

544  
max_d–ay
;

545 
	}
}

549 
	$ngx_h‰p_lim™_»q_expœe
(
ngx_h‰p_lim™_»q_ùx_t
 *
ùx
, 
ngx_ušt_t
 
n
)

551 
ngx_št_t
 
exûss
;

552 
ngx_time_t
 *

;

553 
ngx_m£c_t
 
now
;

554 
ngx_queue_t
 *
q
;

555 
ngx_m£c_št_t
 
ms
;

556 
ngx_rbŒ“_node_t
 *
node
;

557 
ngx_h‰p_lim™_»q_node_t
 *
Ì
;

559 

 = 
	`ngx_timeofday
();

561 
now
 = (
ngx_m£c_t
è(

->
£c
 * 1000 +p->
m£c
);

569 
n
 < 3) {

571 ià(
	`ngx_queue_em±y
(&
ùx
->
sh
->
queue
)) {

575 
q
 = 
	`ngx_queue_Ï¡
(&
ùx
->
sh
->
queue
);

577 
Ì
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_lim™_»q_node_t
, 
queue
);

579 ià(
Ì
->
couÁ
) {

589 ià(
n
++ != 0) {

591 
ms
 = (
ngx_m£c_št_t
è(
now
 - 
Ì
->
Ï¡
);

592 
ms
 = 
	`ngx_abs
(ms);

594 ià(
ms
 < 60000) {

598 
exûss
 = 
Ì
->exûs - 
ùx
->
¿‹
 * 
ms
 / 1000;

600 ià(
exûss
 > 0) {

605 
	`ngx_queue_»move
(
q
);

607 
node
 = (
ngx_rbŒ“_node_t
 *)

608 ((
u_ch¬
 *è
Ì
 - 
	`off£tof
(
ngx_rbŒ“_node_t
, 
cÞÜ
));

610 
	`ngx_rbŒ“_d–‘e
(&
ùx
->
sh
->
rbŒ“
, 
node
);

612 
	`ngx_¦ab_ä“_locked
(
ùx
->
shpoÞ
, 
node
);

614 
	}
}

617 
ngx_št_t


618 
	$ngx_h‰p_lim™_»q_š™_zÚe
(
ngx_shm_zÚe_t
 *
shm_zÚe
, *
d©a
)

620 
ngx_h‰p_lim™_»q_ùx_t
 *
oùx
 = 
d©a
;

622 
size_t
 
Ën
;

623 
ngx_h‰p_lim™_»q_ùx_t
 *
ùx
;

625 
ùx
 = 
shm_zÚe
->
d©a
;

627 ià(
oùx
) {

628 ià(
ùx
->
key
.
v®ue
.
Ën
 !ð
oùx
->key.value.len

629 || 
	`ngx_¡ºcmp
(
ùx
->
key
.
v®ue
.
d©a
, 
oùx
->key.value.data,

630 
ùx
->
key
.
v®ue
.
Ën
)

633 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
shm_zÚe
->
shm
.
log
, 0,

636 &
shm_zÚe
->
shm
.
Çme
, &
ùx
->
key
.
v®ue
,

637 &
oùx
->
key
.
v®ue
);

638  
NGX_ERROR
;

641 
ùx
->
sh
 = 
oùx
->sh;

642 
ùx
->
shpoÞ
 = 
oùx
->shpool;

644  
NGX_OK
;

647 
ùx
->
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
shm_zÚe
->
shm
.
addr
;

649 ià(
shm_zÚe
->
shm
.
exi¡s
) {

650 
ùx
->
sh
 = ctx->
shpoÞ
->
d©a
;

652  
NGX_OK
;

655 
ùx
->
sh
 = 
	`ngx_¦ab_®loc
(ùx->
shpoÞ
, (
ngx_h‰p_lim™_»q_shùx_t
));

656 ià(
ùx
->
sh
 =ð
NULL
) {

657  
NGX_ERROR
;

660 
ùx
->
shpoÞ
->
d©a
 = ctx->
sh
;

662 
	`ngx_rbŒ“_š™
(&
ùx
->
sh
->
rbŒ“
, &ùx->sh->
£Áš–
,

663 
ngx_h‰p_lim™_»q_rbŒ“_š£¹_v®ue
);

665 
	`ngx_queue_š™
(&
ùx
->
sh
->
queue
);

667 
Ën
 = (" iÀlim™_»q zÚ\"\""è+ 
shm_zÚe
->
shm
.
Çme
.len;

669 
ùx
->
shpoÞ
->
log_ùx
 = 
	`ngx_¦ab_®loc
(ùx->shpoÞ, 
Ën
);

670 ià(
ùx
->
shpoÞ
->
log_ùx
 =ð
NULL
) {

671  
NGX_ERROR
;

674 
	`ngx_¥rštf
(
ùx
->
shpoÞ
->
log_ùx
, " in†imit_req zone \"%V\"%Z",

675 &
shm_zÚe
->
shm
.
Çme
);

677 
ùx
->
shpoÞ
->
log_nomem
 = 0;

679  
NGX_OK
;

680 
	}
}

684 
	$ngx_h‰p_lim™_»q_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

686 
ngx_h‰p_lim™_»q_cÚf_t
 *
cÚf
;

688 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_lim™_»q_cÚf_t
));

689 ià(
cÚf
 =ð
NULL
) {

690  
NULL
;

699 
cÚf
->
lim™_log_Ëv–
 = 
NGX_CONF_UNSET_UINT
;

700 
cÚf
->
¡©us_code
 = 
NGX_CONF_UNSET_UINT
;

702  
cÚf
;

703 
	}
}

707 
	$ngx_h‰p_lim™_»q_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

709 
ngx_h‰p_lim™_»q_cÚf_t
 *
´ev
 = 
·»Á
;

710 
ngx_h‰p_lim™_»q_cÚf_t
 *
cÚf
 = 
chžd
;

712 ià(
cÚf
->
lim™s
.
–ts
 =ð
NULL
) {

713 
cÚf
->
lim™s
 = 
´ev
->limits;

716 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
lim™_log_Ëv–
, 
´ev
->limit_log_level,

717 
NGX_LOG_ERR
);

719 
cÚf
->
d–ay_log_Ëv–
 = (cÚf->
lim™_log_Ëv–
 =ð
NGX_LOG_INFO
) ?

720 
NGX_LOG_INFO
 : 
cÚf
->
lim™_log_Ëv–
 + 1;

722 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
¡©us_code
, 
´ev
->status_code,

723 
NGX_HTTP_SERVICE_UNAVAILABLE
);

725  
NGX_CONF_OK
;

726 
	}
}

730 
	$ngx_h‰p_lim™_»q_zÚe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

732 
u_ch¬
 *
p
;

733 
size_t
 
Ën
;

734 
ssize_t
 
size
;

735 
ngx_¡r_t
 *
v®ue
, 
Çme
, 
s
;

736 
ngx_št_t
 
¿‹
, 
sÿË
;

737 
ngx_ušt_t
 
i
;

738 
ngx_shm_zÚe_t
 *
shm_zÚe
;

739 
ngx_h‰p_lim™_»q_ùx_t
 *
ùx
;

740 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

742 
v®ue
 = 
cf
->
¬gs
->
–ts
;

744 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_lim™_»q_ùx_t
));

745 ià(
ùx
 =ð
NULL
) {

746  
NGX_CONF_ERROR
;

749 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

751 
ccv
.
cf
 = cf;

752 
ccv
.
v®ue
 = &value[1];

753 
ccv
.
com¶ex_v®ue
 = &
ùx
->
key
;

755 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

756  
NGX_CONF_ERROR
;

759 
size
 = 0;

760 
¿‹
 = 1;

761 
sÿË
 = 1;

762 
Çme
.
Ën
 = 0;

764 
i
 = 2; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

766 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "zone=", 5) == 0) {

768 
Çme
.
d©a
 = 
v®ue
[
i
].data + 5;

770 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(
Çme
.
d©a
, ':');

772 ià(
p
 =ð
NULL
) {

773 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

774 "šv®id zÚsiz\"%V\"", &
v®ue
[
i
]);

775  
NGX_CONF_ERROR
;

778 
Çme
.
Ën
 = 
p
 -‚ame.
d©a
;

780 
s
.
d©a
 = 
p
 + 1;

781 
s
.
Ën
 = 
v®ue
[
i
].
d©a
 + value[i].len - s.data;

783 
size
 = 
	`ngx_·r£_size
(&
s
);

785 ià(
size
 =ð
NGX_ERROR
) {

786 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

787 "šv®id zÚsiz\"%V\"", &
v®ue
[
i
]);

788  
NGX_CONF_ERROR
;

791 ià(
size
 < (
ssize_t
è(8 * 
ngx_·gesize
)) {

792 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

793 "zÚ\"%V\" i toØsm®l", &
v®ue
[
i
]);

794  
NGX_CONF_ERROR
;

800 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "rate=", 5) == 0) {

802 
Ën
 = 
v®ue
[
i
].len;

803 
p
 = 
v®ue
[
i
].
d©a
 + 
Ën
 - 3;

805 ià(
	`ngx_¡ºcmp
(
p
, "r/s", 3) == 0) {

806 
sÿË
 = 1;

807 
Ën
 -= 3;

809 } ià(
	`ngx_¡ºcmp
(
p
, "r/m", 3) == 0) {

810 
sÿË
 = 60;

811 
Ën
 -= 3;

814 
¿‹
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + 5, 
Ën
 - 5);

815 ià(
¿‹
 <= 0) {

816 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

817 "šv®id„©\"%V\"", &
v®ue
[
i
]);

818  
NGX_CONF_ERROR
;

824 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

825 "šv®id…¬am‘” \"%V\"", &
v®ue
[
i
]);

826  
NGX_CONF_ERROR
;

829 ià(
Çme
.
Ën
 == 0) {

830 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

832 &
cmd
->
Çme
);

833  
NGX_CONF_ERROR
;

836 
ùx
->
¿‹
 =„©* 1000 / 
sÿË
;

838 
shm_zÚe
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
Çme
, 
size
,

839 &
ngx_h‰p_lim™_»q_moduË
);

840 ià(
shm_zÚe
 =ð
NULL
) {

841  
NGX_CONF_ERROR
;

844 ià(
shm_zÚe
->
d©a
) {

845 
ùx
 = 
shm_zÚe
->
d©a
;

847 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

849 &
cmd
->
Çme
, &Çme, &
ùx
->
key
.
v®ue
);

850  
NGX_CONF_ERROR
;

853 
shm_zÚe
->
š™
 = 
ngx_h‰p_lim™_»q_š™_zÚe
;

854 
shm_zÚe
->
d©a
 = 
ùx
;

856  
NGX_CONF_OK
;

857 
	}
}

861 
	$ngx_h‰p_lim™_»q
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

863 
ngx_h‰p_lim™_»q_cÚf_t
 *
Ìcf
 = 
cÚf
;

865 
ngx_št_t
 
bur¡
;

866 
ngx_¡r_t
 *
v®ue
, 
s
;

867 
ngx_ušt_t
 
i
, 
nod–ay
;

868 
ngx_shm_zÚe_t
 *
shm_zÚe
;

869 
ngx_h‰p_lim™_»q_lim™_t
 *
lim™
, *
lim™s
;

871 
v®ue
 = 
cf
->
¬gs
->
–ts
;

873 
shm_zÚe
 = 
NULL
;

874 
bur¡
 = 0;

875 
nod–ay
 = 0;

877 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

879 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "zone=", 5) == 0) {

881 
s
.
Ën
 = 
v®ue
[
i
].len - 5;

882 
s
.
d©a
 = 
v®ue
[
i
].data + 5;

884 
shm_zÚe
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
s
, 0,

885 &
ngx_h‰p_lim™_»q_moduË
);

886 ià(
shm_zÚe
 =ð
NULL
) {

887  
NGX_CONF_ERROR
;

893 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "burst=", 6) == 0) {

895 
bur¡
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + 6, v®ue[i].
Ën
 - 6);

896 ià(
bur¡
 <= 0) {

897 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

898 "šv®id bur¡„©\"%V\"", &
v®ue
[
i
]);

899  
NGX_CONF_ERROR
;

905 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "nodelay") == 0) {

906 
nod–ay
 = 1;

910 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

911 "šv®id…¬am‘” \"%V\"", &
v®ue
[
i
]);

912  
NGX_CONF_ERROR
;

915 ià(
shm_zÚe
 =ð
NULL
) {

916 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

918 &
cmd
->
Çme
);

919  
NGX_CONF_ERROR
;

922 ià(
shm_zÚe
->
d©a
 =ð
NULL
) {

923 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

925 &
shm_zÚe
->
shm
.
Çme
);

926  
NGX_CONF_ERROR
;

929 
lim™s
 = 
Ìcf
->lim™s.
–ts
;

931 ià(
lim™s
 =ð
NULL
) {

932 ià(
	`ngx_¬¿y_š™
(&
Ìcf
->
lim™s
, 
cf
->
poÞ
, 1,

933 (
ngx_h‰p_lim™_»q_lim™_t
))

934 !ð
NGX_OK
)

936  
NGX_CONF_ERROR
;

940 
i
 = 0; i < 
Ìcf
->
lim™s
.
ÃÉs
; i++) {

941 ià(
shm_zÚe
 =ð
lim™s
[
i
].shm_zone) {

946 
lim™
 = 
	`ngx_¬¿y_push
(&
Ìcf
->
lim™s
);

947 ià(
lim™
 =ð
NULL
) {

948  
NGX_CONF_ERROR
;

951 
lim™
->
shm_zÚe
 = shm_zone;

952 
lim™
->
bur¡
 = burst * 1000;

953 
lim™
->
nod–ay
 =‚odelay;

955  
NGX_CONF_OK
;

956 
	}
}

959 
ngx_št_t


960 
	$ngx_h‰p_lim™_»q_š™
(
ngx_cÚf_t
 *
cf
)

962 
ngx_h‰p_hªdËr_±
 *
h
;

963 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

965 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

967 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_PREACCESS_PHASE
].
hªdËrs
);

968 ià(
h
 =ð
NULL
) {

969  
NGX_ERROR
;

972 *
h
 = 
ngx_h‰p_lim™_»q_hªdËr
;

974  
NGX_OK
;

975 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_log_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

12 #ià(
NGX_ZLIB
)

13 
	~<zlib.h
>

17 
ngx_h‰p_log_Ý_s
 
	tngx_h‰p_log_Ý_t
;

19 
	gu_ch¬
 *(*
	tngx_h‰p_log_Ý_run_±
è(
	tngx_h‰p_»que¡_t
 *
	tr
, 
	tu_ch¬
 *
	tbuf
,

20 
	tngx_h‰p_log_Ý_t
 *
	tÝ
);

22 
	$size_t
 (*
	tngx_h‰p_log_Ý_g‘Ën_±
è(
	tngx_h‰p_»que¡_t
 *
	tr
,

23 
	tušŒ_t
 
	td©a
);

26 
	sngx_h‰p_log_Ý_s
 {

27 
size_t
 
Ën
;

28 
ngx_h‰p_log_Ý_g‘Ën_±
 
g‘Ën
;

29 
ngx_h‰p_log_Ý_run_±
 
run
;

30 
ušŒ_t
 
d©a
;

35 
ngx_¡r_t
 
Çme
;

36 
ngx_¬¿y_t
 *
æushes
;

37 
ngx_¬¿y_t
 *
Ýs
;

38 } 
	tngx_h‰p_log_fmt_t
;

42 
ngx_¬¿y_t
 
fÜm©s
;

43 
ngx_ušt_t
 
combšed_u£d
;

44 } 
	tngx_h‰p_log_maš_cÚf_t
;

48 
u_ch¬
 *
¡¬t
;

49 
u_ch¬
 *
pos
;

50 
u_ch¬
 *
Ï¡
;

52 
ngx_ev’t_t
 *
ev’t
;

53 
ngx_m£c_t
 
æush
;

54 
ngx_št_t
 
gz
;

55 } 
	tngx_h‰p_log_buf_t
;

59 
ngx_¬¿y_t
 *
Ëngths
;

60 
ngx_¬¿y_t
 *
v®ues
;

61 } 
	tngx_h‰p_log_süt_t
;

65 
ngx_Ý’_fže_t
 *
fže
;

66 
ngx_h‰p_log_süt_t
 *
süt
;

67 
time_t
 
disk_fuÎ_time
;

68 
time_t
 
”rÜ_log_time
;

69 
ngx_sy¦og_³”_t
 *
sy¦og_³”
;

70 
ngx_h‰p_log_fmt_t
 *
fÜm©
;

71 
ngx_h‰p_com¶ex_v®ue_t
 *
fž‹r
;

72 } 
	tngx_h‰p_log_t
;

76 
ngx_¬¿y_t
 *
logs
;

78 
ngx_Ý’_fže_ÿche_t
 *
Ý’_fže_ÿche
;

79 
time_t
 
Ý’_fže_ÿche_v®id
;

80 
ngx_ušt_t
 
Ý’_fže_ÿche_mš_u£s
;

82 
ngx_ušt_t
 
off
;

83 } 
	tngx_h‰p_log_loc_cÚf_t
;

87 
ngx_¡r_t
 
Çme
;

88 
size_t
 
Ën
;

89 
ngx_h‰p_log_Ý_run_±
 
run
;

90 } 
	tngx_h‰p_log_v¬_t
;

93 
	`ngx_h‰p_log_wr™e
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_log_t
 *
log
,

94 
u_ch¬
 *
buf
, 
size_t
 
Ën
);

95 
ssize_t
 
	`ngx_h‰p_log_süt_wr™e
(
ngx_h‰p_»que¡_t
 *
r
,

96 
ngx_h‰p_log_süt_t
 *
süt
, 
u_ch¬
 **
Çme
, u_ch¬ *
buf
, 
size_t
 
Ën
);

98 #ià(
NGX_ZLIB
)

99 
ssize_t
 
	`ngx_h‰p_log_gz
(
ngx_fd_t
 
fd
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
,

100 
ngx_št_t
 
Ëv–
, 
ngx_log_t
 *
log
);

102 *
	`ngx_h‰p_log_gz_®loc
(*
Ýaque
, 
u_št
 
™ems
, u_šˆ
size
);

103 
	`ngx_h‰p_log_gz_ä“
(*
Ýaque
, *
add»ss
);

106 
	`ngx_h‰p_log_æush
(
ngx_Ý’_fže_t
 *
fže
, 
ngx_log_t
 *
log
);

107 
	`ngx_h‰p_log_æush_hªdËr
(
ngx_ev’t_t
 *
ev
);

109 
u_ch¬
 *
	`ngx_h‰p_log_pe
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

110 
ngx_h‰p_log_Ý_t
 *
Ý
);

111 
u_ch¬
 *
	`ngx_h‰p_log_time
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

112 
ngx_h‰p_log_Ý_t
 *
Ý
);

113 
u_ch¬
 *
	`ngx_h‰p_log_iso8601
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

114 
ngx_h‰p_log_Ý_t
 *
Ý
);

115 
u_ch¬
 *
	`ngx_h‰p_log_m£c
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

116 
ngx_h‰p_log_Ý_t
 *
Ý
);

117 
u_ch¬
 *
	`ngx_h‰p_log_»que¡_time
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

118 
ngx_h‰p_log_Ý_t
 *
Ý
);

119 
u_ch¬
 *
	`ngx_h‰p_log_¡©us
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

120 
ngx_h‰p_log_Ý_t
 *
Ý
);

121 
u_ch¬
 *
	`ngx_h‰p_log_by‹s_£Á
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

122 
ngx_h‰p_log_Ý_t
 *
Ý
);

123 
u_ch¬
 *
	`ngx_h‰p_log_body_by‹s_£Á
(
ngx_h‰p_»que¡_t
 *
r
,

124 
u_ch¬
 *
buf
, 
ngx_h‰p_log_Ý_t
 *
Ý
);

125 
u_ch¬
 *
	`ngx_h‰p_log_»que¡_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

126 
ngx_h‰p_log_Ý_t
 *
Ý
);

128 
ngx_št_t
 
	`ngx_h‰p_log_v¬ŸbË_compže
(
ngx_cÚf_t
 *
cf
,

129 
ngx_h‰p_log_Ý_t
 *
Ý
, 
ngx_¡r_t
 *
v®ue
);

130 
size_t
 
	`ngx_h‰p_log_v¬ŸbË_g‘Ën
(
ngx_h‰p_»que¡_t
 *
r
,

131 
ušŒ_t
 
d©a
);

132 
u_ch¬
 *
	`ngx_h‰p_log_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, u_ch¬ *
buf
,

133 
ngx_h‰p_log_Ý_t
 *
Ý
);

134 
ušŒ_t
 
	`ngx_h‰p_log_esÿ³
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
size
);

137 *
	`ngx_h‰p_log_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

138 *
	`ngx_h‰p_log_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

139 *
	`ngx_h‰p_log_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

140 *
chžd
);

141 *
	`ngx_h‰p_log_£t_log
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

142 *
cÚf
);

143 *
	`ngx_h‰p_log_£t_fÜm©
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

144 *
cÚf
);

145 *
	`ngx_h‰p_log_compže_fÜm©
(
ngx_cÚf_t
 *
cf
,

146 
ngx_¬¿y_t
 *
æushes
,‚gx_¬¿y_ˆ*
Ýs
,‚gx_¬¿y_ˆ*
¬gs
, 
ngx_ušt_t
 
s
);

147 *
	`ngx_h‰p_log_Ý’_fže_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

148 *
cÚf
);

149 
ngx_št_t
 
	`ngx_h‰p_log_š™
(
ngx_cÚf_t
 *
cf
);

152 
ngx_commªd_t
 
ngx_h‰p_log_commªds
[] = {

154 { 
	`ngx_¡ršg
("log_format"),

155 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_2MORE
,

156 
ngx_h‰p_log_£t_fÜm©
,

157 
NGX_HTTP_MAIN_CONF_OFFSET
,

159 
NULL
 },

161 { 
	`ngx_¡ršg
("access_log"),

162 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


163 |
NGX_HTTP_LMT_CONF
|
NGX_CONF_1MORE
,

164 
ngx_h‰p_log_£t_log
,

165 
NGX_HTTP_LOC_CONF_OFFSET
,

167 
NULL
 },

169 { 
	`ngx_¡ršg
("open_log_file_cache"),

170 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1234
,

171 
ngx_h‰p_log_Ý’_fže_ÿche
,

172 
NGX_HTTP_LOC_CONF_OFFSET
,

174 
NULL
 },

176 
ngx_nuÎ_commªd


177 
	}
};

180 
ngx_h‰p_moduË_t
 
	gngx_h‰p_log_moduË_ùx
 = {

181 
NULL
,

182 
ngx_h‰p_log_š™
,

184 
ngx_h‰p_log_ü—‹_maš_cÚf
,

185 
NULL
,

187 
NULL
,

188 
NULL
,

190 
ngx_h‰p_log_ü—‹_loc_cÚf
,

191 
ngx_h‰p_log_m”ge_loc_cÚf


195 
ngx_moduË_t
 
	gngx_h‰p_log_moduË
 = {

196 
NGX_MODULE_V1
,

197 &
ngx_h‰p_log_moduË_ùx
,

198 
ngx_h‰p_log_commªds
,

199 
NGX_HTTP_MODULE
,

200 
NULL
,

201 
NULL
,

202 
NULL
,

203 
NULL
,

204 
NULL
,

205 
NULL
,

206 
NULL
,

207 
NGX_MODULE_V1_PADDING


211 
ngx_¡r_t
 
	gngx_h‰p_acûss_log
 = 
ngx_¡ršg
(
NGX_HTTP_LOG_PATH
);

214 
ngx_¡r_t
 
	gngx_h‰p_combšed_fmt
 =

215 
ngx_¡ršg
("$remote_addr - $remote_user [$time_local] "

220 
ngx_h‰p_log_v¬_t
 
	gngx_h‰p_log_v¬s
[] = {

221 { 
ngx_¡ršg
("pe"), 1, 
ngx_h‰p_log_pe
 },

222 { 
ngx_¡ršg
("time_local"), ("28/Sep/1970:12:00:00 +0600") - 1,

223 
ngx_h‰p_log_time
 },

224 { 
ngx_¡ršg
("time_iso8601"), ("1970-09-28T12:00:00+06:00") - 1,

225 
ngx_h‰p_log_iso8601
 },

226 { 
ngx_¡ršg
("m£c"), 
NGX_TIME_T_LEN
 + 4, 
ngx_h‰p_log_m£c
 },

227 { 
ngx_¡ršg
("»que¡_time"), 
NGX_TIME_T_LEN
 + 4,

228 
ngx_h‰p_log_»que¡_time
 },

229 { 
ngx_¡ršg
("¡©us"), 
NGX_INT_T_LEN
, 
ngx_h‰p_log_¡©us
 },

230 { 
ngx_¡ršg
("by‹s_£Á"), 
NGX_OFF_T_LEN
, 
ngx_h‰p_log_by‹s_£Á
 },

231 { 
ngx_¡ršg
("body_by‹s_£Á"), 
NGX_OFF_T_LEN
,

232 
ngx_h‰p_log_body_by‹s_£Á
 },

233 { 
ngx_¡ršg
("»que¡_Ëngth"), 
NGX_SIZE_T_LEN
,

234 
ngx_h‰p_log_»que¡_Ëngth
 },

236 { 
ngx_nuÎ_¡ršg
, 0, 
NULL
 }

240 
ngx_št_t


241 
	$ngx_h‰p_log_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

243 
u_ch¬
 *
lše
, *
p
;

244 
size_t
 
Ën
, 
size
;

245 
ssize_t
 
n
;

246 
ngx_¡r_t
 
v®
;

247 
ngx_ušt_t
 
i
, 
l
;

248 
ngx_h‰p_log_t
 *
log
;

249 
ngx_h‰p_log_Ý_t
 *
Ý
;

250 
ngx_h‰p_log_buf_t
 *
bufãr
;

251 
ngx_h‰p_log_loc_cÚf_t
 *
lcf
;

253 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

256 
lcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_log_moduË
);

258 ià(
lcf
->
off
) {

259  
NGX_OK
;

262 
log
 = 
lcf
->
logs
->
–ts
;

263 
l
 = 0;† < 
lcf
->
logs
->
ÃÉs
;†++) {

265 ià(
log
[
l
].
fž‹r
) {

266 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
log
[
l
].
fž‹r
, &
v®
è!ð
NGX_OK
) {

267  
NGX_ERROR
;

270 ià(
v®
.
Ën
 =ð0 || (v®.ËÀ=ð1 && v®.
d©a
[0] == '0')) {

275 ià(
	`ngx_time
(è=ð
log
[
l
].
disk_fuÎ_time
) {

286 
	`ngx_h‰p_süt_æush_no_ÿch—bË_v¬ŸbËs
(
r
, 
log
[
l
].
fÜm©
->
æushes
);

288 
Ën
 = 0;

289 
Ý
 = 
log
[
l
].
fÜm©
->
Ýs
->
–ts
;

290 
i
 = 0; i < 
log
[
l
].
fÜm©
->
Ýs
->
ÃÉs
; i++) {

291 ià(
Ý
[
i
].
Ën
 == 0) {

292 
Ën
 +ð
Ý
[
i
].
	`g‘Ën
(
r
, op[i].
d©a
);

295 
Ën
 +ð
Ý
[
i
].len;

299 ià(
log
[
l
].
sy¦og_³”
) {

302 
Ën
 += ("<255>Jan 01 00:00:00 ") - 1

303 + 
ngx_cyþe
->
ho¡Çme
.
Ën
 + 1

304 + 
log
[
l
].
sy¦og_³”
->
g
.
Ën
 + 2;

306 
®loc_lše
;

309 
Ën
 +ð
NGX_LINEFEED_SIZE
;

311 
bufãr
 = 
log
[
l
].
fže
 ?†og[l].fže->
d©a
 : 
NULL
;

313 ià(
bufãr
) {

315 ià(
Ën
 > (
size_t
è(
bufãr
->
Ï¡
 - bufãr->
pos
)) {

317 
	`ngx_h‰p_log_wr™e
(
r
, &
log
[
l
], 
bufãr
->
¡¬t
,

318 
bufãr
->
pos
 - bufãr->
¡¬t
);

320 
bufãr
->
pos
 = bufãr->
¡¬t
;

323 ià(
Ën
 <ð(
size_t
è(
bufãr
->
Ï¡
 - bufãr->
pos
)) {

325 
p
 = 
bufãr
->
pos
;

327 ià(
bufãr
->
ev’t
 && 
p
 =ðbufãr->
¡¬t
) {

328 
	`ngx_add_tim”
(
bufãr
->
ev’t
, bufãr->
æush
);

331 
i
 = 0; i < 
log
[
l
].
fÜm©
->
Ýs
->
ÃÉs
; i++) {

332 
p
 = 
Ý
[
i
].
	`run
(
r
,…, &op[i]);

335 
	`ngx_lšeãed
(
p
);

337 
bufãr
->
pos
 = 
p
;

342 ià(
bufãr
->
ev’t
 && bufãr->ev’t->
tim”_£t
) {

343 
	`ngx_d–_tim”
(
bufãr
->
ev’t
);

347 
®loc_lše
:

349 
lše
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

350 ià(
lše
 =ð
NULL
) {

351  
NGX_ERROR
;

354 
p
 = 
lše
;

356 ià(
log
[
l
].
sy¦og_³”
) {

357 
p
 = 
	`ngx_sy¦og_add_h—d”
(
log
[
l
].
sy¦og_³”
, 
lše
);

360 
i
 = 0; i < 
log
[
l
].
fÜm©
->
Ýs
->
ÃÉs
; i++) {

361 
p
 = 
Ý
[
i
].
	`run
(
r
,…, &op[i]);

364 ià(
log
[
l
].
sy¦og_³”
) {

366 
size
 = 
p
 - 
lše
;

368 
n
 = 
	`ngx_sy¦og_£nd
(
log
[
l
].
sy¦og_³”
, 
lše
, 
size
);

370 ià(
n
 < 0) {

371 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
r
->
cÚÃùiÚ
->
log
, 0,

374 } ià((
size_t
è
n
 !ð
size
) {

375 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
r
->
cÚÃùiÚ
->
log
, 0,

377 
n
, 
size
);

383 
	`ngx_lšeãed
(
p
);

385 
	`ngx_h‰p_log_wr™e
(
r
, &
log
[
l
], 
lše
, 
p
 -†ine);

388  
NGX_OK
;

389 
	}
}

393 
	$ngx_h‰p_log_wr™e
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_log_t
 *
log
, 
u_ch¬
 *
buf
,

394 
size_t
 
Ën
)

396 
u_ch¬
 *
Çme
;

397 
time_t
 
now
;

398 
ssize_t
 
n
;

399 
ngx_”r_t
 
”r
;

400 #ià(
NGX_ZLIB
)

401 
ngx_h‰p_log_buf_t
 *
bufãr
;

404 ià(
log
->
süt
 =ð
NULL
) {

405 
Çme
 = 
log
->
fže
->Çme.
d©a
;

407 #ià(
NGX_ZLIB
)

408 
bufãr
 = 
log
->
fže
->
d©a
;

410 ià(
bufãr
 && bufãr->
gz
) {

411 
n
 = 
	`ngx_h‰p_log_gz
(
log
->
fže
->
fd
, 
buf
, 
Ën
, 
bufãr
->
gz
,

412 
r
->
cÚÃùiÚ
->
log
);

414 
n
 = 
	`ngx_wr™e_fd
(
log
->
fže
->
fd
, 
buf
, 
Ën
);

417 
n
 = 
	`ngx_wr™e_fd
(
log
->
fže
->
fd
, 
buf
, 
Ën
);

421 
Çme
 = 
NULL
;

422 
n
 = 
	`ngx_h‰p_log_süt_wr™e
(
r
, 
log
->
süt
, &
Çme
, 
buf
, 
Ën
);

425 ià(
n
 =ð(
ssize_t
è
Ën
) {

429 
now
 = 
	`ngx_time
();

431 ià(
n
 == -1) {

432 
”r
 = 
ngx_”ºo
;

434 ià(
”r
 =ð
NGX_ENOSPC
) {

435 
log
->
disk_fuÎ_time
 = 
now
;

438 ià(
now
 - 
log
->
”rÜ_log_time
 > 59) {

439 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

440 
ngx_wr™e_fd_n
 "Ø\"%s\" fažed", 
Çme
);

442 
log
->
”rÜ_log_time
 = 
now
;

448 ià(
now
 - 
log
->
”rÜ_log_time
 > 59) {

449 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

450 
ngx_wr™e_fd_n
 "o \"%s\" was incomplete: %z of %uz",

451 
Çme
, 
n
, 
Ën
);

453 
log
->
”rÜ_log_time
 = 
now
;

455 
	}
}

458 
ssize_t


459 
	$ngx_h‰p_log_süt_wr™e
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_log_süt_t
 *
süt
,

460 
u_ch¬
 **
Çme
, u_ch¬ *
buf
, 
size_t
 
Ën
)

462 
size_t
 
roÙ
;

463 
ssize_t
 
n
;

464 
ngx_¡r_t
 
log
, 
·th
;

465 
ngx_Ý’_fže_šfo_t
 
of
;

466 
ngx_h‰p_log_loc_cÚf_t
 *
Îcf
;

467 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

469 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

471 ià(!
r
->
roÙ_‹¡ed
) {

475 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0è=ð
NULL
) {

477  
Ën
;

480 
·th
.
d©a
[
roÙ
] = '\0';

482 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

484 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

485 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

486 
of
.
‹¡_dœ
 = 1;

487 
of
.
‹¡_Úly
 = 1;

488 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

489 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

491 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
·th
, &
of
è!ð
NGX_OK
) {

493  
Ën
;

496 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
·th
, &
of
, 
r
->
poÞ
)

497 !ð
NGX_OK
)

499 ià(
of
.
”r
 == 0) {

501  
Ën
;

504 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 
of
.
”r
,

505 "‹¡šg \"%s\"ƒxi¡’û fažed", 
·th
.
d©a
);

508  
Ën
;

511 ià(!
of
.
is_dœ
) {

512 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 
NGX_ENOTDIR
,

513 "‹¡šg \"%s\"ƒxi¡’û fažed", 
·th
.
d©a
);

516  
Ën
;

520 ià(
	`ngx_h‰p_süt_run
(
r
, &
log
, 
süt
->
Ëngths
->
–ts
, 1,

521 
süt
->
v®ues
->
–ts
)

522 =ð
NULL
)

525  
Ën
;

528 
log
.
d©a
[log.
Ën
 - 1] = '\0';

529 *
Çme
 = 
log
.
d©a
;

531 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

532 "h‰°log \"%s\"", 
log
.
d©a
);

534 
Îcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_log_moduË
);

536 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

538 
of
.
log
 = 1;

539 
of
.
v®id
 = 
Îcf
->
Ý’_fže_ÿche_v®id
;

540 
of
.
mš_u£s
 = 
Îcf
->
Ý’_fže_ÿche_mš_u£s
;

541 
of
.
dœeùio
 = 
NGX_OPEN_FILE_DIRECTIO_OFF
;

543 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
log
, &
of
è!ð
NGX_OK
) {

545  
Ën
;

548 ià(
	`ngx_Ý’_ÿched_fže
(
Îcf
->
Ý’_fže_ÿche
, &
log
, &
of
, 
r
->
poÞ
)

549 !ð
NGX_OK
)

551 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

552 "% \"%s\" fažed", 
of
.
çžed
, 
log
.
d©a
);

554  
Ën
;

557 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

558 "h‰°log #%d", 
of
.
fd
);

560 
n
 = 
	`ngx_wr™e_fd
(
of
.
fd
, 
buf
, 
Ën
);

562  
n
;

563 
	}
}

566 #ià(
NGX_ZLIB
)

568 
ssize_t


569 
	$ngx_h‰p_log_gz
(
ngx_fd_t
 
fd
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
, 
ngx_št_t
 
Ëv–
,

570 
ngx_log_t
 *
log
)

572 
rc
, 
wb™s
, 
memËv–
;

573 
u_ch¬
 *
out
;

574 
size_t
 
size
;

575 
ssize_t
 
n
;

576 
z_¡»am
 
z¡»am
;

577 
ngx_”r_t
 
”r
;

578 
ngx_poÞ_t
 *
poÞ
;

580 
wb™s
 = 
MAX_WBITS
;

581 
memËv–
 = 
MAX_MEM_LEVEL
 - 1;

583 (
ssize_t
è
Ën
 < ((1 << (
wb™s
 - 1)) - 262)) {

584 
wb™s
--;

585 
memËv–
--;

593 
size
 = 
Ën
 + ((len + 7) >> 3) + ((len + 63) >> 6) + 5 + 18;

595 
	`ngx_memz”o
(&
z¡»am
, (
z_¡»am
));

597 
poÞ
 = 
	`ngx_ü—‹_poÞ
(256, 
log
);

598 ià(
poÞ
 =ð
NULL
) {

600  
Ën
;

603 
poÞ
->
log
 =†og;

605 
z¡»am
.
z®loc
 = 
ngx_h‰p_log_gz_®loc
;

606 
z¡»am
.
zä“
 = 
ngx_h‰p_log_gz_ä“
;

607 
z¡»am
.
Ýaque
 = 
poÞ
;

609 
out
 = 
	`ngx_²®loc
(
poÞ
, 
size
);

610 ià(
out
 =ð
NULL
) {

611 
dÚe
;

614 
z¡»am
.
Ãxt_š
 = 
buf
;

615 
z¡»am
.
avaž_š
 = 
Ën
;

616 
z¡»am
.
Ãxt_out
 = 
out
;

617 
z¡»am
.
avaž_out
 = 
size
;

619 
rc
 = 
	`deæ©eIn™2
(&
z¡»am
, (è
Ëv–
, 
Z_DEFLATED
, 
wb™s
 + 16, 
memËv–
,

620 
Z_DEFAULT_STRATEGY
);

622 ià(
rc
 !ð
Z_OK
) {

623 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0, "deæ©eIn™2(èçžed: %d", 
rc
);

624 
dÚe
;

627 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0,

629 
z¡»am
.
Ãxt_š
, z¡»am.
Ãxt_out
,

630 
z¡»am
.
avaž_š
, z¡»am.
avaž_out
);

632 
rc
 = 
	`deæ©e
(&
z¡»am
, 
Z_FINISH
);

634 ià(
rc
 !ð
Z_STREAM_END
) {

635 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

636 "deæ©e(Z_FINISHèçžed: %d", 
rc
);

637 
dÚe
;

640 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0,

642 
z¡»am
.
Ãxt_š
, z¡»am.
Ãxt_out
,

643 
z¡»am
.
avaž_š
, z¡»am.
avaž_out
,

644 
rc
);

646 
size
 -ð
z¡»am
.
avaž_out
;

648 
rc
 = 
	`deæ©eEnd
(&
z¡»am
);

650 ià(
rc
 !ð
Z_OK
) {

651 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0, "deæ©eEnd(èçžed: %d", 
rc
);

652 
dÚe
;

655 
n
 = 
	`ngx_wr™e_fd
(
fd
, 
out
, 
size
);

657 ià(
n
 !ð(
ssize_t
è
size
) {

658 
”r
 = (
n
 =ð-1è? 
ngx_”ºo
 : 0;

660 
	`ngx_de¡roy_poÞ
(
poÞ
);

662 
	`ngx_£t_”ºo
(
”r
);

666 
dÚe
:

668 
	`ngx_de¡roy_poÞ
(
poÞ
);

671  
Ën
;

672 
	}
}

676 
	$ngx_h‰p_log_gz_®loc
(*
Ýaque
, 
u_št
 
™ems
, u_šˆ
size
)

678 
ngx_poÞ_t
 *
poÞ
 = 
Ýaque
;

680 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
poÞ
->
log
, 0,

681 "gz‡Îoc:‚:%ud s:%ud", 
™ems
, 
size
);

683  
	`ngx_·Îoc
(
poÞ
, 
™ems
 * 
size
);

684 
	}
}

688 
	$ngx_h‰p_log_gz_ä“
(*
Ýaque
, *
add»ss
)

691 
ngx_poÞ_t
 *
poÞ
 = 
Ýaque
;

693 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
poÞ
->
log
, 0, "gz f»e: %p", 
add»ss
);

695 
	}
}

701 
	$ngx_h‰p_log_æush
(
ngx_Ý’_fže_t
 *
fže
, 
ngx_log_t
 *
log
)

703 
size_t
 
Ën
;

704 
ssize_t
 
n
;

705 
ngx_h‰p_log_buf_t
 *
bufãr
;

707 
bufãr
 = 
fže
->
d©a
;

709 
Ën
 = 
bufãr
->
pos
 - bufãr->
¡¬t
;

711 ià(
Ën
 == 0) {

715 #ià(
NGX_ZLIB
)

716 ià(
bufãr
->
gz
) {

717 
n
 = 
	`ngx_h‰p_log_gz
(
fže
->
fd
, 
bufãr
->
¡¬t
, 
Ën
, bufãr->
gz
, 
log
);

719 
n
 = 
	`ngx_wr™e_fd
(
fže
->
fd
, 
bufãr
->
¡¬t
, 
Ën
);

722 
n
 = 
	`ngx_wr™e_fd
(
fže
->
fd
, 
bufãr
->
¡¬t
, 
Ën
);

725 ià(
n
 == -1) {

726 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

727 
ngx_wr™e_fd_n
 "o \"%s\" failed",

728 
fže
->
Çme
.
d©a
);

730 } ià((
size_t
è
n
 !ð
Ën
) {

731 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

732 
ngx_wr™e_fd_n
 "o \"%s\" was incomplete: %z of %uz",

733 
fže
->
Çme
.
d©a
, 
n
, 
Ën
);

736 
bufãr
->
pos
 = bufãr->
¡¬t
;

738 ià(
bufãr
->
ev’t
 && bufãr->ev’t->
tim”_£t
) {

739 
	`ngx_d–_tim”
(
bufãr
->
ev’t
);

741 
	}
}

745 
	$ngx_h‰p_log_æush_hªdËr
(
ngx_ev’t_t
 *
ev
)

747 
ngx_Ý’_fže_t
 *
fže
;

748 
ngx_h‰p_log_buf_t
 *
bufãr
;

750 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
ev
->
log
, 0,

753 ià(
ev
->
timedout
) {

754 
	`ngx_h‰p_log_æush
(
ev
->
d©a
,ƒv->
log
);

760 
fže
 = 
ev
->
d©a
;

761 
bufãr
 = 
fže
->
d©a
;

763 
bufãr
->
ev’t
 = 
NULL
;

764 
	}
}

767 
u_ch¬
 *

768 
	$ngx_h‰p_log_cÝy_shÜt
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
,

769 
ngx_h‰p_log_Ý_t
 *
Ý
)

771 
size_t
 
Ën
;

772 
ušŒ_t
 
d©a
;

774 
Ën
 = 
Ý
->len;

775 
d©a
 = 
Ý
->data;

777 
Ën
--) {

778 *
buf
++ = (
u_ch¬
è(
d©a
 & 0xff);

779 
d©a
 >>= 8;

782  
buf
;

783 
	}
}

786 
u_ch¬
 *

787 
	$ngx_h‰p_log_cÝy_lÚg
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
,

788 
ngx_h‰p_log_Ý_t
 *
Ý
)

790  
	`ngx_ýymem
(
buf
, (
u_ch¬
 *è
Ý
->
d©a
, op->
Ën
);

791 
	}
}

794 
u_ch¬
 *

795 
	$ngx_h‰p_log_pe
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
, 
ngx_h‰p_log_Ý_t
 *
Ý
)

797 ià(
r
->
p–še
) {

798 *
buf
 = 'p';

800 *
buf
 = '.';

803  
buf
 + 1;

804 
	}
}

807 
u_ch¬
 *

808 
	$ngx_h‰p_log_time
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
, 
ngx_h‰p_log_Ý_t
 *
Ý
)

810  
	`ngx_ýymem
(
buf
, 
ngx_ÿched_h‰p_log_time
.
d©a
,

811 
ngx_ÿched_h‰p_log_time
.
Ën
);

812 
	}
}

814 
u_ch¬
 *

815 
	$ngx_h‰p_log_iso8601
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
, 
ngx_h‰p_log_Ý_t
 *
Ý
)

817  
	`ngx_ýymem
(
buf
, 
ngx_ÿched_h‰p_log_iso8601
.
d©a
,

818 
ngx_ÿched_h‰p_log_iso8601
.
Ën
);

819 
	}
}

821 
u_ch¬
 *

822 
	$ngx_h‰p_log_m£c
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
, 
ngx_h‰p_log_Ý_t
 *
Ý
)

824 
ngx_time_t
 *

;

826 

 = 
	`ngx_timeofday
();

828  
	`ngx_¥rštf
(
buf
, "%T.%03M", 

->
£c
,p->
m£c
);

829 
	}
}

832 
u_ch¬
 *

833 
	$ngx_h‰p_log_»que¡_time
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
,

834 
ngx_h‰p_log_Ý_t
 *
Ý
)

836 
ngx_time_t
 *

;

837 
ngx_m£c_št_t
 
ms
;

839 

 = 
	`ngx_timeofday
();

841 
ms
 = (
ngx_m£c_št_t
)

842 ((

->
£c
 - 
r
->
¡¬t_£c
è* 1000 + (->
m£c
 -„->
¡¬t_m£c
));

843 
ms
 = 
	`ngx_max
(ms, 0);

845  
	`ngx_¥rštf
(
buf
, "%T.%03M", (
time_t
è
ms
 / 1000, ms % 1000);

846 
	}
}

849 
u_ch¬
 *

850 
	$ngx_h‰p_log_¡©us
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
, 
ngx_h‰p_log_Ý_t
 *
Ý
)

852 
ngx_ušt_t
 
¡©us
;

854 ià(
r
->
”r_¡©us
) {

855 
¡©us
 = 
r
->
”r_¡©us
;

857 } ià(
r
->
h—d”s_out
.
¡©us
) {

858 
¡©us
 = 
r
->
h—d”s_out
.status;

860 } ià(
r
->
h‰p_v”siÚ
 =ð
NGX_HTTP_VERSION_9
) {

861 
¡©us
 = 9;

864 
¡©us
 = 0;

867  
	`ngx_¥rštf
(
buf
, "%03ui", 
¡©us
);

868 
	}
}

871 
u_ch¬
 *

872 
	$ngx_h‰p_log_by‹s_£Á
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
,

873 
ngx_h‰p_log_Ý_t
 *
Ý
)

875  
	`ngx_¥rštf
(
buf
, "%O", 
r
->
cÚÃùiÚ
->
£Á
);

876 
	}
}

884 
u_ch¬
 *

885 
	$ngx_h‰p_log_body_by‹s_£Á
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
,

886 
ngx_h‰p_log_Ý_t
 *
Ý
)

888 
off_t
 
Ëngth
;

890 
Ëngth
 = 
r
->
cÚÃùiÚ
->
£Á
 -„->
h—d”_size
;

892 ià(
Ëngth
 > 0) {

893  
	`ngx_¥rštf
(
buf
, "%O", 
Ëngth
);

896 *
buf
 = '0';

898  
buf
 + 1;

899 
	}
}

902 
u_ch¬
 *

903 
	$ngx_h‰p_log_»que¡_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
,

904 
ngx_h‰p_log_Ý_t
 *
Ý
)

906  
	`ngx_¥rštf
(
buf
, "%O", 
r
->
»que¡_Ëngth
);

907 
	}
}

910 
ngx_št_t


911 
	$ngx_h‰p_log_v¬ŸbË_compže
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_log_Ý_t
 *
Ý
,

912 
ngx_¡r_t
 *
v®ue
)

914 
ngx_št_t
 
šdex
;

916 
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, 
v®ue
);

917 ià(
šdex
 =ð
NGX_ERROR
) {

918  
NGX_ERROR
;

921 
Ý
->
Ën
 = 0;

922 
Ý
->
g‘Ën
 = 
ngx_h‰p_log_v¬ŸbË_g‘Ën
;

923 
Ý
->
run
 = 
ngx_h‰p_log_v¬ŸbË
;

924 
Ý
->
d©a
 = 
šdex
;

926  
NGX_OK
;

927 
	}
}

930 
size_t


931 
	$ngx_h‰p_log_v¬ŸbË_g‘Ën
(
ngx_h‰p_»que¡_t
 *
r
, 
ušŒ_t
 
d©a
)

933 
ušŒ_t
 
Ën
;

934 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®ue
;

936 
v®ue
 = 
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
r
, 
d©a
);

938 ià(
v®ue
 =ð
NULL
 || v®ue->
nÙ_found
) {

942 
Ën
 = 
	`ngx_h‰p_log_esÿ³
(
NULL
, 
v®ue
->
d©a
, value->len);

944 
v®ue
->
esÿ³
 = 
Ën
 ? 1 : 0;

946  
v®ue
->
Ën
 +†en * 3;

947 
	}
}

950 
u_ch¬
 *

951 
	$ngx_h‰p_log_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
, 
ngx_h‰p_log_Ý_t
 *
Ý
)

953 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®ue
;

955 
v®ue
 = 
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
r
, 
Ý
->
d©a
);

957 ià(
v®ue
 =ð
NULL
 || v®ue->
nÙ_found
) {

958 *
buf
 = '-';

959  
buf
 + 1;

962 ià(
v®ue
->
esÿ³
 == 0) {

963  
	`ngx_ýymem
(
buf
, 
v®ue
->
d©a
, v®ue->
Ën
);

966  (
u_ch¬
 *è
	`ngx_h‰p_log_esÿ³
(
buf
, 
v®ue
->
d©a
, v®ue->
Ën
);

968 
	}
}

971 
ušŒ_t


972 
	$ngx_h‰p_log_esÿ³
(
u_ch¬
 *
d¡
, u_ch¬ *
¤c
, 
size_t
 
size
)

974 
ngx_ušt_t
 
n
;

975 
u_ch¬
 
hex
[] = "0123456789ABCDEF";

977 
ušt32_t
 
esÿ³
[] = {

996 ià(
d¡
 =ð
NULL
) {

1000 
n
 = 0;

1002 
size
) {

1003 ià(
esÿ³
[*
¤c
 >> 5] & (1 << (*src & 0x1f))) {

1004 
n
++;

1006 
¤c
++;

1007 
size
--;

1010  (
ušŒ_t
è
n
;

1013 
size
) {

1014 ià(
esÿ³
[*
¤c
 >> 5] & (1 << (*src & 0x1f))) {

1015 *
d¡
++ = '\\';

1016 *
d¡
++ = 'x';

1017 *
d¡
++ = 
hex
[*
¤c
 >> 4];

1018 *
d¡
++ = 
hex
[*
¤c
 & 0xf];

1019 
¤c
++;

1022 *
d¡
++ = *
¤c
++;

1024 
size
--;

1027  (
ušŒ_t
è
d¡
;

1028 
	}
}

1032 
	$ngx_h‰p_log_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

1034 
ngx_h‰p_log_maš_cÚf_t
 *
cÚf
;

1036 
ngx_h‰p_log_fmt_t
 *
fmt
;

1038 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_log_maš_cÚf_t
));

1039 ià(
cÚf
 =ð
NULL
) {

1040  
NULL
;

1043 ià(
	`ngx_¬¿y_š™
(&
cÚf
->
fÜm©s
, 
cf
->
poÞ
, 4, (
ngx_h‰p_log_fmt_t
))

1044 !ð
NGX_OK
)

1046  
NULL
;

1049 
fmt
 = 
	`ngx_¬¿y_push
(&
cÚf
->
fÜm©s
);

1050 ià(
fmt
 =ð
NULL
) {

1051  
NULL
;

1054 
	`ngx_¡r_£t
(&
fmt
->
Çme
, "combined");

1056 
fmt
->
æushes
 = 
NULL
;

1058 
fmt
->
Ýs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 16, (
ngx_h‰p_log_Ý_t
));

1059 ià(
fmt
->
Ýs
 =ð
NULL
) {

1060  
NULL
;

1063  
cÚf
;

1064 
	}
}

1068 
	$ngx_h‰p_log_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

1070 
ngx_h‰p_log_loc_cÚf_t
 *
cÚf
;

1072 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_log_loc_cÚf_t
));

1073 ià(
cÚf
 =ð
NULL
) {

1074  
NULL
;

1077 
cÚf
->
Ý’_fže_ÿche
 = 
NGX_CONF_UNSET_PTR
;

1079  
cÚf
;

1080 
	}
}

1084 
	$ngx_h‰p_log_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1086 
ngx_h‰p_log_loc_cÚf_t
 *
´ev
 = 
·»Á
;

1087 
ngx_h‰p_log_loc_cÚf_t
 *
cÚf
 = 
chžd
;

1089 
ngx_h‰p_log_t
 *
log
;

1090 
ngx_h‰p_log_fmt_t
 *
fmt
;

1091 
ngx_h‰p_log_maš_cÚf_t
 *
lmcf
;

1093 ià(
cÚf
->
Ý’_fže_ÿche
 =ð
NGX_CONF_UNSET_PTR
) {

1095 
cÚf
->
Ý’_fže_ÿche
 = 
´ev
->open_file_cache;

1096 
cÚf
->
Ý’_fže_ÿche_v®id
 = 
´ev
->open_file_cache_valid;

1097 
cÚf
->
Ý’_fže_ÿche_mš_u£s
 = 
´ev
->open_file_cache_min_uses;

1099 ià(
cÚf
->
Ý’_fže_ÿche
 =ð
NGX_CONF_UNSET_PTR
) {

1100 
cÚf
->
Ý’_fže_ÿche
 = 
NULL
;

1104 ià(
cÚf
->
logs
 || cÚf->
off
) {

1105  
NGX_CONF_OK
;

1108 
cÚf
->
logs
 = 
´ev
->logs;

1109 
cÚf
->
off
 = 
´ev
->off;

1111 ià(
cÚf
->
logs
 || cÚf->
off
) {

1112  
NGX_CONF_OK
;

1115 
cÚf
->
logs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 2, (
ngx_h‰p_log_t
));

1116 ià(
cÚf
->
logs
 =ð
NULL
) {

1117  
NGX_CONF_ERROR
;

1120 
log
 = 
	`ngx_¬¿y_push
(
cÚf
->
logs
);

1121 ià(
log
 =ð
NULL
) {

1122  
NGX_CONF_ERROR
;

1125 
	`ngx_memz”o
(
log
, (
ngx_h‰p_log_t
));

1127 
log
->
fže
 = 
	`ngx_cÚf_Ý’_fže
(
cf
->
cyþe
, &
ngx_h‰p_acûss_log
);

1128 ià(
log
->
fže
 =ð
NULL
) {

1129  
NGX_CONF_ERROR
;

1132 
lmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_log_moduË
);

1133 
fmt
 = 
lmcf
->
fÜm©s
.
–ts
;

1136 
log
->
fÜm©
 = &
fmt
[0];

1137 
lmcf
->
combšed_u£d
 = 1;

1139  
NGX_CONF_OK
;

1140 
	}
}

1144 
	$ngx_h‰p_log_£t_log
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1146 
ngx_h‰p_log_loc_cÚf_t
 *
Îcf
 = 
cÚf
;

1148 
ssize_t
 
size
;

1149 
ngx_št_t
 
gz
;

1150 
ngx_ušt_t
 
i
, 
n
;

1151 
ngx_m£c_t
 
æush
;

1152 
ngx_¡r_t
 *
v®ue
, 
Çme
, 
s
;

1153 
ngx_h‰p_log_t
 *
log
;

1154 
ngx_sy¦og_³”_t
 *
³”
;

1155 
ngx_h‰p_log_buf_t
 *
bufãr
;

1156 
ngx_h‰p_log_fmt_t
 *
fmt
;

1157 
ngx_h‰p_log_maš_cÚf_t
 *
lmcf
;

1158 
ngx_h‰p_süt_compže_t
 
sc
;

1159 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

1161 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1163 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

1164 
Îcf
->
off
 = 1;

1165 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

1166  
NGX_CONF_OK
;

1169 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1170 "šv®id…¬am‘” \"%V\"", &
v®ue
[2]);

1171  
NGX_CONF_ERROR
;

1174 ià(
Îcf
->
logs
 =ð
NULL
) {

1175 
Îcf
->
logs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 2, (
ngx_h‰p_log_t
));

1176 ià(
Îcf
->
logs
 =ð
NULL
) {

1177  
NGX_CONF_ERROR
;

1181 
lmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_log_moduË
);

1183 
log
 = 
	`ngx_¬¿y_push
(
Îcf
->
logs
);

1184 ià(
log
 =ð
NULL
) {

1185  
NGX_CONF_ERROR
;

1188 
	`ngx_memz”o
(
log
, (
ngx_h‰p_log_t
));

1191 ià(
	`ngx_¡ºcmp
(
v®ue
[1].
d©a
, "syslog:", 7) == 0) {

1193 
³”
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_sy¦og_³”_t
));

1194 ià(
³”
 =ð
NULL
) {

1195  
NGX_CONF_ERROR
;

1198 ià(
	`ngx_sy¦og_´oûss_cÚf
(
cf
, 
³”
è!ð
NGX_CONF_OK
) {

1199  
NGX_CONF_ERROR
;

1202 
log
->
sy¦og_³”
 = 
³”
;

1204 
´oûss_fÜm©s
;

1207 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
v®ue
[1]);

1209 ià(
n
 == 0) {

1210 
log
->
fže
 = 
	`ngx_cÚf_Ý’_fže
(
cf
->
cyþe
, &
v®ue
[1]);

1211 ià(
log
->
fže
 =ð
NULL
) {

1212  
NGX_CONF_ERROR
;

1216 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
v®ue
[1], 0è!ð
NGX_OK
) {

1217  
NGX_CONF_ERROR
;

1220 
log
->
süt
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_log_süt_t
));

1221 ià(
log
->
süt
 =ð
NULL
) {

1222  
NGX_CONF_ERROR
;

1225 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

1227 
sc
.
cf
 = cf;

1228 
sc
.
sourû
 = &
v®ue
[1];

1229 
sc
.
Ëngths
 = &
log
->
süt
->lengths;

1230 
sc
.
v®ues
 = &
log
->
süt
->values;

1231 
sc
.
v¬ŸbËs
 = 
n
;

1232 
sc
.
com¶‘e_Ëngths
 = 1;

1233 
sc
.
com¶‘e_v®ues
 = 1;

1235 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

1236  
NGX_CONF_ERROR
;

1240 
´oûss_fÜm©s
:

1242 ià(
cf
->
¬gs
->
ÃÉs
 >= 3) {

1243 
Çme
 = 
v®ue
[2];

1245 ià(
	`ngx_¡rcmp
(
Çme
.
d©a
, "combined") == 0) {

1246 
lmcf
->
combšed_u£d
 = 1;

1250 
	`ngx_¡r_£t
(&
Çme
, "combined");

1251 
lmcf
->
combšed_u£d
 = 1;

1254 
fmt
 = 
lmcf
->
fÜm©s
.
–ts
;

1255 
i
 = 0; i < 
lmcf
->
fÜm©s
.
ÃÉs
; i++) {

1256 ià(
fmt
[
i
].
Çme
.
Ën
 ==‚ame.len

1257 && 
	`ngx_¡rÿ£cmp
(
fmt
[
i
].
Çme
.
d©a
,‚ame.data) == 0)

1259 
log
->
fÜm©
 = &
fmt
[
i
];

1264 ià(
log
->
fÜm©
 =ð
NULL
) {

1265 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1266 "unknowÀlog fÜm© \"%V\"", &
Çme
);

1267  
NGX_CONF_ERROR
;

1270 
size
 = 0;

1271 
æush
 = 0;

1272 
gz
 = 0;

1274 
i
 = 3; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

1276 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "buffer=", 7) == 0) {

1277 
s
.
Ën
 = 
v®ue
[
i
].len - 7;

1278 
s
.
d©a
 = 
v®ue
[
i
].data + 7;

1280 
size
 = 
	`ngx_·r£_size
(&
s
);

1282 ià(
size
 =ð
NGX_ERROR
 || size == 0) {

1283 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1284 "šv®id bufã¸siz\"%V\"", &
s
);

1285  
NGX_CONF_ERROR
;

1291 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "flush=", 6) == 0) {

1292 
s
.
Ën
 = 
v®ue
[
i
].len - 6;

1293 
s
.
d©a
 = 
v®ue
[
i
].data + 6;

1295 
æush
 = 
	`ngx_·r£_time
(&
s
, 0);

1297 ià(
æush
 =ð(
ngx_m£c_t
è
NGX_ERROR
 || flush == 0) {

1298 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1299 "šv®id flushim\"%V\"", &
s
);

1300  
NGX_CONF_ERROR
;

1306 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "gzip", 4) == 0

1307 && (
v®ue
[
i
].
Ën
 =ð4 || v®ue[i].
d©a
[4] == '='))

1309 #ià(
NGX_ZLIB
)

1310 ià(
size
 == 0) {

1311 
size
 = 64 * 1024;

1314 ià(
v®ue
[
i
].
Ën
 == 4) {

1315 
gz
 = 
Z_BEST_SPEED
;

1319 
s
.
Ën
 = 
v®ue
[
i
].len - 5;

1320 
s
.
d©a
 = 
v®ue
[
i
].data + 5;

1322 
gz
 = 
	`ngx_©oi
(
s
.
d©a
, s.
Ën
);

1324 ià(
gz
 < 1 || gzip > 9) {

1325 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1326 "šv®id com´essiÚ†ev– \"%V\"", &
s
);

1327  
NGX_CONF_ERROR
;

1333 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1335  
NGX_CONF_ERROR
;

1339 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "if=", 3) == 0) {

1340 
s
.
Ën
 = 
v®ue
[
i
].len - 3;

1341 
s
.
d©a
 = 
v®ue
[
i
].data + 3;

1343 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

1345 
ccv
.
cf
 = cf;

1346 
ccv
.
v®ue
 = &
s
;

1347 
ccv
.
com¶ex_v®ue
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,

1348 (
ngx_h‰p_com¶ex_v®ue_t
));

1349 ià(
ccv
.
com¶ex_v®ue
 =ð
NULL
) {

1350  
NGX_CONF_ERROR
;

1353 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

1354  
NGX_CONF_ERROR
;

1357 
log
->
fž‹r
 = 
ccv
.
com¶ex_v®ue
;

1362 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1363 "šv®id…¬am‘” \"%V\"", &
v®ue
[
i
]);

1364  
NGX_CONF_ERROR
;

1367 ià(
æush
 && 
size
 == 0) {

1368 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1370 &
v®ue
[1]);

1371  
NGX_CONF_ERROR
;

1374 ià(
size
) {

1376 ià(
log
->
süt
) {

1377 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1379  
NGX_CONF_ERROR
;

1382 ià(
log
->
sy¦og_³”
) {

1383 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1385  
NGX_CONF_ERROR
;

1388 ià(
log
->
fže
->
d©a
) {

1389 
bufãr
 = 
log
->
fže
->
d©a
;

1391 ià(
bufãr
->
Ï¡
 - bufãr->
¡¬t
 !ð
size


1392 || 
bufãr
->
æush
 != flush

1393 || 
bufãr
->
gz
 != gzip)

1395 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1398 &
v®ue
[1]);

1399  
NGX_CONF_ERROR
;

1402  
NGX_CONF_OK
;

1405 
bufãr
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_log_buf_t
));

1406 ià(
bufãr
 =ð
NULL
) {

1407  
NGX_CONF_ERROR
;

1410 
bufãr
->
¡¬t
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

1411 ià(
bufãr
->
¡¬t
 =ð
NULL
) {

1412  
NGX_CONF_ERROR
;

1415 
bufãr
->
pos
 = bufãr->
¡¬t
;

1416 
bufãr
->
Ï¡
 = bufãr->
¡¬t
 + 
size
;

1418 ià(
æush
) {

1419 
bufãr
->
ev’t
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_ev’t_t
));

1420 ià(
bufãr
->
ev’t
 =ð
NULL
) {

1421  
NGX_CONF_ERROR
;

1424 
bufãr
->
ev’t
->
d©a
 = 
log
->
fže
;

1425 
bufãr
->
ev’t
->
hªdËr
 = 
ngx_h‰p_log_æush_hªdËr
;

1426 
bufãr
->
ev’t
->
log
 = &
cf
->
cyþe
->
Ãw_log
;

1427 
bufãr
->
ev’t
->
ÿnûÏbË
 = 1;

1429 
bufãr
->
æush
 = flush;

1432 
bufãr
->
gz
 = gzip;

1434 
log
->
fže
->
æush
 = 
ngx_h‰p_log_æush
;

1435 
log
->
fže
->
d©a
 = 
bufãr
;

1438  
NGX_CONF_OK
;

1439 
	}
}

1443 
	$ngx_h‰p_log_£t_fÜm©
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1445 
ngx_h‰p_log_maš_cÚf_t
 *
lmcf
 = 
cÚf
;

1447 
ngx_¡r_t
 *
v®ue
;

1448 
ngx_ušt_t
 
i
;

1449 
ngx_h‰p_log_fmt_t
 *
fmt
;

1451 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1453 
fmt
 = 
lmcf
->
fÜm©s
.
–ts
;

1454 
i
 = 0; i < 
lmcf
->
fÜm©s
.
ÃÉs
; i++) {

1455 ià(
fmt
[
i
].
Çme
.
Ën
 =ð
v®ue
[1].len

1456 && 
	`ngx_¡rcmp
(
fmt
[
i
].
Çme
.
d©a
, 
v®ue
[1].data) == 0)

1458 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1460 &
v®ue
[1]);

1461  
NGX_CONF_ERROR
;

1465 
fmt
 = 
	`ngx_¬¿y_push
(&
lmcf
->
fÜm©s
);

1466 ià(
fmt
 =ð
NULL
) {

1467  
NGX_CONF_ERROR
;

1470 
fmt
->
Çme
 = 
v®ue
[1];

1472 
fmt
->
æushes
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4, (
ngx_št_t
));

1473 ià(
fmt
->
æushes
 =ð
NULL
) {

1474  
NGX_CONF_ERROR
;

1477 
fmt
->
Ýs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 16, (
ngx_h‰p_log_Ý_t
));

1478 ià(
fmt
->
Ýs
 =ð
NULL
) {

1479  
NGX_CONF_ERROR
;

1482  
	`ngx_h‰p_log_compže_fÜm©
(
cf
, 
fmt
->
æushes
, fmt->
Ýs
, cf->
¬gs
, 2);

1483 
	}
}

1487 
	$ngx_h‰p_log_compže_fÜm©
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
æushes
,

1488 
ngx_¬¿y_t
 *
Ýs
,‚gx_¬¿y_ˆ*
¬gs
, 
ngx_ušt_t
 
s
)

1490 
u_ch¬
 *
d©a
, *
p
, 
ch
;

1491 
size_t
 
i
, 
Ën
;

1492 
ngx_¡r_t
 *
v®ue
, 
v¬
;

1493 
ngx_št_t
 *
æush
;

1494 
ngx_ušt_t
 
b¿ck‘
;

1495 
ngx_h‰p_log_Ý_t
 *
Ý
;

1496 
ngx_h‰p_log_v¬_t
 *
v
;

1498 
v®ue
 = 
¬gs
->
–ts
;

1500  ; 
s
 < 
¬gs
->
ÃÉs
; s++) {

1502 
i
 = 0;

1504 
i
 < 
v®ue
[
s
].
Ën
) {

1506 
Ý
 = 
	`ngx_¬¿y_push
(
Ýs
);

1507 ià(
Ý
 =ð
NULL
) {

1508  
NGX_CONF_ERROR
;

1511 
d©a
 = &
v®ue
[
s
].d©a[
i
];

1513 ià(
v®ue
[
s
].
d©a
[
i
] == '$') {

1515 ià(++
i
 =ð
v®ue
[
s
].
Ën
) {

1516 
šv®id
;

1519 ià(
v®ue
[
s
].
d©a
[
i
] == '{') {

1520 
b¿ck‘
 = 1;

1522 ià(++
i
 =ð
v®ue
[
s
].
Ën
) {

1523 
šv®id
;

1526 
v¬
.
d©a
 = &
v®ue
[
s
].d©a[
i
];

1529 
b¿ck‘
 = 0;

1530 
v¬
.
d©a
 = &
v®ue
[
s
].d©a[
i
];

1533 
v¬
.
Ën
 = 0; 
i
 < 
v®ue
[
s
].len; i++, var.len++) {

1534 
ch
 = 
v®ue
[
s
].
d©a
[
i
];

1536 ià(
ch
 =ð'}' && 
b¿ck‘
) {

1537 
i
++;

1538 
b¿ck‘
 = 0;

1542 ià((
ch
 >= 'A' && ch <= 'Z')

1543 || (
ch
 >= 'a' && ch <= 'z')

1544 || (
ch
 >= '0' && ch <= '9')

1545 || 
ch
 == '_')

1553 ià(
b¿ck‘
) {

1554 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1556 "v¬ŸbË i missšg", &
v¬
);

1557  
NGX_CONF_ERROR
;

1560 ià(
v¬
.
Ën
 == 0) {

1561 
šv®id
;

1564 
v
 = 
ngx_h‰p_log_v¬s
; v->
Çme
.
Ën
; v++) {

1566 ià(
v
->
Çme
.
Ën
 =ð
v¬
.len

1567 && 
	`ngx_¡ºcmp
(
v
->
Çme
.
d©a
, 
v¬
.d©a, v¬.
Ën
) == 0)

1569 
Ý
->
Ën
 = 
v
->len;

1570 
Ý
->
g‘Ën
 = 
NULL
;

1571 
Ý
->
run
 = 
v
->run;

1572 
Ý
->
d©a
 = 0;

1574 
found
;

1578 ià(
	`ngx_h‰p_log_v¬ŸbË_compže
(
cf
, 
Ý
, &
v¬
è!ð
NGX_OK
) {

1579  
NGX_CONF_ERROR
;

1582 ià(
æushes
) {

1584 
æush
 = 
	`ngx_¬¿y_push
(
æushes
);

1585 ià(
æush
 =ð
NULL
) {

1586  
NGX_CONF_ERROR
;

1589 *
æush
 = 
Ý
->
d©a
;

1592 
found
:

1597 
i
++;

1599 
i
 < 
v®ue
[
s
].
Ën
 && v®ue[s].
d©a
[i] != '$') {

1600 
i
++;

1603 
Ën
 = &
v®ue
[
s
].
d©a
[
i
] - data;

1605 ià(
Ën
) {

1607 
Ý
->
Ën
 =†en;

1608 
Ý
->
g‘Ën
 = 
NULL
;

1610 ià(
Ën
 <ð(
ušŒ_t
)) {

1611 
Ý
->
run
 = 
ngx_h‰p_log_cÝy_shÜt
;

1612 
Ý
->
d©a
 = 0;

1614 
Ën
--) {

1615 
Ý
->
d©a
 <<= 8;

1616 
Ý
->
d©a
 |ðd©a[
Ën
];

1620 
Ý
->
run
 = 
ngx_h‰p_log_cÝy_lÚg
;

1622 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
Ën
);

1623 ià(
p
 =ð
NULL
) {

1624  
NGX_CONF_ERROR
;

1627 
	`ngx_memýy
(
p
, 
d©a
, 
Ën
);

1628 
Ý
->
d©a
 = (
ušŒ_t
è
p
;

1634  
NGX_CONF_OK
;

1636 
šv®id
:

1638 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "šv®id…¬am‘” \"%s\"", 
d©a
);

1640  
NGX_CONF_ERROR
;

1641 
	}
}

1645 
	$ngx_h‰p_log_Ý’_fže_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1647 
ngx_h‰p_log_loc_cÚf_t
 *
Îcf
 = 
cÚf
;

1649 
time_t
 
šaùive
, 
v®id
;

1650 
ngx_¡r_t
 *
v®ue
, 
s
;

1651 
ngx_št_t
 
max
, 
mš_u£s
;

1652 
ngx_ušt_t
 
i
;

1654 ià(
Îcf
->
Ý’_fže_ÿche
 !ð
NGX_CONF_UNSET_PTR
) {

1658 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1660 
max
 = 0;

1661 
šaùive
 = 10;

1662 
v®id
 = 60;

1663 
mš_u£s
 = 1;

1665 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

1667 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "max=", 4) == 0) {

1669 
max
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + 4, v®ue[i].
Ën
 - 4);

1670 ià(
max
 =ð
NGX_ERROR
) {

1671 
çžed
;

1677 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "inactive=", 9) == 0) {

1679 
s
.
Ën
 = 
v®ue
[
i
].len - 9;

1680 
s
.
d©a
 = 
v®ue
[
i
].data + 9;

1682 
šaùive
 = 
	`ngx_·r£_time
(&
s
, 1);

1683 ià(
šaùive
 =ð(
time_t
è
NGX_ERROR
) {

1684 
çžed
;

1690 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "min_uses=", 9) == 0) {

1692 
mš_u£s
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + 9, v®ue[i].
Ën
 - 9);

1693 ià(
mš_u£s
 =ð
NGX_ERROR
) {

1694 
çžed
;

1700 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "valid=", 6) == 0) {

1702 
s
.
Ën
 = 
v®ue
[
i
].len - 6;

1703 
s
.
d©a
 = 
v®ue
[
i
].data + 6;

1705 
v®id
 = 
	`ngx_·r£_time
(&
s
, 1);

1706 ià(
v®id
 =ð(
time_t
è
NGX_ERROR
) {

1707 
çžed
;

1713 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "off") == 0) {

1715 
Îcf
->
Ý’_fže_ÿche
 = 
NULL
;

1720 
çžed
:

1722 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1724 &
v®ue
[
i
]);

1725  
NGX_CONF_ERROR
;

1728 ià(
Îcf
->
Ý’_fže_ÿche
 =ð
NULL
) {

1729  
NGX_CONF_OK
;

1732 ià(
max
 == 0) {

1733 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1735  
NGX_CONF_ERROR
;

1738 
Îcf
->
Ý’_fže_ÿche
 = 
	`ngx_Ý’_fže_ÿche_š™
(
cf
->
poÞ
, 
max
, 
šaùive
);

1740 ià(
Îcf
->
Ý’_fže_ÿche
) {

1742 
Îcf
->
Ý’_fže_ÿche_v®id
 = 
v®id
;

1743 
Îcf
->
Ý’_fže_ÿche_mš_u£s
 = 
mš_u£s
;

1745  
NGX_CONF_OK
;

1748  
NGX_CONF_ERROR
;

1749 
	}
}

1752 
ngx_št_t


1753 
	$ngx_h‰p_log_š™
(
ngx_cÚf_t
 *
cf
)

1755 
ngx_¡r_t
 *
v®ue
;

1756 
ngx_¬¿y_t
 
a
;

1757 
ngx_h‰p_hªdËr_±
 *
h
;

1758 
ngx_h‰p_log_fmt_t
 *
fmt
;

1759 
ngx_h‰p_log_maš_cÚf_t
 *
lmcf
;

1760 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

1762 
lmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_log_moduË
);

1764 ià(
lmcf
->
combšed_u£d
) {

1765 ià(
	`ngx_¬¿y_š™
(&
a
, 
cf
->
poÞ
, 1, (
ngx_¡r_t
)è!ð
NGX_OK
) {

1766  
NGX_ERROR
;

1769 
v®ue
 = 
	`ngx_¬¿y_push
(&
a
);

1770 ià(
v®ue
 =ð
NULL
) {

1771  
NGX_ERROR
;

1774 *
v®ue
 = 
ngx_h‰p_combšed_fmt
;

1775 
fmt
 = 
lmcf
->
fÜm©s
.
–ts
;

1777 ià(
	`ngx_h‰p_log_compže_fÜm©
(
cf
, 
NULL
, 
fmt
->
Ýs
, &
a
, 0)

1778 !ð
NGX_CONF_OK
)

1780  
NGX_ERROR
;

1784 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

1786 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_LOG_PHASE
].
hªdËrs
);

1787 ià(
h
 =ð
NULL
) {

1788  
NGX_ERROR
;

1791 *
h
 = 
ngx_h‰p_log_hªdËr
;

1793  
NGX_OK
;

1794 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_map_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_ušt_t
 
	mhash_max_size
;

15 
ngx_ušt_t
 
	mhash_buck‘_size
;

16 } 
	tngx_h‰p_m­_cÚf_t
;

20 
ngx_hash_keys_¬¿ys_t
 
	mkeys
;

22 
ngx_¬¿y_t
 *
	mv®ues_hash
;

23 
ngx_¬¿y_t
 
	mv¬_v®ues
;

24 #ià(
NGX_PCRE
)

25 
ngx_¬¿y_t
 
	m»gexes
;

28 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
	mdeçuÉ_v®ue
;

29 
ngx_cÚf_t
 *
	mcf
;

30 
ngx_ušt_t
 
	mho¡Çmes
;

31 } 
	tngx_h‰p_m­_cÚf_ùx_t
;

35 
ngx_h‰p_m­_t
 
	mm­
;

36 
ngx_h‰p_com¶ex_v®ue_t
 
	mv®ue
;

37 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
	mdeçuÉ_v®ue
;

38 
ngx_ušt_t
 
	mho¡Çmes
;

39 } 
	tngx_h‰p_m­_ùx_t
;

42 
ngx_libc_cdeþ
 
ngx_h‰p_m­_cmp_dns_wždÿrds
(cÚ¡ *
Úe
,

43 cÚ¡ *
two
);

44 *
ngx_h‰p_m­_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

45 *
ngx_h‰p_m­_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

46 *
ngx_h‰p_m­
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
, *
cÚf
);

49 
ngx_commªd_t
 
	gngx_h‰p_m­_commªds
[] = {

51 { 
ngx_¡ršg
("map"),

52 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_TAKE2
,

53 
ngx_h‰p_m­_block
,

54 
NGX_HTTP_MAIN_CONF_OFFSET
,

56 
NULL
 },

58 { 
ngx_¡ršg
("map_hash_max_size"),

59 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

60 
ngx_cÚf_£t_num_¦Ù
,

61 
NGX_HTTP_MAIN_CONF_OFFSET
,

62 
off£tof
(
ngx_h‰p_m­_cÚf_t
, 
hash_max_size
),

63 
NULL
 },

65 { 
ngx_¡ršg
("map_hash_bucket_size"),

66 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

67 
ngx_cÚf_£t_num_¦Ù
,

68 
NGX_HTTP_MAIN_CONF_OFFSET
,

69 
off£tof
(
ngx_h‰p_m­_cÚf_t
, 
hash_buck‘_size
),

70 
NULL
 },

72 
ngx_nuÎ_commªd


76 
ngx_h‰p_moduË_t
 
	gngx_h‰p_m­_moduË_ùx
 = {

77 
NULL
,

78 
NULL
,

80 
ngx_h‰p_m­_ü—‹_cÚf
,

81 
NULL
,

83 
NULL
,

84 
NULL
,

86 
NULL
,

87 
NULL


91 
ngx_moduË_t
 
	gngx_h‰p_m­_moduË
 = {

92 
NGX_MODULE_V1
,

93 &
ngx_h‰p_m­_moduË_ùx
,

94 
ngx_h‰p_m­_commªds
,

95 
NGX_HTTP_MODULE
,

96 
NULL
,

97 
NULL
,

98 
NULL
,

99 
NULL
,

100 
NULL
,

101 
NULL
,

102 
NULL
,

103 
NGX_MODULE_V1_PADDING


107 
ngx_št_t


108 
	$ngx_h‰p_m­_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

109 
ušŒ_t
 
d©a
)

111 
ngx_h‰p_m­_ùx_t
 *
m­
 = (ngx_h‰p_m­_ùx_ˆ*è
d©a
;

113 
ngx_¡r_t
 
v®
;

114 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®ue
;

116 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

119 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
m­
->
v®ue
, &
v®
è!ð
NGX_OK
) {

120  
NGX_ERROR
;

123 ià(
m­
->
ho¡Çmes
 && 
v®
.
Ën
 > 0 && v®.
d©a
[val.len - 1] == '.') {

124 
v®
.
Ën
--;

127 
v®ue
 = 
	`ngx_h‰p_m­_fšd
(
r
, &
m­
->m­, &
v®
);

129 ià(
v®ue
 =ð
NULL
) {

130 
v®ue
 = 
m­
->
deçuÉ_v®ue
;

133 ià(!
v®ue
->
v®id
) {

134 
v®ue
 = 
	`ngx_h‰p_g‘_æushed_v¬ŸbË
(
r
, (
ušŒ_t
èv®ue->
d©a
);

136 ià(
v®ue
 =ð
NULL
 || v®ue->
nÙ_found
) {

137 
v®ue
 = &
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

141 *
v
 = *
v®ue
;

143 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

144 "h‰°m­: \"%v\" \"%v\"", &
v®
, 
v
);

146  
NGX_OK
;

147 
	}
}

151 
	$ngx_h‰p_m­_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

153 
ngx_h‰p_m­_cÚf_t
 *
mcf
;

155 
mcf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_m­_cÚf_t
));

156 ià(
mcf
 =ð
NULL
) {

157  
NULL
;

160 
mcf
->
hash_max_size
 = 
NGX_CONF_UNSET_UINT
;

161 
mcf
->
hash_buck‘_size
 = 
NGX_CONF_UNSET_UINT
;

163  
mcf
;

164 
	}
}

168 
	$ngx_h‰p_m­_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

170 
ngx_h‰p_m­_cÚf_t
 *
mcf
 = 
cÚf
;

172 *
rv
;

173 
ngx_¡r_t
 *
v®ue
, 
Çme
;

174 
ngx_cÚf_t
 
§ve
;

175 
ngx_poÞ_t
 *
poÞ
;

176 
ngx_hash_š™_t
 
hash
;

177 
ngx_h‰p_m­_ùx_t
 *
m­
;

178 
ngx_h‰p_v¬ŸbË_t
 *
v¬
;

179 
ngx_h‰p_m­_cÚf_ùx_t
 
ùx
;

180 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

182 ià(
mcf
->
hash_max_size
 =ð
NGX_CONF_UNSET_UINT
) {

183 
mcf
->
hash_max_size
 = 2048;

186 ià(
mcf
->
hash_buck‘_size
 =ð
NGX_CONF_UNSET_UINT
) {

187 
mcf
->
hash_buck‘_size
 = 
ngx_ÿch–še_size
;

190 
mcf
->
hash_buck‘_size
 = 
	`ngx_®ign
(mcf->hash_bucket_size,

191 
ngx_ÿch–še_size
);

194 
m­
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_m­_ùx_t
));

195 ià(
m­
 =ð
NULL
) {

196  
NGX_CONF_ERROR
;

199 
v®ue
 = 
cf
->
¬gs
->
–ts
;

201 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

203 
ccv
.
cf
 = cf;

204 
ccv
.
v®ue
 = &value[1];

205 
ccv
.
com¶ex_v®ue
 = &
m­
->
v®ue
;

207 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

208  
NGX_CONF_ERROR
;

211 
Çme
 = 
v®ue
[2];

213 ià(
Çme
.
d©a
[0] != '$') {

214 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

215 "šv®id v¬ŸbË‚am\"%V\"", &
Çme
);

216  
NGX_CONF_ERROR
;

219 
Çme
.
Ën
--;

220 
Çme
.
d©a
++;

222 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
Çme
, 
NGX_HTTP_VAR_CHANGEABLE
);

223 ià(
v¬
 =ð
NULL
) {

224  
NGX_CONF_ERROR
;

227 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_m­_v¬ŸbË
;

228 
v¬
->
d©a
 = (
ušŒ_t
è
m­
;

230 
poÞ
 = 
	`ngx_ü—‹_poÞ
(
NGX_DEFAULT_POOL_SIZE
, 
cf
->
log
);

231 ià(
poÞ
 =ð
NULL
) {

232  
NGX_CONF_ERROR
;

235 
ùx
.
keys
.
poÞ
 = 
cf
->pool;

236 
ùx
.
keys
.
‹mp_poÞ
 = 
poÞ
;

238 ià(
	`ngx_hash_keys_¬¿y_š™
(&
ùx
.
keys
, 
NGX_HASH_LARGE
è!ð
NGX_OK
) {

239 
	`ngx_de¡roy_poÞ
(
poÞ
);

240  
NGX_CONF_ERROR
;

243 
ùx
.
v®ues_hash
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_¬¿y_t
è* ctx.
keys
.
hsize
);

244 ià(
ùx
.
v®ues_hash
 =ð
NULL
) {

245 
	`ngx_de¡roy_poÞ
(
poÞ
);

246  
NGX_CONF_ERROR
;

249 ià(
	`ngx_¬¿y_š™
(&
ùx
.
v¬_v®ues
, 
cf
->
poÞ
, 2,

250 (
ngx_h‰p_v¬ŸbË_v®ue_t
))

251 !ð
NGX_OK
)

253 
	`ngx_de¡roy_poÞ
(
poÞ
);

254  
NGX_CONF_ERROR
;

257 #ià(
NGX_PCRE
)

258 ià(
	`ngx_¬¿y_š™
(&
ùx
.
»gexes
, 
cf
->
poÞ
, 2, (
ngx_h‰p_m­_»gex_t
))

259 !ð
NGX_OK
)

261 
	`ngx_de¡roy_poÞ
(
poÞ
);

262  
NGX_CONF_ERROR
;

266 
ùx
.
deçuÉ_v®ue
 = 
NULL
;

267 
ùx
.
cf
 = &
§ve
;

268 
ùx
.
ho¡Çmes
 = 0;

270 
§ve
 = *
cf
;

271 
cf
->
poÞ
 =…ool;

272 
cf
->
ùx
 = &ctx;

273 
cf
->
hªdËr
 = 
ngx_h‰p_m­
;

274 
cf
->
hªdËr_cÚf
 = 
cÚf
;

276 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

278 *
cf
 = 
§ve
;

280 ià(
rv
 !ð
NGX_CONF_OK
) {

281 
	`ngx_de¡roy_poÞ
(
poÞ
);

282  
rv
;

285 
m­
->
deçuÉ_v®ue
 = 
ùx
.default_value ? ctx.default_value:

286 &
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

288 
m­
->
ho¡Çmes
 = 
ùx
.hostnames;

290 
hash
.
key
 = 
ngx_hash_key_lc
;

291 
hash
.
max_size
 = 
mcf
->
hash_max_size
;

292 
hash
.
buck‘_size
 = 
mcf
->
hash_buck‘_size
;

293 
hash
.
Çme
 = "map_hash";

294 
hash
.
poÞ
 = 
cf
->pool;

296 ià(
ùx
.
keys
.keys.
ÃÉs
) {

297 
hash
.hash = &
m­
->map.hash.hash;

298 
hash
.
‹mp_poÞ
 = 
NULL
;

300 ià(
	`ngx_hash_š™
(&
hash
, 
ùx
.
keys
.keys.
–ts
, ctx.keys.keys.
ÃÉs
)

301 !ð
NGX_OK
)

303 
	`ngx_de¡roy_poÞ
(
poÞ
);

304  
NGX_CONF_ERROR
;

308 ià(
ùx
.
keys
.
dns_wc_h—d
.
ÃÉs
) {

310 
	`ngx_qsÜt
(
ùx
.
keys
.
dns_wc_h—d
.
–ts
,

311 (
size_t
è
ùx
.
keys
.
dns_wc_h—d
.
ÃÉs
,

312 (
ngx_hash_key_t
), 
ngx_h‰p_m­_cmp_dns_wždÿrds
);

314 
hash
.hash = 
NULL
;

315 
hash
.
‹mp_poÞ
 = 
poÞ
;

317 ià(
	`ngx_hash_wždÿrd_š™
(&
hash
, 
ùx
.
keys
.
dns_wc_h—d
.
–ts
,

318 
ùx
.
keys
.
dns_wc_h—d
.
ÃÉs
)

319 !ð
NGX_OK
)

321 
	`ngx_de¡roy_poÞ
(
poÞ
);

322  
NGX_CONF_ERROR
;

325 
m­
->m­.
hash
.
wc_h—d
 = (
ngx_hash_wždÿrd_t
 *) hash.hash;

328 ià(
ùx
.
keys
.
dns_wc_ž
.
ÃÉs
) {

330 
	`ngx_qsÜt
(
ùx
.
keys
.
dns_wc_ž
.
–ts
,

331 (
size_t
è
ùx
.
keys
.
dns_wc_ž
.
ÃÉs
,

332 (
ngx_hash_key_t
), 
ngx_h‰p_m­_cmp_dns_wždÿrds
);

334 
hash
.hash = 
NULL
;

335 
hash
.
‹mp_poÞ
 = 
poÞ
;

337 ià(
	`ngx_hash_wždÿrd_š™
(&
hash
, 
ùx
.
keys
.
dns_wc_ž
.
–ts
,

338 
ùx
.
keys
.
dns_wc_ž
.
ÃÉs
)

339 !ð
NGX_OK
)

341 
	`ngx_de¡roy_poÞ
(
poÞ
);

342  
NGX_CONF_ERROR
;

345 
m­
->m­.
hash
.
wc_ž
 = (
ngx_hash_wždÿrd_t
 *) hash.hash;

348 #ià(
NGX_PCRE
)

350 ià(
ùx
.
»gexes
.
ÃÉs
) {

351 
m­
->m­.
»gex
 = 
ùx
.
»gexes
.
–ts
;

352 
m­
->m­.
Äegex
 = 
ùx
.
»gexes
.
ÃÉs
;

357 
	`ngx_de¡roy_poÞ
(
poÞ
);

359  
rv
;

360 
	}
}

363 
ngx_libc_cdeþ


364 
	$ngx_h‰p_m­_cmp_dns_wždÿrds
(cÚ¡ *
Úe
, cÚ¡ *
two
)

366 
ngx_hash_key_t
 *
fœ¡
, *
£cÚd
;

368 
fœ¡
 = (
ngx_hash_key_t
 *è
Úe
;

369 
£cÚd
 = (
ngx_hash_key_t
 *è
two
;

371  
	`ngx_dns_¡rcmp
(
fœ¡
->
key
.
d©a
, 
£cÚd
->key.data);

372 
	}
}

376 
	$ngx_h‰p_m­
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
, *
cÚf
)

378 
ngx_št_t
 
rc
, 
šdex
;

379 
ngx_¡r_t
 *
v®ue
, 
Çme
;

380 
ngx_ušt_t
 
i
, 
key
;

381 
ngx_h‰p_m­_cÚf_ùx_t
 *
ùx
;

382 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v¬
, **
vp
;

384 
ùx
 = 
cf
->ctx;

386 
v®ue
 = 
cf
->
¬gs
->
–ts
;

388 ià(
cf
->
¬gs
->
ÃÉs
 == 1

389 && 
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "hostnames") == 0)

391 
ùx
->
ho¡Çmes
 = 1;

392  
NGX_CONF_OK
;

394 } ià(
cf
->
¬gs
->
ÃÉs
 != 2) {

395 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

397  
NGX_CONF_ERROR
;

400 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "include") == 0) {

401  
	`ngx_cÚf_šþude
(
cf
, 
dummy
, 
cÚf
);

404 ià(
v®ue
[1].
d©a
[0] == '$') {

405 
Çme
 = 
v®ue
[1];

406 
Çme
.
Ën
--;

407 
Çme
.
d©a
++;

409 
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
ùx
->
cf
, &
Çme
);

410 ià(
šdex
 =ð
NGX_ERROR
) {

411  
NGX_CONF_ERROR
;

414 
v¬
 = 
ùx
->
v¬_v®ues
.
–ts
;

416 
i
 = 0; i < 
ùx
->
v¬_v®ues
.
ÃÉs
; i++) {

417 ià(
šdex
 =ð(
šŒ_t
è
v¬
[
i
].
d©a
) {

418 
v¬
 = &v¬[
i
];

419 
found
;

423 
v¬
 = 
	`ngx_¬¿y_push
(&
ùx
->
v¬_v®ues
);

424 ià(
v¬
 =ð
NULL
) {

425  
NGX_CONF_ERROR
;

428 
v¬
->
v®id
 = 0;

429 
v¬
->
no_ÿch—bË
 = 0;

430 
v¬
->
nÙ_found
 = 0;

431 
v¬
->
Ën
 = 0;

432 
v¬
->
d©a
 = (
u_ch¬
 *è(
šŒ_t
è
šdex
;

434 
found
;

437 
key
 = 0;

439 
i
 = 0; i < 
v®ue
[1].
Ën
; i++) {

440 
key
 = 
	`ngx_hash
(key, 
v®ue
[1].
d©a
[
i
]);

443 
key
 %ð
ùx
->
keys
.
hsize
;

445 
vp
 = 
ùx
->
v®ues_hash
[
key
].
–ts
;

447 ià(
vp
) {

448 
i
 = 0; i < 
ùx
->
v®ues_hash
[
key
].
ÃÉs
; i++) {

449 ià(
v®ue
[1].
Ën
 !ð(
size_t
è
vp
[
i
]->len) {

453 ià(
	`ngx_¡ºcmp
(
v®ue
[1].
d©a
, 
vp
[
i
]->d©a, v®ue[1].
Ën
) == 0) {

454 
v¬
 = 
vp
[
i
];

455 
found
;

460 ià(
	`ngx_¬¿y_š™
(&
ùx
->
v®ues_hash
[
key
], 
cf
->
poÞ
, 4,

461 (
ngx_h‰p_v¬ŸbË_v®ue_t
 *))

462 !ð
NGX_OK
)

464  
NGX_CONF_ERROR
;

468 
v¬
 = 
	`ngx_·Îoc
(
ùx
->
keys
.
poÞ
, (
ngx_h‰p_v¬ŸbË_v®ue_t
));

469 ià(
v¬
 =ð
NULL
) {

470  
NGX_CONF_ERROR
;

473 
v¬
->
Ën
 = 
v®ue
[1].len;

474 
v¬
->
d©a
 = 
	`ngx_p¡rdup
(
ùx
->
keys
.
poÞ
, &
v®ue
[1]);

475 ià(
v¬
->
d©a
 =ð
NULL
) {

476  
NGX_CONF_ERROR
;

479 
v¬
->
v®id
 = 1;

480 
v¬
->
no_ÿch—bË
 = 0;

481 
v¬
->
nÙ_found
 = 0;

483 
vp
 = 
	`ngx_¬¿y_push
(&
ùx
->
v®ues_hash
[
key
]);

484 ià(
vp
 =ð
NULL
) {

485  
NGX_CONF_ERROR
;

488 *
vp
 = 
v¬
;

490 
found
:

492 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "default") == 0) {

494 ià(
ùx
->
deçuÉ_v®ue
) {

495 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

497  
NGX_CONF_ERROR
;

500 
ùx
->
deçuÉ_v®ue
 = 
v¬
;

502  
NGX_CONF_OK
;

505 #ià(
NGX_PCRE
)

507 ià(
v®ue
[0].
Ën
 && v®ue[0].
d©a
[0] == '~') {

508 
ngx_»gex_compže_t
 
rc
;

509 
ngx_h‰p_m­_»gex_t
 *
»gex
;

510 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

512 
»gex
 = 
	`ngx_¬¿y_push
(&
ùx
->
»gexes
);

513 ià(
»gex
 =ð
NULL
) {

514  
NGX_CONF_ERROR
;

517 
v®ue
[0].
Ën
--;

518 
v®ue
[0].
d©a
++;

520 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

522 ià(
v®ue
[0].
d©a
[0] == '*') {

523 
v®ue
[0].
Ën
--;

524 
v®ue
[0].
d©a
++;

525 
rc
.
ÝtiÚs
 = 
NGX_REGEX_CASELESS
;

528 
rc
.
·‰”n
 = 
v®ue
[0];

529 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

530 
rc
.
”r
.
d©a
 = 
”r¡r
;

532 
»gex
->»gex = 
	`ngx_h‰p_»gex_compže
(
ùx
->
cf
, &
rc
);

533 ià(
»gex
->»gex =ð
NULL
) {

534  
NGX_CONF_ERROR
;

537 
»gex
->
v®ue
 = 
v¬
;

539  
NGX_CONF_OK
;

544 ià(
v®ue
[0].
Ën
 && v®ue[0].
d©a
[0] == '\\') {

545 
v®ue
[0].
Ën
--;

546 
v®ue
[0].
d©a
++;

549 
rc
 = 
	`ngx_hash_add_key
(&
ùx
->
keys
, &
v®ue
[0], 
v¬
,

550 (
ùx
->
ho¡Çmes
è? 
NGX_HASH_WILDCARD_KEY
 : 0);

552 ià(
rc
 =ð
NGX_OK
) {

553  
NGX_CONF_OK
;

556 ià(
rc
 =ð
NGX_DECLINED
) {

557 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

558 "šv®id ho¡ÇmÜ wždÿrd \"%V\"", &
v®ue
[0]);

561 ià(
rc
 =ð
NGX_BUSY
) {

562 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

563 "cÚæiùšg…¬am‘” \"%V\"", &
v®ue
[0]);

566  
NGX_CONF_ERROR
;

567 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_memcached_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_h‰p_up¡»am_cÚf_t
 
	mup¡»am
;

15 
ngx_št_t
 
	mšdex
;

16 
ngx_ušt_t
 
	mgz_æag
;

17 } 
	tngx_h‰p_memÿched_loc_cÚf_t
;

21 
size_t
 
	m»¡
;

22 
ngx_h‰p_»que¡_t
 *
	m»que¡
;

23 
ngx_¡r_t
 
	mkey
;

24 } 
	tngx_h‰p_memÿched_ùx_t
;

27 
ngx_št_t
 
ngx_h‰p_memÿched_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

28 
ngx_št_t
 
ngx_h‰p_memÿched_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

29 
ngx_št_t
 
ngx_h‰p_memÿched_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

30 
ngx_št_t
 
ngx_h‰p_memÿched_fž‹r_š™
(*
d©a
);

31 
ngx_št_t
 
ngx_h‰p_memÿched_fž‹r
(*
d©a
, 
ssize_t
 
by‹s
);

32 
ngx_h‰p_memÿched_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

33 
ngx_h‰p_memÿched_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

34 
ngx_št_t
 
rc
);

36 *
ngx_h‰p_memÿched_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

37 *
ngx_h‰p_memÿched_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

38 *
·»Á
, *
chžd
);

40 *
ngx_h‰p_memÿched_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

41 *
cÚf
);

44 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_memÿched_Ãxt_up¡»am_masks
[] = {

45 { 
ngx_¡ršg
("”rÜ"), 
NGX_HTTP_UPSTREAM_FT_ERROR
 },

46 { 
ngx_¡ršg
("timeout"), 
NGX_HTTP_UPSTREAM_FT_TIMEOUT
 },

47 { 
ngx_¡ršg
("šv®id_»¥Ú£"), 
NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
 },

48 { 
ngx_¡ršg
("nÙ_found"), 
NGX_HTTP_UPSTREAM_FT_HTTP_404
 },

49 { 
ngx_¡ršg
("off"), 
NGX_HTTP_UPSTREAM_FT_OFF
 },

50 { 
ngx_nuÎ_¡ršg
, 0 }

54 
ngx_commªd_t
 
	gngx_h‰p_memÿched_commªds
[] = {

56 { 
ngx_¡ršg
("memcached_pass"),

57 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF
|
NGX_CONF_TAKE1
,

58 
ngx_h‰p_memÿched_·ss
,

59 
NGX_HTTP_LOC_CONF_OFFSET
,

61 
NULL
 },

63 { 
ngx_¡ršg
("memcached_bind"),

64 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

65 
ngx_h‰p_up¡»am_bšd_£t_¦Ù
,

66 
NGX_HTTP_LOC_CONF_OFFSET
,

67 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
up¡»am
.
loÿl
),

68 
NULL
 },

70 { 
ngx_¡ršg
("memcached_connect_timeout"),

71 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

72 
ngx_cÚf_£t_m£c_¦Ù
,

73 
NGX_HTTP_LOC_CONF_OFFSET
,

74 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
up¡»am
.
cÚÃù_timeout
),

75 
NULL
 },

77 { 
ngx_¡ršg
("memcached_send_timeout"),

78 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

79 
ngx_cÚf_£t_m£c_¦Ù
,

80 
NGX_HTTP_LOC_CONF_OFFSET
,

81 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
up¡»am
.
£nd_timeout
),

82 
NULL
 },

84 { 
ngx_¡ršg
("memcached_buffer_size"),

85 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

86 
ngx_cÚf_£t_size_¦Ù
,

87 
NGX_HTTP_LOC_CONF_OFFSET
,

88 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
up¡»am
.
bufãr_size
),

89 
NULL
 },

91 { 
ngx_¡ršg
("memcached_read_timeout"),

92 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

93 
ngx_cÚf_£t_m£c_¦Ù
,

94 
NGX_HTTP_LOC_CONF_OFFSET
,

95 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
up¡»am
.
»ad_timeout
),

96 
NULL
 },

98 { 
ngx_¡ršg
("memcached_next_upstream"),

99 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

100 
ngx_cÚf_£t_b™mask_¦Ù
,

101 
NGX_HTTP_LOC_CONF_OFFSET
,

102 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am
),

103 &
ngx_h‰p_memÿched_Ãxt_up¡»am_masks
 },

105 { 
ngx_¡ršg
("memcached_next_upstream_tries"),

106 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

107 
ngx_cÚf_£t_num_¦Ù
,

108 
NGX_HTTP_LOC_CONF_OFFSET
,

109 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_Œ›s
),

110 
NULL
 },

112 { 
ngx_¡ršg
("memcached_next_upstream_timeout"),

113 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

114 
ngx_cÚf_£t_m£c_¦Ù
,

115 
NGX_HTTP_LOC_CONF_OFFSET
,

116 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_timeout
),

117 
NULL
 },

119 { 
ngx_¡ršg
("memcached_gzip_flag"),

120 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

121 
ngx_cÚf_£t_num_¦Ù
,

122 
NGX_HTTP_LOC_CONF_OFFSET
,

123 
off£tof
(
ngx_h‰p_memÿched_loc_cÚf_t
, 
gz_æag
),

124 
NULL
 },

126 
ngx_nuÎ_commªd


130 
ngx_h‰p_moduË_t
 
	gngx_h‰p_memÿched_moduË_ùx
 = {

131 
NULL
,

132 
NULL
,

134 
NULL
,

135 
NULL
,

137 
NULL
,

138 
NULL
,

140 
ngx_h‰p_memÿched_ü—‹_loc_cÚf
,

141 
ngx_h‰p_memÿched_m”ge_loc_cÚf


145 
ngx_moduË_t
 
	gngx_h‰p_memÿched_moduË
 = {

146 
NGX_MODULE_V1
,

147 &
ngx_h‰p_memÿched_moduË_ùx
,

148 
ngx_h‰p_memÿched_commªds
,

149 
NGX_HTTP_MODULE
,

150 
NULL
,

151 
NULL
,

152 
NULL
,

153 
NULL
,

154 
NULL
,

155 
NULL
,

156 
NULL
,

157 
NGX_MODULE_V1_PADDING


161 
ngx_¡r_t
 
	gngx_h‰p_memÿched_key
 = 
ngx_¡ršg
("memcached_key");

164 
	#NGX_HTTP_MEMCACHED_END
 ((
ngx_h‰p_memÿched_’d
è- 1)

	)

165 
u_ch¬
 
	gngx_h‰p_memÿched_’d
[] = 
CRLF
 "END" CRLF;

168 
ngx_št_t


169 
	$ngx_h‰p_memÿched_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

171 
ngx_št_t
 
rc
;

172 
ngx_h‰p_up¡»am_t
 *
u
;

173 
ngx_h‰p_memÿched_ùx_t
 *
ùx
;

174 
ngx_h‰p_memÿched_loc_cÚf_t
 *
mlcf
;

176 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
))) {

177  
NGX_HTTP_NOT_ALLOWED
;

180 
rc
 = 
	`ngx_h‰p_disÿrd_»que¡_body
(
r
);

182 ià(
rc
 !ð
NGX_OK
) {

183  
rc
;

186 ià(
	`ngx_h‰p_£t_cÚ‹Á_ty³
(
r
è!ð
NGX_OK
) {

187  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

190 ià(
	`ngx_h‰p_up¡»am_ü—‹
(
r
è!ð
NGX_OK
) {

191  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

194 
u
 = 
r
->
up¡»am
;

196 
	`ngx_¡r_£t
(&
u
->
schema
, "memcached://");

197 
u
->
ouut
.
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_memÿched_moduË
;

199 
mlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_memÿched_moduË
);

201 
u
->
cÚf
 = &
mlcf
->
up¡»am
;

203 
u
->
ü—‹_»que¡
 = 
ngx_h‰p_memÿched_ü—‹_»que¡
;

204 
u
->
»š™_»que¡
 = 
ngx_h‰p_memÿched_»š™_»que¡
;

205 
u
->
´oûss_h—d”
 = 
ngx_h‰p_memÿched_´oûss_h—d”
;

206 
u
->
abÜt_»que¡
 = 
ngx_h‰p_memÿched_abÜt_»que¡
;

207 
u
->
fš®ize_»que¡
 = 
ngx_h‰p_memÿched_fš®ize_»que¡
;

209 
ùx
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_memÿched_ùx_t
));

210 ià(
ùx
 =ð
NULL
) {

211  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

214 
ùx
->
»que¡
 = 
r
;

216 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_memÿched_moduË
);

218 
u
->
šput_fž‹r_š™
 = 
ngx_h‰p_memÿched_fž‹r_š™
;

219 
u
->
šput_fž‹r
 = 
ngx_h‰p_memÿched_fž‹r
;

220 
u
->
šput_fž‹r_ùx
 = 
ùx
;

222 
r
->
maš
->
couÁ
++;

224 
	`ngx_h‰p_up¡»am_š™
(
r
);

226  
NGX_DONE
;

227 
	}
}

230 
ngx_št_t


231 
	$ngx_h‰p_memÿched_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

233 
size_t
 
Ën
;

234 
ušŒ_t
 
esÿ³
;

235 
ngx_buf_t
 *
b
;

236 
ngx_chaš_t
 *
þ
;

237 
ngx_h‰p_memÿched_ùx_t
 *
ùx
;

238 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

239 
ngx_h‰p_memÿched_loc_cÚf_t
 *
mlcf
;

241 
mlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_memÿched_moduË
);

243 
vv
 = 
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
r
, 
mlcf
->
šdex
);

245 ià(
vv
 =ð
NULL
 || vv->
nÙ_found
 || vv->
Ën
 == 0) {

246 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

248  
NGX_ERROR
;

251 
esÿ³
 = 2 * 
	`ngx_esÿ³_uri
(
NULL
, 
vv
->
d©a
, vv->
Ën
, 
NGX_ESCAPE_MEMCACHED
);

253 
Ën
 = ("g‘ "è- 1 + 
vv
->ËÀ+ 
esÿ³
 + (
CRLF
) - 1;

255 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
Ën
);

256 ià(
b
 =ð
NULL
) {

257  
NGX_ERROR
;

260 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

261 ià(
þ
 =ð
NULL
) {

262  
NGX_ERROR
;

265 
þ
->
buf
 = 
b
;

266 
þ
->
Ãxt
 = 
NULL
;

268 
r
->
up¡»am
->
»que¡_bufs
 = 
þ
;

270 *
b
->
Ï¡
++ = 'g'; *b->last++ = 'e'; *b->last++ = 't'; *b->last++ = ' ';

272 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_memÿched_moduË
);

274 
ùx
->
key
.
d©a
 = 
b
->
Ï¡
;

276 ià(
esÿ³
 == 0) {

277 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
vv
->
d©a
, vv->
Ën
);

280 
b
->
Ï¡
 = (
u_ch¬
 *è
	`ngx_esÿ³_uri
(b->Ï¡, 
vv
->
d©a
, vv->
Ën
,

281 
NGX_ESCAPE_MEMCACHED
);

284 
ùx
->
key
.
Ën
 = 
b
->
Ï¡
 - ctx->key.
d©a
;

286 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

287 "h‰°memÿched„eque¡: \"%V\"", &
ùx
->
key
);

289 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

291  
NGX_OK
;

292 
	}
}

295 
ngx_št_t


296 
	$ngx_h‰p_memÿched_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

298  
NGX_OK
;

299 
	}
}

302 
ngx_št_t


303 
	$ngx_h‰p_memÿched_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

305 
u_ch¬
 *
p
, *
¡¬t
;

306 
ngx_¡r_t
 
lše
;

307 
ngx_ušt_t
 
æags
;

308 
ngx_bË_–t_t
 *
h
;

309 
ngx_h‰p_up¡»am_t
 *
u
;

310 
ngx_h‰p_memÿched_ùx_t
 *
ùx
;

311 
ngx_h‰p_memÿched_loc_cÚf_t
 *
mlcf
;

313 
u
 = 
r
->
up¡»am
;

315 
p
 = 
u
->
bufãr
.
pos
;… < u->bufãr.
Ï¡
;…++) {

316 ià(*
p
 =ð
LF
) {

317 
found
;

321  
NGX_AGAIN
;

323 
found
:

325 
lše
.
d©a
 = 
u
->
bufãr
.
pos
;

326 
lše
.
Ën
 = 
p
 - 
u
->
bufãr
.
pos
;

328 ià(
lše
.
Ën
 =ð0 || *(
p
 - 1è!ð
CR
) {

329 
no_v®id
;

332 *
p
 = '\0';

333 
lše
.
Ën
--;

335 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

336 "memÿched: \"%V\"", &
lše
);

338 
p
 = 
u
->
bufãr
.
pos
;

340 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_memÿched_moduË
);

341 
mlcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_memÿched_moduË
);

343 ià(
	`ngx_¡ºcmp
(
p
, "VALUE ", ("VALUE ") - 1) == 0) {

345 
p
 += ("VALUE ") - 1;

347 ià(
	`ngx_¡ºcmp
(
p
, 
ùx
->
key
.
d©a
, ctx->key.
Ën
) != 0) {

348 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

351 &
lše
, &
ùx
->
key
);

353  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

356 
p
 +ð
ùx
->
key
.
Ën
;

358 ià(*
p
++ != ' ') {

359 
no_v®id
;

364 
¡¬t
 = 
p
;

366 *
p
) {

367 ià(*
p
++ == ' ') {

368 ià(
mlcf
->
gz_æag
) {

369 
æags
;

371 
Ëngth
;

376 
no_v®id
;

378 
æags
:

380 
æags
 = 
	`ngx_©oi
(
¡¬t
, 
p
 - start - 1);

382 ià(
æags
 =ð(
ngx_ušt_t
è
NGX_ERROR
) {

383 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

386 &
lše
, &
ùx
->
key
);

387  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

390 ià(
æags
 & 
mlcf
->
gz_æag
) {

391 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

392 ià(
h
 =ð
NULL
) {

393  
NGX_ERROR
;

396 
h
->
hash
 = 1;

397 
	`ngx_¡r_£t
(&
h
->
key
, "Content-Encoding");

398 
	`ngx_¡r_£t
(&
h
->
v®ue
, "gzip");

399 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
 = 
h
;

402 
Ëngth
:

404 
¡¬t
 = 
p
;

405 
p
 = 
lše
.
d©a
 +†še.
Ën
;

407 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = 
	`ngx_©oof
(
¡¬t
, 
p
 - start);

408 ià(
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 =ð
NGX_ERROR
) {

409 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

412 &
lše
, &
ùx
->
key
);

413  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

416 
u
->
h—d”s_š
.
¡©us_n
 = 200;

417 
u
->
¡©e
->
¡©us
 = 200;

418 
u
->
bufãr
.
pos
 = 
p
 + (
CRLF
) - 1;

420  
NGX_OK
;

423 ià(
	`ngx_¡rcmp
(
p
, "END\x0d") == 0) {

424 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

425 "key: \"%V\" wa nÙ found by memÿched", &
ùx
->
key
);

427 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = 0;

428 
u
->
h—d”s_š
.
¡©us_n
 = 404;

429 
u
->
¡©e
->
¡©us
 = 404;

430 
u
->
bufãr
.
pos
 = 
p
 + ("END" 
CRLF
) - 1;

431 
u
->
k“·live
 = 1;

433  
NGX_OK
;

436 
no_v®id
:

438 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

439 "memÿched s’ˆšv®id„e¥Ú£: \"%V\"", &
lše
);

441  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

442 
	}
}

445 
ngx_št_t


446 
	$ngx_h‰p_memÿched_fž‹r_š™
(*
d©a
)

448 
ngx_h‰p_memÿched_ùx_t
 *
ùx
 = 
d©a
;

450 
ngx_h‰p_up¡»am_t
 *
u
;

452 
u
 = 
ùx
->
»que¡
->
up¡»am
;

454 ià(
u
->
h—d”s_š
.
¡©us_n
 != 404) {

455 
u
->
Ëngth
 = u->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 + 
NGX_HTTP_MEMCACHED_END
;

456 
ùx
->
»¡
 = 
NGX_HTTP_MEMCACHED_END
;

459 
u
->
Ëngth
 = 0;

462  
NGX_OK
;

463 
	}
}

466 
ngx_št_t


467 
	$ngx_h‰p_memÿched_fž‹r
(*
d©a
, 
ssize_t
 
by‹s
)

469 
ngx_h‰p_memÿched_ùx_t
 *
ùx
 = 
d©a
;

471 
u_ch¬
 *
Ï¡
;

472 
ngx_buf_t
 *
b
;

473 
ngx_chaš_t
 *
þ
, **
Î
;

474 
ngx_h‰p_up¡»am_t
 *
u
;

476 
u
 = 
ùx
->
»que¡
->
up¡»am
;

477 
b
 = &
u
->
bufãr
;

479 ià(
u
->
Ëngth
 =ð(
ssize_t
è
ùx
->
»¡
) {

481 ià(
	`ngx_¡ºcmp
(
b
->
Ï¡
,

482 
ngx_h‰p_memÿched_’d
 + 
NGX_HTTP_MEMCACHED_END
 - 
ùx
->
»¡
,

483 
by‹s
)

486 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

489 
u
->
Ëngth
 = 0;

490 
ùx
->
»¡
 = 0;

492  
NGX_OK
;

495 
u
->
Ëngth
 -ð
by‹s
;

496 
ùx
->
»¡
 -ð
by‹s
;

498 ià(
u
->
Ëngth
 == 0) {

499 
u
->
k“·live
 = 1;

502  
NGX_OK
;

505 
þ
 = 
u
->
out_bufs
, 
Î
 = &u->out_bufs; cl; cÈðþ->
Ãxt
) {

506 
Î
 = &
þ
->
Ãxt
;

509 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
ùx
->
»que¡
->
poÞ
, &
u
->
ä“_bufs
);

510 ià(
þ
 =ð
NULL
) {

511  
NGX_ERROR
;

514 
þ
->
buf
->
æush
 = 1;

515 
þ
->
buf
->
memÜy
 = 1;

517 *
Î
 = 
þ
;

519 
Ï¡
 = 
b
->last;

520 
þ
->
buf
->
pos
 = 
Ï¡
;

521 
b
->
Ï¡
 +ð
by‹s
;

522 
þ
->
buf
->
Ï¡
 = 
b
->last;

523 
þ
->
buf
->
g
 = 
u
->
ouut
.tag;

525 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

527 
by‹s
, 
b
->
Ï¡
 - b->
pos
, 
u
->
Ëngth
, 
ùx
->
»¡
);

529 ià(
by‹s
 <ð(
ssize_t
è(
u
->
Ëngth
 - 
NGX_HTTP_MEMCACHED_END
)) {

530 
u
->
Ëngth
 -ð
by‹s
;

531  
NGX_OK
;

534 
Ï¡
 +ð(
size_t
è(
u
->
Ëngth
 - 
NGX_HTTP_MEMCACHED_END
);

536 ià(
	`ngx_¡ºcmp
(
Ï¡
, 
ngx_h‰p_memÿched_’d
, 
b
->last -†ast) != 0) {

537 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

540 
b
->
Ï¡
 =†ast;

541 
þ
->
buf
->
Ï¡
 =†ast;

542 
u
->
Ëngth
 = 0;

543 
ùx
->
»¡
 = 0;

545  
NGX_OK
;

548 
ùx
->
»¡
 -ð
b
->
Ï¡
 -†ast;

549 
b
->
Ï¡
 =†ast;

550 
þ
->
buf
->
Ï¡
 =†ast;

551 
u
->
Ëngth
 = 
ùx
->
»¡
;

553 ià(
u
->
Ëngth
 == 0) {

554 
u
->
k“·live
 = 1;

557  
NGX_OK
;

558 
	}
}

562 
	$ngx_h‰p_memÿched_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

564 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

567 
	}
}

571 
	$ngx_h‰p_memÿched_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

573 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

576 
	}
}

580 
	$ngx_h‰p_memÿched_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

582 
ngx_h‰p_memÿched_loc_cÚf_t
 *
cÚf
;

584 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_memÿched_loc_cÚf_t
));

585 ià(
cÚf
 =ð
NULL
) {

586  
NULL
;

599 
cÚf
->
up¡»am
.
loÿl
 = 
NGX_CONF_UNSET_PTR
;

600 
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
 = 
NGX_CONF_UNSET_UINT
;

601 
cÚf
->
up¡»am
.
cÚÃù_timeout
 = 
NGX_CONF_UNSET_MSEC
;

602 
cÚf
->
up¡»am
.
£nd_timeout
 = 
NGX_CONF_UNSET_MSEC
;

603 
cÚf
->
up¡»am
.
»ad_timeout
 = 
NGX_CONF_UNSET_MSEC
;

604 
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
 = 
NGX_CONF_UNSET_MSEC
;

606 
cÚf
->
up¡»am
.
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

609 
cÚf
->
up¡»am
.
cyþic_‹mp_fže
 = 0;

610 
cÚf
->
up¡»am
.
bufãršg
 = 0;

611 
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
 = 0;

612 
cÚf
->
up¡»am
.
£nd_low©
 = 0;

613 
cÚf
->
up¡»am
.
bufs
.
num
 = 0;

614 
cÚf
->
up¡»am
.
busy_bufãrs_size
 = 0;

615 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 = 0;

616 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 = 0;

617 
cÚf
->
up¡»am
.
š‹rû±_”rÜs
 = 1;

618 
cÚf
->
up¡»am
.
š‹rû±_404
 = 1;

619 
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
 = 0;

620 
cÚf
->
up¡»am
.
·ss_»que¡_body
 = 0;

622 
cÚf
->
šdex
 = 
NGX_CONF_UNSET
;

623 
cÚf
->
gz_æag
 = 
NGX_CONF_UNSET_UINT
;

625  
cÚf
;

626 
	}
}

630 
	$ngx_h‰p_memÿched_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

632 
ngx_h‰p_memÿched_loc_cÚf_t
 *
´ev
 = 
·»Á
;

633 
ngx_h‰p_memÿched_loc_cÚf_t
 *
cÚf
 = 
chžd
;

635 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
loÿl
,

636 
´ev
->
up¡»am
.
loÿl
, 
NULL
);

638 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
,

639 
´ev
->
up¡»am
.
Ãxt_up¡»am_Œ›s
, 0);

641 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
cÚÃù_timeout
,

642 
´ev
->
up¡»am
.
cÚÃù_timeout
, 60000);

644 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
£nd_timeout
,

645 
´ev
->
up¡»am
.
£nd_timeout
, 60000);

647 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
»ad_timeout
,

648 
´ev
->
up¡»am
.
»ad_timeout
, 60000);

650 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
,

651 
´ev
->
up¡»am
.
Ãxt_up¡»am_timeout
, 0);

653 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
bufãr_size
,

654 
´ev
->
up¡»am
.
bufãr_size
,

655 (
size_t
è
ngx_·gesize
);

657 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am
,

658 
´ev
->
up¡»am
.
Ãxt_up¡»am
,

659 (
NGX_CONF_BITMASK_SET


660 |
NGX_HTTP_UPSTREAM_FT_ERROR


661 |
NGX_HTTP_UPSTREAM_FT_TIMEOUT
));

663 ià(
cÚf
->
up¡»am
.
Ãxt_up¡»am
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

664 
cÚf
->
up¡»am
.
Ãxt_up¡»am
 = 
NGX_CONF_BITMASK_SET


665 |
NGX_HTTP_UPSTREAM_FT_OFF
;

668 ià(
cÚf
->
up¡»am
.up¡»am =ð
NULL
) {

669 
cÚf
->
up¡»am
.up¡»am = 
´ev
->upstream.upstream;

672 ià(
cÚf
->
šdex
 =ð
NGX_CONF_UNSET
) {

673 
cÚf
->
šdex
 = 
´ev
->index;

676 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
gz_æag
, 
´ev
->gzip_flag, 0);

678  
NGX_CONF_OK
;

679 
	}
}

683 
	$ngx_h‰p_memÿched_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

685 
ngx_h‰p_memÿched_loc_cÚf_t
 *
mlcf
 = 
cÚf
;

687 
ngx_¡r_t
 *
v®ue
;

688 
ngx_u¾_t
 
u
;

689 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

691 ià(
mlcf
->
up¡»am
.upstream) {

695 
v®ue
 = 
cf
->
¬gs
->
–ts
;

697 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

699 
u
.
u¾
 = 
v®ue
[1];

700 
u
.
no_»sÞve
 = 1;

702 
mlcf
->
up¡»am
.up¡»am = 
	`ngx_h‰p_up¡»am_add
(
cf
, &
u
, 0);

703 ià(
mlcf
->
up¡»am
.up¡»am =ð
NULL
) {

704  
NGX_CONF_ERROR
;

707 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

709 
þcf
->
hªdËr
 = 
ngx_h‰p_memÿched_hªdËr
;

711 ià(
þcf
->
Çme
.
d©a
[þcf->Çme.
Ën
 - 1] == '/') {

712 
þcf
->
auto_»dœeù
 = 1;

715 
mlcf
->
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, &
ngx_h‰p_memÿched_key
);

717 ià(
mlcf
->
šdex
 =ð
NGX_ERROR
) {

718  
NGX_CONF_ERROR
;

721  
NGX_CONF_OK
;

722 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_mp4_module.c

7 
	~<ngx_cÚfig.h
>

8 
	~<ngx_cÜe.h
>

9 
	~<ngx_h‰p.h
>

12 
	#NGX_HTTP_MP4_TRAK_ATOM
 0

	)

13 
	#NGX_HTTP_MP4_TKHD_ATOM
 1

	)

14 
	#NGX_HTTP_MP4_MDIA_ATOM
 2

	)

15 
	#NGX_HTTP_MP4_MDHD_ATOM
 3

	)

16 
	#NGX_HTTP_MP4_HDLR_ATOM
 4

	)

17 
	#NGX_HTTP_MP4_MINF_ATOM
 5

	)

18 
	#NGX_HTTP_MP4_VMHD_ATOM
 6

	)

19 
	#NGX_HTTP_MP4_SMHD_ATOM
 7

	)

20 
	#NGX_HTTP_MP4_DINF_ATOM
 8

	)

21 
	#NGX_HTTP_MP4_STBL_ATOM
 9

	)

22 
	#NGX_HTTP_MP4_STSD_ATOM
 10

	)

23 
	#NGX_HTTP_MP4_STTS_ATOM
 11

	)

24 
	#NGX_HTTP_MP4_STTS_DATA
 12

	)

25 
	#NGX_HTTP_MP4_STSS_ATOM
 13

	)

26 
	#NGX_HTTP_MP4_STSS_DATA
 14

	)

27 
	#NGX_HTTP_MP4_CTTS_ATOM
 15

	)

28 
	#NGX_HTTP_MP4_CTTS_DATA
 16

	)

29 
	#NGX_HTTP_MP4_STSC_ATOM
 17

	)

30 
	#NGX_HTTP_MP4_STSC_START
 18

	)

31 
	#NGX_HTTP_MP4_STSC_DATA
 19

	)

32 
	#NGX_HTTP_MP4_STSC_END
 20

	)

33 
	#NGX_HTTP_MP4_STSZ_ATOM
 21

	)

34 
	#NGX_HTTP_MP4_STSZ_DATA
 22

	)

35 
	#NGX_HTTP_MP4_STCO_ATOM
 23

	)

36 
	#NGX_HTTP_MP4_STCO_DATA
 24

	)

37 
	#NGX_HTTP_MP4_CO64_ATOM
 25

	)

38 
	#NGX_HTTP_MP4_CO64_DATA
 26

	)

40 
	#NGX_HTTP_MP4_LAST_ATOM
 
NGX_HTTP_MP4_CO64_DATA


	)

44 
size_t
 
	mbufãr_size
;

45 
size_t
 
	mmax_bufãr_size
;

46 } 
	tngx_h‰p_mp4_cÚf_t
;

50 
u_ch¬
 
	mchunk
[4];

51 
u_ch¬
 
	m§m¶es
[4];

52 
u_ch¬
 
	mid
[4];

53 } 
	tngx_mp4_¡sc_’Œy_t
;

57 
ušt32_t
 
	mtimesÿË
;

58 
ušt32_t
 
	mtime_to_§m¶e_’Œ›s
;

59 
ušt32_t
 
	m§m¶e_to_chunk_’Œ›s
;

60 
ušt32_t
 
	msync_§m¶es_’Œ›s
;

61 
ušt32_t
 
	mcompos™iÚ_off£t_’Œ›s
;

62 
ušt32_t
 
	m§m¶e_sizes_’Œ›s
;

63 
ušt32_t
 
	mchunks
;

65 
ngx_ušt_t
 
	m¡¬t_§m¶e
;

66 
ngx_ušt_t
 
	m’d_§m¶e
;

67 
ngx_ušt_t
 
	m¡¬t_chunk
;

68 
ngx_ušt_t
 
	m’d_chunk
;

69 
ngx_ušt_t
 
	m¡¬t_chunk_§m¶es
;

70 
ngx_ušt_t
 
	m’d_chunk_§m¶es
;

71 
ušt64_t
 
	m¡¬t_chunk_§m¶es_size
;

72 
ušt64_t
 
	m’d_chunk_§m¶es_size
;

73 
off_t
 
	m¡¬t_off£t
;

74 
off_t
 
	m’d_off£t
;

76 
size_t
 
	mtkhd_size
;

77 
size_t
 
	mmdhd_size
;

78 
size_t
 
	mhdÌ_size
;

79 
size_t
 
	mvmhd_size
;

80 
size_t
 
	msmhd_size
;

81 
size_t
 
	mdšf_size
;

82 
size_t
 
	msize
;

84 
ngx_chaš_t
 
	mout
[
NGX_HTTP_MP4_LAST_ATOM
 + 1];

86 
ngx_buf_t
 
	mŒak_©om_buf
;

87 
ngx_buf_t
 
	mtkhd_©om_buf
;

88 
ngx_buf_t
 
	mmdŸ_©om_buf
;

89 
ngx_buf_t
 
	mmdhd_©om_buf
;

90 
ngx_buf_t
 
	mhdÌ_©om_buf
;

91 
ngx_buf_t
 
	mmšf_©om_buf
;

92 
ngx_buf_t
 
	mvmhd_©om_buf
;

93 
ngx_buf_t
 
	msmhd_©om_buf
;

94 
ngx_buf_t
 
	mdšf_©om_buf
;

95 
ngx_buf_t
 
	m¡bl_©om_buf
;

96 
ngx_buf_t
 
	m¡sd_©om_buf
;

97 
ngx_buf_t
 
	m¡ts_©om_buf
;

98 
ngx_buf_t
 
	m¡ts_d©a_buf
;

99 
ngx_buf_t
 
	m¡ss_©om_buf
;

100 
ngx_buf_t
 
	m¡ss_d©a_buf
;

101 
ngx_buf_t
 
	mùts_©om_buf
;

102 
ngx_buf_t
 
	mùts_d©a_buf
;

103 
ngx_buf_t
 
	m¡sc_©om_buf
;

104 
ngx_buf_t
 
	m¡sc_¡¬t_chunk_buf
;

105 
ngx_buf_t
 
	m¡sc_’d_chunk_buf
;

106 
ngx_buf_t
 
	m¡sc_d©a_buf
;

107 
ngx_buf_t
 
	m¡sz_©om_buf
;

108 
ngx_buf_t
 
	m¡sz_d©a_buf
;

109 
ngx_buf_t
 
	m¡co_©om_buf
;

110 
ngx_buf_t
 
	m¡co_d©a_buf
;

111 
ngx_buf_t
 
	mco64_©om_buf
;

112 
ngx_buf_t
 
	mco64_d©a_buf
;

114 
ngx_mp4_¡sc_’Œy_t
 
	m¡sc_¡¬t_chunk_’Œy
;

115 
ngx_mp4_¡sc_’Œy_t
 
	m¡sc_’d_chunk_’Œy
;

116 } 
	tngx_h‰p_mp4_Œak_t
;

120 
ngx_fže_t
 
	mfže
;

122 
u_ch¬
 *
	mbufãr
;

123 
u_ch¬
 *
	mbufãr_¡¬t
;

124 
u_ch¬
 *
	mbufãr_pos
;

125 
u_ch¬
 *
	mbufãr_’d
;

126 
size_t
 
	mbufãr_size
;

128 
off_t
 
	moff£t
;

129 
off_t
 
	m’d
;

130 
off_t
 
	mcÚ‹Á_Ëngth
;

131 
ngx_ušt_t
 
	m¡¬t
;

132 
ngx_ušt_t
 
	mËngth
;

133 
ušt32_t
 
	mtimesÿË
;

134 
ngx_h‰p_»que¡_t
 *
	m»que¡
;

135 
ngx_¬¿y_t
 
	mŒak
;

136 
ngx_h‰p_mp4_Œak_t
 
	mŒaks
[2];

138 
size_t
 
	máyp_size
;

139 
size_t
 
	mmoov_size
;

141 
ngx_chaš_t
 *
	mout
;

142 
ngx_chaš_t
 
	máyp_©om
;

143 
ngx_chaš_t
 
	mmoov_©om
;

144 
ngx_chaš_t
 
	mmvhd_©om
;

145 
ngx_chaš_t
 
	mmd©_©om
;

146 
ngx_chaš_t
 
	mmd©_d©a
;

148 
ngx_buf_t
 
	máyp_©om_buf
;

149 
ngx_buf_t
 
	mmoov_©om_buf
;

150 
ngx_buf_t
 
	mmvhd_©om_buf
;

151 
ngx_buf_t
 
	mmd©_©om_buf
;

152 
ngx_buf_t
 
	mmd©_d©a_buf
;

154 
u_ch¬
 
	mmoov_©om_h—d”
[8];

155 
u_ch¬
 
	mmd©_©om_h—d”
[16];

156 } 
	tngx_h‰p_mp4_fže_t
;

160 *
	mÇme
;

161 
ngx_št_t
 (*
hªdËr
)(
ngx_h‰p_mp4_fže_t
 *
	mmp4
,

162 
ušt64_t
 
	m©om_d©a_size
);

163 } 
	tngx_h‰p_mp4_©om_hªdËr_t
;

166 
	#ngx_mp4_©om_h—d”
(
mp4
è(mp4->
bufãr_pos
 - 8)

	)

167 
	#ngx_mp4_©om_d©a
(
mp4
èmp4->
bufãr_pos


	)

168 
	#ngx_mp4_©om_d©a_size
(
t
è(
ušt64_t
è(Ñè- 8)

	)

171 
	#ngx_mp4_©om_Ãxt
(
mp4
, 
n
) \

172 
mp4
->
bufãr_pos
 +ð(
size_t
è
n
; \

173 
mp4
->
off£t
 +ð
n


	)

176 
	#ngx_mp4_£t_©om_Çme
(
p
, 
n1
, 
n2
, 
n3
, 
n4
) \

177 ((
u_ch¬
 *è(
p
))[4] = 
n1
; \

178 ((
u_ch¬
 *è(
p
))[5] = 
n2
; \

179 ((
u_ch¬
 *è(
p
))[6] = 
n3
; \

180 ((
u_ch¬
 *è(
p
))[7] = 
n4


	)

182 
	#ngx_mp4_g‘_32v®ue
(
p
) \

183 Ð((
ušt32_t
è((
u_ch¬
 *è(
p
))[0] << 24) \

184 + ( ((
u_ch¬
 *è(
p
))[1] << 16) \

185 + ( ((
u_ch¬
 *è(
p
))[2] << 8) \

186 + ( ((
u_ch¬
 *è(
p
))[3]è)

	)

188 
	#ngx_mp4_£t_32v®ue
(
p
, 
n
) \

189 ((
u_ch¬
 *è(
p
))[0] = (u_ch¬è((
n
) >> 24); \

190 ((
u_ch¬
 *è(
p
))[1] = (u_ch¬è((
n
) >> 16); \

191 ((
u_ch¬
 *è(
p
))[2] = (u_ch¬è((
n
) >> 8); \

192 ((
u_ch¬
 *è(
p
))[3] = (u_ch¬è(
n
)

	)

194 
	#ngx_mp4_g‘_64v®ue
(
p
) \

195 Ð((
ušt64_t
è((
u_ch¬
 *è(
p
))[0] << 56) \

196 + ((
ušt64_t
è((
u_ch¬
 *è(
p
))[1] << 48) \

197 + ((
ušt64_t
è((
u_ch¬
 *è(
p
))[2] << 40) \

198 + ((
ušt64_t
è((
u_ch¬
 *è(
p
))[3] << 32) \

199 + ((
ušt64_t
è((
u_ch¬
 *è(
p
))[4] << 24) \

200 + ( ((
u_ch¬
 *è(
p
))[5] << 16) \

201 + ( ((
u_ch¬
 *è(
p
))[6] << 8) \

202 + ( ((
u_ch¬
 *è(
p
))[7]è)

	)

204 
	#ngx_mp4_£t_64v®ue
(
p
, 
n
) \

205 ((
u_ch¬
 *è(
p
))[0] = (u_ch¬è((
ušt64_t
è(
n
) >> 56); \

206 ((
u_ch¬
 *è(
p
))[1] = (u_ch¬è((
ušt64_t
è(
n
) >> 48); \

207 ((
u_ch¬
 *è(
p
))[2] = (u_ch¬è((
ušt64_t
è(
n
) >> 40); \

208 ((
u_ch¬
 *è(
p
))[3] = (u_ch¬è((
ušt64_t
è(
n
) >> 32); \

209 ((
u_ch¬
 *è(
p
))[4] = (u_ch¬èÐ(
n
) >> 24); \

210 ((
u_ch¬
 *è(
p
))[5] = (u_ch¬èÐ(
n
) >> 16); \

211 ((
u_ch¬
 *è(
p
))[6] = (u_ch¬èÐ(
n
) >> 8); \

212 ((
u_ch¬
 *è(
p
))[7] = (u_ch¬è(
n
)

	)

214 
	#ngx_mp4_Ï¡_Œak
(
mp4
) \

215 &((
ngx_h‰p_mp4_Œak_t
 *è
mp4
->
Œak
.
–ts
)[mp4->Œak.
ÃÉs
 - 1]

	)

218 
ngx_št_t
 
ngx_h‰p_mp4_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

220 
ngx_št_t
 
ngx_h‰p_mp4_´oûss
(
ngx_h‰p_mp4_fže_t
 *
mp4
);

221 
ngx_št_t
 
ngx_h‰p_mp4_»ad_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

222 
ngx_h‰p_mp4_©om_hªdËr_t
 *
©om
, 
ušt64_t
 
©om_d©a_size
);

223 
ngx_št_t
 
ngx_h‰p_mp4_»ad
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
size_t
 
size
);

224 
ngx_št_t
 
ngx_h‰p_mp4_»ad_áyp_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

225 
ušt64_t
 
©om_d©a_size
);

226 
ngx_št_t
 
ngx_h‰p_mp4_»ad_moov_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

227 
ušt64_t
 
©om_d©a_size
);

228 
ngx_št_t
 
ngx_h‰p_mp4_»ad_md©_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

229 
ušt64_t
 
©om_d©a_size
);

230 
size_t
 
ngx_h‰p_mp4_upd©e_md©_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

231 
off_t
 
¡¬t_off£t
, off_ˆ
’d_off£t
);

232 
ngx_št_t
 
ngx_h‰p_mp4_»ad_mvhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

233 
ušt64_t
 
©om_d©a_size
);

234 
ngx_št_t
 
ngx_h‰p_mp4_»ad_Œak_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

235 
ušt64_t
 
©om_d©a_size
);

236 
ngx_h‰p_mp4_upd©e_Œak_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

237 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

238 
ngx_št_t
 
ngx_h‰p_mp4_»ad_cmov_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

239 
ušt64_t
 
©om_d©a_size
);

240 
ngx_št_t
 
ngx_h‰p_mp4_»ad_tkhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

241 
ušt64_t
 
©om_d©a_size
);

242 
ngx_št_t
 
ngx_h‰p_mp4_»ad_mdŸ_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

243 
ušt64_t
 
©om_d©a_size
);

244 
ngx_h‰p_mp4_upd©e_mdŸ_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

245 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

246 
ngx_št_t
 
ngx_h‰p_mp4_»ad_mdhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

247 
ušt64_t
 
©om_d©a_size
);

248 
ngx_št_t
 
ngx_h‰p_mp4_»ad_hdÌ_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

249 
ušt64_t
 
©om_d©a_size
);

250 
ngx_št_t
 
ngx_h‰p_mp4_»ad_mšf_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

251 
ušt64_t
 
©om_d©a_size
);

252 
ngx_h‰p_mp4_upd©e_mšf_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

253 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

254 
ngx_št_t
 
ngx_h‰p_mp4_»ad_dšf_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

255 
ušt64_t
 
©om_d©a_size
);

256 
ngx_št_t
 
ngx_h‰p_mp4_»ad_vmhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

257 
ušt64_t
 
©om_d©a_size
);

258 
ngx_št_t
 
ngx_h‰p_mp4_»ad_smhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

259 
ušt64_t
 
©om_d©a_size
);

260 
ngx_št_t
 
ngx_h‰p_mp4_»ad_¡bl_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

261 
ušt64_t
 
©om_d©a_size
);

262 
ngx_h‰p_mp4_upd©e_¡bl_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

263 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

264 
ngx_št_t
 
ngx_h‰p_mp4_»ad_¡sd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

265 
ušt64_t
 
©om_d©a_size
);

266 
ngx_št_t
 
ngx_h‰p_mp4_»ad_¡ts_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

267 
ušt64_t
 
©om_d©a_size
);

268 
ngx_št_t
 
ngx_h‰p_mp4_upd©e_¡ts_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

269 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

270 
ngx_št_t
 
ngx_h‰p_mp4_üÝ_¡ts_d©a
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

271 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
ngx_ušt_t
 
¡¬t
);

272 
ngx_št_t
 
ngx_h‰p_mp4_»ad_¡ss_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

273 
ušt64_t
 
©om_d©a_size
);

274 
ngx_št_t
 
ngx_h‰p_mp4_upd©e_¡ss_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

275 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

276 
ngx_h‰p_mp4_üÝ_¡ss_d©a
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

277 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
ngx_ušt_t
 
¡¬t
);

278 
ngx_št_t
 
ngx_h‰p_mp4_»ad_ùts_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

279 
ušt64_t
 
©om_d©a_size
);

280 
ngx_h‰p_mp4_upd©e_ùts_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

281 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

282 
ngx_h‰p_mp4_üÝ_ùts_d©a
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

283 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
ngx_ušt_t
 
¡¬t
);

284 
ngx_št_t
 
ngx_h‰p_mp4_»ad_¡sc_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

285 
ušt64_t
 
©om_d©a_size
);

286 
ngx_št_t
 
ngx_h‰p_mp4_upd©e_¡sc_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

287 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

288 
ngx_št_t
 
ngx_h‰p_mp4_üÝ_¡sc_d©a
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

289 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
ngx_ušt_t
 
¡¬t
);

290 
ngx_št_t
 
ngx_h‰p_mp4_»ad_¡sz_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

291 
ušt64_t
 
©om_d©a_size
);

292 
ngx_št_t
 
ngx_h‰p_mp4_upd©e_¡sz_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

293 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

294 
ngx_št_t
 
ngx_h‰p_mp4_»ad_¡co_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

295 
ušt64_t
 
©om_d©a_size
);

296 
ngx_št_t
 
ngx_h‰p_mp4_upd©e_¡co_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

297 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

298 
ngx_h‰p_mp4_adju¡_¡co_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

299 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
št32_t
 
adju¡m’t
);

300 
ngx_št_t
 
ngx_h‰p_mp4_»ad_co64_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

301 
ušt64_t
 
©om_d©a_size
);

302 
ngx_št_t
 
ngx_h‰p_mp4_upd©e_co64_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

303 
ngx_h‰p_mp4_Œak_t
 *
Œak
);

304 
ngx_h‰p_mp4_adju¡_co64_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

305 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
off_t
 
adju¡m’t
);

307 *
ngx_h‰p_mp4
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

308 *
ngx_h‰p_mp4_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

309 *
ngx_h‰p_mp4_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
);

312 
ngx_commªd_t
 
	gngx_h‰p_mp4_commªds
[] = {

314 { 
ngx_¡ršg
("mp4"),

315 
NGX_HTTP_LOC_CONF
|
NGX_CONF_NOARGS
,

316 
ngx_h‰p_mp4
,

319 
NULL
 },

321 { 
ngx_¡ršg
("mp4_buffer_size"),

322 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

323 
ngx_cÚf_£t_size_¦Ù
,

324 
NGX_HTTP_LOC_CONF_OFFSET
,

325 
off£tof
(
ngx_h‰p_mp4_cÚf_t
, 
bufãr_size
),

326 
NULL
 },

328 { 
ngx_¡ršg
("mp4_max_buffer_size"),

329 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

330 
ngx_cÚf_£t_size_¦Ù
,

331 
NGX_HTTP_LOC_CONF_OFFSET
,

332 
off£tof
(
ngx_h‰p_mp4_cÚf_t
, 
max_bufãr_size
),

333 
NULL
 },

335 
ngx_nuÎ_commªd


339 
ngx_h‰p_moduË_t
 
	gngx_h‰p_mp4_moduË_ùx
 = {

340 
NULL
,

341 
NULL
,

343 
NULL
,

344 
NULL
,

346 
NULL
,

347 
NULL
,

349 
ngx_h‰p_mp4_ü—‹_cÚf
,

350 
ngx_h‰p_mp4_m”ge_cÚf


354 
ngx_moduË_t
 
	gngx_h‰p_mp4_moduË
 = {

355 
NGX_MODULE_V1
,

356 &
ngx_h‰p_mp4_moduË_ùx
,

357 
ngx_h‰p_mp4_commªds
,

358 
NGX_HTTP_MODULE
,

359 
NULL
,

360 
NULL
,

361 
NULL
,

362 
NULL
,

363 
NULL
,

364 
NULL
,

365 
NULL
,

366 
NGX_MODULE_V1_PADDING


370 
ngx_h‰p_mp4_©om_hªdËr_t
 
	gngx_h‰p_mp4_©oms
[] = {

371 { "áyp", 
ngx_h‰p_mp4_»ad_áyp_©om
 },

372 { "moov", 
ngx_h‰p_mp4_»ad_moov_©om
 },

373 { "md©", 
ngx_h‰p_mp4_»ad_md©_©om
 },

374 { 
NULL
, NULL }

377 
ngx_h‰p_mp4_©om_hªdËr_t
 
	gngx_h‰p_mp4_moov_©oms
[] = {

378 { "mvhd", 
ngx_h‰p_mp4_»ad_mvhd_©om
 },

379 { "Œak", 
ngx_h‰p_mp4_»ad_Œak_©om
 },

380 { "cmov", 
ngx_h‰p_mp4_»ad_cmov_©om
 },

381 { 
NULL
, NULL }

384 
ngx_h‰p_mp4_©om_hªdËr_t
 
	gngx_h‰p_mp4_Œak_©oms
[] = {

385 { "tkhd", 
ngx_h‰p_mp4_»ad_tkhd_©om
 },

386 { "mdŸ", 
ngx_h‰p_mp4_»ad_mdŸ_©om
 },

387 { 
NULL
, NULL }

390 
ngx_h‰p_mp4_©om_hªdËr_t
 
	gngx_h‰p_mp4_mdŸ_©oms
[] = {

391 { "mdhd", 
ngx_h‰p_mp4_»ad_mdhd_©om
 },

392 { "hdÌ", 
ngx_h‰p_mp4_»ad_hdÌ_©om
 },

393 { "mšf", 
ngx_h‰p_mp4_»ad_mšf_©om
 },

394 { 
NULL
, NULL }

397 
ngx_h‰p_mp4_©om_hªdËr_t
 
	gngx_h‰p_mp4_mšf_©oms
[] = {

398 { "vmhd", 
ngx_h‰p_mp4_»ad_vmhd_©om
 },

399 { "smhd", 
ngx_h‰p_mp4_»ad_smhd_©om
 },

400 { "dšf", 
ngx_h‰p_mp4_»ad_dšf_©om
 },

401 { "¡bl", 
ngx_h‰p_mp4_»ad_¡bl_©om
 },

402 { 
NULL
, NULL }

405 
ngx_h‰p_mp4_©om_hªdËr_t
 
	gngx_h‰p_mp4_¡bl_©oms
[] = {

406 { "¡sd", 
ngx_h‰p_mp4_»ad_¡sd_©om
 },

407 { "¡ts", 
ngx_h‰p_mp4_»ad_¡ts_©om
 },

408 { "¡ss", 
ngx_h‰p_mp4_»ad_¡ss_©om
 },

409 { "ùts", 
ngx_h‰p_mp4_»ad_ùts_©om
 },

410 { "¡sc", 
ngx_h‰p_mp4_»ad_¡sc_©om
 },

411 { "¡sz", 
ngx_h‰p_mp4_»ad_¡sz_©om
 },

412 { "¡co", 
ngx_h‰p_mp4_»ad_¡co_©om
 },

413 { "co64", 
ngx_h‰p_mp4_»ad_co64_©om
 },

414 { 
NULL
, NULL }

418 
ngx_št_t


419 
	$ngx_h‰p_mp4_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

421 
u_ch¬
 *
Ï¡
;

422 
size_t
 
roÙ
;

423 
ngx_št_t
 
rc
, 
¡¬t
, 
’d
;

424 
ngx_ušt_t
 
Ëv–
, 
Ëngth
;

425 
ngx_¡r_t
 
·th
, 
v®ue
;

426 
ngx_log_t
 *
log
;

427 
ngx_buf_t
 *
b
;

428 
ngx_chaš_t
 
out
;

429 
ngx_h‰p_mp4_fže_t
 *
mp4
;

430 
ngx_Ý’_fže_šfo_t
 
of
;

431 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

433 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
))) {

434  
NGX_HTTP_NOT_ALLOWED
;

437 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] == '/') {

438  
NGX_DECLINED
;

441 
rc
 = 
	`ngx_h‰p_disÿrd_»que¡_body
(
r
);

443 ià(
rc
 !ð
NGX_OK
) {

444  
rc
;

447 
Ï¡
 = 
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0);

448 ià(
Ï¡
 =ð
NULL
) {

449  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

452 
log
 = 
r
->
cÚÃùiÚ
->log;

454 
·th
.
Ën
 = 
Ï¡
 -…©h.
d©a
;

456 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0,

457 "h‰°mp4 fž’ame: \"%V\"", &
·th
);

459 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

461 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

463 
of
.
»ad_ah—d
 = 
þcf
->read_ahead;

464 
of
.
dœeùio
 = 
NGX_MAX_OFF_T_VALUE
;

465 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

466 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

467 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

468 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

470 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
·th
, &
of
è!ð
NGX_OK
) {

471  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

474 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
·th
, &
of
, 
r
->
poÞ
)

475 !ð
NGX_OK
)

477 
of
.
”r
) {

480  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

482 
NGX_ENOENT
:

483 
NGX_ENOTDIR
:

484 
NGX_ENAMETOOLONG
:

486 
Ëv–
 = 
NGX_LOG_ERR
;

487 
rc
 = 
NGX_HTTP_NOT_FOUND
;

490 
NGX_EACCES
:

491 #ià(
NGX_HAVE_OPENAT
)

492 
NGX_EMLINK
:

493 
NGX_ELOOP
:

496 
Ëv–
 = 
NGX_LOG_ERR
;

497 
rc
 = 
NGX_HTTP_FORBIDDEN
;

502 
Ëv–
 = 
NGX_LOG_CRIT
;

503 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

507 ià(
rc
 !ð
NGX_HTTP_NOT_FOUND
 || 
þcf
->
log_nÙ_found
) {

508 
	`ngx_log_”rÜ
(
Ëv–
, 
log
, 
of
.
”r
,

509 "% \"%s\" fažed", 
of
.
çžed
, 
·th
.
d©a
);

512  
rc
;

515 ià(!
of
.
is_fže
) {

517 ià(
	`ngx_þo£_fže
(
of
.
fd
è=ð
NGX_FILE_ERROR
) {

518 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

519 
ngx_þo£_fže_n
 " \"%s\" fažed", 
·th
.
d©a
);

522  
NGX_DECLINED
;

525 
r
->
roÙ_‹¡ed
 = !r->
”rÜ_·ge
;

526 
r
->
®low_¿nges
 = 1;

528 
¡¬t
 = -1;

529 
Ëngth
 = 0;

530 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
of
.
size
;

531 
mp4
 = 
NULL
;

532 
b
 = 
NULL
;

534 ià(
r
->
¬gs
.
Ën
) {

536 ià(
	`ngx_h‰p_¬g
(
r
, (
u_ch¬
 *è"¡¬t", 5, &
v®ue
è=ð
NGX_OK
) {

544 
	`ngx_£t_”ºo
(0);

545 
¡¬t
 = (è(
	`¡¹od
((*è
v®ue
.
d©a
, 
NULL
) * 1000);

547 ià(
ngx_”ºo
 != 0) {

548 
¡¬t
 = -1;

552 ià(
	`ngx_h‰p_¬g
(
r
, (
u_ch¬
 *è"’d", 3, &
v®ue
è=ð
NGX_OK
) {

554 
	`ngx_£t_”ºo
(0);

555 
’d
 = (è(
	`¡¹od
((*è
v®ue
.
d©a
, 
NULL
) * 1000);

557 ià(
ngx_”ºo
 != 0) {

558 
’d
 = -1;

561 ià(
’d
 > 0) {

562 ià(
¡¬t
 < 0) {

563 
¡¬t
 = 0;

566 ià(
’d
 > 
¡¬t
) {

567 
Ëngth
 = 
’d
 - 
¡¬t
;

573 ià(
¡¬t
 >= 0) {

574 
r
->
sšgË_¿nge
 = 1;

576 
mp4
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_mp4_fže_t
));

577 ià(
mp4
 =ð
NULL
) {

578  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

581 
mp4
->
fže
.
fd
 = 
of
.fd;

582 
mp4
->
fže
.
Çme
 = 
·th
;

583 
mp4
->
fže
.
log
 = 
r
->
cÚÃùiÚ
->log;

584 
mp4
->
’d
 = 
of
.
size
;

585 
mp4
->
¡¬t
 = (
ngx_ušt_t
) start;

586 
mp4
->
Ëngth
 =†ength;

587 
mp4
->
»que¡
 = 
r
;

589 
	`ngx_h‰p_mp4_´oûss
(
mp4
)) {

591 
NGX_DECLINED
:

592 ià(
mp4
->
bufãr
) {

593 
	`ngx_pä“
(
r
->
poÞ
, 
mp4
->
bufãr
);

596 
	`ngx_pä“
(
r
->
poÞ
, 
mp4
);

597 
mp4
 = 
NULL
;

601 
NGX_OK
:

602 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
mp4
->
cÚ‹Á_Ëngth
;

606 ià(
mp4
->
bufãr
) {

607 
	`ngx_pä“
(
r
->
poÞ
, 
mp4
->
bufãr
);

610 
	`ngx_pä“
(
r
->
poÞ
, 
mp4
);

612  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

616 
log
->
aùiÚ
 = "sending mp4o client";

618 ià(
þcf
->
dœeùio
 <ð
of
.
size
) {

625 ià(
	`ngx_dœeùio_Ú
(
of
.
fd
è=ð
NGX_FILE_ERROR
) {

626 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

627 
ngx_dœeùio_Ú_n
 " \"%s\" fažed", 
·th
.
d©a
);

630 
of
.
is_dœeùio
 = 1;

632 ià(
mp4
) {

633 
mp4
->
fže
.
dœeùio
 = 1;

637 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_OK
;

638 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = 
of
.
mtime
;

640 ià(
	`ngx_h‰p_£t_‘ag
(
r
è!ð
NGX_OK
) {

641  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

644 ià(
	`ngx_h‰p_£t_cÚ‹Á_ty³
(
r
è!ð
NGX_OK
) {

645  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

648 ià(
mp4
 =ð
NULL
) {

649 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

650 ià(
b
 =ð
NULL
) {

651  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

654 
b
->
fže
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_fže_t
));

655 ià(
b
->
fže
 =ð
NULL
) {

656  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

660 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

662 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

663  
rc
;

666 ià(
mp4
) {

667  
	`ngx_h‰p_ouut_fž‹r
(
r
, 
mp4
->
out
);

670 
b
->
fže_pos
 = 0;

671 
b
->
fže_Ï¡
 = 
of
.
size
;

673 
b
->
š_fže
 = b->
fže_Ï¡
 ? 1 : 0;

674 
b
->
Ï¡_buf
 = (
r
 =ðr->
maš
) ? 1 : 0;

675 
b
->
Ï¡_š_chaš
 = 1;

677 
b
->
fže
->
fd
 = 
of
.fd;

678 
b
->
fže
->
Çme
 = 
·th
;

679 
b
->
fže
->
log
 =†og;

680 
b
->
fže
->
dœeùio
 = 
of
.
is_dœeùio
;

682 
out
.
buf
 = 
b
;

683 
out
.
Ãxt
 = 
NULL
;

685  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

686 
	}
}

689 
ngx_št_t


690 
	$ngx_h‰p_mp4_´oûss
(
ngx_h‰p_mp4_fže_t
 *
mp4
)

692 
off_t
 
¡¬t_off£t
, 
’d_off£t
, 
adju¡m’t
;

693 
ngx_št_t
 
rc
;

694 
ngx_ušt_t
 
i
, 
j
;

695 
ngx_chaš_t
 **
´ev
;

696 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

697 
ngx_h‰p_mp4_cÚf_t
 *
cÚf
;

699 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

700 "mp4 s¹:%ui,†’gth:%ui", 
mp4
->
¡¬t
, mp4->
Ëngth
);

702 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
mp4
->
»que¡
, 
ngx_h‰p_mp4_moduË
);

704 
mp4
->
bufãr_size
 = 
cÚf
->buffer_size;

706 
rc
 = 
	`ngx_h‰p_mp4_»ad_©om
(
mp4
, 
ngx_h‰p_mp4_©oms
, mp4->
’d
);

707 ià(
rc
 !ð
NGX_OK
) {

708  
rc
;

711 ià(
mp4
->
Œak
.
ÃÉs
 == 0) {

712 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

714 
mp4
->
fže
.
Çme
.
d©a
);

715  
NGX_ERROR
;

718 ià(
mp4
->
md©_©om
.
buf
 =ð
NULL
) {

719 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

721 
mp4
->
fže
.
Çme
.
d©a
);

722  
NGX_ERROR
;

725 
´ev
 = &
mp4
->
out
;

727 ià(
mp4
->
áyp_©om
.
buf
) {

728 *
´ev
 = &
mp4
->
áyp_©om
;

729 
´ev
 = &
mp4
->
áyp_©om
.
Ãxt
;

732 *
´ev
 = &
mp4
->
moov_©om
;

733 
´ev
 = &
mp4
->
moov_©om
.
Ãxt
;

735 ià(
mp4
->
mvhd_©om
.
buf
) {

736 
mp4
->
moov_size
 +ðmp4->
mvhd_©om_buf
.
Ï¡
 - mp4->mvhd_©om_buf.
pos
;

737 *
´ev
 = &
mp4
->
mvhd_©om
;

738 
´ev
 = &
mp4
->
mvhd_©om
.
Ãxt
;

741 
¡¬t_off£t
 = 
mp4
->
’d
;

742 
’d_off£t
 = 0;

743 
Œak
 = 
mp4
->Œak.
–ts
;

745 
i
 = 0; i < 
mp4
->
Œak
.
ÃÉs
; i++) {

747 ià(
	`ngx_h‰p_mp4_upd©e_¡ts_©om
(
mp4
, &
Œak
[
i
]è!ð
NGX_OK
) {

748  
NGX_ERROR
;

751 ià(
	`ngx_h‰p_mp4_upd©e_¡ss_©om
(
mp4
, &
Œak
[
i
]è!ð
NGX_OK
) {

752  
NGX_ERROR
;

755 
	`ngx_h‰p_mp4_upd©e_ùts_©om
(
mp4
, &
Œak
[
i
]);

757 ià(
	`ngx_h‰p_mp4_upd©e_¡sc_©om
(
mp4
, &
Œak
[
i
]è!ð
NGX_OK
) {

758  
NGX_ERROR
;

761 ià(
	`ngx_h‰p_mp4_upd©e_¡sz_©om
(
mp4
, &
Œak
[
i
]è!ð
NGX_OK
) {

762  
NGX_ERROR
;

765 ià(
Œak
[
i
].
out
[
NGX_HTTP_MP4_CO64_DATA
].
buf
) {

766 ià(
	`ngx_h‰p_mp4_upd©e_co64_©om
(
mp4
, &
Œak
[
i
]è!ð
NGX_OK
) {

767  
NGX_ERROR
;

771 ià(
	`ngx_h‰p_mp4_upd©e_¡co_©om
(
mp4
, &
Œak
[
i
]è!ð
NGX_OK
) {

772  
NGX_ERROR
;

776 
	`ngx_h‰p_mp4_upd©e_¡bl_©om
(
mp4
, &
Œak
[
i
]);

777 
	`ngx_h‰p_mp4_upd©e_mšf_©om
(
mp4
, &
Œak
[
i
]);

778 
Œak
[
i
].
size
 +ðŒak[i].
mdhd_size
;

779 
Œak
[
i
].
size
 +ðŒak[i].
hdÌ_size
;

780 
	`ngx_h‰p_mp4_upd©e_mdŸ_©om
(
mp4
, &
Œak
[
i
]);

781 
Œak
[
i
].
size
 +ðŒak[i].
tkhd_size
;

782 
	`ngx_h‰p_mp4_upd©e_Œak_©om
(
mp4
, &
Œak
[
i
]);

784 
mp4
->
moov_size
 +ð
Œak
[
i
].
size
;

786 ià(
¡¬t_off£t
 > 
Œak
[
i
].start_offset) {

787 
¡¬t_off£t
 = 
Œak
[
i
].start_offset;

790 ià(
’d_off£t
 < 
Œak
[
i
].end_offset) {

791 
’d_off£t
 = 
Œak
[
i
].end_offset;

794 *
´ev
 = &
Œak
[
i
].
out
[
NGX_HTTP_MP4_TRAK_ATOM
];

795 
´ev
 = &
Œak
[
i
].
out
[
NGX_HTTP_MP4_TRAK_ATOM
].
Ãxt
;

797 
j
 = 0; j < 
NGX_HTTP_MP4_LAST_ATOM
 + 1; j++) {

798 ià(
Œak
[
i
].
out
[
j
].
buf
) {

799 *
´ev
 = &
Œak
[
i
].
out
[
j
];

800 
´ev
 = &
Œak
[
i
].
out
[
j
].
Ãxt
;

805 ià(
’d_off£t
 < 
¡¬t_off£t
) {

806 
’d_off£t
 = 
¡¬t_off£t
;

809 
mp4
->
moov_size
 += 8;

811 
	`ngx_mp4_£t_32v®ue
(
mp4
->
moov_©om_h—d”
, mp4->
moov_size
);

812 
	`ngx_mp4_£t_©om_Çme
(
mp4
->
moov_©om_h—d”
, 'm', 'o', 'o', 'v');

813 
mp4
->
cÚ‹Á_Ëngth
 +ðmp4->
moov_size
;

815 *
´ev
 = &
mp4
->
md©_©om
;

817 ià(
¡¬t_off£t
 > 
mp4
->
md©_d©a
.
buf
->
fže_Ï¡
) {

818 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

820 
mp4
->
fže
.
Çme
.
d©a
);

821  
NGX_ERROR
;

824 
adju¡m’t
 = 
mp4
->
áyp_size
 + mp4->
moov_size


825 + 
	`ngx_h‰p_mp4_upd©e_md©_©om
(
mp4
, 
¡¬t_off£t
, 
’d_off£t
)

826 - 
¡¬t_off£t
;

828 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

829 "mp4‡dju¡m’t:%O", 
adju¡m’t
);

831 
i
 = 0; i < 
mp4
->
Œak
.
ÃÉs
; i++) {

832 ià(
Œak
[
i
].
out
[
NGX_HTTP_MP4_CO64_DATA
].
buf
) {

833 
	`ngx_h‰p_mp4_adju¡_co64_©om
(
mp4
, &
Œak
[
i
], 
adju¡m’t
);

835 
	`ngx_h‰p_mp4_adju¡_¡co_©om
(
mp4
, &
Œak
[
i
], (
št32_t
è
adju¡m’t
);

839  
NGX_OK
;

840 
	}
}

844 
u_ch¬
 
	msize
[4];

845 
u_ch¬
 
	mÇme
[4];

846 } 
	tngx_mp4_©om_h—d”_t
;

849 
u_ch¬
 
	msize
[4];

850 
u_ch¬
 
	mÇme
[4];

851 
u_ch¬
 
	msize64
[8];

852 } 
	tngx_mp4_©om_h—d”64_t
;

855 
ngx_št_t


856 
	$ngx_h‰p_mp4_»ad_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

857 
ngx_h‰p_mp4_©om_hªdËr_t
 *
©om
, 
ušt64_t
 
©om_d©a_size
)

859 
off_t
 
’d
;

860 
size_t
 
©om_h—d”_size
;

861 
u_ch¬
 *
©om_h—d”
, *
©om_Çme
;

862 
ušt64_t
 
©om_size
;

863 
ngx_št_t
 
rc
;

864 
ngx_ušt_t
 
n
;

866 
’d
 = 
mp4
->
off£t
 + 
©om_d©a_size
;

868 
mp4
->
off£t
 < 
’d
) {

870 ià(
	`ngx_h‰p_mp4_»ad
(
mp4
, (
ušt32_t
)è!ð
NGX_OK
) {

871  
NGX_ERROR
;

874 
©om_h—d”
 = 
mp4
->
bufãr_pos
;

875 
©om_size
 = 
	`ngx_mp4_g‘_32v®ue
(
©om_h—d”
);

876 
©om_h—d”_size
 = (
ngx_mp4_©om_h—d”_t
);

878 ià(
©om_size
 == 0) {

879 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

881  
NGX_OK
;

884 ià(
©om_size
 < (
ngx_mp4_©om_h—d”_t
)) {

886 ià(
©om_size
 == 1) {

888 ià(
	`ngx_h‰p_mp4_»ad
(
mp4
, (
ngx_mp4_©om_h—d”64_t
))

889 !ð
NGX_OK
)

891  
NGX_ERROR
;

895 
©om_h—d”
 = 
mp4
->
bufãr_pos
;

896 
©om_size
 = 
	`ngx_mp4_g‘_64v®ue
(
©om_h—d”
 + 8);

897 
©om_h—d”_size
 = (
ngx_mp4_©om_h—d”64_t
);

900 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

902 
mp4
->
fže
.
Çme
.
d©a
, 
©om_size
);

903  
NGX_ERROR
;

907 ià(
	`ngx_h‰p_mp4_»ad
(
mp4
, (
ngx_mp4_©om_h—d”_t
)è!ð
NGX_OK
) {

908  
NGX_ERROR
;

911 
©om_h—d”
 = 
mp4
->
bufãr_pos
;

912 
©om_Çme
 = 
©om_h—d”
 + (
ušt32_t
);

914 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

916 4, 
©om_Çme
, 
mp4
->
off£t
, 
©om_size
);

918 ià(
©om_size
 > (
ušt64_t
è(
NGX_MAX_OFF_T_VALUE
 - 
mp4
->
off£t
)

919 || 
mp4
->
off£t
 + (
off_t
è
©om_size
 > 
’d
)

921 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

923 
mp4
->
fže
.
Çme
.
d©a
, 
©om_size
);

924  
NGX_ERROR
;

927 
n
 = 0; 
©om
[n].
Çme
;‚++) {

929 ià(
	`ngx_¡ºcmp
(
©om_Çme
, 
©om
[
n
].
Çme
, 4) == 0) {

931 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_h—d”_size
);

933 
rc
 = 
©om
[
n
].
	`hªdËr
(
mp4
, 
©om_size
 - 
©om_h—d”_size
);

934 ià(
rc
 !ð
NGX_OK
) {

935  
rc
;

938 
Ãxt
;

942 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_size
);

944 
Ãxt
:

948  
NGX_OK
;

949 
	}
}

952 
ngx_št_t


953 
	$ngx_h‰p_mp4_»ad
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
size_t
 
size
)

955 
ssize_t
 
n
;

957 ià(
mp4
->
bufãr_pos
 + 
size
 <ðmp4->
bufãr_’d
) {

958  
NGX_OK
;

961 ià(
mp4
->
off£t
 + (
off_t
èmp4->
bufãr_size
 > mp4->
’d
) {

962 
mp4
->
bufãr_size
 = (
size_t
è(mp4->
’d
 - mp4->
off£t
);

965 ià(
mp4
->
bufãr_size
 < 
size
) {

966 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

967 "\"%s\" mp4 fžŒunÿ‹d", 
mp4
->
fže
.
Çme
.
d©a
);

968  
NGX_ERROR
;

971 ià(
mp4
->
bufãr
 =ð
NULL
) {

972 
mp4
->
bufãr
 = 
	`ngx_·Îoc
(mp4->
»que¡
->
poÞ
, mp4->
bufãr_size
);

973 ià(
mp4
->
bufãr
 =ð
NULL
) {

974  
NGX_ERROR
;

977 
mp4
->
bufãr_¡¬t
 = mp4->
bufãr
;

980 
n
 = 
	`ngx_»ad_fže
(&
mp4
->
fže
, mp4->
bufãr_¡¬t
, mp4->
bufãr_size
,

981 
mp4
->
off£t
);

983 ià(
n
 =ð
NGX_ERROR
) {

984  
NGX_ERROR
;

987 ià((
size_t
è
n
 !ð
mp4
->
bufãr_size
) {

988 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
mp4
->
fže
.
log
, 0,

989 
ngx_»ad_fže_n
 "„ead only %z of %z from \"%s\"",

990 
n
, 
mp4
->
bufãr_size
, mp4->
fže
.
Çme
.
d©a
);

991  
NGX_ERROR
;

994 
mp4
->
bufãr_pos
 = mp4->
bufãr_¡¬t
;

995 
mp4
->
bufãr_’d
 = mp4->
bufãr_¡¬t
 + mp4->
bufãr_size
;

997  
NGX_OK
;

998 
	}
}

1001 
ngx_št_t


1002 
	$ngx_h‰p_mp4_»ad_áyp_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1004 
u_ch¬
 *
áyp_©om
;

1005 
size_t
 
©om_size
;

1006 
ngx_buf_t
 *
©om
;

1008 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 ftyp‡tom");

1010 ià(
©om_d©a_size
 > 1024

1011 || 
	`ngx_mp4_©om_d©a
(
mp4
è+ (
size_t
è
©om_d©a_size
 > mp4->
bufãr_’d
)

1013 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1015 
mp4
->
fže
.
Çme
.
d©a
, 
©om_d©a_size
);

1016  
NGX_ERROR
;

1019 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1021 
áyp_©om
 = 
	`ngx_·Îoc
(
mp4
->
»que¡
->
poÞ
, 
©om_size
);

1022 ià(
áyp_©om
 =ð
NULL
) {

1023  
NGX_ERROR
;

1026 
	`ngx_mp4_£t_32v®ue
(
áyp_©om
, 
©om_size
);

1027 
	`ngx_mp4_£t_©om_Çme
(
áyp_©om
, 'f', 't', 'y', 'p');

1033 
	`ngx_memýy
(
áyp_©om
 + (
ngx_mp4_©om_h—d”_t
),

1034 
	`ngx_mp4_©om_d©a
(
mp4
), (
size_t
è
©om_d©a_size
);

1036 
©om
 = &
mp4
->
áyp_©om_buf
;

1037 
©om
->
‹mpÜ¬y
 = 1;

1038 
©om
->
pos
 = 
áyp_©om
;

1039 
©om
->
Ï¡
 = 
áyp_©om
 + 
©om_size
;

1041 
mp4
->
áyp_©om
.
buf
 = 
©om
;

1042 
mp4
->
áyp_size
 = 
©om_size
;

1043 
mp4
->
cÚ‹Á_Ëngth
 = 
©om_size
;

1045 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1047  
NGX_OK
;

1048 
	}
}

1055 
	#NGX_HTTP_MP4_MOOV_BUFFER_EXCESS
 (4 * 1024)

	)

1057 
ngx_št_t


1058 
	$ngx_h‰p_mp4_»ad_moov_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1060 
ngx_št_t
 
rc
;

1061 
ngx_ušt_t
 
no_md©
;

1062 
ngx_buf_t
 *
©om
;

1063 
ngx_h‰p_mp4_cÚf_t
 *
cÚf
;

1065 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 moov‡tom");

1067 
no_md©
 = (
mp4
->
md©_©om
.
buf
 =ð
NULL
);

1069 ià(
no_md©
 && 
mp4
->
¡¬t
 =ð0 && mp4->
Ëngth
 == 0) {

1074  
NGX_DECLINED
;

1077 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
mp4
->
»que¡
, 
ngx_h‰p_mp4_moduË
);

1079 ià(
©om_d©a_size
 > 
mp4
->
bufãr_size
) {

1081 ià(
©om_d©a_size
 > 
cÚf
->
max_bufãr_size
) {

1082 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1085 
mp4
->
fže
.
Çme
.
d©a
, 
©om_d©a_size
);

1086  
NGX_ERROR
;

1089 
	`ngx_pä“
(
mp4
->
»que¡
->
poÞ
, mp4->
bufãr
);

1090 
mp4
->
bufãr
 = 
NULL
;

1091 
mp4
->
bufãr_pos
 = 
NULL
;

1092 
mp4
->
bufãr_’d
 = 
NULL
;

1094 
mp4
->
bufãr_size
 = (
size_t
è
©om_d©a_size


1095 + 
NGX_HTTP_MP4_MOOV_BUFFER_EXCESS
 * 
no_md©
;

1098 ià(
	`ngx_h‰p_mp4_»ad
(
mp4
, (
size_t
è
©om_d©a_size
è!ð
NGX_OK
) {

1099  
NGX_ERROR
;

1102 
mp4
->
Œak
.
–ts
 = &mp4->
Œaks
;

1103 
mp4
->
Œak
.
size
 = (
ngx_h‰p_mp4_Œak_t
);

1104 
mp4
->
Œak
.
ÇÎoc
 = 2;

1105 
mp4
->
Œak
.
poÞ
 = mp4->
»que¡
->pool;

1107 
©om
 = &
mp4
->
moov_©om_buf
;

1108 
©om
->
‹mpÜ¬y
 = 1;

1109 
©om
->
pos
 = 
mp4
->
moov_©om_h—d”
;

1110 
©om
->
Ï¡
 = 
mp4
->
moov_©om_h—d”
 + 8;

1112 
mp4
->
moov_©om
.
buf
 = &mp4->
moov_©om_buf
;

1114 
rc
 = 
	`ngx_h‰p_mp4_»ad_©om
(
mp4
, 
ngx_h‰p_mp4_moov_©oms
, 
©om_d©a_size
);

1116 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 moov‡tom done");

1118 ià(
no_md©
) {

1119 
mp4
->
bufãr_¡¬t
 = mp4->
bufãr_pos
;

1120 
mp4
->
bufãr_size
 = 
NGX_HTTP_MP4_MOOV_BUFFER_EXCESS
;

1122 ià(
mp4
->
bufãr_¡¬t
 + mp4->
bufãr_size
 > mp4->
bufãr_’d
) {

1123 
mp4
->
bufãr
 = 
NULL
;

1124 
mp4
->
bufãr_pos
 = 
NULL
;

1125 
mp4
->
bufãr_’d
 = 
NULL
;

1130 
mp4
->
off£t
 = mp4->
’d
;

1133  
rc
;

1134 
	}
}

1137 
ngx_št_t


1138 
	$ngx_h‰p_mp4_»ad_md©_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1140 
ngx_buf_t
 *
d©a
;

1142 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 mdat‡tom");

1144 
d©a
 = &
mp4
->
md©_d©a_buf
;

1145 
d©a
->
fže
 = &
mp4
->file;

1146 
d©a
->
š_fže
 = 1;

1147 
d©a
->
Ï¡_buf
 = 1;

1148 
d©a
->
Ï¡_š_chaš
 = 1;

1149 
d©a
->
fže_Ï¡
 = 
mp4
->
off£t
 + 
©om_d©a_size
;

1151 
mp4
->
md©_©om
.
buf
 = &mp4->
md©_©om_buf
;

1152 
mp4
->
md©_©om
.
Ãxt
 = &mp4->
md©_d©a
;

1153 
mp4
->
md©_d©a
.
buf
 = 
d©a
;

1155 ià(
mp4
->
Œak
.
ÃÉs
) {

1157 
mp4
->
off£t
 = mp4->
’d
;

1160 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1163  
NGX_OK
;

1164 
	}
}

1167 
size_t


1168 
	$ngx_h‰p_mp4_upd©e_md©_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
off_t
 
¡¬t_off£t
,

1169 
off_t
 
’d_off£t
)

1171 
off_t
 
©om_d©a_size
;

1172 
u_ch¬
 *
©om_h—d”
;

1173 
ušt32_t
 
©om_h—d”_size
;

1174 
ušt64_t
 
©om_size
;

1175 
ngx_buf_t
 *
©om
;

1177 
©om_d©a_size
 = 
’d_off£t
 - 
¡¬t_off£t
;

1178 
mp4
->
md©_d©a
.
buf
->
fže_pos
 = 
¡¬t_off£t
;

1179 
mp4
->
md©_d©a
.
buf
->
fže_Ï¡
 = 
’d_off£t
;

1181 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1182 "md©‚ew off£ˆ@%O:%O", 
¡¬t_off£t
, 
©om_d©a_size
);

1184 
©om_h—d”
 = 
mp4
->
md©_©om_h—d”
;

1186 ià((
ušt64_t
è
©om_d©a_size
 > (uint64_t) 0xffffffff) {

1187 
©om_size
 = 1;

1188 
©om_h—d”_size
 = (
ngx_mp4_©om_h—d”64_t
);

1189 
	`ngx_mp4_£t_64v®ue
(
©om_h—d”
 + (
ngx_mp4_©om_h—d”_t
),

1190 (
ngx_mp4_©om_h—d”64_t
è+ 
©om_d©a_size
);

1192 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ 
©om_d©a_size
;

1193 
©om_h—d”_size
 = (
ngx_mp4_©om_h—d”_t
);

1196 
mp4
->
cÚ‹Á_Ëngth
 +ð
©om_h—d”_size
 + 
©om_d©a_size
;

1198 
	`ngx_mp4_£t_32v®ue
(
©om_h—d”
, 
©om_size
);

1199 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 'm', 'd', 'a', 't');

1201 
©om
 = &
mp4
->
md©_©om_buf
;

1202 
©om
->
‹mpÜ¬y
 = 1;

1203 
©om
->
pos
 = 
©om_h—d”
;

1204 
©om
->
Ï¡
 = 
©om_h—d”
 + 
©om_h—d”_size
;

1206  
©om_h—d”_size
;

1207 
	}
}

1211 
u_ch¬
 
	msize
[4];

1212 
u_ch¬
 
	mÇme
[4];

1213 
u_ch¬
 
	mv”siÚ
[1];

1214 
u_ch¬
 
	mæags
[3];

1215 
u_ch¬
 
	mü—tiÚ_time
[4];

1216 
u_ch¬
 
	mmodifiÿtiÚ_time
[4];

1217 
u_ch¬
 
	mtimesÿË
[4];

1218 
u_ch¬
 
	mdu¿tiÚ
[4];

1219 
u_ch¬
 
	m¿‹
[4];

1220 
u_ch¬
 
	mvÞume
[2];

1221 
u_ch¬
 
	m»£rved
[10];

1222 
u_ch¬
 
	mm©rix
[36];

1223 
u_ch¬
 
	m´ev›w_time
[4];

1224 
u_ch¬
 
	m´ev›w_du¿tiÚ
[4];

1225 
u_ch¬
 
	mpo¡”_time
[4];

1226 
u_ch¬
 
	m£ËùiÚ_time
[4];

1227 
u_ch¬
 
	m£ËùiÚ_du¿tiÚ
[4];

1228 
u_ch¬
 
	mcu¼’t_time
[4];

1229 
u_ch¬
 
	mÃxt_Œack_id
[4];

1230 } 
	tngx_mp4_mvhd_©om_t
;

1233 
u_ch¬
 
	msize
[4];

1234 
u_ch¬
 
	mÇme
[4];

1235 
u_ch¬
 
	mv”siÚ
[1];

1236 
u_ch¬
 
	mæags
[3];

1237 
u_ch¬
 
	mü—tiÚ_time
[8];

1238 
u_ch¬
 
	mmodifiÿtiÚ_time
[8];

1239 
u_ch¬
 
	mtimesÿË
[4];

1240 
u_ch¬
 
	mdu¿tiÚ
[8];

1241 
u_ch¬
 
	m¿‹
[4];

1242 
u_ch¬
 
	mvÞume
[2];

1243 
u_ch¬
 
	m»£rved
[10];

1244 
u_ch¬
 
	mm©rix
[36];

1245 
u_ch¬
 
	m´ev›w_time
[4];

1246 
u_ch¬
 
	m´ev›w_du¿tiÚ
[4];

1247 
u_ch¬
 
	mpo¡”_time
[4];

1248 
u_ch¬
 
	m£ËùiÚ_time
[4];

1249 
u_ch¬
 
	m£ËùiÚ_du¿tiÚ
[4];

1250 
u_ch¬
 
	mcu¼’t_time
[4];

1251 
u_ch¬
 
	mÃxt_Œack_id
[4];

1252 } 
	tngx_mp4_mvhd64_©om_t
;

1255 
ngx_št_t


1256 
	$ngx_h‰p_mp4_»ad_mvhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1258 
u_ch¬
 *
©om_h—d”
;

1259 
size_t
 
©om_size
;

1260 
ušt32_t
 
timesÿË
;

1261 
ušt64_t
 
du¿tiÚ
, 
¡¬t_time
, 
Ëngth_time
;

1262 
ngx_buf_t
 *
©om
;

1263 
ngx_mp4_mvhd_©om_t
 *
mvhd_©om
;

1264 
ngx_mp4_mvhd64_©om_t
 *
mvhd64_©om
;

1266 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 mvhd‡tom");

1268 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1269 
mvhd_©om
 = (
ngx_mp4_mvhd_©om_t
 *è
©om_h—d”
;

1270 
mvhd64_©om
 = (
ngx_mp4_mvhd64_©om_t
 *è
©om_h—d”
;

1271 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 'm', 'v', 'h', 'd');

1273 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_mvhd_©om_t
è> 
©om_d©a_size
) {

1274 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1275 "\"%s\" mp4 mvhd‡tomoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

1276  
NGX_ERROR
;

1279 ià(
mvhd_©om
->
v”siÚ
[0] == 0) {

1281 
timesÿË
 = 
	`ngx_mp4_g‘_32v®ue
(
mvhd_©om
->timescale);

1282 
du¿tiÚ
 = 
	`ngx_mp4_g‘_32v®ue
(
mvhd_©om
->duration);

1287 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_mvhd64_©om_t
è> 
©om_d©a_size
) {

1288 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1290 
mp4
->
fže
.
Çme
.
d©a
);

1291  
NGX_ERROR
;

1294 
timesÿË
 = 
	`ngx_mp4_g‘_32v®ue
(
mvhd64_©om
->timescale);

1295 
du¿tiÚ
 = 
	`ngx_mp4_g‘_64v®ue
(
mvhd64_©om
->duration);

1298 
mp4
->
timesÿË
 =imescale;

1300 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1302 
timesÿË
, 
du¿tiÚ
, () duration /imescale);

1304 
¡¬t_time
 = (
ušt64_t
è
mp4
->
¡¬t
 * 
timesÿË
 / 1000;

1306 ià(
du¿tiÚ
 < 
¡¬t_time
) {

1307 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1309 
mp4
->
fže
.
Çme
.
d©a
);

1310  
NGX_ERROR
;

1313 
du¿tiÚ
 -ð
¡¬t_time
;

1315 ià(
mp4
->
Ëngth
) {

1316 
Ëngth_time
 = (
ušt64_t
è
mp4
->
Ëngth
 * 
timesÿË
 / 1000;

1318 ià(
du¿tiÚ
 > 
Ëngth_time
) {

1319 
du¿tiÚ
 = 
Ëngth_time
;

1323 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1325 
du¿tiÚ
, (èdu¿tiÚ / 
timesÿË
);

1327 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1328 
	`ngx_mp4_£t_32v®ue
(
mvhd_©om
->
size
, 
©om_size
);

1330 ià(
mvhd_©om
->
v”siÚ
[0] == 0) {

1331 
	`ngx_mp4_£t_32v®ue
(
mvhd_©om
->
du¿tiÚ
, duration);

1334 
	`ngx_mp4_£t_64v®ue
(
mvhd64_©om
->
du¿tiÚ
, duration);

1337 
©om
 = &
mp4
->
mvhd_©om_buf
;

1338 
©om
->
‹mpÜ¬y
 = 1;

1339 
©om
->
pos
 = 
©om_h—d”
;

1340 
©om
->
Ï¡
 = 
©om_h—d”
 + 
©om_size
;

1342 
mp4
->
mvhd_©om
.
buf
 = 
©om
;

1344 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1346  
NGX_OK
;

1347 
	}
}

1350 
ngx_št_t


1351 
	$ngx_h‰p_mp4_»ad_Œak_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1353 
u_ch¬
 *
©om_h—d”
, *
©om_’d
;

1354 
off_t
 
©om_fže_’d
;

1355 
ngx_št_t
 
rc
;

1356 
ngx_buf_t
 *
©om
;

1357 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1359 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4rak‡tom");

1361 
Œak
 = 
	`ngx_¬¿y_push
(&
mp4
->trak);

1362 ià(
Œak
 =ð
NULL
) {

1363  
NGX_ERROR
;

1366 
	`ngx_memz”o
(
Œak
, (
ngx_h‰p_mp4_Œak_t
));

1368 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1369 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 't', 'r', 'a', 'k');

1371 
©om
 = &
Œak
->
Œak_©om_buf
;

1372 
©om
->
‹mpÜ¬y
 = 1;

1373 
©om
->
pos
 = 
©om_h—d”
;

1374 
©om
->
Ï¡
 = 
©om_h—d”
 + (
ngx_mp4_©om_h—d”_t
);

1376 
Œak
->
out
[
NGX_HTTP_MP4_TRAK_ATOM
].
buf
 = 
©om
;

1378 
©om_’d
 = 
mp4
->
bufãr_pos
 + (
size_t
è
©om_d©a_size
;

1379 
©om_fže_’d
 = 
mp4
->
off£t
 + 
©om_d©a_size
;

1381 
rc
 = 
	`ngx_h‰p_mp4_»ad_©om
(
mp4
, 
ngx_h‰p_mp4_Œak_©oms
, 
©om_d©a_size
);

1383 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1384 "mp4¿k‡tom: %i", 
rc
);

1386 ià(
rc
 =ð
NGX_DECLINED
) {

1388 
	`ngx_memz”o
(
Œak
, (
ngx_h‰p_mp4_Œak_t
));

1389 
mp4
->
Œak
.
ÃÉs
--;

1390 
mp4
->
bufãr_pos
 = 
©om_’d
;

1391 
mp4
->
off£t
 = 
©om_fže_’d
;

1392  
NGX_OK
;

1395  
rc
;

1396 
	}
}

1400 
	$ngx_h‰p_mp4_upd©e_Œak_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

1401 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

1403 
ngx_buf_t
 *
©om
;

1405 
Œak
->
size
 +ð(
ngx_mp4_©om_h—d”_t
);

1406 
©om
 = &
Œak
->
Œak_©om_buf
;

1407 
	`ngx_mp4_£t_32v®ue
(
©om
->
pos
, 
Œak
->
size
);

1408 
	}
}

1411 
ngx_št_t


1412 
	$ngx_h‰p_mp4_»ad_cmov_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1414 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1416 
mp4
->
fže
.
Çme
.
d©a
);

1418  
NGX_ERROR
;

1419 
	}
}

1423 
u_ch¬
 
	msize
[4];

1424 
u_ch¬
 
	mÇme
[4];

1425 
u_ch¬
 
	mv”siÚ
[1];

1426 
u_ch¬
 
	mæags
[3];

1427 
u_ch¬
 
	mü—tiÚ_time
[4];

1428 
u_ch¬
 
	mmodifiÿtiÚ_time
[4];

1429 
u_ch¬
 
	mŒack_id
[4];

1430 
u_ch¬
 
	m»£rved1
[4];

1431 
u_ch¬
 
	mdu¿tiÚ
[4];

1432 
u_ch¬
 
	m»£rved2
[8];

1433 
u_ch¬
 
	mÏy”
[2];

1434 
u_ch¬
 
	mgroup
[2];

1435 
u_ch¬
 
	mvÞume
[2];

1436 
u_ch¬
 
	m»v”ved3
[2];

1437 
u_ch¬
 
	mm©rix
[36];

1438 
u_ch¬
 
	mwidth
[4];

1439 
u_ch¬
 
	mheigth
[4];

1440 } 
	tngx_mp4_tkhd_©om_t
;

1443 
u_ch¬
 
	msize
[4];

1444 
u_ch¬
 
	mÇme
[4];

1445 
u_ch¬
 
	mv”siÚ
[1];

1446 
u_ch¬
 
	mæags
[3];

1447 
u_ch¬
 
	mü—tiÚ_time
[8];

1448 
u_ch¬
 
	mmodifiÿtiÚ_time
[8];

1449 
u_ch¬
 
	mŒack_id
[4];

1450 
u_ch¬
 
	m»£rved1
[4];

1451 
u_ch¬
 
	mdu¿tiÚ
[8];

1452 
u_ch¬
 
	m»£rved2
[8];

1453 
u_ch¬
 
	mÏy”
[2];

1454 
u_ch¬
 
	mgroup
[2];

1455 
u_ch¬
 
	mvÞume
[2];

1456 
u_ch¬
 
	m»v”ved3
[2];

1457 
u_ch¬
 
	mm©rix
[36];

1458 
u_ch¬
 
	mwidth
[4];

1459 
u_ch¬
 
	mheigth
[4];

1460 } 
	tngx_mp4_tkhd64_©om_t
;

1463 
ngx_št_t


1464 
	$ngx_h‰p_mp4_»ad_tkhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1466 
u_ch¬
 *
©om_h—d”
;

1467 
size_t
 
©om_size
;

1468 
ušt64_t
 
du¿tiÚ
, 
¡¬t_time
, 
Ëngth_time
;

1469 
ngx_buf_t
 *
©om
;

1470 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1471 
ngx_mp4_tkhd_©om_t
 *
tkhd_©om
;

1472 
ngx_mp4_tkhd64_©om_t
 *
tkhd64_©om
;

1474 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4khd‡tom");

1476 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1477 
tkhd_©om
 = (
ngx_mp4_tkhd_©om_t
 *è
©om_h—d”
;

1478 
tkhd64_©om
 = (
ngx_mp4_tkhd64_©om_t
 *è
©om_h—d”
;

1479 
	`ngx_mp4_£t_©om_Çme
(
tkhd_©om
, 't', 'k', 'h', 'd');

1481 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_tkhd_©om_t
è> 
©om_d©a_size
) {

1482 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1483 "\"%s\" mp4khd‡tomoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

1484  
NGX_ERROR
;

1487 ià(
tkhd_©om
->
v”siÚ
[0] == 0) {

1489 
du¿tiÚ
 = 
	`ngx_mp4_g‘_32v®ue
(
tkhd_©om
->duration);

1494 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_tkhd64_©om_t
è> 
©om_d©a_size
) {

1495 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1497 
mp4
->
fže
.
Çme
.
d©a
);

1498  
NGX_ERROR
;

1501 
du¿tiÚ
 = 
	`ngx_mp4_g‘_64v®ue
(
tkhd64_©om
->duration);

1504 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1506 
du¿tiÚ
, (èdu¿tiÚ / 
mp4
->
timesÿË
);

1508 
¡¬t_time
 = (
ušt64_t
è
mp4
->
¡¬t
 * mp4->
timesÿË
 / 1000;

1510 ià(
du¿tiÚ
 <ð
¡¬t_time
) {

1511 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1513  
NGX_DECLINED
;

1516 
du¿tiÚ
 -ð
¡¬t_time
;

1518 ià(
mp4
->
Ëngth
) {

1519 
Ëngth_time
 = (
ušt64_t
è
mp4
->
Ëngth
 * mp4->
timesÿË
 / 1000;

1521 ià(
du¿tiÚ
 > 
Ëngth_time
) {

1522 
du¿tiÚ
 = 
Ëngth_time
;

1526 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1528 
du¿tiÚ
, (èdu¿tiÚ / 
mp4
->
timesÿË
);

1530 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1532 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1533 
Œak
->
tkhd_size
 = 
©om_size
;

1535 
	`ngx_mp4_£t_32v®ue
(
tkhd_©om
->
size
, 
©om_size
);

1537 ià(
tkhd_©om
->
v”siÚ
[0] == 0) {

1538 
	`ngx_mp4_£t_32v®ue
(
tkhd_©om
->
du¿tiÚ
, duration);

1541 
	`ngx_mp4_£t_64v®ue
(
tkhd64_©om
->
du¿tiÚ
, duration);

1544 
©om
 = &
Œak
->
tkhd_©om_buf
;

1545 
©om
->
‹mpÜ¬y
 = 1;

1546 
©om
->
pos
 = 
©om_h—d”
;

1547 
©om
->
Ï¡
 = 
©om_h—d”
 + 
©om_size
;

1549 
Œak
->
out
[
NGX_HTTP_MP4_TKHD_ATOM
].
buf
 = 
©om
;

1551 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1553  
NGX_OK
;

1554 
	}
}

1557 
ngx_št_t


1558 
	$ngx_h‰p_mp4_»ad_mdŸ_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1560 
u_ch¬
 *
©om_h—d”
;

1561 
ngx_buf_t
 *
©om
;

1562 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1564 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "process mdia‡tom");

1566 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1567 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 'm', 'd', 'i', 'a');

1569 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1571 
©om
 = &
Œak
->
mdŸ_©om_buf
;

1572 
©om
->
‹mpÜ¬y
 = 1;

1573 
©om
->
pos
 = 
©om_h—d”
;

1574 
©om
->
Ï¡
 = 
©om_h—d”
 + (
ngx_mp4_©om_h—d”_t
);

1576 
Œak
->
out
[
NGX_HTTP_MP4_MDIA_ATOM
].
buf
 = 
©om
;

1578  
	`ngx_h‰p_mp4_»ad_©om
(
mp4
, 
ngx_h‰p_mp4_mdŸ_©oms
, 
©om_d©a_size
);

1579 
	}
}

1583 
	$ngx_h‰p_mp4_upd©e_mdŸ_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

1584 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

1586 
ngx_buf_t
 *
©om
;

1588 
Œak
->
size
 +ð(
ngx_mp4_©om_h—d”_t
);

1589 
©om
 = &
Œak
->
mdŸ_©om_buf
;

1590 
	`ngx_mp4_£t_32v®ue
(
©om
->
pos
, 
Œak
->
size
);

1591 
	}
}

1595 
u_ch¬
 
	msize
[4];

1596 
u_ch¬
 
	mÇme
[4];

1597 
u_ch¬
 
	mv”siÚ
[1];

1598 
u_ch¬
 
	mæags
[3];

1599 
u_ch¬
 
	mü—tiÚ_time
[4];

1600 
u_ch¬
 
	mmodifiÿtiÚ_time
[4];

1601 
u_ch¬
 
	mtimesÿË
[4];

1602 
u_ch¬
 
	mdu¿tiÚ
[4];

1603 
u_ch¬
 
	mÏnguage
[2];

1604 
u_ch¬
 
	mqu®™y
[2];

1605 } 
	tngx_mp4_mdhd_©om_t
;

1608 
u_ch¬
 
	msize
[4];

1609 
u_ch¬
 
	mÇme
[4];

1610 
u_ch¬
 
	mv”siÚ
[1];

1611 
u_ch¬
 
	mæags
[3];

1612 
u_ch¬
 
	mü—tiÚ_time
[8];

1613 
u_ch¬
 
	mmodifiÿtiÚ_time
[8];

1614 
u_ch¬
 
	mtimesÿË
[4];

1615 
u_ch¬
 
	mdu¿tiÚ
[8];

1616 
u_ch¬
 
	mÏnguage
[2];

1617 
u_ch¬
 
	mqu®™y
[2];

1618 } 
	tngx_mp4_mdhd64_©om_t
;

1621 
ngx_št_t


1622 
	$ngx_h‰p_mp4_»ad_mdhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1624 
u_ch¬
 *
©om_h—d”
;

1625 
size_t
 
©om_size
;

1626 
ušt32_t
 
timesÿË
;

1627 
ušt64_t
 
du¿tiÚ
, 
¡¬t_time
, 
Ëngth_time
;

1628 
ngx_buf_t
 *
©om
;

1629 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1630 
ngx_mp4_mdhd_©om_t
 *
mdhd_©om
;

1631 
ngx_mp4_mdhd64_©om_t
 *
mdhd64_©om
;

1633 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 mdhd‡tom");

1635 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1636 
mdhd_©om
 = (
ngx_mp4_mdhd_©om_t
 *è
©om_h—d”
;

1637 
mdhd64_©om
 = (
ngx_mp4_mdhd64_©om_t
 *è
©om_h—d”
;

1638 
	`ngx_mp4_£t_©om_Çme
(
mdhd_©om
, 'm', 'd', 'h', 'd');

1640 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_mdhd_©om_t
è> 
©om_d©a_size
) {

1641 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1642 "\"%s\" mp4 mdhd‡tomoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

1643  
NGX_ERROR
;

1646 ià(
mdhd_©om
->
v”siÚ
[0] == 0) {

1648 
timesÿË
 = 
	`ngx_mp4_g‘_32v®ue
(
mdhd_©om
->timescale);

1649 
du¿tiÚ
 = 
	`ngx_mp4_g‘_32v®ue
(
mdhd_©om
->duration);

1654 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_mdhd64_©om_t
è> 
©om_d©a_size
) {

1655 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1657 
mp4
->
fže
.
Çme
.
d©a
);

1658  
NGX_ERROR
;

1661 
timesÿË
 = 
	`ngx_mp4_g‘_32v®ue
(
mdhd64_©om
->timescale);

1662 
du¿tiÚ
 = 
	`ngx_mp4_g‘_64v®ue
(
mdhd64_©om
->duration);

1665 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1667 
timesÿË
, 
du¿tiÚ
, () duration /imescale);

1669 
¡¬t_time
 = (
ušt64_t
è
mp4
->
¡¬t
 * 
timesÿË
 / 1000;

1671 ià(
du¿tiÚ
 <ð
¡¬t_time
) {

1672 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1674  
NGX_DECLINED
;

1677 
du¿tiÚ
 -ð
¡¬t_time
;

1679 ià(
mp4
->
Ëngth
) {

1680 
Ëngth_time
 = (
ušt64_t
è
mp4
->
Ëngth
 * 
timesÿË
 / 1000;

1682 ià(
du¿tiÚ
 > 
Ëngth_time
) {

1683 
du¿tiÚ
 = 
Ëngth_time
;

1687 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1689 
du¿tiÚ
, (èdu¿tiÚ / 
timesÿË
);

1691 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1693 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1694 
Œak
->
mdhd_size
 = 
©om_size
;

1695 
Œak
->
timesÿË
 =imescale;

1697 
	`ngx_mp4_£t_32v®ue
(
mdhd_©om
->
size
, 
©om_size
);

1699 ià(
mdhd_©om
->
v”siÚ
[0] == 0) {

1700 
	`ngx_mp4_£t_32v®ue
(
mdhd_©om
->
du¿tiÚ
, duration);

1703 
	`ngx_mp4_£t_64v®ue
(
mdhd64_©om
->
du¿tiÚ
, duration);

1706 
©om
 = &
Œak
->
mdhd_©om_buf
;

1707 
©om
->
‹mpÜ¬y
 = 1;

1708 
©om
->
pos
 = 
©om_h—d”
;

1709 
©om
->
Ï¡
 = 
©om_h—d”
 + 
©om_size
;

1711 
Œak
->
out
[
NGX_HTTP_MP4_MDHD_ATOM
].
buf
 = 
©om
;

1713 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1715  
NGX_OK
;

1716 
	}
}

1719 
ngx_št_t


1720 
	$ngx_h‰p_mp4_»ad_hdÌ_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1722 
u_ch¬
 *
©om_h—d”
;

1723 
size_t
 
©om_size
;

1724 
ngx_buf_t
 *
©om
;

1725 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1727 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 hdlr‡tom");

1729 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1730 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1731 
	`ngx_mp4_£t_32v®ue
(
©om_h—d”
, 
©om_size
);

1732 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 'h', 'd', 'l', 'r');

1734 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1736 
©om
 = &
Œak
->
hdÌ_©om_buf
;

1737 
©om
->
‹mpÜ¬y
 = 1;

1738 
©om
->
pos
 = 
©om_h—d”
;

1739 
©om
->
Ï¡
 = 
©om_h—d”
 + 
©om_size
;

1741 
Œak
->
hdÌ_size
 = 
©om_size
;

1742 
Œak
->
out
[
NGX_HTTP_MP4_HDLR_ATOM
].
buf
 = 
©om
;

1744 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1746  
NGX_OK
;

1747 
	}
}

1750 
ngx_št_t


1751 
	$ngx_h‰p_mp4_»ad_mšf_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1753 
u_ch¬
 *
©om_h—d”
;

1754 
ngx_buf_t
 *
©om
;

1755 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1757 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "process minf‡tom");

1759 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1760 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 'm', 'i', 'n', 'f');

1762 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1764 
©om
 = &
Œak
->
mšf_©om_buf
;

1765 
©om
->
‹mpÜ¬y
 = 1;

1766 
©om
->
pos
 = 
©om_h—d”
;

1767 
©om
->
Ï¡
 = 
©om_h—d”
 + (
ngx_mp4_©om_h—d”_t
);

1769 
Œak
->
out
[
NGX_HTTP_MP4_MINF_ATOM
].
buf
 = 
©om
;

1771  
	`ngx_h‰p_mp4_»ad_©om
(
mp4
, 
ngx_h‰p_mp4_mšf_©oms
, 
©om_d©a_size
);

1772 
	}
}

1776 
	$ngx_h‰p_mp4_upd©e_mšf_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

1777 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

1779 
ngx_buf_t
 *
©om
;

1781 
Œak
->
size
 +ð(
ngx_mp4_©om_h—d”_t
)

1782 + 
Œak
->
vmhd_size


1783 + 
Œak
->
smhd_size


1784 + 
Œak
->
dšf_size
;

1785 
©om
 = &
Œak
->
mšf_©om_buf
;

1786 
	`ngx_mp4_£t_32v®ue
(
©om
->
pos
, 
Œak
->
size
);

1787 
	}
}

1790 
ngx_št_t


1791 
	$ngx_h‰p_mp4_»ad_vmhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1793 
u_ch¬
 *
©om_h—d”
;

1794 
size_t
 
©om_size
;

1795 
ngx_buf_t
 *
©om
;

1796 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1798 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 vmhd‡tom");

1800 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1801 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1802 
	`ngx_mp4_£t_32v®ue
(
©om_h—d”
, 
©om_size
);

1803 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 'v', 'm', 'h', 'd');

1805 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1807 
©om
 = &
Œak
->
vmhd_©om_buf
;

1808 
©om
->
‹mpÜ¬y
 = 1;

1809 
©om
->
pos
 = 
©om_h—d”
;

1810 
©om
->
Ï¡
 = 
©om_h—d”
 + 
©om_size
;

1812 
Œak
->
vmhd_size
 +ð
©om_size
;

1813 
Œak
->
out
[
NGX_HTTP_MP4_VMHD_ATOM
].
buf
 = 
©om
;

1815 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1817  
NGX_OK
;

1818 
	}
}

1821 
ngx_št_t


1822 
	$ngx_h‰p_mp4_»ad_smhd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1824 
u_ch¬
 *
©om_h—d”
;

1825 
size_t
 
©om_size
;

1826 
ngx_buf_t
 *
©om
;

1827 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1829 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 smhd‡tom");

1831 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1832 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1833 
	`ngx_mp4_£t_32v®ue
(
©om_h—d”
, 
©om_size
);

1834 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 's', 'm', 'h', 'd');

1836 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1838 
©om
 = &
Œak
->
smhd_©om_buf
;

1839 
©om
->
‹mpÜ¬y
 = 1;

1840 
©om
->
pos
 = 
©om_h—d”
;

1841 
©om
->
Ï¡
 = 
©om_h—d”
 + 
©om_size
;

1843 
Œak
->
smhd_size
 +ð
©om_size
;

1844 
Œak
->
out
[
NGX_HTTP_MP4_SMHD_ATOM
].
buf
 = 
©om
;

1846 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1848  
NGX_OK
;

1849 
	}
}

1852 
ngx_št_t


1853 
	$ngx_h‰p_mp4_»ad_dšf_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1855 
u_ch¬
 *
©om_h—d”
;

1856 
size_t
 
©om_size
;

1857 
ngx_buf_t
 *
©om
;

1858 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1860 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 dinf‡tom");

1862 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1863 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1864 
	`ngx_mp4_£t_32v®ue
(
©om_h—d”
, 
©om_size
);

1865 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 'd', 'i', 'n', 'f');

1867 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1869 
©om
 = &
Œak
->
dšf_©om_buf
;

1870 
©om
->
‹mpÜ¬y
 = 1;

1871 
©om
->
pos
 = 
©om_h—d”
;

1872 
©om
->
Ï¡
 = 
©om_h—d”
 + 
©om_size
;

1874 
Œak
->
dšf_size
 +ð
©om_size
;

1875 
Œak
->
out
[
NGX_HTTP_MP4_DINF_ATOM
].
buf
 = 
©om
;

1877 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1879  
NGX_OK
;

1880 
	}
}

1883 
ngx_št_t


1884 
	$ngx_h‰p_mp4_»ad_¡bl_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1886 
u_ch¬
 *
©om_h—d”
;

1887 
ngx_buf_t
 *
©om
;

1888 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1890 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "process stbl‡tom");

1892 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1893 
	`ngx_mp4_£t_©om_Çme
(
©om_h—d”
, 's', 't', 'b', 'l');

1895 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1897 
©om
 = &
Œak
->
¡bl_©om_buf
;

1898 
©om
->
‹mpÜ¬y
 = 1;

1899 
©om
->
pos
 = 
©om_h—d”
;

1900 
©om
->
Ï¡
 = 
©om_h—d”
 + (
ngx_mp4_©om_h—d”_t
);

1902 
Œak
->
out
[
NGX_HTTP_MP4_STBL_ATOM
].
buf
 = 
©om
;

1904  
	`ngx_h‰p_mp4_»ad_©om
(
mp4
, 
ngx_h‰p_mp4_¡bl_©oms
, 
©om_d©a_size
);

1905 
	}
}

1909 
	$ngx_h‰p_mp4_upd©e_¡bl_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

1910 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

1912 
ngx_buf_t
 *
©om
;

1914 
Œak
->
size
 +ð(
ngx_mp4_©om_h—d”_t
);

1915 
©om
 = &
Œak
->
¡bl_©om_buf
;

1916 
	`ngx_mp4_£t_32v®ue
(
©om
->
pos
, 
Œak
->
size
);

1917 
	}
}

1921 
u_ch¬
 
	msize
[4];

1922 
u_ch¬
 
	mÇme
[4];

1923 
u_ch¬
 
	mv”siÚ
[1];

1924 
u_ch¬
 
	mæags
[3];

1925 
u_ch¬
 
	m’Œ›s
[4];

1927 
u_ch¬
 
	mmedŸ_size
[4];

1928 
u_ch¬
 
	mmedŸ_Çme
[4];

1929 } 
	tngx_mp4_¡sd_©om_t
;

1932 
ngx_št_t


1933 
	$ngx_h‰p_mp4_»ad_¡sd_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1935 
u_ch¬
 *
©om_h—d”
, *
©om_bË
;

1936 
size_t
 
©om_size
;

1937 
ngx_buf_t
 *
©om
;

1938 
ngx_mp4_¡sd_©om_t
 *
¡sd_©om
;

1939 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

1943 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 stsd‡tom");

1945 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

1946 
¡sd_©om
 = (
ngx_mp4_¡sd_©om_t
 *è
©om_h—d”
;

1947 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

1948 
©om_bË
 = 
©om_h—d”
 + 
©om_size
;

1949 
	`ngx_mp4_£t_32v®ue
(
¡sd_©om
->
size
, 
©om_size
);

1950 
	`ngx_mp4_£t_©om_Çme
(
¡sd_©om
, 's', 't', 's', 'd');

1952 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡sd_©om_t
è> 
©om_d©a_size
) {

1953 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

1954 "\"%s\" mp4 stsd‡tomoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

1955  
NGX_ERROR
;

1958 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

1960 
	`ngx_mp4_g‘_32v®ue
(
¡sd_©om
->
’Œ›s
),

1961 4, 
¡sd_©om
->
medŸ_Çme
);

1963 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

1965 
©om
 = &
Œak
->
¡sd_©om_buf
;

1966 
©om
->
‹mpÜ¬y
 = 1;

1967 
©om
->
pos
 = 
©om_h—d”
;

1968 
©om
->
Ï¡
 = 
©om_bË
;

1970 
Œak
->
out
[
NGX_HTTP_MP4_STSD_ATOM
].
buf
 = 
©om
;

1971 
Œak
->
size
 +ð
©om_size
;

1973 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

1975  
NGX_OK
;

1976 
	}
}

1980 
u_ch¬
 
	msize
[4];

1981 
u_ch¬
 
	mÇme
[4];

1982 
u_ch¬
 
	mv”siÚ
[1];

1983 
u_ch¬
 
	mæags
[3];

1984 
u_ch¬
 
	m’Œ›s
[4];

1985 } 
	tngx_mp4_¡ts_©om_t
;

1988 
u_ch¬
 
	mcouÁ
[4];

1989 
u_ch¬
 
	mdu¿tiÚ
[4];

1990 } 
	tngx_mp4_¡ts_’Œy_t
;

1993 
ngx_št_t


1994 
	$ngx_h‰p_mp4_»ad_¡ts_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

1996 
u_ch¬
 *
©om_h—d”
, *
©om_bË
, *
©om_’d
;

1997 
ušt32_t
 
’Œ›s
;

1998 
ngx_buf_t
 *
©om
, *
d©a
;

1999 
ngx_mp4_¡ts_©om_t
 *
¡ts_©om
;

2000 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

2004 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 stts‡tom");

2006 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

2007 
¡ts_©om
 = (
ngx_mp4_¡ts_©om_t
 *è
©om_h—d”
;

2008 
	`ngx_mp4_£t_©om_Çme
(
¡ts_©om
, 's', 't', 't', 's');

2010 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡ts_©om_t
è> 
©om_d©a_size
) {

2011 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2012 "\"%s\" mp4 s‰ ©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2013  
NGX_ERROR
;

2016 
’Œ›s
 = 
	`ngx_mp4_g‘_32v®ue
(
¡ts_©om
->entries);

2018 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2019 "mp4ime-to-§m¶’Œ›s:%uD", 
’Œ›s
);

2021 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡ts_©om_t
)

2022 + 
’Œ›s
 * (
ngx_mp4_¡ts_’Œy_t
è> 
©om_d©a_size
)

2024 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2025 "\"%s\" mp4 s‰ ©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2026  
NGX_ERROR
;

2029 
©om_bË
 = 
©om_h—d”
 + (
ngx_mp4_¡ts_©om_t
);

2030 
©om_’d
 = 
©om_bË
 + 
’Œ›s
 * (
ngx_mp4_¡ts_’Œy_t
);

2032 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

2033 
Œak
->
time_to_§m¶e_’Œ›s
 = 
’Œ›s
;

2035 
©om
 = &
Œak
->
¡ts_©om_buf
;

2036 
©om
->
‹mpÜ¬y
 = 1;

2037 
©om
->
pos
 = 
©om_h—d”
;

2038 
©om
->
Ï¡
 = 
©om_bË
;

2040 
d©a
 = &
Œak
->
¡ts_d©a_buf
;

2041 
d©a
->
‹mpÜ¬y
 = 1;

2042 
d©a
->
pos
 = 
©om_bË
;

2043 
d©a
->
Ï¡
 = 
©om_’d
;

2045 
Œak
->
out
[
NGX_HTTP_MP4_STTS_ATOM
].
buf
 = 
©om
;

2046 
Œak
->
out
[
NGX_HTTP_MP4_STTS_DATA
].
buf
 = 
d©a
;

2048 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

2050  
NGX_OK
;

2051 
	}
}

2054 
ngx_št_t


2055 
	$ngx_h‰p_mp4_upd©e_¡ts_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

2056 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

2058 
size_t
 
©om_size
;

2059 
ngx_buf_t
 *
©om
, *
d©a
;

2060 
ngx_mp4_¡ts_©om_t
 *
¡ts_©om
;

2067 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2070 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STTS_DATA
].
buf
;

2072 ià(
d©a
 =ð
NULL
) {

2073 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2075 
mp4
->
fže
.
Çme
.
d©a
);

2076  
NGX_ERROR
;

2079 ià(
	`ngx_h‰p_mp4_üÝ_¡ts_d©a
(
mp4
, 
Œak
, 1è!ð
NGX_OK
) {

2080  
NGX_ERROR
;

2083 ià(
	`ngx_h‰p_mp4_üÝ_¡ts_d©a
(
mp4
, 
Œak
, 0è!ð
NGX_OK
) {

2084  
NGX_ERROR
;

2087 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2088 "time-to-§m¶’Œ›s:%uD", 
Œak
->
time_to_§m¶e_’Œ›s
);

2090 
©om_size
 = (
ngx_mp4_¡ts_©om_t
è+ (
d©a
->
Ï¡
 - d©a->
pos
);

2091 
Œak
->
size
 +ð
©om_size
;

2093 
©om
 = 
Œak
->
out
[
NGX_HTTP_MP4_STTS_ATOM
].
buf
;

2094 
¡ts_©om
 = (
ngx_mp4_¡ts_©om_t
 *è
©om
->
pos
;

2095 
	`ngx_mp4_£t_32v®ue
(
¡ts_©om
->
size
, 
©om_size
);

2096 
	`ngx_mp4_£t_32v®ue
(
¡ts_©om
->
’Œ›s
, 
Œak
->
time_to_§m¶e_’Œ›s
);

2098  
NGX_OK
;

2099 
	}
}

2102 
ngx_št_t


2103 
	$ngx_h‰p_mp4_üÝ_¡ts_d©a
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

2104 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
ngx_ušt_t
 
¡¬t
)

2106 
ušt32_t
 
couÁ
, 
du¿tiÚ
, 
»¡
;

2107 
ušt64_t
 
¡¬t_time
;

2108 
ngx_buf_t
 *
d©a
;

2109 
ngx_ušt_t
 
¡¬t_§m¶e
, 
’Œ›s
, 
¡¬t_£c
;

2110 
ngx_mp4_¡ts_’Œy_t
 *
’Œy
, *
’d
;

2112 ià(
¡¬t
) {

2113 
¡¬t_£c
 = 
mp4
->
¡¬t
;

2115 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2116 "mp4 s‰ üÝ s¹_time:%ui", 
¡¬t_£c
);

2118 } ià(
mp4
->
Ëngth
) {

2119 
¡¬t_£c
 = 
mp4
->
Ëngth
;

2121 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2122 "mp4 s‰ üÝƒnd_time:%ui", 
¡¬t_£c
);

2125  
NGX_OK
;

2128 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STTS_DATA
].
buf
;

2130 
¡¬t_time
 = (
ušt64_t
è
¡¬t_£c
 * 
Œak
->
timesÿË
 / 1000;

2132 
’Œ›s
 = 
Œak
->
time_to_§m¶e_’Œ›s
;

2133 
¡¬t_§m¶e
 = 0;

2134 
’Œy
 = (
ngx_mp4_¡ts_’Œy_t
 *è
d©a
->
pos
;

2135 
’d
 = (
ngx_mp4_¡ts_’Œy_t
 *è
d©a
->
Ï¡
;

2137 
’Œy
 < 
’d
) {

2138 
couÁ
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->count);

2139 
du¿tiÚ
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->duration);

2141 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2143 
¡¬t_time
, 
couÁ
, 
du¿tiÚ
);

2145 ià(
¡¬t_time
 < (
ušt64_t
è
couÁ
 * 
du¿tiÚ
) {

2146 
¡¬t_§m¶e
 +ð(
ngx_ušt_t
è(
¡¬t_time
 / 
du¿tiÚ
);

2147 
»¡
 = (
ušt32_t
è(
¡¬t_time
 / 
du¿tiÚ
);

2148 
found
;

2151 
¡¬t_§m¶e
 +ð
couÁ
;

2152 
¡¬t_time
 -ð
couÁ
 * 
du¿tiÚ
;

2153 
’Œ›s
--;

2154 
’Œy
++;

2157 ià(
¡¬t
) {

2158 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2160 
mp4
->
fže
.
Çme
.
d©a
);

2162  
NGX_ERROR
;

2165 
Œak
->
’d_§m¶e
 =¿k->
¡¬t_§m¶e
 + start_sample;

2167 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2168 "’d_§m¶e:%ui", 
Œak
->
’d_§m¶e
);

2170  
NGX_OK
;

2173 
found
:

2175 ià(
¡¬t
) {

2176 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
couÁ
, couÁ - 
»¡
);

2177 
d©a
->
pos
 = (
u_ch¬
 *è
’Œy
;

2178 
Œak
->
time_to_§m¶e_’Œ›s
 = 
’Œ›s
;

2179 
Œak
->
¡¬t_§m¶e
 = start_sample;

2181 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2183 
Œak
->
¡¬t_§m¶e
, 
couÁ
 - 
»¡
);

2186 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
couÁ
, 
»¡
);

2187 
d©a
->
Ï¡
 = (
u_ch¬
 *è(
’Œy
 + 1);

2188 
Œak
->
time_to_§m¶e_’Œ›s
 -ð
’Œ›s
 - 1;

2189 
Œak
->
’d_§m¶e
 =¿k->
¡¬t_§m¶e
 + start_sample;

2191 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2193 
Œak
->
’d_§m¶e
, 
»¡
);

2196  
NGX_OK
;

2197 
	}
}

2201 
u_ch¬
 
	msize
[4];

2202 
u_ch¬
 
	mÇme
[4];

2203 
u_ch¬
 
	mv”siÚ
[1];

2204 
u_ch¬
 
	mæags
[3];

2205 
u_ch¬
 
	m’Œ›s
[4];

2206 } 
	tngx_h‰p_mp4_¡ss_©om_t
;

2209 
ngx_št_t


2210 
	$ngx_h‰p_mp4_»ad_¡ss_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

2212 
u_ch¬
 *
©om_h—d”
, *
©om_bË
, *
©om_’d
;

2213 
ušt32_t
 
’Œ›s
;

2214 
ngx_buf_t
 *
©om
, *
d©a
;

2215 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

2216 
ngx_h‰p_mp4_¡ss_©om_t
 *
¡ss_©om
;

2220 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 stss‡tom");

2222 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

2223 
¡ss_©om
 = (
ngx_h‰p_mp4_¡ss_©om_t
 *è
©om_h—d”
;

2224 
	`ngx_mp4_£t_©om_Çme
(
¡ss_©om
, 's', 't', 's', 's');

2226 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_h‰p_mp4_¡ss_©om_t
è> 
©om_d©a_size
) {

2227 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2228 "\"%s\" mp4 sts ©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2229  
NGX_ERROR
;

2232 
’Œ›s
 = 
	`ngx_mp4_g‘_32v®ue
(
¡ss_©om
->entries);

2234 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2235 "synø§m¶’Œ›s:%uD", 
’Œ›s
);

2237 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

2238 
Œak
->
sync_§m¶es_’Œ›s
 = 
’Œ›s
;

2240 
©om_bË
 = 
©om_h—d”
 + (
ngx_h‰p_mp4_¡ss_©om_t
);

2242 
©om
 = &
Œak
->
¡ss_©om_buf
;

2243 
©om
->
‹mpÜ¬y
 = 1;

2244 
©om
->
pos
 = 
©om_h—d”
;

2245 
©om
->
Ï¡
 = 
©om_bË
;

2247 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_h‰p_mp4_¡ss_©om_t
)

2248 + 
’Œ›s
 * (
ušt32_t
è> 
©om_d©a_size
)

2250 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2251 "\"%s\" mp4 sts ©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2252  
NGX_ERROR
;

2255 
©om_’d
 = 
©om_bË
 + 
’Œ›s
 * (
ušt32_t
);

2257 
d©a
 = &
Œak
->
¡ss_d©a_buf
;

2258 
d©a
->
‹mpÜ¬y
 = 1;

2259 
d©a
->
pos
 = 
©om_bË
;

2260 
d©a
->
Ï¡
 = 
©om_’d
;

2262 
Œak
->
out
[
NGX_HTTP_MP4_STSS_ATOM
].
buf
 = 
©om
;

2263 
Œak
->
out
[
NGX_HTTP_MP4_STSS_DATA
].
buf
 = 
d©a
;

2265 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

2267  
NGX_OK
;

2268 
	}
}

2271 
ngx_št_t


2272 
	$ngx_h‰p_mp4_upd©e_¡ss_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

2273 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

2275 
size_t
 
©om_size
;

2276 
ušt32_t
 
§m¶e
, 
¡¬t_§m¶e
, *
’Œy
, *
’d
;

2277 
ngx_buf_t
 *
©om
, *
d©a
;

2278 
ngx_h‰p_mp4_¡ss_©om_t
 *
¡ss_©om
;

2286 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2289 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSS_DATA
].
buf
;

2291 ià(
d©a
 =ð
NULL
) {

2292  
NGX_OK
;

2295 
	`ngx_h‰p_mp4_üÝ_¡ss_d©a
(
mp4
, 
Œak
, 1);

2296 
	`ngx_h‰p_mp4_üÝ_¡ss_d©a
(
mp4
, 
Œak
, 0);

2298 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2299 "synø§m¶’Œ›s:%uD", 
Œak
->
sync_§m¶es_’Œ›s
);

2301 ià(
Œak
->
sync_§m¶es_’Œ›s
) {

2302 
’Œy
 = (
ušt32_t
 *è
d©a
->
pos
;

2303 
’d
 = (
ušt32_t
 *è
d©a
->
Ï¡
;

2305 
¡¬t_§m¶e
 = 
Œak
->start_sample;

2307 
’Œy
 < 
’d
) {

2308 
§m¶e
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
);

2309 
§m¶e
 -ð
¡¬t_§m¶e
;

2310 
	`ngx_mp4_£t_32v®ue
(
’Œy
, 
§m¶e
);

2311 
’Œy
++;

2315 
Œak
->
out
[
NGX_HTTP_MP4_STSS_DATA
].
buf
 = 
NULL
;

2318 
©om_size
 = (
ngx_h‰p_mp4_¡ss_©om_t
è+ (
d©a
->
Ï¡
 - d©a->
pos
);

2319 
Œak
->
size
 +ð
©om_size
;

2321 
©om
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSS_ATOM
].
buf
;

2322 
¡ss_©om
 = (
ngx_h‰p_mp4_¡ss_©om_t
 *è
©om
->
pos
;

2324 
	`ngx_mp4_£t_32v®ue
(
¡ss_©om
->
size
, 
©om_size
);

2325 
	`ngx_mp4_£t_32v®ue
(
¡ss_©om
->
’Œ›s
, 
Œak
->
sync_§m¶es_’Œ›s
);

2327  
NGX_OK
;

2328 
	}
}

2332 
	$ngx_h‰p_mp4_üÝ_¡ss_d©a
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

2333 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
ngx_ušt_t
 
¡¬t
)

2335 
ušt32_t
 
§m¶e
, 
¡¬t_§m¶e
, *
’Œy
, *
’d
;

2336 
ngx_buf_t
 *
d©a
;

2337 
ngx_ušt_t
 
’Œ›s
;

2341 ià(
¡¬t
) {

2342 
¡¬t_§m¶e
 = 
Œak
->start_sample + 1;

2344 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2345 "mp4 sts üÝ s¹_§m¶e:%uD", 
¡¬t_§m¶e
);

2347 } ià(
mp4
->
Ëngth
) {

2348 
¡¬t_§m¶e
 = 
Œak
->
’d_§m¶e
 + 1;

2350 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2351 "mp4 sts üÝƒnd_§m¶e:%uD", 
¡¬t_§m¶e
);

2357 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSS_DATA
].
buf
;

2359 
’Œ›s
 = 
Œak
->
sync_§m¶es_’Œ›s
;

2360 
’Œy
 = (
ušt32_t
 *è
d©a
->
pos
;

2361 
’d
 = (
ušt32_t
 *è
d©a
->
Ï¡
;

2363 
’Œy
 < 
’d
) {

2364 
§m¶e
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
);

2366 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2367 "sync:%uD", 
§m¶e
);

2369 ià(
§m¶e
 >ð
¡¬t_§m¶e
) {

2370 
found
;

2373 
’Œ›s
--;

2374 
’Œy
++;

2377 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2380 
found
:

2382 ià(
¡¬t
) {

2383 
d©a
->
pos
 = (
u_ch¬
 *è
’Œy
;

2384 
Œak
->
sync_§m¶es_’Œ›s
 = 
’Œ›s
;

2387 
d©a
->
Ï¡
 = (
u_ch¬
 *è
’Œy
;

2388 
Œak
->
sync_§m¶es_’Œ›s
 -ð
’Œ›s
;

2390 
	}
}

2394 
u_ch¬
 
	msize
[4];

2395 
u_ch¬
 
	mÇme
[4];

2396 
u_ch¬
 
	mv”siÚ
[1];

2397 
u_ch¬
 
	mæags
[3];

2398 
u_ch¬
 
	m’Œ›s
[4];

2399 } 
	tngx_mp4_ùts_©om_t
;

2402 
u_ch¬
 
	mcouÁ
[4];

2403 
u_ch¬
 
	moff£t
[4];

2404 } 
	tngx_mp4_ùts_’Œy_t
;

2407 
ngx_št_t


2408 
	$ngx_h‰p_mp4_»ad_ùts_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

2410 
u_ch¬
 *
©om_h—d”
, *
©om_bË
, *
©om_’d
;

2411 
ušt32_t
 
’Œ›s
;

2412 
ngx_buf_t
 *
©om
, *
d©a
;

2413 
ngx_mp4_ùts_©om_t
 *
ùts_©om
;

2414 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

2418 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 ctts‡tom");

2420 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

2421 
ùts_©om
 = (
ngx_mp4_ùts_©om_t
 *è
©om_h—d”
;

2422 
	`ngx_mp4_£t_©om_Çme
(
ùts_©om
, 'c', 't', 't', 's');

2424 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_ùts_©om_t
è> 
©om_d©a_size
) {

2425 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2426 "\"%s\" mp4 c‰ ©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2427  
NGX_ERROR
;

2430 
’Œ›s
 = 
	`ngx_mp4_g‘_32v®ue
(
ùts_©om
->entries);

2432 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2433 "compos™iÚ off£ˆ’Œ›s:%uD", 
’Œ›s
);

2435 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

2436 
Œak
->
compos™iÚ_off£t_’Œ›s
 = 
’Œ›s
;

2438 
©om_bË
 = 
©om_h—d”
 + (
ngx_mp4_ùts_©om_t
);

2440 
©om
 = &
Œak
->
ùts_©om_buf
;

2441 
©om
->
‹mpÜ¬y
 = 1;

2442 
©om
->
pos
 = 
©om_h—d”
;

2443 
©om
->
Ï¡
 = 
©om_bË
;

2445 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_ùts_©om_t
)

2446 + 
’Œ›s
 * (
ngx_mp4_ùts_’Œy_t
è> 
©om_d©a_size
)

2448 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2449 "\"%s\" mp4 c‰ ©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2450  
NGX_ERROR
;

2453 
©om_’d
 = 
©om_bË
 + 
’Œ›s
 * (
ngx_mp4_ùts_’Œy_t
);

2455 
d©a
 = &
Œak
->
ùts_d©a_buf
;

2456 
d©a
->
‹mpÜ¬y
 = 1;

2457 
d©a
->
pos
 = 
©om_bË
;

2458 
d©a
->
Ï¡
 = 
©om_’d
;

2460 
Œak
->
out
[
NGX_HTTP_MP4_CTTS_ATOM
].
buf
 = 
©om
;

2461 
Œak
->
out
[
NGX_HTTP_MP4_CTTS_DATA
].
buf
 = 
d©a
;

2463 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

2465  
NGX_OK
;

2466 
	}
}

2470 
	$ngx_h‰p_mp4_upd©e_ùts_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

2471 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

2473 
size_t
 
©om_size
;

2474 
ngx_buf_t
 *
©om
, *
d©a
;

2475 
ngx_mp4_ùts_©om_t
 *
ùts_©om
;

2483 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2486 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_CTTS_DATA
].
buf
;

2488 ià(
d©a
 =ð
NULL
) {

2492 
	`ngx_h‰p_mp4_üÝ_ùts_d©a
(
mp4
, 
Œak
, 1);

2493 
	`ngx_h‰p_mp4_üÝ_ùts_d©a
(
mp4
, 
Œak
, 0);

2495 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2497 
Œak
->
compos™iÚ_off£t_’Œ›s
);

2499 ià(
Œak
->
compos™iÚ_off£t_’Œ›s
 == 0) {

2500 
Œak
->
out
[
NGX_HTTP_MP4_CTTS_ATOM
].
buf
 = 
NULL
;

2501 
Œak
->
out
[
NGX_HTTP_MP4_CTTS_DATA
].
buf
 = 
NULL
;

2505 
©om_size
 = (
ngx_mp4_ùts_©om_t
è+ (
d©a
->
Ï¡
 - d©a->
pos
);

2506 
Œak
->
size
 +ð
©om_size
;

2508 
©om
 = 
Œak
->
out
[
NGX_HTTP_MP4_CTTS_ATOM
].
buf
;

2509 
ùts_©om
 = (
ngx_mp4_ùts_©om_t
 *è
©om
->
pos
;

2511 
	`ngx_mp4_£t_32v®ue
(
ùts_©om
->
size
, 
©om_size
);

2512 
	`ngx_mp4_£t_32v®ue
(
ùts_©om
->
’Œ›s
, 
Œak
->
compos™iÚ_off£t_’Œ›s
);

2515 
	}
}

2519 
	$ngx_h‰p_mp4_üÝ_ùts_d©a
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

2520 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
ngx_ušt_t
 
¡¬t
)

2522 
ušt32_t
 
couÁ
, 
¡¬t_§m¶e
, 
»¡
;

2523 
ngx_buf_t
 *
d©a
;

2524 
ngx_ušt_t
 
’Œ›s
;

2525 
ngx_mp4_ùts_’Œy_t
 *
’Œy
, *
’d
;

2529 ià(
¡¬t
) {

2530 
¡¬t_§m¶e
 = 
Œak
->start_sample + 1;

2532 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2533 "mp4 c‰ üÝ s¹_§m¶e:%uD", 
¡¬t_§m¶e
);

2535 } ià(
mp4
->
Ëngth
) {

2536 
¡¬t_§m¶e
 = 
Œak
->
’d_§m¶e
 -rak->start_sample + 1;

2538 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2539 "mp4 c‰ üÝƒnd_§m¶e:%uD", 
¡¬t_§m¶e
);

2545 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_CTTS_DATA
].
buf
;

2547 
’Œ›s
 = 
Œak
->
compos™iÚ_off£t_’Œ›s
;

2548 
’Œy
 = (
ngx_mp4_ùts_’Œy_t
 *è
d©a
->
pos
;

2549 
’d
 = (
ngx_mp4_ùts_’Œy_t
 *è
d©a
->
Ï¡
;

2551 
’Œy
 < 
’d
) {

2552 
couÁ
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->count);

2554 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2556 
¡¬t_§m¶e
, 
couÁ
, 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->
off£t
));

2558 ià(
¡¬t_§m¶e
 <ð
couÁ
) {

2559 
»¡
 = 
¡¬t_§m¶e
 - 1;

2560 
found
;

2563 
¡¬t_§m¶e
 -ð
couÁ
;

2564 
’Œ›s
--;

2565 
’Œy
++;

2568 ià(
¡¬t
) {

2569 
d©a
->
pos
 = (
u_ch¬
 *è
’d
;

2570 
Œak
->
compos™iÚ_off£t_’Œ›s
 = 0;

2575 
found
:

2577 ià(
¡¬t
) {

2578 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
couÁ
, couÁ - 
»¡
);

2579 
d©a
->
pos
 = (
u_ch¬
 *è
’Œy
;

2580 
Œak
->
compos™iÚ_off£t_’Œ›s
 = 
’Œ›s
;

2583 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
couÁ
, 
»¡
);

2584 
d©a
->
Ï¡
 = (
u_ch¬
 *è(
’Œy
 + 1);

2585 
Œak
->
compos™iÚ_off£t_’Œ›s
 -ð
’Œ›s
 - 1;

2587 
	}
}

2591 
u_ch¬
 
	msize
[4];

2592 
u_ch¬
 
	mÇme
[4];

2593 
u_ch¬
 
	mv”siÚ
[1];

2594 
u_ch¬
 
	mæags
[3];

2595 
u_ch¬
 
	m’Œ›s
[4];

2596 } 
	tngx_mp4_¡sc_©om_t
;

2599 
ngx_št_t


2600 
	$ngx_h‰p_mp4_»ad_¡sc_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

2602 
u_ch¬
 *
©om_h—d”
, *
©om_bË
, *
©om_’d
;

2603 
ušt32_t
 
’Œ›s
;

2604 
ngx_buf_t
 *
©om
, *
d©a
;

2605 
ngx_mp4_¡sc_©om_t
 *
¡sc_©om
;

2606 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

2610 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 stsc‡tom");

2612 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

2613 
¡sc_©om
 = (
ngx_mp4_¡sc_©om_t
 *è
©om_h—d”
;

2614 
	`ngx_mp4_£t_©om_Çme
(
¡sc_©om
, 's', 't', 's', 'c');

2616 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡sc_©om_t
è> 
©om_d©a_size
) {

2617 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2618 "\"%s\" mp4 stsø©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2619  
NGX_ERROR
;

2622 
’Œ›s
 = 
	`ngx_mp4_g‘_32v®ue
(
¡sc_©om
->entries);

2624 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2625 "§m¶e-to-chunkƒÁr›s:%uD", 
’Œ›s
);

2627 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡sc_©om_t
)

2628 + 
’Œ›s
 * (
ngx_mp4_¡sc_’Œy_t
è> 
©om_d©a_size
)

2630 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2631 "\"%s\" mp4 stsø©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2632  
NGX_ERROR
;

2635 
©om_bË
 = 
©om_h—d”
 + (
ngx_mp4_¡sc_©om_t
);

2636 
©om_’d
 = 
©om_bË
 + 
’Œ›s
 * (
ngx_mp4_¡sc_’Œy_t
);

2638 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

2639 
Œak
->
§m¶e_to_chunk_’Œ›s
 = 
’Œ›s
;

2641 
©om
 = &
Œak
->
¡sc_©om_buf
;

2642 
©om
->
‹mpÜ¬y
 = 1;

2643 
©om
->
pos
 = 
©om_h—d”
;

2644 
©om
->
Ï¡
 = 
©om_bË
;

2646 
d©a
 = &
Œak
->
¡sc_d©a_buf
;

2647 
d©a
->
‹mpÜ¬y
 = 1;

2648 
d©a
->
pos
 = 
©om_bË
;

2649 
d©a
->
Ï¡
 = 
©om_’d
;

2651 
Œak
->
out
[
NGX_HTTP_MP4_STSC_ATOM
].
buf
 = 
©om
;

2652 
Œak
->
out
[
NGX_HTTP_MP4_STSC_DATA
].
buf
 = 
d©a
;

2654 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

2656  
NGX_OK
;

2657 
	}
}

2660 
ngx_št_t


2661 
	$ngx_h‰p_mp4_upd©e_¡sc_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

2662 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

2664 
size_t
 
©om_size
;

2665 
ušt32_t
 
chunk
;

2666 
ngx_buf_t
 *
©om
, *
d©a
;

2667 
ngx_mp4_¡sc_©om_t
 *
¡sc_©om
;

2668 
ngx_mp4_¡sc_’Œy_t
 *
’Œy
, *
’d
;

2676 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2679 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSC_DATA
].
buf
;

2681 ià(
d©a
 =ð
NULL
) {

2682 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2684 
mp4
->
fže
.
Çme
.
d©a
);

2685  
NGX_ERROR
;

2688 ià(
Œak
->
§m¶e_to_chunk_’Œ›s
 == 0) {

2689 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2691 
mp4
->
fže
.
Çme
.
d©a
);

2692  
NGX_ERROR
;

2695 ià(
	`ngx_h‰p_mp4_üÝ_¡sc_d©a
(
mp4
, 
Œak
, 1è!ð
NGX_OK
) {

2696  
NGX_ERROR
;

2699 ià(
	`ngx_h‰p_mp4_üÝ_¡sc_d©a
(
mp4
, 
Œak
, 0è!ð
NGX_OK
) {

2700  
NGX_ERROR
;

2703 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2705 
Œak
->
§m¶e_to_chunk_’Œ›s
);

2707 
’Œy
 = (
ngx_mp4_¡sc_’Œy_t
 *è
d©a
->
pos
;

2708 
’d
 = (
ngx_mp4_¡sc_’Œy_t
 *è
d©a
->
Ï¡
;

2710 
’Œy
 < 
’d
) {

2711 
chunk
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->chunk);

2712 
chunk
 -ð
Œak
->
¡¬t_chunk
;

2713 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
chunk
, chunk);

2714 
’Œy
++;

2717 
©om_size
 = (
ngx_mp4_¡sc_©om_t
)

2718 + 
Œak
->
§m¶e_to_chunk_’Œ›s
 * (
ngx_mp4_¡sc_’Œy_t
);

2720 
Œak
->
size
 +ð
©om_size
;

2722 
©om
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSC_ATOM
].
buf
;

2723 
¡sc_©om
 = (
ngx_mp4_¡sc_©om_t
 *è
©om
->
pos
;

2725 
	`ngx_mp4_£t_32v®ue
(
¡sc_©om
->
size
, 
©om_size
);

2726 
	`ngx_mp4_£t_32v®ue
(
¡sc_©om
->
’Œ›s
, 
Œak
->
§m¶e_to_chunk_’Œ›s
);

2728  
NGX_OK
;

2729 
	}
}

2732 
ngx_št_t


2733 
	$ngx_h‰p_mp4_üÝ_¡sc_d©a
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

2734 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
ngx_ušt_t
 
¡¬t
)

2736 
ušt32_t
 
¡¬t_§m¶e
, 
chunk
, 
§m¶es
, 
id
, 
Ãxt_chunk
, 
n
,

2737 
´ev_§m¶es
;

2738 
ngx_buf_t
 *
d©a
, *
buf
;

2739 
ngx_ušt_t
 
’Œ›s
, 
rg‘_chunk
, 
chunk_§m¶es
;

2740 
ngx_mp4_¡sc_’Œy_t
 *
’Œy
, *
’d
, *
fœ¡
;

2742 
’Œ›s
 = 
Œak
->
§m¶e_to_chunk_’Œ›s
 - 1;

2744 ià(
¡¬t
) {

2745 
¡¬t_§m¶e
 = (
ušt32_t
è
Œak
->start_sample;

2747 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2748 "mp4 stsøüÝ s¹_§m¶e:%uD", 
¡¬t_§m¶e
);

2750 } ià(
mp4
->
Ëngth
) {

2751 
¡¬t_§m¶e
 = (
ušt32_t
è(
Œak
->
’d_§m¶e
 -rak->start_sample);

2752 
§m¶es
 = 0;

2754 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSC_START
].
buf
;

2756 ià(
d©a
) {

2757 
’Œy
 = (
ngx_mp4_¡sc_’Œy_t
 *è
d©a
->
pos
;

2758 
§m¶es
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->samples);

2759 
’Œ›s
--;

2761 ià(
§m¶es
 > 
¡¬t_§m¶e
) {

2762 
§m¶es
 = 
¡¬t_§m¶e
;

2763 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
§m¶es
, samples);

2766 
¡¬t_§m¶e
 -ð
§m¶es
;

2769 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2771 
¡¬t_§m¶e
, 
§m¶es
);

2774  
NGX_OK
;

2777 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSC_DATA
].
buf
;

2779 
’Œy
 = (
ngx_mp4_¡sc_’Œy_t
 *è
d©a
->
pos
;

2780 
’d
 = (
ngx_mp4_¡sc_’Œy_t
 *è
d©a
->
Ï¡
;

2782 
chunk
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->chunk);

2783 
§m¶es
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->samples);

2784 
id
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->id);

2785 
´ev_§m¶es
 = 0;

2786 
’Œy
++;

2788 
’Œy
 < 
’d
) {

2790 
Ãxt_chunk
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->
chunk
);

2792 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2795 
¡¬t_§m¶e
, 
chunk
, 
Ãxt_chunk
 - chunk, 
§m¶es
, 
id
);

2797 
n
 = (
Ãxt_chunk
 - 
chunk
è* 
§m¶es
;

2799 ià(
¡¬t_§m¶e
 < 
n
) {

2800 
found
;

2803 
¡¬t_§m¶e
 -ð
n
;

2805 
´ev_§m¶es
 = 
§m¶es
;

2806 
chunk
 = 
Ãxt_chunk
;

2807 
§m¶es
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->samples);

2808 
id
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
->id);

2809 
’Œ›s
--;

2810 
’Œy
++;

2813 
Ãxt_chunk
 = 
Œak
->
chunks
 + 1;

2815 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2817 
¡¬t_§m¶e
, 
chunk
, 
Ãxt_chunk
 - chunk, 
§m¶es
);

2819 
n
 = (
Ãxt_chunk
 - 
chunk
è* 
§m¶es
;

2821 ià(
¡¬t_§m¶e
 > 
n
) {

2822 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2824 
¡¬t
 ? "¡¬t" : "’d", 
mp4
->
fže
.
Çme
.
d©a
);

2825  
NGX_ERROR
;

2828 
found
:

2830 
’Œ›s
++;

2831 
’Œy
--;

2833 ià(
§m¶es
 == 0) {

2834 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2836 
mp4
->
fže
.
Çme
.
d©a
);

2837  
NGX_ERROR
;

2840 
rg‘_chunk
 = 
chunk
 - 1;

2841 
rg‘_chunk
 +ð
¡¬t_§m¶e
 / 
§m¶es
;

2842 
chunk_§m¶es
 = 
¡¬t_§m¶e
 % 
§m¶es
;

2844 ià(
¡¬t
) {

2845 
d©a
->
pos
 = (
u_ch¬
 *è
’Œy
;

2847 
Œak
->
§m¶e_to_chunk_’Œ›s
 = 
’Œ›s
;

2848 
Œak
->
¡¬t_chunk
 = 
rg‘_chunk
;

2849 
Œak
->
¡¬t_chunk_§m¶es
 = 
chunk_§m¶es
;

2851 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
chunk
, 
Œak
->
¡¬t_chunk
 + 1);

2853 
§m¶es
 -ð
chunk_§m¶es
;

2855 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2857 
Œak
->
¡¬t_chunk
,¿k->
¡¬t_chunk_§m¶es
);

2860 ià(
¡¬t_§m¶e
) {

2861 
d©a
->
Ï¡
 = (
u_ch¬
 *è(
’Œy
 + 1);

2862 
Œak
->
§m¶e_to_chunk_’Œ›s
 -ð
’Œ›s
 - 1;

2863 
Œak
->
’d_chunk_§m¶es
 = 
§m¶es
;

2866 
d©a
->
Ï¡
 = (
u_ch¬
 *è
’Œy
;

2867 
Œak
->
§m¶e_to_chunk_’Œ›s
 -ð
’Œ›s
;

2868 
Œak
->
’d_chunk_§m¶es
 = 
´ev_§m¶es
;

2871 ià(
chunk_§m¶es
) {

2872 
Œak
->
’d_chunk
 = 
rg‘_chunk
 + 1;

2873 
Œak
->
’d_chunk_§m¶es
 = 
chunk_§m¶es
;

2876 
Œak
->
’d_chunk
 = 
rg‘_chunk
;

2879 
§m¶es
 = 
chunk_§m¶es
;

2880 
Ãxt_chunk
 = 
chunk
 + 1;

2882 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2884 
Œak
->
’d_chunk
,¿k->
’d_chunk_§m¶es
);

2887 ià(
chunk_§m¶es
 && 
Ãxt_chunk
 - 
rg‘_chunk
 == 2) {

2889 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
§m¶es
, samples);

2891 } ià(
chunk_§m¶es
 && 
¡¬t
) {

2893 
fœ¡
 = &
Œak
->
¡sc_¡¬t_chunk_’Œy
;

2894 
	`ngx_mp4_£t_32v®ue
(
fœ¡
->
chunk
, 1);

2895 
	`ngx_mp4_£t_32v®ue
(
fœ¡
->
§m¶es
, samples);

2896 
	`ngx_mp4_£t_32v®ue
(
fœ¡
->
id
, id);

2898 
buf
 = &
Œak
->
¡sc_¡¬t_chunk_buf
;

2899 
buf
->
‹mpÜ¬y
 = 1;

2900 
buf
->
pos
 = (
u_ch¬
 *è
fœ¡
;

2901 
buf
->
Ï¡
 = (
u_ch¬
 *è
fœ¡
 + (
ngx_mp4_¡sc_’Œy_t
);

2903 
Œak
->
out
[
NGX_HTTP_MP4_STSC_START
].
buf
 = buf;

2905 
	`ngx_mp4_£t_32v®ue
(
’Œy
->
chunk
, 
Œak
->
¡¬t_chunk
 + 2);

2907 
Œak
->
§m¶e_to_chunk_’Œ›s
++;

2909 } ià(
chunk_§m¶es
) {

2911 
fœ¡
 = &
Œak
->
¡sc_’d_chunk_’Œy
;

2912 
	`ngx_mp4_£t_32v®ue
(
fœ¡
->
chunk
, 
Œak
->
’d_chunk
 -¿k->
¡¬t_chunk
);

2913 
	`ngx_mp4_£t_32v®ue
(
fœ¡
->
§m¶es
, samples);

2914 
	`ngx_mp4_£t_32v®ue
(
fœ¡
->
id
, id);

2916 
buf
 = &
Œak
->
¡sc_’d_chunk_buf
;

2917 
buf
->
‹mpÜ¬y
 = 1;

2918 
buf
->
pos
 = (
u_ch¬
 *è
fœ¡
;

2919 
buf
->
Ï¡
 = (
u_ch¬
 *è
fœ¡
 + (
ngx_mp4_¡sc_’Œy_t
);

2921 
Œak
->
out
[
NGX_HTTP_MP4_STSC_END
].
buf
 = buf;

2923 
Œak
->
§m¶e_to_chunk_’Œ›s
++;

2926  
NGX_OK
;

2927 
	}
}

2931 
u_ch¬
 
	msize
[4];

2932 
u_ch¬
 
	mÇme
[4];

2933 
u_ch¬
 
	mv”siÚ
[1];

2934 
u_ch¬
 
	mæags
[3];

2935 
u_ch¬
 
	munifÜm_size
[4];

2936 
u_ch¬
 
	m’Œ›s
[4];

2937 } 
	tngx_mp4_¡sz_©om_t
;

2940 
ngx_št_t


2941 
	$ngx_h‰p_mp4_»ad_¡sz_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

2943 
u_ch¬
 *
©om_h—d”
, *
©om_bË
, *
©om_’d
;

2944 
size_t
 
©om_size
;

2945 
ušt32_t
 
’Œ›s
, 
size
;

2946 
ngx_buf_t
 *
©om
, *
d©a
;

2947 
ngx_mp4_¡sz_©om_t
 *
¡sz_©om
;

2948 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

2952 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 stsz‡tom");

2954 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

2955 
¡sz_©om
 = (
ngx_mp4_¡sz_©om_t
 *è
©om_h—d”
;

2956 
	`ngx_mp4_£t_©om_Çme
(
¡sz_©om
, 's', 't', 's', 'z');

2958 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡sz_©om_t
è> 
©om_d©a_size
) {

2959 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2960 "\"%s\" mp4 stsz‡tomoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

2961  
NGX_ERROR
;

2964 
size
 = 
	`ngx_mp4_g‘_32v®ue
(
¡sz_©om
->
unifÜm_size
);

2965 
’Œ›s
 = 
	`ngx_mp4_g‘_32v®ue
(
¡sz_©om
->entries);

2967 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

2968 "§m¶unifÜm size:%uD,ƒÁr›s:%uD", 
size
, 
’Œ›s
);

2970 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

2971 
Œak
->
§m¶e_sizes_’Œ›s
 = 
’Œ›s
;

2973 
©om_bË
 = 
©om_h—d”
 + (
ngx_mp4_¡sz_©om_t
);

2975 
©om
 = &
Œak
->
¡sz_©om_buf
;

2976 
©om
->
‹mpÜ¬y
 = 1;

2977 
©om
->
pos
 = 
©om_h—d”
;

2978 
©om
->
Ï¡
 = 
©om_bË
;

2980 
Œak
->
out
[
NGX_HTTP_MP4_STSZ_ATOM
].
buf
 = 
©om
;

2982 ià(
size
 == 0) {

2983 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡sz_©om_t
)

2984 + 
’Œ›s
 * (
ušt32_t
è> 
©om_d©a_size
)

2986 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

2988 
mp4
->
fže
.
Çme
.
d©a
);

2989  
NGX_ERROR
;

2992 
©om_’d
 = 
©om_bË
 + 
’Œ›s
 * (
ušt32_t
);

2994 
d©a
 = &
Œak
->
¡sz_d©a_buf
;

2995 
d©a
->
‹mpÜ¬y
 = 1;

2996 
d©a
->
pos
 = 
©om_bË
;

2997 
d©a
->
Ï¡
 = 
©om_’d
;

2999 
Œak
->
out
[
NGX_HTTP_MP4_STSZ_DATA
].
buf
 = 
d©a
;

3004 
©om_size
 = (
ngx_mp4_©om_h—d”_t
è+ (
size_t
è
©om_d©a_size
;

3005 
	`ngx_mp4_£t_32v®ue
(
©om_h—d”
, 
©om_size
);

3006 
Œak
->
size
 +ð
©om_size
;

3009 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

3011  
NGX_OK
;

3012 
	}
}

3015 
ngx_št_t


3016 
	$ngx_h‰p_mp4_upd©e_¡sz_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

3017 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

3019 
size_t
 
©om_size
;

3020 
ušt32_t
 *
pos
, *
’d
, 
’Œ›s
;

3021 
ngx_buf_t
 *
©om
, *
d©a
;

3022 
ngx_mp4_¡sz_©om_t
 *
¡sz_©om
;

3030 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3033 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSZ_DATA
].
buf
;

3035 ià(
d©a
) {

3036 
’Œ›s
 = 
Œak
->
§m¶e_sizes_’Œ›s
;

3038 ià(
Œak
->
¡¬t_§m¶e
 > 
’Œ›s
) {

3039 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3041 
mp4
->
fže
.
Çme
.
d©a
);

3042  
NGX_ERROR
;

3045 
’Œ›s
 -ð
Œak
->
¡¬t_§m¶e
;

3046 
d©a
->
pos
 +ð
Œak
->
¡¬t_§m¶e
 * (
ušt32_t
);

3047 
’d
 = (
ušt32_t
 *è
d©a
->
pos
;

3049 
pos
 = 
’d
 - 
Œak
->
¡¬t_chunk_§m¶es
;…os <ƒnd;…os++) {

3050 
Œak
->
¡¬t_chunk_§m¶es_size
 +ð
	`ngx_mp4_g‘_32v®ue
(
pos
);

3053 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3055 
Œak
->
¡¬t_chunk_§m¶es_size
);

3057 ià(
mp4
->
Ëngth
) {

3058 ià(
Œak
->
’d_§m¶e
 -¿k->
¡¬t_§m¶e
 > 
’Œ›s
) {

3059 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3061 
mp4
->
fže
.
Çme
.
d©a
);

3062  
NGX_ERROR
;

3065 
’Œ›s
 = 
Œak
->
’d_§m¶e
 -¿k->
¡¬t_§m¶e
;

3066 
d©a
->
Ï¡
 = d©a->
pos
 + 
’Œ›s
 * (
ušt32_t
);

3067 
’d
 = (
ušt32_t
 *è
d©a
->
Ï¡
;

3069 
pos
 = 
’d
 - 
Œak
->
’d_chunk_§m¶es
;…os <ƒnd;…os++) {

3070 
Œak
->
’d_chunk_§m¶es_size
 +ð
	`ngx_mp4_g‘_32v®ue
(
pos
);

3073 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3075 
Œak
->
’d_chunk_§m¶es_size
);

3078 
©om_size
 = (
ngx_mp4_¡sz_©om_t
è+ (
d©a
->
Ï¡
 - d©a->
pos
);

3079 
Œak
->
size
 +ð
©om_size
;

3081 
©om
 = 
Œak
->
out
[
NGX_HTTP_MP4_STSZ_ATOM
].
buf
;

3082 
¡sz_©om
 = (
ngx_mp4_¡sz_©om_t
 *è
©om
->
pos
;

3084 
	`ngx_mp4_£t_32v®ue
(
¡sz_©om
->
size
, 
©om_size
);

3085 
	`ngx_mp4_£t_32v®ue
(
¡sz_©om
->
’Œ›s
,ƒntries);

3088  
NGX_OK
;

3089 
	}
}

3093 
u_ch¬
 
	msize
[4];

3094 
u_ch¬
 
	mÇme
[4];

3095 
u_ch¬
 
	mv”siÚ
[1];

3096 
u_ch¬
 
	mæags
[3];

3097 
u_ch¬
 
	m’Œ›s
[4];

3098 } 
	tngx_mp4_¡co_©om_t
;

3101 
ngx_št_t


3102 
	$ngx_h‰p_mp4_»ad_¡co_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

3104 
u_ch¬
 *
©om_h—d”
, *
©om_bË
, *
©om_’d
;

3105 
ušt32_t
 
’Œ›s
;

3106 
ngx_buf_t
 *
©om
, *
d©a
;

3107 
ngx_mp4_¡co_©om_t
 *
¡co_©om
;

3108 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

3112 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 stco‡tom");

3114 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

3115 
¡co_©om
 = (
ngx_mp4_¡co_©om_t
 *è
©om_h—d”
;

3116 
	`ngx_mp4_£t_©om_Çme
(
¡co_©om
, 's', 't', 'c', 'o');

3118 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡co_©om_t
è> 
©om_d©a_size
) {

3119 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3120 "\"%s\" mp4 stcØ©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

3121  
NGX_ERROR
;

3124 
’Œ›s
 = 
	`ngx_mp4_g‘_32v®ue
(
¡co_©om
->entries);

3126 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "chunks:%uD", 
’Œ›s
);

3128 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_¡co_©om_t
)

3129 + 
’Œ›s
 * (
ušt32_t
è> 
©om_d©a_size
)

3131 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3132 "\"%s\" mp4 stcØ©omoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

3133  
NGX_ERROR
;

3136 
©om_bË
 = 
©om_h—d”
 + (
ngx_mp4_¡co_©om_t
);

3137 
©om_’d
 = 
©om_bË
 + 
’Œ›s
 * (
ušt32_t
);

3139 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

3140 
Œak
->
chunks
 = 
’Œ›s
;

3142 
©om
 = &
Œak
->
¡co_©om_buf
;

3143 
©om
->
‹mpÜ¬y
 = 1;

3144 
©om
->
pos
 = 
©om_h—d”
;

3145 
©om
->
Ï¡
 = 
©om_bË
;

3147 
d©a
 = &
Œak
->
¡co_d©a_buf
;

3148 
d©a
->
‹mpÜ¬y
 = 1;

3149 
d©a
->
pos
 = 
©om_bË
;

3150 
d©a
->
Ï¡
 = 
©om_’d
;

3152 
Œak
->
out
[
NGX_HTTP_MP4_STCO_ATOM
].
buf
 = 
©om
;

3153 
Œak
->
out
[
NGX_HTTP_MP4_STCO_DATA
].
buf
 = 
d©a
;

3155 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

3157  
NGX_OK
;

3158 
	}
}

3161 
ngx_št_t


3162 
	$ngx_h‰p_mp4_upd©e_¡co_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

3163 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

3165 
size_t
 
©om_size
;

3166 
ušt32_t
 
’Œ›s
;

3167 
ngx_buf_t
 *
©om
, *
d©a
;

3168 
ngx_mp4_¡co_©om_t
 *
¡co_©om
;

3176 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3179 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STCO_DATA
].
buf
;

3181 ià(
d©a
 =ð
NULL
) {

3182 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3184 
mp4
->
fže
.
Çme
.
d©a
);

3185  
NGX_ERROR
;

3188 ià(
Œak
->
¡¬t_chunk
 >¿k->
chunks
) {

3189 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3191 
mp4
->
fže
.
Çme
.
d©a
);

3192  
NGX_ERROR
;

3195 
d©a
->
pos
 +ð
Œak
->
¡¬t_chunk
 * (
ušt32_t
);

3197 
Œak
->
¡¬t_off£t
 = 
	`ngx_mp4_g‘_32v®ue
(
d©a
->
pos
);

3198 
Œak
->
¡¬t_off£t
 +ðŒak->
¡¬t_chunk_§m¶es_size
;

3199 
	`ngx_mp4_£t_32v®ue
(
d©a
->
pos
, 
Œak
->
¡¬t_off£t
);

3201 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3202 "¡¬ˆchunk off£t:%O", 
Œak
->
¡¬t_off£t
);

3204 ià(
mp4
->
Ëngth
) {

3206 ià(
Œak
->
’d_chunk
 >¿k->
chunks
) {

3207 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3209 
mp4
->
fže
.
Çme
.
d©a
);

3210  
NGX_ERROR
;

3213 
’Œ›s
 = 
Œak
->
’d_chunk
 -¿k->
¡¬t_chunk
;

3214 
d©a
->
Ï¡
 = d©a->
pos
 + 
’Œ›s
 * (
ušt32_t
);

3216 ià(
’Œ›s
) {

3217 
Œak
->
’d_off£t
 =

3218 
	`ngx_mp4_g‘_32v®ue
(
d©a
->
Ï¡
 - (
ušt32_t
));

3219 
Œak
->
’d_off£t
 +ðŒak->
’d_chunk_§m¶es_size
;

3221 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3222 "’d chunk off£t:%O", 
Œak
->
’d_off£t
);

3226 
’Œ›s
 = 
Œak
->
chunks
 -¿k->
¡¬t_chunk
;

3227 
Œak
->
’d_off£t
 = 
mp4
->
md©_d©a
.
buf
->
fže_Ï¡
;

3230 ià(
’Œ›s
 == 0) {

3231 
Œak
->
¡¬t_off£t
 = 
mp4
->
’d
;

3232 
Œak
->
’d_off£t
 = 0;

3235 
©om_size
 = (
ngx_mp4_¡co_©om_t
è+ (
d©a
->
Ï¡
 - d©a->
pos
);

3236 
Œak
->
size
 +ð
©om_size
;

3238 
©om
 = 
Œak
->
out
[
NGX_HTTP_MP4_STCO_ATOM
].
buf
;

3239 
¡co_©om
 = (
ngx_mp4_¡co_©om_t
 *è
©om
->
pos
;

3241 
	`ngx_mp4_£t_32v®ue
(
¡co_©om
->
size
, 
©om_size
);

3242 
	`ngx_mp4_£t_32v®ue
(
¡co_©om
->
’Œ›s
,ƒntries);

3244  
NGX_OK
;

3245 
	}
}

3249 
	$ngx_h‰p_mp4_adju¡_¡co_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

3250 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
št32_t
 
adju¡m’t
)

3252 
ušt32_t
 
off£t
, *
’Œy
, *
’d
;

3253 
ngx_buf_t
 *
d©a
;

3260 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3263 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_STCO_DATA
].
buf
;

3264 
’Œy
 = (
ušt32_t
 *è
d©a
->
pos
;

3265 
’d
 = (
ušt32_t
 *è
d©a
->
Ï¡
;

3267 
’Œy
 < 
’d
) {

3268 
off£t
 = 
	`ngx_mp4_g‘_32v®ue
(
’Œy
);

3269 
off£t
 +ð
adju¡m’t
;

3270 
	`ngx_mp4_£t_32v®ue
(
’Œy
, 
off£t
);

3271 
’Œy
++;

3273 
	}
}

3277 
u_ch¬
 
	msize
[4];

3278 
u_ch¬
 
	mÇme
[4];

3279 
u_ch¬
 
	mv”siÚ
[1];

3280 
u_ch¬
 
	mæags
[3];

3281 
u_ch¬
 
	m’Œ›s
[4];

3282 } 
	tngx_mp4_co64_©om_t
;

3285 
ngx_št_t


3286 
	$ngx_h‰p_mp4_»ad_co64_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
, 
ušt64_t
 
©om_d©a_size
)

3288 
u_ch¬
 *
©om_h—d”
, *
©om_bË
, *
©om_’d
;

3289 
ušt32_t
 
’Œ›s
;

3290 
ngx_buf_t
 *
©om
, *
d©a
;

3291 
ngx_mp4_co64_©om_t
 *
co64_©om
;

3292 
ngx_h‰p_mp4_Œak_t
 *
Œak
;

3296 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "mp4 co64‡tom");

3298 
©om_h—d”
 = 
	`ngx_mp4_©om_h—d”
(
mp4
);

3299 
co64_©om
 = (
ngx_mp4_co64_©om_t
 *è
©om_h—d”
;

3300 
	`ngx_mp4_£t_©om_Çme
(
co64_©om
, 'c', 'o', '6', '4');

3302 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_co64_©om_t
è> 
©om_d©a_size
) {

3303 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3304 "\"%s\" mp4 co64‡tomoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

3305  
NGX_ERROR
;

3308 
’Œ›s
 = 
	`ngx_mp4_g‘_32v®ue
(
co64_©om
->entries);

3310 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0, "chunks:%uD", 
’Œ›s
);

3312 ià(
	`ngx_mp4_©om_d©a_size
(
ngx_mp4_co64_©om_t
)

3313 + 
’Œ›s
 * (
ušt64_t
è> 
©om_d©a_size
)

3315 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3316 "\"%s\" mp4 co64‡tomoØsm®l", 
mp4
->
fže
.
Çme
.
d©a
);

3317  
NGX_ERROR
;

3320 
©om_bË
 = 
©om_h—d”
 + (
ngx_mp4_co64_©om_t
);

3321 
©om_’d
 = 
©om_bË
 + 
’Œ›s
 * (
ušt64_t
);

3323 
Œak
 = 
	`ngx_mp4_Ï¡_Œak
(
mp4
);

3324 
Œak
->
chunks
 = 
’Œ›s
;

3326 
©om
 = &
Œak
->
co64_©om_buf
;

3327 
©om
->
‹mpÜ¬y
 = 1;

3328 
©om
->
pos
 = 
©om_h—d”
;

3329 
©om
->
Ï¡
 = 
©om_bË
;

3331 
d©a
 = &
Œak
->
co64_d©a_buf
;

3332 
d©a
->
‹mpÜ¬y
 = 1;

3333 
d©a
->
pos
 = 
©om_bË
;

3334 
d©a
->
Ï¡
 = 
©om_’d
;

3336 
Œak
->
out
[
NGX_HTTP_MP4_CO64_ATOM
].
buf
 = 
©om
;

3337 
Œak
->
out
[
NGX_HTTP_MP4_CO64_DATA
].
buf
 = 
d©a
;

3339 
	`ngx_mp4_©om_Ãxt
(
mp4
, 
©om_d©a_size
);

3341  
NGX_OK
;

3342 
	}
}

3345 
ngx_št_t


3346 
	$ngx_h‰p_mp4_upd©e_co64_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

3347 
ngx_h‰p_mp4_Œak_t
 *
Œak
)

3349 
size_t
 
©om_size
;

3350 
ušt64_t
 
’Œ›s
;

3351 
ngx_buf_t
 *
©om
, *
d©a
;

3352 
ngx_mp4_co64_©om_t
 *
co64_©om
;

3360 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3363 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_CO64_DATA
].
buf
;

3365 ià(
d©a
 =ð
NULL
) {

3366 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3368 
mp4
->
fže
.
Çme
.
d©a
);

3369  
NGX_ERROR
;

3372 ià(
Œak
->
¡¬t_chunk
 >¿k->
chunks
) {

3373 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3375 
mp4
->
fže
.
Çme
.
d©a
);

3376  
NGX_ERROR
;

3379 
d©a
->
pos
 +ð
Œak
->
¡¬t_chunk
 * (
ušt64_t
);

3381 
Œak
->
¡¬t_off£t
 = 
	`ngx_mp4_g‘_64v®ue
(
d©a
->
pos
);

3382 
Œak
->
¡¬t_off£t
 +ðŒak->
¡¬t_chunk_§m¶es_size
;

3383 
	`ngx_mp4_£t_64v®ue
(
d©a
->
pos
, 
Œak
->
¡¬t_off£t
);

3385 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3386 "¡¬ˆchunk off£t:%O", 
Œak
->
¡¬t_off£t
);

3388 ià(
mp4
->
Ëngth
) {

3390 ià(
Œak
->
’d_chunk
 >¿k->
chunks
) {

3391 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
mp4
->
fže
.
log
, 0,

3393 
mp4
->
fže
.
Çme
.
d©a
);

3394  
NGX_ERROR
;

3397 
’Œ›s
 = 
Œak
->
’d_chunk
 -¿k->
¡¬t_chunk
;

3398 
d©a
->
Ï¡
 = d©a->
pos
 + 
’Œ›s
 * (
ušt64_t
);

3400 ià(
’Œ›s
) {

3401 
Œak
->
’d_off£t
 =

3402 
	`ngx_mp4_g‘_64v®ue
(
d©a
->
Ï¡
 - (
ušt64_t
));

3403 
Œak
->
’d_off£t
 +ðŒak->
’d_chunk_§m¶es_size
;

3405 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3406 "’d chunk off£t:%O", 
Œak
->
’d_off£t
);

3410 
’Œ›s
 = 
Œak
->
chunks
 -¿k->
¡¬t_chunk
;

3411 
Œak
->
’d_off£t
 = 
mp4
->
md©_d©a
.
buf
->
fže_Ï¡
;

3414 ià(
’Œ›s
 == 0) {

3415 
Œak
->
¡¬t_off£t
 = 
mp4
->
’d
;

3416 
Œak
->
’d_off£t
 = 0;

3419 
©om_size
 = (
ngx_mp4_co64_©om_t
è+ (
d©a
->
Ï¡
 - d©a->
pos
);

3420 
Œak
->
size
 +ð
©om_size
;

3422 
©om
 = 
Œak
->
out
[
NGX_HTTP_MP4_CO64_ATOM
].
buf
;

3423 
co64_©om
 = (
ngx_mp4_co64_©om_t
 *è
©om
->
pos
;

3425 
	`ngx_mp4_£t_32v®ue
(
co64_©om
->
size
, 
©om_size
);

3426 
	`ngx_mp4_£t_32v®ue
(
co64_©om
->
’Œ›s
,ƒntries);

3428  
NGX_OK
;

3429 
	}
}

3433 
	$ngx_h‰p_mp4_adju¡_co64_©om
(
ngx_h‰p_mp4_fže_t
 *
mp4
,

3434 
ngx_h‰p_mp4_Œak_t
 *
Œak
, 
off_t
 
adju¡m’t
)

3436 
ušt64_t
 
off£t
, *
’Œy
, *
’d
;

3437 
ngx_buf_t
 *
d©a
;

3444 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
mp4
->
fže
.
log
, 0,

3447 
d©a
 = 
Œak
->
out
[
NGX_HTTP_MP4_CO64_DATA
].
buf
;

3448 
’Œy
 = (
ušt64_t
 *è
d©a
->
pos
;

3449 
’d
 = (
ušt64_t
 *è
d©a
->
Ï¡
;

3451 
’Œy
 < 
’d
) {

3452 
off£t
 = 
	`ngx_mp4_g‘_64v®ue
(
’Œy
);

3453 
off£t
 +ð
adju¡m’t
;

3454 
	`ngx_mp4_£t_64v®ue
(
’Œy
, 
off£t
);

3455 
’Œy
++;

3457 
	}
}

3461 
	$ngx_h‰p_mp4
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3463 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3465 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

3466 
þcf
->
hªdËr
 = 
ngx_h‰p_mp4_hªdËr
;

3468  
NGX_CONF_OK
;

3469 
	}
}

3473 
	$ngx_h‰p_mp4_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

3475 
ngx_h‰p_mp4_cÚf_t
 *
cÚf
;

3477 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_mp4_cÚf_t
));

3478 ià(
cÚf
 =ð
NULL
) {

3479  
NULL
;

3482 
cÚf
->
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

3483 
cÚf
->
max_bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

3485  
cÚf
;

3486 
	}
}

3490 
	$ngx_h‰p_mp4_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

3492 
ngx_h‰p_mp4_cÚf_t
 *
´ev
 = 
·»Á
;

3493 
ngx_h‰p_mp4_cÚf_t
 *
cÚf
 = 
chžd
;

3495 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
bufãr_size
, 
´ev
->buffer_size, 512 * 1024);

3496 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
max_bufãr_size
, 
´ev
->max_buffer_size,

3499  
NGX_CONF_OK
;

3500 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_not_modified_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_ušt_t
 
ngx_h‰p_‹¡_if_unmodif›d
(
ngx_h‰p_»que¡_t
 *
r
);

14 
ngx_ušt_t
 
ngx_h‰p_‹¡_if_modif›d
(
ngx_h‰p_»que¡_t
 *
r
);

15 
ngx_ušt_t
 
ngx_h‰p_‹¡_if_m©ch
(
ngx_h‰p_»que¡_t
 *
r
,

16 
ngx_bË_–t_t
 *
h—d”
, 
ngx_ušt_t
 
w—k
);

17 
ngx_št_t
 
ngx_h‰p_nÙ_modif›d_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

20 
ngx_h‰p_moduË_t
 
	gngx_h‰p_nÙ_modif›d_fž‹r_moduË_ùx
 = {

21 
NULL
,

22 
ngx_h‰p_nÙ_modif›d_fž‹r_š™
,

24 
NULL
,

25 
NULL
,

27 
NULL
,

28 
NULL
,

30 
NULL
,

31 
NULL


35 
ngx_moduË_t
 
	gngx_h‰p_nÙ_modif›d_fž‹r_moduË
 = {

36 
NGX_MODULE_V1
,

37 &
ngx_h‰p_nÙ_modif›d_fž‹r_moduË_ùx
,

38 
NULL
,

39 
NGX_HTTP_MODULE
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NGX_MODULE_V1_PADDING


51 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

54 
ngx_št_t


55 
	$ngx_h‰p_nÙ_modif›d_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

57 ià(
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_OK


58 || 
r
 !ðr->
maš


59 || 
r
->
di§bË_nÙ_modif›d
)

61  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

64 ià(
r
->
h—d”s_š
.
if_unmodif›d_sšû


65 && !
	`ngx_h‰p_‹¡_if_unmodif›d
(
r
))

67  
	`ngx_h‰p_fž‹r_fš®ize_»que¡
(
r
, 
NULL
,

68 
NGX_HTTP_PRECONDITION_FAILED
);

71 ià(
r
->
h—d”s_š
.
if_m©ch


72 && !
	`ngx_h‰p_‹¡_if_m©ch
(
r
,„->
h—d”s_š
.
if_m©ch
, 0))

74  
	`ngx_h‰p_fž‹r_fš®ize_»que¡
(
r
, 
NULL
,

75 
NGX_HTTP_PRECONDITION_FAILED
);

78 ià(
r
->
h—d”s_š
.
if_modif›d_sšû
 ||„->h—d”s_š.
if_nÚe_m©ch
) {

80 ià(
r
->
h—d”s_š
.
if_modif›d_sšû


81 && 
	`ngx_h‰p_‹¡_if_modif›d
(
r
))

83  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

86 ià(
r
->
h—d”s_š
.
if_nÚe_m©ch


87 && !
	`ngx_h‰p_‹¡_if_m©ch
(
r
,„->
h—d”s_š
.
if_nÚe_m©ch
, 1))

89  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

94 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_NOT_MODIFIED
;

95 
r
->
h—d”s_out
.
¡©us_lše
.
Ën
 = 0;

96 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 = 0;

97 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
r
);

98 
	`ngx_h‰p_þ—r_acû±_¿nges
(
r
);

100 ià(
r
->
h—d”s_out
.
cÚ‹Á_’codšg
) {

101 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
->
hash
 = 0;

102 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
 = 
NULL
;

105  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

108  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

109 
	}
}

112 
ngx_ušt_t


113 
	$ngx_h‰p_‹¡_if_unmodif›d
(
ngx_h‰p_»que¡_t
 *
r
)

115 
time_t
 
iums
;

117 ià(
r
->
h—d”s_out
.
Ï¡_modif›d_time
 =ð(
time_t
) -1) {

121 
iums
 = 
	`ngx_h‰p_·r£_time
(
r
->
h—d”s_š
.
if_unmodif›d_sšû
->
v®ue
.
d©a
,

122 
r
->
h—d”s_š
.
if_unmodif›d_sšû
->
v®ue
.
Ën
);

124 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

125 "h‰°iums:%T†m:%T", 
iums
, 
r
->
h—d”s_out
.
Ï¡_modif›d_time
);

127 ià(
iums
 >ð
r
->
h—d”s_out
.
Ï¡_modif›d_time
) {

132 
	}
}

135 
ngx_ušt_t


136 
	$ngx_h‰p_‹¡_if_modif›d
(
ngx_h‰p_»que¡_t
 *
r
)

138 
time_t
 
ims
;

139 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

141 ià(
r
->
h—d”s_out
.
Ï¡_modif›d_time
 =ð(
time_t
) -1) {

145 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

147 ià(
þcf
->
if_modif›d_sšû
 =ð
NGX_HTTP_IMS_OFF
) {

151 
ims
 = 
	`ngx_h‰p_·r£_time
(
r
->
h—d”s_š
.
if_modif›d_sšû
->
v®ue
.
d©a
,

152 
r
->
h—d”s_š
.
if_modif›d_sšû
->
v®ue
.
Ën
);

154 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

155 "h‰°ims:%T†m:%T", 
ims
, 
r
->
h—d”s_out
.
Ï¡_modif›d_time
);

157 ià(
ims
 =ð
r
->
h—d”s_out
.
Ï¡_modif›d_time
) {

161 ià(
þcf
->
if_modif›d_sšû
 =ð
NGX_HTTP_IMS_EXACT


162 || 
ims
 < 
r
->
h—d”s_out
.
Ï¡_modif›d_time
)

168 
	}
}

171 
ngx_ušt_t


172 
	$ngx_h‰p_‹¡_if_m©ch
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h—d”
,

173 
ngx_ušt_t
 
w—k
)

175 
u_ch¬
 *
¡¬t
, *
’d
, 
ch
;

176 
ngx_¡r_t
 
‘ag
, *
li¡
;

178 
li¡
 = &
h—d”
->
v®ue
;

180 ià(
li¡
->
Ën
 =ð1 &&†i¡->
d©a
[0] == '*') {

184 ià(
r
->
h—d”s_out
.
‘ag
 =ð
NULL
) {

188 
‘ag
 = 
r
->
h—d”s_out
.‘ag->
v®ue
;

190 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

191 "h‰°im:\"%V\"ƒg:%V", 
li¡
, &
‘ag
);

193 ià(
w—k


194 && 
‘ag
.
Ën
 > 2

195 && 
‘ag
.
d©a
[0] == 'W'

196 && 
‘ag
.
d©a
[1] == '/')

198 
‘ag
.
Ën
 -= 2;

199 
‘ag
.
d©a
 += 2;

202 
¡¬t
 = 
li¡
->
d©a
;

203 
’d
 = 
li¡
->
d©a
 +†i¡->
Ën
;

205 
¡¬t
 < 
’d
) {

207 ià(
w—k


208 && 
’d
 - 
¡¬t
 > 2

209 && 
¡¬t
[0] == 'W'

210 && 
¡¬t
[1] == '/')

212 
¡¬t
 += 2;

215 ià(
‘ag
.
Ën
 > (
size_t
è(
’d
 - 
¡¬t
)) {

219 ià(
	`ngx_¡ºcmp
(
¡¬t
, 
‘ag
.
d©a
,ƒg.
Ën
) != 0) {

220 
sk
;

223 
¡¬t
 +ð
‘ag
.
Ën
;

225 
¡¬t
 < 
’d
) {

226 
ch
 = *
¡¬t
;

228 ià(
ch
 == ' ' || ch == '\t') {

229 
¡¬t
++;

236 ià(
¡¬t
 =ð
’d
 || *start == ',') {

240 
sk
:

242 
¡¬t
 < 
’d
 && *start != ',') { start++; }

243 
¡¬t
 < 
’d
) {

244 
ch
 = *
¡¬t
;

246 ià(
ch
 == ' ' || ch == '\t' || ch == ',') {

247 
¡¬t
++;

256 
	}
}

259 
ngx_št_t


260 
	$ngx_h‰p_nÙ_modif›d_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

262 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

263 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_nÙ_modif›d_h—d”_fž‹r
;

265  
NGX_OK
;

266 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_proxy_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_h‰p_´oxy_»wr™e_s
 
	tngx_h‰p_´oxy_»wr™e_t
;

15 
	$ngx_št_t
 (*
	tngx_h‰p_´oxy_»wr™e_±
)(
	tngx_h‰p_»que¡_t
 *
	tr
,

16 
	tngx_bË_–t_t
 *
	th
, 
	tsize_t
 
	t´efix
, size_ˆ
	tËn
,

17 
	tngx_h‰p_´oxy_»wr™e_t
 *
	t´
);

19 
	sngx_h‰p_´oxy_»wr™e_s
 {

20 
ngx_h‰p_´oxy_»wr™e_±
 
hªdËr
;

23 
ngx_h‰p_com¶ex_v®ue_t
 
com¶ex
;

24 #ià(
NGX_PCRE
)

25 
ngx_h‰p_»gex_t
 *
»gex
;

27 } 
·‰”n
;

29 
ngx_h‰p_com¶ex_v®ue_t
 
»¶aûm’t
;

34 
ngx_¡r_t
 
key_¡¬t
;

35 
ngx_¡r_t
 
schema
;

36 
ngx_¡r_t
 
ho¡_h—d”
;

37 
ngx_¡r_t
 
pÜt
;

38 
ngx_¡r_t
 
uri
;

39 } 
	tngx_h‰p_´oxy_v¬s_t
;

43 
ngx_¬¿y_t
 *
æushes
;

44 
ngx_¬¿y_t
 *
Ëngths
;

45 
ngx_¬¿y_t
 *
v®ues
;

46 
ngx_hash_t
 
hash
;

47 } 
	tngx_h‰p_´oxy_h—d”s_t
;

51 
ngx_h‰p_up¡»am_cÚf_t
 
up¡»am
;

53 
ngx_¬¿y_t
 *
body_æushes
;

54 
ngx_¬¿y_t
 *
body_Ëngths
;

55 
ngx_¬¿y_t
 *
body_v®ues
;

56 
ngx_¡r_t
 
body_sourû
;

58 
ngx_h‰p_´oxy_h—d”s_t
 
h—d”s
;

59 #ià(
NGX_HTTP_CACHE
)

60 
ngx_h‰p_´oxy_h—d”s_t
 
h—d”s_ÿche
;

62 
ngx_¬¿y_t
 *
h—d”s_sourû
;

64 
ngx_¬¿y_t
 *
´oxy_Ëngths
;

65 
ngx_¬¿y_t
 *
´oxy_v®ues
;

67 
ngx_¬¿y_t
 *
»dœeùs
;

68 
ngx_¬¿y_t
 *
cook›_domašs
;

69 
ngx_¬¿y_t
 *
cook›_·ths
;

71 
ngx_¡r_t
 
m‘hod
;

72 
ngx_¡r_t
 
loÿtiÚ
;

73 
ngx_¡r_t
 
u¾
;

75 #ià(
NGX_HTTP_CACHE
)

76 
ngx_h‰p_com¶ex_v®ue_t
 
ÿche_key
;

79 
ngx_h‰p_´oxy_v¬s_t
 
v¬s
;

81 
ngx_æag_t
 
»dœeù
;

83 
ngx_ušt_t
 
h‰p_v”siÚ
;

85 
ngx_ušt_t
 
h—d”s_hash_max_size
;

86 
ngx_ušt_t
 
h—d”s_hash_buck‘_size
;

88 #ià(
NGX_HTTP_SSL
)

89 
ngx_ušt_t
 
s¦
;

90 
ngx_ušt_t
 
s¦_´ÙocÞs
;

91 
ngx_¡r_t
 
s¦_ch”s
;

92 
ngx_ušt_t
 
s¦_v”ify_d•th
;

93 
ngx_¡r_t
 
s¦_Œu¡ed_û¹ifiÿ‹
;

94 
ngx_¡r_t
 
s¦_ül
;

95 
ngx_¡r_t
 
s¦_û¹ifiÿ‹
;

96 
ngx_¡r_t
 
s¦_û¹ifiÿ‹_key
;

97 
ngx_¬¿y_t
 *
s¦_·sswÜds
;

99 } 
	tngx_h‰p_´oxy_loc_cÚf_t
;

103 
ngx_h‰p_¡©us_t
 
¡©us
;

104 
ngx_h‰p_chunked_t
 
chunked
;

105 
ngx_h‰p_´oxy_v¬s_t
 
v¬s
;

106 
off_t
 
š‹º®_body_Ëngth
;

108 
ngx_ušt_t
 
h—d
;

109 } 
	tngx_h‰p_´oxy_ùx_t
;

112 
ngx_št_t
 
	`ngx_h‰p_´oxy_ev®
(
ngx_h‰p_»que¡_t
 *
r
,

113 
ngx_h‰p_´oxy_ùx_t
 *
ùx
, 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
);

114 #ià(
NGX_HTTP_CACHE
)

115 
ngx_št_t
 
	`ngx_h‰p_´oxy_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
);

117 
ngx_št_t
 
	`ngx_h‰p_´oxy_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

118 
ngx_št_t
 
	`ngx_h‰p_´oxy_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

119 
ngx_št_t
 
	`ngx_h‰p_´oxy_´oûss_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
);

120 
ngx_št_t
 
	`ngx_h‰p_´oxy_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

121 
ngx_št_t
 
	`ngx_h‰p_´oxy_šput_fž‹r_š™
(*
d©a
);

122 
ngx_št_t
 
	`ngx_h‰p_´oxy_cÝy_fž‹r
(
ngx_ev’t_pe_t
 *
p
,

123 
ngx_buf_t
 *
buf
);

124 
ngx_št_t
 
	`ngx_h‰p_´oxy_chunked_fž‹r
(
ngx_ev’t_pe_t
 *
p
,

125 
ngx_buf_t
 *
buf
);

126 
ngx_št_t
 
	`ngx_h‰p_´oxy_nÚ_bufã»d_cÝy_fž‹r
(*
d©a
,

127 
ssize_t
 
by‹s
);

128 
ngx_št_t
 
	`ngx_h‰p_´oxy_nÚ_bufã»d_chunked_fž‹r
(*
d©a
,

129 
ssize_t
 
by‹s
);

130 
	`ngx_h‰p_´oxy_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

131 
	`ngx_h‰p_´oxy_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

132 
ngx_št_t
 
rc
);

134 
ngx_št_t
 
	`ngx_h‰p_´oxy_ho¡_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

135 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

136 
ngx_št_t
 
	`ngx_h‰p_´oxy_pÜt_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

137 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

138 
ngx_št_t


139 
	`ngx_h‰p_´oxy_add_x_fÜw¬ded_fÜ_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

140 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

141 
ngx_št_t


142 
	`ngx_h‰p_´oxy_š‹º®_body_Ëngth_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

143 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

144 
ngx_št_t
 
	`ngx_h‰p_´oxy_»wr™e_»dœeù
(
ngx_h‰p_»que¡_t
 *
r
,

145 
ngx_bË_–t_t
 *
h
, 
size_t
 
´efix
);

146 
ngx_št_t
 
	`ngx_h‰p_´oxy_»wr™e_cook›
(
ngx_h‰p_»que¡_t
 *
r
,

147 
ngx_bË_–t_t
 *
h
);

148 
ngx_št_t
 
	`ngx_h‰p_´oxy_»wr™e_cook›_v®ue
(
ngx_h‰p_»que¡_t
 *
r
,

149 
ngx_bË_–t_t
 *
h
, 
u_ch¬
 *
v®ue
, 
ngx_¬¿y_t
 *
»wr™es
);

150 
ngx_št_t
 
	`ngx_h‰p_´oxy_»wr™e
(
ngx_h‰p_»que¡_t
 *
r
,

151 
ngx_bË_–t_t
 *
h
, 
size_t
 
´efix
, size_ˆ
Ën
, 
ngx_¡r_t
 *
»¶aûm’t
);

153 
ngx_št_t
 
	`ngx_h‰p_´oxy_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

154 *
	`ngx_h‰p_´oxy_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

155 *
	`ngx_h‰p_´oxy_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

156 *
·»Á
, *
chžd
);

157 
ngx_št_t
 
	`ngx_h‰p_´oxy_š™_h—d”s
(
ngx_cÚf_t
 *
cf
,

158 
ngx_h‰p_´oxy_loc_cÚf_t
 *
cÚf
, 
ngx_h‰p_´oxy_h—d”s_t
 *
h—d”s
,

159 
ngx_keyv®_t
 *
deçuÉ_h—d”s
);

161 *
	`ngx_h‰p_´oxy_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

162 *
cÚf
);

163 *
	`ngx_h‰p_´oxy_»dœeù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

164 *
cÚf
);

165 *
	`ngx_h‰p_´oxy_cook›_domaš
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

166 *
cÚf
);

167 *
	`ngx_h‰p_´oxy_cook›_·th
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

168 *
cÚf
);

169 *
	`ngx_h‰p_´oxy_¡Üe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

170 *
cÚf
);

171 #ià(
NGX_HTTP_CACHE
)

172 *
	`ngx_h‰p_´oxy_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

173 *
cÚf
);

174 *
	`ngx_h‰p_´oxy_ÿche_key
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

175 *
cÚf
);

177 #ià(
NGX_HTTP_SSL
)

178 *
	`ngx_h‰p_´oxy_s¦_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
,

179 
ngx_commªd_t
 *
cmd
, *
cÚf
);

182 *
	`ngx_h‰p_´oxy_low©_check
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

184 
ngx_št_t
 
	`ngx_h‰p_´oxy_»wr™e_»gex
(
ngx_cÚf_t
 *
cf
,

185 
ngx_h‰p_´oxy_»wr™e_t
 *
´
, 
ngx_¡r_t
 *
»gex
, 
ngx_ušt_t
 
ÿ£Ëss
);

187 #ià(
NGX_HTTP_SSL
)

188 
ngx_št_t
 
	`ngx_h‰p_´oxy_£t_s¦
(
ngx_cÚf_t
 *
cf
,

189 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
);

191 
	`ngx_h‰p_´oxy_£t_v¬s
(
ngx_u¾_t
 *
u
, 
ngx_h‰p_´oxy_v¬s_t
 *
v
);

194 
ngx_cÚf_po¡_t
 
ngx_h‰p_´oxy_low©_po¡
 =

195 { 
ngx_h‰p_´oxy_low©_check
 
	}
};

198 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_´oxy_Ãxt_up¡»am_masks
[] = {

199 { 
ngx_¡ršg
("”rÜ"), 
NGX_HTTP_UPSTREAM_FT_ERROR
 },

200 { 
ngx_¡ršg
("timeout"), 
NGX_HTTP_UPSTREAM_FT_TIMEOUT
 },

201 { 
ngx_¡ršg
("šv®id_h—d”"), 
NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
 },

202 { 
ngx_¡ršg
("h‰p_500"), 
NGX_HTTP_UPSTREAM_FT_HTTP_500
 },

203 { 
ngx_¡ršg
("h‰p_502"), 
NGX_HTTP_UPSTREAM_FT_HTTP_502
 },

204 { 
ngx_¡ršg
("h‰p_503"), 
NGX_HTTP_UPSTREAM_FT_HTTP_503
 },

205 { 
ngx_¡ršg
("h‰p_504"), 
NGX_HTTP_UPSTREAM_FT_HTTP_504
 },

206 { 
ngx_¡ršg
("h‰p_403"), 
NGX_HTTP_UPSTREAM_FT_HTTP_403
 },

207 { 
ngx_¡ršg
("h‰p_404"), 
NGX_HTTP_UPSTREAM_FT_HTTP_404
 },

208 { 
ngx_¡ršg
("upd©šg"), 
NGX_HTTP_UPSTREAM_FT_UPDATING
 },

209 { 
ngx_¡ršg
("off"), 
NGX_HTTP_UPSTREAM_FT_OFF
 },

210 { 
ngx_nuÎ_¡ršg
, 0 }

214 #ià(
NGX_HTTP_SSL
)

216 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_´oxy_s¦_´ÙocÞs
[] = {

217 { 
ngx_¡ršg
("SSLv2"), 
NGX_SSL_SSLv2
 },

218 { 
ngx_¡ršg
("SSLv3"), 
NGX_SSL_SSLv3
 },

219 { 
ngx_¡ršg
("TLSv1"), 
NGX_SSL_TLSv1
 },

220 { 
ngx_¡ršg
("TLSv1.1"), 
NGX_SSL_TLSv1_1
 },

221 { 
ngx_¡ršg
("TLSv1.2"), 
NGX_SSL_TLSv1_2
 },

222 { 
ngx_nuÎ_¡ršg
, 0 }

228 
ngx_cÚf_’um_t
 
	gngx_h‰p_´oxy_h‰p_v”siÚ
[] = {

229 { 
ngx_¡ršg
("1.0"), 
NGX_HTTP_VERSION_10
 },

230 { 
ngx_¡ršg
("1.1"), 
NGX_HTTP_VERSION_11
 },

231 { 
ngx_nuÎ_¡ršg
, 0 }

235 
ngx_moduË_t
 
	gngx_h‰p_´oxy_moduË
;

238 
ngx_commªd_t
 
	gngx_h‰p_´oxy_commªds
[] = {

240 { 
ngx_¡ršg
("proxy_pass"),

241 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF
|
NGX_HTTP_LMT_CONF
|
NGX_CONF_TAKE1
,

242 
ngx_h‰p_´oxy_·ss
,

243 
NGX_HTTP_LOC_CONF_OFFSET
,

245 
NULL
 },

247 { 
ngx_¡ršg
("proxy_redirect"),

248 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE12
,

249 
ngx_h‰p_´oxy_»dœeù
,

250 
NGX_HTTP_LOC_CONF_OFFSET
,

252 
NULL
 },

254 { 
ngx_¡ršg
("proxy_cookie_domain"),

255 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE12
,

256 
ngx_h‰p_´oxy_cook›_domaš
,

257 
NGX_HTTP_LOC_CONF_OFFSET
,

259 
NULL
 },

261 { 
ngx_¡ršg
("proxy_cookie_path"),

262 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE12
,

263 
ngx_h‰p_´oxy_cook›_·th
,

264 
NGX_HTTP_LOC_CONF_OFFSET
,

266 
NULL
 },

268 { 
ngx_¡ršg
("proxy_store"),

269 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

270 
ngx_h‰p_´oxy_¡Üe
,

271 
NGX_HTTP_LOC_CONF_OFFSET
,

273 
NULL
 },

275 { 
ngx_¡ršg
("proxy_store_access"),

276 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE123
,

277 
ngx_cÚf_£t_acûss_¦Ù
,

278 
NGX_HTTP_LOC_CONF_OFFSET
,

279 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
¡Üe_acûss
),

280 
NULL
 },

282 { 
ngx_¡ršg
("proxy_buffering"),

283 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

284 
ngx_cÚf_£t_æag_¦Ù
,

285 
NGX_HTTP_LOC_CONF_OFFSET
,

286 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
bufãršg
),

287 
NULL
 },

289 { 
ngx_¡ršg
("proxy_ignore_client_abort"),

290 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

291 
ngx_cÚf_£t_æag_¦Ù
,

292 
NGX_HTTP_LOC_CONF_OFFSET
,

293 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ignÜe_þ›Á_abÜt
),

294 
NULL
 },

296 { 
ngx_¡ršg
("proxy_bind"),

297 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

298 
ngx_h‰p_up¡»am_bšd_£t_¦Ù
,

299 
NGX_HTTP_LOC_CONF_OFFSET
,

300 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
loÿl
),

301 
NULL
 },

303 { 
ngx_¡ršg
("proxy_connect_timeout"),

304 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

305 
ngx_cÚf_£t_m£c_¦Ù
,

306 
NGX_HTTP_LOC_CONF_OFFSET
,

307 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
cÚÃù_timeout
),

308 
NULL
 },

310 { 
ngx_¡ršg
("proxy_send_timeout"),

311 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

312 
ngx_cÚf_£t_m£c_¦Ù
,

313 
NGX_HTTP_LOC_CONF_OFFSET
,

314 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
£nd_timeout
),

315 
NULL
 },

317 { 
ngx_¡ršg
("proxy_send_lowat"),

318 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

319 
ngx_cÚf_£t_size_¦Ù
,

320 
NGX_HTTP_LOC_CONF_OFFSET
,

321 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
£nd_low©
),

322 &
ngx_h‰p_´oxy_low©_po¡
 },

324 { 
ngx_¡ršg
("proxy_intercept_errors"),

325 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

326 
ngx_cÚf_£t_æag_¦Ù
,

327 
NGX_HTTP_LOC_CONF_OFFSET
,

328 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
š‹rû±_”rÜs
),

329 
NULL
 },

331 { 
ngx_¡ršg
("proxy_set_header"),

332 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

333 
ngx_cÚf_£t_keyv®_¦Ù
,

334 
NGX_HTTP_LOC_CONF_OFFSET
,

335 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
h—d”s_sourû
),

336 
NULL
 },

338 { 
ngx_¡ršg
("proxy_headers_hash_max_size"),

339 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

340 
ngx_cÚf_£t_num_¦Ù
,

341 
NGX_HTTP_LOC_CONF_OFFSET
,

342 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
h—d”s_hash_max_size
),

343 
NULL
 },

345 { 
ngx_¡ršg
("proxy_headers_hash_bucket_size"),

346 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

347 
ngx_cÚf_£t_num_¦Ù
,

348 
NGX_HTTP_LOC_CONF_OFFSET
,

349 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
h—d”s_hash_buck‘_size
),

350 
NULL
 },

352 { 
ngx_¡ršg
("proxy_set_body"),

353 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

354 
ngx_cÚf_£t_¡r_¦Ù
,

355 
NGX_HTTP_LOC_CONF_OFFSET
,

356 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
body_sourû
),

357 
NULL
 },

359 { 
ngx_¡ršg
("proxy_method"),

360 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

361 
ngx_cÚf_£t_¡r_¦Ù
,

362 
NGX_HTTP_LOC_CONF_OFFSET
,

363 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
m‘hod
),

364 
NULL
 },

366 { 
ngx_¡ršg
("proxy_pass_request_headers"),

367 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

368 
ngx_cÚf_£t_æag_¦Ù
,

369 
NGX_HTTP_LOC_CONF_OFFSET
,

370 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
·ss_»que¡_h—d”s
),

371 
NULL
 },

373 { 
ngx_¡ršg
("proxy_pass_request_body"),

374 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

375 
ngx_cÚf_£t_æag_¦Ù
,

376 
NGX_HTTP_LOC_CONF_OFFSET
,

377 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
·ss_»que¡_body
),

378 
NULL
 },

380 { 
ngx_¡ršg
("proxy_buffer_size"),

381 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

382 
ngx_cÚf_£t_size_¦Ù
,

383 
NGX_HTTP_LOC_CONF_OFFSET
,

384 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
bufãr_size
),

385 
NULL
 },

387 { 
ngx_¡ršg
("proxy_read_timeout"),

388 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

389 
ngx_cÚf_£t_m£c_¦Ù
,

390 
NGX_HTTP_LOC_CONF_OFFSET
,

391 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
»ad_timeout
),

392 
NULL
 },

394 { 
ngx_¡ršg
("proxy_buffers"),

395 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

396 
ngx_cÚf_£t_bufs_¦Ù
,

397 
NGX_HTTP_LOC_CONF_OFFSET
,

398 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
bufs
),

399 
NULL
 },

401 { 
ngx_¡ršg
("proxy_busy_buffers_size"),

402 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

403 
ngx_cÚf_£t_size_¦Ù
,

404 
NGX_HTTP_LOC_CONF_OFFSET
,

405 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
busy_bufãrs_size_cÚf
),

406 
NULL
 },

408 { 
ngx_¡ršg
("proxy_force_ranges"),

409 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

410 
ngx_cÚf_£t_æag_¦Ù
,

411 
NGX_HTTP_LOC_CONF_OFFSET
,

412 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
fÜû_¿nges
),

413 
NULL
 },

415 { 
ngx_¡ršg
("proxy_limit_rate"),

416 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

417 
ngx_cÚf_£t_size_¦Ù
,

418 
NGX_HTTP_LOC_CONF_OFFSET
,

419 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
lim™_¿‹
),

420 
NULL
 },

422 #ià(
NGX_HTTP_CACHE
)

424 { 
ngx_¡ršg
("proxy_cache"),

425 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

426 
ngx_h‰p_´oxy_ÿche
,

427 
NGX_HTTP_LOC_CONF_OFFSET
,

429 
NULL
 },

431 { 
ngx_¡ršg
("proxy_cache_key"),

432 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

433 
ngx_h‰p_´oxy_ÿche_key
,

434 
NGX_HTTP_LOC_CONF_OFFSET
,

436 
NULL
 },

438 { 
ngx_¡ršg
("proxy_cache_path"),

439 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_2MORE
,

440 
ngx_h‰p_fže_ÿche_£t_¦Ù
,

443 &
ngx_h‰p_´oxy_moduË
 },

445 { 
ngx_¡ršg
("proxy_cache_bypass"),

446 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

447 
ngx_h‰p_£t_´ediÿ‹_¦Ù
,

448 
NGX_HTTP_LOC_CONF_OFFSET
,

449 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_by·ss
),

450 
NULL
 },

452 { 
ngx_¡ršg
("proxy_no_cache"),

453 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

454 
ngx_h‰p_£t_´ediÿ‹_¦Ù
,

455 
NGX_HTTP_LOC_CONF_OFFSET
,

456 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
no_ÿche
),

457 
NULL
 },

459 { 
ngx_¡ršg
("proxy_cache_valid"),

460 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

461 
ngx_h‰p_fže_ÿche_v®id_£t_¦Ù
,

462 
NGX_HTTP_LOC_CONF_OFFSET
,

463 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_v®id
),

464 
NULL
 },

466 { 
ngx_¡ršg
("proxy_cache_min_uses"),

467 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

468 
ngx_cÚf_£t_num_¦Ù
,

469 
NGX_HTTP_LOC_CONF_OFFSET
,

470 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_mš_u£s
),

471 
NULL
 },

473 { 
ngx_¡ršg
("proxy_cache_use_stale"),

474 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

475 
ngx_cÚf_£t_b™mask_¦Ù
,

476 
NGX_HTTP_LOC_CONF_OFFSET
,

477 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_u£_¡®e
),

478 &
ngx_h‰p_´oxy_Ãxt_up¡»am_masks
 },

480 { 
ngx_¡ršg
("proxy_cache_methods"),

481 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

482 
ngx_cÚf_£t_b™mask_¦Ù
,

483 
NGX_HTTP_LOC_CONF_OFFSET
,

484 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_m‘hods
),

485 &
ngx_h‰p_up¡»am_ÿche_m‘hod_mask
 },

487 { 
ngx_¡ršg
("proxy_cache_lock"),

488 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

489 
ngx_cÚf_£t_æag_¦Ù
,

490 
NGX_HTTP_LOC_CONF_OFFSET
,

491 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_lock
),

492 
NULL
 },

494 { 
ngx_¡ršg
("proxy_cache_lock_timeout"),

495 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

496 
ngx_cÚf_£t_m£c_¦Ù
,

497 
NGX_HTTP_LOC_CONF_OFFSET
,

498 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_lock_timeout
),

499 
NULL
 },

501 { 
ngx_¡ršg
("proxy_cache_lock_age"),

502 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

503 
ngx_cÚf_£t_m£c_¦Ù
,

504 
NGX_HTTP_LOC_CONF_OFFSET
,

505 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_lock_age
),

506 
NULL
 },

508 { 
ngx_¡ršg
("proxy_cache_revalidate"),

509 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

510 
ngx_cÚf_£t_æag_¦Ù
,

511 
NGX_HTTP_LOC_CONF_OFFSET
,

512 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ÿche_»v®id©e
),

513 
NULL
 },

517 { 
ngx_¡ršg
("proxy_temp_path"),

518 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1234
,

519 
ngx_cÚf_£t_·th_¦Ù
,

520 
NGX_HTTP_LOC_CONF_OFFSET
,

521 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
‹mp_·th
),

522 
NULL
 },

524 { 
ngx_¡ršg
("proxy_max_temp_file_size"),

525 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

526 
ngx_cÚf_£t_size_¦Ù
,

527 
NGX_HTTP_LOC_CONF_OFFSET
,

528 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
max_‹mp_fže_size_cÚf
),

529 
NULL
 },

531 { 
ngx_¡ršg
("proxy_temp_file_write_size"),

532 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

533 
ngx_cÚf_£t_size_¦Ù
,

534 
NGX_HTTP_LOC_CONF_OFFSET
,

535 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
‹mp_fže_wr™e_size_cÚf
),

536 
NULL
 },

538 { 
ngx_¡ršg
("proxy_next_upstream"),

539 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

540 
ngx_cÚf_£t_b™mask_¦Ù
,

541 
NGX_HTTP_LOC_CONF_OFFSET
,

542 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am
),

543 &
ngx_h‰p_´oxy_Ãxt_up¡»am_masks
 },

545 { 
ngx_¡ršg
("proxy_next_upstream_tries"),

546 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

547 
ngx_cÚf_£t_num_¦Ù
,

548 
NGX_HTTP_LOC_CONF_OFFSET
,

549 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_Œ›s
),

550 
NULL
 },

552 { 
ngx_¡ršg
("proxy_next_upstream_timeout"),

553 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

554 
ngx_cÚf_£t_m£c_¦Ù
,

555 
NGX_HTTP_LOC_CONF_OFFSET
,

556 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_timeout
),

557 
NULL
 },

559 { 
ngx_¡ršg
("proxy_pass_header"),

560 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

561 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

562 
NGX_HTTP_LOC_CONF_OFFSET
,

563 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
·ss_h—d”s
),

564 
NULL
 },

566 { 
ngx_¡ršg
("proxy_hide_header"),

567 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

568 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

569 
NGX_HTTP_LOC_CONF_OFFSET
,

570 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
hide_h—d”s
),

571 
NULL
 },

573 { 
ngx_¡ršg
("proxy_ignore_headers"),

574 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

575 
ngx_cÚf_£t_b™mask_¦Ù
,

576 
NGX_HTTP_LOC_CONF_OFFSET
,

577 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
ignÜe_h—d”s
),

578 &
ngx_h‰p_up¡»am_ignÜe_h—d”s_masks
 },

580 { 
ngx_¡ršg
("proxy_http_version"),

581 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

582 
ngx_cÚf_£t_’um_¦Ù
,

583 
NGX_HTTP_LOC_CONF_OFFSET
,

584 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
h‰p_v”siÚ
),

585 &
ngx_h‰p_´oxy_h‰p_v”siÚ
 },

587 #ià(
NGX_HTTP_SSL
)

589 { 
ngx_¡ršg
("proxy_ssl_session_reuse"),

590 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

591 
ngx_cÚf_£t_æag_¦Ù
,

592 
NGX_HTTP_LOC_CONF_OFFSET
,

593 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
s¦_£ssiÚ_»u£
),

594 
NULL
 },

596 { 
ngx_¡ršg
("proxy_ssl_protocols"),

597 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

598 
ngx_cÚf_£t_b™mask_¦Ù
,

599 
NGX_HTTP_LOC_CONF_OFFSET
,

600 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
s¦_´ÙocÞs
),

601 &
ngx_h‰p_´oxy_s¦_´ÙocÞs
 },

603 { 
ngx_¡ršg
("proxy_ssl_ciphers"),

604 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

605 
ngx_cÚf_£t_¡r_¦Ù
,

606 
NGX_HTTP_LOC_CONF_OFFSET
,

607 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
s¦_ch”s
),

608 
NULL
 },

610 { 
ngx_¡ršg
("proxy_ssl_name"),

611 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

612 
ngx_h‰p_£t_com¶ex_v®ue_¦Ù
,

613 
NGX_HTTP_LOC_CONF_OFFSET
,

614 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
s¦_Çme
),

615 
NULL
 },

617 { 
ngx_¡ršg
("proxy_ssl_server_name"),

618 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

619 
ngx_cÚf_£t_æag_¦Ù
,

620 
NGX_HTTP_LOC_CONF_OFFSET
,

621 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
s¦_£rv”_Çme
),

622 
NULL
 },

624 { 
ngx_¡ršg
("proxy_ssl_verify"),

625 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

626 
ngx_cÚf_£t_æag_¦Ù
,

627 
NGX_HTTP_LOC_CONF_OFFSET
,

628 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
up¡»am
.
s¦_v”ify
),

629 
NULL
 },

631 { 
ngx_¡ršg
("proxy_ssl_verify_depth"),

632 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

633 
ngx_cÚf_£t_num_¦Ù
,

634 
NGX_HTTP_LOC_CONF_OFFSET
,

635 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
s¦_v”ify_d•th
),

636 
NULL
 },

638 { 
ngx_¡ršg
("proxy_ssl_trusted_certificate"),

639 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

640 
ngx_cÚf_£t_¡r_¦Ù
,

641 
NGX_HTTP_LOC_CONF_OFFSET
,

642 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
s¦_Œu¡ed_û¹ifiÿ‹
),

643 
NULL
 },

645 { 
ngx_¡ršg
("proxy_ssl_crl"),

646 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

647 
ngx_cÚf_£t_¡r_¦Ù
,

648 
NGX_HTTP_LOC_CONF_OFFSET
,

649 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
s¦_ül
),

650 
NULL
 },

652 { 
ngx_¡ršg
("proxy_ssl_certificate"),

653 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

654 
ngx_cÚf_£t_¡r_¦Ù
,

655 
NGX_HTTP_LOC_CONF_OFFSET
,

656 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
s¦_û¹ifiÿ‹
),

657 
NULL
 },

659 { 
ngx_¡ršg
("proxy_ssl_certificate_key"),

660 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

661 
ngx_cÚf_£t_¡r_¦Ù
,

662 
NGX_HTTP_LOC_CONF_OFFSET
,

663 
off£tof
(
ngx_h‰p_´oxy_loc_cÚf_t
, 
s¦_û¹ifiÿ‹_key
),

664 
NULL
 },

666 { 
ngx_¡ršg
("proxy_ssl_password_file"),

667 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

668 
ngx_h‰p_´oxy_s¦_·sswÜd_fže
,

669 
NGX_HTTP_LOC_CONF_OFFSET
,

671 
NULL
 },

675 
ngx_nuÎ_commªd


679 
ngx_h‰p_moduË_t
 
	gngx_h‰p_´oxy_moduË_ùx
 = {

680 
ngx_h‰p_´oxy_add_v¬ŸbËs
,

681 
NULL
,

683 
NULL
,

684 
NULL
,

686 
NULL
,

687 
NULL
,

689 
ngx_h‰p_´oxy_ü—‹_loc_cÚf
,

690 
ngx_h‰p_´oxy_m”ge_loc_cÚf


694 
ngx_moduË_t
 
	gngx_h‰p_´oxy_moduË
 = {

695 
NGX_MODULE_V1
,

696 &
ngx_h‰p_´oxy_moduË_ùx
,

697 
ngx_h‰p_´oxy_commªds
,

698 
NGX_HTTP_MODULE
,

699 
NULL
,

700 
NULL
,

701 
NULL
,

702 
NULL
,

703 
NULL
,

704 
NULL
,

705 
NULL
,

706 
NGX_MODULE_V1_PADDING


710 
	gngx_h‰p_´oxy_v”siÚ
[] = " HTTP/1.0" 
CRLF
;

711 
	gngx_h‰p_´oxy_v”siÚ_11
[] = " HTTP/1.1" 
CRLF
;

714 
ngx_keyv®_t
 
	gngx_h‰p_´oxy_h—d”s
[] = {

715 { 
ngx_¡ršg
("Host"),‚gx_string("$proxy_host") },

716 { 
ngx_¡ršg
("Connection"),‚gx_string("close") },

717 { 
ngx_¡ršg
("Content-Length"),‚gx_string("$proxy_internal_body_length") },

718 { 
ngx_¡ršg
("Transfer-Encoding"),‚gx_string("") },

719 { 
ngx_¡ršg
("Keep-Alive"),‚gx_string("") },

720 { 
ngx_¡ršg
("Expect"),‚gx_string("") },

721 { 
ngx_¡ršg
("Upgrade"),‚gx_string("") },

722 { 
ngx_nuÎ_¡ršg
,‚gx_null_string }

726 
ngx_¡r_t
 
	gngx_h‰p_´oxy_hide_h—d”s
[] = {

727 
ngx_¡ršg
("Date"),

728 
ngx_¡ršg
("Server"),

729 
ngx_¡ršg
("X-Pad"),

730 
ngx_¡ršg
("X-Accel-Expires"),

731 
ngx_¡ršg
("X-Accel-Redirect"),

732 
ngx_¡ršg
("X-Accel-Limit-Rate"),

733 
ngx_¡ršg
("X-Accel-Buffering"),

734 
ngx_¡ršg
("X-Accel-Charset"),

735 
ngx_nuÎ_¡ršg


739 #ià(
NGX_HTTP_CACHE
)

741 
ngx_keyv®_t
 
	gngx_h‰p_´oxy_ÿche_h—d”s
[] = {

742 { 
ngx_¡ršg
("Host"),‚gx_string("$proxy_host") },

743 { 
ngx_¡ršg
("Connection"),‚gx_string("close") },

744 { 
ngx_¡ršg
("Content-Length"),‚gx_string("$proxy_internal_body_length") },

745 { 
ngx_¡ršg
("Transfer-Encoding"),‚gx_string("") },

746 { 
ngx_¡ršg
("Keep-Alive"),‚gx_string("") },

747 { 
ngx_¡ršg
("Expect"),‚gx_string("") },

748 { 
ngx_¡ršg
("Upgrade"),‚gx_string("") },

749 { 
ngx_¡ršg
("If-Modified-Since"),

750 
ngx_¡ršg
("$upstream_cache_last_modified") },

751 { 
ngx_¡ršg
("If-Unmodified-Since"),‚gx_string("") },

752 { 
ngx_¡ršg
("If-None-Match"),‚gx_string("$upstream_cache_etag") },

753 { 
ngx_¡ršg
("If-Match"),‚gx_string("") },

754 { 
ngx_¡ršg
("Range"),‚gx_string("") },

755 { 
ngx_¡ršg
("If-Range"),‚gx_string("") },

756 { 
ngx_nuÎ_¡ršg
,‚gx_null_string }

762 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_´oxy_v¬s
[] = {

764 { 
ngx_¡ršg
("´oxy_ho¡"), 
NULL
, 
ngx_h‰p_´oxy_ho¡_v¬ŸbË
, 0,

765 
NGX_HTTP_VAR_CHANGEABLE
|
NGX_HTTP_VAR_NOCACHEABLE
|
NGX_HTTP_VAR_NOHASH
, 0 },

767 { 
ngx_¡ršg
("´oxy_pÜt"), 
NULL
, 
ngx_h‰p_´oxy_pÜt_v¬ŸbË
, 0,

768 
NGX_HTTP_VAR_CHANGEABLE
|
NGX_HTTP_VAR_NOCACHEABLE
|
NGX_HTTP_VAR_NOHASH
, 0 },

770 { 
ngx_¡ršg
("´oxy_add_x_fÜw¬ded_fÜ"), 
NULL
,

771 
ngx_h‰p_´oxy_add_x_fÜw¬ded_fÜ_v¬ŸbË
, 0, 
NGX_HTTP_VAR_NOHASH
, 0 },

774 { 
ngx_¡ršg
("´oxy_add_vŸ"), 
NULL
, NULL, 0, 
NGX_HTTP_VAR_NOHASH
, 0 },

777 { 
ngx_¡ršg
("´oxy_š‹º®_body_Ëngth"), 
NULL
,

778 
ngx_h‰p_´oxy_š‹º®_body_Ëngth_v¬ŸbË
, 0,

779 
NGX_HTTP_VAR_NOCACHEABLE
|
NGX_HTTP_VAR_NOHASH
, 0 },

781 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

785 
ngx_·th_š™_t
 
	gngx_h‰p_´oxy_‹mp_·th
 = {

786 
ngx_¡ršg
(
NGX_HTTP_PROXY_TEMP_PATH
), { 1, 2, 0 }

790 
ngx_št_t


791 
	$ngx_h‰p_´oxy_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

793 
ngx_št_t
 
rc
;

794 
ngx_h‰p_up¡»am_t
 *
u
;

795 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

796 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
;

798 ià(
	`ngx_h‰p_up¡»am_ü—‹
(
r
è!ð
NGX_OK
) {

799  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

802 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_´oxy_ùx_t
));

803 ià(
ùx
 =ð
NULL
) {

804  
NGX_ERROR
;

807 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_´oxy_moduË
);

809 
¶cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_´oxy_moduË
);

811 
u
 = 
r
->
up¡»am
;

813 ià(
¶cf
->
´oxy_Ëngths
 =ð
NULL
) {

814 
ùx
->
v¬s
 = 
¶cf
->vars;

815 
u
->
schema
 = 
¶cf
->
v¬s
.schema;

816 #ià(
NGX_HTTP_SSL
)

817 
u
->
s¦
 = (
¶cf
->
up¡»am
.s¦ !ð
NULL
);

821 ià(
	`ngx_h‰p_´oxy_ev®
(
r
, 
ùx
, 
¶cf
è!ð
NGX_OK
) {

822  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

826 
u
->
ouut
.
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_´oxy_moduË
;

828 
u
->
cÚf
 = &
¶cf
->
up¡»am
;

830 #ià(
NGX_HTTP_CACHE
)

831 
u
->
ü—‹_key
 = 
ngx_h‰p_´oxy_ü—‹_key
;

833 
u
->
ü—‹_»que¡
 = 
ngx_h‰p_´oxy_ü—‹_»que¡
;

834 
u
->
»š™_»que¡
 = 
ngx_h‰p_´oxy_»š™_»que¡
;

835 
u
->
´oûss_h—d”
 = 
ngx_h‰p_´oxy_´oûss_¡©us_lše
;

836 
u
->
abÜt_»que¡
 = 
ngx_h‰p_´oxy_abÜt_»que¡
;

837 
u
->
fš®ize_»que¡
 = 
ngx_h‰p_´oxy_fš®ize_»que¡
;

838 
r
->
¡©e
 = 0;

840 ià(
¶cf
->
»dœeùs
) {

841 
u
->
»wr™e_»dœeù
 = 
ngx_h‰p_´oxy_»wr™e_»dœeù
;

844 ià(
¶cf
->
cook›_domašs
 ||…lcf->
cook›_·ths
) {

845 
u
->
»wr™e_cook›
 = 
ngx_h‰p_´oxy_»wr™e_cook›
;

848 
u
->
bufãršg
 = 
¶cf
->
up¡»am
.buffering;

850 
u
->
pe
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_ev’t_pe_t
));

851 ià(
u
->
pe
 =ð
NULL
) {

852  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

855 
u
->
pe
->
šput_fž‹r
 = 
ngx_h‰p_´oxy_cÝy_fž‹r
;

856 
u
->
pe
->
šput_ùx
 = 
r
;

858 
u
->
šput_fž‹r_š™
 = 
ngx_h‰p_´oxy_šput_fž‹r_š™
;

859 
u
->
šput_fž‹r
 = 
ngx_h‰p_´oxy_nÚ_bufã»d_cÝy_fž‹r
;

860 
u
->
šput_fž‹r_ùx
 = 
r
;

862 
u
->
acûl
 = 1;

864 
rc
 = 
	`ngx_h‰p_»ad_þ›Á_»que¡_body
(
r
, 
ngx_h‰p_up¡»am_š™
);

866 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

867  
rc
;

870  
NGX_DONE
;

871 
	}
}

874 
ngx_št_t


875 
	$ngx_h‰p_´oxy_ev®
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_´oxy_ùx_t
 *
ùx
,

876 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
)

878 
u_ch¬
 *
p
;

879 
size_t
 
add
;

880 
u_shÜt
 
pÜt
;

881 
ngx_¡r_t
 
´oxy
;

882 
ngx_u¾_t
 
u¾
;

883 
ngx_h‰p_up¡»am_t
 *
u
;

885 ià(
	`ngx_h‰p_süt_run
(
r
, &
´oxy
, 
¶cf
->
´oxy_Ëngths
->
–ts
, 0,

886 
¶cf
->
´oxy_v®ues
->
–ts
)

887 =ð
NULL
)

889  
NGX_ERROR
;

892 ià(
´oxy
.
Ën
 > 7

893 && 
	`ngx_¡ºÿ£cmp
(
´oxy
.
d©a
, (
u_ch¬
 *) "http://", 7) == 0)

895 
add
 = 7;

896 
pÜt
 = 80;

898 #ià(
NGX_HTTP_SSL
)

900 } ià(
´oxy
.
Ën
 > 8

901 && 
	`ngx_¡ºÿ£cmp
(
´oxy
.
d©a
, (
u_ch¬
 *) "https://", 8) == 0)

903 
add
 = 8;

904 
pÜt
 = 443;

905 
r
->
up¡»am
->
s¦
 = 1;

910 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

911 "šv®id URL…»fix iÀ\"%V\"", &
´oxy
);

912  
NGX_ERROR
;

915 
u
 = 
r
->
up¡»am
;

917 
u
->
schema
.
Ën
 = 
add
;

918 
u
->
schema
.
d©a
 = 
´oxy
.data;

920 
	`ngx_memz”o
(&
u¾
, (
ngx_u¾_t
));

922 
u¾
.u¾.
Ën
 = 
´oxy
.ËÀ- 
add
;

923 
u¾
.u¾.
d©a
 = 
´oxy
.d©¨+ 
add
;

924 
u¾
.
deçuÉ_pÜt
 = 
pÜt
;

925 
u¾
.
uri_·¹
 = 1;

926 
u¾
.
no_»sÞve
 = 1;

928 ià(
	`ngx_·r£_u¾
(
r
->
poÞ
, &
u¾
è!ð
NGX_OK
) {

929 ià(
u¾
.
”r
) {

930 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

931 "% š up¡»am \"%V\"", 
u¾
.
”r
, &url.url);

934  
NGX_ERROR
;

937 ià(
u¾
.
uri
.
Ën
) {

938 ià(
u¾
.
uri
.
d©a
[0] == '?') {

939 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
u¾
.
uri
.
Ën
 + 1);

940 ià(
p
 =ð
NULL
) {

941  
NGX_ERROR
;

944 *
p
++ = '/';

945 
	`ngx_memýy
(
p
, 
u¾
.
uri
.
d©a
, u¾.uri.
Ën
);

947 
u¾
.
uri
.
Ën
++;

948 
u¾
.
uri
.
d©a
 = 
p
 - 1;

952 
ùx
->
v¬s
.
key_¡¬t
 = 
u
->
schema
;

954 
	`ngx_h‰p_´oxy_£t_v¬s
(&
u¾
, &
ùx
->
v¬s
);

956 
u
->
»sÞved
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_»sÞved_t
));

957 ià(
u
->
»sÞved
 =ð
NULL
) {

958  
NGX_ERROR
;

961 ià(
u¾
.
addrs
 && u¾.addrs[0].
sockaddr
) {

962 
u
->
»sÞved
->
sockaddr
 = 
u¾
.
addrs
[0].sockaddr;

963 
u
->
»sÞved
->
sockËn
 = 
u¾
.
addrs
[0].socklen;

964 
u
->
»sÞved
->
Çddrs
 = 1;

965 
u
->
»sÞved
->
ho¡
 = 
u¾
.
addrs
[0].
Çme
;

968 
u
->
»sÞved
->
ho¡
 = 
u¾
.host;

969 
u
->
»sÞved
->
pÜt
 = (
š_pÜt_t
è(
u¾
.
no_pÜt
 ?…ort : url.port);

970 
u
->
»sÞved
->
no_pÜt
 = 
u¾
.no_port;

973  
NGX_OK
;

974 
	}
}

977 #ià(
NGX_HTTP_CACHE
)

979 
ngx_št_t


980 
	$ngx_h‰p_´oxy_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
)

982 
size_t
 
Ën
, 
loc_Ën
;

983 
u_ch¬
 *
p
;

984 
ušŒ_t
 
esÿ³
;

985 
ngx_¡r_t
 *
key
;

986 
ngx_h‰p_up¡»am_t
 *
u
;

987 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

988 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
;

990 
u
 = 
r
->
up¡»am
;

992 
¶cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_´oxy_moduË
);

994 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

996 
key
 = 
	`ngx_¬¿y_push
(&
r
->
ÿche
->
keys
);

997 ià(
key
 =ð
NULL
) {

998  
NGX_ERROR
;

1001 ià(
¶cf
->
ÿche_key
.
v®ue
.
d©a
) {

1003 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
¶cf
->
ÿche_key
, 
key
è!ð
NGX_OK
) {

1004  
NGX_ERROR
;

1007  
NGX_OK
;

1010 *
key
 = 
ùx
->
v¬s
.
key_¡¬t
;

1012 
key
 = 
	`ngx_¬¿y_push
(&
r
->
ÿche
->
keys
);

1013 ià(
key
 =ð
NULL
) {

1014  
NGX_ERROR
;

1017 ià(
¶cf
->
´oxy_Ëngths
 && 
ùx
->
v¬s
.
uri
.
Ën
) {

1019 *
key
 = 
ùx
->
v¬s
.
uri
;

1020 
u
->
uri
 = 
ùx
->
v¬s
.uri;

1022  
NGX_OK
;

1024 } ià(
ùx
->
v¬s
.
uri
.
Ën
 =ð0 && 
r
->
v®id_uÅ¬£d_uri
 &&„ =ðr->
maš
)

1026 *
key
 = 
r
->
uÅ¬£d_uri
;

1027 
u
->
uri
 = 
r
->
uÅ¬£d_uri
;

1029  
NGX_OK
;

1032 
loc_Ën
 = (
r
->
v®id_loÿtiÚ
 && 
ùx
->
v¬s
.
uri
.
Ën
è? 
¶cf
->
loÿtiÚ
.len : 0;

1034 ià(
r
->
quÙed_uri
 ||„->
š‹º®
) {

1035 
esÿ³
 = 2 * 
	`ngx_esÿ³_uri
(
NULL
, 
r
->
uri
.
d©a
 + 
loc_Ën
,

1036 
r
->
uri
.
Ën
 - 
loc_Ën
, 
NGX_ESCAPE_URI
);

1038 
esÿ³
 = 0;

1041 
Ën
 = 
ùx
->
v¬s
.
uri
.ËÀ+ 
r
->uri.ËÀ- 
loc_Ën
 + 
esÿ³


1042 + ("?"è- 1 + 
r
->
¬gs
.
Ën
;

1044 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

1045 ià(
p
 =ð
NULL
) {

1046  
NGX_ERROR
;

1049 
key
->
d©a
 = 
p
;

1051 ià(
r
->
v®id_loÿtiÚ
) {

1052 
p
 = 
	`ngx_cÝy
Õ, 
ùx
->
v¬s
.
uri
.
d©a
, ctx->v¬s.uri.
Ën
);

1055 ià(
esÿ³
) {

1056 
	`ngx_esÿ³_uri
(
p
, 
r
->
uri
.
d©a
 + 
loc_Ën
,

1057 
r
->
uri
.
Ën
 - 
loc_Ën
, 
NGX_ESCAPE_URI
);

1058 
p
 +ð
r
->
uri
.
Ën
 - 
loc_Ën
 + 
esÿ³
;

1061 
p
 = 
	`ngx_cÝy
Õ, 
r
->
uri
.
d©a
 + 
loc_Ën
,„->uri.
Ën
 -†oc_len);

1064 ià(
r
->
¬gs
.
Ën
 > 0) {

1065 *
p
++ = '?';

1066 
p
 = 
	`ngx_cÝy
Õ, 
r
->
¬gs
.
d©a
,„->¬gs.
Ën
);

1069 
key
->
Ën
 = 
p
 - key->
d©a
;

1070 
u
->
uri
 = *
key
;

1072  
NGX_OK
;

1073 
	}
}

1078 
ngx_št_t


1079 
	$ngx_h‰p_´oxy_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

1081 
size_t
 
Ën
, 
uri_Ën
, 
loc_Ën
, 
body_Ën
;

1082 
ušŒ_t
 
esÿ³
;

1083 
ngx_buf_t
 *
b
;

1084 
ngx_¡r_t
 
m‘hod
;

1085 
ngx_ušt_t
 
i
, 
uÅ¬£d_uri
;

1086 
ngx_chaš_t
 *
þ
, *
body
;

1087 
ngx_li¡_·¹_t
 *
·¹
;

1088 
ngx_bË_–t_t
 *
h—d”
;

1089 
ngx_h‰p_up¡»am_t
 *
u
;

1090 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

1091 
ngx_h‰p_süt_code_±
 
code
;

1092 
ngx_h‰p_´oxy_h—d”s_t
 *
h—d”s
;

1093 
ngx_h‰p_süt_’gše_t
 
e
, 
Ë
;

1094 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
;

1095 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

1097 
u
 = 
r
->
up¡»am
;

1099 
¶cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_´oxy_moduË
);

1101 #ià(
NGX_HTTP_CACHE
)

1102 
h—d”s
 = 
u
->
ÿch—bË
 ? &
¶cf
->
h—d”s_ÿche
 : &plcf->headers;

1104 
h—d”s
 = &
¶cf
->headers;

1107 ià(
u
->
m‘hod
.
Ën
) {

1109 
m‘hod
 = 
u
->method;

1110 
m‘hod
.
Ën
++;

1112 } ià(
¶cf
->
m‘hod
.
Ën
) {

1113 
m‘hod
 = 
¶cf
->method;

1116 
m‘hod
 = 
r
->
m‘hod_Çme
;

1117 
m‘hod
.
Ën
++;

1120 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

1122 ià(
m‘hod
.
Ën
 == 5

1123 && 
	`ngx_¡ºÿ£cmp
(
m‘hod
.
d©a
, (
u_ch¬
 *) "HEAD ", 5) == 0)

1125 
ùx
->
h—d
 = 1;

1128 
Ën
 = 
m‘hod
.ËÀ+ (
ngx_h‰p_´oxy_v”siÚ
è- 1 + (
CRLF
) - 1;

1130 
esÿ³
 = 0;

1131 
loc_Ën
 = 0;

1132 
uÅ¬£d_uri
 = 0;

1134 ià(
¶cf
->
´oxy_Ëngths
 && 
ùx
->
v¬s
.
uri
.
Ën
) {

1135 
uri_Ën
 = 
ùx
->
v¬s
.
uri
.
Ën
;

1137 } ià(
ùx
->
v¬s
.
uri
.
Ën
 =ð0 && 
r
->
v®id_uÅ¬£d_uri
 &&„ =ðr->
maš
)

1139 
uÅ¬£d_uri
 = 1;

1140 
uri_Ën
 = 
r
->
uÅ¬£d_uri
.
Ën
;

1143 
loc_Ën
 = (
r
->
v®id_loÿtiÚ
 && 
ùx
->
v¬s
.
uri
.
Ën
) ?

1144 
¶cf
->
loÿtiÚ
.
Ën
 : 0;

1146 ià(
r
->
quÙed_uri
 ||„->
¥aû_š_uri
 ||„->
š‹º®
) {

1147 
esÿ³
 = 2 * 
	`ngx_esÿ³_uri
(
NULL
, 
r
->
uri
.
d©a
 + 
loc_Ën
,

1148 
r
->
uri
.
Ën
 - 
loc_Ën
, 
NGX_ESCAPE_URI
);

1151 
uri_Ën
 = 
ùx
->
v¬s
.
uri
.
Ën
 + 
r
->uri.ËÀ- 
loc_Ën
 + 
esÿ³


1152 + ("?"è- 1 + 
r
->
¬gs
.
Ën
;

1155 ià(
uri_Ën
 == 0) {

1156 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1158  
NGX_ERROR
;

1161 
Ën
 +ð
uri_Ën
;

1163 
	`ngx_memz”o
(&
Ë
, (
ngx_h‰p_süt_’gše_t
));

1165 
	`ngx_h‰p_süt_æush_no_ÿch—bË_v¬ŸbËs
(
r
, 
¶cf
->
body_æushes
);

1166 
	`ngx_h‰p_süt_æush_no_ÿch—bË_v¬ŸbËs
(
r
, 
h—d”s
->
æushes
);

1168 ià(
¶cf
->
body_Ëngths
) {

1169 
Ë
.

 = 
¶cf
->
body_Ëngths
->
–ts
;

1170 
Ë
.
»que¡
 = 
r
;

1171 
Ë
.
æushed
 = 1;

1172 
body_Ën
 = 0;

1174 *(
ušŒ_t
 *è
Ë
.

) {

1175 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

1176 
body_Ën
 +ð
	`lcode
(&
Ë
);

1179 
ùx
->
š‹º®_body_Ëngth
 = 
body_Ën
;

1180 
Ën
 +ð
body_Ën
;

1183 
ùx
->
š‹º®_body_Ëngth
 = 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
;

1186 
Ë
.

 = 
h—d”s
->
Ëngths
->
–ts
;

1187 
Ë
.
»que¡
 = 
r
;

1188 
Ë
.
æushed
 = 1;

1190 *(
ušŒ_t
 *è
Ë
.

) {

1191 *(
ušŒ_t
 *è
Ë
.

) {

1192 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

1193 
Ën
 +ð
	`lcode
(&
Ë
);

1195 
Ë
.

 +ð(
ušŒ_t
);

1199 ià(
¶cf
->
up¡»am
.
·ss_»que¡_h—d”s
) {

1200 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

1201 
h—d”
 = 
·¹
->
–ts
;

1203 
i
 = 0; ; i++) {

1205 ià(
i
 >ð
·¹
->
ÃÉs
) {

1206 ià(
·¹
->
Ãxt
 =ð
NULL
) {

1210 
·¹
 =…¬t->
Ãxt
;

1211 
h—d”
 = 
·¹
->
–ts
;

1212 
i
 = 0;

1215 ià(
	`ngx_hash_fšd
(&
h—d”s
->
hash
, 
h—d”
[
i
].hash,

1216 
h—d”
[
i
].
lowÿ£_key
, h—d”[i].
key
.
Ën
))

1221 
Ën
 +ð
h—d”
[
i
].
key
.len + (": ") - 1

1222 + 
h—d”
[
i
].
v®ue
.
Ën
 + (
CRLF
) - 1;

1227 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
Ën
);

1228 ià(
b
 =ð
NULL
) {

1229  
NGX_ERROR
;

1232 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

1233 ià(
þ
 =ð
NULL
) {

1234  
NGX_ERROR
;

1237 
þ
->
buf
 = 
b
;

1242 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
m‘hod
.
d©a
, m‘hod.
Ën
);

1244 
u
->
uri
.
d©a
 = 
b
->
Ï¡
;

1246 ià(
¶cf
->
´oxy_Ëngths
 && 
ùx
->
v¬s
.
uri
.
Ën
) {

1247 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
ùx
->
v¬s
.
uri
.
d©a
, ctx->v¬s.uri.
Ën
);

1249 } ià(
uÅ¬£d_uri
) {

1250 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
r
->
uÅ¬£d_uri
.
d©a
,„->uÅ¬£d_uri.
Ën
);

1253 ià(
r
->
v®id_loÿtiÚ
) {

1254 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
ùx
->
v¬s
.
uri
.
d©a
, ctx->v¬s.uri.
Ën
);

1257 ià(
esÿ³
) {

1258 
	`ngx_esÿ³_uri
(
b
->
Ï¡
, 
r
->
uri
.
d©a
 + 
loc_Ën
,

1259 
r
->
uri
.
Ën
 - 
loc_Ën
, 
NGX_ESCAPE_URI
);

1260 
b
->
Ï¡
 +ð
r
->
uri
.
Ën
 - 
loc_Ën
 + 
esÿ³
;

1263 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
r
->
uri
.
d©a
 + 
loc_Ën
,

1264 
r
->
uri
.
Ën
 - 
loc_Ën
);

1267 ià(
r
->
¬gs
.
Ën
 > 0) {

1268 *
b
->
Ï¡
++ = '?';

1269 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
r
->
¬gs
.
d©a
,„->¬gs.
Ën
);

1273 
u
->
uri
.
Ën
 = 
b
->
Ï¡
 - u->uri.
d©a
;

1275 ià(
¶cf
->
h‰p_v”siÚ
 =ð
NGX_HTTP_VERSION_11
) {

1276 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
ngx_h‰p_´oxy_v”siÚ_11
,

1277 (
ngx_h‰p_´oxy_v”siÚ_11
) - 1);

1280 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
ngx_h‰p_´oxy_v”siÚ
,

1281 (
ngx_h‰p_´oxy_v”siÚ
) - 1);

1284 
	`ngx_memz”o
(&
e
, (
ngx_h‰p_süt_’gše_t
));

1286 
e
.

 = 
h—d”s
->
v®ues
->
–ts
;

1287 
e
.
pos
 = 
b
->
Ï¡
;

1288 
e
.
»que¡
 = 
r
;

1289 
e
.
æushed
 = 1;

1291 
Ë
.

 = 
h—d”s
->
Ëngths
->
–ts
;

1293 *(
ušŒ_t
 *è
Ë
.

) {

1294 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

1297 (è
	`lcode
(&
Ë
);

1299 ià(*(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

) {

1301 
Ën
 = 0; *(
ušŒ_t
 *è
Ë
.

;†’ +ð
	`lcode
(&le)) {

1302 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

1305 
e
.
sk
 = (
Ën
 =ð(
CRLF
) - 1) ? 1 : 0;

1308 
e
.
sk
 = 0;

1311 
Ë
.

 +ð(
ušŒ_t
);

1313 *(
ušŒ_t
 *è
e
.

) {

1314 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

1315 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

1317 
e
.

 +ð(
ušŒ_t
);

1320 
b
->
Ï¡
 = 
e
.
pos
;

1323 ià(
¶cf
->
up¡»am
.
·ss_»que¡_h—d”s
) {

1324 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

1325 
h—d”
 = 
·¹
->
–ts
;

1327 
i
 = 0; ; i++) {

1329 ià(
i
 >ð
·¹
->
ÃÉs
) {

1330 ià(
·¹
->
Ãxt
 =ð
NULL
) {

1334 
·¹
 =…¬t->
Ãxt
;

1335 
h—d”
 = 
·¹
->
–ts
;

1336 
i
 = 0;

1339 ià(
	`ngx_hash_fšd
(&
h—d”s
->
hash
, 
h—d”
[
i
].hash,

1340 
h—d”
[
i
].
lowÿ£_key
, h—d”[i].
key
.
Ën
))

1345 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
h—d”
[
i
].
key
.
d©a
, h—d”[i].key.
Ën
);

1347 *
b
->
Ï¡
++ = ':'; *b->last++ = ' ';

1349 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
h—d”
[
i
].
v®ue
.
d©a
,

1350 
h—d”
[
i
].
v®ue
.
Ën
);

1352 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1354 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1356 &
h—d”
[
i
].
key
, &h—d”[i].
v®ue
);

1362 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1364 ià(
¶cf
->
body_v®ues
) {

1365 
e
.

 = 
¶cf
->
body_v®ues
->
–ts
;

1366 
e
.
pos
 = 
b
->
Ï¡
;

1368 *(
ušŒ_t
 *è
e
.

) {

1369 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

1370 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

1373 
b
->
Ï¡
 = 
e
.
pos
;

1376 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1378 (
size_t
è(
b
->
Ï¡
 - b->
pos
), b->pos);

1380 ià(
¶cf
->
body_v®ues
 =ð
NULL
 &&…lcf->
up¡»am
.
·ss_»que¡_body
) {

1382 
body
 = 
u
->
»que¡_bufs
;

1383 
u
->
»que¡_bufs
 = 
þ
;

1385 
body
) {

1386 
b
 = 
	`ngx_®loc_buf
(
r
->
poÞ
);

1387 ià(
b
 =ð
NULL
) {

1388  
NGX_ERROR
;

1391 
	`ngx_memýy
(
b
, 
body
->
buf
, (
ngx_buf_t
));

1393 
þ
->
Ãxt
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

1394 ià(
þ
->
Ãxt
 =ð
NULL
) {

1395  
NGX_ERROR
;

1398 
þ
 = cl->
Ãxt
;

1399 
þ
->
buf
 = 
b
;

1401 
body
 = body->
Ãxt
;

1405 
u
->
»que¡_bufs
 = 
þ
;

1408 
b
->
æush
 = 1;

1409 
þ
->
Ãxt
 = 
NULL
;

1411  
NGX_OK
;

1412 
	}
}

1415 
ngx_št_t


1416 
	$ngx_h‰p_´oxy_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

1418 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

1420 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

1422 ià(
ùx
 =ð
NULL
) {

1423  
NGX_OK
;

1426 
ùx
->
¡©us
.
code
 = 0;

1427 
ùx
->
¡©us
.
couÁ
 = 0;

1428 
ùx
->
¡©us
.
¡¬t
 = 
NULL
;

1429 
ùx
->
¡©us
.
’d
 = 
NULL
;

1430 
ùx
->
chunked
.
¡©e
 = 0;

1432 
r
->
up¡»am
->
´oûss_h—d”
 = 
ngx_h‰p_´oxy_´oûss_¡©us_lše
;

1433 
r
->
up¡»am
->
pe
->
šput_fž‹r
 = 
ngx_h‰p_´oxy_cÝy_fž‹r
;

1434 
r
->
up¡»am
->
šput_fž‹r
 = 
ngx_h‰p_´oxy_nÚ_bufã»d_cÝy_fž‹r
;

1435 
r
->
¡©e
 = 0;

1437  
NGX_OK
;

1438 
	}
}

1441 
ngx_št_t


1442 
	$ngx_h‰p_´oxy_´oûss_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
)

1444 
size_t
 
Ën
;

1445 
ngx_št_t
 
rc
;

1446 
ngx_h‰p_up¡»am_t
 *
u
;

1447 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

1449 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

1451 ià(
ùx
 =ð
NULL
) {

1452  
NGX_ERROR
;

1455 
u
 = 
r
->
up¡»am
;

1457 
rc
 = 
	`ngx_h‰p_·r£_¡©us_lše
(
r
, &
u
->
bufãr
, &
ùx
->
¡©us
);

1459 ià(
rc
 =ð
NGX_AGAIN
) {

1460  
rc
;

1463 ià(
rc
 =ð
NGX_ERROR
) {

1465 #ià(
NGX_HTTP_CACHE
)

1467 ià(
r
->
ÿche
) {

1468 
r
->
h‰p_v”siÚ
 = 
NGX_HTTP_VERSION_9
;

1469  
NGX_OK
;

1474 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1478 ià(
u
->
acûl
) {

1479  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1483 
r
->
h‰p_v”siÚ
 = 
NGX_HTTP_VERSION_9
;

1484 
u
->
¡©e
->
¡©us
 = 
NGX_HTTP_OK
;

1485 
u
->
h—d”s_š
.
cÚÃùiÚ_þo£
 = 1;

1487  
NGX_OK
;

1490 ià(
u
->
¡©e
 && u->¡©e->
¡©us
 == 0) {

1491 
u
->
¡©e
->
¡©us
 = 
ùx
->¡©us.
code
;

1494 
u
->
h—d”s_š
.
¡©us_n
 = 
ùx
->
¡©us
.
code
;

1496 
Ën
 = 
ùx
->
¡©us
.
’d
 - ctx->¡©us.
¡¬t
;

1497 
u
->
h—d”s_š
.
¡©us_lše
.
Ën
 =†en;

1499 
u
->
h—d”s_š
.
¡©us_lše
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

1500 ià(
u
->
h—d”s_š
.
¡©us_lše
.
d©a
 =ð
NULL
) {

1501  
NGX_ERROR
;

1504 
	`ngx_memýy
(
u
->
h—d”s_š
.
¡©us_lše
.
d©a
, 
ùx
->
¡©us
.
¡¬t
, 
Ën
);

1506 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1508 
u
->
h—d”s_š
.
¡©us_n
, &u->h—d”s_š.
¡©us_lše
);

1510 ià(
ùx
->
¡©us
.
h‰p_v”siÚ
 < 
NGX_HTTP_VERSION_11
) {

1511 
u
->
h—d”s_š
.
cÚÃùiÚ_þo£
 = 1;

1514 
u
->
´oûss_h—d”
 = 
ngx_h‰p_´oxy_´oûss_h—d”
;

1516  
	`ngx_h‰p_´oxy_´oûss_h—d”
(
r
);

1517 
	}
}

1520 
ngx_št_t


1521 
	$ngx_h‰p_´oxy_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

1523 
ngx_št_t
 
rc
;

1524 
ngx_bË_–t_t
 *
h
;

1525 
ngx_h‰p_up¡»am_t
 *
u
;

1526 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

1527 
ngx_h‰p_up¡»am_h—d”_t
 *
hh
;

1528 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

1530 
umcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_up¡»am_moduË
);

1534 
rc
 = 
	`ngx_h‰p_·r£_h—d”_lše
(
r
, &r->
up¡»am
->
bufãr
, 1);

1536 ià(
rc
 =ð
NGX_OK
) {

1540 
h
 = 
	`ngx_li¡_push
(&
r
->
up¡»am
->
h—d”s_š
.
h—d”s
);

1541 ià(
h
 =ð
NULL
) {

1542  
NGX_ERROR
;

1545 
h
->
hash
 = 
r
->
h—d”_hash
;

1547 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

1548 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

1550 
h
->
key
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

1551 
h
->
key
.
Ën
 + 1 + h->
v®ue
.len + 1 + h->key.len);

1552 ià(
h
->
key
.
d©a
 =ð
NULL
) {

1553  
NGX_ERROR
;

1556 
h
->
v®ue
.
d©a
 = h->
key
.d©¨+ h->key.
Ën
 + 1;

1557 
h
->
lowÿ£_key
 = h->
key
.
d©a
 + h->key.
Ën
 + 1 + h->
v®ue
.len + 1;

1559 
	`ngx_memýy
(
h
->
key
.
d©a
, 
r
->
h—d”_Çme_¡¬t
, h->key.
Ën
);

1560 
h
->
key
.
d©a
[h->key.
Ën
] = '\0';

1561 
	`ngx_memýy
(
h
->
v®ue
.
d©a
, 
r
->
h—d”_¡¬t
, h->v®ue.
Ën
);

1562 
h
->
v®ue
.
d©a
[h->v®ue.
Ën
] = '\0';

1564 ià(
h
->
key
.
Ën
 =ð
r
->
lowÿ£_šdex
) {

1565 
	`ngx_memýy
(
h
->
lowÿ£_key
, 
r
->
lowÿ£_h—d”
, h->
key
.
Ën
);

1568 
	`ngx_¡¾ow
(
h
->
lowÿ£_key
, h->
key
.
d©a
, h->key.
Ën
);

1571 
hh
 = 
	`ngx_hash_fšd
(&
umcf
->
h—d”s_š_hash
, 
h
->
hash
,

1572 
h
->
lowÿ£_key
, h->
key
.
Ën
);

1574 ià(
hh
 && hh->
	`hªdËr
(
r
, 
h
, hh->
off£t
è!ð
NGX_OK
) {

1575  
NGX_ERROR
;

1578 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1580 &
h
->
key
, &h->
v®ue
);

1585 ià(
rc
 =ð
NGX_HTTP_PARSE_HEADER_DONE
) {

1589 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1597 ià(
r
->
up¡»am
->
h—d”s_š
.
£rv”
 =ð
NULL
) {

1598 
h
 = 
	`ngx_li¡_push
(&
r
->
up¡»am
->
h—d”s_š
.
h—d”s
);

1599 ià(
h
 =ð
NULL
) {

1600  
NGX_ERROR
;

1603 
h
->
hash
 = 
	`ngx_hash
(ngx_hash(ngx_hash(ngx_hash(

1604 
	`ngx_hash
('s', 'e'), 'r'), 'v'), 'e'), 'r');

1606 
	`ngx_¡r_£t
(&
h
->
key
, "Server");

1607 
	`ngx_¡r_nuÎ
(&
h
->
v®ue
);

1608 
h
->
lowÿ£_key
 = (
u_ch¬
 *) "server";

1611 ià(
r
->
up¡»am
->
h—d”s_š
.
d©e
 =ð
NULL
) {

1612 
h
 = 
	`ngx_li¡_push
(&
r
->
up¡»am
->
h—d”s_š
.
h—d”s
);

1613 ià(
h
 =ð
NULL
) {

1614  
NGX_ERROR
;

1617 
h
->
hash
 = 
	`ngx_hash
(ngx_hash(ngx_hash('d', 'a'), 't'), 'e');

1619 
	`ngx_¡r_£t
(&
h
->
key
, "Date");

1620 
	`ngx_¡r_nuÎ
(&
h
->
v®ue
);

1621 
h
->
lowÿ£_key
 = (
u_ch¬
 *) "date";

1626 
u
 = 
r
->
up¡»am
;

1628 ià(
u
->
h—d”s_š
.
chunked
) {

1629 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = -1;

1637 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

1639 ià(
u
->
h—d”s_š
.
¡©us_n
 =ð
NGX_HTTP_NO_CONTENT


1640 || 
u
->
h—d”s_š
.
¡©us_n
 =ð
NGX_HTTP_NOT_MODIFIED


1641 || 
ùx
->
h—d


1642 || (!
u
->
h—d”s_š
.
chunked


1643 && 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 == 0))

1645 
u
->
k“·live
 = !u->
h—d”s_š
.
cÚÃùiÚ_þo£
;

1648 ià(
u
->
h—d”s_š
.
¡©us_n
 =ð
NGX_HTTP_SWITCHING_PROTOCOLS
) {

1649 
u
->
k“·live
 = 0;

1651 ià(
r
->
h—d”s_š
.
upg¿de
) {

1652 
u
->
upg¿de
 = 1;

1656  
NGX_OK
;

1659 ià(
rc
 =ð
NGX_AGAIN
) {

1660  
NGX_AGAIN
;

1665 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1668  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1670 
	}
}

1673 
ngx_št_t


1674 
	$ngx_h‰p_´oxy_šput_fž‹r_š™
(*
d©a
)

1676 
ngx_h‰p_»que¡_t
 *
r
 = 
d©a
;

1677 
ngx_h‰p_up¡»am_t
 *
u
;

1678 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

1680 
u
 = 
r
->
up¡»am
;

1681 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

1683 ià(
ùx
 =ð
NULL
) {

1684  
NGX_ERROR
;

1687 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1689 
u
->
h—d”s_š
.
¡©us_n
, 
ùx
->
h—d
, u->h—d”s_š.
chunked
,

1690 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
);

1694 ià(
u
->
h—d”s_š
.
¡©us_n
 =ð
NGX_HTTP_NO_CONTENT


1695 || 
u
->
h—d”s_š
.
¡©us_n
 =ð
NGX_HTTP_NOT_MODIFIED


1696 || 
ùx
->
h—d
)

1701 
u
->
pe
->
Ëngth
 = 0;

1702 
u
->
Ëngth
 = 0;

1703 
u
->
k“·live
 = !u->
h—d”s_š
.
cÚÃùiÚ_þo£
;

1705 } ià(
u
->
h—d”s_š
.
chunked
) {

1708 
u
->
pe
->
šput_fž‹r
 = 
ngx_h‰p_´oxy_chunked_fž‹r
;

1709 
u
->
pe
->
Ëngth
 = 3;

1711 
u
->
šput_fž‹r
 = 
ngx_h‰p_´oxy_nÚ_bufã»d_chunked_fž‹r
;

1712 
u
->
Ëngth
 = 1;

1714 } ià(
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 == 0) {

1717 
u
->
pe
->
Ëngth
 = 0;

1718 
u
->
Ëngth
 = 0;

1719 
u
->
k“·live
 = !u->
h—d”s_š
.
cÚÃùiÚ_þo£
;

1724 
u
->
pe
->
Ëngth
 = u->
h—d”s_š
.
cÚ‹Á_Ëngth_n
;

1725 
u
->
Ëngth
 = u->
h—d”s_š
.
cÚ‹Á_Ëngth_n
;

1728  
NGX_OK
;

1729 
	}
}

1732 
ngx_št_t


1733 
	$ngx_h‰p_´oxy_cÝy_fž‹r
(
ngx_ev’t_pe_t
 *
p
, 
ngx_buf_t
 *
buf
)

1735 
ngx_buf_t
 *
b
;

1736 
ngx_chaš_t
 *
þ
;

1737 
ngx_h‰p_»que¡_t
 *
r
;

1739 ià(
buf
->
pos
 =ðbuf->
Ï¡
) {

1740  
NGX_OK
;

1743 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
p
->
poÞ
, &p->
ä“
);

1744 ià(
þ
 =ð
NULL
) {

1745  
NGX_ERROR
;

1748 
b
 = 
þ
->
buf
;

1750 
	`ngx_memýy
(
b
, 
buf
, (
ngx_buf_t
));

1751 
b
->
shadow
 = 
buf
;

1752 
b
->
g
 = 
p
->tag;

1753 
b
->
Ï¡_shadow
 = 1;

1754 
b
->
»cyþed
 = 1;

1755 
buf
->
shadow
 = 
b
;

1757 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0, "špuˆbuà#%d", 
b
->
num
);

1759 ià(
p
->
š
) {

1760 *
p
->
Ï¡_š
 = 
þ
;

1762 
p
->
š
 = 
þ
;

1764 
p
->
Ï¡_š
 = &
þ
->
Ãxt
;

1766 ià(
p
->
Ëngth
 == -1) {

1767  
NGX_OK
;

1770 
p
->
Ëngth
 -ð
b
->
Ï¡
 - b->
pos
;

1772 ià(
p
->
Ëngth
 == 0) {

1773 
r
 = 
p
->
šput_ùx
;

1774 
p
->
up¡»am_dÚe
 = 1;

1775 
r
->
up¡»am
->
k“·live
 = !r->up¡»am->
h—d”s_š
.
cÚÃùiÚ_þo£
;

1777 } ià(
p
->
Ëngth
 < 0) {

1778 
r
 = 
p
->
šput_ùx
;

1779 
p
->
up¡»am_dÚe
 = 1;

1781 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
r
->
cÚÃùiÚ
->
log
, 0,

1786  
NGX_OK
;

1787 
	}
}

1790 
ngx_št_t


1791 
	$ngx_h‰p_´oxy_chunked_fž‹r
(
ngx_ev’t_pe_t
 *
p
, 
ngx_buf_t
 *
buf
)

1793 
ngx_št_t
 
rc
;

1794 
ngx_buf_t
 *
b
, **
´ev
;

1795 
ngx_chaš_t
 *
þ
;

1796 
ngx_h‰p_»que¡_t
 *
r
;

1797 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

1799 ià(
buf
->
pos
 =ðbuf->
Ï¡
) {

1800  
NGX_OK
;

1803 
r
 = 
p
->
šput_ùx
;

1804 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

1806 ià(
ùx
 =ð
NULL
) {

1807  
NGX_ERROR
;

1810 
b
 = 
NULL
;

1811 
´ev
 = &
buf
->
shadow
;

1815 
rc
 = 
	`ngx_h‰p_·r£_chunked
(
r
, 
buf
, &
ùx
->
chunked
);

1817 ià(
rc
 =ð
NGX_OK
) {

1821 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
p
->
poÞ
, &p->
ä“
);

1822 ià(
þ
 =ð
NULL
) {

1823  
NGX_ERROR
;

1826 
b
 = 
þ
->
buf
;

1828 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

1830 
b
->
pos
 = 
buf
->pos;

1831 
b
->
¡¬t
 = 
buf
->start;

1832 
b
->
’d
 = 
buf
->end;

1833 
b
->
g
 = 
p
->tag;

1834 
b
->
‹mpÜ¬y
 = 1;

1835 
b
->
»cyþed
 = 1;

1837 *
´ev
 = 
b
;

1838 
´ev
 = &
b
->
shadow
;

1840 ià(
p
->
š
) {

1841 *
p
->
Ï¡_š
 = 
þ
;

1843 
p
->
š
 = 
þ
;

1845 
p
->
Ï¡_š
 = &
þ
->
Ãxt
;

1847  
b
->
num
 = 
buf
->num;

1849 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

1850 "špuˆbuà#%d %p", 
b
->
num
, b->
pos
);

1852 ià(
buf
->
Ï¡
 - buf->
pos
 >ð
ùx
->
chunked
.
size
) {

1854 
buf
->
pos
 +ð(
size_t
è
ùx
->
chunked
.
size
;

1855 
b
->
Ï¡
 = 
buf
->
pos
;

1856 
ùx
->
chunked
.
size
 = 0;

1861 
ùx
->
chunked
.
size
 -ð
buf
->
Ï¡
 - buf->
pos
;

1862 
buf
->
pos
 = buf->
Ï¡
;

1863 
b
->
Ï¡
 = 
buf
->last;

1868 ià(
rc
 =ð
NGX_DONE
) {

1872 
p
->
up¡»am_dÚe
 = 1;

1873 
r
->
up¡»am
->
k“·live
 = !r->up¡»am->
h—d”s_š
.
cÚÃùiÚ_þo£
;

1878 ià(
rc
 =ð
NGX_AGAIN
) {

1882 
p
->
Ëngth
 = 
ùx
->
chunked
.length;

1889 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1892  
NGX_ERROR
;

1895 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1897 
ùx
->
chunked
.
¡©e
, 
p
->
Ëngth
);

1899 ià(
b
) {

1900 
b
->
shadow
 = 
buf
;

1901 
b
->
Ï¡_shadow
 = 1;

1903 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
p
->
log
, 0,

1904 "špuˆbuà%°%z", 
b
->
pos
, b->
Ï¡
 - b->pos);

1906  
NGX_OK
;

1911 ià(
	`ngx_ev’t_pe_add_ä“_buf
(
p
, 
buf
è!ð
NGX_OK
) {

1912  
NGX_ERROR
;

1915  
NGX_OK
;

1916 
	}
}

1919 
ngx_št_t


1920 
	$ngx_h‰p_´oxy_nÚ_bufã»d_cÝy_fž‹r
(*
d©a
, 
ssize_t
 
by‹s
)

1922 
ngx_h‰p_»que¡_t
 *
r
 = 
d©a
;

1924 
ngx_buf_t
 *
b
;

1925 
ngx_chaš_t
 *
þ
, **
Î
;

1926 
ngx_h‰p_up¡»am_t
 *
u
;

1928 
u
 = 
r
->
up¡»am
;

1930 
þ
 = 
u
->
out_bufs
, 
Î
 = &u->out_bufs; cl; cÈðþ->
Ãxt
) {

1931 
Î
 = &
þ
->
Ãxt
;

1934 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
u
->
ä“_bufs
);

1935 ià(
þ
 =ð
NULL
) {

1936  
NGX_ERROR
;

1939 *
Î
 = 
þ
;

1941 
þ
->
buf
->
æush
 = 1;

1942 
þ
->
buf
->
memÜy
 = 1;

1944 
b
 = &
u
->
bufãr
;

1946 
þ
->
buf
->
pos
 = 
b
->
Ï¡
;

1947 
b
->
Ï¡
 +ð
by‹s
;

1948 
þ
->
buf
->
Ï¡
 = 
b
->last;

1949 
þ
->
buf
->
g
 = 
u
->
ouut
.tag;

1951 ià(
u
->
Ëngth
 == -1) {

1952  
NGX_OK
;

1955 
u
->
Ëngth
 -ð
by‹s
;

1957 ià(
u
->
Ëngth
 == 0) {

1958 
u
->
k“·live
 = !u->
h—d”s_š
.
cÚÃùiÚ_þo£
;

1961  
NGX_OK
;

1962 
	}
}

1965 
ngx_št_t


1966 
	$ngx_h‰p_´oxy_nÚ_bufã»d_chunked_fž‹r
(*
d©a
, 
ssize_t
 
by‹s
)

1968 
ngx_h‰p_»que¡_t
 *
r
 = 
d©a
;

1970 
ngx_št_t
 
rc
;

1971 
ngx_buf_t
 *
b
, *
buf
;

1972 
ngx_chaš_t
 *
þ
, **
Î
;

1973 
ngx_h‰p_up¡»am_t
 *
u
;

1974 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

1976 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

1978 ià(
ùx
 =ð
NULL
) {

1979  
NGX_ERROR
;

1982 
u
 = 
r
->
up¡»am
;

1983 
buf
 = &
u
->
bufãr
;

1985 
buf
->
pos
 = buf->
Ï¡
;

1986 
buf
->
Ï¡
 +ð
by‹s
;

1988 
þ
 = 
u
->
out_bufs
, 
Î
 = &u->out_bufs; cl; cÈðþ->
Ãxt
) {

1989 
Î
 = &
þ
->
Ãxt
;

1994 
rc
 = 
	`ngx_h‰p_·r£_chunked
(
r
, 
buf
, &
ùx
->
chunked
);

1996 ià(
rc
 =ð
NGX_OK
) {

2000 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
u
->
ä“_bufs
);

2001 ià(
þ
 =ð
NULL
) {

2002  
NGX_ERROR
;

2005 *
Î
 = 
þ
;

2006 
Î
 = &
þ
->
Ãxt
;

2008 
b
 = 
þ
->
buf
;

2010 
b
->
æush
 = 1;

2011 
b
->
memÜy
 = 1;

2013 
b
->
pos
 = 
buf
->pos;

2014 
b
->
g
 = 
u
->
ouut
.tag;

2016 ià(
buf
->
Ï¡
 - buf->
pos
 >ð
ùx
->
chunked
.
size
) {

2017 
buf
->
pos
 +ð(
size_t
è
ùx
->
chunked
.
size
;

2018 
b
->
Ï¡
 = 
buf
->
pos
;

2019 
ùx
->
chunked
.
size
 = 0;

2022 
ùx
->
chunked
.
size
 -ð
buf
->
Ï¡
 - buf->
pos
;

2023 
buf
->
pos
 = buf->
Ï¡
;

2024 
b
->
Ï¡
 = 
buf
->last;

2027 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2029 
b
->
pos
, b->
Ï¡
 - b->pos);

2034 ià(
rc
 =ð
NGX_DONE
) {

2038 
u
->
k“·live
 = !u->
h—d”s_š
.
cÚÃùiÚ_þo£
;

2039 
u
->
Ëngth
 = 0;

2044 ià(
rc
 =ð
NGX_AGAIN
) {

2050 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2053  
NGX_ERROR
;

2058 ià(
r
->
sub»que¡_š_memÜy
) {

2060 
þ
 = 
u
->
out_bufs
;

2062 ià(
þ
) {

2063 
buf
->
pos
 = 
þ
->buf->pos;

2066 
buf
->
Ï¡
 = buf->
pos
;

2068 
þ
 = 
u
->
out_bufs
; cl; cÈðþ->
Ãxt
) {

2069 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2071 
þ
->
buf
->
pos
, cl->buf->
Ï¡
, 
	`ngx_buf_size
(cl->buf));

2073 ià(
buf
->
Ï¡
 =ð
þ
->buf->
pos
) {

2074 
buf
->
Ï¡
 = 
þ
->buf->last;

2078 
buf
->
Ï¡
 = 
	`ngx_movemem
(buf->Ï¡, 
þ
->buf->
pos
,

2079 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
);

2081 
þ
->
buf
->
pos
 = buf->
Ï¡
 - (cl->buf->last - cl->buf->pos);

2082 
þ
->
buf
->
Ï¡
 = buf->last;

2086  
NGX_OK
;

2087 
	}
}

2091 
	$ngx_h‰p_´oxy_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

2093 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2097 
	}
}

2101 
	$ngx_h‰p_´oxy_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

2103 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2107 
	}
}

2110 
ngx_št_t


2111 
	$ngx_h‰p_´oxy_ho¡_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

2112 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2114 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

2116 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

2118 ià(
ùx
 =ð
NULL
) {

2119 
v
->
nÙ_found
 = 1;

2120  
NGX_OK
;

2123 
v
->
Ën
 = 
ùx
->
v¬s
.
ho¡_h—d”
.len;

2124 
v
->
v®id
 = 1;

2125 
v
->
no_ÿch—bË
 = 0;

2126 
v
->
nÙ_found
 = 0;

2127 
v
->
d©a
 = 
ùx
->
v¬s
.
ho¡_h—d”
.data;

2129  
NGX_OK
;

2130 
	}
}

2133 
ngx_št_t


2134 
	$ngx_h‰p_´oxy_pÜt_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

2135 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2137 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

2139 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

2141 ià(
ùx
 =ð
NULL
) {

2142 
v
->
nÙ_found
 = 1;

2143  
NGX_OK
;

2146 
v
->
Ën
 = 
ùx
->
v¬s
.
pÜt
.len;

2147 
v
->
v®id
 = 1;

2148 
v
->
no_ÿch—bË
 = 0;

2149 
v
->
nÙ_found
 = 0;

2150 
v
->
d©a
 = 
ùx
->
v¬s
.
pÜt
.data;

2152  
NGX_OK
;

2153 
	}
}

2156 
ngx_št_t


2157 
	$ngx_h‰p_´oxy_add_x_fÜw¬ded_fÜ_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

2158 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2160 
size_t
 
Ën
;

2161 
u_ch¬
 *
p
;

2162 
ngx_ušt_t
 
i
, 
n
;

2163 
ngx_bË_–t_t
 **
h
;

2165 
v
->
v®id
 = 1;

2166 
v
->
no_ÿch—bË
 = 0;

2167 
v
->
nÙ_found
 = 0;

2169 
n
 = 
r
->
h—d”s_š
.
x_fÜw¬ded_fÜ
.
ÃÉs
;

2170 
h
 = 
r
->
h—d”s_š
.
x_fÜw¬ded_fÜ
.
–ts
;

2172 
Ën
 = 0;

2174 
i
 = 0; i < 
n
; i++) {

2175 
Ën
 +ð
h
[
i
]->
v®ue
.len + (", ") - 1;

2178 ià(
Ën
 == 0) {

2179 
v
->
Ën
 = 
r
->
cÚÃùiÚ
->
addr_‹xt
.len;

2180 
v
->
d©a
 = 
r
->
cÚÃùiÚ
->
addr_‹xt
.data;

2181  
NGX_OK
;

2184 
Ën
 +ð
r
->
cÚÃùiÚ
->
addr_‹xt
.len;

2186 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

2187 ià(
p
 =ð
NULL
) {

2188  
NGX_ERROR
;

2191 
v
->
Ën
 =†en;

2192 
v
->
d©a
 = 
p
;

2194 
i
 = 0; i < 
n
; i++) {

2195 
p
 = 
	`ngx_cÝy
Õ, 
h
[
i
]->
v®ue
.
d©a
, h[i]->v®ue.
Ën
);

2196 *
p
++ = ','; *p++ = ' ';

2199 
	`ngx_memýy
(
p
, 
r
->
cÚÃùiÚ
->
addr_‹xt
.
d©a
,„->cÚÃùiÚ->addr_‹xt.
Ën
);

2201  
NGX_OK
;

2202 
	}
}

2205 
ngx_št_t


2206 
	$ngx_h‰p_´oxy_š‹º®_body_Ëngth_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

2207 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2209 
ngx_h‰p_´oxy_ùx_t
 *
ùx
;

2211 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_´oxy_moduË
);

2213 ià(
ùx
 =ð
NULL
 || ctx->
š‹º®_body_Ëngth
 < 0) {

2214 
v
->
nÙ_found
 = 1;

2215  
NGX_OK
;

2218 
v
->
v®id
 = 1;

2219 
v
->
no_ÿch—bË
 = 0;

2220 
v
->
nÙ_found
 = 0;

2222 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_OFF_T_LEN
);

2224 ià(
v
->
d©a
 =ð
NULL
) {

2225  
NGX_ERROR
;

2228 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%O", 
ùx
->
š‹º®_body_Ëngth
) - v->data;

2230  
NGX_OK
;

2231 
	}
}

2234 
ngx_št_t


2235 
	$ngx_h‰p_´oxy_»wr™e_»dœeù
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

2236 
size_t
 
´efix
)

2238 
size_t
 
Ën
;

2239 
ngx_št_t
 
rc
;

2240 
ngx_ušt_t
 
i
;

2241 
ngx_h‰p_´oxy_»wr™e_t
 *
´
;

2242 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
;

2244 
¶cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_´oxy_moduË
);

2246 
´
 = 
¶cf
->
»dœeùs
->
–ts
;

2248 ià(
´
 =ð
NULL
) {

2249  
NGX_DECLINED
;

2252 
Ën
 = 
h
->
v®ue
.ËÀ- 
´efix
;

2254 
i
 = 0; i < 
¶cf
->
»dœeùs
->
ÃÉs
; i++) {

2255 
rc
 = 
´
[
i
].
	`hªdËr
(
r
, 
h
, 
´efix
, 
Ën
, &pr[i]);

2257 ià(
rc
 !ð
NGX_DECLINED
) {

2258  
rc
;

2262  
NGX_DECLINED
;

2263 
	}
}

2266 
ngx_št_t


2267 
	$ngx_h‰p_´oxy_»wr™e_cook›
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
)

2269 
size_t
 
´efix
;

2270 
u_ch¬
 *
p
;

2271 
ngx_št_t
 
rc
, 
rv
;

2272 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
;

2274 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(
h
->
v®ue
.
d©a
, ';');

2275 ià(
p
 =ð
NULL
) {

2276  
NGX_DECLINED
;

2279 
´efix
 = 
p
 + 1 - 
h
->
v®ue
.
d©a
;

2281 
rv
 = 
NGX_DECLINED
;

2283 
¶cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_´oxy_moduË
);

2285 ià(
¶cf
->
cook›_domašs
) {

2286 
p
 = 
	`ngx_¡rÿ£¡º
(
h
->
v®ue
.
d©a
 + 
´efix
, "domain=", 7 - 1);

2288 ià(
p
) {

2289 
rc
 = 
	`ngx_h‰p_´oxy_»wr™e_cook›_v®ue
(
r
, 
h
, 
p
 + 7,

2290 
¶cf
->
cook›_domašs
);

2291 ià(
rc
 =ð
NGX_ERROR
) {

2292  
NGX_ERROR
;

2295 ià(
rc
 !ð
NGX_DECLINED
) {

2296 
rv
 = 
rc
;

2301 ià(
¶cf
->
cook›_·ths
) {

2302 
p
 = 
	`ngx_¡rÿ£¡º
(
h
->
v®ue
.
d©a
 + 
´efix
, "path=", 5 - 1);

2304 ià(
p
) {

2305 
rc
 = 
	`ngx_h‰p_´oxy_»wr™e_cook›_v®ue
(
r
, 
h
, 
p
 + 5,

2306 
¶cf
->
cook›_·ths
);

2307 ià(
rc
 =ð
NGX_ERROR
) {

2308  
NGX_ERROR
;

2311 ià(
rc
 !ð
NGX_DECLINED
) {

2312 
rv
 = 
rc
;

2317  
rv
;

2318 
	}
}

2321 
ngx_št_t


2322 
	$ngx_h‰p_´oxy_»wr™e_cook›_v®ue
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

2323 
u_ch¬
 *
v®ue
, 
ngx_¬¿y_t
 *
»wr™es
)

2325 
size_t
 
Ën
, 
´efix
;

2326 
u_ch¬
 *
p
;

2327 
ngx_št_t
 
rc
;

2328 
ngx_ušt_t
 
i
;

2329 
ngx_h‰p_´oxy_»wr™e_t
 *
´
;

2331 
´efix
 = 
v®ue
 - 
h
->v®ue.
d©a
;

2333 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(
v®ue
, ';');

2335 
Ën
 = 
p
 ? (
size_t
èÕ - 
v®ue
è: (
h
->v®ue.ËÀ- 
´efix
);

2337 
´
 = 
»wr™es
->
–ts
;

2339 
i
 = 0; i < 
»wr™es
->
ÃÉs
; i++) {

2340 
rc
 = 
´
[
i
].
	`hªdËr
(
r
, 
h
, 
´efix
, 
Ën
, &pr[i]);

2342 ià(
rc
 !ð
NGX_DECLINED
) {

2343  
rc
;

2347  
NGX_DECLINED
;

2348 
	}
}

2351 
ngx_št_t


2352 
	$ngx_h‰p_´oxy_»wr™e_com¶ex_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

2353 
ngx_bË_–t_t
 *
h
, 
size_t
 
´efix
, size_ˆ
Ën
, 
ngx_h‰p_´oxy_»wr™e_t
 *
´
)

2355 
ngx_¡r_t
 
·‰”n
, 
»¶aûm’t
;

2357 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
´
->
·‰”n
.
com¶ex
, &·‰”nè!ð
NGX_OK
) {

2358  
NGX_ERROR
;

2361 ià(
·‰”n
.
Ën
 >†en

2362 || 
	`ngx_r¡ºcmp
(
h
->
v®ue
.
d©a
 + 
´efix
, 
·‰”n
.data,

2363 
·‰”n
.
Ën
) != 0)

2365  
NGX_DECLINED
;

2368 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
´
->
»¶aûm’t
, &»¶aûm’tè!ð
NGX_OK
) {

2369  
NGX_ERROR
;

2372  
	`ngx_h‰p_´oxy_»wr™e
(
r
, 
h
, 
´efix
, 
·‰”n
.
Ën
, &
»¶aûm’t
);

2373 
	}
}

2376 #ià(
NGX_PCRE
)

2378 
ngx_št_t


2379 
	$ngx_h‰p_´oxy_»wr™e_»gex_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

2380 
size_t
 
´efix
, size_ˆ
Ën
, 
ngx_h‰p_´oxy_»wr™e_t
 *
´
)

2382 
ngx_¡r_t
 
·‰”n
, 
»¶aûm’t
;

2384 
·‰”n
.
Ën
 =†en;

2385 
·‰”n
.
d©a
 = 
h
->
v®ue
.d©¨+ 
´efix
;

2387 ià(
	`ngx_h‰p_»gex_exec
(
r
, 
´
->
·‰”n
.
»gex
, &·‰”nè!ð
NGX_OK
) {

2388  
NGX_DECLINED
;

2391 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
´
->
»¶aûm’t
, &»¶aûm’tè!ð
NGX_OK
) {

2392  
NGX_ERROR
;

2395 ià(
´efix
 =ð0 && 
h
->
v®ue
.
Ën
 ==†en) {

2396 
h
->
v®ue
 = 
»¶aûm’t
;

2397  
NGX_OK
;

2400  
	`ngx_h‰p_´oxy_»wr™e
(
r
, 
h
, 
´efix
, 
Ën
, &
»¶aûm’t
);

2401 
	}
}

2406 
ngx_št_t


2407 
	$ngx_h‰p_´oxy_»wr™e_domaš_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

2408 
ngx_bË_–t_t
 *
h
, 
size_t
 
´efix
, size_ˆ
Ën
, 
ngx_h‰p_´oxy_»wr™e_t
 *
´
)

2410 
u_ch¬
 *
p
;

2411 
ngx_¡r_t
 
·‰”n
, 
»¶aûm’t
;

2413 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
´
->
·‰”n
.
com¶ex
, &·‰”nè!ð
NGX_OK
) {

2414  
NGX_ERROR
;

2417 
p
 = 
h
->
v®ue
.
d©a
 + 
´efix
;

2419 ià(
p
[0] == '.') {

2420 
p
++;

2421 
´efix
++;

2422 
Ën
--;

2425 ià(
·‰”n
.
Ën
 !ðËÀ|| 
	`ngx_r¡ºÿ£cmp
Õ©‹º.
d©a
, 
p
,†en) != 0) {

2426  
NGX_DECLINED
;

2429 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
´
->
»¶aûm’t
, &»¶aûm’tè!ð
NGX_OK
) {

2430  
NGX_ERROR
;

2433  
	`ngx_h‰p_´oxy_»wr™e
(
r
, 
h
, 
´efix
, 
Ën
, &
»¶aûm’t
);

2434 
	}
}

2437 
ngx_št_t


2438 
	$ngx_h‰p_´oxy_»wr™e
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
, 
size_t
 
´efix
,

2439 
size_t
 
Ën
, 
ngx_¡r_t
 *
»¶aûm’t
)

2441 
u_ch¬
 *
p
, *
d©a
;

2442 
size_t
 
Ãw_Ën
;

2444 
Ãw_Ën
 = 
»¶aûm’t
->
Ën
 + 
h
->
v®ue
.len -†en;

2446 ià(
»¶aûm’t
->
Ën
 >†en) {

2448 
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ãw_Ën
 + 1);

2449 ià(
d©a
 =ð
NULL
) {

2450  
NGX_ERROR
;

2453 
p
 = 
	`ngx_cÝy
(
d©a
, 
h
->
v®ue
.d©a, 
´efix
);

2454 
p
 = 
	`ngx_cÝy
Õ, 
»¶aûm’t
->
d©a
,„•Ïûm’t->
Ën
);

2456 
	`ngx_memýy
(
p
, 
h
->
v®ue
.
d©a
 + 
´efix
 + 
Ën
,

2457 
h
->
v®ue
.
Ën
 -†’ - 
´efix
 + 1);

2459 
h
->
v®ue
.
d©a
 = data;

2462 
p
 = 
	`ngx_cÝy
(
h
->
v®ue
.
d©a
 + 
´efix
, 
»¶aûm’t
->data,

2463 
»¶aûm’t
->
Ën
);

2465 
	`ngx_memmove
(
p
, 
h
->
v®ue
.
d©a
 + 
´efix
 + 
Ën
,

2466 
h
->
v®ue
.
Ën
 -†’ - 
´efix
 + 1);

2469 
h
->
v®ue
.
Ën
 = 
Ãw_Ën
;

2471  
NGX_OK
;

2472 
	}
}

2475 
ngx_št_t


2476 
	$ngx_h‰p_´oxy_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

2478 
ngx_h‰p_v¬ŸbË_t
 *
v¬
, *
v
;

2480 
v
 = 
ngx_h‰p_´oxy_v¬s
; v->
Çme
.
Ën
; v++) {

2481 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

2482 ià(
v¬
 =ð
NULL
) {

2483  
NGX_ERROR
;

2486 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

2487 
v¬
->
d©a
 = 
v
->data;

2490  
NGX_OK
;

2491 
	}
}

2495 
	$ngx_h‰p_´oxy_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

2497 
ngx_h‰p_´oxy_loc_cÚf_t
 *
cÚf
;

2499 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_´oxy_loc_cÚf_t
));

2500 ià(
cÚf
 =ð
NULL
) {

2501  
NULL
;

2541 
cÚf
->
up¡»am
.
¡Üe
 = 
NGX_CONF_UNSET
;

2542 
cÚf
->
up¡»am
.
¡Üe_acûss
 = 
NGX_CONF_UNSET_UINT
;

2543 
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
 = 
NGX_CONF_UNSET_UINT
;

2544 
cÚf
->
up¡»am
.
bufãršg
 = 
NGX_CONF_UNSET
;

2545 
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
 = 
NGX_CONF_UNSET
;

2546 
cÚf
->
up¡»am
.
fÜû_¿nges
 = 
NGX_CONF_UNSET
;

2548 
cÚf
->
up¡»am
.
loÿl
 = 
NGX_CONF_UNSET_PTR
;

2550 
cÚf
->
up¡»am
.
cÚÃù_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2551 
cÚf
->
up¡»am
.
£nd_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2552 
cÚf
->
up¡»am
.
»ad_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2553 
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2555 
cÚf
->
up¡»am
.
£nd_low©
 = 
NGX_CONF_UNSET_SIZE
;

2556 
cÚf
->
up¡»am
.
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

2557 
cÚf
->
up¡»am
.
lim™_¿‹
 = 
NGX_CONF_UNSET_SIZE
;

2559 
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

2560 
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

2561 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

2563 
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
 = 
NGX_CONF_UNSET
;

2564 
cÚf
->
up¡»am
.
·ss_»que¡_body
 = 
NGX_CONF_UNSET
;

2566 #ià(
NGX_HTTP_CACHE
)

2567 
cÚf
->
up¡»am
.
ÿche
 = 
NGX_CONF_UNSET_PTR
;

2568 
cÚf
->
up¡»am
.
ÿche_mš_u£s
 = 
NGX_CONF_UNSET_UINT
;

2569 
cÚf
->
up¡»am
.
ÿche_by·ss
 = 
NGX_CONF_UNSET_PTR
;

2570 
cÚf
->
up¡»am
.
no_ÿche
 = 
NGX_CONF_UNSET_PTR
;

2571 
cÚf
->
up¡»am
.
ÿche_v®id
 = 
NGX_CONF_UNSET_PTR
;

2572 
cÚf
->
up¡»am
.
ÿche_lock
 = 
NGX_CONF_UNSET
;

2573 
cÚf
->
up¡»am
.
ÿche_lock_timeout
 = 
NGX_CONF_UNSET_MSEC
;

2574 
cÚf
->
up¡»am
.
ÿche_lock_age
 = 
NGX_CONF_UNSET_MSEC
;

2575 
cÚf
->
up¡»am
.
ÿche_»v®id©e
 = 
NGX_CONF_UNSET
;

2578 
cÚf
->
up¡»am
.
hide_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

2579 
cÚf
->
up¡»am
.
·ss_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

2581 
cÚf
->
up¡»am
.
š‹rû±_”rÜs
 = 
NGX_CONF_UNSET
;

2583 #ià(
NGX_HTTP_SSL
)

2584 
cÚf
->
up¡»am
.
s¦_£ssiÚ_»u£
 = 
NGX_CONF_UNSET
;

2585 
cÚf
->
up¡»am
.
s¦_£rv”_Çme
 = 
NGX_CONF_UNSET
;

2586 
cÚf
->
up¡»am
.
s¦_v”ify
 = 
NGX_CONF_UNSET
;

2587 
cÚf
->
s¦_v”ify_d•th
 = 
NGX_CONF_UNSET_UINT
;

2588 
cÚf
->
s¦_·sswÜds
 = 
NGX_CONF_UNSET_PTR
;

2592 
cÚf
->
up¡»am
.
cyþic_‹mp_fže
 = 0;

2594 
cÚf
->
»dœeù
 = 
NGX_CONF_UNSET
;

2595 
cÚf
->
up¡»am
.
chªge_bufãršg
 = 1;

2597 
cÚf
->
cook›_domašs
 = 
NGX_CONF_UNSET_PTR
;

2598 
cÚf
->
cook›_·ths
 = 
NGX_CONF_UNSET_PTR
;

2600 
cÚf
->
h‰p_v”siÚ
 = 
NGX_CONF_UNSET_UINT
;

2602 
cÚf
->
h—d”s_hash_max_size
 = 
NGX_CONF_UNSET_UINT
;

2603 
cÚf
->
h—d”s_hash_buck‘_size
 = 
NGX_CONF_UNSET_UINT
;

2605 
	`ngx_¡r_£t
(&
cÚf
->
up¡»am
.
moduË
, "proxy");

2607  
cÚf
;

2608 
	}
}

2612 
	$ngx_h‰p_´oxy_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

2614 
ngx_h‰p_´oxy_loc_cÚf_t
 *
´ev
 = 
·»Á
;

2615 
ngx_h‰p_´oxy_loc_cÚf_t
 *
cÚf
 = 
chžd
;

2617 
u_ch¬
 *
p
;

2618 
size_t
 
size
;

2619 
ngx_št_t
 
rc
;

2620 
ngx_hash_š™_t
 
hash
;

2621 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2622 
ngx_h‰p_´oxy_»wr™e_t
 *
´
;

2623 
ngx_h‰p_süt_compže_t
 
sc
;

2625 ià(
cÚf
->
up¡»am
.
¡Üe
 != 0) {

2626 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
¡Üe
,

2627 
´ev
->
up¡»am
.
¡Üe
, 0);

2629 ià(
cÚf
->
up¡»am
.
¡Üe_Ëngths
 =ð
NULL
) {

2630 
cÚf
->
up¡»am
.
¡Üe_Ëngths
 = 
´ev
->upstream.store_lengths;

2631 
cÚf
->
up¡»am
.
¡Üe_v®ues
 = 
´ev
->upstream.store_values;

2635 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
¡Üe_acûss
,

2636 
´ev
->
up¡»am
.
¡Üe_acûss
, 0600);

2638 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
,

2639 
´ev
->
up¡»am
.
Ãxt_up¡»am_Œ›s
, 0);

2641 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
bufãršg
,

2642 
´ev
->
up¡»am
.
bufãršg
, 1);

2644 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
,

2645 
´ev
->
up¡»am
.
ignÜe_þ›Á_abÜt
, 0);

2647 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
fÜû_¿nges
,

2648 
´ev
->
up¡»am
.
fÜû_¿nges
, 0);

2650 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
loÿl
,

2651 
´ev
->
up¡»am
.
loÿl
, 
NULL
);

2653 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
cÚÃù_timeout
,

2654 
´ev
->
up¡»am
.
cÚÃù_timeout
, 60000);

2656 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
£nd_timeout
,

2657 
´ev
->
up¡»am
.
£nd_timeout
, 60000);

2659 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
»ad_timeout
,

2660 
´ev
->
up¡»am
.
»ad_timeout
, 60000);

2662 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
,

2663 
´ev
->
up¡»am
.
Ãxt_up¡»am_timeout
, 0);

2665 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
£nd_low©
,

2666 
´ev
->
up¡»am
.
£nd_low©
, 0);

2668 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
bufãr_size
,

2669 
´ev
->
up¡»am
.
bufãr_size
,

2670 (
size_t
è
ngx_·gesize
);

2672 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
lim™_¿‹
,

2673 
´ev
->
up¡»am
.
lim™_¿‹
, 0);

2675 
	`ngx_cÚf_m”ge_bufs_v®ue
(
cÚf
->
up¡»am
.
bufs
, 
´ev
->upstream.bufs,

2676 8, 
ngx_·gesize
);

2678 ià(
cÚf
->
up¡»am
.
bufs
.
num
 < 2) {

2679 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2681  
NGX_CONF_ERROR
;

2685 
size
 = 
cÚf
->
up¡»am
.
bufãr_size
;

2686 ià(
size
 < 
cÚf
->
up¡»am
.
bufs
.size) {

2687 
size
 = 
cÚf
->
up¡»am
.
bufs
.size;

2691 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
,

2692 
´ev
->
up¡»am
.
busy_bufãrs_size_cÚf
,

2693 
NGX_CONF_UNSET_SIZE
);

2695 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

2696 
cÚf
->
up¡»am
.
busy_bufãrs_size
 = 2 * 
size
;

2698 
cÚf
->
up¡»am
.
busy_bufãrs_size
 =

2699 
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
;

2702 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size
 < 
size
) {

2703 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2708  
NGX_CONF_ERROR
;

2711 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size


2712 > (
cÚf
->
up¡»am
.
bufs
.
num
 - 1è* cÚf->up¡»am.bufs.
size
)

2714 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2718  
NGX_CONF_ERROR
;

2722 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
,

2723 
´ev
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
,

2724 
NGX_CONF_UNSET_SIZE
);

2726 ià(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

2727 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 = 2 * 
size
;

2729 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 =

2730 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
;

2733 ià(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 < 
size
) {

2734 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2739  
NGX_CONF_ERROR
;

2742 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
,

2743 
´ev
->
up¡»am
.
max_‹mp_fže_size_cÚf
,

2744 
NGX_CONF_UNSET_SIZE
);

2746 ià(
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

2747 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 = 1024 * 1024 * 1024;

2749 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 =

2750 
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
;

2753 ià(
cÚf
->
up¡»am
.
max_‹mp_fže_size
 != 0

2754 && 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 < 
size
)

2756 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2762  
NGX_CONF_ERROR
;

2766 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
ignÜe_h—d”s
,

2767 
´ev
->
up¡»am
.
ignÜe_h—d”s
,

2768 
NGX_CONF_BITMASK_SET
);

2771 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am
,

2772 
´ev
->
up¡»am
.
Ãxt_up¡»am
,

2773 (
NGX_CONF_BITMASK_SET


2774 |
NGX_HTTP_UPSTREAM_FT_ERROR


2775 |
NGX_HTTP_UPSTREAM_FT_TIMEOUT
));

2777 ià(
cÚf
->
up¡»am
.
Ãxt_up¡»am
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

2778 
cÚf
->
up¡»am
.
Ãxt_up¡»am
 = 
NGX_CONF_BITMASK_SET


2779 |
NGX_HTTP_UPSTREAM_FT_OFF
;

2782 ià(
	`ngx_cÚf_m”ge_·th_v®ue
(
cf
, &
cÚf
->
up¡»am
.
‹mp_·th
,

2783 
´ev
->
up¡»am
.
‹mp_·th
,

2784 &
ngx_h‰p_´oxy_‹mp_·th
)

2785 !ð
NGX_OK
)

2787  
NGX_CONF_ERROR
;

2791 #ià(
NGX_HTTP_CACHE
)

2793 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche
,

2794 
´ev
->
up¡»am
.
ÿche
, 
NULL
);

2796 ià(
cÚf
->
up¡»am
.
ÿche
 && cÚf->up¡»am.ÿche->
d©a
 =ð
NULL
) {

2797 
ngx_shm_zÚe_t
 *
shm_zÚe
;

2799 
shm_zÚe
 = 
cÚf
->
up¡»am
.
ÿche
;

2801 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2803 &
shm_zÚe
->
shm
.
Çme
);

2805  
NGX_CONF_ERROR
;

2808 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
ÿche_mš_u£s
,

2809 
´ev
->
up¡»am
.
ÿche_mš_u£s
, 1);

2811 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
,

2812 
´ev
->
up¡»am
.
ÿche_u£_¡®e
,

2813 (
NGX_CONF_BITMASK_SET


2814 |
NGX_HTTP_UPSTREAM_FT_OFF
));

2816 ià(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

2817 
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 = 
NGX_CONF_BITMASK_SET


2818 |
NGX_HTTP_UPSTREAM_FT_OFF
;

2821 ià(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_ERROR
) {

2822 
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 |ð
NGX_HTTP_UPSTREAM_FT_NOLIVE
;

2825 ià(
cÚf
->
up¡»am
.
ÿche_m‘hods
 == 0) {

2826 
cÚf
->
up¡»am
.
ÿche_m‘hods
 = 
´ev
->upstream.cache_methods;

2829 
cÚf
->
up¡»am
.
ÿche_m‘hods
 |ð
NGX_HTTP_GET
|
NGX_HTTP_HEAD
;

2831 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche_by·ss
,

2832 
´ev
->
up¡»am
.
ÿche_by·ss
, 
NULL
);

2834 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
no_ÿche
,

2835 
´ev
->
up¡»am
.
no_ÿche
, 
NULL
);

2837 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche_v®id
,

2838 
´ev
->
up¡»am
.
ÿche_v®id
, 
NULL
);

2840 ià(
cÚf
->
ÿche_key
.
v®ue
.
d©a
 =ð
NULL
) {

2841 
cÚf
->
ÿche_key
 = 
´ev
->cache_key;

2844 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock
,

2845 
´ev
->
up¡»am
.
ÿche_lock
, 0);

2847 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock_timeout
,

2848 
´ev
->
up¡»am
.
ÿche_lock_timeout
, 5000);

2850 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock_age
,

2851 
´ev
->
up¡»am
.
ÿche_lock_age
, 5000);

2853 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ÿche_»v®id©e
,

2854 
´ev
->
up¡»am
.
ÿche_»v®id©e
, 0);

2858 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
m‘hod
, 
´ev
->method, "");

2860 ià(
cÚf
->
m‘hod
.
Ën


2861 && 
cÚf
->
m‘hod
.
d©a
[cÚf->m‘hod.
Ën
 - 1] != ' ')

2863 
cÚf
->
m‘hod
.
d©a
[cÚf->m‘hod.
Ën
] = ' ';

2864 
cÚf
->
m‘hod
.
Ën
++;

2867 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
,

2868 
´ev
->
up¡»am
.
·ss_»que¡_h—d”s
, 1);

2869 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
·ss_»que¡_body
,

2870 
´ev
->
up¡»am
.
·ss_»que¡_body
, 1);

2872 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
š‹rû±_”rÜs
,

2873 
´ev
->
up¡»am
.
š‹rû±_”rÜs
, 0);

2875 #ià(
NGX_HTTP_SSL
)

2877 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
s¦_£ssiÚ_»u£
,

2878 
´ev
->
up¡»am
.
s¦_£ssiÚ_»u£
, 1);

2880 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
s¦_´ÙocÞs
, 
´ev
->ssl_protocols,

2881 (
NGX_CONF_BITMASK_SET
|
NGX_SSL_SSLv3


2882 |
NGX_SSL_TLSv1
|
NGX_SSL_TLSv1_1


2883 |
NGX_SSL_TLSv1_2
));

2885 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_ch”s
, 
´ev
->ssl_ciphers,

2888 ià(
cÚf
->
up¡»am
.
s¦_Çme
 =ð
NULL
) {

2889 
cÚf
->
up¡»am
.
s¦_Çme
 = 
´ev
->upstream.ssl_name;

2892 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
s¦_£rv”_Çme
,

2893 
´ev
->
up¡»am
.
s¦_£rv”_Çme
, 0);

2894 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
s¦_v”ify
,

2895 
´ev
->
up¡»am
.
s¦_v”ify
, 0);

2896 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
s¦_v”ify_d•th
,

2897 
´ev
->
s¦_v”ify_d•th
, 1);

2898 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_Œu¡ed_û¹ifiÿ‹
,

2899 
´ev
->
s¦_Œu¡ed_û¹ifiÿ‹
, "");

2900 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_ül
, 
´ev
->ssl_crl, "");

2902 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_û¹ifiÿ‹
,

2903 
´ev
->
s¦_û¹ifiÿ‹
, "");

2904 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_û¹ifiÿ‹_key
,

2905 
´ev
->
s¦_û¹ifiÿ‹_key
, "");

2906 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
s¦_·sswÜds
, 
´ev
->s¦_·sswÜds, 
NULL
);

2908 ià(
cÚf
->
s¦
 && 
	`ngx_h‰p_´oxy_£t_s¦
(
cf
, cÚfè!ð
NGX_OK
) {

2909  
NGX_CONF_ERROR
;

2914 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
»dœeù
, 
´ev
->redirect, 1);

2916 ià(
cÚf
->
»dœeù
) {

2918 ià(
cÚf
->
»dœeùs
 =ð
NULL
) {

2919 
cÚf
->
»dœeùs
 = 
´ev
->redirects;

2922 ià(
cÚf
->
»dœeùs
 =ð
NULL
 && cÚf->
u¾
.
d©a
) {

2924 
cÚf
->
»dœeùs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1,

2925 (
ngx_h‰p_´oxy_»wr™e_t
));

2926 ià(
cÚf
->
»dœeùs
 =ð
NULL
) {

2927  
NGX_CONF_ERROR
;

2930 
´
 = 
	`ngx_¬¿y_push
(
cÚf
->
»dœeùs
);

2931 ià(
´
 =ð
NULL
) {

2932  
NGX_CONF_ERROR
;

2935 
	`ngx_memz”o
(&
´
->
·‰”n
.
com¶ex
,

2936 (
ngx_h‰p_com¶ex_v®ue_t
));

2938 
	`ngx_memz”o
(&
´
->
»¶aûm’t
, (
ngx_h‰p_com¶ex_v®ue_t
));

2940 
´
->
hªdËr
 = 
ngx_h‰p_´oxy_»wr™e_com¶ex_hªdËr
;

2942 ià(
cÚf
->
v¬s
.
uri
.
Ën
) {

2943 
´
->
·‰”n
.
com¶ex
.
v®ue
 = 
cÚf
->
u¾
;

2944 
´
->
»¶aûm’t
.
v®ue
 = 
cÚf
->
loÿtiÚ
;

2947 
´
->
·‰”n
.
com¶ex
.
v®ue
.
Ën
 = 
cÚf
->
u¾
.len

2950 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
´
->
·‰”n
.
com¶ex
.
v®ue
.
Ën
);

2951 ià(
p
 =ð
NULL
) {

2952  
NGX_CONF_ERROR
;

2955 
´
->
·‰”n
.
com¶ex
.
v®ue
.
d©a
 = 
p
;

2957 
p
 = 
	`ngx_ýymem
Õ, 
cÚf
->
u¾
.
d©a
, cÚf->u¾.
Ën
);

2958 *
p
 = '/';

2960 
	`ngx_¡r_£t
(&
´
->
»¶aûm’t
.
v®ue
, "/");

2965 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
cook›_domašs
, 
´ev
->cook›_domašs, 
NULL
);

2967 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
cook›_·ths
, 
´ev
->cook›_·ths, 
NULL
);

2969 #ià(
NGX_HTTP_SSL
)

2970 ià(
cÚf
->
up¡»am
.
s¦
 =ð
NULL
) {

2971 
cÚf
->
up¡»am
.
s¦
 = 
´ev
->upstream.ssl;

2975 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
h‰p_v”siÚ
, 
´ev
->http_version,

2976 
NGX_HTTP_VERSION_10
);

2978 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
h—d”s_hash_max_size
,

2979 
´ev
->
h—d”s_hash_max_size
, 512);

2981 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
h—d”s_hash_buck‘_size
,

2982 
´ev
->
h—d”s_hash_buck‘_size
, 64);

2984 
cÚf
->
h—d”s_hash_buck‘_size
 = 
	`ngx_®ign
(conf->headers_hash_bucket_size,

2985 
ngx_ÿch–še_size
);

2987 
hash
.
max_size
 = 
cÚf
->
h—d”s_hash_max_size
;

2988 
hash
.
buck‘_size
 = 
cÚf
->
h—d”s_hash_buck‘_size
;

2989 
hash
.
Çme
 = "proxy_headers_hash";

2991 ià(
	`ngx_h‰p_up¡»am_hide_h—d”s_hash
(
cf
, &
cÚf
->
up¡»am
,

2992 &
´ev
->
up¡»am
, 
ngx_h‰p_´oxy_hide_h—d”s
, &
hash
)

2993 !ð
NGX_OK
)

2995  
NGX_CONF_ERROR
;

2998 ià(
cÚf
->
up¡»am
.up¡»am =ð
NULL
) {

2999 
cÚf
->
up¡»am
.up¡»am = 
´ev
->upstream.upstream;

3000 
cÚf
->
v¬s
 = 
´ev
->vars;

3003 ià(
cÚf
->
´oxy_Ëngths
 =ð
NULL
) {

3004 
cÚf
->
´oxy_Ëngths
 = 
´ev
->proxy_lengths;

3005 
cÚf
->
´oxy_v®ues
 = 
´ev
->proxy_values;

3008 ià(
cÚf
->
up¡»am
.up¡»am || cÚf->
´oxy_Ëngths
) {

3009 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

3010 ià(
þcf
->
hªdËr
 =ð
NULL
 && clcf->
lmt_exýt
) {

3011 
þcf
->
hªdËr
 = 
ngx_h‰p_´oxy_hªdËr
;

3012 
cÚf
->
loÿtiÚ
 = 
´ev
->location;

3016 ià(
cÚf
->
body_sourû
.
d©a
 =ð
NULL
) {

3017 
cÚf
->
body_æushes
 = 
´ev
->body_flushes;

3018 
cÚf
->
body_sourû
 = 
´ev
->body_source;

3019 
cÚf
->
body_Ëngths
 = 
´ev
->body_lengths;

3020 
cÚf
->
body_v®ues
 = 
´ev
->body_values;

3023 ià(
cÚf
->
body_sourû
.
d©a
 && cÚf->
body_Ëngths
 =ð
NULL
) {

3025 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

3027 
sc
.
cf
 = cf;

3028 
sc
.
sourû
 = &
cÚf
->
body_sourû
;

3029 
sc
.
æushes
 = &
cÚf
->
body_æushes
;

3030 
sc
.
Ëngths
 = &
cÚf
->
body_Ëngths
;

3031 
sc
.
v®ues
 = &
cÚf
->
body_v®ues
;

3032 
sc
.
com¶‘e_Ëngths
 = 1;

3033 
sc
.
com¶‘e_v®ues
 = 1;

3035 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

3036  
NGX_CONF_ERROR
;

3040 ià(
cÚf
->
h—d”s_sourû
 =ð
NULL
) {

3041 
cÚf
->
h—d”s
 = 
´ev
->headers;

3042 #ià(
NGX_HTTP_CACHE
)

3043 
cÚf
->
h—d”s_ÿche
 = 
´ev
->headers_cache;

3045 
cÚf
->
h—d”s_sourû
 = 
´ev
->headers_source;

3048 
rc
 = 
	`ngx_h‰p_´oxy_š™_h—d”s
(
cf
, 
cÚf
, &cÚf->
h—d”s
,

3049 
ngx_h‰p_´oxy_h—d”s
);

3050 ià(
rc
 !ð
NGX_OK
) {

3051  
NGX_CONF_ERROR
;

3054 #ià(
NGX_HTTP_CACHE
)

3056 ià(
cÚf
->
up¡»am
.
ÿche
) {

3057 
rc
 = 
	`ngx_h‰p_´oxy_š™_h—d”s
(
cf
, 
cÚf
, &cÚf->
h—d”s_ÿche
,

3058 
ngx_h‰p_´oxy_ÿche_h—d”s
);

3059 ià(
rc
 !ð
NGX_OK
) {

3060  
NGX_CONF_ERROR
;

3066  
NGX_CONF_OK
;

3067 
	}
}

3070 
ngx_št_t


3071 
	$ngx_h‰p_´oxy_š™_h—d”s
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_´oxy_loc_cÚf_t
 *
cÚf
,

3072 
ngx_h‰p_´oxy_h—d”s_t
 *
h—d”s
, 
ngx_keyv®_t
 *
deçuÉ_h—d”s
)

3074 
u_ch¬
 *
p
;

3075 
size_t
 
size
;

3076 
ušŒ_t
 *
code
;

3077 
ngx_ušt_t
 
i
;

3078 
ngx_¬¿y_t
 
h—d”s_Çmes
, 
h—d”s_m”ged
;

3079 
ngx_keyv®_t
 *
¤c
, *
s
, *
h
;

3080 
ngx_hash_key_t
 *
hk
;

3081 
ngx_hash_š™_t
 
hash
;

3082 
ngx_h‰p_süt_compže_t
 
sc
;

3083 
ngx_h‰p_süt_cÝy_code_t
 *
cÝy
;

3085 ià(
h—d”s
->
hash
.
buck‘s
) {

3086  
NGX_OK
;

3089 ià(
	`ngx_¬¿y_š™
(&
h—d”s_Çmes
, 
cf
->
‹mp_poÞ
, 4, (
ngx_hash_key_t
))

3090 !ð
NGX_OK
)

3092  
NGX_ERROR
;

3095 ià(
	`ngx_¬¿y_š™
(&
h—d”s_m”ged
, 
cf
->
‹mp_poÞ
, 4, (
ngx_keyv®_t
))

3096 !ð
NGX_OK
)

3098  
NGX_ERROR
;

3101 ià(
cÚf
->
h—d”s_sourû
 =ð
NULL
) {

3102 
cÚf
->
h—d”s_sourû
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4,

3103 (
ngx_keyv®_t
));

3104 ià(
cÚf
->
h—d”s_sourû
 =ð
NULL
) {

3105  
NGX_ERROR
;

3109 
h—d”s
->
Ëngths
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 64, 1);

3110 ià(
h—d”s
->
Ëngths
 =ð
NULL
) {

3111  
NGX_ERROR
;

3114 
h—d”s
->
v®ues
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 512, 1);

3115 ià(
h—d”s
->
v®ues
 =ð
NULL
) {

3116  
NGX_ERROR
;

3119 
¤c
 = 
cÚf
->
h—d”s_sourû
->
–ts
;

3120 
i
 = 0; i < 
cÚf
->
h—d”s_sourû
->
ÃÉs
; i++) {

3122 
s
 = 
	`ngx_¬¿y_push
(&
h—d”s_m”ged
);

3123 ià(
s
 =ð
NULL
) {

3124  
NGX_ERROR
;

3127 *
s
 = 
¤c
[
i
];

3130 
h
 = 
deçuÉ_h—d”s
;

3132 
h
->
key
.
Ën
) {

3134 
¤c
 = 
h—d”s_m”ged
.
–ts
;

3135 
i
 = 0; i < 
h—d”s_m”ged
.
ÃÉs
; i++) {

3136 ià(
	`ngx_¡rÿ£cmp
(
h
->
key
.
d©a
, 
¤c
[
i
].key.data) == 0) {

3137 
Ãxt
;

3141 
s
 = 
	`ngx_¬¿y_push
(&
h—d”s_m”ged
);

3142 ià(
s
 =ð
NULL
) {

3143  
NGX_ERROR
;

3146 *
s
 = *
h
;

3148 
Ãxt
:

3150 
h
++;

3154 
¤c
 = 
h—d”s_m”ged
.
–ts
;

3155 
i
 = 0; i < 
h—d”s_m”ged
.
ÃÉs
; i++) {

3157 
hk
 = 
	`ngx_¬¿y_push
(&
h—d”s_Çmes
);

3158 ià(
hk
 =ð
NULL
) {

3159  
NGX_ERROR
;

3162 
hk
->
key
 = 
¤c
[
i
].key;

3163 
hk
->
key_hash
 = 
	`ngx_hash_key_lc
(
¤c
[
i
].
key
.
d©a
, src[i].key.
Ën
);

3164 
hk
->
v®ue
 = (*) 1;

3166 ià(
¤c
[
i
].
v®ue
.
Ën
 == 0) {

3170 ià(
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
¤c
[
i
].
v®ue
) == 0) {

3171 
cÝy
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
Ëngths
,

3172 (
ngx_h‰p_süt_cÝy_code_t
));

3173 ià(
cÝy
 =ð
NULL
) {

3174  
NGX_ERROR
;

3177 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
)

3178 
ngx_h‰p_süt_cÝy_Ën_code
;

3179 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len + (": ") - 1

3180 + 
¤c
[
i
].
v®ue
.
Ën
 + (
CRLF
) - 1;

3183 
size
 = ((
ngx_h‰p_süt_cÝy_code_t
)

3184 + 
¤c
[
i
].
key
.
Ën
 + (": ") - 1

3185 + 
¤c
[
i
].
v®ue
.
Ën
 + (
CRLF
) - 1

3186 + (
ušŒ_t
) - 1)

3187 & ~((
ušŒ_t
) - 1);

3189 
cÝy
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
v®ues
, 
size
);

3190 ià(
cÝy
 =ð
NULL
) {

3191  
NGX_ERROR
;

3194 
cÝy
->
code
 = 
ngx_h‰p_süt_cÝy_code
;

3195 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len + (": ") - 1

3196 + 
¤c
[
i
].
v®ue
.
Ën
 + (
CRLF
) - 1;

3198 
p
 = (
u_ch¬
 *è
cÝy
 + (
ngx_h‰p_süt_cÝy_code_t
);

3200 
p
 = 
	`ngx_ýymem
Õ, 
¤c
[
i
].
key
.
d©a
, src[i].key.
Ën
);

3201 *
p
++ = ':'; *p++ = ' ';

3202 
p
 = 
	`ngx_ýymem
Õ, 
¤c
[
i
].
v®ue
.
d©a
, src[i].v®ue.
Ën
);

3203 *
p
++ = 
CR
; *°ð
LF
;

3206 
cÝy
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
Ëngths
,

3207 (
ngx_h‰p_süt_cÝy_code_t
));

3208 ià(
cÝy
 =ð
NULL
) {

3209  
NGX_ERROR
;

3212 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
)

3213 
ngx_h‰p_süt_cÝy_Ën_code
;

3214 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len + (": ") - 1;

3217 
size
 = ((
ngx_h‰p_süt_cÝy_code_t
)

3218 + 
¤c
[
i
].
key
.
Ën
 + (": "è- 1 + (
ušŒ_t
) - 1)

3219 & ~((
ušŒ_t
) - 1);

3221 
cÝy
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
v®ues
, 
size
);

3222 ià(
cÝy
 =ð
NULL
) {

3223  
NGX_ERROR
;

3226 
cÝy
->
code
 = 
ngx_h‰p_süt_cÝy_code
;

3227 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len + (": ") - 1;

3229 
p
 = (
u_ch¬
 *è
cÝy
 + (
ngx_h‰p_süt_cÝy_code_t
);

3230 
p
 = 
	`ngx_ýymem
Õ, 
¤c
[
i
].
key
.
d©a
, src[i].key.
Ën
);

3231 *
p
++ = ':'; *p = ' ';

3234 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

3236 
sc
.
cf
 = cf;

3237 
sc
.
sourû
 = &
¤c
[
i
].
v®ue
;

3238 
sc
.
æushes
 = &
h—d”s
->flushes;

3239 
sc
.
Ëngths
 = &
h—d”s
->lengths;

3240 
sc
.
v®ues
 = &
h—d”s
->values;

3242 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

3243  
NGX_ERROR
;

3247 
cÝy
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
Ëngths
,

3248 (
ngx_h‰p_süt_cÝy_code_t
));

3249 ià(
cÝy
 =ð
NULL
) {

3250  
NGX_ERROR
;

3253 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
)

3254 
ngx_h‰p_süt_cÝy_Ën_code
;

3255 
cÝy
->
Ën
 = (
CRLF
) - 1;

3258 
size
 = ((
ngx_h‰p_süt_cÝy_code_t
)

3259 + (
CRLF
è- 1 + (
ušŒ_t
) - 1)

3260 & ~((
ušŒ_t
) - 1);

3262 
cÝy
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
v®ues
, 
size
);

3263 ià(
cÝy
 =ð
NULL
) {

3264  
NGX_ERROR
;

3267 
cÝy
->
code
 = 
ngx_h‰p_süt_cÝy_code
;

3268 
cÝy
->
Ën
 = (
CRLF
) - 1;

3270 
p
 = (
u_ch¬
 *è
cÝy
 + (
ngx_h‰p_süt_cÝy_code_t
);

3271 *
p
++ = 
CR
; *°ð
LF
;

3274 
code
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
Ëngths
, (
ušŒ_t
));

3275 ià(
code
 =ð
NULL
) {

3276  
NGX_ERROR
;

3279 *
code
 = (
ušŒ_t
è
NULL
;

3281 
code
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
v®ues
, (
ušŒ_t
));

3282 ià(
code
 =ð
NULL
) {

3283  
NGX_ERROR
;

3286 *
code
 = (
ušŒ_t
è
NULL
;

3289 
code
 = 
	`ngx_¬¿y_push_n
(
h—d”s
->
Ëngths
, (
ušŒ_t
));

3290 ià(
code
 =ð
NULL
) {

3291  
NGX_ERROR
;

3294 *
code
 = (
ušŒ_t
è
NULL
;

3297 
hash
.hash = &
h—d”s
->hash;

3298 
hash
.
key
 = 
ngx_hash_key_lc
;

3299 
hash
.
max_size
 = 
cÚf
->
h—d”s_hash_max_size
;

3300 
hash
.
buck‘_size
 = 
cÚf
->
h—d”s_hash_buck‘_size
;

3301 
hash
.
Çme
 = "proxy_headers_hash";

3302 
hash
.
poÞ
 = 
cf
->pool;

3303 
hash
.
‹mp_poÞ
 = 
NULL
;

3305  
	`ngx_hash_š™
(&
hash
, 
h—d”s_Çmes
.
–ts
, h—d”s_Çmes.
ÃÉs
);

3306 
	}
}

3310 
	$ngx_h‰p_´oxy_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3312 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

3314 
size_t
 
add
;

3315 
u_shÜt
 
pÜt
;

3316 
ngx_¡r_t
 *
v®ue
, *
u¾
;

3317 
ngx_u¾_t
 
u
;

3318 
ngx_ušt_t
 
n
;

3319 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3320 
ngx_h‰p_süt_compže_t
 
sc
;

3322 ià(
¶cf
->
up¡»am
.up¡»am ||…lcf->
´oxy_Ëngths
) {

3326 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

3328 
þcf
->
hªdËr
 = 
ngx_h‰p_´oxy_hªdËr
;

3330 ià(
þcf
->
Çme
.
d©a
[þcf->Çme.
Ën
 - 1] == '/') {

3331 
þcf
->
auto_»dœeù
 = 1;

3334 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3336 
u¾
 = &
v®ue
[1];

3338 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(
u¾
);

3340 ià(
n
) {

3342 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

3344 
sc
.
cf
 = cf;

3345 
sc
.
sourû
 = 
u¾
;

3346 
sc
.
Ëngths
 = &
¶cf
->
´oxy_Ëngths
;

3347 
sc
.
v®ues
 = &
¶cf
->
´oxy_v®ues
;

3348 
sc
.
v¬ŸbËs
 = 
n
;

3349 
sc
.
com¶‘e_Ëngths
 = 1;

3350 
sc
.
com¶‘e_v®ues
 = 1;

3352 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

3353  
NGX_CONF_ERROR
;

3356 #ià(
NGX_HTTP_SSL
)

3357 
¶cf
->
s¦
 = 1;

3360  
NGX_CONF_OK
;

3363 ià(
	`ngx_¡ºÿ£cmp
(
u¾
->
d©a
, (
u_ch¬
 *) "http://", 7) == 0) {

3364 
add
 = 7;

3365 
pÜt
 = 80;

3367 } ià(
	`ngx_¡ºÿ£cmp
(
u¾
->
d©a
, (
u_ch¬
 *) "https://", 8) == 0) {

3369 #ià(
NGX_HTTP_SSL
)

3370 
¶cf
->
s¦
 = 1;

3372 
add
 = 8;

3373 
pÜt
 = 443;

3375 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3377  
NGX_CONF_ERROR
;

3381 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "invalid URL…refix");

3382  
NGX_CONF_ERROR
;

3385 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

3387 
u
.
u¾
.
Ën
 = u¾->ËÀ- 
add
;

3388 
u
.
u¾
.
d©a
 = u¾->d©¨+ 
add
;

3389 
u
.
deçuÉ_pÜt
 = 
pÜt
;

3390 
u
.
uri_·¹
 = 1;

3391 
u
.
no_»sÞve
 = 1;

3393 
¶cf
->
up¡»am
.up¡»am = 
	`ngx_h‰p_up¡»am_add
(
cf
, &
u
, 0);

3394 ià(
¶cf
->
up¡»am
.up¡»am =ð
NULL
) {

3395  
NGX_CONF_ERROR
;

3398 
¶cf
->
v¬s
.
schema
.
Ën
 = 
add
;

3399 
¶cf
->
v¬s
.
schema
.
d©a
 = 
u¾
->data;

3400 
¶cf
->
v¬s
.
key_¡¬t
 =…lcf->v¬s.
schema
;

3402 
	`ngx_h‰p_´oxy_£t_v¬s
(&
u
, &
¶cf
->
v¬s
);

3404 
¶cf
->
loÿtiÚ
 = 
þcf
->
Çme
;

3406 ià(
þcf
->
Çmed


3407 #ià(
NGX_PCRE
)

3408 || 
þcf
->
»gex


3410 || 
þcf
->
nÚame
)

3412 ià(
¶cf
->
v¬s
.
uri
.
Ën
) {

3413 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3419  
NGX_CONF_ERROR
;

3422 
¶cf
->
loÿtiÚ
.
Ën
 = 0;

3425 
¶cf
->
u¾
 = *url;

3427  
NGX_CONF_OK
;

3428 
	}
}

3432 
	$ngx_h‰p_´oxy_»dœeù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3434 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

3436 
u_ch¬
 *
p
;

3437 
ngx_¡r_t
 *
v®ue
;

3438 
ngx_h‰p_´oxy_»wr™e_t
 *
´
;

3439 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

3441 ià(
¶cf
->
»dœeù
 == 0) {

3442  
NGX_CONF_OK
;

3445 
¶cf
->
»dœeù
 = 1;

3447 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3449 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

3450 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

3451 
¶cf
->
»dœeù
 = 0;

3452 
¶cf
->
»dœeùs
 = 
NULL
;

3453  
NGX_CONF_OK
;

3456 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "false") == 0) {

3457 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_ERR
, 
cf
, 0,

3459 
¶cf
->
»dœeù
 = 0;

3460 
¶cf
->
»dœeùs
 = 
NULL
;

3461  
NGX_CONF_OK
;

3464 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "default") != 0) {

3465 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3466 "šv®id…¬am‘” \"%V\"", &
v®ue
[1]);

3467  
NGX_CONF_ERROR
;

3471 ià(
¶cf
->
»dœeùs
 =ð
NULL
) {

3472 
¶cf
->
»dœeùs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1,

3473 (
ngx_h‰p_´oxy_»wr™e_t
));

3474 ià(
¶cf
->
»dœeùs
 =ð
NULL
) {

3475  
NGX_CONF_ERROR
;

3479 
´
 = 
	`ngx_¬¿y_push
(
¶cf
->
»dœeùs
);

3480 ià(
´
 =ð
NULL
) {

3481  
NGX_CONF_ERROR
;

3484 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "default") == 0) {

3485 ià(
¶cf
->
´oxy_Ëngths
) {

3486 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3489  
NGX_CONF_ERROR
;

3492 ià(
¶cf
->
u¾
.
d©a
 =ð
NULL
) {

3493 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3496  
NGX_CONF_ERROR
;

3499 
´
->
hªdËr
 = 
ngx_h‰p_´oxy_»wr™e_com¶ex_hªdËr
;

3501 
	`ngx_memz”o
(&
´
->
·‰”n
.
com¶ex
, (
ngx_h‰p_com¶ex_v®ue_t
));

3503 
	`ngx_memz”o
(&
´
->
»¶aûm’t
, (
ngx_h‰p_com¶ex_v®ue_t
));

3505 ià(
¶cf
->
v¬s
.
uri
.
Ën
) {

3506 
´
->
·‰”n
.
com¶ex
.
v®ue
 = 
¶cf
->
u¾
;

3507 
´
->
»¶aûm’t
.
v®ue
 = 
¶cf
->
loÿtiÚ
;

3510 
´
->
·‰”n
.
com¶ex
.
v®ue
.
Ën
 = 
¶cf
->
u¾
.len + ("/") - 1;

3512 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
´
->
·‰”n
.
com¶ex
.
v®ue
.
Ën
);

3513 ià(
p
 =ð
NULL
) {

3514  
NGX_CONF_ERROR
;

3517 
´
->
·‰”n
.
com¶ex
.
v®ue
.
d©a
 = 
p
;

3519 
p
 = 
	`ngx_ýymem
Õ, 
¶cf
->
u¾
.
d©a
,…lcf->u¾.
Ën
);

3520 *
p
 = '/';

3522 
	`ngx_¡r_£t
(&
´
->
»¶aûm’t
.
v®ue
, "/");

3525  
NGX_CONF_OK
;

3529 ià(
v®ue
[1].
d©a
[0] == '~') {

3530 
v®ue
[1].
Ën
--;

3531 
v®ue
[1].
d©a
++;

3533 ià(
v®ue
[1].
d©a
[0] == '*') {

3534 
v®ue
[1].
Ën
--;

3535 
v®ue
[1].
d©a
++;

3537 ià(
	`ngx_h‰p_´oxy_»wr™e_»gex
(
cf
, 
´
, &
v®ue
[1], 1è!ð
NGX_OK
) {

3538  
NGX_CONF_ERROR
;

3542 ià(
	`ngx_h‰p_´oxy_»wr™e_»gex
(
cf
, 
´
, &
v®ue
[1], 0è!ð
NGX_OK
) {

3543  
NGX_CONF_ERROR
;

3549 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

3551 
ccv
.
cf
 = cf;

3552 
ccv
.
v®ue
 = &value[1];

3553 
ccv
.
com¶ex_v®ue
 = &
´
->
·‰”n
.
com¶ex
;

3555 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

3556  
NGX_CONF_ERROR
;

3559 
´
->
hªdËr
 = 
ngx_h‰p_´oxy_»wr™e_com¶ex_hªdËr
;

3563 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

3565 
ccv
.
cf
 = cf;

3566 
ccv
.
v®ue
 = &value[2];

3567 
ccv
.
com¶ex_v®ue
 = &
´
->
»¶aûm’t
;

3569 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

3570  
NGX_CONF_ERROR
;

3573  
NGX_CONF_OK
;

3574 
	}
}

3578 
	$ngx_h‰p_´oxy_cook›_domaš
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3580 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

3582 
ngx_¡r_t
 *
v®ue
;

3583 
ngx_h‰p_´oxy_»wr™e_t
 *
´
;

3584 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

3586 ià(
¶cf
->
cook›_domašs
 =ð
NULL
) {

3587  
NGX_CONF_OK
;

3590 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3592 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

3594 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

3595 
¶cf
->
cook›_domašs
 = 
NULL
;

3596  
NGX_CONF_OK
;

3599 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3600 "šv®id…¬am‘” \"%V\"", &
v®ue
[1]);

3601  
NGX_CONF_ERROR
;

3604 ià(
¶cf
->
cook›_domašs
 =ð
NGX_CONF_UNSET_PTR
) {

3605 
¶cf
->
cook›_domašs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1,

3606 (
ngx_h‰p_´oxy_»wr™e_t
));

3607 ià(
¶cf
->
cook›_domašs
 =ð
NULL
) {

3608  
NGX_CONF_ERROR
;

3612 
´
 = 
	`ngx_¬¿y_push
(
¶cf
->
cook›_domašs
);

3613 ià(
´
 =ð
NULL
) {

3614  
NGX_CONF_ERROR
;

3617 ià(
v®ue
[1].
d©a
[0] == '~') {

3618 
v®ue
[1].
Ën
--;

3619 
v®ue
[1].
d©a
++;

3621 ià(
	`ngx_h‰p_´oxy_»wr™e_»gex
(
cf
, 
´
, &
v®ue
[1], 1è!ð
NGX_OK
) {

3622  
NGX_CONF_ERROR
;

3627 ià(
v®ue
[1].
d©a
[0] == '.') {

3628 
v®ue
[1].
Ën
--;

3629 
v®ue
[1].
d©a
++;

3632 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

3634 
ccv
.
cf
 = cf;

3635 
ccv
.
v®ue
 = &value[1];

3636 
ccv
.
com¶ex_v®ue
 = &
´
->
·‰”n
.
com¶ex
;

3638 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

3639  
NGX_CONF_ERROR
;

3642 
´
->
hªdËr
 = 
ngx_h‰p_´oxy_»wr™e_domaš_hªdËr
;

3644 ià(
v®ue
[2].
d©a
[0] == '.') {

3645 
v®ue
[2].
Ën
--;

3646 
v®ue
[2].
d©a
++;

3650 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

3652 
ccv
.
cf
 = cf;

3653 
ccv
.
v®ue
 = &value[2];

3654 
ccv
.
com¶ex_v®ue
 = &
´
->
»¶aûm’t
;

3656 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

3657  
NGX_CONF_ERROR
;

3660  
NGX_CONF_OK
;

3661 
	}
}

3665 
	$ngx_h‰p_´oxy_cook›_·th
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3667 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

3669 
ngx_¡r_t
 *
v®ue
;

3670 
ngx_h‰p_´oxy_»wr™e_t
 *
´
;

3671 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

3673 ià(
¶cf
->
cook›_·ths
 =ð
NULL
) {

3674  
NGX_CONF_OK
;

3677 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3679 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

3681 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

3682 
¶cf
->
cook›_·ths
 = 
NULL
;

3683  
NGX_CONF_OK
;

3686 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3687 "šv®id…¬am‘” \"%V\"", &
v®ue
[1]);

3688  
NGX_CONF_ERROR
;

3691 ià(
¶cf
->
cook›_·ths
 =ð
NGX_CONF_UNSET_PTR
) {

3692 
¶cf
->
cook›_·ths
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1,

3693 (
ngx_h‰p_´oxy_»wr™e_t
));

3694 ià(
¶cf
->
cook›_·ths
 =ð
NULL
) {

3695  
NGX_CONF_ERROR
;

3699 
´
 = 
	`ngx_¬¿y_push
(
¶cf
->
cook›_·ths
);

3700 ià(
´
 =ð
NULL
) {

3701  
NGX_CONF_ERROR
;

3704 ià(
v®ue
[1].
d©a
[0] == '~') {

3705 
v®ue
[1].
Ën
--;

3706 
v®ue
[1].
d©a
++;

3708 ià(
v®ue
[1].
d©a
[0] == '*') {

3709 
v®ue
[1].
Ën
--;

3710 
v®ue
[1].
d©a
++;

3712 ià(
	`ngx_h‰p_´oxy_»wr™e_»gex
(
cf
, 
´
, &
v®ue
[1], 1è!ð
NGX_OK
) {

3713  
NGX_CONF_ERROR
;

3717 ià(
	`ngx_h‰p_´oxy_»wr™e_»gex
(
cf
, 
´
, &
v®ue
[1], 0è!ð
NGX_OK
) {

3718  
NGX_CONF_ERROR
;

3724 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

3726 
ccv
.
cf
 = cf;

3727 
ccv
.
v®ue
 = &value[1];

3728 
ccv
.
com¶ex_v®ue
 = &
´
->
·‰”n
.
com¶ex
;

3730 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

3731  
NGX_CONF_ERROR
;

3734 
´
->
hªdËr
 = 
ngx_h‰p_´oxy_»wr™e_com¶ex_hªdËr
;

3737 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

3739 
ccv
.
cf
 = cf;

3740 
ccv
.
v®ue
 = &value[2];

3741 
ccv
.
com¶ex_v®ue
 = &
´
->
»¶aûm’t
;

3743 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

3744  
NGX_CONF_ERROR
;

3747  
NGX_CONF_OK
;

3748 
	}
}

3751 
ngx_št_t


3752 
	$ngx_h‰p_´oxy_»wr™e_»gex
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_´oxy_»wr™e_t
 *
´
,

3753 
ngx_¡r_t
 *
»gex
, 
ngx_ušt_t
 
ÿ£Ëss
)

3755 #ià(
NGX_PCRE
)

3756 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

3757 
ngx_»gex_compže_t
 
rc
;

3759 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

3761 
rc
.
·‰”n
 = *
»gex
;

3762 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

3763 
rc
.
”r
.
d©a
 = 
”r¡r
;

3765 ià(
ÿ£Ëss
) {

3766 
rc
.
ÝtiÚs
 = 
NGX_REGEX_CASELESS
;

3769 
´
->
·‰”n
.
»gex
 = 
	`ngx_h‰p_»gex_compže
(
cf
, &
rc
);

3770 ià(
´
->
·‰”n
.
»gex
 =ð
NULL
) {

3771  
NGX_ERROR
;

3774 
´
->
hªdËr
 = 
ngx_h‰p_´oxy_»wr™e_»gex_hªdËr
;

3776  
NGX_OK
;

3780 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3781 "usšg„egex \"%V\"„equœe PCRE†ib¿ry", 
»gex
);

3782  
NGX_ERROR
;

3785 
	}
}

3789 
	$ngx_h‰p_´oxy_¡Üe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3791 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

3793 
ngx_¡r_t
 *
v®ue
;

3794 
ngx_h‰p_süt_compže_t
 
sc
;

3796 ià(
¶cf
->
up¡»am
.
¡Üe
 !ð
NGX_CONF_UNSET


3797 || 
¶cf
->
up¡»am
.
¡Üe_Ëngths
)

3802 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3804 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

3805 
¶cf
->
up¡»am
.
¡Üe
 = 0;

3806  
NGX_CONF_OK
;

3809 #ià(
NGX_HTTP_CACHE
)

3811 ià(
¶cf
->
up¡»am
.
ÿche
 !ð
NGX_CONF_UNSET_PTR


3812 && 
¶cf
->
up¡»am
.
ÿche
 !ð
NULL
)

3819 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "on") == 0) {

3820 
¶cf
->
up¡»am
.
¡Üe
 = 1;

3821  
NGX_CONF_OK
;

3825 
v®ue
[1].
Ën
++;

3827 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

3829 
sc
.
cf
 = cf;

3830 
sc
.
sourû
 = &
v®ue
[1];

3831 
sc
.
Ëngths
 = &
¶cf
->
up¡»am
.
¡Üe_Ëngths
;

3832 
sc
.
v®ues
 = &
¶cf
->
up¡»am
.
¡Üe_v®ues
;

3833 
sc
.
v¬ŸbËs
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
v®ue
[1]);

3834 
sc
.
com¶‘e_Ëngths
 = 1;

3835 
sc
.
com¶‘e_v®ues
 = 1;

3837 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

3838  
NGX_CONF_ERROR
;

3841  
NGX_CONF_OK
;

3842 
	}
}

3845 #ià(
NGX_HTTP_CACHE
)

3848 
	$ngx_h‰p_´oxy_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3850 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

3852 
ngx_¡r_t
 *
v®ue
;

3854 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3856 ià(
¶cf
->
up¡»am
.
ÿche
 !ð
NGX_CONF_UNSET_PTR
) {

3860 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

3861 
¶cf
->
up¡»am
.
ÿche
 = 
NULL
;

3862  
NGX_CONF_OK
;

3865 ià(
¶cf
->
up¡»am
.
¡Üe
 > 0 ||…lcf->up¡»am.
¡Üe_Ëngths
) {

3869 
¶cf
->
up¡»am
.
ÿche
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
v®ue
[1], 0,

3870 &
ngx_h‰p_´oxy_moduË
);

3871 ià(
¶cf
->
up¡»am
.
ÿche
 =ð
NULL
) {

3872  
NGX_CONF_ERROR
;

3875  
NGX_CONF_OK
;

3876 
	}
}

3880 
	$ngx_h‰p_´oxy_ÿche_key
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3882 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

3884 
ngx_¡r_t
 *
v®ue
;

3885 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

3887 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3889 ià(
¶cf
->
ÿche_key
.
v®ue
.
d©a
) {

3893 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

3895 
ccv
.
cf
 = cf;

3896 
ccv
.
v®ue
 = &value[1];

3897 
ccv
.
com¶ex_v®ue
 = &
¶cf
->
ÿche_key
;

3899 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

3900  
NGX_CONF_ERROR
;

3903  
NGX_CONF_OK
;

3904 
	}
}

3909 #ià(
NGX_HTTP_SSL
)

3912 
	$ngx_h‰p_´oxy_s¦_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3914 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

3916 
ngx_¡r_t
 *
v®ue
;

3918 ià(
¶cf
->
s¦_·sswÜds
 !ð
NGX_CONF_UNSET_PTR
) {

3922 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3924 
¶cf
->
s¦_·sswÜds
 = 
	`ngx_s¦_»ad_·sswÜd_fže
(
cf
, &
v®ue
[1]);

3926 ià(
¶cf
->
s¦_·sswÜds
 =ð
NULL
) {

3927  
NGX_CONF_ERROR
;

3930  
NGX_CONF_OK
;

3931 
	}
}

3937 
	$ngx_h‰p_´oxy_low©_check
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

3939 #ià(
NGX_FREEBSD
)

3940 
ssize_t
 *
Å
 = 
d©a
;

3942 ià((
u_lÚg
è*
Å
 >ð
ngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
) {

3943 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3946 
ngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
);

3948  
NGX_CONF_ERROR
;

3951 #–ià!(
NGX_HAVE_SO_SNDLOWAT
)

3952 
ssize_t
 *
Å
 = 
d©a
;

3954 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

3957 *
Å
 = 0;

3961  
NGX_CONF_OK
;

3962 
	}
}

3965 #ià(
NGX_HTTP_SSL
)

3967 
ngx_št_t


3968 
	$ngx_h‰p_´oxy_£t_s¦
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_´oxy_loc_cÚf_t
 *
¶cf
)

3970 
ngx_poÞ_þ—nup_t
 *
þn
;

3972 
¶cf
->
up¡»am
.
s¦
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_s¦_t
));

3973 ià(
¶cf
->
up¡»am
.
s¦
 =ð
NULL
) {

3974  
NGX_ERROR
;

3977 
¶cf
->
up¡»am
.
s¦
->
log
 = 
cf
->log;

3979 ià(
	`ngx_s¦_ü—‹
(
¶cf
->
up¡»am
.
s¦
,…lcf->
s¦_´ÙocÞs
, 
NULL
)

3980 !ð
NGX_OK
)

3982  
NGX_ERROR
;

3985 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

3986 ià(
þn
 =ð
NULL
) {

3987  
NGX_ERROR
;

3990 
þn
->
hªdËr
 = 
ngx_s¦_þ—nup_ùx
;

3991 
þn
->
d©a
 = 
¶cf
->
up¡»am
.
s¦
;

3993 ià(
¶cf
->
s¦_û¹ifiÿ‹
.
Ën
) {

3995 ià(
¶cf
->
s¦_û¹ifiÿ‹_key
.
Ën
 == 0) {

3996 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

3998 "fÜ c”tifiÿ‹ \"%V\"", &
¶cf
->
s¦_û¹ifiÿ‹
);

3999  
NGX_ERROR
;

4002 ià(
	`ngx_s¦_û¹ifiÿ‹
(
cf
, 
¶cf
->
up¡»am
.
s¦
, &¶cf->
s¦_û¹ifiÿ‹
,

4003 &
¶cf
->
s¦_û¹ifiÿ‹_key
,…lcf->
s¦_·sswÜds
)

4004 !ð
NGX_OK
)

4006  
NGX_ERROR
;

4010 ià(
	`SSL_CTX_£t_ch”_li¡
(
¶cf
->
up¡»am
.
s¦
->
ùx
,

4011 (cÚ¡ *è
¶cf
->
s¦_ch”s
.
d©a
)

4014 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

4016 &
¶cf
->
s¦_ch”s
);

4017  
NGX_ERROR
;

4020 ià(
¶cf
->
up¡»am
.
s¦_v”ify
) {

4021 ià(
¶cf
->
s¦_Œu¡ed_û¹ifiÿ‹
.
Ën
 == 0) {

4022 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

4024  
NGX_ERROR
;

4027 ià(
	`ngx_s¦_Œu¡ed_û¹ifiÿ‹
(
cf
, 
¶cf
->
up¡»am
.
s¦
,

4028 &
¶cf
->
s¦_Œu¡ed_û¹ifiÿ‹
,

4029 
¶cf
->
s¦_v”ify_d•th
)

4030 !ð
NGX_OK
)

4032  
NGX_ERROR
;

4035 ià(
	`ngx_s¦_ül
(
cf
, 
¶cf
->
up¡»am
.
s¦
, &¶cf->
s¦_ül
è!ð
NGX_OK
) {

4036  
NGX_ERROR
;

4040  
NGX_OK
;

4041 
	}
}

4047 
	$ngx_h‰p_´oxy_£t_v¬s
(
ngx_u¾_t
 *
u
, 
ngx_h‰p_´oxy_v¬s_t
 *
v
)

4049 ià(
u
->
çmžy
 !ð
AF_UNIX
) {

4051 ià(
u
->
no_pÜt
 || u->
pÜt
 =ðu->
deçuÉ_pÜt
) {

4053 
v
->
ho¡_h—d”
 = 
u
->
ho¡
;

4055 ià(
u
->
deçuÉ_pÜt
 == 80) {

4056 
	`ngx_¡r_£t
(&
v
->
pÜt
, "80");

4059 
	`ngx_¡r_£t
(&
v
->
pÜt
, "443");

4063 
v
->
ho¡_h—d”
.
Ën
 = 
u
->
ho¡
.ËÀ+ 1 + u->
pÜt_‹xt
.len;

4064 
v
->
ho¡_h—d”
.
d©a
 = 
u
->
ho¡
.data;

4065 
v
->
pÜt
 = 
u
->
pÜt_‹xt
;

4068 
v
->
key_¡¬t
.
Ën
 +ðv->
ho¡_h—d”
.len;

4071 
	`ngx_¡r_£t
(&
v
->
ho¡_h—d”
, "localhost");

4072 
	`ngx_¡r_nuÎ
(&
v
->
pÜt
);

4073 
v
->
key_¡¬t
.
Ën
 +ð("unix:"è- 1 + 
u
->
ho¡
.len + 1;

4076 
v
->
uri
 = 
u
->uri;

4077 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_random_index_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_æag_t
 
	m’abË
;

15 } 
	tngx_h‰p_¿ndom_šdex_loc_cÚf_t
;

18 
	#NGX_HTTP_RANDOM_INDEX_PREALLOCATE
 50

	)

21 
ngx_št_t
 
ngx_h‰p_¿ndom_šdex_”rÜ
(
ngx_h‰p_»que¡_t
 *
r
,

22 
ngx_dœ_t
 *
dœ
, 
ngx_¡r_t
 *
Çme
);

23 
ngx_št_t
 
ngx_h‰p_¿ndom_šdex_š™
(
ngx_cÚf_t
 *
cf
);

24 *
ngx_h‰p_¿ndom_šdex_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

25 *
ngx_h‰p_¿ndom_šdex_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

26 *
·»Á
, *
chžd
);

29 
ngx_commªd_t
 
	gngx_h‰p_¿ndom_šdex_commªds
[] = {

31 { 
ngx_¡ršg
("random_index"),

32 
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

33 
ngx_cÚf_£t_æag_¦Ù
,

34 
NGX_HTTP_LOC_CONF_OFFSET
,

35 
off£tof
(
ngx_h‰p_¿ndom_šdex_loc_cÚf_t
, 
’abË
),

36 
NULL
 },

38 
ngx_nuÎ_commªd


42 
ngx_h‰p_moduË_t
 
	gngx_h‰p_¿ndom_šdex_moduË_ùx
 = {

43 
NULL
,

44 
ngx_h‰p_¿ndom_šdex_š™
,

46 
NULL
,

47 
NULL
,

49 
NULL
,

50 
NULL
,

52 
ngx_h‰p_¿ndom_šdex_ü—‹_loc_cÚf
,

53 
ngx_h‰p_¿ndom_šdex_m”ge_loc_cÚf


57 
ngx_moduË_t
 
	gngx_h‰p_¿ndom_šdex_moduË
 = {

58 
NGX_MODULE_V1
,

59 &
ngx_h‰p_¿ndom_šdex_moduË_ùx
,

60 
ngx_h‰p_¿ndom_šdex_commªds
,

61 
NGX_HTTP_MODULE
,

62 
NULL
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NGX_MODULE_V1_PADDING


73 
ngx_št_t


74 
	$ngx_h‰p_¿ndom_šdex_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

76 
u_ch¬
 *
Ï¡
, *
fž’ame
;

77 
size_t
 
Ën
, 
®loÿ‹d
, 
roÙ
;

78 
ngx_”r_t
 
”r
;

79 
ngx_št_t
 
rc
;

80 
ngx_¡r_t
 
·th
, 
uri
, *
Çme
;

81 
ngx_dœ_t
 
dœ
;

82 
ngx_ušt_t
 
n
, 
Ëv–
;

83 
ngx_¬¿y_t
 
Çmes
;

84 
ngx_h‰p_¿ndom_šdex_loc_cÚf_t
 *
¾cf
;

86 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] != '/') {

87  
NGX_DECLINED
;

90 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
|
NGX_HTTP_POST
))) {

91  
NGX_DECLINED
;

94 
¾cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_¿ndom_šdex_moduË
);

96 ià(!
¾cf
->
’abË
) {

97  
NGX_DECLINED
;

100 #ià(
NGX_HAVE_D_TYPE
)

101 
Ën
 = 
NGX_DIR_MASK_LEN
;

103 
Ën
 = 
NGX_HTTP_RANDOM_INDEX_PREALLOCATE
;

106 
Ï¡
 = 
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 
Ën
);

107 ià(
Ï¡
 =ð
NULL
) {

108  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

111 
®loÿ‹d
 = 
·th
.
Ën
;

113 
·th
.
Ën
 = 
Ï¡
 -…©h.
d©a
 - 1;

114 
·th
.
d©a
[·th.
Ën
] = '\0';

116 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

117 "h‰°¿ndom index: \"%s\"", 
·th
.
d©a
);

119 ià(
	`ngx_Ý’_dœ
(&
·th
, &
dœ
è=ð
NGX_ERROR
) {

120 
”r
 = 
ngx_”ºo
;

122 ià(
”r
 =ð
NGX_ENOENT


123 || 
”r
 =ð
NGX_ENOTDIR


124 || 
”r
 =ð
NGX_ENAMETOOLONG
)

126 
Ëv–
 = 
NGX_LOG_ERR
;

127 
rc
 = 
NGX_HTTP_NOT_FOUND
;

129 } ià(
”r
 =ð
NGX_EACCES
) {

130 
Ëv–
 = 
NGX_LOG_ERR
;

131 
rc
 = 
NGX_HTTP_FORBIDDEN
;

134 
Ëv–
 = 
NGX_LOG_CRIT
;

135 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

138 
	`ngx_log_”rÜ
(
Ëv–
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

139 
ngx_Ý’_dœ_n
 " \"%s\" fažed", 
·th
.
d©a
);

141  
rc
;

144 ià(
	`ngx_¬¿y_š™
(&
Çmes
, 
r
->
poÞ
, 32, (
ngx_¡r_t
)è!ð
NGX_OK
) {

145  
	`ngx_h‰p_¿ndom_šdex_”rÜ
(
r
, &
dœ
, &
·th
);

148 
fž’ame
 = 
·th
.
d©a
;

149 
fž’ame
[
·th
.
Ën
] = '/';

152 
	`ngx_£t_”ºo
(0);

154 ià(
	`ngx_»ad_dœ
(&
dœ
è=ð
NGX_ERROR
) {

155 
”r
 = 
ngx_”ºo
;

157 ià(
”r
 !ð
NGX_ENOMOREFILES
) {

158 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

159 
ngx_»ad_dœ_n
 " \"%V\" fažed", &
·th
);

160  
	`ngx_h‰p_¿ndom_šdex_”rÜ
(
r
, &
dœ
, &
·th
);

166 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

167 "h‰°¿ndom index fže: \"%s\"", 
	`ngx_de_Çme
(&
dœ
));

169 ià(
	`ngx_de_Çme
(&
dœ
)[0] == '.') {

173 
Ën
 = 
	`ngx_de_Çm–’
(&
dœ
);

175 ià(
dœ
.
ty³
 =ð0 || 
	`ngx_de_is_lšk
(&dir)) {

179 ià(
·th
.
Ën
 + 1 +†’ + 1 > 
®loÿ‹d
) {

180 
®loÿ‹d
 = 
·th
.
Ën
 + 1 +†en + 1

181 + 
NGX_HTTP_RANDOM_INDEX_PREALLOCATE
;

183 
fž’ame
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
®loÿ‹d
);

184 ià(
fž’ame
 =ð
NULL
) {

185  
	`ngx_h‰p_¿ndom_šdex_”rÜ
(
r
, &
dœ
, &
·th
);

188 
Ï¡
 = 
	`ngx_ýy¡º
(
fž’ame
, 
·th
.
d©a
,…©h.
Ën
 + 1);

189 *
Ï¡
++ = '/';

192 
	`ngx_ýy¡º
(
Ï¡
, 
	`ngx_de_Çme
(&
dœ
), 
Ën
 + 1);

194 ià(
	`ngx_de_šfo
(
fž’ame
, &
dœ
è=ð
NGX_FILE_ERROR
) {

195 
”r
 = 
ngx_”ºo
;

197 ià(
”r
 !ð
NGX_ENOENT
) {

198 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

199 
ngx_de_šfo_n
 " \"%s\" fažed", 
fž’ame
);

200  
	`ngx_h‰p_¿ndom_šdex_”rÜ
(
r
, &
dœ
, &
·th
);

203 ià(
	`ngx_de_lšk_šfo
(
fž’ame
, &
dœ
è=ð
NGX_FILE_ERROR
) {

204 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

205 
ngx_de_lšk_šfo_n
 " \"%s\" failed",

206 
fž’ame
);

207  
	`ngx_h‰p_¿ndom_šdex_”rÜ
(
r
, &
dœ
, &
·th
);

212 ià(!
	`ngx_de_is_fže
(&
dœ
)) {

216 
Çme
 = 
	`ngx_¬¿y_push
(&
Çmes
);

217 ià(
Çme
 =ð
NULL
) {

218  
	`ngx_h‰p_¿ndom_šdex_”rÜ
(
r
, &
dœ
, &
·th
);

221 
Çme
->
Ën
 =†en;

223 
Çme
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

224 ià(
Çme
->
d©a
 =ð
NULL
) {

225  
	`ngx_h‰p_¿ndom_šdex_”rÜ
(
r
, &
dœ
, &
·th
);

228 
	`ngx_memýy
(
Çme
->
d©a
, 
	`ngx_de_Çme
(&
dœ
), 
Ën
);

231 ià(
	`ngx_þo£_dœ
(&
dœ
è=ð
NGX_ERROR
) {

232 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

233 
ngx_þo£_dœ_n
 " \"%s\" fažed", &
·th
);

236 
n
 = 
Çmes
.
ÃÉs
;

238 ià(
n
 == 0) {

239  
NGX_DECLINED
;

242 
Çme
 = 
Çmes
.
–ts
;

244 
n
 = (
ngx_ušt_t
è(((
ušt64_t
è
	`ngx_¿ndom
() *‚) / 0x80000000);

246 
uri
.
Ën
 = 
r
->uri.ËÀ+ 
Çme
[
n
].len;

248 
uri
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, uri.
Ën
);

249 ià(
uri
.
d©a
 =ð
NULL
) {

250  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

253 
Ï¡
 = 
	`ngx_cÝy
(
uri
.
d©a
, 
r
->uri.d©a,„->uri.
Ën
);

254 
	`ngx_memýy
(
Ï¡
, 
Çme
[
n
].
d©a
,‚ame[n].
Ën
);

256  
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
uri
, &r->
¬gs
);

257 
	}
}

260 
ngx_št_t


261 
	$ngx_h‰p_¿ndom_šdex_”rÜ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_dœ_t
 *
dœ
,

262 
ngx_¡r_t
 *
Çme
)

264 ià(
	`ngx_þo£_dœ
(
dœ
è=ð
NGX_ERROR
) {

265 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

266 
ngx_þo£_dœ_n
 " \"%V\" fažed", 
Çme
);

269  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

270 
	}
}

274 
	$ngx_h‰p_¿ndom_šdex_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

276 
ngx_h‰p_¿ndom_šdex_loc_cÚf_t
 *
cÚf
;

278 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_¿ndom_šdex_loc_cÚf_t
));

279 ià(
cÚf
 =ð
NULL
) {

280  
NULL
;

283 
cÚf
->
’abË
 = 
NGX_CONF_UNSET
;

285  
cÚf
;

286 
	}
}

290 
	$ngx_h‰p_¿ndom_šdex_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

292 
ngx_h‰p_¿ndom_šdex_loc_cÚf_t
 *
´ev
 = 
·»Á
;

293 
ngx_h‰p_¿ndom_šdex_loc_cÚf_t
 *
cÚf
 = 
chžd
;

295 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

297  
NGX_CONF_OK
;

298 
	}
}

301 
ngx_št_t


302 
	$ngx_h‰p_¿ndom_šdex_š™
(
ngx_cÚf_t
 *
cf
)

304 
ngx_h‰p_hªdËr_±
 *
h
;

305 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

307 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

309 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_CONTENT_PHASE
].
hªdËrs
);

310 ià(
h
 =ð
NULL
) {

311  
NGX_ERROR
;

314 *
h
 = 
ngx_h‰p_¿ndom_šdex_hªdËr
;

316  
NGX_OK
;

317 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_range_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

49 
off_t
 
	m¡¬t
;

50 
off_t
 
	m’d
;

51 
ngx_¡r_t
 
	mcÚ‹Á_¿nge
;

52 } 
	tngx_h‰p_¿nge_t
;

56 
off_t
 
	moff£t
;

57 
ngx_¡r_t
 
	mbound¬y_h—d”
;

58 
ngx_¬¿y_t
 
	m¿nges
;

59 } 
	tngx_h‰p_¿nge_fž‹r_ùx_t
;

62 
ngx_št_t
 
ngx_h‰p_¿nge_·r£
(
ngx_h‰p_»que¡_t
 *
r
,

63 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
, 
ngx_ušt_t
 
¿nges
);

64 
ngx_št_t
 
ngx_h‰p_¿nge_sšgË·¹_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

65 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
);

66 
ngx_št_t
 
ngx_h‰p_¿nge_muÉ¬t_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

67 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
);

68 
ngx_št_t
 
ngx_h‰p_¿nge_nÙ_§tisfŸbË
(
ngx_h‰p_»que¡_t
 *
r
);

69 
ngx_št_t
 
ngx_h‰p_¿nge_‹¡_ov”Ïµed
(
ngx_h‰p_»que¡_t
 *
r
,

70 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
);

71 
ngx_št_t
 
ngx_h‰p_¿nge_sšgË·¹_body
(
ngx_h‰p_»que¡_t
 *
r
,

72 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
);

73 
ngx_št_t
 
ngx_h‰p_¿nge_muÉ¬t_body
(
ngx_h‰p_»que¡_t
 *
r
,

74 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
);

76 
ngx_št_t
 
ngx_h‰p_¿nge_h—d”_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

77 
ngx_št_t
 
ngx_h‰p_¿nge_body_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

80 
ngx_h‰p_moduË_t
 
	gngx_h‰p_¿nge_h—d”_fž‹r_moduË_ùx
 = {

81 
NULL
,

82 
ngx_h‰p_¿nge_h—d”_fž‹r_š™
,

84 
NULL
,

85 
NULL
,

87 
NULL
,

88 
NULL
,

90 
NULL
,

91 
NULL
,

95 
ngx_moduË_t
 
	gngx_h‰p_¿nge_h—d”_fž‹r_moduË
 = {

96 
NGX_MODULE_V1
,

97 &
ngx_h‰p_¿nge_h—d”_fž‹r_moduË_ùx
,

98 
NULL
,

99 
NGX_HTTP_MODULE
,

100 
NULL
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NGX_MODULE_V1_PADDING


111 
ngx_h‰p_moduË_t
 
	gngx_h‰p_¿nge_body_fž‹r_moduË_ùx
 = {

112 
NULL
,

113 
ngx_h‰p_¿nge_body_fž‹r_š™
,

115 
NULL
,

116 
NULL
,

118 
NULL
,

119 
NULL
,

121 
NULL
,

122 
NULL
,

126 
ngx_moduË_t
 
	gngx_h‰p_¿nge_body_fž‹r_moduË
 = {

127 
NGX_MODULE_V1
,

128 &
ngx_h‰p_¿nge_body_fž‹r_moduË_ùx
,

129 
NULL
,

130 
NGX_HTTP_MODULE
,

131 
NULL
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NULL
,

137 
NULL
,

138 
NGX_MODULE_V1_PADDING


142 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

143 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

146 
ngx_št_t


147 
	$ngx_h‰p_¿nge_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

149 
time_t
 
if_¿nge_time
;

150 
ngx_¡r_t
 *
if_¿nge
, *
‘ag
;

151 
ngx_ušt_t
 
¿nges
;

152 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

153 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
;

155 ià(
r
->
h‰p_v”siÚ
 < 
NGX_HTTP_VERSION_10


156 || 
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_OK


157 || 
r
 !ðr->
maš


158 || 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 == -1

159 || !
r
->
®low_¿nges
)

161  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

164 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

166 ià(
þcf
->
max_¿nges
 == 0) {

167  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

170 ià(
r
->
h—d”s_š
.
¿nge
 =ð
NULL


171 || 
r
->
h—d”s_š
.
¿nge
->
v®ue
.
Ën
 < 7

172 || 
	`ngx_¡ºÿ£cmp
(
r
->
h—d”s_š
.
¿nge
->
v®ue
.
d©a
,

173 (
u_ch¬
 *) "bytes=", 6)

176 
Ãxt_fž‹r
;

179 ià(
r
->
h—d”s_š
.
if_¿nge
) {

181 
if_¿nge
 = &
r
->
h—d”s_š
.if_¿nge->
v®ue
;

183 ià(
if_¿nge
->
Ën
 >ð2 && if_¿nge->
d©a
[if_range->len - 1] == '"') {

185 ià(
r
->
h—d”s_out
.
‘ag
 =ð
NULL
) {

186 
Ãxt_fž‹r
;

189 
‘ag
 = &
r
->
h—d”s_out
.‘ag->
v®ue
;

191 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

192 "h‰°œ:%Vƒg:%V", 
if_¿nge
, 
‘ag
);

194 ià(
if_¿nge
->
Ën
 !ð
‘ag
->len

195 || 
	`ngx_¡ºcmp
(
if_¿nge
->
d©a
, 
‘ag
->d©a,ƒg->
Ën
) != 0)

197 
Ãxt_fž‹r
;

200 
·r£
;

203 ià(
r
->
h—d”s_out
.
Ï¡_modif›d_time
 =ð(
time_t
) -1) {

204 
Ãxt_fž‹r
;

207 
if_¿nge_time
 = 
	`ngx_h‰p_·r£_time
(
if_¿nge
->
d©a
, if_¿nge->
Ën
);

209 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

211 
if_¿nge_time
, 
r
->
h—d”s_out
.
Ï¡_modif›d_time
);

213 ià(
if_¿nge_time
 !ð
r
->
h—d”s_out
.
Ï¡_modif›d_time
) {

214 
Ãxt_fž‹r
;

218 
·r£
:

220 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_¿nge_fž‹r_ùx_t
));

221 ià(
ùx
 =ð
NULL
) {

222  
NGX_ERROR
;

225 ià(
	`ngx_¬¿y_š™
(&
ùx
->
¿nges
, 
r
->
poÞ
, 1, (
ngx_h‰p_¿nge_t
))

226 !ð
NGX_OK
)

228  
NGX_ERROR
;

231 
¿nges
 = 
r
->
sšgË_¿nge
 ? 1 : 
þcf
->
max_¿nges
;

233 
	`ngx_h‰p_¿nge_·r£
(
r
, 
ùx
, 
¿nges
)) {

235 
NGX_OK
:

236 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_¿nge_body_fž‹r_moduË
);

238 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_PARTIAL_CONTENT
;

239 
r
->
h—d”s_out
.
¡©us_lše
.
Ën
 = 0;

241 ià(
ùx
->
¿nges
.
ÃÉs
 == 1) {

242  
	`ngx_h‰p_¿nge_sšgË·¹_h—d”
(
r
, 
ùx
);

245  
	`ngx_h‰p_¿nge_muÉ¬t_h—d”
(
r
, 
ùx
);

247 
NGX_HTTP_RANGE_NOT_SATISFIABLE
:

248  
	`ngx_h‰p_¿nge_nÙ_§tisfŸbË
(
r
);

250 
NGX_ERROR
:

251  
NGX_ERROR
;

257 
Ãxt_fž‹r
:

259 
r
->
h—d”s_out
.
acû±_¿nges
 = 
	`ngx_li¡_push
(&r->h—d”s_out.
h—d”s
);

260 ià(
r
->
h—d”s_out
.
acû±_¿nges
 =ð
NULL
) {

261  
NGX_ERROR
;

264 
r
->
h—d”s_out
.
acû±_¿nges
->
hash
 = 1;

265 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
acû±_¿nges
->
key
, "Accept-Ranges");

266 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
acû±_¿nges
->
v®ue
, "bytes");

268  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

269 
	}
}

272 
ngx_št_t


273 
	$ngx_h‰p_¿nge_·r£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
,

274 
ngx_ušt_t
 
¿nges
)

276 
u_ch¬
 *
p
;

277 
off_t
 
¡¬t
, 
’d
, 
size
, 
cÚ‹Á_Ëngth
;

278 
ngx_ušt_t
 
suffix
;

279 
ngx_h‰p_¿nge_t
 *
¿nge
;

281 
p
 = 
r
->
h—d”s_š
.
¿nge
->
v®ue
.
d©a
 + 6;

282 
size
 = 0;

283 
cÚ‹Á_Ëngth
 = 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
;

286 
¡¬t
 = 0;

287 
’d
 = 0;

288 
suffix
 = 0;

290 *
p
 == ' ') {…++; }

292 ià(*
p
 != '-') {

293 ià(*
p
 < '0' || *p > '9') {

294  
NGX_HTTP_RANGE_NOT_SATISFIABLE
;

297 *
p
 >= '0' && *p <= '9') {

298 
¡¬t
 = s¹ * 10 + *
p
++ - '0';

301 *
p
 == ' ') {…++; }

303 ià(*
p
++ != '-') {

304  
NGX_HTTP_RANGE_NOT_SATISFIABLE
;

307 *
p
 == ' ') {…++; }

309 ià(*
p
 == ',' || *p == '\0') {

310 
’d
 = 
cÚ‹Á_Ëngth
;

311 
found
;

315 
suffix
 = 1;

316 
p
++;

319 ià(*
p
 < '0' || *p > '9') {

320  
NGX_HTTP_RANGE_NOT_SATISFIABLE
;

323 *
p
 >= '0' && *p <= '9') {

324 
’d
 =ƒnd * 10 + *
p
++ - '0';

327 *
p
 == ' ') {…++; }

329 ià(*
p
 != ',' && *p != '\0') {

330  
NGX_HTTP_RANGE_NOT_SATISFIABLE
;

333 ià(
suffix
) {

334 
¡¬t
 = 
cÚ‹Á_Ëngth
 - 
’d
;

335 
’d
 = 
cÚ‹Á_Ëngth
 - 1;

338 ià(
’d
 >ð
cÚ‹Á_Ëngth
) {

339 
’d
 = 
cÚ‹Á_Ëngth
;

342 
’d
++;

345 
found
:

347 ià(
¡¬t
 < 
’d
) {

348 
¿nge
 = 
	`ngx_¬¿y_push
(&
ùx
->
¿nges
);

349 ià(
¿nge
 =ð
NULL
) {

350  
NGX_ERROR
;

353 
¿nge
->
¡¬t
 = start;

354 
¿nge
->
’d
 =ƒnd;

356 
size
 +ð
’d
 - 
¡¬t
;

358 ià(
¿nges
-- == 0) {

359  
NGX_DECLINED
;

363 ià(*
p
++ != ',') {

368 ià(
ùx
->
¿nges
.
ÃÉs
 == 0) {

369  
NGX_HTTP_RANGE_NOT_SATISFIABLE
;

372 ià(
size
 > 
cÚ‹Á_Ëngth
) {

373  
NGX_DECLINED
;

376  
NGX_OK
;

377 
	}
}

380 
ngx_št_t


381 
	$ngx_h‰p_¿nge_sšgË·¹_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

382 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
)

384 
ngx_bË_–t_t
 *
cÚ‹Á_¿nge
;

385 
ngx_h‰p_¿nge_t
 *
¿nge
;

387 
cÚ‹Á_¿nge
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

388 ià(
cÚ‹Á_¿nge
 =ð
NULL
) {

389  
NGX_ERROR
;

392 
r
->
h—d”s_out
.
cÚ‹Á_¿nge
 = content_range;

394 
cÚ‹Á_¿nge
->
hash
 = 1;

395 
	`ngx_¡r_£t
(&
cÚ‹Á_¿nge
->
key
, "Content-Range");

397 
cÚ‹Á_¿nge
->
v®ue
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

398 ("by‹ -/"è- 1 + 3 * 
NGX_OFF_T_LEN
);

399 ià(
cÚ‹Á_¿nge
->
v®ue
.
d©a
 =ð
NULL
) {

400  
NGX_ERROR
;

405 
¿nge
 = 
ùx
->
¿nges
.
–ts
;

407 
cÚ‹Á_¿nge
->
v®ue
.
Ën
 = 
	`ngx_¥rštf
(cÚ‹Á_¿nge->v®ue.
d©a
,

409 
¿nge
->
¡¬t
,„ªge->
’d
 - 1,

410 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
)

411 - 
cÚ‹Á_¿nge
->
v®ue
.
d©a
;

413 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
¿nge
->
’d
 -„ªge->
¡¬t
;

415 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
) {

416 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
->
hash
 = 0;

417 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 = 
NULL
;

420  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

421 
	}
}

424 
ngx_št_t


425 
	$ngx_h‰p_¿nge_muÉ¬t_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

426 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
)

428 
size_t
 
Ën
;

429 
ngx_ušt_t
 
i
;

430 
ngx_h‰p_¿nge_t
 *
¿nge
;

431 
ngx_©omic_ušt_t
 
bound¬y
;

433 
Ën
 = (
CRLF
 "--"è- 1 + 
NGX_ATOMIC_T_LEN


434 + (
CRLF
 "Content-Type: ") - 1

435 + 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën


436 + (
CRLF
 "Content-Range: bytes ") - 1;

438 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 =ðr->h—d”s_out.
cÚ‹Á_ty³
.
Ën


439 && 
r
->
h—d”s_out
.
ch¬£t
.
Ën
)

441 
Ën
 +ð("; ch¬£t="è- 1 + 
r
->
h—d”s_out
.
ch¬£t
.len;

444 
ùx
->
bound¬y_h—d”
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

445 ià(
ùx
->
bound¬y_h—d”
.
d©a
 =ð
NULL
) {

446  
NGX_ERROR
;

449 
bound¬y
 = 
	`ngx_Ãxt_‹mp_numb”
(0);

459 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 =ðr->h—d”s_out.
cÚ‹Á_ty³
.
Ën


460 && 
r
->
h—d”s_out
.
ch¬£t
.
Ën
)

462 
ùx
->
bound¬y_h—d”
.
Ën
 = 
	`ngx_¥rštf
(ùx->bound¬y_h—d”.
d©a
,

463 
CRLF
 "--%0muA" CRLF

464 "CÚ‹Á-Ty³: %V; ch¬£t=%V" 
CRLF


466 
bound¬y
,

467 &
r
->
h—d”s_out
.
cÚ‹Á_ty³
,

468 &
r
->
h—d”s_out
.
ch¬£t
)

469 - 
ùx
->
bound¬y_h—d”
.
d©a
;

471 } ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
) {

472 
ùx
->
bound¬y_h—d”
.
Ën
 = 
	`ngx_¥rštf
(ùx->bound¬y_h—d”.
d©a
,

473 
CRLF
 "--%0muA" CRLF

474 "CÚ‹Á-Ty³: %V" 
CRLF


476 
bound¬y
,

477 &
r
->
h—d”s_out
.
cÚ‹Á_ty³
)

478 - 
ùx
->
bound¬y_h—d”
.
d©a
;

481 
ùx
->
bound¬y_h—d”
.
Ën
 = 
	`ngx_¥rštf
(ùx->bound¬y_h—d”.
d©a
,

482 
CRLF
 "--%0muA" CRLF

484 
bound¬y
)

485 - 
ùx
->
bound¬y_h—d”
.
d©a
;

488 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
 =

489 
	`ngx_²®loc
(
r
->
poÞ
,

491 + 
NGX_ATOMIC_T_LEN
);

493 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
 =ð
NULL
) {

494  
NGX_ERROR
;

497 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

501 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 =

502 
	`ngx_¥rštf
(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
,

504 
bound¬y
)

505 - 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
;

507 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 =„->h—d”s_out.
cÚ‹Á_ty³
.
Ën
;

509 
r
->
h—d”s_out
.
ch¬£t
.
Ën
 = 0;

513 
Ën
 = (
CRLF
 "--"è- 1 + 
NGX_ATOMIC_T_LEN
 + ("--" CRLF) - 1;

515 
¿nge
 = 
ùx
->
¿nges
.
–ts
;

516 
i
 = 0; i < 
ùx
->
¿nges
.
ÃÉs
; i++) {

520 
¿nge
[
i
].
cÚ‹Á_¿nge
.
d©a
 =

521 
	`ngx_²®loc
(
r
->
poÞ
, 3 * 
NGX_OFF_T_LEN
 + 2 + 4);

523 ià(
¿nge
[
i
].
cÚ‹Á_¿nge
.
d©a
 =ð
NULL
) {

524  
NGX_ERROR
;

527 
¿nge
[
i
].
cÚ‹Á_¿nge
.
Ën
 = 
	`ngx_¥rštf
Ôªge[i].cÚ‹Á_¿nge.
d©a
,

528 "%O-%O/%O" 
CRLF
 CRLF,

529 
¿nge
[
i
].
¡¬t
,„ªge[i].
’d
 - 1,

530 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
)

531 - 
¿nge
[
i
].
cÚ‹Á_¿nge
.
d©a
;

533 
Ën
 +ð
ùx
->
bound¬y_h—d”
.ËÀ+ 
¿nge
[
i
].
cÚ‹Á_¿nge
.len

534 + (
size_t
è(
¿nge
[
i
].
’d
 -„ªge[i].
¡¬t
);

537 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
Ën
;

539 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
) {

540 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
->
hash
 = 0;

541 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 = 
NULL
;

544  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

545 
	}
}

548 
ngx_št_t


549 
	$ngx_h‰p_¿nge_nÙ_§tisfŸbË
(
ngx_h‰p_»que¡_t
 *
r
)

551 
ngx_bË_–t_t
 *
cÚ‹Á_¿nge
;

553 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_RANGE_NOT_SATISFIABLE
;

555 
cÚ‹Á_¿nge
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

556 ià(
cÚ‹Á_¿nge
 =ð
NULL
) {

557  
NGX_ERROR
;

560 
r
->
h—d”s_out
.
cÚ‹Á_¿nge
 = content_range;

562 
cÚ‹Á_¿nge
->
hash
 = 1;

563 
	`ngx_¡r_£t
(&
cÚ‹Á_¿nge
->
key
, "Content-Range");

565 
cÚ‹Á_¿nge
->
v®ue
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

566 ("by‹ */"è- 1 + 
NGX_OFF_T_LEN
);

567 ià(
cÚ‹Á_¿nge
->
v®ue
.
d©a
 =ð
NULL
) {

568  
NGX_ERROR
;

571 
cÚ‹Á_¿nge
->
v®ue
.
Ën
 = 
	`ngx_¥rštf
(cÚ‹Á_¿nge->v®ue.
d©a
,

573 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
)

574 - 
cÚ‹Á_¿nge
->
v®ue
.
d©a
;

576 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
r
);

578  
NGX_HTTP_RANGE_NOT_SATISFIABLE
;

579 
	}
}

582 
ngx_št_t


583 
	$ngx_h‰p_¿nge_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

585 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
;

587 ià(
š
 =ð
NULL
) {

588  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

591 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_¿nge_body_fž‹r_moduË
);

593 ià(
ùx
 =ð
NULL
) {

594  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

597 ià(
ùx
->
¿nges
.
ÃÉs
 == 1) {

598  
	`ngx_h‰p_¿nge_sšgË·¹_body
(
r
, 
ùx
, 
š
);

605 ià(
	`ngx_buf_¥ecŸl
(
š
->
buf
)) {

606  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

609 ià(
	`ngx_h‰p_¿nge_‹¡_ov”Ïµed
(
r
, 
ùx
, 
š
è!ð
NGX_OK
) {

610  
NGX_ERROR
;

613  
	`ngx_h‰p_¿nge_muÉ¬t_body
(
r
, 
ùx
, 
š
);

614 
	}
}

617 
ngx_št_t


618 
	$ngx_h‰p_¿nge_‹¡_ov”Ïµed
(
ngx_h‰p_»que¡_t
 *
r
,

619 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
)

621 
off_t
 
¡¬t
, 
Ï¡
;

622 
ngx_buf_t
 *
buf
;

623 
ngx_ušt_t
 
i
;

624 
ngx_h‰p_¿nge_t
 *
¿nge
;

626 ià(
ùx
->
off£t
) {

627 
ov”Ïµed
;

630 
buf
 = 
š
->buf;

632 ià(!
buf
->
Ï¡_buf
) {

633 
¡¬t
 = 
ùx
->
off£t
;

634 
Ï¡
 = 
ùx
->
off£t
 + 
	`ngx_buf_size
(
buf
);

636 
¿nge
 = 
ùx
->
¿nges
.
–ts
;

637 
i
 = 0; i < 
ùx
->
¿nges
.
ÃÉs
; i++) {

638 ià(
¡¬t
 > 
¿nge
[
i
].¡¬ˆ|| 
Ï¡
 <„ªge[i].
’d
) {

639 
ov”Ïµed
;

644 
ùx
->
off£t
 = 
	`ngx_buf_size
(
buf
);

646  
NGX_OK
;

648 
ov”Ïµed
:

650 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

653  
NGX_ERROR
;

654 
	}
}

657 
ngx_št_t


658 
	$ngx_h‰p_¿nge_sšgË·¹_body
(
ngx_h‰p_»que¡_t
 *
r
,

659 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
)

661 
off_t
 
¡¬t
, 
Ï¡
;

662 
ngx_buf_t
 *
buf
;

663 
ngx_chaš_t
 *
out
, *
þ
, **
Î
;

664 
ngx_h‰p_¿nge_t
 *
¿nge
;

666 
out
 = 
NULL
;

667 
Î
 = &
out
;

668 
¿nge
 = 
ùx
->
¿nges
.
–ts
;

670 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

672 
buf
 = 
þ
->buf;

674 
¡¬t
 = 
ùx
->
off£t
;

675 
Ï¡
 = 
ùx
->
off£t
 + 
	`ngx_buf_size
(
buf
);

677 
ùx
->
off£t
 = 
Ï¡
;

679 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

680 "h‰°¿ngbody buf: %O-%O", 
¡¬t
, 
Ï¡
);

682 ià(
	`ngx_buf_¥ecŸl
(
buf
)) {

683 *
Î
 = 
þ
;

684 
Î
 = &
þ
->
Ãxt
;

688 ià(
¿nge
->
’d
 <ð
¡¬t
 ||„ªge->¡¬ˆ>ð
Ï¡
) {

690 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

693 ià(
buf
->
š_fže
) {

694 
buf
->
fže_pos
 = buf->
fže_Ï¡
;

697 
buf
->
pos
 = buf->
Ï¡
;

698 
buf
->
sync
 = 1;

703 ià(
¿nge
->
¡¬t
 > start) {

705 ià(
buf
->
š_fže
) {

706 
buf
->
fže_pos
 +ð
¿nge
->
¡¬t
 - start;

709 ià(
	`ngx_buf_š_memÜy
(
buf
)) {

710 
buf
->
pos
 +ð(
size_t
è(
¿nge
->
¡¬t
 - start);

714 ià(
¿nge
->
’d
 <ð
Ï¡
) {

716 ià(
buf
->
š_fže
) {

717 
buf
->
fže_Ï¡
 -ð
Ï¡
 - 
¿nge
->
’d
;

720 ià(
	`ngx_buf_š_memÜy
(
buf
)) {

721 
buf
->
Ï¡
 -ð(
size_t
èÖa¡ - 
¿nge
->
’d
);

724 
buf
->
Ï¡_buf
 = 1;

725 *
Î
 = 
þ
;

726 
þ
->
Ãxt
 = 
NULL
;

731 *
Î
 = 
þ
;

732 
Î
 = &
þ
->
Ãxt
;

735 ià(
out
 =ð
NULL
) {

736  
NGX_OK
;

739  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
out
);

740 
	}
}

743 
ngx_št_t


744 
	$ngx_h‰p_¿nge_muÉ¬t_body
(
ngx_h‰p_»que¡_t
 *
r
,

745 
ngx_h‰p_¿nge_fž‹r_ùx_t
 *
ùx
, 
ngx_chaš_t
 *
š
)

747 
ngx_buf_t
 *
b
, *
buf
;

748 
ngx_ušt_t
 
i
;

749 
ngx_chaš_t
 *
out
, *
hþ
, *
rþ
, *
dþ
, **
Î
;

750 
ngx_h‰p_¿nge_t
 *
¿nge
;

752 
Î
 = &
out
;

753 
buf
 = 
š
->buf;

754 
¿nge
 = 
ùx
->
¿nges
.
–ts
;

756 
i
 = 0; i < 
ùx
->
¿nges
.
ÃÉs
; i++) {

766 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

767 ià(
b
 =ð
NULL
) {

768  
NGX_ERROR
;

771 
b
->
memÜy
 = 1;

772 
b
->
pos
 = 
ùx
->
bound¬y_h—d”
.
d©a
;

773 
b
->
Ï¡
 = 
ùx
->
bound¬y_h—d”
.
d©a
 + ctx->bound¬y_h—d”.
Ën
;

775 
hþ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

776 ià(
hþ
 =ð
NULL
) {

777  
NGX_ERROR
;

780 
hþ
->
buf
 = 
b
;

785 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

786 ià(
b
 =ð
NULL
) {

787  
NGX_ERROR
;

790 
b
->
‹mpÜ¬y
 = 1;

791 
b
->
pos
 = 
¿nge
[
i
].
cÚ‹Á_¿nge
.
d©a
;

792 
b
->
Ï¡
 = 
¿nge
[
i
].
cÚ‹Á_¿nge
.
d©a
 +„ªge[i].cÚ‹Á_¿nge.
Ën
;

794 
rþ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

795 ià(
rþ
 =ð
NULL
) {

796  
NGX_ERROR
;

799 
rþ
->
buf
 = 
b
;

804 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

805 ià(
b
 =ð
NULL
) {

806  
NGX_ERROR
;

809 
b
->
š_fže
 = 
buf
->in_file;

810 
b
->
‹mpÜ¬y
 = 
buf
->temporary;

811 
b
->
memÜy
 = 
buf
->memory;

812 
b
->
mm­
 = 
buf
->mmap;

813 
b
->
fže
 = 
buf
->file;

815 ià(
buf
->
š_fže
) {

816 
b
->
fže_pos
 = 
buf
->fže_po + 
¿nge
[
i
].
¡¬t
;

817 
b
->
fže_Ï¡
 = 
buf
->
fže_pos
 + 
¿nge
[
i
].
’d
;

820 ià(
	`ngx_buf_š_memÜy
(
buf
)) {

821 
b
->
pos
 = 
buf
->po + (
size_t
è
¿nge
[
i
].
¡¬t
;

822 
b
->
Ï¡
 = 
buf
->
pos
 + (
size_t
è
¿nge
[
i
].
’d
;

825 
dþ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

826 ià(
dþ
 =ð
NULL
) {

827  
NGX_ERROR
;

830 
dþ
->
buf
 = 
b
;

832 *
Î
 = 
hþ
;

833 
hþ
->
Ãxt
 = 
rþ
;

834 
rþ
->
Ãxt
 = 
dþ
;

835 
Î
 = &
dþ
->
Ãxt
;

840 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

841 ià(
b
 =ð
NULL
) {

842  
NGX_ERROR
;

845 
b
->
‹mpÜ¬y
 = 1;

846 
b
->
Ï¡_buf
 = 1;

848 
b
->
pos
 = 
	`ngx_²®loc
(
r
->
poÞ
, (
CRLF
 "--"è- 1 + 
NGX_ATOMIC_T_LEN


849 + ("--" 
CRLF
) - 1);

850 ià(
b
->
pos
 =ð
NULL
) {

851  
NGX_ERROR
;

854 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->
pos
, 
ùx
->
bound¬y_h—d”
.
d©a
,

855 (
CRLF
 "--"è- 1 + 
NGX_ATOMIC_T_LEN
);

856 *
b
->
Ï¡
++ = '-'; *b->last++ = '-';

857 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

859 
hþ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

860 ià(
hþ
 =ð
NULL
) {

861  
NGX_ERROR
;

864 
hþ
->
buf
 = 
b
;

865 
hþ
->
Ãxt
 = 
NULL
;

867 *
Î
 = 
hþ
;

869  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
out
);

870 
	}
}

873 
ngx_št_t


874 
	$ngx_h‰p_¿nge_h—d”_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

876 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

877 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_¿nge_h—d”_fž‹r
;

879  
NGX_OK
;

880 
	}
}

883 
ngx_št_t


884 
	$ngx_h‰p_¿nge_body_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

886 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

887 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_¿nge_body_fž‹r
;

889  
NGX_OK
;

890 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_realip_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
	#NGX_HTTP_REALIP_XREALIP
 0

	)

14 
	#NGX_HTTP_REALIP_XFWD
 1

	)

15 
	#NGX_HTTP_REALIP_HEADER
 2

	)

16 
	#NGX_HTTP_REALIP_PROXY
 3

	)

20 
ngx_¬¿y_t
 *
	mäom
;

21 
ngx_ušt_t
 
	mty³
;

22 
ngx_ušt_t
 
	mhash
;

23 
ngx_¡r_t
 
	mh—d”
;

24 
ngx_æag_t
 
	m»cursive
;

25 } 
	tngx_h‰p_»®_loc_cÚf_t
;

29 
ngx_cÚÃùiÚ_t
 *
	mcÚÃùiÚ
;

30 
sockaddr
 *
	msockaddr
;

31 
sockËn_t
 
	msockËn
;

32 
ngx_¡r_t
 
	maddr_‹xt
;

33 } 
	tngx_h‰p_»®_ùx_t
;

36 
ngx_št_t
 
ngx_h‰p_»®_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

37 
ngx_št_t
 
ngx_h‰p_»®_£t_addr
(
ngx_h‰p_»que¡_t
 *
r
,

38 
ngx_addr_t
 *
addr
);

39 
ngx_h‰p_»®_þ—nup
(*
d©a
);

40 *
ngx_h‰p_»®_äom
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

41 *
cÚf
);

42 *
ngx_h‰p_»®
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

43 *
ngx_h‰p_»®_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

44 *
ngx_h‰p_»®_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

45 *
·»Á
, *
chžd
);

46 
ngx_št_t
 
ngx_h‰p_»®_š™
(
ngx_cÚf_t
 *
cf
);

49 
ngx_commªd_t
 
	gngx_h‰p_»®_commªds
[] = {

51 { 
ngx_¡ršg
("set_real_ip_from"),

52 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

53 
ngx_h‰p_»®_äom
,

54 
NGX_HTTP_LOC_CONF_OFFSET
,

56 
NULL
 },

58 { 
ngx_¡ršg
("real_ip_header"),

59 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

60 
ngx_h‰p_»®
,

61 
NGX_HTTP_LOC_CONF_OFFSET
,

63 
NULL
 },

65 { 
ngx_¡ršg
("real_ip_recursive"),

66 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

67 
ngx_cÚf_£t_æag_¦Ù
,

68 
NGX_HTTP_LOC_CONF_OFFSET
,

69 
off£tof
(
ngx_h‰p_»®_loc_cÚf_t
, 
»cursive
),

70 
NULL
 },

72 
ngx_nuÎ_commªd


77 
ngx_h‰p_moduË_t
 
	gngx_h‰p_»®_moduË_ùx
 = {

78 
NULL
,

79 
ngx_h‰p_»®_š™
,

81 
NULL
,

82 
NULL
,

84 
NULL
,

85 
NULL
,

87 
ngx_h‰p_»®_ü—‹_loc_cÚf
,

88 
ngx_h‰p_»®_m”ge_loc_cÚf


92 
ngx_moduË_t
 
	gngx_h‰p_»®_moduË
 = {

93 
NGX_MODULE_V1
,

94 &
ngx_h‰p_»®_moduË_ùx
,

95 
ngx_h‰p_»®_commªds
,

96 
NGX_HTTP_MODULE
,

97 
NULL
,

98 
NULL
,

99 
NULL
,

100 
NULL
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NGX_MODULE_V1_PADDING


108 
ngx_št_t


109 
	$ngx_h‰p_»®_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

111 
u_ch¬
 *
p
;

112 
size_t
 
Ën
;

113 
ngx_¡r_t
 *
v®ue
;

114 
ngx_ušt_t
 
i
, 
hash
;

115 
ngx_addr_t
 
addr
;

116 
ngx_¬¿y_t
 *
xfwd
;

117 
ngx_li¡_·¹_t
 *
·¹
;

118 
ngx_bË_–t_t
 *
h—d”
;

119 
ngx_cÚÃùiÚ_t
 *
c
;

120 
ngx_h‰p_»®_ùx_t
 *
ùx
;

121 
ngx_h‰p_»®_loc_cÚf_t
 *
¾cf
;

123 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_»®_moduË
);

125 ià(
ùx
) {

126  
NGX_DECLINED
;

129 
¾cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_»®_moduË
);

131 ià(
¾cf
->
äom
 =ð
NULL
) {

132  
NGX_DECLINED
;

135 
¾cf
->
ty³
) {

137 
NGX_HTTP_REALIP_XREALIP
:

139 ià(
r
->
h—d”s_š
.
x_»®_
 =ð
NULL
) {

140  
NGX_DECLINED
;

143 
v®ue
 = &
r
->
h—d”s_š
.
x_»®_
->value;

144 
xfwd
 = 
NULL
;

148 
NGX_HTTP_REALIP_XFWD
:

150 
xfwd
 = &
r
->
h—d”s_š
.
x_fÜw¬ded_fÜ
;

152 ià(
xfwd
->
–ts
 =ð
NULL
) {

153  
NGX_DECLINED
;

156 
v®ue
 = 
NULL
;

160 
NGX_HTTP_REALIP_PROXY
:

162 
v®ue
 = &
r
->
cÚÃùiÚ
->
´oxy_´ÙocÞ_addr
;

164 ià(
v®ue
->
Ën
 == 0) {

165  
NGX_DECLINED
;

168 
xfwd
 = 
NULL
;

174 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

175 
h—d”
 = 
·¹
->
–ts
;

177 
hash
 = 
¾cf
->hash;

178 
Ën
 = 
¾cf
->
h—d”
.len;

179 
p
 = 
¾cf
->
h—d”
.
d©a
;

181 
i
 = 0; ; i++) {

183 ià(
i
 >ð
·¹
->
ÃÉs
) {

184 ià(
·¹
->
Ãxt
 =ð
NULL
) {

188 
·¹
 =…¬t->
Ãxt
;

189 
h—d”
 = 
·¹
->
–ts
;

190 
i
 = 0;

193 ià(
hash
 =ð
h—d”
[
i
].hash

194 && 
Ën
 =ð
h—d”
[
i
].
key
.len

195 && 
	`ngx_¡ºcmp
(
p
, 
h—d”
[
i
].
lowÿ£_key
, 
Ën
) == 0)

197 
v®ue
 = &
h—d”
[
i
].value;

198 
xfwd
 = 
NULL
;

200 
found
;

204  
NGX_DECLINED
;

207 
found
:

209 
c
 = 
r
->
cÚÃùiÚ
;

211 
addr
.
sockaddr
 = 
c
->sockaddr;

212 
addr
.
sockËn
 = 
c
->socklen;

215 ià(
	`ngx_h‰p_g‘_fÜw¬ded_addr
(
r
, &
addr
, 
xfwd
, 
v®ue
, 
¾cf
->
äom
,

216 
¾cf
->
»cursive
)

217 !ð
NGX_DECLINED
)

219  
	`ngx_h‰p_»®_£t_addr
(
r
, &
addr
);

222  
NGX_DECLINED
;

223 
	}
}

226 
ngx_št_t


227 
	$ngx_h‰p_»®_£t_addr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_addr_t
 *
addr
)

229 
size_t
 
Ën
;

230 
u_ch¬
 *
p
;

231 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

232 
ngx_cÚÃùiÚ_t
 *
c
;

233 
ngx_poÞ_þ—nup_t
 *
þn
;

234 
ngx_h‰p_»®_ùx_t
 *
ùx
;

236 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
r
->
poÞ
, (
ngx_h‰p_»®_ùx_t
));

237 ià(
þn
 =ð
NULL
) {

238  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

241 
ùx
 = 
þn
->
d©a
;

242 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_»®_moduË
);

244 
c
 = 
r
->
cÚÃùiÚ
;

246 
Ën
 = 
	`ngx_sock_ÁÝ
(
addr
->
sockaddr
,‡ddr->
sockËn
, 
‹xt
,

247 
NGX_SOCKADDR_STRLEN
, 0);

248 ià(
Ën
 == 0) {

249  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

252 
p
 = 
	`ngx_²®loc
(
c
->
poÞ
, 
Ën
);

253 ià(
p
 =ð
NULL
) {

254  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

257 
	`ngx_memýy
(
p
, 
‹xt
, 
Ën
);

259 
þn
->
hªdËr
 = 
ngx_h‰p_»®_þ—nup
;

261 
ùx
->
cÚÃùiÚ
 = 
c
;

262 
ùx
->
sockaddr
 = 
c
->sockaddr;

263 
ùx
->
sockËn
 = 
c
->socklen;

264 
ùx
->
addr_‹xt
 = 
c
->addr_text;

266 
c
->
sockaddr
 = 
addr
->sockaddr;

267 
c
->
sockËn
 = 
addr
->socklen;

268 
c
->
addr_‹xt
.
Ën
 =†en;

269 
c
->
addr_‹xt
.
d©a
 = 
p
;

271  
NGX_DECLINED
;

272 
	}
}

276 
	$ngx_h‰p_»®_þ—nup
(*
d©a
)

278 
ngx_h‰p_»®_ùx_t
 *
ùx
 = 
d©a
;

280 
ngx_cÚÃùiÚ_t
 *
c
;

282 
c
 = 
ùx
->
cÚÃùiÚ
;

284 
c
->
sockaddr
 = 
ùx
->sockaddr;

285 
c
->
sockËn
 = 
ùx
->socklen;

286 
c
->
addr_‹xt
 = 
ùx
->addr_text;

287 
	}
}

291 
	$ngx_h‰p_»®_äom
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

293 
ngx_h‰p_»®_loc_cÚf_t
 *
¾cf
 = 
cÚf
;

295 
ngx_št_t
 
rc
;

296 
ngx_¡r_t
 *
v®ue
;

297 
ngx_cidr_t
 *
cidr
;

299 
v®ue
 = 
cf
->
¬gs
->
–ts
;

301 ià(
¾cf
->
äom
 =ð
NULL
) {

302 
¾cf
->
äom
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 2,

303 (
ngx_cidr_t
));

304 ià(
¾cf
->
äom
 =ð
NULL
) {

305  
NGX_CONF_ERROR
;

309 
cidr
 = 
	`ngx_¬¿y_push
(
¾cf
->
äom
);

310 ià(
cidr
 =ð
NULL
) {

311  
NGX_CONF_ERROR
;

314 #ià(
NGX_HAVE_UNIX_DOMAIN
)

316 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "unix:") == 0) {

317 
cidr
->
çmžy
 = 
AF_UNIX
;

318  
NGX_CONF_OK
;

323 
rc
 = 
	`ngx_±ocidr
(&
v®ue
[1], 
cidr
);

325 ià(
rc
 =ð
NGX_ERROR
) {

326 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "invalid…arameter \"%V\"",

327 &
v®ue
[1]);

328  
NGX_CONF_ERROR
;

331 ià(
rc
 =ð
NGX_DONE
) {

332 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

333 "low‡dd»s b™ oà%V‡» m—nšgËss", &
v®ue
[1]);

336  
NGX_CONF_OK
;

337 
	}
}

341 
	$ngx_h‰p_»®
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

343 
ngx_h‰p_»®_loc_cÚf_t
 *
¾cf
 = 
cÚf
;

345 
ngx_¡r_t
 *
v®ue
;

347 
v®ue
 = 
cf
->
¬gs
->
–ts
;

349 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "X-Real-IP") == 0) {

350 
¾cf
->
ty³
 = 
NGX_HTTP_REALIP_XREALIP
;

351  
NGX_CONF_OK
;

354 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "X-Forwarded-For") == 0) {

355 
¾cf
->
ty³
 = 
NGX_HTTP_REALIP_XFWD
;

356  
NGX_CONF_OK
;

359 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "proxy_protocol") == 0) {

360 
¾cf
->
ty³
 = 
NGX_HTTP_REALIP_PROXY
;

361  
NGX_CONF_OK
;

364 
¾cf
->
ty³
 = 
NGX_HTTP_REALIP_HEADER
;

365 
¾cf
->
hash
 = 
	`ngx_hash_¡¾ow
(
v®ue
[1].
d©a
, v®ue[1].d©a, v®ue[1].
Ën
);

366 
¾cf
->
h—d”
 = 
v®ue
[1];

368  
NGX_CONF_OK
;

369 
	}
}

373 
	$ngx_h‰p_»®_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

375 
ngx_h‰p_»®_loc_cÚf_t
 *
cÚf
;

377 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_»®_loc_cÚf_t
));

378 ià(
cÚf
 =ð
NULL
) {

379  
NULL
;

390 
cÚf
->
ty³
 = 
NGX_CONF_UNSET_UINT
;

391 
cÚf
->
»cursive
 = 
NGX_CONF_UNSET
;

393  
cÚf
;

394 
	}
}

398 
	$ngx_h‰p_»®_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

400 
ngx_h‰p_»®_loc_cÚf_t
 *
´ev
 = 
·»Á
;

401 
ngx_h‰p_»®_loc_cÚf_t
 *
cÚf
 = 
chžd
;

403 ià(
cÚf
->
äom
 =ð
NULL
) {

404 
cÚf
->
äom
 = 
´ev
->from;

407 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
ty³
, 
´ev
->ty³, 
NGX_HTTP_REALIP_XREALIP
);

408 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
»cursive
, 
´ev
->recursive, 0);

410 ià(
cÚf
->
h—d”
.
Ën
 == 0) {

411 
cÚf
->
hash
 = 
´ev
->hash;

412 
cÚf
->
h—d”
 = 
´ev
->header;

415  
NGX_CONF_OK
;

416 
	}
}

419 
ngx_št_t


420 
	$ngx_h‰p_»®_š™
(
ngx_cÚf_t
 *
cf
)

422 
ngx_h‰p_hªdËr_±
 *
h
;

423 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

425 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

427 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_POST_READ_PHASE
].
hªdËrs
);

428 ià(
h
 =ð
NULL
) {

429  
NGX_ERROR
;

432 *
h
 = 
ngx_h‰p_»®_hªdËr
;

434 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_PREACCESS_PHASE
].
hªdËrs
);

435 ià(
h
 =ð
NULL
) {

436  
NGX_ERROR
;

439 *
h
 = 
ngx_h‰p_»®_hªdËr
;

441  
NGX_OK
;

442 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_referer_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
	#NGX_HTTP_REFERER_NO_URI_PART
 ((*è4)

	)

17 
ngx_hash_combšed_t
 
	mhash
;

19 #ià(
NGX_PCRE
)

20 
ngx_¬¿y_t
 *
	m»gex
;

21 
ngx_¬¿y_t
 *
	m£rv”_Çme_»gex
;

24 
ngx_æag_t
 
	mno_»ã»r
;

25 
ngx_æag_t
 
	mblocked_»ã»r
;

26 
ngx_æag_t
 
	m£rv”_Çmes
;

28 
ngx_hash_keys_¬¿ys_t
 *
	mkeys
;

30 
ngx_ušt_t
 
	m»ã»r_hash_max_size
;

31 
ngx_ušt_t
 
	m»ã»r_hash_buck‘_size
;

32 } 
	tngx_h‰p_»ã»r_cÚf_t
;

35 * 
ngx_h‰p_»ã»r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

36 * 
ngx_h‰p_»ã»r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

37 *
chžd
);

38 *
ngx_h‰p_v®id_»ã»rs
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

39 *
cÚf
);

40 
ngx_št_t
 
ngx_h‰p_add_»ã»r
(
ngx_cÚf_t
 *
cf
,

41 
ngx_hash_keys_¬¿ys_t
 *
keys
, 
ngx_¡r_t
 *
v®ue
,‚gx_¡r_ˆ*
uri
);

42 
ngx_št_t
 
ngx_h‰p_add_»gex_»ã»r
(
ngx_cÚf_t
 *
cf
,

43 
ngx_h‰p_»ã»r_cÚf_t
 *
¾cf
, 
ngx_¡r_t
 *
Çme
);

44 #ià(
NGX_PCRE
)

45 
ngx_št_t
 
ngx_h‰p_add_»gex_£rv”_Çme
(
ngx_cÚf_t
 *
cf
,

46 
ngx_h‰p_»ã»r_cÚf_t
 *
¾cf
, 
ngx_h‰p_»gex_t
 *
»gex
);

48 
ngx_libc_cdeþ
 
ngx_h‰p_cmp_»ã»r_wždÿrds
(cÚ¡ *
Úe
,

49 cÚ¡ *
two
);

52 
ngx_commªd_t
 
	gngx_h‰p_»ã»r_commªds
[] = {

54 { 
ngx_¡ršg
("valid_referers"),

55 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

56 
ngx_h‰p_v®id_»ã»rs
,

57 
NGX_HTTP_LOC_CONF_OFFSET
,

59 
NULL
 },

61 { 
ngx_¡ršg
("referer_hash_max_size"),

62 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

63 
ngx_cÚf_£t_num_¦Ù
,

64 
NGX_HTTP_LOC_CONF_OFFSET
,

65 
off£tof
(
ngx_h‰p_»ã»r_cÚf_t
, 
»ã»r_hash_max_size
),

66 
NULL
 },

68 { 
ngx_¡ršg
("referer_hash_bucket_size"),

69 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

70 
ngx_cÚf_£t_num_¦Ù
,

71 
NGX_HTTP_LOC_CONF_OFFSET
,

72 
off£tof
(
ngx_h‰p_»ã»r_cÚf_t
, 
»ã»r_hash_buck‘_size
),

73 
NULL
 },

75 
ngx_nuÎ_commªd


79 
ngx_h‰p_moduË_t
 
	gngx_h‰p_»ã»r_moduË_ùx
 = {

80 
NULL
,

81 
NULL
,

83 
NULL
,

84 
NULL
,

86 
NULL
,

87 
NULL
,

89 
ngx_h‰p_»ã»r_ü—‹_cÚf
,

90 
ngx_h‰p_»ã»r_m”ge_cÚf


94 
ngx_moduË_t
 
	gngx_h‰p_»ã»r_moduË
 = {

95 
NGX_MODULE_V1
,

96 &
ngx_h‰p_»ã»r_moduË_ùx
,

97 
ngx_h‰p_»ã»r_commªds
,

98 
NGX_HTTP_MODULE
,

99 
NULL
,

100 
NULL
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NGX_MODULE_V1_PADDING


110 
ngx_št_t


111 
	$ngx_h‰p_»ã»r_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

112 
ušŒ_t
 
d©a
)

114 
u_ch¬
 *
p
, *
»f
, *
Ï¡
;

115 
size_t
 
Ën
;

116 
ngx_¡r_t
 *
uri
;

117 
ngx_ušt_t
 
i
, 
key
;

118 
ngx_h‰p_»ã»r_cÚf_t
 *
¾cf
;

119 
u_ch¬
 
buf
[256];

120 #ià(
NGX_PCRE
)

121 
ngx_št_t
 
rc
;

122 
ngx_¡r_t
 
»ã»r
;

125 
¾cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_»ã»r_moduË
);

127 ià(
¾cf
->
hash
.hash.
buck‘s
 =ð
NULL


128 && 
¾cf
->
hash
.
wc_h—d
 =ð
NULL


129 && 
¾cf
->
hash
.
wc_ž
 =ð
NULL


130 #ià(
NGX_PCRE
)

131 && 
¾cf
->
»gex
 =ð
NULL


132 && 
¾cf
->
£rv”_Çme_»gex
 =ð
NULL


136 
v®id
;

139 ià(
r
->
h—d”s_š
.
»ã»r
 =ð
NULL
) {

140 ià(
¾cf
->
no_»ã»r
) {

141 
v®id
;

144 
šv®id
;

147 
Ën
 = 
r
->
h—d”s_š
.
»ã»r
->
v®ue
.len;

148 
»f
 = 
r
->
h—d”s_š
.
»ã»r
->
v®ue
.
d©a
;

150 ià(
Ën
 >= ("http://i.ru") - 1) {

151 
Ï¡
 = 
»f
 + 
Ën
;

153 ià(
	`ngx_¡ºÿ£cmp
(
»f
, (
u_ch¬
 *) "http://", 7) == 0) {

154 
»f
 += 7;

155 
Ën
 -= 7;

156 
v®id_scheme
;

158 } ià(
	`ngx_¡ºÿ£cmp
(
»f
, (
u_ch¬
 *) "https://", 8) == 0) {

159 
»f
 += 8;

160 
Ën
 -= 8;

161 
v®id_scheme
;

165 ià(
¾cf
->
blocked_»ã»r
) {

166 
v®id
;

169 
šv®id
;

171 
v®id_scheme
:

173 
i
 = 0;

174 
key
 = 0;

176 
p
 = 
»f
;… < 
Ï¡
;…++) {

177 ià(*
p
 == '/' || *p == ':') {

181 ià(
i
 == 256) {

182 
šv®id
;

185 
buf
[
i
] = 
	`ngx_tÞow”
(*
p
);

186 
key
 = 
	`ngx_hash
(key, 
buf
[
i
++]);

189 
uri
 = 
	`ngx_hash_fšd_combšed
(&
¾cf
->
hash
, 
key
, 
buf
, 
p
 - 
»f
);

191 ià(
uri
) {

192 
uri
;

195 #ià(
NGX_PCRE
)

197 ià(
¾cf
->
£rv”_Çme_»gex
) {

198 
»ã»r
.
Ën
 = 
p
 - 
»f
;

199 
»ã»r
.
d©a
 = 
buf
;

201 
rc
 = 
	`ngx_»gex_exec_¬¿y
(
¾cf
->
£rv”_Çme_»gex
, &
»ã»r
,

202 
r
->
cÚÃùiÚ
->
log
);

204 ià(
rc
 =ð
NGX_OK
) {

205 
v®id
;

208 ià(
rc
 =ð
NGX_ERROR
) {

209  
rc
;

215 ià(
¾cf
->
»gex
) {

216 
»ã»r
.
Ën
 =†en;

217 
»ã»r
.
d©a
 = 
»f
;

219 
rc
 = 
	`ngx_»gex_exec_¬¿y
(
¾cf
->
»gex
, &
»ã»r
, 
r
->
cÚÃùiÚ
->
log
);

221 ià(
rc
 =ð
NGX_OK
) {

222 
v®id
;

225 ià(
rc
 =ð
NGX_ERROR
) {

226  
rc
;

234 
šv®id
:

236 *
v
 = 
ngx_h‰p_v¬ŸbË_Œue_v®ue
;

238  
NGX_OK
;

240 
uri
:

242  ; 
p
 < 
Ï¡
;…++) {

243 ià(*
p
 == '/') {

248 
Ën
 = 
Ï¡
 - 
p
;

250 ià(
uri
 =ð
NGX_HTTP_REFERER_NO_URI_PART
) {

251 
v®id
;

254 ià(
Ën
 < 
uri
->ËÀ|| 
	`ngx_¡ºcmp
(uri->
d©a
, 
p
, uri->len) != 0) {

255 
šv®id
;

258 
v®id
:

260 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

262  
NGX_OK
;

263 
	}
}

267 
	$ngx_h‰p_»ã»r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

269 
ngx_h‰p_»ã»r_cÚf_t
 *
cÚf
;

271 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_»ã»r_cÚf_t
));

272 ià(
cÚf
 =ð
NULL
) {

273  
NULL
;

284 #ià(
NGX_PCRE
)

285 
cÚf
->
»gex
 = 
NGX_CONF_UNSET_PTR
;

286 
cÚf
->
£rv”_Çme_»gex
 = 
NGX_CONF_UNSET_PTR
;

289 
cÚf
->
no_»ã»r
 = 
NGX_CONF_UNSET
;

290 
cÚf
->
blocked_»ã»r
 = 
NGX_CONF_UNSET
;

291 
cÚf
->
»ã»r_hash_max_size
 = 
NGX_CONF_UNSET_UINT
;

292 
cÚf
->
»ã»r_hash_buck‘_size
 = 
NGX_CONF_UNSET_UINT
;

294  
cÚf
;

295 
	}
}

299 
	$ngx_h‰p_»ã»r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

301 
ngx_h‰p_»ã»r_cÚf_t
 *
´ev
 = 
·»Á
;

302 
ngx_h‰p_»ã»r_cÚf_t
 *
cÚf
 = 
chžd
;

304 
ngx_ušt_t
 
n
;

305 
ngx_hash_š™_t
 
hash
;

306 
ngx_h‰p_£rv”_Çme_t
 *
¢
;

307 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

309 ià(
cÚf
->
keys
 =ð
NULL
) {

310 
cÚf
->
hash
 = 
´ev
->hash;

312 #ià(
NGX_PCRE
)

313 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
»gex
, 
´ev
->»gex, 
NULL
);

314 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
£rv”_Çme_»gex
,

315 
´ev
->
£rv”_Çme_»gex
, 
NULL
);

317 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
no_»ã»r
, 
´ev
->no_referer, 0);

318 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
blocked_»ã»r
, 
´ev
->blocked_referer, 0);

319 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
»ã»r_hash_max_size
,

320 
´ev
->
»ã»r_hash_max_size
, 2048);

321 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
»ã»r_hash_buck‘_size
,

322 
´ev
->
»ã»r_hash_buck‘_size
, 64);

324  
NGX_CONF_OK
;

327 ià(
cÚf
->
£rv”_Çmes
 == 1) {

328 
cscf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_¤v_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

330 
¢
 = 
cscf
->
£rv”_Çmes
.
–ts
;

331 
n
 = 0;‚ < 
cscf
->
£rv”_Çmes
.
ÃÉs
;‚++) {

333 #ià(
NGX_PCRE
)

334 ià(
¢
[
n
].
»gex
) {

336 ià(
	`ngx_h‰p_add_»gex_£rv”_Çme
(
cf
, 
cÚf
, 
¢
[
n
].
»gex
)

337 !ð
NGX_OK
)

339  
NGX_CONF_ERROR
;

346 ià(
	`ngx_h‰p_add_»ã»r
(
cf
, 
cÚf
->
keys
, &
¢
[
n
].
Çme
, 
NULL
)

347 !ð
NGX_OK
)

349  
NGX_CONF_ERROR
;

354 ià((
cÚf
->
no_»ã»r
 =ð1 || cÚf->
blocked_»ã»r
 == 1)

355 && 
cÚf
->
keys
->keys.
ÃÉs
 == 0

356 && 
cÚf
->
keys
->
dns_wc_h—d
.
ÃÉs
 == 0

357 && 
cÚf
->
keys
->
dns_wc_ž
.
ÃÉs
 == 0)

359 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

363  
NGX_CONF_ERROR
;

366 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
»ã»r_hash_max_size
,

367 
´ev
->
»ã»r_hash_max_size
, 2048);

368 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
»ã»r_hash_buck‘_size
,

369 
´ev
->
»ã»r_hash_buck‘_size
, 64);

370 
cÚf
->
»ã»r_hash_buck‘_size
 = 
	`ngx_®ign
(conf->referer_hash_bucket_size,

371 
ngx_ÿch–še_size
);

373 
hash
.
key
 = 
ngx_hash_key_lc
;

374 
hash
.
max_size
 = 
cÚf
->
»ã»r_hash_max_size
;

375 
hash
.
buck‘_size
 = 
cÚf
->
»ã»r_hash_buck‘_size
;

376 
hash
.
Çme
 = "referer_hash";

377 
hash
.
poÞ
 = 
cf
->pool;

379 ià(
cÚf
->
keys
->keys.
ÃÉs
) {

380 
hash
.hash = &
cÚf
->hash.hash;

381 
hash
.
‹mp_poÞ
 = 
NULL
;

383 ià(
	`ngx_hash_š™
(&
hash
, 
cÚf
->
keys
->keys.
–ts
, cÚf->keys->keys.
ÃÉs
)

384 !ð
NGX_OK
)

386  
NGX_CONF_ERROR
;

390 ià(
cÚf
->
keys
->
dns_wc_h—d
.
ÃÉs
) {

392 
	`ngx_qsÜt
(
cÚf
->
keys
->
dns_wc_h—d
.
–ts
,

393 (
size_t
è
cÚf
->
keys
->
dns_wc_h—d
.
ÃÉs
,

394 (
ngx_hash_key_t
),

395 
ngx_h‰p_cmp_»ã»r_wždÿrds
);

397 
hash
.hash = 
NULL
;

398 
hash
.
‹mp_poÞ
 = 
cf
->temp_pool;

400 ià(
	`ngx_hash_wždÿrd_š™
(&
hash
, 
cÚf
->
keys
->
dns_wc_h—d
.
–ts
,

401 
cÚf
->
keys
->
dns_wc_h—d
.
ÃÉs
)

402 !ð
NGX_OK
)

404  
NGX_CONF_ERROR
;

407 
cÚf
->
hash
.
wc_h—d
 = (
ngx_hash_wždÿrd_t
 *) hash.hash;

410 ià(
cÚf
->
keys
->
dns_wc_ž
.
ÃÉs
) {

412 
	`ngx_qsÜt
(
cÚf
->
keys
->
dns_wc_ž
.
–ts
,

413 (
size_t
è
cÚf
->
keys
->
dns_wc_ž
.
ÃÉs
,

414 (
ngx_hash_key_t
),

415 
ngx_h‰p_cmp_»ã»r_wždÿrds
);

417 
hash
.hash = 
NULL
;

418 
hash
.
‹mp_poÞ
 = 
cf
->temp_pool;

420 ià(
	`ngx_hash_wždÿrd_š™
(&
hash
, 
cÚf
->
keys
->
dns_wc_ž
.
–ts
,

421 
cÚf
->
keys
->
dns_wc_ž
.
ÃÉs
)

422 !ð
NGX_OK
)

424  
NGX_CONF_ERROR
;

427 
cÚf
->
hash
.
wc_ž
 = (
ngx_hash_wždÿrd_t
 *) hash.hash;

430 #ià(
NGX_PCRE
)

431 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
»gex
, 
´ev
->»gex, 
NULL
);

432 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
£rv”_Çme_»gex
, 
´ev
->server_name_regex,

433 
NULL
);

436 ià(
cÚf
->
no_»ã»r
 =ð
NGX_CONF_UNSET
) {

437 
cÚf
->
no_»ã»r
 = 0;

440 ià(
cÚf
->
blocked_»ã»r
 =ð
NGX_CONF_UNSET
) {

441 
cÚf
->
blocked_»ã»r
 = 0;

444 
cÚf
->
keys
 = 
NULL
;

446  
NGX_CONF_OK
;

447 
	}
}

451 
	$ngx_h‰p_v®id_»ã»rs
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

453 
ngx_h‰p_»ã»r_cÚf_t
 *
¾cf
 = 
cÚf
;

455 
u_ch¬
 *
p
;

456 
ngx_¡r_t
 *
v®ue
, 
uri
, 
Çme
;

457 
ngx_ušt_t
 
i
;

458 
ngx_h‰p_v¬ŸbË_t
 *
v¬
;

460 
	`ngx_¡r_£t
(&
Çme
, "invalid_referer");

462 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
Çme
, 
NGX_HTTP_VAR_CHANGEABLE
);

463 ià(
v¬
 =ð
NULL
) {

464  
NGX_CONF_ERROR
;

467 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_»ã»r_v¬ŸbË
;

469 ià(
¾cf
->
keys
 =ð
NULL
) {

470 
¾cf
->
keys
 = 
	`ngx_pÿÎoc
(
cf
->
‹mp_poÞ
, (
ngx_hash_keys_¬¿ys_t
));

471 ià(
¾cf
->
keys
 =ð
NULL
) {

472  
NGX_CONF_ERROR
;

475 
¾cf
->
keys
->
poÞ
 = 
cf
->pool;

476 
¾cf
->
keys
->
‹mp_poÞ
 = 
cf
->
poÞ
;

478 ià(
	`ngx_hash_keys_¬¿y_š™
(
¾cf
->
keys
, 
NGX_HASH_SMALL
è!ð
NGX_OK
) {

479  
NGX_CONF_ERROR
;

483 
v®ue
 = 
cf
->
¬gs
->
–ts
;

485 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

486 ià(
v®ue
[
i
].
Ën
 == 0) {

487 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

488 "šv®id„eã»¸\"%V\"", &
v®ue
[
i
]);

489  
NGX_CONF_ERROR
;

492 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "none") == 0) {

493 
¾cf
->
no_»ã»r
 = 1;

497 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "blocked") == 0) {

498 
¾cf
->
blocked_»ã»r
 = 1;

502 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "server_names") == 0) {

503 
¾cf
->
£rv”_Çmes
 = 1;

507 ià(
v®ue
[
i
].
d©a
[0] == '~') {

508 ià(
	`ngx_h‰p_add_»gex_»ã»r
(
cf
, 
¾cf
, &
v®ue
[
i
]è!ð
NGX_OK
) {

509  
NGX_CONF_ERROR
;

515 
	`ngx_¡r_nuÎ
(&
uri
);

517 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(
v®ue
[
i
].
d©a
, '/');

519 ià(
p
) {

520 
uri
.
Ën
 = (
v®ue
[
i
].
d©a
 + v®ue[i].Ënè- 
p
;

521 
uri
.
d©a
 = 
p
;

522 
v®ue
[
i
].
Ën
 = 
p
 - v®ue[i].
d©a
;

525 ià(
	`ngx_h‰p_add_»ã»r
(
cf
, 
¾cf
->
keys
, &
v®ue
[
i
], &
uri
è!ð
NGX_OK
) {

526  
NGX_CONF_ERROR
;

530  
NGX_CONF_OK
;

531 
	}
}

534 
ngx_št_t


535 
	$ngx_h‰p_add_»ã»r
(
ngx_cÚf_t
 *
cf
, 
ngx_hash_keys_¬¿ys_t
 *
keys
,

536 
ngx_¡r_t
 *
v®ue
,‚gx_¡r_ˆ*
uri
)

538 
ngx_št_t
 
rc
;

539 
ngx_¡r_t
 *
u
;

541 ià(
uri
 =ð
NULL
 || uri->
Ën
 == 0) {

542 
u
 = 
NGX_HTTP_REFERER_NO_URI_PART
;

545 
u
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_¡r_t
));

546 ià(
u
 =ð
NULL
) {

547  
NGX_ERROR
;

550 *
u
 = *
uri
;

553 
rc
 = 
	`ngx_hash_add_key
(
keys
, 
v®ue
, 
u
, 
NGX_HASH_WILDCARD_KEY
);

555 ià(
rc
 =ð
NGX_OK
) {

556  
NGX_OK
;

559 ià(
rc
 =ð
NGX_DECLINED
) {

560 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

561 "šv®id ho¡ÇmÜ wždÿrd \"%V\"", 
v®ue
);

564 ià(
rc
 =ð
NGX_BUSY
) {

565 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

566 "cÚæiùšg…¬am‘” \"%V\"", 
v®ue
);

569  
NGX_ERROR
;

570 
	}
}

573 
ngx_št_t


574 
	$ngx_h‰p_add_»gex_»ã»r
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_»ã»r_cÚf_t
 *
¾cf
,

575 
ngx_¡r_t
 *
Çme
)

577 #ià(
NGX_PCRE
)

578 
ngx_»gex_–t_t
 *
»
;

579 
ngx_»gex_compže_t
 
rc
;

580 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

582 ià(
Çme
->
Ën
 == 1) {

583 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "em±y„egex iÀ\"%V\"", 
Çme
);

584  
NGX_ERROR
;

587 ià(
¾cf
->
»gex
 =ð
NGX_CONF_UNSET_PTR
) {

588 
¾cf
->
»gex
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 2, (
ngx_»gex_–t_t
));

589 ià(
¾cf
->
»gex
 =ð
NULL
) {

590  
NGX_ERROR
;

594 
»
 = 
	`ngx_¬¿y_push
(
¾cf
->
»gex
);

595 ià(
»
 =ð
NULL
) {

596  
NGX_ERROR
;

599 
Çme
->
Ën
--;

600 
Çme
->
d©a
++;

602 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

604 
rc
.
·‰”n
 = *
Çme
;

605 
rc
.
poÞ
 = 
cf
->pool;

606 
rc
.
ÝtiÚs
 = 
NGX_REGEX_CASELESS
;

607 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

608 
rc
.
”r
.
d©a
 = 
”r¡r
;

610 ià(
	`ngx_»gex_compže
(&
rc
è!ð
NGX_OK
) {

611 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "%V", &
rc
.
”r
);

612  
NGX_ERROR
;

615 
»
->
»gex
 = 
rc
.regex;

616 
»
->
Çme
 =‚ame->
d©a
;

618  
NGX_OK
;

622 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

624 
Çme
);

626  
NGX_ERROR
;

629 
	}
}

632 #ià(
NGX_PCRE
)

634 
ngx_št_t


635 
	$ngx_h‰p_add_»gex_£rv”_Çme
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_»ã»r_cÚf_t
 *
¾cf
,

636 
ngx_h‰p_»gex_t
 *
»gex
)

638 
ngx_»gex_–t_t
 *
»
;

640 ià(
¾cf
->
£rv”_Çme_»gex
 =ð
NGX_CONF_UNSET_PTR
) {

641 
¾cf
->
£rv”_Çme_»gex
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 2,

642 (
ngx_»gex_–t_t
));

643 ià(
¾cf
->
£rv”_Çme_»gex
 =ð
NULL
) {

644  
NGX_ERROR
;

648 
»
 = 
	`ngx_¬¿y_push
(
¾cf
->
£rv”_Çme_»gex
);

649 ià(
»
 =ð
NULL
) {

650  
NGX_ERROR
;

653 
»
->
»gex
 =„egex->regex;

654 
»
->
Çme
 = 
»gex
->Çme.
d©a
;

656  
NGX_OK
;

657 
	}
}

662 
ngx_libc_cdeþ


663 
	$ngx_h‰p_cmp_»ã»r_wždÿrds
(cÚ¡ *
Úe
, cÚ¡ *
two
)

665 
ngx_hash_key_t
 *
fœ¡
, *
£cÚd
;

667 
fœ¡
 = (
ngx_hash_key_t
 *è
Úe
;

668 
£cÚd
 = (
ngx_hash_key_t
 *è
two
;

670  
	`ngx_dns_¡rcmp
(
fœ¡
->
key
.
d©a
, 
£cÚd
->key.data);

671 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_rewrite_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_¬¿y_t
 *
	mcodes
;

16 
ngx_ušt_t
 
	m¡ack_size
;

18 
ngx_æag_t
 
	mlog
;

19 
ngx_æag_t
 
	munš™Ÿlized_v¬ŸbË_w¬n
;

20 } 
	tngx_h‰p_»wr™e_loc_cÚf_t
;

23 *
ngx_h‰p_»wr™e_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

24 *
ngx_h‰p_»wr™e_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

25 *
·»Á
, *
chžd
);

26 
ngx_št_t
 
ngx_h‰p_»wr™e_š™
(
ngx_cÚf_t
 *
cf
);

27 *
ngx_h‰p_»wr™e
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

28 *
ngx_h‰p_»wr™e_»tuº
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

29 *
cÚf
);

30 *
ngx_h‰p_»wr™e_b»ak
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

31 *
cÚf
);

32 *
ngx_h‰p_»wr™e_if
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

33 *
cÚf
);

34 * 
ngx_h‰p_»wr™e_if_cÚd™iÚ
(
ngx_cÚf_t
 *
cf
,

35 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
);

36 *
ngx_h‰p_»wr™e_v¬ŸbË
(
ngx_cÚf_t
 *
cf
,

37 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
, 
ngx_¡r_t
 *
v®ue
);

38 *
ngx_h‰p_»wr™e_£t
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

39 *
cÚf
);

40 * 
ngx_h‰p_»wr™e_v®ue
(
ngx_cÚf_t
 *
cf
,

41 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
, 
ngx_¡r_t
 *
v®ue
);

44 
ngx_commªd_t
 
	gngx_h‰p_»wr™e_commªds
[] = {

46 { 
ngx_¡ršg
("rewrite"),

47 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_SIF_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


48 |
NGX_CONF_TAKE23
,

49 
ngx_h‰p_»wr™e
,

50 
NGX_HTTP_LOC_CONF_OFFSET
,

52 
NULL
 },

54 { 
ngx_¡ršg
("return"),

55 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_SIF_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


56 |
NGX_CONF_TAKE12
,

57 
ngx_h‰p_»wr™e_»tuº
,

58 
NGX_HTTP_LOC_CONF_OFFSET
,

60 
NULL
 },

62 { 
ngx_¡ršg
("break"),

63 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_SIF_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


64 |
NGX_CONF_NOARGS
,

65 
ngx_h‰p_»wr™e_b»ak
,

66 
NGX_HTTP_LOC_CONF_OFFSET
,

68 
NULL
 },

70 { 
ngx_¡ršg
("if"),

71 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_1MORE
,

72 
ngx_h‰p_»wr™e_if
,

73 
NGX_HTTP_LOC_CONF_OFFSET
,

75 
NULL
 },

77 { 
ngx_¡ršg
("set"),

78 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_SIF_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


79 |
NGX_CONF_TAKE2
,

80 
ngx_h‰p_»wr™e_£t
,

81 
NGX_HTTP_LOC_CONF_OFFSET
,

83 
NULL
 },

85 { 
ngx_¡ršg
("rewrite_log"),

86 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_SIF_CONF
|
NGX_HTTP_LOC_CONF


87 |
NGX_HTTP_LIF_CONF
|
NGX_CONF_FLAG
,

88 
ngx_cÚf_£t_æag_¦Ù
,

89 
NGX_HTTP_LOC_CONF_OFFSET
,

90 
off£tof
(
ngx_h‰p_»wr™e_loc_cÚf_t
, 
log
),

91 
NULL
 },

93 { 
ngx_¡ršg
("uninitialized_variable_warn"),

94 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_SIF_CONF
|
NGX_HTTP_LOC_CONF


95 |
NGX_HTTP_LIF_CONF
|
NGX_CONF_FLAG
,

96 
ngx_cÚf_£t_æag_¦Ù
,

97 
NGX_HTTP_LOC_CONF_OFFSET
,

98 
off£tof
(
ngx_h‰p_»wr™e_loc_cÚf_t
, 
unš™Ÿlized_v¬ŸbË_w¬n
),

99 
NULL
 },

101 
ngx_nuÎ_commªd


105 
ngx_h‰p_moduË_t
 
	gngx_h‰p_»wr™e_moduË_ùx
 = {

106 
NULL
,

107 
ngx_h‰p_»wr™e_š™
,

109 
NULL
,

110 
NULL
,

112 
NULL
,

113 
NULL
,

115 
ngx_h‰p_»wr™e_ü—‹_loc_cÚf
,

116 
ngx_h‰p_»wr™e_m”ge_loc_cÚf


120 
ngx_moduË_t
 
	gngx_h‰p_»wr™e_moduË
 = {

121 
NGX_MODULE_V1
,

122 &
ngx_h‰p_»wr™e_moduË_ùx
,

123 
ngx_h‰p_»wr™e_commªds
,

124 
NGX_HTTP_MODULE
,

125 
NULL
,

126 
NULL
,

127 
NULL
,

128 
NULL
,

129 
NULL
,

130 
NULL
,

131 
NULL
,

132 
NGX_MODULE_V1_PADDING


136 
ngx_št_t


137 
	$ngx_h‰p_»wr™e_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

139 
ngx_št_t
 
šdex
;

140 
ngx_h‰p_süt_code_±
 
code
;

141 
ngx_h‰p_süt_’gše_t
 *
e
;

142 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

143 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

144 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
¾cf
;

146 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

147 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

148 
šdex
 = 
cmcf
->
pha£_’gše
.
loÿtiÚ_»wr™e_šdex
;

150 ià(
r
->
pha£_hªdËr
 =ð
šdex
 &&„->
loc_cÚf
 =ð
cscf
->
ùx
->loc_conf) {

152  
NGX_DECLINED
;

155 
¾cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_»wr™e_moduË
);

157 ià(
¾cf
->
codes
 =ð
NULL
) {

158  
NGX_DECLINED
;

161 
e
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_süt_’gše_t
));

162 ià(
e
 =ð
NULL
) {

163  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

166 
e
->
¥
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
,

167 
¾cf
->
¡ack_size
 * (
ngx_h‰p_v¬ŸbË_v®ue_t
));

168 ià(
e
->
¥
 =ð
NULL
) {

169  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

172 
e
->

 = 
¾cf
->
codes
->
–ts
;

173 
e
->
»que¡
 = 
r
;

174 
e
->
quÙe
 = 1;

175 
e
->
log
 = 
¾cf
->log;

176 
e
->
¡©us
 = 
NGX_DECLINED
;

178 *(
ušŒ_t
 *è
e
->

) {

179 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
->

;

180 
	`code
(
e
);

183 ià(
e
->
¡©us
 < 
NGX_HTTP_BAD_REQUEST
) {

184  
e
->
¡©us
;

187 ià(
r
->
”r_¡©us
 == 0) {

188  
e
->
¡©us
;

191  
r
->
”r_¡©us
;

192 
	}
}

195 
ngx_št_t


196 
	$ngx_h‰p_»wr™e_v¬
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

197 
ušŒ_t
 
d©a
)

199 
ngx_h‰p_v¬ŸbË_t
 *
v¬
;

200 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

201 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
¾cf
;

203 
¾cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_»wr™e_moduË
);

205 ià(
¾cf
->
unš™Ÿlized_v¬ŸbË_w¬n
 == 0) {

206 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

207  
NGX_OK
;

210 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

212 
v¬
 = 
cmcf
->
v¬ŸbËs
.
–ts
;

220 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
r
->
cÚÃùiÚ
->
log
, 0,

221 "usšg unš™Ÿlized \"%V\" v¬ŸbË", &
v¬
[
d©a
].
Çme
);

223 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

225  
NGX_OK
;

226 
	}
}

230 
	$ngx_h‰p_»wr™e_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

232 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
cÚf
;

234 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_»wr™e_loc_cÚf_t
));

235 ià(
cÚf
 =ð
NULL
) {

236  
NULL
;

239 
cÚf
->
¡ack_size
 = 
NGX_CONF_UNSET_UINT
;

240 
cÚf
->
log
 = 
NGX_CONF_UNSET
;

241 
cÚf
->
unš™Ÿlized_v¬ŸbË_w¬n
 = 
NGX_CONF_UNSET
;

243  
cÚf
;

244 
	}
}

248 
	$ngx_h‰p_»wr™e_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

250 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
´ev
 = 
·»Á
;

251 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
cÚf
 = 
chžd
;

253 
ušŒ_t
 *
code
;

255 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
log
, 
´ev
->log, 0);

256 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
unš™Ÿlized_v¬ŸbË_w¬n
,

257 
´ev
->
unš™Ÿlized_v¬ŸbË_w¬n
, 1);

258 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
¡ack_size
, 
´ev
->stack_size, 10);

260 ià(
cÚf
->
codes
 =ð
NULL
) {

261  
NGX_CONF_OK
;

264 ià(
cÚf
->
codes
 =ð
´ev
->codes) {

265  
NGX_CONF_OK
;

268 
code
 = 
	`ngx_¬¿y_push_n
(
cÚf
->
codes
, (
ušŒ_t
));

269 ià(
code
 =ð
NULL
) {

270  
NGX_CONF_ERROR
;

273 *
code
 = (
ušŒ_t
è
NULL
;

275  
NGX_CONF_OK
;

276 
	}
}

279 
ngx_št_t


280 
	$ngx_h‰p_»wr™e_š™
(
ngx_cÚf_t
 *
cf
)

282 
ngx_h‰p_hªdËr_±
 *
h
;

283 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

285 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

287 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_SERVER_REWRITE_PHASE
].
hªdËrs
);

288 ià(
h
 =ð
NULL
) {

289  
NGX_ERROR
;

292 *
h
 = 
ngx_h‰p_»wr™e_hªdËr
;

294 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_REWRITE_PHASE
].
hªdËrs
);

295 ià(
h
 =ð
NULL
) {

296  
NGX_ERROR
;

299 *
h
 = 
ngx_h‰p_»wr™e_hªdËr
;

301  
NGX_OK
;

302 
	}
}

306 
	$ngx_h‰p_»wr™e
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

308 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
 = 
cÚf
;

310 
ngx_¡r_t
 *
v®ue
;

311 
ngx_ušt_t
 
Ï¡
;

312 
ngx_»gex_compže_t
 
rc
;

313 
ngx_h‰p_süt_code_±
 *
code
;

314 
ngx_h‰p_süt_compže_t
 
sc
;

315 
ngx_h‰p_süt_»gex_code_t
 *
»gex
;

316 
ngx_h‰p_süt_»gex_’d_code_t
 *
»gex_’d
;

317 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

319 
»gex
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

320 (
ngx_h‰p_süt_»gex_code_t
));

321 ià(
»gex
 =ð
NULL
) {

322  
NGX_CONF_ERROR
;

325 
	`ngx_memz”o
(
»gex
, (
ngx_h‰p_süt_»gex_code_t
));

327 
v®ue
 = 
cf
->
¬gs
->
–ts
;

329 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

331 
rc
.
·‰”n
 = 
v®ue
[1];

332 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

333 
rc
.
”r
.
d©a
 = 
”r¡r
;

337 
»gex
->»gex = 
	`ngx_h‰p_»gex_compže
(
cf
, &
rc
);

338 ià(
»gex
->»gex =ð
NULL
) {

339  
NGX_CONF_ERROR
;

342 
»gex
->
code
 = 
ngx_h‰p_süt_»gex_¡¬t_code
;

343 
»gex
->
uri
 = 1;

344 
»gex
->
Çme
 = 
v®ue
[1];

346 ià(
v®ue
[2].
d©a
[v®ue[2].
Ën
 - 1] == '?') {

349 
v®ue
[2].
Ën
--;

352 
»gex
->
add_¬gs
 = 1;

355 
Ï¡
 = 0;

357 ià(
	`ngx_¡ºcmp
(
v®ue
[2].
d©a
, "http://", ("http://") - 1) == 0

358 || 
	`ngx_¡ºcmp
(
v®ue
[2].
d©a
, "https://", ("https://") - 1) == 0

359 || 
	`ngx_¡ºcmp
(
v®ue
[2].
d©a
, "$scheme", ("$scheme") - 1) == 0)

361 
»gex
->
¡©us
 = 
NGX_HTTP_MOVED_TEMPORARILY
;

362 
»gex
->
»dœeù
 = 1;

363 
Ï¡
 = 1;

366 ià(
cf
->
¬gs
->
ÃÉs
 == 4) {

367 ià(
	`ngx_¡rcmp
(
v®ue
[3].
d©a
, "last") == 0) {

368 
Ï¡
 = 1;

370 } ià(
	`ngx_¡rcmp
(
v®ue
[3].
d©a
, "break") == 0) {

371 
»gex
->
b»ak_cyþe
 = 1;

372 
Ï¡
 = 1;

374 } ià(
	`ngx_¡rcmp
(
v®ue
[3].
d©a
, "redirect") == 0) {

375 
»gex
->
¡©us
 = 
NGX_HTTP_MOVED_TEMPORARILY
;

376 
»gex
->
»dœeù
 = 1;

377 
Ï¡
 = 1;

379 } ià(
	`ngx_¡rcmp
(
v®ue
[3].
d©a
, "permanent") == 0) {

380 
»gex
->
¡©us
 = 
NGX_HTTP_MOVED_PERMANENTLY
;

381 
»gex
->
»dœeù
 = 1;

382 
Ï¡
 = 1;

385 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

386 "šv®id…¬am‘” \"%V\"", &
v®ue
[3]);

387  
NGX_CONF_ERROR
;

391 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

393 
sc
.
cf
 = cf;

394 
sc
.
sourû
 = &
v®ue
[2];

395 
sc
.
Ëngths
 = &
»gex
->lengths;

396 
sc
.
v®ues
 = &
lcf
->
codes
;

397 
sc
.
v¬ŸbËs
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
v®ue
[2]);

398 
sc
.
maš
 = 
»gex
;

399 
sc
.
com¶‘e_Ëngths
 = 1;

400 
sc
.
compže_¬gs
 = !
»gex
->
»dœeù
;

402 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

403  
NGX_CONF_ERROR
;

406 
»gex
 = 
sc
.
maš
;

408 
»gex
->
size
 = 
sc
.size;

409 
»gex
->
¬gs
 = 
sc
.args;

411 ià(
sc
.
v¬ŸbËs
 =ð0 && !sc.
dup_ÿ±u»
) {

412 
»gex
->
Ëngths
 = 
NULL
;

415 
»gex_’d
 = 
	`ngx_h‰p_süt_add_code
(
lcf
->
codes
,

416 (
ngx_h‰p_süt_»gex_’d_code_t
),

417 &
»gex
);

418 ià(
»gex_’d
 =ð
NULL
) {

419  
NGX_CONF_ERROR
;

422 
»gex_’d
->
code
 = 
ngx_h‰p_süt_»gex_’d_code
;

423 
»gex_’d
->
uri
 = 
»gex
->uri;

424 
»gex_’d
->
¬gs
 = 
»gex
->args;

425 
»gex_’d
->
add_¬gs
 = 
»gex
->add_args;

426 
»gex_’d
->
»dœeù
 = 
»gex
->redirect;

428 ià(
Ï¡
) {

429 
code
 = 
	`ngx_h‰p_süt_add_code
(
lcf
->
codes
, (
ušŒ_t
), &
»gex
);

430 ià(
code
 =ð
NULL
) {

431  
NGX_CONF_ERROR
;

434 *
code
 = 
NULL
;

437 
»gex
->
Ãxt
 = (
u_ch¬
 *è
lcf
->
codes
->
–ts
 +†cf->codes->
ÃÉs


438 - (
u_ch¬
 *è
»gex
;

440  
NGX_CONF_OK
;

441 
	}
}

445 
	$ngx_h‰p_»wr™e_»tuº
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

447 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
 = 
cÚf
;

449 
u_ch¬
 *
p
;

450 
ngx_¡r_t
 *
v®ue
, *
v
;

451 
ngx_h‰p_süt_»tuº_code_t
 *
»t
;

452 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

454 
»t
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

455 (
ngx_h‰p_süt_»tuº_code_t
));

456 ià(
»t
 =ð
NULL
) {

457  
NGX_CONF_ERROR
;

460 
v®ue
 = 
cf
->
¬gs
->
–ts
;

462 
	`ngx_memz”o
(
»t
, (
ngx_h‰p_süt_»tuº_code_t
));

464 
»t
->
code
 = 
ngx_h‰p_süt_»tuº_code
;

466 
p
 = 
v®ue
[1].
d©a
;

468 
»t
->
¡©us
 = 
	`ngx_©oi
(
p
, 
v®ue
[1].
Ën
);

470 ià(
»t
->
¡©us
 =ð(
ušŒ_t
è
NGX_ERROR
) {

472 ià(
cf
->
¬gs
->
ÃÉs
 == 2

473 && (
	`ngx_¡ºcmp
(
p
, "http://", ("http://") - 1) == 0

474 || 
	`ngx_¡ºcmp
(
p
, "https://", ("https://") - 1) == 0

475 || 
	`ngx_¡ºcmp
(
p
, "$scheme", ("$scheme") - 1) == 0))

477 
»t
->
¡©us
 = 
NGX_HTTP_MOVED_TEMPORARILY
;

478 
v
 = &
v®ue
[1];

481 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

482 "šv®id„‘uº cod\"%V\"", &
v®ue
[1]);

483  
NGX_CONF_ERROR
;

488 ià(
»t
->
¡©us
 > 999) {

489 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

490 "šv®id„‘uº cod\"%V\"", &
v®ue
[1]);

491  
NGX_CONF_ERROR
;

494 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

495  
NGX_CONF_OK
;

498 
v
 = &
v®ue
[2];

501 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

503 
ccv
.
cf
 = cf;

504 
ccv
.
v®ue
 = 
v
;

505 
ccv
.
com¶ex_v®ue
 = &
»t
->
‹xt
;

507 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

508  
NGX_CONF_ERROR
;

511  
NGX_CONF_OK
;

512 
	}
}

516 
	$ngx_h‰p_»wr™e_b»ak
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

518 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
 = 
cÚf
;

520 
ngx_h‰p_süt_code_±
 *
code
;

522 
code
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
, (
ušŒ_t
));

523 ià(
code
 =ð
NULL
) {

524  
NGX_CONF_ERROR
;

527 *
code
 = 
ngx_h‰p_süt_b»ak_code
;

529  
NGX_CONF_OK
;

530 
	}
}

534 
	$ngx_h‰p_»wr™e_if
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

536 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
 = 
cÚf
;

538 *
mcÚf
;

539 *
rv
;

540 
u_ch¬
 *
–ts
;

541 
ngx_ušt_t
 
i
;

542 
ngx_cÚf_t
 
§ve
;

543 
ngx_h‰p_moduË_t
 *
moduË
;

544 
ngx_h‰p_cÚf_ùx_t
 *
ùx
, *
pùx
;

545 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, *
pþcf
;

546 
ngx_h‰p_süt_if_code_t
 *
if_code
;

547 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
Æcf
;

549 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÚf_ùx_t
));

550 ià(
ùx
 =ð
NULL
) {

551  
NGX_CONF_ERROR
;

554 
pùx
 = 
cf
->
ùx
;

555 
ùx
->
maš_cÚf
 = 
pùx
->main_conf;

556 
ùx
->
¤v_cÚf
 = 
pùx
->srv_conf;

558 
ùx
->
loc_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

559 ià(
ùx
->
loc_cÚf
 =ð
NULL
) {

560  
NGX_CONF_ERROR
;

563 
i
 = 0; 
ngx_moduËs
[i]; i++) {

564 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

568 
moduË
 = 
ngx_moduËs
[
i
]->
ùx
;

570 ià(
moduË
->
ü—‹_loc_cÚf
) {

572 
mcÚf
 = 
moduË
->
	`ü—‹_loc_cÚf
(
cf
);

573 ià(
mcÚf
 =ð
NULL
) {

574  
NGX_CONF_ERROR
;

577 
ùx
->
loc_cÚf
[
ngx_moduËs
[
i
]->
ùx_šdex
] = 
mcÚf
;

581 
pþcf
 = 
pùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

583 
þcf
 = 
ùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

584 
þcf
->
loc_cÚf
 = 
ùx
->loc_conf;

585 
þcf
->
Çme
 = 
pþcf
->name;

586 
þcf
->
nÚame
 = 1;

588 ià(
	`ngx_h‰p_add_loÿtiÚ
(
cf
, &
pþcf
->
loÿtiÚs
, 
þcf
è!ð
NGX_OK
) {

589  
NGX_CONF_ERROR
;

592 ià(
	`ngx_h‰p_»wr™e_if_cÚd™iÚ
(
cf
, 
lcf
è!ð
NGX_CONF_OK
) {

593  
NGX_CONF_ERROR
;

596 
if_code
 = 
	`ngx_¬¿y_push_n
(
lcf
->
codes
, (
ngx_h‰p_süt_if_code_t
));

597 ià(
if_code
 =ð
NULL
) {

598  
NGX_CONF_ERROR
;

601 
if_code
->
code
 = 
ngx_h‰p_süt_if_code
;

603 
–ts
 = 
lcf
->
codes
->elts;

608 
Æcf
 = 
ùx
->
loc_cÚf
[
ngx_h‰p_»wr™e_moduË
.
ùx_šdex
];

609 
Æcf
->
codes
 = 
lcf
->codes;

612 
§ve
 = *
cf
;

613 
cf
->
ùx
 = ctx;

615 ià(
pþcf
->
Çme
.
Ën
 == 0) {

616 
if_code
->
loc_cÚf
 = 
NULL
;

617 
cf
->
cmd_ty³
 = 
NGX_HTTP_SIF_CONF
;

620 
if_code
->
loc_cÚf
 = 
ùx
->loc_conf;

621 
cf
->
cmd_ty³
 = 
NGX_HTTP_LIF_CONF
;

624 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

626 *
cf
 = 
§ve
;

628 ià(
rv
 !ð
NGX_CONF_OK
) {

629  
rv
;

633 ià(
–ts
 !ð
lcf
->
codes
->elts) {

634 
if_code
 = (
ngx_h‰p_süt_if_code_t
 *)

635 ((
u_ch¬
 *è
if_code
 + ((u_ch¬ *è
lcf
->
codes
->
–ts
 -ƒlts));

638 
if_code
->
Ãxt
 = (
u_ch¬
 *è
lcf
->
codes
->
–ts
 +†cf->codes->
ÃÉs


639 - (
u_ch¬
 *è
if_code
;

643 
Æcf
->
codes
 = 
NULL
;

645  
NGX_CONF_OK
;

646 
	}
}

650 
	$ngx_h‰p_»wr™e_if_cÚd™iÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
)

652 
u_ch¬
 *
p
;

653 
size_t
 
Ën
;

654 
ngx_¡r_t
 *
v®ue
;

655 
ngx_ušt_t
 
cur
, 
Ï¡
;

656 
ngx_»gex_compže_t
 
rc
;

657 
ngx_h‰p_süt_code_±
 *
code
;

658 
ngx_h‰p_süt_fže_code_t
 *
fÝ
;

659 
ngx_h‰p_süt_»gex_code_t
 *
»gex
;

660 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

662 
v®ue
 = 
cf
->
¬gs
->
–ts
;

663 
Ï¡
 = 
cf
->
¬gs
->
ÃÉs
 - 1;

665 ià(
v®ue
[1].
Ën
 < 1 || v®ue[1].
d©a
[0] != '(') {

666 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

667 "šv®id cÚd™iÚ \"%V\"", &
v®ue
[1]);

668  
NGX_CONF_ERROR
;

671 ià(
v®ue
[1].
Ën
 == 1) {

672 
cur
 = 2;

675 
cur
 = 1;

676 
v®ue
[1].
Ën
--;

677 
v®ue
[1].
d©a
++;

680 ià(
v®ue
[
Ï¡
].
Ën
 < 1 || v®ue[Ï¡].
d©a
[value[last].len - 1] != ')') {

681 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

682 "šv®id cÚd™iÚ \"%V\"", &
v®ue
[
Ï¡
]);

683  
NGX_CONF_ERROR
;

686 ià(
v®ue
[
Ï¡
].
Ën
 == 1) {

687 
Ï¡
--;

690 
v®ue
[
Ï¡
].
Ën
--;

691 
v®ue
[
Ï¡
].
d©a
[v®ue[Ï¡].
Ën
] = '\0';

694 
Ën
 = 
v®ue
[
cur
].len;

695 
p
 = 
v®ue
[
cur
].
d©a
;

697 ià(
Ën
 > 1 && 
p
[0] == '$') {

699 ià(
cur
 !ð
Ï¡
 && cur + 2 !=†ast) {

700 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

701 "šv®id cÚd™iÚ \"%V\"", &
v®ue
[
cur
]);

702  
NGX_CONF_ERROR
;

705 ià(
	`ngx_h‰p_»wr™e_v¬ŸbË
(
cf
, 
lcf
, &
v®ue
[
cur
]è!ð
NGX_CONF_OK
) {

706  
NGX_CONF_ERROR
;

709 ià(
cur
 =ð
Ï¡
) {

710  
NGX_CONF_OK
;

713 
cur
++;

715 
Ën
 = 
v®ue
[
cur
].len;

716 
p
 = 
v®ue
[
cur
].
d©a
;

718 ià(
Ën
 =ð1 && 
p
[0] == '=') {

720 ià(
	`ngx_h‰p_»wr™e_v®ue
(
cf
, 
lcf
, &
v®ue
[
Ï¡
]è!ð
NGX_CONF_OK
) {

721  
NGX_CONF_ERROR
;

724 
code
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

725 (
ušŒ_t
));

726 ià(
code
 =ð
NULL
) {

727  
NGX_CONF_ERROR
;

730 *
code
 = 
ngx_h‰p_süt_equ®_code
;

732  
NGX_CONF_OK
;

735 ià(
Ën
 =ð2 && 
p
[0] == '!' &&…[1] == '=') {

737 ià(
	`ngx_h‰p_»wr™e_v®ue
(
cf
, 
lcf
, &
v®ue
[
Ï¡
]è!ð
NGX_CONF_OK
) {

738  
NGX_CONF_ERROR
;

741 
code
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

742 (
ušŒ_t
));

743 ià(
code
 =ð
NULL
) {

744  
NGX_CONF_ERROR
;

747 *
code
 = 
ngx_h‰p_süt_nÙ_equ®_code
;

748  
NGX_CONF_OK
;

751 ià((
Ën
 =ð1 && 
p
[0] == '~')

752 || (
Ën
 =ð2 && 
p
[0] == '~' &&…[1] == '*')

753 || (
Ën
 =ð2 && 
p
[0] == '!' &&…[1] == '~')

754 || (
Ën
 =ð3 && 
p
[0] == '!' &&…[1] == '~' &&…[2] == '*'))

756 
»gex
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

757 (
ngx_h‰p_süt_»gex_code_t
));

758 ià(
»gex
 =ð
NULL
) {

759  
NGX_CONF_ERROR
;

762 
	`ngx_memz”o
(
»gex
, (
ngx_h‰p_süt_»gex_code_t
));

764 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

766 
rc
.
·‰”n
 = 
v®ue
[
Ï¡
];

767 
rc
.
ÝtiÚs
 = (
p
[
Ën
 - 1] =ð'*'è? 
NGX_REGEX_CASELESS
 : 0;

768 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

769 
rc
.
”r
.
d©a
 = 
”r¡r
;

771 
»gex
->»gex = 
	`ngx_h‰p_»gex_compže
(
cf
, &
rc
);

772 ià(
»gex
->»gex =ð
NULL
) {

773  
NGX_CONF_ERROR
;

776 
»gex
->
code
 = 
ngx_h‰p_süt_»gex_¡¬t_code
;

777 
»gex
->
Ãxt
 = (
ngx_h‰p_süt_»gex_code_t
);

778 
»gex
->
‹¡
 = 1;

779 ià(
p
[0] == '!') {

780 
»gex
->
Ãg©ive_‹¡
 = 1;

782 
»gex
->
Çme
 = 
v®ue
[
Ï¡
];

784  
NGX_CONF_OK
;

787 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

788 "uÃx³ùed \"%V\" iÀcÚd™iÚ", &
v®ue
[
cur
]);

789  
NGX_CONF_ERROR
;

791 } ià((
Ën
 =ð2 && 
p
[0] == '-')

792 || (
Ën
 =ð3 && 
p
[0] == '!' &&…[1] == '-'))

794 ià(
cur
 + 1 !ð
Ï¡
) {

795 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

796 "šv®id cÚd™iÚ \"%V\"", &
v®ue
[
cur
]);

797  
NGX_CONF_ERROR
;

800 
v®ue
[
Ï¡
].
d©a
[v®ue[Ï¡].
Ën
] = '\0';

801 
v®ue
[
Ï¡
].
Ën
++;

803 ià(
	`ngx_h‰p_»wr™e_v®ue
(
cf
, 
lcf
, &
v®ue
[
Ï¡
]è!ð
NGX_CONF_OK
) {

804  
NGX_CONF_ERROR
;

807 
fÝ
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

808 (
ngx_h‰p_süt_fže_code_t
));

809 ià(
fÝ
 =ð
NULL
) {

810  
NGX_CONF_ERROR
;

813 
fÝ
->
code
 = 
ngx_h‰p_süt_fže_code
;

815 ià(
p
[1] == 'f') {

816 
fÝ
->
Ý
 = 
ngx_h‰p_süt_fže_¶aš
;

817  
NGX_CONF_OK
;

820 ià(
p
[1] == 'd') {

821 
fÝ
->
Ý
 = 
ngx_h‰p_süt_fže_dœ
;

822  
NGX_CONF_OK
;

825 ià(
p
[1] == 'e') {

826 
fÝ
->
Ý
 = 
ngx_h‰p_süt_fže_exi¡s
;

827  
NGX_CONF_OK
;

830 ià(
p
[1] == 'x') {

831 
fÝ
->
Ý
 = 
ngx_h‰p_süt_fže_exec
;

832  
NGX_CONF_OK
;

835 ià(
p
[0] == '!') {

836 ià(
p
[2] == 'f') {

837 
fÝ
->
Ý
 = 
ngx_h‰p_süt_fže_nÙ_¶aš
;

838  
NGX_CONF_OK
;

841 ià(
p
[2] == 'd') {

842 
fÝ
->
Ý
 = 
ngx_h‰p_süt_fže_nÙ_dœ
;

843  
NGX_CONF_OK
;

846 ià(
p
[2] == 'e') {

847 
fÝ
->
Ý
 = 
ngx_h‰p_süt_fže_nÙ_exi¡s
;

848  
NGX_CONF_OK
;

851 ià(
p
[2] == 'x') {

852 
fÝ
->
Ý
 = 
ngx_h‰p_süt_fže_nÙ_exec
;

853  
NGX_CONF_OK
;

857 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

858 "šv®id cÚd™iÚ \"%V\"", &
v®ue
[
cur
]);

859  
NGX_CONF_ERROR
;

862 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

863 "šv®id cÚd™iÚ \"%V\"", &
v®ue
[
cur
]);

865  
NGX_CONF_ERROR
;

866 
	}
}

870 
	$ngx_h‰p_»wr™e_v¬ŸbË
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
,

871 
ngx_¡r_t
 *
v®ue
)

873 
ngx_št_t
 
šdex
;

874 
ngx_h‰p_süt_v¬_code_t
 *
v¬_code
;

876 
v®ue
->
Ën
--;

877 
v®ue
->
d©a
++;

879 
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, 
v®ue
);

881 ià(
šdex
 =ð
NGX_ERROR
) {

882  
NGX_CONF_ERROR
;

885 
v¬_code
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

886 (
ngx_h‰p_süt_v¬_code_t
));

887 ià(
v¬_code
 =ð
NULL
) {

888  
NGX_CONF_ERROR
;

891 
v¬_code
->
code
 = 
ngx_h‰p_süt_v¬_code
;

892 
v¬_code
->
šdex
 = index;

894  
NGX_CONF_OK
;

895 
	}
}

899 
	$ngx_h‰p_»wr™e_£t
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

901 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
 = 
cÚf
;

903 
ngx_št_t
 
šdex
;

904 
ngx_¡r_t
 *
v®ue
;

905 
ngx_h‰p_v¬ŸbË_t
 *
v
;

906 
ngx_h‰p_süt_v¬_code_t
 *
vcode
;

907 
ngx_h‰p_süt_v¬_hªdËr_code_t
 *
vhcode
;

909 
v®ue
 = 
cf
->
¬gs
->
–ts
;

911 ià(
v®ue
[1].
d©a
[0] != '$') {

912 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

913 "šv®id v¬ŸbË‚am\"%V\"", &
v®ue
[1]);

914  
NGX_CONF_ERROR
;

917 
v®ue
[1].
Ën
--;

918 
v®ue
[1].
d©a
++;

920 
v
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v®ue
[1], 
NGX_HTTP_VAR_CHANGEABLE
);

921 ià(
v
 =ð
NULL
) {

922  
NGX_CONF_ERROR
;

925 
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, &
v®ue
[1]);

926 ià(
šdex
 =ð
NGX_ERROR
) {

927  
NGX_CONF_ERROR
;

930 ià(
v
->
g‘_hªdËr
 =ð
NULL


931 && 
	`ngx_¡ºÿ£cmp
(
v®ue
[1].
d©a
, (
u_ch¬
 *) "http_", 5) != 0

932 && 
	`ngx_¡ºÿ£cmp
(
v®ue
[1].
d©a
, (
u_ch¬
 *) "sent_http_", 10) != 0

933 && 
	`ngx_¡ºÿ£cmp
(
v®ue
[1].
d©a
, (
u_ch¬
 *) "upstream_http_", 14) != 0

934 && 
	`ngx_¡ºÿ£cmp
(
v®ue
[1].
d©a
, (
u_ch¬
 *) "cookie_", 7) != 0

935 && 
	`ngx_¡ºÿ£cmp
(
v®ue
[1].
d©a
, (
u_ch¬
 *) "upstream_cookie_", 16)

937 && 
	`ngx_¡ºÿ£cmp
(
v®ue
[1].
d©a
, (
u_ch¬
 *) "arg_", 4) != 0)

939 
v
->
g‘_hªdËr
 = 
ngx_h‰p_»wr™e_v¬
;

940 
v
->
d©a
 = 
šdex
;

943 ià(
	`ngx_h‰p_»wr™e_v®ue
(
cf
, 
lcf
, &
v®ue
[2]è!ð
NGX_CONF_OK
) {

944  
NGX_CONF_ERROR
;

947 ià(
v
->
£t_hªdËr
) {

948 
vhcode
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

949 (
ngx_h‰p_süt_v¬_hªdËr_code_t
));

950 ià(
vhcode
 =ð
NULL
) {

951  
NGX_CONF_ERROR
;

954 
vhcode
->
code
 = 
ngx_h‰p_süt_v¬_£t_hªdËr_code
;

955 
vhcode
->
hªdËr
 = 
v
->
£t_hªdËr
;

956 
vhcode
->
d©a
 = 
v
->data;

958  
NGX_CONF_OK
;

961 
vcode
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

962 (
ngx_h‰p_süt_v¬_code_t
));

963 ià(
vcode
 =ð
NULL
) {

964  
NGX_CONF_ERROR
;

967 
vcode
->
code
 = 
ngx_h‰p_süt_£t_v¬_code
;

968 
vcode
->
šdex
 = (
ušŒ_t
) index;

970  
NGX_CONF_OK
;

971 
	}
}

975 
	$ngx_h‰p_»wr™e_v®ue
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_»wr™e_loc_cÚf_t
 *
lcf
,

976 
ngx_¡r_t
 *
v®ue
)

978 
ngx_št_t
 
n
;

979 
ngx_h‰p_süt_compže_t
 
sc
;

980 
ngx_h‰p_süt_v®ue_code_t
 *
v®
;

981 
ngx_h‰p_süt_com¶ex_v®ue_code_t
 *
com¶ex
;

983 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(
v®ue
);

985 ià(
n
 == 0) {

986 
v®
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

987 (
ngx_h‰p_süt_v®ue_code_t
));

988 ià(
v®
 =ð
NULL
) {

989  
NGX_CONF_ERROR
;

992 
n
 = 
	`ngx_©oi
(
v®ue
->
d©a
, v®ue->
Ën
);

994 ià(
n
 =ð
NGX_ERROR
) {

995 
n
 = 0;

998 
v®
->
code
 = 
ngx_h‰p_süt_v®ue_code
;

999 
v®
->
v®ue
 = (
ušŒ_t
è
n
;

1000 
v®
->
‹xt_Ën
 = (
ušŒ_t
è
v®ue
->
Ën
;

1001 
v®
->
‹xt_d©a
 = (
ušŒ_t
è
v®ue
->
d©a
;

1003  
NGX_CONF_OK
;

1006 
com¶ex
 = 
	`ngx_h‰p_süt_¡¬t_code
(
cf
->
poÞ
, &
lcf
->
codes
,

1007 (
ngx_h‰p_süt_com¶ex_v®ue_code_t
));

1008 ià(
com¶ex
 =ð
NULL
) {

1009  
NGX_CONF_ERROR
;

1012 
com¶ex
->
code
 = 
ngx_h‰p_süt_com¶ex_v®ue_code
;

1013 
com¶ex
->
Ëngths
 = 
NULL
;

1015 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

1017 
sc
.
cf
 = cf;

1018 
sc
.
sourû
 = 
v®ue
;

1019 
sc
.
Ëngths
 = &
com¶ex
->lengths;

1020 
sc
.
v®ues
 = &
lcf
->
codes
;

1021 
sc
.
v¬ŸbËs
 = 
n
;

1022 
sc
.
com¶‘e_Ëngths
 = 1;

1024 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

1025  
NGX_CONF_ERROR
;

1028  
NGX_CONF_OK
;

1029 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_scgi_module.c

9 
	~<ngx_cÚfig.h
>

10 
	~<ngx_cÜe.h
>

11 
	~<ngx_h‰p.h
>

15 
ngx_¬¿y_t
 *
	mæushes
;

16 
ngx_¬¿y_t
 *
	mËngths
;

17 
ngx_¬¿y_t
 *
	mv®ues
;

18 
ngx_ušt_t
 
	mnumb”
;

19 
ngx_hash_t
 
	mhash
;

20 } 
	tngx_h‰p_scgi_·¿ms_t
;

24 
ngx_h‰p_up¡»am_cÚf_t
 
	mup¡»am
;

26 
ngx_h‰p_scgi_·¿ms_t
 
	m·¿ms
;

27 #ià(
NGX_HTTP_CACHE
)

28 
ngx_h‰p_scgi_·¿ms_t
 
	m·¿ms_ÿche
;

30 
ngx_¬¿y_t
 *
	m·¿ms_sourû
;

32 
ngx_¬¿y_t
 *
	mscgi_Ëngths
;

33 
ngx_¬¿y_t
 *
	mscgi_v®ues
;

35 #ià(
NGX_HTTP_CACHE
)

36 
ngx_h‰p_com¶ex_v®ue_t
 
	mÿche_key
;

38 } 
	tngx_h‰p_scgi_loc_cÚf_t
;

41 
ngx_št_t
 
ngx_h‰p_scgi_ev®
(
ngx_h‰p_»que¡_t
 *
r
,

42 
ngx_h‰p_scgi_loc_cÚf_t
 *
scf
);

43 
ngx_št_t
 
ngx_h‰p_scgi_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

44 
ngx_št_t
 
ngx_h‰p_scgi_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

45 
ngx_št_t
 
ngx_h‰p_scgi_´oûss_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
);

46 
ngx_št_t
 
ngx_h‰p_scgi_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

47 
ngx_h‰p_scgi_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

48 
ngx_h‰p_scgi_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
);

50 *
ngx_h‰p_scgi_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

51 *
ngx_h‰p_scgi_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

52 *
chžd
);

53 
ngx_št_t
 
ngx_h‰p_scgi_š™_·¿ms
(
ngx_cÚf_t
 *
cf
,

54 
ngx_h‰p_scgi_loc_cÚf_t
 *
cÚf
, 
ngx_h‰p_scgi_·¿ms_t
 *
·¿ms
,

55 
ngx_keyv®_t
 *
deçuÉ_·¿ms
);

57 *
ngx_h‰p_scgi_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

58 *
ngx_h‰p_scgi_¡Üe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

59 *
cÚf
);

61 #ià(
NGX_HTTP_CACHE
)

62 
ngx_št_t
 
ngx_h‰p_scgi_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
);

63 *
ngx_h‰p_scgi_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

64 *
cÚf
);

65 *
ngx_h‰p_scgi_ÿche_key
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

66 *
cÚf
);

70 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_scgi_Ãxt_up¡»am_masks
[] = {

71 { 
ngx_¡ršg
("”rÜ"), 
NGX_HTTP_UPSTREAM_FT_ERROR
 },

72 { 
ngx_¡ršg
("timeout"), 
NGX_HTTP_UPSTREAM_FT_TIMEOUT
 },

73 { 
ngx_¡ršg
("šv®id_h—d”"), 
NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
 },

74 { 
ngx_¡ršg
("h‰p_500"), 
NGX_HTTP_UPSTREAM_FT_HTTP_500
 },

75 { 
ngx_¡ršg
("h‰p_503"), 
NGX_HTTP_UPSTREAM_FT_HTTP_503
 },

76 { 
ngx_¡ršg
("h‰p_403"), 
NGX_HTTP_UPSTREAM_FT_HTTP_403
 },

77 { 
ngx_¡ršg
("h‰p_404"), 
NGX_HTTP_UPSTREAM_FT_HTTP_404
 },

78 { 
ngx_¡ršg
("upd©šg"), 
NGX_HTTP_UPSTREAM_FT_UPDATING
 },

79 { 
ngx_¡ršg
("off"), 
NGX_HTTP_UPSTREAM_FT_OFF
 },

80 { 
ngx_nuÎ_¡ršg
, 0 }

84 
ngx_moduË_t
 
	gngx_h‰p_scgi_moduË
;

87 
ngx_commªd_t
 
	gngx_h‰p_scgi_commªds
[] = {

89 { 
ngx_¡ršg
("scgi_pass"),

90 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF
|
NGX_CONF_TAKE1
,

91 
ngx_h‰p_scgi_·ss
,

92 
NGX_HTTP_LOC_CONF_OFFSET
,

94 
NULL
 },

96 { 
ngx_¡ršg
("scgi_store"),

97 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

98 
ngx_h‰p_scgi_¡Üe
,

99 
NGX_HTTP_LOC_CONF_OFFSET
,

101 
NULL
 },

103 { 
ngx_¡ršg
("scgi_store_access"),

104 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE123
,

105 
ngx_cÚf_£t_acûss_¦Ù
,

106 
NGX_HTTP_LOC_CONF_OFFSET
,

107 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
¡Üe_acûss
),

108 
NULL
 },

110 { 
ngx_¡ršg
("scgi_buffering"),

111 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

112 
ngx_cÚf_£t_æag_¦Ù
,

113 
NGX_HTTP_LOC_CONF_OFFSET
,

114 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
bufãršg
),

115 
NULL
 },

117 { 
ngx_¡ršg
("scgi_ignore_client_abort"),

118 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

119 
ngx_cÚf_£t_æag_¦Ù
,

120 
NGX_HTTP_LOC_CONF_OFFSET
,

121 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ignÜe_þ›Á_abÜt
),

122 
NULL
 },

124 { 
ngx_¡ršg
("scgi_bind"),

125 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

126 
ngx_h‰p_up¡»am_bšd_£t_¦Ù
,

127 
NGX_HTTP_LOC_CONF_OFFSET
,

128 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
loÿl
),

129 
NULL
 },

131 { 
ngx_¡ršg
("scgi_connect_timeout"),

132 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

133 
ngx_cÚf_£t_m£c_¦Ù
,

134 
NGX_HTTP_LOC_CONF_OFFSET
,

135 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
cÚÃù_timeout
),

136 
NULL
 },

138 { 
ngx_¡ršg
("scgi_send_timeout"),

139 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

140 
ngx_cÚf_£t_m£c_¦Ù
,

141 
NGX_HTTP_LOC_CONF_OFFSET
,

142 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
£nd_timeout
),

143 
NULL
 },

145 { 
ngx_¡ršg
("scgi_buffer_size"),

146 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

147 
ngx_cÚf_£t_size_¦Ù
,

148 
NGX_HTTP_LOC_CONF_OFFSET
,

149 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
bufãr_size
),

150 
NULL
 },

152 { 
ngx_¡ršg
("scgi_pass_request_headers"),

153 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

154 
ngx_cÚf_£t_æag_¦Ù
,

155 
NGX_HTTP_LOC_CONF_OFFSET
,

156 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
·ss_»que¡_h—d”s
),

157 
NULL
 },

159 { 
ngx_¡ršg
("scgi_pass_request_body"),

160 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

161 
ngx_cÚf_£t_æag_¦Ù
,

162 
NGX_HTTP_LOC_CONF_OFFSET
,

163 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
·ss_»que¡_body
),

164 
NULL
 },

166 { 
ngx_¡ršg
("scgi_intercept_errors"),

167 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

168 
ngx_cÚf_£t_æag_¦Ù
,

169 
NGX_HTTP_LOC_CONF_OFFSET
,

170 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
š‹rû±_”rÜs
),

171 
NULL
 },

173 { 
ngx_¡ršg
("scgi_read_timeout"),

174 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

175 
ngx_cÚf_£t_m£c_¦Ù
,

176 
NGX_HTTP_LOC_CONF_OFFSET
,

177 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
»ad_timeout
),

178 
NULL
 },

180 { 
ngx_¡ršg
("scgi_buffers"),

181 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

182 
ngx_cÚf_£t_bufs_¦Ù
,

183 
NGX_HTTP_LOC_CONF_OFFSET
,

184 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
bufs
),

185 
NULL
 },

187 { 
ngx_¡ršg
("scgi_busy_buffers_size"),

188 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

189 
ngx_cÚf_£t_size_¦Ù
,

190 
NGX_HTTP_LOC_CONF_OFFSET
,

191 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
busy_bufãrs_size_cÚf
),

192 
NULL
 },

194 { 
ngx_¡ršg
("scgi_force_ranges"),

195 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

196 
ngx_cÚf_£t_æag_¦Ù
,

197 
NGX_HTTP_LOC_CONF_OFFSET
,

198 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
fÜû_¿nges
),

199 
NULL
 },

201 { 
ngx_¡ršg
("scgi_limit_rate"),

202 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

203 
ngx_cÚf_£t_size_¦Ù
,

204 
NGX_HTTP_LOC_CONF_OFFSET
,

205 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
lim™_¿‹
),

206 
NULL
 },

208 #ià(
NGX_HTTP_CACHE
)

210 { 
ngx_¡ršg
("scgi_cache"),

211 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

212 
ngx_h‰p_scgi_ÿche
,

213 
NGX_HTTP_LOC_CONF_OFFSET
,

215 
NULL
 },

217 { 
ngx_¡ršg
("scgi_cache_key"),

218 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

219 
ngx_h‰p_scgi_ÿche_key
,

220 
NGX_HTTP_LOC_CONF_OFFSET
,

222 
NULL
 },

224 { 
ngx_¡ršg
("scgi_cache_path"),

225 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_2MORE
,

226 
ngx_h‰p_fže_ÿche_£t_¦Ù
,

229 &
ngx_h‰p_scgi_moduË
 },

231 { 
ngx_¡ršg
("scgi_cache_bypass"),

232 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

233 
ngx_h‰p_£t_´ediÿ‹_¦Ù
,

234 
NGX_HTTP_LOC_CONF_OFFSET
,

235 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_by·ss
),

236 
NULL
 },

238 { 
ngx_¡ršg
("scgi_no_cache"),

239 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

240 
ngx_h‰p_£t_´ediÿ‹_¦Ù
,

241 
NGX_HTTP_LOC_CONF_OFFSET
,

242 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
no_ÿche
),

243 
NULL
 },

245 { 
ngx_¡ršg
("scgi_cache_valid"),

246 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

247 
ngx_h‰p_fže_ÿche_v®id_£t_¦Ù
,

248 
NGX_HTTP_LOC_CONF_OFFSET
,

249 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_v®id
),

250 
NULL
 },

252 { 
ngx_¡ršg
("scgi_cache_min_uses"),

253 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

254 
ngx_cÚf_£t_num_¦Ù
,

255 
NGX_HTTP_LOC_CONF_OFFSET
,

256 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_mš_u£s
),

257 
NULL
 },

259 { 
ngx_¡ršg
("scgi_cache_use_stale"),

260 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

261 
ngx_cÚf_£t_b™mask_¦Ù
,

262 
NGX_HTTP_LOC_CONF_OFFSET
,

263 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_u£_¡®e
),

264 &
ngx_h‰p_scgi_Ãxt_up¡»am_masks
 },

266 { 
ngx_¡ršg
("scgi_cache_methods"),

267 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

268 
ngx_cÚf_£t_b™mask_¦Ù
,

269 
NGX_HTTP_LOC_CONF_OFFSET
,

270 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_m‘hods
),

271 &
ngx_h‰p_up¡»am_ÿche_m‘hod_mask
 },

273 { 
ngx_¡ršg
("scgi_cache_lock"),

274 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

275 
ngx_cÚf_£t_æag_¦Ù
,

276 
NGX_HTTP_LOC_CONF_OFFSET
,

277 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock
),

278 
NULL
 },

280 { 
ngx_¡ršg
("scgi_cache_lock_timeout"),

281 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

282 
ngx_cÚf_£t_m£c_¦Ù
,

283 
NGX_HTTP_LOC_CONF_OFFSET
,

284 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock_timeout
),

285 
NULL
 },

287 { 
ngx_¡ršg
("scgi_cache_lock_age"),

288 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

289 
ngx_cÚf_£t_m£c_¦Ù
,

290 
NGX_HTTP_LOC_CONF_OFFSET
,

291 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock_age
),

292 
NULL
 },

294 { 
ngx_¡ršg
("scgi_cache_revalidate"),

295 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

296 
ngx_cÚf_£t_æag_¦Ù
,

297 
NGX_HTTP_LOC_CONF_OFFSET
,

298 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ÿche_»v®id©e
),

299 
NULL
 },

303 { 
ngx_¡ršg
("scgi_temp_path"),

304 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1234
,

305 
ngx_cÚf_£t_·th_¦Ù
,

306 
NGX_HTTP_LOC_CONF_OFFSET
,

307 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
‹mp_·th
),

308 
NULL
 },

310 { 
ngx_¡ršg
("scgi_max_temp_file_size"),

311 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

312 
ngx_cÚf_£t_size_¦Ù
,

313 
NGX_HTTP_LOC_CONF_OFFSET
,

314 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
max_‹mp_fže_size_cÚf
),

315 
NULL
 },

317 { 
ngx_¡ršg
("scgi_temp_file_write_size"),

318 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

319 
ngx_cÚf_£t_size_¦Ù
,

320 
NGX_HTTP_LOC_CONF_OFFSET
,

321 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
‹mp_fže_wr™e_size_cÚf
),

322 
NULL
 },

324 { 
ngx_¡ršg
("scgi_next_upstream"),

325 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

326 
ngx_cÚf_£t_b™mask_¦Ù
,

327 
NGX_HTTP_LOC_CONF_OFFSET
,

328 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am
),

329 &
ngx_h‰p_scgi_Ãxt_up¡»am_masks
 },

331 { 
ngx_¡ršg
("scgi_next_upstream_tries"),

332 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

333 
ngx_cÚf_£t_num_¦Ù
,

334 
NGX_HTTP_LOC_CONF_OFFSET
,

335 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_Œ›s
),

336 
NULL
 },

338 { 
ngx_¡ršg
("scgi_next_upstream_timeout"),

339 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

340 
ngx_cÚf_£t_m£c_¦Ù
,

341 
NGX_HTTP_LOC_CONF_OFFSET
,

342 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_timeout
),

343 
NULL
 },

345 { 
ngx_¡ršg
("scgi_param"),

346 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE23
,

347 
ngx_h‰p_up¡»am_·¿m_£t_¦Ù
,

348 
NGX_HTTP_LOC_CONF_OFFSET
,

349 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
·¿ms_sourû
),

350 
NULL
 },

352 { 
ngx_¡ršg
("scgi_pass_header"),

353 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

354 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

355 
NGX_HTTP_LOC_CONF_OFFSET
,

356 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
·ss_h—d”s
),

357 
NULL
 },

359 { 
ngx_¡ršg
("scgi_hide_header"),

360 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

361 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

362 
NGX_HTTP_LOC_CONF_OFFSET
,

363 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
hide_h—d”s
),

364 
NULL
 },

366 { 
ngx_¡ršg
("scgi_ignore_headers"),

367 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

368 
ngx_cÚf_£t_b™mask_¦Ù
,

369 
NGX_HTTP_LOC_CONF_OFFSET
,

370 
off£tof
(
ngx_h‰p_scgi_loc_cÚf_t
, 
up¡»am
.
ignÜe_h—d”s
),

371 &
ngx_h‰p_up¡»am_ignÜe_h—d”s_masks
 },

373 
ngx_nuÎ_commªd


377 
ngx_h‰p_moduË_t
 
	gngx_h‰p_scgi_moduË_ùx
 = {

378 
NULL
,

379 
NULL
,

381 
NULL
,

382 
NULL
,

384 
NULL
,

385 
NULL
,

387 
ngx_h‰p_scgi_ü—‹_loc_cÚf
,

388 
ngx_h‰p_scgi_m”ge_loc_cÚf


392 
ngx_moduË_t
 
	gngx_h‰p_scgi_moduË
 = {

393 
NGX_MODULE_V1
,

394 &
ngx_h‰p_scgi_moduË_ùx
,

395 
ngx_h‰p_scgi_commªds
,

396 
NGX_HTTP_MODULE
,

397 
NULL
,

398 
NULL
,

399 
NULL
,

400 
NULL
,

401 
NULL
,

402 
NULL
,

403 
NULL
,

404 
NGX_MODULE_V1_PADDING


408 
ngx_¡r_t
 
	gngx_h‰p_scgi_hide_h—d”s
[] = {

409 
ngx_¡ršg
("Status"),

410 
ngx_¡ršg
("X-Accel-Expires"),

411 
ngx_¡ršg
("X-Accel-Redirect"),

412 
ngx_¡ršg
("X-Accel-Limit-Rate"),

413 
ngx_¡ršg
("X-Accel-Buffering"),

414 
ngx_¡ršg
("X-Accel-Charset"),

415 
ngx_nuÎ_¡ršg


419 #ià(
NGX_HTTP_CACHE
)

421 
ngx_keyv®_t
 
	gngx_h‰p_scgi_ÿche_h—d”s
[] = {

422 { 
ngx_¡ršg
("HTTP_IF_MODIFIED_SINCE"),

423 
ngx_¡ršg
("$upstream_cache_last_modified") },

424 { 
ngx_¡ršg
("HTTP_IF_UNMODIFIED_SINCE"),‚gx_string("") },

425 { 
ngx_¡ršg
("HTTP_IF_NONE_MATCH"),‚gx_string("$upstream_cache_etag") },

426 { 
ngx_¡ršg
("HTTP_IF_MATCH"),‚gx_string("") },

427 { 
ngx_¡ršg
("HTTP_RANGE"),‚gx_string("") },

428 { 
ngx_¡ršg
("HTTP_IF_RANGE"),‚gx_string("") },

429 { 
ngx_nuÎ_¡ršg
,‚gx_null_string }

435 
ngx_·th_š™_t
 
	gngx_h‰p_scgi_‹mp_·th
 = {

436 
ngx_¡ršg
(
NGX_HTTP_SCGI_TEMP_PATH
), { 1, 2, 0 }

440 
ngx_št_t


441 
	$ngx_h‰p_scgi_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

443 
ngx_št_t
 
rc
;

444 
ngx_h‰p_¡©us_t
 *
¡©us
;

445 
ngx_h‰p_up¡»am_t
 *
u
;

446 
ngx_h‰p_scgi_loc_cÚf_t
 *
scf
;

448 ià(
	`ngx_h‰p_up¡»am_ü—‹
(
r
è!ð
NGX_OK
) {

449  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

452 
¡©us
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_¡©us_t
));

453 ià(
¡©us
 =ð
NULL
) {

454  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

457 
	`ngx_h‰p_£t_ùx
(
r
, 
¡©us
, 
ngx_h‰p_scgi_moduË
);

459 
scf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_scgi_moduË
);

461 ià(
scf
->
scgi_Ëngths
) {

462 ià(
	`ngx_h‰p_scgi_ev®
(
r
, 
scf
è!ð
NGX_OK
) {

463  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

467 
u
 = 
r
->
up¡»am
;

469 
	`ngx_¡r_£t
(&
u
->
schema
, "scgi://");

470 
u
->
ouut
.
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_scgi_moduË
;

472 
u
->
cÚf
 = &
scf
->
up¡»am
;

474 #ià(
NGX_HTTP_CACHE
)

475 
u
->
ü—‹_key
 = 
ngx_h‰p_scgi_ü—‹_key
;

477 
u
->
ü—‹_»que¡
 = 
ngx_h‰p_scgi_ü—‹_»que¡
;

478 
u
->
»š™_»que¡
 = 
ngx_h‰p_scgi_»š™_»que¡
;

479 
u
->
´oûss_h—d”
 = 
ngx_h‰p_scgi_´oûss_¡©us_lše
;

480 
u
->
abÜt_»que¡
 = 
ngx_h‰p_scgi_abÜt_»que¡
;

481 
u
->
fš®ize_»que¡
 = 
ngx_h‰p_scgi_fš®ize_»que¡
;

482 
r
->
¡©e
 = 0;

484 
u
->
bufãršg
 = 
scf
->
up¡»am
.buffering;

486 
u
->
pe
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_ev’t_pe_t
));

487 ià(
u
->
pe
 =ð
NULL
) {

488  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

491 
u
->
pe
->
šput_fž‹r
 = 
ngx_ev’t_pe_cÝy_šput_fž‹r
;

492 
u
->
pe
->
šput_ùx
 = 
r
;

494 
rc
 = 
	`ngx_h‰p_»ad_þ›Á_»que¡_body
(
r
, 
ngx_h‰p_up¡»am_š™
);

496 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

497  
rc
;

500  
NGX_DONE
;

501 
	}
}

504 
ngx_št_t


505 
	$ngx_h‰p_scgi_ev®
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_scgi_loc_cÚf_t
 * 
scf
)

507 
ngx_u¾_t
 
u¾
;

508 
ngx_h‰p_up¡»am_t
 *
u
;

510 
	`ngx_memz”o
(&
u¾
, (
ngx_u¾_t
));

512 ià(
	`ngx_h‰p_süt_run
(
r
, &
u¾
.u¾, 
scf
->
scgi_Ëngths
->
–ts
, 0,

513 
scf
->
scgi_v®ues
->
–ts
)

514 =ð
NULL
)

516  
NGX_ERROR
;

519 
u¾
.
no_»sÞve
 = 1;

521 ià(
	`ngx_·r£_u¾
(
r
->
poÞ
, &
u¾
è!ð
NGX_OK
) {

522 ià(
u¾
.
”r
) {

523 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

524 "% š up¡»am \"%V\"", 
u¾
.
”r
, &url.url);

527  
NGX_ERROR
;

530 
u
 = 
r
->
up¡»am
;

532 
u
->
»sÞved
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_»sÞved_t
));

533 ià(
u
->
»sÞved
 =ð
NULL
) {

534  
NGX_ERROR
;

537 ià(
u¾
.
addrs
 && u¾.addrs[0].
sockaddr
) {

538 
u
->
»sÞved
->
sockaddr
 = 
u¾
.
addrs
[0].sockaddr;

539 
u
->
»sÞved
->
sockËn
 = 
u¾
.
addrs
[0].socklen;

540 
u
->
»sÞved
->
Çddrs
 = 1;

541 
u
->
»sÞved
->
ho¡
 = 
u¾
.
addrs
[0].
Çme
;

544 
u
->
»sÞved
->
ho¡
 = 
u¾
.host;

545 
u
->
»sÞved
->
pÜt
 = 
u¾
.port;

546 
u
->
»sÞved
->
no_pÜt
 = 
u¾
.no_port;

549  
NGX_OK
;

550 
	}
}

553 #ià(
NGX_HTTP_CACHE
)

555 
ngx_št_t


556 
	$ngx_h‰p_scgi_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
)

558 
ngx_¡r_t
 *
key
;

559 
ngx_h‰p_scgi_loc_cÚf_t
 *
scf
;

561 
key
 = 
	`ngx_¬¿y_push
(&
r
->
ÿche
->
keys
);

562 ià(
key
 =ð
NULL
) {

563  
NGX_ERROR
;

566 
scf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_scgi_moduË
);

568 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
scf
->
ÿche_key
, 
key
è!ð
NGX_OK
) {

569  
NGX_ERROR
;

572  
NGX_OK
;

573 
	}
}

578 
ngx_št_t


579 
	$ngx_h‰p_scgi_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

581 
off_t
 
cÚ‹Á_Ëngth_n
;

582 
u_ch¬
 
ch
, *
key
, *
v®
, *
lowÿ£_key
;

583 
size_t
 
Ën
, 
key_Ën
, 
v®_Ën
, 
®loÿ‹d
;

584 
ngx_buf_t
 *
b
;

585 
ngx_¡r_t
 
cÚ‹Á_Ëngth
;

586 
ngx_ušt_t
 
i
, 
n
, 
hash
, 
sk_em±y
, 
h—d”_·¿ms
;

587 
ngx_chaš_t
 *
þ
, *
body
;

588 
ngx_li¡_·¹_t
 *
·¹
;

589 
ngx_bË_–t_t
 *
h—d”
, **
ignÜed
;

590 
ngx_h‰p_scgi_·¿ms_t
 *
·¿ms
;

591 
ngx_h‰p_süt_code_±
 
code
;

592 
ngx_h‰p_süt_’gše_t
 
e
, 
Ë
;

593 
ngx_h‰p_scgi_loc_cÚf_t
 *
scf
;

594 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

595 
u_ch¬
 
bufãr
[
NGX_OFF_T_LEN
];

597 
cÚ‹Á_Ëngth_n
 = 0;

598 
body
 = 
r
->
up¡»am
->
»que¡_bufs
;

600 
body
) {

601 
cÚ‹Á_Ëngth_n
 +ð
	`ngx_buf_size
(
body
->
buf
);

602 
body
 = body->
Ãxt
;

605 
cÚ‹Á_Ëngth
.
d©a
 = 
bufãr
;

606 
cÚ‹Á_Ëngth
.
Ën
 = 
	`ngx_¥rštf
(
bufãr
, "%O", 
cÚ‹Á_Ëngth_n
) - buffer;

608 
Ën
 = ("CONTENT_LENGTH"è+ 
cÚ‹Á_Ëngth
.len + 1;

610 
h—d”_·¿ms
 = 0;

611 
ignÜed
 = 
NULL
;

613 
scf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_scgi_moduË
);

615 #ià(
NGX_HTTP_CACHE
)

616 
·¿ms
 = 
r
->
up¡»am
->
ÿch—bË
 ? &
scf
->
·¿ms_ÿche
 : &scf->params;

618 
·¿ms
 = &
scf
->params;

621 ià(
·¿ms
->
Ëngths
) {

622 
	`ngx_memz”o
(&
Ë
, (
ngx_h‰p_süt_’gše_t
));

624 
	`ngx_h‰p_süt_æush_no_ÿch—bË_v¬ŸbËs
(
r
, 
·¿ms
->
æushes
);

625 
Ë
.
æushed
 = 1;

627 
Ë
.

 = 
·¿ms
->
Ëngths
->
–ts
;

628 
Ë
.
»que¡
 = 
r
;

630 *(
ušŒ_t
 *è
Ë
.

) {

632 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

633 
key_Ën
 = 
	`lcode
(&
Ë
);

635 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

636 
sk_em±y
 = 
	`lcode
(&
Ë
);

638 
v®_Ën
 = 0; *(
ušŒ_t
 *è
Ë
.

; v®_ËÀ+ð
	`lcode
(&le)) {

639 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

641 
Ë
.

 +ð(
ušŒ_t
);

643 ià(
sk_em±y
 && 
v®_Ën
 == 0) {

647 
Ën
 +ð
key_Ën
 + 
v®_Ën
 + 1;

651 ià(
scf
->
up¡»am
.
·ss_»que¡_h—d”s
) {

653 
®loÿ‹d
 = 0;

654 
lowÿ£_key
 = 
NULL
;

656 ià(
·¿ms
->
numb”
) {

657 
n
 = 0;

658 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

660 
·¹
) {

661 
n
 +ð
·¹
->
ÃÉs
;

662 
·¹
 =…¬t->
Ãxt
;

665 
ignÜed
 = 
	`ngx_·Îoc
(
r
->
poÞ
, 
n
 * (*));

666 ià(
ignÜed
 =ð
NULL
) {

667  
NGX_ERROR
;

671 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

672 
h—d”
 = 
·¹
->
–ts
;

674 
i
 = 0; ; i++) {

676 ià(
i
 >ð
·¹
->
ÃÉs
) {

677 ià(
·¹
->
Ãxt
 =ð
NULL
) {

681 
·¹
 =…¬t->
Ãxt
;

682 
h—d”
 = 
·¹
->
–ts
;

683 
i
 = 0;

686 ià(
·¿ms
->
numb”
) {

687 ià(
®loÿ‹d
 < 
h—d”
[
i
].
key
.
Ën
) {

688 
®loÿ‹d
 = 
h—d”
[
i
].
key
.
Ën
 + 16;

689 
lowÿ£_key
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
®loÿ‹d
);

690 ià(
lowÿ£_key
 =ð
NULL
) {

691  
NGX_ERROR
;

695 
hash
 = 0;

697 
n
 = 0;‚ < 
h—d”
[
i
].
key
.
Ën
;‚++) {

698 
ch
 = 
h—d”
[
i
].
key
.
d©a
[
n
];

700 ià(
ch
 >= 'A' && ch <= 'Z') {

701 
ch
 |= 0x20;

703 } ià(
ch
 == '-') {

704 
ch
 = '_';

707 
hash
 = 
	`ngx_hash
(hash, 
ch
);

708 
lowÿ£_key
[
n
] = 
ch
;

711 ià(
	`ngx_hash_fšd
(&
·¿ms
->
hash
, hash, 
lowÿ£_key
, 
n
)) {

712 
ignÜed
[
h—d”_·¿ms
++] = &
h—d”
[
i
];

717 
Ën
 +ð("HTTP_"è- 1 + 
h—d”
[
i
].
key
.len + 1

718 + 
h—d”
[
i
].
v®ue
.
Ën
 + 1;

724 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
NGX_SIZE_T_LEN
 + 1 + 
Ën
 + 1);

725 ià(
b
 =ð
NULL
) {

726  
NGX_ERROR
;

729 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

730 ià(
þ
 =ð
NULL
) {

731  
NGX_ERROR
;

734 
þ
->
buf
 = 
b
;

736 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->last, "%ui:CONTENT_LENGTH%Z%V%Z",

737 
Ën
, &
cÚ‹Á_Ëngth
);

739 ià(
·¿ms
->
Ëngths
) {

740 
	`ngx_memz”o
(&
e
, (
ngx_h‰p_süt_’gše_t
));

742 
e
.

 = 
·¿ms
->
v®ues
->
–ts
;

743 
e
.
pos
 = 
b
->
Ï¡
;

744 
e
.
»que¡
 = 
r
;

745 
e
.
æushed
 = 1;

747 
Ë
.

 = 
·¿ms
->
Ëngths
->
–ts
;

749 *(
ušŒ_t
 *è
Ë
.

) {

751 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

752 
	`lcode
(&
Ë
);

754 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

755 
sk_em±y
 = 
	`lcode
(&
Ë
);

757 
v®_Ën
 = 0; *(
ušŒ_t
 *è
Ë
.

; v®_ËÀ+ð
	`lcode
(&le)) {

758 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

760 
Ë
.

 +ð(
ušŒ_t
);

762 ià(
sk_em±y
 && 
v®_Ën
 == 0) {

763 
e
.
sk
 = 1;

765 *(
ušŒ_t
 *è
e
.

) {

766 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

767 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

769 
e
.

 +ð(
ušŒ_t
);

771 
e
.
sk
 = 0;

776 #ià(
NGX_DEBUG
)

777 
key
 = 
e
.
pos
;

779 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

780 
	`code
((
ngx_h‰p_süt_’gše_t
 *è& 
e
);

782 #ià(
NGX_DEBUG
)

783 
v®
 = 
e
.
pos
;

785 *(
ušŒ_t
 *è
e
.

) {

786 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

787 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

789 *
e
.
pos
++ = '\0';

790 
e
.

 +ð(
ušŒ_t
);

792 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

793 "scg˜·¿m: \"%s: %s\"", 
key
, 
v®
);

796 
b
->
Ï¡
 = 
e
.
pos
;

799 ià(
scf
->
up¡»am
.
·ss_»que¡_h—d”s
) {

801 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

802 
h—d”
 = 
·¹
->
–ts
;

804 
i
 = 0; ; i++) {

806 ià(
i
 >ð
·¹
->
ÃÉs
) {

807 ià(
·¹
->
Ãxt
 =ð
NULL
) {

811 
·¹
 =…¬t->
Ãxt
;

812 
h—d”
 = 
·¹
->
–ts
;

813 
i
 = 0;

816 
n
 = 0;‚ < 
h—d”_·¿ms
;‚++) {

817 ià(&
h—d”
[
i
] =ð
ignÜed
[
n
]) {

818 
Ãxt
;

822 
key
 = 
b
->
Ï¡
;

823 
b
->
Ï¡
 = 
	`ngx_ýymem
(
key
, "HTTP_", ("HTTP_") - 1);

825 
n
 = 0;‚ < 
h—d”
[
i
].
key
.
Ën
;‚++) {

826 
ch
 = 
h—d”
[
i
].
key
.
d©a
[
n
];

828 ià(
ch
 >= 'a' && ch <= 'z') {

829 
ch
 &= ~0x20;

831 } ià(
ch
 == '-') {

832 
ch
 = '_';

835 *
b
->
Ï¡
++ = 
ch
;

838 *
b
->
Ï¡
++ = (
u_ch¬
) 0;

840 
v®
 = 
b
->
Ï¡
;

841 
b
->
Ï¡
 = 
	`ngx_cÝy
(
v®
, 
h—d”
[
i
].
v®ue
.
d©a
, h—d”[i].v®ue.
Ën
);

842 *
b
->
Ï¡
++ = (
u_ch¬
) 0;

844 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

845 "scg˜·¿m: \"%s: %s\"", 
key
, 
v®
);

847 
Ãxt
:

853 *
b
->
Ï¡
++ = (
u_ch¬
) ',';

855 ià(
scf
->
up¡»am
.
·ss_»que¡_body
) {

856 
body
 = 
r
->
up¡»am
->
»que¡_bufs
;

857 
r
->
up¡»am
->
»que¡_bufs
 = 
þ
;

859 
body
) {

860 
b
 = 
	`ngx_®loc_buf
(
r
->
poÞ
);

861 ià(
b
 =ð
NULL
) {

862  
NGX_ERROR
;

865 
	`ngx_memýy
(
b
, 
body
->
buf
, (
ngx_buf_t
));

867 
þ
->
Ãxt
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

868 ià(
þ
->
Ãxt
 =ð
NULL
) {

869  
NGX_ERROR
;

872 
þ
 = cl->
Ãxt
;

873 
þ
->
buf
 = 
b
;

875 
body
 = body->
Ãxt
;

879 
r
->
up¡»am
->
»que¡_bufs
 = 
þ
;

882 
þ
->
Ãxt
 = 
NULL
;

884  
NGX_OK
;

885 
	}
}

888 
ngx_št_t


889 
	$ngx_h‰p_scgi_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

891 
ngx_h‰p_¡©us_t
 *
¡©us
;

893 
¡©us
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_scgi_moduË
);

895 ià(
¡©us
 =ð
NULL
) {

896  
NGX_OK
;

899 
¡©us
->
code
 = 0;

900 
¡©us
->
couÁ
 = 0;

901 
¡©us
->
¡¬t
 = 
NULL
;

902 
¡©us
->
’d
 = 
NULL
;

904 
r
->
up¡»am
->
´oûss_h—d”
 = 
ngx_h‰p_scgi_´oûss_¡©us_lše
;

905 
r
->
¡©e
 = 0;

907  
NGX_OK
;

908 
	}
}

911 
ngx_št_t


912 
	$ngx_h‰p_scgi_´oûss_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
)

914 
size_t
 
Ën
;

915 
ngx_št_t
 
rc
;

916 
ngx_h‰p_¡©us_t
 *
¡©us
;

917 
ngx_h‰p_up¡»am_t
 *
u
;

919 
¡©us
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_scgi_moduË
);

921 ià(
¡©us
 =ð
NULL
) {

922  
NGX_ERROR
;

925 
u
 = 
r
->
up¡»am
;

927 
rc
 = 
	`ngx_h‰p_·r£_¡©us_lše
(
r
, &
u
->
bufãr
, 
¡©us
);

929 ià(
rc
 =ð
NGX_AGAIN
) {

930  
rc
;

933 ià(
rc
 =ð
NGX_ERROR
) {

934 
u
->
´oûss_h—d”
 = 
ngx_h‰p_scgi_´oûss_h—d”
;

935  
	`ngx_h‰p_scgi_´oûss_h—d”
(
r
);

938 ià(
u
->
¡©e
 && u->¡©e->
¡©us
 == 0) {

939 
u
->
¡©e
->
¡©us
 = stus->
code
;

942 
u
->
h—d”s_š
.
¡©us_n
 = 
¡©us
->
code
;

944 
Ën
 = 
¡©us
->
’d
 - stus->
¡¬t
;

945 
u
->
h—d”s_š
.
¡©us_lše
.
Ën
 =†en;

947 
u
->
h—d”s_š
.
¡©us_lše
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

948 ià(
u
->
h—d”s_š
.
¡©us_lše
.
d©a
 =ð
NULL
) {

949  
NGX_ERROR
;

952 
	`ngx_memýy
(
u
->
h—d”s_š
.
¡©us_lše
.
d©a
, 
¡©us
->
¡¬t
, 
Ën
);

954 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

956 
u
->
h—d”s_š
.
¡©us_n
, &u->h—d”s_š.
¡©us_lše
);

958 
u
->
´oûss_h—d”
 = 
ngx_h‰p_scgi_´oûss_h—d”
;

960  
	`ngx_h‰p_scgi_´oûss_h—d”
(
r
);

961 
	}
}

964 
ngx_št_t


965 
	$ngx_h‰p_scgi_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

967 
ngx_¡r_t
 *
¡©us_lše
;

968 
ngx_št_t
 
rc
, 
¡©us
;

969 
ngx_bË_–t_t
 *
h
;

970 
ngx_h‰p_up¡»am_t
 *
u
;

971 
ngx_h‰p_up¡»am_h—d”_t
 *
hh
;

972 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

974 
umcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_up¡»am_moduË
);

978 
rc
 = 
	`ngx_h‰p_·r£_h—d”_lše
(
r
, &r->
up¡»am
->
bufãr
, 1);

980 ià(
rc
 =ð
NGX_OK
) {

984 
h
 = 
	`ngx_li¡_push
(&
r
->
up¡»am
->
h—d”s_š
.
h—d”s
);

985 ià(
h
 =ð
NULL
) {

986  
NGX_ERROR
;

989 
h
->
hash
 = 
r
->
h—d”_hash
;

991 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

992 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

994 
h
->
key
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

995 
h
->
key
.
Ën
 + 1 + h->
v®ue
.len + 1

996 + 
h
->
key
.
Ën
);

997 ià(
h
->
key
.
d©a
 =ð
NULL
) {

998  
NGX_ERROR
;

1001 
h
->
v®ue
.
d©a
 = h->
key
.d©¨+ h->key.
Ën
 + 1;

1002 
h
->
lowÿ£_key
 = h->
key
.
d©a
 + h->key.
Ën
 + 1 + h->
v®ue
.len + 1;

1004 
	`ngx_memýy
(
h
->
key
.
d©a
, 
r
->
h—d”_Çme_¡¬t
, h->key.
Ën
);

1005 
h
->
key
.
d©a
[h->key.
Ën
] = '\0';

1006 
	`ngx_memýy
(
h
->
v®ue
.
d©a
, 
r
->
h—d”_¡¬t
, h->v®ue.
Ën
);

1007 
h
->
v®ue
.
d©a
[h->v®ue.
Ën
] = '\0';

1009 ià(
h
->
key
.
Ën
 =ð
r
->
lowÿ£_šdex
) {

1010 
	`ngx_memýy
(
h
->
lowÿ£_key
, 
r
->
lowÿ£_h—d”
, h->
key
.
Ën
);

1013 
	`ngx_¡¾ow
(
h
->
lowÿ£_key
, h->
key
.
d©a
, h->key.
Ën
);

1016 
hh
 = 
	`ngx_hash_fšd
(&
umcf
->
h—d”s_š_hash
, 
h
->
hash
,

1017 
h
->
lowÿ£_key
, h->
key
.
Ën
);

1019 ià(
hh
 && hh->
	`hªdËr
(
r
, 
h
, hh->
off£t
è!ð
NGX_OK
) {

1020  
NGX_ERROR
;

1023 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1024 "h‰°scg˜h—d”: \"%V: %V\"", &
h
->
key
, &h->
v®ue
);

1029 ià(
rc
 =ð
NGX_HTTP_PARSE_HEADER_DONE
) {

1033 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1036 
u
 = 
r
->
up¡»am
;

1038 ià(
u
->
h—d”s_š
.
¡©us_n
) {

1039 
dÚe
;

1042 ià(
u
->
h—d”s_š
.
¡©us
) {

1043 
¡©us_lše
 = &
u
->
h—d”s_š
.
¡©us
->
v®ue
;

1045 
¡©us
 = 
	`ngx_©oi
(
¡©us_lše
->
d©a
, 3);

1046 ià(
¡©us
 =ð
NGX_ERROR
) {

1047 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1049 
¡©us_lše
);

1050  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1053 
u
->
h—d”s_š
.
¡©us_n
 = 
¡©us
;

1054 
u
->
h—d”s_š
.
¡©us_lše
 = *status_line;

1056 } ià(
u
->
h—d”s_š
.
loÿtiÚ
) {

1057 
u
->
h—d”s_š
.
¡©us_n
 = 302;

1058 
	`ngx_¡r_£t
(&
u
->
h—d”s_š
.
¡©us_lše
,

1062 
u
->
h—d”s_š
.
¡©us_n
 = 200;

1063 
	`ngx_¡r_£t
(&
u
->
h—d”s_š
.
¡©us_lše
, "200 OK");

1066 ià(
u
->
¡©e
 && u->¡©e->
¡©us
 == 0) {

1067 
u
->
¡©e
->
¡©us
 = u->
h—d”s_š
.
¡©us_n
;

1070 
dÚe
:

1072 ià(
u
->
h—d”s_š
.
¡©us_n
 =ð
NGX_HTTP_SWITCHING_PROTOCOLS


1073 && 
r
->
h—d”s_š
.
upg¿de
)

1075 
u
->
upg¿de
 = 1;

1078  
NGX_OK
;

1081 ià(
rc
 =ð
NGX_AGAIN
) {

1082  
NGX_AGAIN
;

1087 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1090  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1092 
	}
}

1096 
	$ngx_h‰p_scgi_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

1098 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1102 
	}
}

1106 
	$ngx_h‰p_scgi_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

1108 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1112 
	}
}

1116 
	$ngx_h‰p_scgi_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

1118 
ngx_h‰p_scgi_loc_cÚf_t
 *
cÚf
;

1120 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_scgi_loc_cÚf_t
));

1121 ià(
cÚf
 =ð
NULL
) {

1122  
NULL
;

1125 
cÚf
->
up¡»am
.
¡Üe
 = 
NGX_CONF_UNSET
;

1126 
cÚf
->
up¡»am
.
¡Üe_acûss
 = 
NGX_CONF_UNSET_UINT
;

1127 
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
 = 
NGX_CONF_UNSET_UINT
;

1128 
cÚf
->
up¡»am
.
bufãršg
 = 
NGX_CONF_UNSET
;

1129 
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
 = 
NGX_CONF_UNSET
;

1130 
cÚf
->
up¡»am
.
fÜû_¿nges
 = 
NGX_CONF_UNSET
;

1132 
cÚf
->
up¡»am
.
loÿl
 = 
NGX_CONF_UNSET_PTR
;

1134 
cÚf
->
up¡»am
.
cÚÃù_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1135 
cÚf
->
up¡»am
.
£nd_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1136 
cÚf
->
up¡»am
.
»ad_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1137 
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1139 
cÚf
->
up¡»am
.
£nd_low©
 = 
NGX_CONF_UNSET_SIZE
;

1140 
cÚf
->
up¡»am
.
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

1141 
cÚf
->
up¡»am
.
lim™_¿‹
 = 
NGX_CONF_UNSET_SIZE
;

1143 
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

1144 
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

1145 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

1147 
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
 = 
NGX_CONF_UNSET
;

1148 
cÚf
->
up¡»am
.
·ss_»que¡_body
 = 
NGX_CONF_UNSET
;

1150 #ià(
NGX_HTTP_CACHE
)

1151 
cÚf
->
up¡»am
.
ÿche
 = 
NGX_CONF_UNSET_PTR
;

1152 
cÚf
->
up¡»am
.
ÿche_mš_u£s
 = 
NGX_CONF_UNSET_UINT
;

1153 
cÚf
->
up¡»am
.
ÿche_by·ss
 = 
NGX_CONF_UNSET_PTR
;

1154 
cÚf
->
up¡»am
.
no_ÿche
 = 
NGX_CONF_UNSET_PTR
;

1155 
cÚf
->
up¡»am
.
ÿche_v®id
 = 
NGX_CONF_UNSET_PTR
;

1156 
cÚf
->
up¡»am
.
ÿche_lock
 = 
NGX_CONF_UNSET
;

1157 
cÚf
->
up¡»am
.
ÿche_lock_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1158 
cÚf
->
up¡»am
.
ÿche_lock_age
 = 
NGX_CONF_UNSET_MSEC
;

1159 
cÚf
->
up¡»am
.
ÿche_»v®id©e
 = 
NGX_CONF_UNSET
;

1162 
cÚf
->
up¡»am
.
hide_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

1163 
cÚf
->
up¡»am
.
·ss_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

1165 
cÚf
->
up¡»am
.
š‹rû±_”rÜs
 = 
NGX_CONF_UNSET
;

1168 
cÚf
->
up¡»am
.
cyþic_‹mp_fže
 = 0;

1170 
cÚf
->
up¡»am
.
chªge_bufãršg
 = 1;

1172 
	`ngx_¡r_£t
(&
cÚf
->
up¡»am
.
moduË
, "scgi");

1174  
cÚf
;

1175 
	}
}

1179 
	$ngx_h‰p_scgi_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1181 
ngx_h‰p_scgi_loc_cÚf_t
 *
´ev
 = 
·»Á
;

1182 
ngx_h‰p_scgi_loc_cÚf_t
 *
cÚf
 = 
chžd
;

1184 
size_t
 
size
;

1185 
ngx_št_t
 
rc
;

1186 
ngx_hash_š™_t
 
hash
;

1187 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1189 ià(
cÚf
->
up¡»am
.
¡Üe
 != 0) {

1190 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
¡Üe
, 
´ev
->upstream.store, 0);

1192 ià(
cÚf
->
up¡»am
.
¡Üe_Ëngths
 =ð
NULL
) {

1193 
cÚf
->
up¡»am
.
¡Üe_Ëngths
 = 
´ev
->upstream.store_lengths;

1194 
cÚf
->
up¡»am
.
¡Üe_v®ues
 = 
´ev
->upstream.store_values;

1198 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
¡Üe_acûss
,

1199 
´ev
->
up¡»am
.
¡Üe_acûss
, 0600);

1201 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
,

1202 
´ev
->
up¡»am
.
Ãxt_up¡»am_Œ›s
, 0);

1204 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
bufãršg
,

1205 
´ev
->
up¡»am
.
bufãršg
, 1);

1207 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
,

1208 
´ev
->
up¡»am
.
ignÜe_þ›Á_abÜt
, 0);

1210 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
fÜû_¿nges
,

1211 
´ev
->
up¡»am
.
fÜû_¿nges
, 0);

1213 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
loÿl
,

1214 
´ev
->
up¡»am
.
loÿl
, 
NULL
);

1216 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
cÚÃù_timeout
,

1217 
´ev
->
up¡»am
.
cÚÃù_timeout
, 60000);

1219 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
£nd_timeout
,

1220 
´ev
->
up¡»am
.
£nd_timeout
, 60000);

1222 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
»ad_timeout
,

1223 
´ev
->
up¡»am
.
»ad_timeout
, 60000);

1225 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
,

1226 
´ev
->
up¡»am
.
Ãxt_up¡»am_timeout
, 0);

1228 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
£nd_low©
,

1229 
´ev
->
up¡»am
.
£nd_low©
, 0);

1231 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
bufãr_size
,

1232 
´ev
->
up¡»am
.
bufãr_size
,

1233 (
size_t
è
ngx_·gesize
);

1235 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
lim™_¿‹
,

1236 
´ev
->
up¡»am
.
lim™_¿‹
, 0);

1239 
	`ngx_cÚf_m”ge_bufs_v®ue
(
cÚf
->
up¡»am
.
bufs
, 
´ev
->upstream.bufs,

1240 8, 
ngx_·gesize
);

1242 ià(
cÚf
->
up¡»am
.
bufs
.
num
 < 2) {

1243 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1245  
NGX_CONF_ERROR
;

1249 
size
 = 
cÚf
->
up¡»am
.
bufãr_size
;

1250 ià(
size
 < 
cÚf
->
up¡»am
.
bufs
.size) {

1251 
size
 = 
cÚf
->
up¡»am
.
bufs
.size;

1255 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
,

1256 
´ev
->
up¡»am
.
busy_bufãrs_size_cÚf
,

1257 
NGX_CONF_UNSET_SIZE
);

1259 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

1260 
cÚf
->
up¡»am
.
busy_bufãrs_size
 = 2 * 
size
;

1262 
cÚf
->
up¡»am
.
busy_bufãrs_size
 =

1263 
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
;

1266 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size
 < 
size
) {

1267 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1272  
NGX_CONF_ERROR
;

1275 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size


1276 > (
cÚf
->
up¡»am
.
bufs
.
num
 - 1è* cÚf->up¡»am.bufs.
size
)

1278 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1282  
NGX_CONF_ERROR
;

1286 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
,

1287 
´ev
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
,

1288 
NGX_CONF_UNSET_SIZE
);

1290 ià(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

1291 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 = 2 * 
size
;

1293 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 =

1294 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
;

1297 ià(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 < 
size
) {

1298 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1303  
NGX_CONF_ERROR
;

1307 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
,

1308 
´ev
->
up¡»am
.
max_‹mp_fže_size_cÚf
,

1309 
NGX_CONF_UNSET_SIZE
);

1311 ià(
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

1312 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 = 1024 * 1024 * 1024;

1314 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 =

1315 
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
;

1318 ià(
cÚf
->
up¡»am
.
max_‹mp_fže_size
 != 0

1319 && 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 < 
size
)

1321 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1327  
NGX_CONF_ERROR
;

1331 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
ignÜe_h—d”s
,

1332 
´ev
->
up¡»am
.
ignÜe_h—d”s
,

1333 
NGX_CONF_BITMASK_SET
);

1336 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am
,

1337 
´ev
->
up¡»am
.
Ãxt_up¡»am
,

1338 (
NGX_CONF_BITMASK_SET


1339 |
NGX_HTTP_UPSTREAM_FT_ERROR


1340 |
NGX_HTTP_UPSTREAM_FT_TIMEOUT
));

1342 ià(
cÚf
->
up¡»am
.
Ãxt_up¡»am
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

1343 
cÚf
->
up¡»am
.
Ãxt_up¡»am
 = 
NGX_CONF_BITMASK_SET


1344 |
NGX_HTTP_UPSTREAM_FT_OFF
;

1347 ià(
	`ngx_cÚf_m”ge_·th_v®ue
(
cf
, &
cÚf
->
up¡»am
.
‹mp_·th
,

1348 
´ev
->
up¡»am
.
‹mp_·th
,

1349 &
ngx_h‰p_scgi_‹mp_·th
)

1350 !ð
NGX_OK
)

1352  
NGX_CONF_ERROR
;

1355 #ià(
NGX_HTTP_CACHE
)

1357 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche
,

1358 
´ev
->
up¡»am
.
ÿche
, 
NULL
);

1360 ià(
cÚf
->
up¡»am
.
ÿche
 && cÚf->up¡»am.ÿche->
d©a
 =ð
NULL
) {

1361 
ngx_shm_zÚe_t
 *
shm_zÚe
;

1363 
shm_zÚe
 = 
cÚf
->
up¡»am
.
ÿche
;

1365 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1367 &
shm_zÚe
->
shm
.
Çme
);

1369  
NGX_CONF_ERROR
;

1372 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
ÿche_mš_u£s
,

1373 
´ev
->
up¡»am
.
ÿche_mš_u£s
, 1);

1375 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
,

1376 
´ev
->
up¡»am
.
ÿche_u£_¡®e
,

1377 (
NGX_CONF_BITMASK_SET


1378 |
NGX_HTTP_UPSTREAM_FT_OFF
));

1380 ià(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

1381 
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 = 
NGX_CONF_BITMASK_SET


1382 |
NGX_HTTP_UPSTREAM_FT_OFF
;

1385 ià(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_ERROR
) {

1386 
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 |ð
NGX_HTTP_UPSTREAM_FT_NOLIVE
;

1389 ià(
cÚf
->
up¡»am
.
ÿche_m‘hods
 == 0) {

1390 
cÚf
->
up¡»am
.
ÿche_m‘hods
 = 
´ev
->upstream.cache_methods;

1393 
cÚf
->
up¡»am
.
ÿche_m‘hods
 |ð
NGX_HTTP_GET
|
NGX_HTTP_HEAD
;

1395 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche_by·ss
,

1396 
´ev
->
up¡»am
.
ÿche_by·ss
, 
NULL
);

1398 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
no_ÿche
,

1399 
´ev
->
up¡»am
.
no_ÿche
, 
NULL
);

1401 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche_v®id
,

1402 
´ev
->
up¡»am
.
ÿche_v®id
, 
NULL
);

1404 ià(
cÚf
->
ÿche_key
.
v®ue
.
d©a
 =ð
NULL
) {

1405 
cÚf
->
ÿche_key
 = 
´ev
->cache_key;

1408 ià(
cÚf
->
up¡»am
.
ÿche
 && cÚf->
ÿche_key
.
v®ue
.
d©a
 =ð
NULL
) {

1409 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1413 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock
,

1414 
´ev
->
up¡»am
.
ÿche_lock
, 0);

1416 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock_timeout
,

1417 
´ev
->
up¡»am
.
ÿche_lock_timeout
, 5000);

1419 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock_age
,

1420 
´ev
->
up¡»am
.
ÿche_lock_age
, 5000);

1422 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ÿche_»v®id©e
,

1423 
´ev
->
up¡»am
.
ÿche_»v®id©e
, 0);

1427 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
,

1428 
´ev
->
up¡»am
.
·ss_»que¡_h—d”s
, 1);

1429 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
·ss_»que¡_body
,

1430 
´ev
->
up¡»am
.
·ss_»que¡_body
, 1);

1432 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
š‹rû±_”rÜs
,

1433 
´ev
->
up¡»am
.
š‹rû±_”rÜs
, 0);

1435 
hash
.
max_size
 = 512;

1436 
hash
.
buck‘_size
 = 
	`ngx_®ign
(64, 
ngx_ÿch–še_size
);

1437 
hash
.
Çme
 = "scgi_hide_headers_hash";

1439 ià(
	`ngx_h‰p_up¡»am_hide_h—d”s_hash
(
cf
, &
cÚf
->
up¡»am
,

1440 &
´ev
->
up¡»am
, 
ngx_h‰p_scgi_hide_h—d”s
, &
hash
)

1441 !ð
NGX_OK
)

1443  
NGX_CONF_ERROR
;

1446 ià(
cÚf
->
up¡»am
.up¡»am =ð
NULL
) {

1447 
cÚf
->
up¡»am
.up¡»am = 
´ev
->upstream.upstream;

1450 ià(
cÚf
->
scgi_Ëngths
 =ð
NULL
) {

1451 
cÚf
->
scgi_Ëngths
 = 
´ev
->scgi_lengths;

1452 
cÚf
->
scgi_v®ues
 = 
´ev
->scgi_values;

1455 ià(
cÚf
->
up¡»am
.up¡»am || cÚf->
scgi_Ëngths
) {

1456 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

1457 ià(
þcf
->
hªdËr
 =ð
NULL
 && clcf->
lmt_exýt
) {

1458 
þcf
->
hªdËr
 = 
ngx_h‰p_scgi_hªdËr
;

1462 ià(
cÚf
->
·¿ms_sourû
 =ð
NULL
) {

1463 
cÚf
->
·¿ms
 = 
´ev
->params;

1464 #ià(
NGX_HTTP_CACHE
)

1465 
cÚf
->
·¿ms_ÿche
 = 
´ev
->params_cache;

1467 
cÚf
->
·¿ms_sourû
 = 
´ev
->params_source;

1470 
rc
 = 
	`ngx_h‰p_scgi_š™_·¿ms
(
cf
, 
cÚf
, &cÚf->
·¿ms
, 
NULL
);

1471 ià(
rc
 !ð
NGX_OK
) {

1472  
NGX_CONF_ERROR
;

1475 #ià(
NGX_HTTP_CACHE
)

1477 ià(
cÚf
->
up¡»am
.
ÿche
) {

1478 
rc
 = 
	`ngx_h‰p_scgi_š™_·¿ms
(
cf
, 
cÚf
, &cÚf->
·¿ms_ÿche
,

1479 
ngx_h‰p_scgi_ÿche_h—d”s
);

1480 ià(
rc
 !ð
NGX_OK
) {

1481  
NGX_CONF_ERROR
;

1487  
NGX_CONF_OK
;

1488 
	}
}

1491 
ngx_št_t


1492 
	$ngx_h‰p_scgi_š™_·¿ms
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_scgi_loc_cÚf_t
 *
cÚf
,

1493 
ngx_h‰p_scgi_·¿ms_t
 *
·¿ms
, 
ngx_keyv®_t
 *
deçuÉ_·¿ms
)

1495 
u_ch¬
 *
p
;

1496 
size_t
 
size
;

1497 
ušŒ_t
 *
code
;

1498 
ngx_ušt_t
 
i
, 
n¤c
;

1499 
ngx_¬¿y_t
 
h—d”s_Çmes
, 
·¿ms_m”ged
;

1500 
ngx_keyv®_t
 *
h
;

1501 
ngx_hash_key_t
 *
hk
;

1502 
ngx_hash_š™_t
 
hash
;

1503 
ngx_h‰p_up¡»am_·¿m_t
 *
¤c
, *
s
;

1504 
ngx_h‰p_süt_compže_t
 
sc
;

1505 
ngx_h‰p_süt_cÝy_code_t
 *
cÝy
;

1507 ià(
·¿ms
->
hash
.
buck‘s
) {

1508  
NGX_OK
;

1511 ià(
cÚf
->
·¿ms_sourû
 =ð
NULL
 && 
deçuÉ_·¿ms
 == NULL) {

1512 
·¿ms
->
hash
.
buck‘s
 = (*) 1;

1513  
NGX_OK
;

1516 
·¿ms
->
Ëngths
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 64, 1);

1517 ià(
·¿ms
->
Ëngths
 =ð
NULL
) {

1518  
NGX_ERROR
;

1521 
·¿ms
->
v®ues
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 512, 1);

1522 ià(
·¿ms
->
v®ues
 =ð
NULL
) {

1523  
NGX_ERROR
;

1526 ià(
	`ngx_¬¿y_š™
(&
h—d”s_Çmes
, 
cf
->
‹mp_poÞ
, 4, (
ngx_hash_key_t
))

1527 !ð
NGX_OK
)

1529  
NGX_ERROR
;

1532 ià(
cÚf
->
·¿ms_sourû
) {

1533 
¤c
 = 
cÚf
->
·¿ms_sourû
->
–ts
;

1534 
n¤c
 = 
cÚf
->
·¿ms_sourû
->
ÃÉs
;

1537 
¤c
 = 
NULL
;

1538 
n¤c
 = 0;

1541 ià(
deçuÉ_·¿ms
) {

1542 ià(
	`ngx_¬¿y_š™
(&
·¿ms_m”ged
, 
cf
->
‹mp_poÞ
, 4,

1543 (
ngx_h‰p_up¡»am_·¿m_t
))

1544 !ð
NGX_OK
)

1546  
NGX_ERROR
;

1549 
i
 = 0; i < 
n¤c
; i++) {

1551 
s
 = 
	`ngx_¬¿y_push
(&
·¿ms_m”ged
);

1552 ià(
s
 =ð
NULL
) {

1553  
NGX_ERROR
;

1556 *
s
 = 
¤c
[
i
];

1559 
h
 = 
deçuÉ_·¿ms
;

1561 
h
->
key
.
Ën
) {

1563 
¤c
 = 
·¿ms_m”ged
.
–ts
;

1564 
n¤c
 = 
·¿ms_m”ged
.
ÃÉs
;

1566 
i
 = 0; i < 
n¤c
; i++) {

1567 ià(
	`ngx_¡rÿ£cmp
(
h
->
key
.
d©a
, 
¤c
[
i
].key.data) == 0) {

1568 
Ãxt
;

1572 
s
 = 
	`ngx_¬¿y_push
(&
·¿ms_m”ged
);

1573 ià(
s
 =ð
NULL
) {

1574  
NGX_ERROR
;

1577 
s
->
key
 = 
h
->key;

1578 
s
->
v®ue
 = 
h
->value;

1579 
s
->
sk_em±y
 = 1;

1581 
Ãxt
:

1583 
h
++;

1586 
¤c
 = 
·¿ms_m”ged
.
–ts
;

1587 
n¤c
 = 
·¿ms_m”ged
.
ÃÉs
;

1590 
i
 = 0; i < 
n¤c
; i++) {

1592 ià(
¤c
[
i
].
key
.
Ën
 > ("HTTP_") - 1

1593 && 
	`ngx_¡ºcmp
(
¤c
[
i
].
key
.
d©a
, "HTTP_", ("HTTP_") - 1) == 0)

1595 
hk
 = 
	`ngx_¬¿y_push
(&
h—d”s_Çmes
);

1596 ià(
hk
 =ð
NULL
) {

1597  
NGX_ERROR
;

1600 
hk
->
key
.
Ën
 = 
¤c
[
i
].key.len - 5;

1601 
hk
->
key
.
d©a
 = 
¤c
[
i
].key.data + 5;

1602 
hk
->
key_hash
 = 
	`ngx_hash_key_lc
(hk->
key
.
d©a
, hk->key.
Ën
);

1603 
hk
->
v®ue
 = (*) 1;

1605 ià(
¤c
[
i
].
v®ue
.
Ën
 == 0) {

1610 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
,

1611 (
ngx_h‰p_süt_cÝy_code_t
));

1612 ià(
cÝy
 =ð
NULL
) {

1613  
NGX_ERROR
;

1616 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_cÝy_Ën_code
;

1617 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len + 1;

1619 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
,

1620 (
ngx_h‰p_süt_cÝy_code_t
));

1621 ià(
cÝy
 =ð
NULL
) {

1622  
NGX_ERROR
;

1625 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_cÝy_Ën_code
;

1626 
cÝy
->
Ën
 = 
¤c
[
i
].
sk_em±y
;

1629 
size
 = ((
ngx_h‰p_süt_cÝy_code_t
)

1630 + 
¤c
[
i
].
key
.
Ën
 + 1 + (
ušŒ_t
) - 1)

1631 & ~((
ušŒ_t
) - 1);

1633 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
v®ues
, 
size
);

1634 ià(
cÝy
 =ð
NULL
) {

1635  
NGX_ERROR
;

1638 
cÝy
->
code
 = 
ngx_h‰p_süt_cÝy_code
;

1639 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len + 1;

1641 
p
 = (
u_ch¬
 *è
cÝy
 + (
ngx_h‰p_süt_cÝy_code_t
);

1642 (è
	`ngx_ýy¡º
(
p
, 
¤c
[
i
].
key
.
d©a
, src[i].key.
Ën
 + 1);

1645 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

1647 
sc
.
cf
 = cf;

1648 
sc
.
sourû
 = &
¤c
[
i
].
v®ue
;

1649 
sc
.
æushes
 = &
·¿ms
->flushes;

1650 
sc
.
Ëngths
 = &
·¿ms
->lengths;

1651 
sc
.
v®ues
 = &
·¿ms
->values;

1653 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

1654  
NGX_ERROR
;

1657 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
, (
ušŒ_t
));

1658 ià(
code
 =ð
NULL
) {

1659  
NGX_ERROR
;

1662 *
code
 = (
ušŒ_t
è
NULL
;

1665 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
v®ues
, (
ušŒ_t
));

1666 ià(
code
 =ð
NULL
) {

1667  
NGX_ERROR
;

1670 *
code
 = (
ušŒ_t
è
NULL
;

1673 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
, (
ušŒ_t
));

1674 ià(
code
 =ð
NULL
) {

1675  
NGX_ERROR
;

1678 *
code
 = (
ušŒ_t
è
NULL
;

1680 
·¿ms
->
numb”
 = 
h—d”s_Çmes
.
ÃÉs
;

1682 
hash
.hash = &
·¿ms
->hash;

1683 
hash
.
key
 = 
ngx_hash_key_lc
;

1684 
hash
.
max_size
 = 512;

1685 
hash
.
buck‘_size
 = 64;

1686 
hash
.
Çme
 = "scgi_params_hash";

1687 
hash
.
poÞ
 = 
cf
->pool;

1688 
hash
.
‹mp_poÞ
 = 
NULL
;

1690  
	`ngx_hash_š™
(&
hash
, 
h—d”s_Çmes
.
–ts
, h—d”s_Çmes.
ÃÉs
);

1691 
	}
}

1695 
	$ngx_h‰p_scgi_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1697 
ngx_h‰p_scgi_loc_cÚf_t
 *
scf
 = 
cÚf
;

1699 
ngx_u¾_t
 
u
;

1700 
ngx_¡r_t
 *
v®ue
, *
u¾
;

1701 
ngx_ušt_t
 
n
;

1702 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1703 
ngx_h‰p_süt_compže_t
 
sc
;

1705 ià(
scf
->
up¡»am
.up¡»am || scf->
scgi_Ëngths
) {

1709 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

1710 
þcf
->
hªdËr
 = 
ngx_h‰p_scgi_hªdËr
;

1712 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1714 
u¾
 = &
v®ue
[1];

1716 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(
u¾
);

1718 ià(
n
) {

1720 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

1722 
sc
.
cf
 = cf;

1723 
sc
.
sourû
 = 
u¾
;

1724 
sc
.
Ëngths
 = &
scf
->
scgi_Ëngths
;

1725 
sc
.
v®ues
 = &
scf
->
scgi_v®ues
;

1726 
sc
.
v¬ŸbËs
 = 
n
;

1727 
sc
.
com¶‘e_Ëngths
 = 1;

1728 
sc
.
com¶‘e_v®ues
 = 1;

1730 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

1731  
NGX_CONF_ERROR
;

1734  
NGX_CONF_OK
;

1737 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

1739 
u
.
u¾
 = 
v®ue
[1];

1740 
u
.
no_»sÞve
 = 1;

1742 
scf
->
up¡»am
.up¡»am = 
	`ngx_h‰p_up¡»am_add
(
cf
, &
u
, 0);

1743 ià(
scf
->
up¡»am
.up¡»am =ð
NULL
) {

1744  
NGX_CONF_ERROR
;

1747 ià(
þcf
->
Çme
.
d©a
[þcf->Çme.
Ën
 - 1] == '/') {

1748 
þcf
->
auto_»dœeù
 = 1;

1751  
NGX_CONF_OK
;

1752 
	}
}

1756 
	$ngx_h‰p_scgi_¡Üe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1758 
ngx_h‰p_scgi_loc_cÚf_t
 *
scf
 = 
cÚf
;

1760 
ngx_¡r_t
 *
v®ue
;

1761 
ngx_h‰p_süt_compže_t
 
sc
;

1763 ià(
scf
->
up¡»am
.
¡Üe
 !ð
NGX_CONF_UNSET
 || scf->up¡»am.
¡Üe_Ëngths
) {

1767 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1769 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

1770 
scf
->
up¡»am
.
¡Üe
 = 0;

1771  
NGX_CONF_OK
;

1774 #ià(
NGX_HTTP_CACHE
)

1776 ià(
scf
->
up¡»am
.
ÿche
 !ð
NGX_CONF_UNSET_PTR


1777 && 
scf
->
up¡»am
.
ÿche
 !ð
NULL
)

1784 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "on") == 0) {

1785 
scf
->
up¡»am
.
¡Üe
 = 1;

1786  
NGX_CONF_OK
;

1790 
v®ue
[1].
Ën
++;

1792 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

1794 
sc
.
cf
 = cf;

1795 
sc
.
sourû
 = &
v®ue
[1];

1796 
sc
.
Ëngths
 = &
scf
->
up¡»am
.
¡Üe_Ëngths
;

1797 
sc
.
v®ues
 = &
scf
->
up¡»am
.
¡Üe_v®ues
;

1798 
sc
.
v¬ŸbËs
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
v®ue
[1]);

1799 
sc
.
com¶‘e_Ëngths
 = 1;

1800 
sc
.
com¶‘e_v®ues
 = 1;

1802 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

1803  
NGX_CONF_ERROR
;

1806  
NGX_CONF_OK
;

1807 
	}
}

1810 #ià(
NGX_HTTP_CACHE
)

1813 
	$ngx_h‰p_scgi_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1815 
ngx_h‰p_scgi_loc_cÚf_t
 *
scf
 = 
cÚf
;

1817 
ngx_¡r_t
 *
v®ue
;

1819 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1821 ià(
scf
->
up¡»am
.
ÿche
 !ð
NGX_CONF_UNSET_PTR
) {

1825 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

1826 
scf
->
up¡»am
.
ÿche
 = 
NULL
;

1827  
NGX_CONF_OK
;

1830 ià(
scf
->
up¡»am
.
¡Üe
 > 0 || scf->up¡»am.
¡Üe_Ëngths
) {

1834 
scf
->
up¡»am
.
ÿche
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
v®ue
[1], 0,

1835 &
ngx_h‰p_scgi_moduË
);

1836 ià(
scf
->
up¡»am
.
ÿche
 =ð
NULL
) {

1837  
NGX_CONF_ERROR
;

1840  
NGX_CONF_OK
;

1841 
	}
}

1845 
	$ngx_h‰p_scgi_ÿche_key
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1847 
ngx_h‰p_scgi_loc_cÚf_t
 *
scf
 = 
cÚf
;

1849 
ngx_¡r_t
 *
v®ue
;

1850 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

1852 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1854 ià(
scf
->
ÿche_key
.
v®ue
.
d©a
) {

1858 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

1860 
ccv
.
cf
 = cf;

1861 
ccv
.
v®ue
 = &value[1];

1862 
ccv
.
com¶ex_v®ue
 = &
scf
->
ÿche_key
;

1864 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

1865  
NGX_CONF_ERROR
;

1868  
NGX_CONF_OK
;

1869 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_secure_link_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngx_md5.h
>

15 
ngx_h‰p_com¶ex_v®ue_t
 *
	mv¬ŸbË
;

16 
ngx_h‰p_com¶ex_v®ue_t
 *
	mmd5
;

17 
ngx_¡r_t
 
	m£ü‘
;

18 } 
	tngx_h‰p_£cu»_lšk_cÚf_t
;

22 
ngx_¡r_t
 
	mexpœes
;

23 } 
	tngx_h‰p_£cu»_lšk_ùx_t
;

26 
ngx_št_t
 
ngx_h‰p_£cu»_lšk_Þd_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

27 
ngx_h‰p_£cu»_lšk_cÚf_t
 *
cÚf
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

28 
ušŒ_t
 
d©a
);

29 
ngx_št_t
 
ngx_h‰p_£cu»_lšk_expœes_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

30 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

31 *
ngx_h‰p_£cu»_lšk_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

32 *
ngx_h‰p_£cu»_lšk_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

33 *
chžd
);

34 
ngx_št_t
 
ngx_h‰p_£cu»_lšk_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

37 
ngx_commªd_t
 
	gngx_h‰p_£cu»_lšk_commªds
[] = {

39 { 
ngx_¡ršg
("secure_link"),

40 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

41 
ngx_h‰p_£t_com¶ex_v®ue_¦Ù
,

42 
NGX_HTTP_LOC_CONF_OFFSET
,

43 
off£tof
(
ngx_h‰p_£cu»_lšk_cÚf_t
, 
v¬ŸbË
),

44 
NULL
 },

46 { 
ngx_¡ršg
("secure_link_md5"),

47 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

48 
ngx_h‰p_£t_com¶ex_v®ue_¦Ù
,

49 
NGX_HTTP_LOC_CONF_OFFSET
,

50 
off£tof
(
ngx_h‰p_£cu»_lšk_cÚf_t
, 
md5
),

51 
NULL
 },

53 { 
ngx_¡ršg
("secure_link_secret"),

54 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

55 
ngx_cÚf_£t_¡r_¦Ù
,

56 
NGX_HTTP_LOC_CONF_OFFSET
,

57 
off£tof
(
ngx_h‰p_£cu»_lšk_cÚf_t
, 
£ü‘
),

58 
NULL
 },

60 
ngx_nuÎ_commªd


64 
ngx_h‰p_moduË_t
 
	gngx_h‰p_£cu»_lšk_moduË_ùx
 = {

65 
ngx_h‰p_£cu»_lšk_add_v¬ŸbËs
,

66 
NULL
,

68 
NULL
,

69 
NULL
,

71 
NULL
,

72 
NULL
,

74 
ngx_h‰p_£cu»_lšk_ü—‹_cÚf
,

75 
ngx_h‰p_£cu»_lšk_m”ge_cÚf


79 
ngx_moduË_t
 
	gngx_h‰p_£cu»_lšk_moduË
 = {

80 
NGX_MODULE_V1
,

81 &
ngx_h‰p_£cu»_lšk_moduË_ùx
,

82 
ngx_h‰p_£cu»_lšk_commªds
,

83 
NGX_HTTP_MODULE
,

84 
NULL
,

85 
NULL
,

86 
NULL
,

87 
NULL
,

88 
NULL
,

89 
NULL
,

90 
NULL
,

91 
NGX_MODULE_V1_PADDING


95 
ngx_¡r_t
 
	gngx_h‰p_£cu»_lšk_Çme
 = 
ngx_¡ršg
("secure_link");

96 
ngx_¡r_t
 
	gngx_h‰p_£cu»_lšk_expœes_Çme
 =

97 
ngx_¡ršg
("secure_link_expires");

100 
ngx_št_t


101 
	$ngx_h‰p_£cu»_lšk_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

102 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

104 
u_ch¬
 *
p
, *
Ï¡
;

105 
ngx_¡r_t
 
v®
, 
hash
;

106 
time_t
 
expœes
;

107 
ngx_md5_t
 
md5
;

108 
ngx_h‰p_£cu»_lšk_ùx_t
 *
ùx
;

109 
ngx_h‰p_£cu»_lšk_cÚf_t
 *
cÚf
;

110 
u_ch¬
 
hash_buf
[16], 
md5_buf
[16];

112 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_£cu»_lšk_moduË
);

114 ià(
cÚf
->
£ü‘
.
d©a
) {

115  
	`ngx_h‰p_£cu»_lšk_Þd_v¬ŸbË
(
r
, 
cÚf
, 
v
, 
d©a
);

118 ià(
cÚf
->
v¬ŸbË
 =ð
NULL
 || cÚf->
md5
 == NULL) {

119 
nÙ_found
;

122 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
cÚf
->
v¬ŸbË
, &
v®
è!ð
NGX_OK
) {

123  
NGX_ERROR
;

126 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

127 "£cu»†šk: \"%V\"", &
v®
);

129 
Ï¡
 = 
v®
.
d©a
 + v®.
Ën
;

131 
p
 = 
	`ngx_¡¾chr
(
v®
.
d©a
, 
Ï¡
, ',');

132 
expœes
 = 0;

134 ià(
p
) {

135 
v®
.
Ën
 = 
p
++ - v®.
d©a
;

137 
expœes
 = 
	`ngx_©Ùm
(
p
, 
Ï¡
 -…);

138 ià(
expœes
 <= 0) {

139 
nÙ_found
;

142 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_£cu»_lšk_ùx_t
));

143 ià(
ùx
 =ð
NULL
) {

144  
NGX_ERROR
;

147 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_£cu»_lšk_moduË
);

149 
ùx
->
expœes
.
Ën
 = 
Ï¡
 - 
p
;

150 
ùx
->
expœes
.
d©a
 = 
p
;

153 ià(
v®
.
Ën
 > 24) {

154 
nÙ_found
;

157 
hash
.
Ën
 = 16;

158 
hash
.
d©a
 = 
hash_buf
;

160 ià(
	`ngx_decode_ba£64u¾
(&
hash
, &
v®
è!ð
NGX_OK
) {

161 
nÙ_found
;

164 ià(
hash
.
Ën
 != 16) {

165 
nÙ_found
;

168 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
cÚf
->
md5
, &
v®
è!ð
NGX_OK
) {

169  
NGX_ERROR
;

172 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

173 "£cu»†šk md5: \"%V\"", &
v®
);

175 
	`ngx_md5_š™
(&
md5
);

176 
	`ngx_md5_upd©e
(&
md5
, 
v®
.
d©a
, v®.
Ën
);

177 
	`ngx_md5_fš®
(
md5_buf
, &
md5
);

179 ià(
	`ngx_memcmp
(
hash_buf
, 
md5_buf
, 16) != 0) {

180 
nÙ_found
;

183 
v
->
d©a
 = (
u_ch¬
 *è((
expœes
 &&ƒxpœe < 
	`ngx_time
()) ? "0" : "1");

184 
v
->
Ën
 = 1;

185 
v
->
v®id
 = 1;

186 
v
->
no_ÿch—bË
 = 0;

187 
v
->
nÙ_found
 = 0;

189  
NGX_OK
;

191 
nÙ_found
:

193 
v
->
nÙ_found
 = 1;

195  
NGX_OK
;

196 
	}
}

199 
ngx_št_t


200 
	$ngx_h‰p_£cu»_lšk_Þd_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

201 
ngx_h‰p_£cu»_lšk_cÚf_t
 *
cÚf
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

202 
ušŒ_t
 
d©a
)

204 
u_ch¬
 *
p
, *
¡¬t
, *
’d
, *
Ï¡
;

205 
size_t
 
Ën
;

206 
ngx_št_t
 
n
;

207 
ngx_ušt_t
 
i
;

208 
ngx_md5_t
 
md5
;

209 
u_ch¬
 
hash
[16];

211 
p
 = &
r
->
uÅ¬£d_uri
.
d©a
[1];

212 
Ï¡
 = 
r
->
uÅ¬£d_uri
.
d©a
 +„->uÅ¬£d_uri.
Ën
;

214 
p
 < 
Ï¡
) {

215 ià(*
p
++ == '/') {

216 
¡¬t
 = 
p
;

217 
md5_¡¬t
;

221 
nÙ_found
;

223 
md5_¡¬t
:

225 
p
 < 
Ï¡
) {

226 ià(*
p
++ == '/') {

227 
’d
 = 
p
 - 1;

228 
u¾_¡¬t
;

232 
nÙ_found
;

234 
u¾_¡¬t
:

236 
Ën
 = 
Ï¡
 - 
p
;

238 ià(
’d
 - 
¡¬t
 !ð32 || 
Ën
 == 0) {

239 
nÙ_found
;

242 
	`ngx_md5_š™
(&
md5
);

243 
	`ngx_md5_upd©e
(&
md5
, 
p
, 
Ën
);

244 
	`ngx_md5_upd©e
(&
md5
, 
cÚf
->
£ü‘
.
d©a
, cÚf->£ü‘.
Ën
);

245 
	`ngx_md5_fš®
(
hash
, &
md5
);

247 
i
 = 0; i < 16; i++) {

248 
n
 = 
	`ngx_hextoi
(&
¡¬t
[2 * 
i
], 2);

249 ià(
n
 =ð
NGX_ERROR
 ||‚ !ð
hash
[
i
]) {

250 
nÙ_found
;

254 
v
->
Ën
 =†en;

255 
v
->
v®id
 = 1;

256 
v
->
no_ÿch—bË
 = 0;

257 
v
->
nÙ_found
 = 0;

258 
v
->
d©a
 = 
p
;

260  
NGX_OK
;

262 
nÙ_found
:

264 
v
->
nÙ_found
 = 1;

266  
NGX_OK
;

267 
	}
}

270 
ngx_št_t


271 
	$ngx_h‰p_£cu»_lšk_expœes_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

272 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

274 
ngx_h‰p_£cu»_lšk_ùx_t
 *
ùx
;

276 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_£cu»_lšk_moduË
);

278 ià(
ùx
) {

279 
v
->
Ën
 = 
ùx
->
expœes
.len;

280 
v
->
v®id
 = 1;

281 
v
->
no_ÿch—bË
 = 0;

282 
v
->
nÙ_found
 = 0;

283 
v
->
d©a
 = 
ùx
->
expœes
.data;

286 
v
->
nÙ_found
 = 1;

289  
NGX_OK
;

290 
	}
}

294 
	$ngx_h‰p_£cu»_lšk_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

296 
ngx_h‰p_£cu»_lšk_cÚf_t
 *
cÚf
;

298 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_£cu»_lšk_cÚf_t
));

299 ià(
cÚf
 =ð
NULL
) {

300  
NULL
;

311  
cÚf
;

312 
	}
}

316 
	$ngx_h‰p_£cu»_lšk_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

318 
ngx_h‰p_£cu»_lšk_cÚf_t
 *
´ev
 = 
·»Á
;

319 
ngx_h‰p_£cu»_lšk_cÚf_t
 *
cÚf
 = 
chžd
;

321 ià(
cÚf
->
£ü‘
.
d©a
) {

322 ià(
cÚf
->
v¬ŸbË
 || cÚf->
md5
) {

323 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

326  
NGX_CONF_ERROR
;

329  
NGX_CONF_OK
;

332 ià(
cÚf
->
v¬ŸbË
 =ð
NULL
) {

333 
cÚf
->
v¬ŸbË
 = 
´ev
->variable;

336 ià(
cÚf
->
md5
 =ð
NULL
) {

337 
cÚf
->
md5
 = 
´ev
->md5;

340 ià(
cÚf
->
v¬ŸbË
 =ð
NULL
 && cÚf->
md5
 == NULL) {

341 
cÚf
->
£ü‘
 = 
´ev
->secret;

344  
NGX_CONF_OK
;

345 
	}
}

348 
ngx_št_t


349 
	$ngx_h‰p_£cu»_lšk_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

351 
ngx_h‰p_v¬ŸbË_t
 *
v¬
;

353 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
ngx_h‰p_£cu»_lšk_Çme
, 0);

354 ià(
v¬
 =ð
NULL
) {

355  
NGX_ERROR
;

358 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_£cu»_lšk_v¬ŸbË
;

360 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
ngx_h‰p_£cu»_lšk_expœes_Çme
, 0);

361 ià(
v¬
 =ð
NULL
) {

362  
NGX_ERROR
;

365 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_£cu»_lšk_expœes_v¬ŸbË
;

367  
NGX_OK
;

368 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_split_clients_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ušt32_t
 
	m³rûÁ
;

15 
ngx_h‰p_v¬ŸbË_v®ue_t
 
	mv®ue
;

16 } 
	tngx_h‰p_¥l™_þ›Ás_·¹_t
;

20 
ngx_h‰p_com¶ex_v®ue_t
 
	mv®ue
;

21 
ngx_¬¿y_t
 
	m·¹s
;

22 } 
	tngx_h‰p_¥l™_þ›Ás_ùx_t
;

25 *
ngx_cÚf_¥l™_þ›Ás_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

26 *
cÚf
);

27 *
ngx_h‰p_¥l™_þ›Ás
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
,

28 *
cÚf
);

30 
ngx_commªd_t
 
	gngx_h‰p_¥l™_þ›Ás_commªds
[] = {

32 { 
ngx_¡ršg
("split_clients"),

33 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_TAKE2
,

34 
ngx_cÚf_¥l™_þ›Ás_block
,

35 
NGX_HTTP_MAIN_CONF_OFFSET
,

37 
NULL
 },

39 
ngx_nuÎ_commªd


43 
ngx_h‰p_moduË_t
 
	gngx_h‰p_¥l™_þ›Ás_moduË_ùx
 = {

44 
NULL
,

45 
NULL
,

47 
NULL
,

48 
NULL
,

50 
NULL
,

51 
NULL
,

53 
NULL
,

54 
NULL


58 
ngx_moduË_t
 
	gngx_h‰p_¥l™_þ›Ás_moduË
 = {

59 
NGX_MODULE_V1
,

60 &
ngx_h‰p_¥l™_þ›Ás_moduË_ùx
,

61 
ngx_h‰p_¥l™_þ›Ás_commªds
,

62 
NGX_HTTP_MODULE
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
NGX_MODULE_V1_PADDING


74 
ngx_št_t


75 
	$ngx_h‰p_¥l™_þ›Ás_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

76 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

78 
ngx_h‰p_¥l™_þ›Ás_ùx_t
 *
ùx
 = (ngx_h‰p_¥l™_þ›Ás_ùx_ˆ*è
d©a
;

80 
ušt32_t
 
hash
;

81 
ngx_¡r_t
 
v®
;

82 
ngx_ušt_t
 
i
;

83 
ngx_h‰p_¥l™_þ›Ás_·¹_t
 *
·¹
;

85 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

87 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
ùx
->
v®ue
, &
v®
è!ð
NGX_OK
) {

88  
NGX_OK
;

91 
hash
 = 
	`ngx_murmur_hash2
(
v®
.
d©a
, v®.
Ën
);

93 
·¹
 = 
ùx
->
·¹s
.
–ts
;

95 
i
 = 0; i < 
ùx
->
·¹s
.
ÃÉs
; i++) {

97 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

98 "h‰°¥l™: %uD %uD", 
hash
, 
·¹
[
i
].
³rûÁ
);

100 ià(
hash
 < 
·¹
[
i
].
³rûÁ
 ||…art[i].percent == 0) {

101 *
v
 = 
·¹
[
i
].
v®ue
;

102  
NGX_OK
;

106  
NGX_OK
;

107 
	}
}

111 
	$ngx_cÚf_¥l™_þ›Ás_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

113 *
rv
;

114 
ušt32_t
 
sum
, 
Ï¡
;

115 
ngx_¡r_t
 *
v®ue
, 
Çme
;

116 
ngx_ušt_t
 
i
;

117 
ngx_cÚf_t
 
§ve
;

118 
ngx_h‰p_v¬ŸbË_t
 *
v¬
;

119 
ngx_h‰p_¥l™_þ›Ás_ùx_t
 *
ùx
;

120 
ngx_h‰p_¥l™_þ›Ás_·¹_t
 *
·¹
;

121 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

123 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_¥l™_þ›Ás_ùx_t
));

124 ià(
ùx
 =ð
NULL
) {

125  
NGX_CONF_ERROR
;

128 
v®ue
 = 
cf
->
¬gs
->
–ts
;

130 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

132 
ccv
.
cf
 = cf;

133 
ccv
.
v®ue
 = &value[1];

134 
ccv
.
com¶ex_v®ue
 = &
ùx
->
v®ue
;

136 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

137  
NGX_CONF_ERROR
;

140 
Çme
 = 
v®ue
[2];

142 ià(
Çme
.
d©a
[0] != '$') {

143 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

144 "šv®id v¬ŸbË‚am\"%V\"", &
Çme
);

145  
NGX_CONF_ERROR
;

148 
Çme
.
Ën
--;

149 
Çme
.
d©a
++;

151 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
Çme
, 
NGX_HTTP_VAR_CHANGEABLE
);

152 ià(
v¬
 =ð
NULL
) {

153  
NGX_CONF_ERROR
;

156 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_¥l™_þ›Ás_v¬ŸbË
;

157 
v¬
->
d©a
 = (
ušŒ_t
è
ùx
;

159 ià(
	`ngx_¬¿y_š™
(&
ùx
->
·¹s
, 
cf
->
poÞ
, 2,

160 (
ngx_h‰p_¥l™_þ›Ás_·¹_t
))

161 !ð
NGX_OK
)

163  
NGX_CONF_ERROR
;

166 
§ve
 = *
cf
;

167 
cf
->
ùx
 = ctx;

168 
cf
->
hªdËr
 = 
ngx_h‰p_¥l™_þ›Ás
;

169 
cf
->
hªdËr_cÚf
 = 
cÚf
;

171 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

173 *
cf
 = 
§ve
;

175 ià(
rv
 !ð
NGX_CONF_OK
) {

176  
rv
;

179 
sum
 = 0;

180 
Ï¡
 = 0;

181 
·¹
 = 
ùx
->
·¹s
.
–ts
;

183 
i
 = 0; i < 
ùx
->
·¹s
.
ÃÉs
; i++) {

184 
sum
 = 
·¹
[
i
].
³rûÁ
 ? sum +…art[i].percent : 10000;

185 ià(
sum
 > 10000) {

186 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

188  
NGX_CONF_ERROR
;

191 ià(
·¹
[
i
].
³rûÁ
) {

192 
Ï¡
 +ð
·¹
[
i
].
³rûÁ
 * (
ušt64_t
) 0xffffffff / 10000;

193 
·¹
[
i
].
³rûÁ
 = 
Ï¡
;

197  
rv
;

198 
	}
}

202 
	$ngx_h‰p_¥l™_þ›Ás
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
, *
cÚf
)

204 
ngx_št_t
 
n
;

205 
ngx_¡r_t
 *
v®ue
;

206 
ngx_h‰p_¥l™_þ›Ás_ùx_t
 *
ùx
;

207 
ngx_h‰p_¥l™_þ›Ás_·¹_t
 *
·¹
;

209 
ùx
 = 
cf
->ctx;

210 
v®ue
 = 
cf
->
¬gs
->
–ts
;

212 
·¹
 = 
	`ngx_¬¿y_push
(&
ùx
->
·¹s
);

213 ià(
·¹
 =ð
NULL
) {

214  
NGX_CONF_ERROR
;

217 ià(
v®ue
[0].
Ën
 =ð1 && v®ue[0].
d©a
[0] == '*') {

218 
·¹
->
³rûÁ
 = 0;

221 ià(
v®ue
[0].
Ën
 =ð0 || v®ue[0].
d©a
[value[0].len - 1] != '%') {

222 
šv®id
;

225 
n
 = 
	`ngx_©oå
(
v®ue
[0].
d©a
, v®ue[0].
Ën
 - 1, 2);

226 ià(
n
 =ð
NGX_ERROR
 ||‚ == 0) {

227 
šv®id
;

230 
·¹
->
³rûÁ
 = (
ušt32_t
è
n
;

233 
·¹
->
v®ue
.
Ën
 = value[1].len;

234 
·¹
->
v®ue
.
v®id
 = 1;

235 
·¹
->
v®ue
.
no_ÿch—bË
 = 0;

236 
·¹
->
v®ue
.
nÙ_found
 = 0;

237 
·¹
->
v®ue
.
d©a
 = value[1].data;

239  
NGX_CONF_OK
;

241 
šv®id
:

243 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

244 "šv®id…”ûÁ v®u\"%V\"", &
v®ue
[0]);

245  
NGX_CONF_ERROR
;

246 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_ssi_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

12 
	#NGX_HTTP_SSI_ERROR
 1

	)

14 
	#NGX_HTTP_SSI_DATE_LEN
 2048

	)

16 
	#NGX_HTTP_SSI_ADD_PREFIX
 1

	)

17 
	#NGX_HTTP_SSI_ADD_ZERO
 2

	)

21 
ngx_æag_t
 
	m’abË
;

22 
ngx_æag_t
 
	msž’t_”rÜs
;

23 
ngx_æag_t
 
	mignÜe_»cyþed_bufãrs
;

24 
ngx_æag_t
 
	mÏ¡_modif›d
;

26 
ngx_hash_t
 
	mty³s
;

28 
size_t
 
	mmš_fže_chunk
;

29 
size_t
 
	mv®ue_Ën
;

31 
ngx_¬¿y_t
 *
	mty³s_keys
;

32 } 
	tngx_h‰p_ssi_loc_cÚf_t
;

36 
ngx_¡r_t
 
	mÇme
;

37 
ngx_ušt_t
 
	mkey
;

38 
ngx_¡r_t
 
	mv®ue
;

39 } 
	tngx_h‰p_ssi_v¬_t
;

43 
ngx_¡r_t
 
	mÇme
;

44 
ngx_chaš_t
 *
	mbufs
;

45 
ngx_ušt_t
 
	mcouÁ
;

46 } 
	tngx_h‰p_ssi_block_t
;

50 
	mssi_¡¬t_¡©e
 = 0,

51 
	mssi_g_¡©e
,

52 
	mssi_comm’t0_¡©e
,

53 
	mssi_comm’t1_¡©e
,

54 
	mssi_sh¬p_¡©e
,

55 
	mssi_´ecommªd_¡©e
,

56 
	mssi_commªd_¡©e
,

57 
	mssi_´•¬am_¡©e
,

58 
	mssi_·¿m_¡©e
,

59 
	mssi_´“qu®_¡©e
,

60 
	mssi_´ev®ue_¡©e
,

61 
	mssi_doubË_quÙed_v®ue_¡©e
,

62 
	mssi_quÙed_v®ue_¡©e
,

63 
	mssi_quÙed_symbÞ_¡©e
,

64 
	mssi_po¡·¿m_¡©e
,

65 
	mssi_comm’t_’d0_¡©e
,

66 
	mssi_comm’t_’d1_¡©e
,

67 
	mssi_”rÜ_¡©e
,

68 
	mssi_”rÜ_’d0_¡©e
,

69 
	mssi_”rÜ_’d1_¡©e


70 } 
	tngx_h‰p_ssi_¡©e_e
;

73 
ngx_št_t
 
ngx_h‰p_ssi_ouut
(
ngx_h‰p_»que¡_t
 *
r
,

74 
ngx_h‰p_ssi_ùx_t
 *
ùx
);

75 
ngx_h‰p_ssi_bufã»d
(
ngx_h‰p_»que¡_t
 *
r
,

76 
ngx_h‰p_ssi_ùx_t
 *
ùx
);

77 
ngx_št_t
 
ngx_h‰p_ssi_·r£
(
ngx_h‰p_»que¡_t
 *
r
,

78 
ngx_h‰p_ssi_ùx_t
 *
ùx
);

79 
ngx_¡r_t
 *
ngx_h‰p_ssi_g‘_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

80 
ngx_¡r_t
 *
Çme
, 
ngx_ušt_t
 
key
);

81 
ngx_št_t
 
ngx_h‰p_ssi_ev®u©e_¡ršg
(
ngx_h‰p_»que¡_t
 *
r
,

82 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
‹xt
, 
ngx_ušt_t
 
æags
);

83 
ngx_št_t
 
ngx_h‰p_ssi_»gex_m©ch
(
ngx_h‰p_»que¡_t
 *
r
,

84 
ngx_¡r_t
 *
·‰”n
,‚gx_¡r_ˆ*
¡r
);

86 
ngx_št_t
 
ngx_h‰p_ssi_šþude
(
ngx_h‰p_»que¡_t
 *
r
,

87 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

88 
ngx_št_t
 
ngx_h‰p_ssi_¡ub_ouut
(
ngx_h‰p_»que¡_t
 *
r
, *
d©a
,

89 
ngx_št_t
 
rc
);

90 
ngx_št_t
 
ngx_h‰p_ssi_£t_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, *
d©a
,

91 
ngx_št_t
 
rc
);

92 
ngx_št_t
 
ngx_h‰p_ssi_echo
(
ngx_h‰p_»que¡_t
 *
r
,

93 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

94 
ngx_št_t
 
ngx_h‰p_ssi_cÚfig
(
ngx_h‰p_»que¡_t
 *
r
,

95 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

96 
ngx_št_t
 
ngx_h‰p_ssi_£t
(
ngx_h‰p_»que¡_t
 *
r
,

97 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

98 
ngx_št_t
 
ngx_h‰p_ssi_if
(
ngx_h‰p_»que¡_t
 *
r
,

99 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

100 
ngx_št_t
 
ngx_h‰p_ssi_–£
(
ngx_h‰p_»que¡_t
 *
r
,

101 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

102 
ngx_št_t
 
ngx_h‰p_ssi_’dif
(
ngx_h‰p_»que¡_t
 *
r
,

103 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

104 
ngx_št_t
 
ngx_h‰p_ssi_block
(
ngx_h‰p_»que¡_t
 *
r
,

105 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

106 
ngx_št_t
 
ngx_h‰p_ssi_’dblock
(
ngx_h‰p_»que¡_t
 *
r
,

107 
ngx_h‰p_ssi_ùx_t
 *
ùx
, 
ngx_¡r_t
 **
·¿ms
);

109 
ngx_št_t
 
ngx_h‰p_ssi_d©e_gmt_loÿl_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

110 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
gmt
);

112 
ngx_št_t
 
ngx_h‰p_ssi_´ecÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
);

113 *
ngx_h‰p_ssi_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

114 *
ngx_h‰p_ssi_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
);

115 *
ngx_h‰p_ssi_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

116 *
ngx_h‰p_ssi_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

117 *
·»Á
, *
chžd
);

118 
ngx_št_t
 
ngx_h‰p_ssi_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

121 
ngx_commªd_t
 
	gngx_h‰p_ssi_fž‹r_commªds
[] = {

123 { 
ngx_¡ršg
("ssi"),

124 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


125 |
NGX_CONF_FLAG
,

126 
ngx_cÚf_£t_æag_¦Ù
,

127 
NGX_HTTP_LOC_CONF_OFFSET
,

128 
off£tof
(
ngx_h‰p_ssi_loc_cÚf_t
, 
’abË
),

129 
NULL
 },

131 { 
ngx_¡ršg
("ssi_silent_errors"),

132 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

133 
ngx_cÚf_£t_æag_¦Ù
,

134 
NGX_HTTP_LOC_CONF_OFFSET
,

135 
off£tof
(
ngx_h‰p_ssi_loc_cÚf_t
, 
sž’t_”rÜs
),

136 
NULL
 },

138 { 
ngx_¡ršg
("ssi_ignore_recycled_buffers"),

139 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

140 
ngx_cÚf_£t_æag_¦Ù
,

141 
NGX_HTTP_LOC_CONF_OFFSET
,

142 
off£tof
(
ngx_h‰p_ssi_loc_cÚf_t
, 
ignÜe_»cyþed_bufãrs
),

143 
NULL
 },

145 { 
ngx_¡ršg
("ssi_min_file_chunk"),

146 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

147 
ngx_cÚf_£t_size_¦Ù
,

148 
NGX_HTTP_LOC_CONF_OFFSET
,

149 
off£tof
(
ngx_h‰p_ssi_loc_cÚf_t
, 
mš_fže_chunk
),

150 
NULL
 },

152 { 
ngx_¡ršg
("ssi_value_length"),

153 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

154 
ngx_cÚf_£t_size_¦Ù
,

155 
NGX_HTTP_LOC_CONF_OFFSET
,

156 
off£tof
(
ngx_h‰p_ssi_loc_cÚf_t
, 
v®ue_Ën
),

157 
NULL
 },

159 { 
ngx_¡ršg
("ssi_types"),

160 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

161 
ngx_h‰p_ty³s_¦Ù
,

162 
NGX_HTTP_LOC_CONF_OFFSET
,

163 
off£tof
(
ngx_h‰p_ssi_loc_cÚf_t
, 
ty³s_keys
),

164 &
ngx_h‰p_html_deçuÉ_ty³s
[0] },

166 { 
ngx_¡ršg
("ssi_last_modified"),

167 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

168 
ngx_cÚf_£t_æag_¦Ù
,

169 
NGX_HTTP_LOC_CONF_OFFSET
,

170 
off£tof
(
ngx_h‰p_ssi_loc_cÚf_t
, 
Ï¡_modif›d
),

171 
NULL
 },

173 
ngx_nuÎ_commªd


178 
ngx_h‰p_moduË_t
 
	gngx_h‰p_ssi_fž‹r_moduË_ùx
 = {

179 
ngx_h‰p_ssi_´ecÚfigu¿tiÚ
,

180 
ngx_h‰p_ssi_fž‹r_š™
,

182 
ngx_h‰p_ssi_ü—‹_maš_cÚf
,

183 
ngx_h‰p_ssi_š™_maš_cÚf
,

185 
NULL
,

186 
NULL
,

188 
ngx_h‰p_ssi_ü—‹_loc_cÚf
,

189 
ngx_h‰p_ssi_m”ge_loc_cÚf


193 
ngx_moduË_t
 
	gngx_h‰p_ssi_fž‹r_moduË
 = {

194 
NGX_MODULE_V1
,

195 &
ngx_h‰p_ssi_fž‹r_moduË_ùx
,

196 
ngx_h‰p_ssi_fž‹r_commªds
,

197 
NGX_HTTP_MODULE
,

198 
NULL
,

199 
NULL
,

200 
NULL
,

201 
NULL
,

202 
NULL
,

203 
NULL
,

204 
NULL
,

205 
NGX_MODULE_V1_PADDING


209 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

210 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

213 
u_ch¬
 
	gngx_h‰p_ssi_¡ršg
[] = "<!--";

215 
ngx_¡r_t
 
	gngx_h‰p_ssi_nÚe
 = 
ngx_¡ršg
("(none)");

216 
ngx_¡r_t
 
	gngx_h‰p_ssi_timefmt
 = 
ngx_¡ršg
("%A, %d-%b-%Y %H:%M:%S %Z");

217 
ngx_¡r_t
 
	gngx_h‰p_ssi_nuÎ_¡ršg
 = 
ngx_nuÎ_¡ršg
;

220 
	#NGX_HTTP_SSI_INCLUDE_VIRTUAL
 0

	)

221 
	#NGX_HTTP_SSI_INCLUDE_FILE
 1

	)

222 
	#NGX_HTTP_SSI_INCLUDE_WAIT
 2

	)

223 
	#NGX_HTTP_SSI_INCLUDE_SET
 3

	)

224 
	#NGX_HTTP_SSI_INCLUDE_STUB
 4

	)

226 
	#NGX_HTTP_SSI_ECHO_VAR
 0

	)

227 
	#NGX_HTTP_SSI_ECHO_DEFAULT
 1

	)

228 
	#NGX_HTTP_SSI_ECHO_ENCODING
 2

	)

230 
	#NGX_HTTP_SSI_CONFIG_ERRMSG
 0

	)

231 
	#NGX_HTTP_SSI_CONFIG_TIMEFMT
 1

	)

233 
	#NGX_HTTP_SSI_SET_VAR
 0

	)

234 
	#NGX_HTTP_SSI_SET_VALUE
 1

	)

236 
	#NGX_HTTP_SSI_IF_EXPR
 0

	)

238 
	#NGX_HTTP_SSI_BLOCK_NAME
 0

	)

241 
ngx_h‰p_ssi_·¿m_t
 
	gngx_h‰p_ssi_šþude_·¿ms
[] = {

242 { 
ngx_¡ršg
("vœtu®"), 
NGX_HTTP_SSI_INCLUDE_VIRTUAL
, 0, 0 },

243 { 
ngx_¡ršg
("fže"), 
NGX_HTTP_SSI_INCLUDE_FILE
, 0, 0 },

244 { 
ngx_¡ršg
("wa™"), 
NGX_HTTP_SSI_INCLUDE_WAIT
, 0, 0 },

245 { 
ngx_¡ršg
("£t"), 
NGX_HTTP_SSI_INCLUDE_SET
, 0, 0 },

246 { 
ngx_¡ršg
("¡ub"), 
NGX_HTTP_SSI_INCLUDE_STUB
, 0, 0 },

247 { 
ngx_nuÎ_¡ršg
, 0, 0, 0 }

251 
ngx_h‰p_ssi_·¿m_t
 
	gngx_h‰p_ssi_echo_·¿ms
[] = {

252 { 
ngx_¡ršg
("v¬"), 
NGX_HTTP_SSI_ECHO_VAR
, 1, 0 },

253 { 
ngx_¡ršg
("deçuÉ"), 
NGX_HTTP_SSI_ECHO_DEFAULT
, 0, 0 },

254 { 
ngx_¡ršg
("’codšg"), 
NGX_HTTP_SSI_ECHO_ENCODING
, 0, 0 },

255 { 
ngx_nuÎ_¡ršg
, 0, 0, 0 }

259 
ngx_h‰p_ssi_·¿m_t
 
	gngx_h‰p_ssi_cÚfig_·¿ms
[] = {

260 { 
ngx_¡ršg
("”rmsg"), 
NGX_HTTP_SSI_CONFIG_ERRMSG
, 0, 0 },

261 { 
ngx_¡ršg
("timefmt"), 
NGX_HTTP_SSI_CONFIG_TIMEFMT
, 0, 0 },

262 { 
ngx_nuÎ_¡ršg
, 0, 0, 0 }

266 
ngx_h‰p_ssi_·¿m_t
 
	gngx_h‰p_ssi_£t_·¿ms
[] = {

267 { 
ngx_¡ršg
("v¬"), 
NGX_HTTP_SSI_SET_VAR
, 1, 0 },

268 { 
ngx_¡ršg
("v®ue"), 
NGX_HTTP_SSI_SET_VALUE
, 1, 0 },

269 { 
ngx_nuÎ_¡ršg
, 0, 0, 0 }

273 
ngx_h‰p_ssi_·¿m_t
 
	gngx_h‰p_ssi_if_·¿ms
[] = {

274 { 
ngx_¡ršg
("ex´"), 
NGX_HTTP_SSI_IF_EXPR
, 1, 0 },

275 { 
ngx_nuÎ_¡ršg
, 0, 0, 0 }

279 
ngx_h‰p_ssi_·¿m_t
 
	gngx_h‰p_ssi_block_·¿ms
[] = {

280 { 
ngx_¡ršg
("Çme"), 
NGX_HTTP_SSI_BLOCK_NAME
, 1, 0 },

281 { 
ngx_nuÎ_¡ršg
, 0, 0, 0 }

285 
ngx_h‰p_ssi_·¿m_t
 
	gngx_h‰p_ssi_no_·¿ms
[] = {

286 { 
ngx_nuÎ_¡ršg
, 0, 0, 0 }

290 
ngx_h‰p_ssi_commªd_t
 
	gngx_h‰p_ssi_commªds
[] = {

291 { 
ngx_¡ršg
("šþude"), 
ngx_h‰p_ssi_šþude
,

292 
ngx_h‰p_ssi_šþude_·¿ms
, 0, 0, 1 },

293 { 
ngx_¡ršg
("echo"), 
ngx_h‰p_ssi_echo
,

294 
ngx_h‰p_ssi_echo_·¿ms
, 0, 0, 0 },

295 { 
ngx_¡ršg
("cÚfig"), 
ngx_h‰p_ssi_cÚfig
,

296 
ngx_h‰p_ssi_cÚfig_·¿ms
, 0, 0, 0 },

297 { 
ngx_¡ršg
("£t"), 
ngx_h‰p_ssi_£t
, 
ngx_h‰p_ssi_£t_·¿ms
, 0, 0, 0 },

299 { 
ngx_¡ršg
("if"), 
ngx_h‰p_ssi_if
, 
ngx_h‰p_ssi_if_·¿ms
, 0, 0, 0 },

300 { 
ngx_¡ršg
("–if"), 
ngx_h‰p_ssi_if
, 
ngx_h‰p_ssi_if_·¿ms
,

301 
NGX_HTTP_SSI_COND_IF
, 0, 0 },

302 { 
ngx_¡ršg
("–£"), 
ngx_h‰p_ssi_–£
, 
ngx_h‰p_ssi_no_·¿ms
,

303 
NGX_HTTP_SSI_COND_IF
, 0, 0 },

304 { 
ngx_¡ršg
("’dif"), 
ngx_h‰p_ssi_’dif
, 
ngx_h‰p_ssi_no_·¿ms
,

305 
NGX_HTTP_SSI_COND_ELSE
, 0, 0 },

307 { 
ngx_¡ršg
("block"), 
ngx_h‰p_ssi_block
,

308 
ngx_h‰p_ssi_block_·¿ms
, 0, 0, 0 },

309 { 
ngx_¡ršg
("’dblock"), 
ngx_h‰p_ssi_’dblock
,

310 
ngx_h‰p_ssi_no_·¿ms
, 0, 1, 0 },

312 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

316 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_ssi_v¬s
[] = {

318 { 
ngx_¡ršg
("d©e_loÿl"), 
NULL
, 
ngx_h‰p_ssi_d©e_gmt_loÿl_v¬ŸbË
, 0,

319 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

321 { 
ngx_¡ršg
("d©e_gmt"), 
NULL
, 
ngx_h‰p_ssi_d©e_gmt_loÿl_v¬ŸbË
, 1,

322 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

324 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

329 
ngx_št_t


330 
	$ngx_h‰p_ssi_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

332 
ngx_h‰p_ssi_ùx_t
 *
ùx
;

333 
ngx_h‰p_ssi_loc_cÚf_t
 *
¦cf
;

335 
¦cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ssi_fž‹r_moduË
);

337 ià(!
¦cf
->
’abË


338 || 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 == 0

339 || 
	`ngx_h‰p_‹¡_cÚ‹Á_ty³
(
r
, &
¦cf
->
ty³s
è=ð
NULL
)

341  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

344 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_ssi_ùx_t
));

345 ià(
ùx
 =ð
NULL
) {

346  
NGX_ERROR
;

349 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_ssi_fž‹r_moduË
);

352 
ùx
->
v®ue_Ën
 = 
¦cf
->value_len;

353 
ùx
->
Ï¡_out
 = &ùx->
out
;

355 
ùx
->
’codšg
 = 
NGX_HTTP_SSI_ENTITY_ENCODING
;

356 
ùx
->
ouut
 = 1;

358 
ùx
->
·¿ms
.
–ts
 = ctx->
·¿ms_¬¿y
;

359 
ùx
->
·¿ms
.
size
 = (
ngx_bË_–t_t
);

360 
ùx
->
·¿ms
.
ÇÎoc
 = 
NGX_HTTP_SSI_PARAMS_N
;

361 
ùx
->
·¿ms
.
poÞ
 = 
r
->pool;

363 
ùx
->
timefmt
 = 
ngx_h‰p_ssi_timefmt
;

364 
	`ngx_¡r_£t
(&
ùx
->
”rmsg
,

367 
r
->
fž‹r_Ãed_š_memÜy
 = 1;

369 ià(
r
 =ðr->
maš
) {

370 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
r
);

371 
	`ngx_h‰p_þ—r_acû±_¿nges
(
r
);

373 ià(!
¦cf
->
Ï¡_modif›d
) {

374 
	`ngx_h‰p_þ—r_Ï¡_modif›d
(
r
);

375 
	`ngx_h‰p_þ—r_‘ag
(
r
);

378 
	`ngx_h‰p_w—k_‘ag
(
r
);

382  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

383 
	}
}

386 
ngx_št_t


387 
	$ngx_h‰p_ssi_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

389 
size_t
 
Ën
;

390 
ngx_št_t
 
rc
;

391 
ngx_buf_t
 *
b
;

392 
ngx_ušt_t
 
i
, 
šdex
;

393 
ngx_chaš_t
 *
þ
, **
Î
;

394 
ngx_bË_–t_t
 *
·¿m
;

395 
ngx_h‰p_ssi_ùx_t
 *
ùx
, *
mùx
;

396 
ngx_h‰p_ssi_block_t
 *
bl
;

397 
ngx_h‰p_ssi_·¿m_t
 *
´m
;

398 
ngx_h‰p_ssi_commªd_t
 *
cmd
;

399 
ngx_h‰p_ssi_loc_cÚf_t
 *
¦cf
;

400 
ngx_h‰p_ssi_maš_cÚf_t
 *
smcf
;

401 
ngx_¡r_t
 *
·¿ms
[
NGX_HTTP_SSI_MAX_PARAMS
 + 1];

403 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ssi_fž‹r_moduË
);

405 ià(
ùx
 =ð
NULL


406 || (
š
 =ð
NULL


407 && 
ùx
->
buf
 =ð
NULL


408 && 
ùx
->
š
 =ð
NULL


409 && 
ùx
->
busy
 =ð
NULL
))

411  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

416 ià(
š
) {

417 ià(
	`ngx_chaš_add_cÝy
(
r
->
poÞ
, &
ùx
->
š
, inè!ð
NGX_OK
) {

418  
NGX_ERROR
;

422 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

423 "h‰°ss˜fž‹¸\"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

425 ià(
ùx
->
wa™
) {

427 ià(
r
 !ðr->
cÚÃùiÚ
->
d©a
) {

428 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

430 &
ùx
->
wa™
->
uri
, &ùx->wa™->
¬gs
);

432  
NGX_AGAIN
;

435 ià(
ùx
->
wa™
->
dÚe
) {

436 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

438 &
ùx
->
wa™
->
uri
, &ùx->wa™->
¬gs
);

440 
ùx
->
wa™
 = 
NULL
;

443 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

445 &
ùx
->
wa™
->
uri
, &ùx->wa™->
¬gs
);

447  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
NULL
);

451 
¦cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_ssi_fž‹r_moduË
);

453 
ùx
->
š
 || ctx->
buf
) {

455 ià(
ùx
->
buf
 =ð
NULL
) {

456 
ùx
->
buf
 = ctx->
š
->buf;

457 
ùx
->
š
 = ctx->š->
Ãxt
;

458 
ùx
->
pos
 = ctx->
buf
->pos;

461 ià(
ùx
->
¡©e
 =ð
ssi_¡¬t_¡©e
) {

462 
ùx
->
cÝy_¡¬t
 = ctx->
pos
;

463 
ùx
->
cÝy_’d
 = ctx->
pos
;

466 
b
 = 
NULL
;

468 
ùx
->
pos
 < ctx->
buf
->
Ï¡
) {

470 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

471 "§ved: %d s‹: %d", 
ùx
->
§ved
, ctx->
¡©e
);

473 
rc
 = 
	`ngx_h‰p_ssi_·r£
(
r
, 
ùx
);

475 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

477 
rc
, 
ùx
->
looked
, ctx->
cÝy_¡¬t
, ctx->
cÝy_’d
);

479 ià(
rc
 =ð
NGX_ERROR
) {

480  
rc
;

483 ià(
ùx
->
cÝy_¡¬t
 !ðùx->
cÝy_’d
) {

485 ià(
ùx
->
ouut
) {

487 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

488 "§ved: %d", 
ùx
->
§ved
);

490 ià(
ùx
->
§ved
) {

492 ià(
ùx
->
ä“
) {

493 
þ
 = 
ùx
->
ä“
;

494 
ùx
->
ä“
 = ctx->ä“->
Ãxt
;

495 
b
 = 
þ
->
buf
;

496 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

499 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

500 ià(
b
 =ð
NULL
) {

501  
NGX_ERROR
;

504 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

505 ià(
þ
 =ð
NULL
) {

506  
NGX_ERROR
;

509 
þ
->
buf
 = 
b
;

512 
b
->
memÜy
 = 1;

513 
b
->
pos
 = 
ngx_h‰p_ssi_¡ršg
;

514 
b
->
Ï¡
 = 
ngx_h‰p_ssi_¡ršg
 + 
ùx
->
§ved
;

516 *
ùx
->
Ï¡_out
 = 
þ
;

517 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

519 
ùx
->
§ved
 = 0;

522 ià(
ùx
->
ä“
) {

523 
þ
 = 
ùx
->
ä“
;

524 
ùx
->
ä“
 = ctx->ä“->
Ãxt
;

525 
b
 = 
þ
->
buf
;

528 
b
 = 
	`ngx_®loc_buf
(
r
->
poÞ
);

529 ià(
b
 =ð
NULL
) {

530  
NGX_ERROR
;

533 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

534 ià(
þ
 =ð
NULL
) {

535  
NGX_ERROR
;

538 
þ
->
buf
 = 
b
;

541 
	`ngx_memýy
(
b
, 
ùx
->
buf
, (
ngx_buf_t
));

543 
b
->
pos
 = 
ùx
->
cÝy_¡¬t
;

544 
b
->
Ï¡
 = 
ùx
->
cÝy_’d
;

545 
b
->
shadow
 = 
NULL
;

546 
b
->
Ï¡_buf
 = 0;

547 
b
->
»cyþed
 = 0;

549 ià(
b
->
š_fže
) {

550 ià(
¦cf
->
mš_fže_chunk
 < (
size_t
è(
b
->
Ï¡
 - b->
pos
))

552 
b
->
fže_Ï¡
 = b->
fže_pos


553 + (
b
->
Ï¡
 - 
ùx
->
buf
->
pos
);

554 
b
->
fže_pos
 +ðb->
pos
 - 
ùx
->
buf
->pos;

557 
b
->
š_fže
 = 0;

561 
þ
->
Ãxt
 = 
NULL
;

562 *
ùx
->
Ï¡_out
 = 
þ
;

563 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

566 ià(
ùx
->
block


567 && 
ùx
->
§ved
 + (ùx->
cÝy_’d
 - ctx->
cÝy_¡¬t
))

569 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
,

570 
ùx
->
§ved
 + (ùx->
cÝy_’d
 - ctx->
cÝy_¡¬t
));

572 ià(
b
 =ð
NULL
) {

573  
NGX_ERROR
;

576 ià(
ùx
->
§ved
) {

577 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->
pos
, 
ngx_h‰p_ssi_¡ršg
,

578 
ùx
->
§ved
);

581 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
ùx
->
cÝy_¡¬t
,

582 
ùx
->
cÝy_’d
 - ctx->
cÝy_¡¬t
);

584 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

585 ià(
þ
 =ð
NULL
) {

586  
NGX_ERROR
;

589 
þ
->
buf
 = 
b
;

590 
þ
->
Ãxt
 = 
NULL
;

592 
b
 = 
NULL
;

594 
mùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
->
maš
,

595 
ngx_h‰p_ssi_fž‹r_moduË
);

596 
bl
 = 
mùx
->
blocks
->
–ts
;

597 
Î
 = &
bl
[
mùx
->
blocks
->
ÃÉs
 - 1].
bufs
;

598 *
Î
;

599 
Î
 = &(*Î)->
Ãxt
)

604 *
Î
 = 
þ
;

607 
ùx
->
§ved
 = 0;

611 ià(
ùx
->
¡©e
 =ð
ssi_¡¬t_¡©e
) {

612 
ùx
->
cÝy_¡¬t
 = ctx->
pos
;

613 
ùx
->
cÝy_’d
 = ctx->
pos
;

616 
ùx
->
cÝy_¡¬t
 = 
NULL
;

617 
ùx
->
cÝy_’d
 = 
NULL
;

620 ià(
rc
 =ð
NGX_AGAIN
) {

625 
b
 = 
NULL
;

627 ià(
rc
 =ð
NGX_OK
) {

629 
smcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
,

630 
ngx_h‰p_ssi_fž‹r_moduË
);

632 
cmd
 = 
	`ngx_hash_fšd
(&
smcf
->
hash
, 
ùx
->
key
, ctx->
commªd
.
d©a
,

633 
ùx
->
commªd
.
Ën
);

635 ià(
cmd
 =ð
NULL
) {

636 ià(
ùx
->
ouut
) {

637 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

639 &
ùx
->
commªd
);

640 
ssi_”rÜ
;

646 ià(!
ùx
->
ouut
 && !
cmd
->
block
) {

648 ià(
ùx
->
block
) {

652 
Ën
 = 5 + 
ùx
->
commªd
.len + 4;

654 
·¿m
 = 
ùx
->
·¿ms
.
–ts
;

655 
i
 = 0; i < 
ùx
->
·¿ms
.
ÃÉs
; i++) {

656 
Ën
 +ð1 + 
·¿m
[
i
].
key
.len + 2

657 + 
·¿m
[
i
].
v®ue
.
Ën
 + 1;

660 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
Ën
);

662 ià(
b
 =ð
NULL
) {

663  
NGX_ERROR
;

666 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

667 ià(
þ
 =ð
NULL
) {

668  
NGX_ERROR
;

671 
þ
->
buf
 = 
b
;

672 
þ
->
Ãxt
 = 
NULL
;

674 *
b
->
Ï¡
++ = '<';

675 *
b
->
Ï¡
++ = '!';

676 *
b
->
Ï¡
++ = '-';

677 *
b
->
Ï¡
++ = '-';

678 *
b
->
Ï¡
++ = '#';

680 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
ùx
->
commªd
.
d©a
,

681 
ùx
->
commªd
.
Ën
);

683 
i
 = 0; i < 
ùx
->
·¿ms
.
ÃÉs
; i++) {

684 *
b
->
Ï¡
++ = ' ';

685 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
·¿m
[
i
].
key
.
d©a
,

686 
·¿m
[
i
].
key
.
Ën
);

687 *
b
->
Ï¡
++ = '=';

688 *
b
->
Ï¡
++ = '"';

689 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
·¿m
[
i
].
v®ue
.
d©a
,

690 
·¿m
[
i
].
v®ue
.
Ën
);

691 *
b
->
Ï¡
++ = '"';

694 *
b
->
Ï¡
++ = ' ';

695 *
b
->
Ï¡
++ = '-';

696 *
b
->
Ï¡
++ = '-';

697 *
b
->
Ï¡
++ = '>';

699 
mùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
->
maš
,

700 
ngx_h‰p_ssi_fž‹r_moduË
);

701 
bl
 = 
mùx
->
blocks
->
–ts
;

702 
Î
 = &
bl
[
mùx
->
blocks
->
ÃÉs
 - 1].
bufs
;

703 *
Î
;

704 
Î
 = &(*Î)->
Ãxt
)

709 *
Î
 = 
þ
;

711 
b
 = 
NULL
;

716 ià(
cmd
->
cÚd™iÚ®
 == 0) {

721 ià(
cmd
->
cÚd™iÚ®


722 && (
ùx
->
cÚd™iÚ®
 == 0

723 || 
ùx
->
cÚd™iÚ®
 > 
cmd
->conditional))

725 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

727 &
ùx
->
commªd
);

728 
ssi_”rÜ
;

731 ià(
ùx
->
·¿ms
.
ÃÉs
 > 
NGX_HTTP_SSI_MAX_PARAMS
) {

732 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

734 &
ùx
->
commªd
);

735 
ssi_”rÜ
;

738 
	`ngx_memz”o
(
·¿ms
,

739 (
NGX_HTTP_SSI_MAX_PARAMS
 + 1è* (
ngx_¡r_t
 *));

741 
·¿m
 = 
ùx
->
·¿ms
.
–ts
;

743 
i
 = 0; i < 
ùx
->
·¿ms
.
ÃÉs
; i++) {

745 
´m
 = 
cmd
->
·¿ms
;…rm->
Çme
.
Ën
;…rm++) {

747 ià(
·¿m
[
i
].
key
.
Ën
 !ð
´m
->
Çme
.len

748 || 
	`ngx_¡ºcmp
(
·¿m
[
i
].
key
.
d©a
, 
´m
->
Çme
.data,

749 
´m
->
Çme
.
Ën
) != 0)

754 ià(!
´m
->
muÉË
) {

755 ià(
·¿ms
[
´m
->
šdex
]) {

756 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
,

757 
r
->
cÚÃùiÚ
->
log
, 0,

760 &
·¿m
[
i
].
key
, &
ùx
->
commªd
);

762 
ssi_”rÜ
;

765 
·¿ms
[
´m
->
šdex
] = &
·¿m
[
i
].
v®ue
;

770 
šdex
 = 
´m
->šdex; 
·¿ms
[index]; index++) {

774 
·¿ms
[
šdex
] = &
·¿m
[
i
].
v®ue
;

779 ià(
´m
->
Çme
.
Ën
 == 0) {

780 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

783 &
·¿m
[
i
].
key
, &
ùx
->
commªd
);

785 
ssi_”rÜ
;

789 
´m
 = 
cmd
->
·¿ms
;…rm->
Çme
.
Ën
;…rm++) {

790 ià(
´m
->
mªd©Üy
 && 
·¿ms
[´m->
šdex
] == 0) {

791 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

794 &
´m
->
Çme
, &
ùx
->
commªd
);

796 
ssi_”rÜ
;

800 ià(
cmd
->
æush
 && 
ùx
->
out
) {

802 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

805 ià(
	`ngx_h‰p_ssi_ouut
(
r
, 
ùx
è=ð
NGX_ERROR
) {

806  
NGX_ERROR
;

810 
rc
 = 
cmd
->
	`hªdËr
(
r
, 
ùx
, 
·¿ms
);

812 ià(
rc
 =ð
NGX_OK
) {

816 ià(
rc
 =ð
NGX_DONE
 ||„ø=ð
NGX_AGAIN
 ||„ø=ð
NGX_ERROR
) {

817 
	`ngx_h‰p_ssi_bufã»d
(
r
, 
ùx
);

818  
rc
;

825 
ssi_”rÜ
:

827 ià(
¦cf
->
sž’t_”rÜs
) {

831 ià(
ùx
->
ä“
) {

832 
þ
 = 
ùx
->
ä“
;

833 
ùx
->
ä“
 = ctx->ä“->
Ãxt
;

834 
b
 = 
þ
->
buf
;

835 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

838 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

839 ià(
b
 =ð
NULL
) {

840  
NGX_ERROR
;

843 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

844 ià(
þ
 =ð
NULL
) {

845  
NGX_ERROR
;

848 
þ
->
buf
 = 
b
;

851 
b
->
memÜy
 = 1;

852 
b
->
pos
 = 
ùx
->
”rmsg
.
d©a
;

853 
b
->
Ï¡
 = 
ùx
->
”rmsg
.
d©a
 + ctx->”rmsg.
Ën
;

855 
þ
->
Ãxt
 = 
NULL
;

856 *
ùx
->
Ï¡_out
 = 
þ
;

857 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

862 ià(
ùx
->
buf
->
Ï¡_buf
 || 
	`ngx_buf_š_memÜy
(ctx->buf)) {

863 ià(
b
 =ð
NULL
) {

864 ià(
ùx
->
ä“
) {

865 
þ
 = 
ùx
->
ä“
;

866 
ùx
->
ä“
 = ctx->ä“->
Ãxt
;

867 
b
 = 
þ
->
buf
;

868 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

871 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

872 ià(
b
 =ð
NULL
) {

873  
NGX_ERROR
;

876 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

877 ià(
þ
 =ð
NULL
) {

878  
NGX_ERROR
;

881 
þ
->
buf
 = 
b
;

884 
b
->
sync
 = 1;

886 
þ
->
Ãxt
 = 
NULL
;

887 *
ùx
->
Ï¡_out
 = 
þ
;

888 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

891 
b
->
Ï¡_buf
 = 
ùx
->
buf
->last_buf;

892 
b
->
shadow
 = 
ùx
->
buf
;

894 ià(
¦cf
->
ignÜe_»cyþed_bufãrs
 == 0) {

895 
b
->
»cyþed
 = 
ùx
->
buf
->recycled;

899 
ùx
->
buf
 = 
NULL
;

901 
ùx
->
§ved
 = ctx->
looked
;

904 ià(
ùx
->
out
 =ð
NULL
 && ctx->
busy
 == NULL) {

905  
NGX_OK
;

908  
	`ngx_h‰p_ssi_ouut
(
r
, 
ùx
);

909 
	}
}

912 
ngx_št_t


913 
	$ngx_h‰p_ssi_ouut
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
)

915 
ngx_št_t
 
rc
;

916 
ngx_buf_t
 *
b
;

917 
ngx_chaš_t
 *
þ
;

920 
b
 = 
NULL
;

921 
þ
 = 
ùx
->
out
; cl; cÈðþ->
Ãxt
) {

922 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

923 "ss˜out: %°%p", 
þ
->
buf
, cl->buf->
pos
);

924 ià(
þ
->
buf
 =ð
b
) {

925 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

927 
	`ngx_debug_pošt
();

928  
NGX_ERROR
;

930 
b
 = 
þ
->
buf
;

934 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
ùx
->
out
);

936 ià(
ùx
->
busy
 =ð
NULL
) {

937 
ùx
->
busy
 = ctx->
out
;

940 
þ
 = 
ùx
->
busy
; cl->
Ãxt
; cl = cl->next) { }

941 
þ
->
Ãxt
 = 
ùx
->
out
;

944 
ùx
->
out
 = 
NULL
;

945 
ùx
->
Ï¡_out
 = &ùx->
out
;

947 
ùx
->
busy
) {

949 
þ
 = 
ùx
->
busy
;

950 
b
 = 
þ
->
buf
;

952 ià(
	`ngx_buf_size
(
b
) != 0) {

956 ià(
b
->
shadow
) {

957 
b
->
shadow
->
pos
 = b->shadow->
Ï¡
;

960 
ùx
->
busy
 = 
þ
->
Ãxt
;

962 ià(
	`ngx_buf_š_memÜy
(
b
è|| b->
š_fže
) {

965 
þ
->
Ãxt
 = 
ùx
->
ä“
;

966 
ùx
->
ä“
 = 
þ
;

970 
	`ngx_h‰p_ssi_bufã»d
(
r
, 
ùx
);

972  
rc
;

973 
	}
}

977 
	$ngx_h‰p_ssi_bufã»d
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
)

979 ià(
ùx
->
š
 || ctx->
buf
) {

980 
r
->
bufã»d
 |ð
NGX_HTTP_SSI_BUFFERED
;

983 
r
->
bufã»d
 &ð~
NGX_HTTP_SSI_BUFFERED
;

985 
	}
}

988 
ngx_št_t


989 
	$ngx_h‰p_ssi_·r£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
)

991 
u_ch¬
 *
p
, *
v®ue
, *
Ï¡
, *
cÝy_’d
, 
ch
;

992 
size_t
 
looked
;

993 
ngx_h‰p_ssi_¡©e_e
 
¡©e
;

995 
¡©e
 = 
ùx
->state;

996 
looked
 = 
ùx
->looked;

997 
Ï¡
 = 
ùx
->
buf
->last;

998 
cÝy_’d
 = 
ùx
->copy_end;

1000 
p
 = 
ùx
->
pos
;… < 
Ï¡
;…++) {

1002 
ch
 = *
p
;

1004 ià(
¡©e
 =ð
ssi_¡¬t_¡©e
) {

1009 ià(
ch
 == '<') {

1010 
cÝy_’d
 = 
p
;

1011 
looked
 = 1;

1012 
¡©e
 = 
ssi_g_¡©e
;

1014 
g_¡¬‹d
;

1017 ià(++
p
 =ð
Ï¡
) {

1021 
ch
 = *
p
;

1024 
ùx
->
¡©e
 = state;

1025 
ùx
->
pos
 = 
p
;

1026 
ùx
->
looked
 =†ooked;

1027 
ùx
->
cÝy_’d
 = 
p
;

1029 ià(
ùx
->
cÝy_¡¬t
 =ð
NULL
) {

1030 
ùx
->
cÝy_¡¬t
 = ctx->
buf
->
pos
;

1033  
NGX_AGAIN
;

1035 
g_¡¬‹d
:

1040 
¡©e
) {

1042 
ssi_¡¬t_¡©e
:

1046 
ssi_g_¡©e
:

1047 
ch
) {

1049 
looked
 = 2;

1050 
¡©e
 = 
ssi_comm’t0_¡©e
;

1054 
cÝy_’d
 = 
p
;

1058 
cÝy_’d
 = 
p
;

1059 
looked
 = 0;

1060 
¡©e
 = 
ssi_¡¬t_¡©e
;

1066 
ssi_comm’t0_¡©e
:

1067 
ch
) {

1069 
looked
 = 3;

1070 
¡©e
 = 
ssi_comm’t1_¡©e
;

1074 
cÝy_’d
 = 
p
;

1075 
looked
 = 1;

1076 
¡©e
 = 
ssi_g_¡©e
;

1080 
cÝy_’d
 = 
p
;

1081 
looked
 = 0;

1082 
¡©e
 = 
ssi_¡¬t_¡©e
;

1088 
ssi_comm’t1_¡©e
:

1089 
ch
) {

1091 
looked
 = 4;

1092 
¡©e
 = 
ssi_sh¬p_¡©e
;

1096 
cÝy_’d
 = 
p
;

1097 
looked
 = 1;

1098 
¡©e
 = 
ssi_g_¡©e
;

1102 
cÝy_’d
 = 
p
;

1103 
looked
 = 0;

1104 
¡©e
 = 
ssi_¡¬t_¡©e
;

1110 
ssi_sh¬p_¡©e
:

1111 
ch
) {

1113 ià(
p
 - 
ùx
->
pos
 < 4) {

1114 
ùx
->
§ved
 = 0;

1116 
looked
 = 0;

1117 
¡©e
 = 
ssi_´ecommªd_¡©e
;

1121 
cÝy_’d
 = 
p
;

1122 
looked
 = 1;

1123 
¡©e
 = 
ssi_g_¡©e
;

1127 
cÝy_’d
 = 
p
;

1128 
looked
 = 0;

1129 
¡©e
 = 
ssi_¡¬t_¡©e
;

1135 
ssi_´ecommªd_¡©e
:

1136 
ch
) {

1138 
CR
:

1139 
LF
:

1144 
ùx
->
commªd
.
Ën
 = 1;

1145 
ùx
->
commªd
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

1146 
NGX_HTTP_SSI_COMMAND_LEN
);

1147 ià(
ùx
->
commªd
.
d©a
 =ð
NULL
) {

1148  
NGX_ERROR
;

1151 
ùx
->
commªd
.
d©a
[0] = 
ch
;

1153 
ùx
->
key
 = 0;

1154 
ùx
->
key
 = 
	`ngx_hash
(ùx->key, 
ch
);

1156 
ùx
->
·¿ms
.
ÃÉs
 = 0;

1158 
¡©e
 = 
ssi_commªd_¡©e
;

1164 
ssi_commªd_¡©e
:

1165 
ch
) {

1167 
CR
:

1168 
LF
:

1170 
¡©e
 = 
ssi_´•¬am_¡©e
;

1174 
¡©e
 = 
ssi_comm’t_’d0_¡©e
;

1178 ià(
ùx
->
commªd
.
Ën
 =ð
NGX_HTTP_SSI_COMMAND_LEN
) {

1179 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1181 &
ùx
->
commªd
, 
ch
);

1183 
¡©e
 = 
ssi_”rÜ_¡©e
;

1187 
ùx
->
commªd
.
d©a
[ùx->commªd.
Ën
++] = 
ch
;

1188 
ùx
->
key
 = 
	`ngx_hash
(ùx->key, 
ch
);

1193 
ssi_´•¬am_¡©e
:

1194 
ch
) {

1196 
CR
:

1197 
LF
:

1202 
¡©e
 = 
ssi_comm’t_’d0_¡©e
;

1206 
ùx
->
·¿m
 = 
	`ngx_¬¿y_push
(&ùx->
·¿ms
);

1207 ià(
ùx
->
·¿m
 =ð
NULL
) {

1208  
NGX_ERROR
;

1211 
ùx
->
·¿m
->
key
.
Ën
 = 1;

1212 
ùx
->
·¿m
->
key
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

1213 
NGX_HTTP_SSI_PARAM_LEN
);

1214 ià(
ùx
->
·¿m
->
key
.
d©a
 =ð
NULL
) {

1215  
NGX_ERROR
;

1218 
ùx
->
·¿m
->
key
.
d©a
[0] = 
ch
;

1220 
ùx
->
·¿m
->
v®ue
.
Ën
 = 0;

1222 ià(
ùx
->
v®ue_buf
 =ð
NULL
) {

1223 
ùx
->
·¿m
->
v®ue
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

1224 
ùx
->
v®ue_Ën
 + 1);

1225 ià(
ùx
->
·¿m
->
v®ue
.
d©a
 =ð
NULL
) {

1226  
NGX_ERROR
;

1230 
ùx
->
·¿m
->
v®ue
.
d©a
 = ctx->
v®ue_buf
;

1233 
¡©e
 = 
ssi_·¿m_¡©e
;

1239 
ssi_·¿m_¡©e
:

1240 
ch
) {

1242 
CR
:

1243 
LF
:

1245 
¡©e
 = 
ssi_´“qu®_¡©e
;

1249 
¡©e
 = 
ssi_´ev®ue_¡©e
;

1253 
¡©e
 = 
ssi_”rÜ_’d0_¡©e
;

1255 
ùx
->
·¿m
->
key
.
d©a
[ùx->·¿m->key.
Ën
++] = 
ch
;

1256 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1258 &
ùx
->
·¿m
->
key
, &ùx->
commªd
);

1262 ià(
ùx
->
·¿m
->
key
.
Ën
 =ð
NGX_HTTP_SSI_PARAM_LEN
) {

1263 
¡©e
 = 
ssi_”rÜ_¡©e
;

1264 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1267 &
ùx
->
·¿m
->
key
, 
ch
, &ùx->
commªd
);

1271 
ùx
->
·¿m
->
key
.
d©a
[ùx->·¿m->key.
Ën
++] = 
ch
;

1276 
ssi_´“qu®_¡©e
:

1277 
ch
) {

1279 
CR
:

1280 
LF
:

1285 
¡©e
 = 
ssi_´ev®ue_¡©e
;

1289 ià(
ch
 == '-') {

1290 
¡©e
 = 
ssi_”rÜ_’d0_¡©e
;

1292 
¡©e
 = 
ssi_”rÜ_¡©e
;

1295 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1298 
ch
, &
ùx
->
·¿m
->
key
, &ùx->
commªd
);

1304 
ssi_´ev®ue_¡©e
:

1305 
ch
) {

1307 
CR
:

1308 
LF
:

1313 
¡©e
 = 
ssi_doubË_quÙed_v®ue_¡©e
;

1317 
¡©e
 = 
ssi_quÙed_v®ue_¡©e
;

1321 ià(
ch
 == '-') {

1322 
¡©e
 = 
ssi_”rÜ_’d0_¡©e
;

1324 
¡©e
 = 
ssi_”rÜ_¡©e
;

1327 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1330 
ch
, &
ùx
->
·¿m
->
key
, &ùx->
commªd
);

1336 
ssi_doubË_quÙed_v®ue_¡©e
:

1337 
ch
) {

1339 
¡©e
 = 
ssi_po¡·¿m_¡©e
;

1343 
ùx
->
§ved_¡©e
 = 
ssi_doubË_quÙed_v®ue_¡©e
;

1344 
¡©e
 = 
ssi_quÙed_symbÞ_¡©e
;

1349 ià(
ùx
->
·¿m
->
v®ue
.
Ën
 =ðùx->
v®ue_Ën
) {

1350 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1353 &
ùx
->
·¿m
->
v®ue
, 
ch
, &ùx->·¿m->
key
,

1354 &
ùx
->
commªd
);

1355 
¡©e
 = 
ssi_”rÜ_¡©e
;

1359 
ùx
->
·¿m
->
v®ue
.
d©a
[ùx->·¿m->v®ue.
Ën
++] = 
ch
;

1364 
ssi_quÙed_v®ue_¡©e
:

1365 
ch
) {

1367 
¡©e
 = 
ssi_po¡·¿m_¡©e
;

1371 
ùx
->
§ved_¡©e
 = 
ssi_quÙed_v®ue_¡©e
;

1372 
¡©e
 = 
ssi_quÙed_symbÞ_¡©e
;

1377 ià(
ùx
->
·¿m
->
v®ue
.
Ën
 =ðùx->
v®ue_Ën
) {

1378 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1381 &
ùx
->
·¿m
->
v®ue
, 
ch
, &ùx->·¿m->
key
,

1382 &
ùx
->
commªd
);

1383 
¡©e
 = 
ssi_”rÜ_¡©e
;

1387 
ùx
->
·¿m
->
v®ue
.
d©a
[ùx->·¿m->v®ue.
Ën
++] = 
ch
;

1392 
ssi_quÙed_symbÞ_¡©e
:

1393 
¡©e
 = 
ùx
->
§ved_¡©e
;

1395 ià(
ùx
->
·¿m
->
v®ue
.
Ën
 =ðùx->
v®ue_Ën
) {

1396 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1399 &
ùx
->
·¿m
->
v®ue
, 
ch
, &ùx->·¿m->
key
,

1400 &
ùx
->
commªd
);

1401 
¡©e
 = 
ssi_”rÜ_¡©e
;

1405 
ùx
->
·¿m
->
v®ue
.
d©a
[ùx->·¿m->v®ue.
Ën
++] = 
ch
;

1409 
ssi_po¡·¿m_¡©e
:

1411 ià(
ùx
->
·¿m
->
v®ue
.
Ën
 + 1 < ctx->
v®ue_Ën
 / 2) {

1412 
v®ue
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
ùx
->
·¿m
->v®ue.
Ën
 + 1);

1413 ià(
v®ue
 =ð
NULL
) {

1414  
NGX_ERROR
;

1417 
	`ngx_memýy
(
v®ue
, 
ùx
->
·¿m
->v®ue.
d©a
,

1418 
ùx
->
·¿m
->
v®ue
.
Ën
);

1420 
ùx
->
v®ue_buf
 = ctx->
·¿m
->
v®ue
.
d©a
;

1421 
ùx
->
·¿m
->
v®ue
.
d©a
 = value;

1424 
ùx
->
v®ue_buf
 = 
NULL
;

1427 
ch
) {

1429 
CR
:

1430 
LF
:

1432 
¡©e
 = 
ssi_´•¬am_¡©e
;

1436 
¡©e
 = 
ssi_comm’t_’d0_¡©e
;

1440 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1443 
ch
, &
ùx
->
·¿m
->
v®ue
, &ùx->·¿m->
key
,

1444 &
ùx
->
commªd
);

1445 
¡©e
 = 
ssi_”rÜ_¡©e
;

1451 
ssi_comm’t_’d0_¡©e
:

1452 
ch
) {

1454 
¡©e
 = 
ssi_comm’t_’d1_¡©e
;

1458 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1460 
ch
, &
ùx
->
commªd
);

1461 
¡©e
 = 
ssi_”rÜ_¡©e
;

1467 
ssi_comm’t_’d1_¡©e
:

1468 
ch
) {

1470 
ùx
->
¡©e
 = 
ssi_¡¬t_¡©e
;

1471 
ùx
->
pos
 = 
p
 + 1;

1472 
ùx
->
looked
 =†ooked;

1473 
ùx
->
cÝy_’d
 = copy_end;

1475 ià(
ùx
->
cÝy_¡¬t
 =ð
NULL
 && 
cÝy_’d
) {

1476 
ùx
->
cÝy_¡¬t
 = ctx->
buf
->
pos
;

1479  
NGX_OK
;

1482 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1484 
ch
, &
ùx
->
commªd
);

1485 
¡©e
 = 
ssi_”rÜ_¡©e
;

1491 
ssi_”rÜ_¡©e
:

1492 
ch
) {

1494 
¡©e
 = 
ssi_”rÜ_’d0_¡©e
;

1503 
ssi_”rÜ_’d0_¡©e
:

1504 
ch
) {

1506 
¡©e
 = 
ssi_”rÜ_’d1_¡©e
;

1510 
¡©e
 = 
ssi_”rÜ_¡©e
;

1516 
ssi_”rÜ_’d1_¡©e
:

1517 
ch
) {

1519 
ùx
->
¡©e
 = 
ssi_¡¬t_¡©e
;

1520 
ùx
->
pos
 = 
p
 + 1;

1521 
ùx
->
looked
 =†ooked;

1522 
ùx
->
cÝy_’d
 = copy_end;

1524 ià(
ùx
->
cÝy_¡¬t
 =ð
NULL
 && 
cÝy_’d
) {

1525 
ùx
->
cÝy_¡¬t
 = ctx->
buf
->
pos
;

1528  
NGX_HTTP_SSI_ERROR
;

1531 
¡©e
 = 
ssi_”rÜ_¡©e
;

1539 
ùx
->
¡©e
 = state;

1540 
ùx
->
pos
 = 
p
;

1541 
ùx
->
looked
 =†ooked;

1543 
ùx
->
cÝy_’d
 = (
¡©e
 =ð
ssi_¡¬t_¡©e
è? 
p
 : copy_end;

1545 ià(
ùx
->
cÝy_¡¬t
 =ð
NULL
 && ctx->
cÝy_’d
) {

1546 
ùx
->
cÝy_¡¬t
 = ctx->
buf
->
pos
;

1549  
NGX_AGAIN
;

1550 
	}
}

1553 
ngx_¡r_t
 *

1554 
	$ngx_h‰p_ssi_g‘_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
Çme
,

1555 
ngx_ušt_t
 
key
)

1557 
ngx_ušt_t
 
i
;

1558 
ngx_li¡_·¹_t
 *
·¹
;

1559 
ngx_h‰p_ssi_v¬_t
 *
v¬
;

1560 
ngx_h‰p_ssi_ùx_t
 *
ùx
;

1562 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
->
maš
, 
ngx_h‰p_ssi_fž‹r_moduË
);

1564 #ià(
NGX_PCRE
)

1566 
ngx_¡r_t
 *
v®ue
;

1568 ià(
key
 >= '0' && key <= '9') {

1569 
i
 = 
key
 - '0';

1571 ià(
i
 < 
ùx
->
nÿ±u»s
) {

1572 
v®ue
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_¡r_t
));

1573 ià(
v®ue
 =ð
NULL
) {

1574  
NULL
;

1577 
i
 *= 2;

1579 
v®ue
->
d©a
 = 
ùx
->
ÿ±u»s_d©a
 + ctx->
ÿ±u»s
[
i
];

1580 
v®ue
->
Ën
 = 
ùx
->
ÿ±u»s
[
i
 + 1] - ctx->captures[i];

1582  
v®ue
;

1588 ià(
ùx
->
v¬ŸbËs
 =ð
NULL
) {

1589  
NULL
;

1592 
·¹
 = &
ùx
->
v¬ŸbËs
->part;

1593 
v¬
 = 
·¹
->
–ts
;

1595 
i
 = 0; ; i++) {

1597 ià(
i
 >ð
·¹
->
ÃÉs
) {

1598 ià(
·¹
->
Ãxt
 =ð
NULL
) {

1602 
·¹
 =…¬t->
Ãxt
;

1603 
v¬
 = 
·¹
->
–ts
;

1604 
i
 = 0;

1607 ià(
Çme
->
Ën
 !ð
v¬
[
i
].name.len) {

1611 ià(
key
 !ð
v¬
[
i
].key) {

1615 ià(
	`ngx_¡ºcmp
(
Çme
->
d©a
, 
v¬
[
i
].Çme.d©a,‚ame->
Ën
) == 0) {

1616  &
v¬
[
i
].
v®ue
;

1620  
NULL
;

1621 
	}
}

1624 
ngx_št_t


1625 
	$ngx_h‰p_ssi_ev®u©e_¡ršg
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

1626 
ngx_¡r_t
 *
‹xt
, 
ngx_ušt_t
 
æags
)

1628 
u_ch¬
 
ch
, *
p
, **
v®ue
, *
d©a
, *
·¹_d©a
;

1629 
size_t
 *
size
, 
Ën
, 
´efix
, 
·¹_Ën
;

1630 
ngx_¡r_t
 
v¬
, *
v®
;

1631 
ngx_št_t
 
key
;

1632 
ngx_ušt_t
 
i
, 
n
, 
b¿ck‘
, 
quÙed
;

1633 
ngx_¬¿y_t
 
Ëngths
, 
v®ues
;

1634 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

1636 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(
‹xt
);

1638 ià(
n
 == 0) {

1640 
d©a
 = 
‹xt
->data;

1641 
p
 = 
d©a
;

1643 ià((
æags
 & 
NGX_HTTP_SSI_ADD_PREFIX
è&& 
‹xt
->
d©a
[0] != '/') {

1645 
´efix
 = 
r
->
uri
.
Ën
;…refix;…refix--) {

1646 ià(
r
->
uri
.
d©a
[
´efix
 - 1] == '/') {

1651 ià(
´efix
) {

1652 
Ën
 = 
´efix
 + 
‹xt
->len;

1654 
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

1655 ià(
d©a
 =ð
NULL
) {

1656  
NGX_ERROR
;

1659 
p
 = 
	`ngx_cÝy
(
d©a
, 
r
->
uri
.d©a, 
´efix
);

1663 
quÙed
 = 0;

1665 
i
 = 0; i < 
‹xt
->
Ën
; i++) {

1666 
ch
 = 
‹xt
->
d©a
[
i
];

1668 ià(!
quÙed
) {

1670 ià(
ch
 == '\\') {

1671 
quÙed
 = 1;

1676 
quÙed
 = 0;

1678 ià(
ch
 != '\\' && ch != '\'' && ch != '"' && ch != '$') {

1679 *
p
++ = '\\';

1683 *
p
++ = 
ch
;

1686 
‹xt
->
Ën
 = 
p
 - 
d©a
;

1687 
‹xt
->
d©a
 = data;

1689  
NGX_OK
;

1692 ià(
	`ngx_¬¿y_š™
(&
Ëngths
, 
r
->
poÞ
, 8, (
size_t
 *)è!ð
NGX_OK
) {

1693  
NGX_ERROR
;

1696 ià(
	`ngx_¬¿y_š™
(&
v®ues
, 
r
->
poÞ
, 8, (
u_ch¬
 *)è!ð
NGX_OK
) {

1697  
NGX_ERROR
;

1700 
Ën
 = 0;

1701 
i
 = 0;

1703 
i
 < 
‹xt
->
Ën
) {

1705 ià(
‹xt
->
d©a
[
i
] == '$') {

1707 
v¬
.
Ën
 = 0;

1709 ià(++
i
 =ð
‹xt
->
Ën
) {

1710 
šv®id_v¬ŸbË
;

1713 ià(
‹xt
->
d©a
[
i
] == '{') {

1714 
b¿ck‘
 = 1;

1716 ià(++
i
 =ð
‹xt
->
Ën
) {

1717 
šv®id_v¬ŸbË
;

1720 
v¬
.
d©a
 = &
‹xt
->d©a[
i
];

1723 
b¿ck‘
 = 0;

1724 
v¬
.
d©a
 = &
‹xt
->d©a[
i
];

1727  ; 
i
 < 
‹xt
->
Ën
; i++, 
v¬
.len++) {

1728 
ch
 = 
‹xt
->
d©a
[
i
];

1730 ià(
ch
 =ð'}' && 
b¿ck‘
) {

1731 
i
++;

1732 
b¿ck‘
 = 0;

1736 ià((
ch
 >= 'A' && ch <= 'Z')

1737 || (
ch
 >= 'a' && ch <= 'z')

1738 || (
ch
 >= '0' && ch <= '9')

1739 || 
ch
 == '_')

1747 ià(
b¿ck‘
) {

1748 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1750 "v¬ŸbË i missšg", &
v¬
);

1751  
NGX_HTTP_SSI_ERROR
;

1754 ià(
v¬
.
Ën
 == 0) {

1755 
šv®id_v¬ŸbË
;

1758 
key
 = 
	`ngx_hash_¡¾ow
(
v¬
.
d©a
, v¬.d©a, v¬.
Ën
);

1760 
v®
 = 
	`ngx_h‰p_ssi_g‘_v¬ŸbË
(
r
, &
v¬
, 
key
);

1762 ià(
v®
 =ð
NULL
) {

1763 
vv
 = 
	`ngx_h‰p_g‘_v¬ŸbË
(
r
, &
v¬
, 
key
);

1764 ià(
vv
 =ð
NULL
) {

1765  
NGX_ERROR
;

1768 ià(
vv
->
nÙ_found
) {

1772 
·¹_d©a
 = 
vv
->
d©a
;

1773 
·¹_Ën
 = 
vv
->
Ën
;

1776 
·¹_d©a
 = 
v®
->
d©a
;

1777 
·¹_Ën
 = 
v®
->
Ën
;

1781 
·¹_d©a
 = &
‹xt
->
d©a
[
i
];

1782 
quÙed
 = 0;

1784 
p
 = 
·¹_d©a
; 
i
 < 
‹xt
->
Ën
; i++) {

1785 
ch
 = 
‹xt
->
d©a
[
i
];

1787 ià(!
quÙed
) {

1789 ià(
ch
 == '\\') {

1790 
quÙed
 = 1;

1794 ià(
ch
 == '$') {

1799 
quÙed
 = 0;

1801 ià(
ch
 != '\\' && ch != '\'' && ch != '"' && ch != '$') {

1802 *
p
++ = '\\';

1806 *
p
++ = 
ch
;

1809 
·¹_Ën
 = 
p
 - 
·¹_d©a
;

1812 
Ën
 +ð
·¹_Ën
;

1814 
size
 = 
	`ngx_¬¿y_push
(&
Ëngths
);

1815 ià(
size
 =ð
NULL
) {

1816  
NGX_ERROR
;

1819 *
size
 = 
·¹_Ën
;

1821 
v®ue
 = 
	`ngx_¬¿y_push
(&
v®ues
);

1822 ià(
v®ue
 =ð
NULL
) {

1823  
NGX_ERROR
;

1826 *
v®ue
 = 
·¹_d©a
;

1829 
´efix
 = 0;

1831 
size
 = 
Ëngths
.
–ts
;

1832 
v®ue
 = 
v®ues
.
–ts
;

1834 ià(
æags
 & 
NGX_HTTP_SSI_ADD_PREFIX
) {

1835 
i
 = 0; i < 
v®ues
.
ÃÉs
; i++) {

1836 ià(
size
[
i
] != 0) {

1837 ià(*
v®ue
[
i
] != '/') {

1838 
´efix
 = 
r
->
uri
.
Ën
;…refix;…refix--) {

1839 ià(
r
->
uri
.
d©a
[
´efix
 - 1] == '/') {

1840 
Ën
 +ð
´efix
;

1851 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
 + ((
æags
 & 
NGX_HTTP_SSI_ADD_ZERO
) ? 1 : 0));

1852 ià(
p
 =ð
NULL
) {

1853  
NGX_ERROR
;

1856 
‹xt
->
Ën
 =†en;

1857 
‹xt
->
d©a
 = 
p
;

1859 
p
 = 
	`ngx_cÝy
Õ, 
r
->
uri
.
d©a
, 
´efix
);

1861 
i
 = 0; i < 
v®ues
.
ÃÉs
; i++) {

1862 
p
 = 
	`ngx_cÝy
Õ, 
v®ue
[
i
], 
size
[i]);

1865  
NGX_OK
;

1867 
šv®id_v¬ŸbË
:

1869 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1870 "šv®id v¬ŸbË‚amš \"%V\"", 
‹xt
);

1872  
NGX_HTTP_SSI_ERROR
;

1873 
	}
}

1876 
ngx_št_t


1877 
	$ngx_h‰p_ssi_»gex_m©ch
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
·‰”n
,

1878 
ngx_¡r_t
 *
¡r
)

1880 #ià(
NGX_PCRE
)

1881 
rc
, *
ÿ±u»s
;

1882 
u_ch¬
 *
p
, 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

1883 
size_t
 
size
;

1884 
ngx_št_t
 
key
;

1885 
ngx_¡r_t
 *
vv
, 
Çme
, 
v®ue
;

1886 
ngx_ušt_t
 
i
, 
n
;

1887 
ngx_h‰p_ssi_ùx_t
 *
ùx
;

1888 
ngx_h‰p_ssi_v¬_t
 *
v¬
;

1889 
ngx_»gex_compže_t
 
rgc
;

1891 
	`ngx_memz”o
(&
rgc
, (
ngx_»gex_compže_t
));

1893 
rgc
.
·‰”n
 = *pattern;

1894 
rgc
.
poÞ
 = 
r
->pool;

1895 
rgc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

1896 
rgc
.
”r
.
d©a
 = 
”r¡r
;

1898 ià(
	`ngx_»gex_compže
(&
rgc
è!ð
NGX_OK
) {

1899 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0, "%V", &
rgc
.
”r
);

1900  
NGX_HTTP_SSI_ERROR
;

1903 
n
 = (
rgc
.
ÿ±u»s
 + 1) * 3;

1905 
ÿ±u»s
 = 
	`ngx_·Îoc
(
r
->
poÞ
, 
n
 * ());

1906 ià(
ÿ±u»s
 =ð
NULL
) {

1907  
NGX_ERROR
;

1910 
rc
 = 
	`ngx_»gex_exec
(
rgc
.
»gex
, 
¡r
, 
ÿ±u»s
, 
n
);

1912 ià(
rc
 < 
NGX_REGEX_NO_MATCHED
) {

1913 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

1914 
ngx_»gex_exec_n
 " failed: %i on \"%V\" using \"%V\"",

1915 
rc
, 
¡r
, 
·‰”n
);

1916  
NGX_HTTP_SSI_ERROR
;

1919 ià(
rc
 =ð
NGX_REGEX_NO_MATCHED
) {

1920  
NGX_DECLINED
;

1923 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
->
maš
, 
ngx_h‰p_ssi_fž‹r_moduË
);

1925 
ùx
->
nÿ±u»s
 = 
rc
;

1926 
ùx
->
ÿ±u»s
 = captures;

1927 
ùx
->
ÿ±u»s_d©a
 = 
¡r
->
d©a
;

1929 ià(
rgc
.
Çmed_ÿ±u»s
 > 0) {

1931 ià(
ùx
->
v¬ŸbËs
 =ð
NULL
) {

1932 
ùx
->
v¬ŸbËs
 = 
	`ngx_li¡_ü—‹
(
r
->
poÞ
, 4,

1933 (
ngx_h‰p_ssi_v¬_t
));

1934 ià(
ùx
->
v¬ŸbËs
 =ð
NULL
) {

1935  
NGX_ERROR
;

1939 
size
 = 
rgc
.
Çme_size
;

1940 
p
 = 
rgc
.
Çmes
;

1942 
i
 = 0; i < (
ngx_ušt_t
è
rgc
.
Çmed_ÿ±u»s
; i++, 
p
 +ð
size
) {

1944 
Çme
.
d©a
 = &
p
[2];

1945 
Çme
.
Ën
 = 
	`ngx_¡¾’
Òame.
d©a
);

1947 
n
 = 2 * ((
p
[0] << 8) +…[1]);

1949 
v®ue
.
d©a
 = &
¡r
->d©a[
ÿ±u»s
[
n
]];

1950 
v®ue
.
Ën
 = 
ÿ±u»s
[
n
 + 1] - captures[n];

1952 
key
 = 
	`ngx_hash_¡¾ow
(
Çme
.
d©a
,‚ame.d©a,‚ame.
Ën
);

1954 
vv
 = 
	`ngx_h‰p_ssi_g‘_v¬ŸbË
(
r
, &
Çme
, 
key
);

1956 ià(
vv
) {

1957 *
vv
 = 
v®ue
;

1961 
v¬
 = 
	`ngx_li¡_push
(
ùx
->
v¬ŸbËs
);

1962 ià(
v¬
 =ð
NULL
) {

1963  
NGX_ERROR
;

1966 
v¬
->
Çme
 =‚ame;

1967 
v¬
->
key
 = key;

1968 
v¬
->
v®ue
 = value;

1972  
NGX_OK
;

1976 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

1978 
·‰”n
);

1979  
NGX_HTTP_SSI_ERROR
;

1982 
	}
}

1985 
ngx_št_t


1986 
	$ngx_h‰p_ssi_šþude
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

1987 
ngx_¡r_t
 **
·¿ms
)

1989 
ngx_št_t
 
rc
, 
key
;

1990 
ngx_¡r_t
 *
uri
, *
fže
, *
wa™
, *
£t
, *
¡ub
, 
¬gs
;

1991 
ngx_buf_t
 *
b
;

1992 
ngx_ušt_t
 
æags
, 
i
;

1993 
ngx_chaš_t
 *
þ
, *
Ž
, **
Î
, *
out
;

1994 
ngx_h‰p_»que¡_t
 *
¤
;

1995 
ngx_h‰p_ssi_v¬_t
 *
v¬
;

1996 
ngx_h‰p_ssi_ùx_t
 *
mùx
;

1997 
ngx_h‰p_ssi_block_t
 *
bl
;

1998 
ngx_h‰p_po¡_sub»que¡_t
 *
p¤
;

2000 
uri
 = 
·¿ms
[
NGX_HTTP_SSI_INCLUDE_VIRTUAL
];

2001 
fže
 = 
·¿ms
[
NGX_HTTP_SSI_INCLUDE_FILE
];

2002 
wa™
 = 
·¿ms
[
NGX_HTTP_SSI_INCLUDE_WAIT
];

2003 
£t
 = 
·¿ms
[
NGX_HTTP_SSI_INCLUDE_SET
];

2004 
¡ub
 = 
·¿ms
[
NGX_HTTP_SSI_INCLUDE_STUB
];

2006 ià(
uri
 && 
fže
) {

2007 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2009 
uri
, 
fže
);

2010  
NGX_HTTP_SSI_ERROR
;

2013 ià(
uri
 =ð
NULL
 && 
fže
 == NULL) {

2014 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2016  
NGX_HTTP_SSI_ERROR
;

2019 ià(
£t
 && 
¡ub
) {

2020 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2023  
NGX_HTTP_SSI_ERROR
;

2026 ià(
wa™
) {

2027 ià(
uri
 =ð
NULL
) {

2028 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2029 "\"wa™\" cªnÙ bu£d w™h fže=\"%V\"", 
fže
);

2030  
NGX_HTTP_SSI_ERROR
;

2033 ià(
wa™
->
Ën
 == 2

2034 && 
	`ngx_¡ºÿ£cmp
(
wa™
->
d©a
, (
u_ch¬
 *) "no", 2) == 0)

2036 
wa™
 = 
NULL
;

2038 } ià(
wa™
->
Ën
 != 3

2039 || 
	`ngx_¡ºÿ£cmp
(
wa™
->
d©a
, (
u_ch¬
 *) "yes", 3) != 0)

2041 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2043 
wa™
);

2044  
NGX_HTTP_SSI_ERROR
;

2048 ià(
uri
 =ð
NULL
) {

2049 
uri
 = 
fže
;

2050 
wa™
 = (
ngx_¡r_t
 *) -1;

2053 
rc
 = 
	`ngx_h‰p_ssi_ev®u©e_¡ršg
(
r
, 
ùx
, 
uri
, 
NGX_HTTP_SSI_ADD_PREFIX
);

2055 ià(
rc
 !ð
NGX_OK
) {

2056  
rc
;

2059 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2060 "ss˜šþude: \"%V\"", 
uri
);

2062 
	`ngx_¡r_nuÎ
(&
¬gs
);

2063 
æags
 = 
NGX_HTTP_LOG_UNSAFE
;

2065 ià(
	`ngx_h‰p_·r£_un§ã_uri
(
r
, 
uri
, &
¬gs
, &
æags
è!ð
NGX_OK
) {

2066  
NGX_HTTP_SSI_ERROR
;

2069 
p¤
 = 
NULL
;

2071 
mùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
->
maš
, 
ngx_h‰p_ssi_fž‹r_moduË
);

2073 ià(
¡ub
) {

2074 ià(
mùx
->
blocks
) {

2075 
bl
 = 
mùx
->
blocks
->
–ts
;

2076 
i
 = 0; i < 
mùx
->
blocks
->
ÃÉs
; i++) {

2077 ià(
¡ub
->
Ën
 =ð
bl
[
i
].
Çme
.len

2078 && 
	`ngx_¡ºcmp
(
¡ub
->
d©a
, 
bl
[
i
].
Çme
.d©a, stub->
Ën
) == 0)

2080 
found
;

2085 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2086 "\"¡ub\"=\"%V\" fÜ \"šþude\"‚Ù found", 
¡ub
);

2087  
NGX_HTTP_SSI_ERROR
;

2089 
found
:

2091 
p¤
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_po¡_sub»que¡_t
));

2092 ià(
p¤
 =ð
NULL
) {

2093  
NGX_ERROR
;

2096 
p¤
->
hªdËr
 = 
ngx_h‰p_ssi_¡ub_ouut
;

2098 ià(
bl
[
i
].
couÁ
++) {

2100 
out
 = 
NULL
;

2101 
Î
 = &
out
;

2103 
Ž
 = 
bl
[
i
].
bufs
;l;ÈðŽ->
Ãxt
) {

2105 ià(
ùx
->
ä“
) {

2106 
þ
 = 
ùx
->
ä“
;

2107 
ùx
->
ä“
 = ctx->ä“->
Ãxt
;

2108 
b
 = 
þ
->
buf
;

2111 
b
 = 
	`ngx_®loc_buf
(
r
->
poÞ
);

2112 ià(
b
 =ð
NULL
) {

2113  
NGX_ERROR
;

2116 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

2117 ià(
þ
 =ð
NULL
) {

2118  
NGX_ERROR
;

2121 
þ
->
buf
 = 
b
;

2124 
	`ngx_memýy
(
b
, 
Ž
->
buf
, (
ngx_buf_t
));

2126 
b
->
pos
 = b->
¡¬t
;

2128 *
Î
 = 
þ
;

2129 
þ
->
Ãxt
 = 
NULL
;

2130 
Î
 = &
þ
->
Ãxt
;

2133 
p¤
->
d©a
 = 
out
;

2136 
p¤
->
d©a
 = 
bl
[
i
].
bufs
;

2140 ià(
wa™
) {

2141 
æags
 |ð
NGX_HTTP_SUBREQUEST_WAITED
;

2144 ià(
£t
) {

2145 
key
 = 
	`ngx_hash_¡¾ow
(
£t
->
d©a
, s‘->d©a, s‘->
Ën
);

2147 
p¤
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_po¡_sub»que¡_t
));

2148 ià(
p¤
 =ð
NULL
) {

2149  
NGX_ERROR
;

2152 
p¤
->
hªdËr
 = 
ngx_h‰p_ssi_£t_v¬ŸbË
;

2153 
p¤
->
d©a
 = 
	`ngx_h‰p_ssi_g‘_v¬ŸbË
(
r
, 
£t
, 
key
);

2155 ià(
p¤
->
d©a
 =ð
NULL
) {

2157 ià(
mùx
->
v¬ŸbËs
 =ð
NULL
) {

2158 
mùx
->
v¬ŸbËs
 = 
	`ngx_li¡_ü—‹
(
r
->
poÞ
, 4,

2159 (
ngx_h‰p_ssi_v¬_t
));

2160 ià(
mùx
->
v¬ŸbËs
 =ð
NULL
) {

2161  
NGX_ERROR
;

2165 
v¬
 = 
	`ngx_li¡_push
(
mùx
->
v¬ŸbËs
);

2166 ià(
v¬
 =ð
NULL
) {

2167  
NGX_ERROR
;

2170 
v¬
->
Çme
 = *
£t
;

2171 
v¬
->
key
 = key;

2172 
v¬
->
v®ue
 = 
ngx_h‰p_ssi_nuÎ_¡ršg
;

2173 
p¤
->
d©a
 = &
v¬
->
v®ue
;

2176 
æags
 |ð
NGX_HTTP_SUBREQUEST_IN_MEMORY
|
NGX_HTTP_SUBREQUEST_WAITED
;

2179 ià(
	`ngx_h‰p_sub»que¡
(
r
, 
uri
, &
¬gs
, &
¤
, 
p¤
, 
æags
è!ð
NGX_OK
) {

2180  
NGX_HTTP_SSI_ERROR
;

2183 ià(
wa™
 =ð
NULL
 && 
£t
 == NULL) {

2184  
NGX_OK
;

2187 ià(
ùx
->
wa™
 =ð
NULL
) {

2188 
ùx
->
wa™
 = 
¤
;

2190  
NGX_AGAIN
;

2193 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2197  
NGX_OK
;

2198 
	}
}

2201 
ngx_št_t


2202 
	$ngx_h‰p_ssi_¡ub_ouut
(
ngx_h‰p_»que¡_t
 *
r
, *
d©a
, 
ngx_št_t
 
rc
)

2204 
ngx_chaš_t
 *
out
;

2206 ià(
rc
 =ð
NGX_ERROR
 || 
r
->
cÚÃùiÚ
->
”rÜ
 ||„->
»que¡_ouut
) {

2207  
rc
;

2210 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2211 "ss˜¡ub ouut: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

2213 
out
 = 
d©a
;

2215 ià(!
r
->
h—d”_£Á
) {

2216 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 =

2217 
r
->
·»Á
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
;

2218 
r
->
h—d”s_out
.
cÚ‹Á_ty³
 =„->
·»Á
->headers_out.content_type;

2220 ià(
	`ngx_h‰p_£nd_h—d”
(
r
è=ð
NGX_ERROR
) {

2221  
NGX_ERROR
;

2225  
	`ngx_h‰p_ouut_fž‹r
(
r
, 
out
);

2226 
	}
}

2229 
ngx_št_t


2230 
	$ngx_h‰p_ssi_£t_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, *
d©a
, 
ngx_št_t
 
rc
)

2232 
ngx_¡r_t
 *
v®ue
 = 
d©a
;

2234 ià(
r
->
up¡»am
) {

2235 
v®ue
->
Ën
 = 
r
->
up¡»am
->
bufãr
.
Ï¡
 -„->up¡»am->bufãr.
pos
;

2236 
v®ue
->
d©a
 = 
r
->
up¡»am
->
bufãr
.
pos
;

2239  
rc
;

2240 
	}
}

2243 
ngx_št_t


2244 
	$ngx_h‰p_ssi_echo
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

2245 
ngx_¡r_t
 **
·¿ms
)

2247 
u_ch¬
 *
p
;

2248 
ušŒ_t
 
Ën
;

2249 
ngx_št_t
 
key
;

2250 
ngx_buf_t
 *
b
;

2251 
ngx_¡r_t
 *
v¬
, *
v®ue
, *
’c
, 
‹xt
;

2252 
ngx_chaš_t
 *
þ
;

2253 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

2255 
v¬
 = 
·¿ms
[
NGX_HTTP_SSI_ECHO_VAR
];

2257 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2258 "ss˜echØ\"%V\"", 
v¬
);

2260 
key
 = 
	`ngx_hash_¡¾ow
(
v¬
->
d©a
, v¬->d©a, v¬->
Ën
);

2262 
v®ue
 = 
	`ngx_h‰p_ssi_g‘_v¬ŸbË
(
r
, 
v¬
, 
key
);

2264 ià(
v®ue
 =ð
NULL
) {

2265 
vv
 = 
	`ngx_h‰p_g‘_v¬ŸbË
(
r
, 
v¬
, 
key
);

2267 ià(
vv
 =ð
NULL
) {

2268  
NGX_HTTP_SSI_ERROR
;

2271 ià(!
vv
->
nÙ_found
) {

2272 
‹xt
.
d©a
 = 
vv
->data;

2273 
‹xt
.
Ën
 = 
vv
->len;

2274 
v®ue
 = &
‹xt
;

2278 ià(
v®ue
 =ð
NULL
) {

2279 
v®ue
 = 
·¿ms
[
NGX_HTTP_SSI_ECHO_DEFAULT
];

2281 ià(
v®ue
 =ð
NULL
) {

2282 
v®ue
 = &
ngx_h‰p_ssi_nÚe
;

2284 } ià(
v®ue
->
Ën
 == 0) {

2285  
NGX_OK
;

2289 ià(
v®ue
->
Ën
 == 0) {

2290  
NGX_OK
;

2294 
’c
 = 
·¿ms
[
NGX_HTTP_SSI_ECHO_ENCODING
];

2296 ià(
’c
) {

2297 ià(
’c
->
Ën
 =ð4 && 
	`ngx_¡ºcmp
Ónc->
d©a
, "none", 4) == 0) {

2299 
ùx
->
’codšg
 = 
NGX_HTTP_SSI_NO_ENCODING
;

2301 } ià(
’c
->
Ën
 =ð3 && 
	`ngx_¡ºcmp
Ónc->
d©a
, "url", 3) == 0) {

2303 
ùx
->
’codšg
 = 
NGX_HTTP_SSI_URL_ENCODING
;

2305 } ià(
’c
->
Ën
 =ð6 && 
	`ngx_¡ºcmp
Ónc->
d©a
, "entity", 6) == 0) {

2307 
ùx
->
’codšg
 = 
NGX_HTTP_SSI_ENTITY_ENCODING
;

2310 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2312 
’c
);

2316 
p
 = 
v®ue
->
d©a
;

2318 
ùx
->
’codšg
) {

2320 
NGX_HTTP_SSI_URL_ENCODING
:

2321 
Ën
 = 2 * 
	`ngx_esÿ³_uri
(
NULL
, 
v®ue
->
d©a
, value->len,

2322 
NGX_ESCAPE_HTML
);

2324 ià(
Ën
) {

2325 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
v®ue
->
Ën
 +†en);

2326 ià(
p
 =ð
NULL
) {

2327  
NGX_HTTP_SSI_ERROR
;

2330 (è
	`ngx_esÿ³_uri
(
p
, 
v®ue
->
d©a
, v®ue->
Ën
, 
NGX_ESCAPE_HTML
);

2333 
Ën
 +ð
v®ue
->len;

2336 
NGX_HTTP_SSI_ENTITY_ENCODING
:

2337 
Ën
 = 
	`ngx_esÿ³_html
(
NULL
, 
v®ue
->
d©a
, value->len);

2339 ià(
Ën
) {

2340 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
v®ue
->
Ën
 +†en);

2341 ià(
p
 =ð
NULL
) {

2342  
NGX_HTTP_SSI_ERROR
;

2345 (è
	`ngx_esÿ³_html
(
p
, 
v®ue
->
d©a
, v®ue->
Ën
);

2348 
Ën
 +ð
v®ue
->len;

2352 
Ën
 = 
v®ue
->len;

2356 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

2357 ià(
b
 =ð
NULL
) {

2358  
NGX_HTTP_SSI_ERROR
;

2361 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

2362 ià(
þ
 =ð
NULL
) {

2363  
NGX_HTTP_SSI_ERROR
;

2366 
b
->
memÜy
 = 1;

2367 
b
->
pos
 = 
p
;

2368 
b
->
Ï¡
 = 
p
 + 
Ën
;

2370 
þ
->
buf
 = 
b
;

2371 
þ
->
Ãxt
 = 
NULL
;

2372 *
ùx
->
Ï¡_out
 = 
þ
;

2373 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

2375  
NGX_OK
;

2376 
	}
}

2379 
ngx_št_t


2380 
	$ngx_h‰p_ssi_cÚfig
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

2381 
ngx_¡r_t
 **
·¿ms
)

2383 
ngx_¡r_t
 *
v®ue
;

2385 
v®ue
 = 
·¿ms
[
NGX_HTTP_SSI_CONFIG_TIMEFMT
];

2387 ià(
v®ue
) {

2388 
ùx
->
timefmt
.
Ën
 = 
v®ue
->len;

2389 
ùx
->
timefmt
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
v®ue
->
Ën
 + 1);

2390 ià(
ùx
->
timefmt
.
d©a
 =ð
NULL
) {

2391  
NGX_HTTP_SSI_ERROR
;

2394 
	`ngx_ýy¡º
(
ùx
->
timefmt
.
d©a
, 
v®ue
->d©a, v®ue->
Ën
 + 1);

2397 
v®ue
 = 
·¿ms
[
NGX_HTTP_SSI_CONFIG_ERRMSG
];

2399 ià(
v®ue
) {

2400 
ùx
->
”rmsg
 = *
v®ue
;

2403  
NGX_OK
;

2404 
	}
}

2407 
ngx_št_t


2408 
	$ngx_h‰p_ssi_£t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

2409 
ngx_¡r_t
 **
·¿ms
)

2411 
ngx_št_t
 
key
, 
rc
;

2412 
ngx_¡r_t
 *
Çme
, *
v®ue
, *
vv
;

2413 
ngx_h‰p_ssi_v¬_t
 *
v¬
;

2414 
ngx_h‰p_ssi_ùx_t
 *
mùx
;

2416 
mùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
->
maš
, 
ngx_h‰p_ssi_fž‹r_moduË
);

2418 ià(
mùx
->
v¬ŸbËs
 =ð
NULL
) {

2419 
mùx
->
v¬ŸbËs
 = 
	`ngx_li¡_ü—‹
(
r
->
poÞ
, 4,

2420 (
ngx_h‰p_ssi_v¬_t
));

2421 ià(
mùx
->
v¬ŸbËs
 =ð
NULL
) {

2422  
NGX_ERROR
;

2426 
Çme
 = 
·¿ms
[
NGX_HTTP_SSI_SET_VAR
];

2427 
v®ue
 = 
·¿ms
[
NGX_HTTP_SSI_SET_VALUE
];

2429 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2430 "ss˜£ˆ\"%V\" \"%V\"", 
Çme
, 
v®ue
);

2432 
rc
 = 
	`ngx_h‰p_ssi_ev®u©e_¡ršg
(
r
, 
ùx
, 
v®ue
, 0);

2434 ià(
rc
 !ð
NGX_OK
) {

2435  
rc
;

2438 
key
 = 
	`ngx_hash_¡¾ow
(
Çme
->
d©a
,‚ame->d©a,‚ame->
Ën
);

2440 
vv
 = 
	`ngx_h‰p_ssi_g‘_v¬ŸbË
(
r
, 
Çme
, 
key
);

2442 ià(
vv
) {

2443 *
vv
 = *
v®ue
;

2444  
NGX_OK
;

2447 
v¬
 = 
	`ngx_li¡_push
(
mùx
->
v¬ŸbËs
);

2448 ià(
v¬
 =ð
NULL
) {

2449  
NGX_ERROR
;

2452 
v¬
->
Çme
 = *name;

2453 
v¬
->
key
 = key;

2454 
v¬
->
v®ue
 = *value;

2456 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2457 "£t: \"%V\"=\"%V\"", 
Çme
, 
v®ue
);

2459  
NGX_OK
;

2460 
	}
}

2463 
ngx_št_t


2464 
	$ngx_h‰p_ssi_if
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

2465 
ngx_¡r_t
 **
·¿ms
)

2467 
u_ch¬
 *
p
, *
Ï¡
;

2468 
ngx_¡r_t
 *
ex´
, 
Ëá
, 
right
;

2469 
ngx_št_t
 
rc
;

2470 
ngx_ušt_t
 
Ãg©ive
, 
nÜegex
, 
æags
;

2472 ià(
ùx
->
commªd
.
Ën
 == 2) {

2473 ià(
ùx
->
cÚd™iÚ®
) {

2474 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2476  
NGX_HTTP_SSI_ERROR
;

2480 ià(
ùx
->
ouut_cho£n
) {

2481 
ùx
->
ouut
 = 0;

2482  
NGX_OK
;

2485 
ex´
 = 
·¿ms
[
NGX_HTTP_SSI_IF_EXPR
];

2487 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2488 "ss˜iàex´=\"%V\"", 
ex´
);

2490 
Ëá
.
d©a
 = 
ex´
->data;

2491 
Ï¡
 = 
ex´
->
d©a
 +ƒx´->
Ën
;

2493 
p
 = 
Ëá
.
d©a
;… < 
Ï¡
;…++) {

2494 ià(*
p
 >= 'A' && *p <= 'Z') {

2495 *
p
 |= 0x20;

2499 ià((*
p
 >= 'a' && *p <= 'z')

2500 || (*
p
 >= '0' && *p <= '9')

2501 || *
p
 == '$' || *p == '{' || *p == '}' || *p == '_'

2502 || *
p
 == '"' || *p == '\'')

2510 
Ëá
.
Ën
 = 
p
 -†eá.
d©a
;

2512 
p
 < 
Ï¡
 && *p == ' ') {

2513 
p
++;

2516 
æags
 = 0;

2518 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2519 "Ëá: \"%V\"", &
Ëá
);

2521 
rc
 = 
	`ngx_h‰p_ssi_ev®u©e_¡ršg
(
r
, 
ùx
, &
Ëá
, 
æags
);

2523 ià(
rc
 !ð
NGX_OK
) {

2524  
rc
;

2527 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2528 "ev®u‹d†eá: \"%V\"", &
Ëá
);

2530 ià(
p
 =ð
Ï¡
) {

2531 ià(
Ëá
.
Ën
) {

2532 
ùx
->
ouut
 = 1;

2533 
ùx
->
ouut_cho£n
 = 1;

2536 
ùx
->
ouut
 = 0;

2539 
ùx
->
cÚd™iÚ®
 = 
NGX_HTTP_SSI_COND_IF
;

2541  
NGX_OK
;

2544 ià(
p
 < 
Ï¡
 && *p == '=') {

2545 
Ãg©ive
 = 0;

2546 
p
++;

2548 } ià(
p
 + 1 < 
Ï¡
 && *p == '!' && *(p + 1) == '=') {

2549 
Ãg©ive
 = 1;

2550 
p
 += 2;

2553 
šv®id_ex´essiÚ
;

2556 
p
 < 
Ï¡
 && *p == ' ') {

2557 
p
++;

2560 ià(
p
 < 
Ï¡
 - 1 && *p == '/') {

2561 ià(*(
Ï¡
 - 1) != '/') {

2562 
šv®id_ex´essiÚ
;

2565 
nÜegex
 = 0;

2566 
æags
 = 
NGX_HTTP_SSI_ADD_ZERO
;

2567 
Ï¡
--;

2568 
p
++;

2571 
nÜegex
 = 1;

2572 
æags
 = 0;

2574 ià(
p
 < 
Ï¡
 - 1 &&…[0] == '\\' &&…[1] == '/') {

2575 
p
++;

2579 
right
.
Ën
 = 
Ï¡
 - 
p
;

2580 
right
.
d©a
 = 
p
;

2582 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2583 "right: \"%V\"", &
right
);

2585 
rc
 = 
	`ngx_h‰p_ssi_ev®u©e_¡ršg
(
r
, 
ùx
, &
right
, 
æags
);

2587 ià(
rc
 !ð
NGX_OK
) {

2588  
rc
;

2591 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2592 "ev®u‹d„ight: \"%V\"", &
right
);

2594 ià(
nÜegex
) {

2595 ià(
Ëá
.
Ën
 !ð
right
.len) {

2596 
rc
 = -1;

2599 
rc
 = 
	`ngx_¡ºcmp
(
Ëá
.
d©a
, 
right
.d©a,„ight.
Ën
);

2603 
right
.
d©a
[right.
Ën
] = '\0';

2605 
rc
 = 
	`ngx_h‰p_ssi_»gex_m©ch
(
r
, &
right
, &
Ëá
);

2607 ià(
rc
 =ð
NGX_OK
) {

2608 
rc
 = 0;

2609 } ià(
rc
 =ð
NGX_DECLINED
) {

2610 
rc
 = -1;

2612  
rc
;

2616 ià((
rc
 =ð0 && !
Ãg©ive
) || (rc != 0 &&‚egative)) {

2617 
ùx
->
ouut
 = 1;

2618 
ùx
->
ouut_cho£n
 = 1;

2621 
ùx
->
ouut
 = 0;

2624 
ùx
->
cÚd™iÚ®
 = 
NGX_HTTP_SSI_COND_IF
;

2626  
NGX_OK
;

2628 
šv®id_ex´essiÚ
:

2630 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2631 "šv®idƒx´essiÚ iÀ\"%V\"", 
ex´
);

2633  
NGX_HTTP_SSI_ERROR
;

2634 
	}
}

2637 
ngx_št_t


2638 
	$ngx_h‰p_ssi_–£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

2639 
ngx_¡r_t
 **
·¿ms
)

2641 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2644 ià(
ùx
->
ouut_cho£n
) {

2645 
ùx
->
ouut
 = 0;

2647 
ùx
->
ouut
 = 1;

2650 
ùx
->
cÚd™iÚ®
 = 
NGX_HTTP_SSI_COND_ELSE
;

2652  
NGX_OK
;

2653 
	}
}

2656 
ngx_št_t


2657 
	$ngx_h‰p_ssi_’dif
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

2658 
ngx_¡r_t
 **
·¿ms
)

2660 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2663 
ùx
->
ouut
 = 1;

2664 
ùx
->
ouut_cho£n
 = 0;

2665 
ùx
->
cÚd™iÚ®
 = 0;

2667  
NGX_OK
;

2668 
	}
}

2671 
ngx_št_t


2672 
	$ngx_h‰p_ssi_block
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

2673 
ngx_¡r_t
 **
·¿ms
)

2675 
ngx_h‰p_ssi_ùx_t
 *
mùx
;

2676 
ngx_h‰p_ssi_block_t
 *
bl
;

2678 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2681 
mùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
->
maš
, 
ngx_h‰p_ssi_fž‹r_moduË
);

2683 ià(
mùx
->
blocks
 =ð
NULL
) {

2684 
mùx
->
blocks
 = 
	`ngx_¬¿y_ü—‹
(
r
->
poÞ
, 4,

2685 (
ngx_h‰p_ssi_block_t
));

2686 ià(
mùx
->
blocks
 =ð
NULL
) {

2687  
NGX_HTTP_SSI_ERROR
;

2691 
bl
 = 
	`ngx_¬¿y_push
(
mùx
->
blocks
);

2692 ià(
bl
 =ð
NULL
) {

2693  
NGX_HTTP_SSI_ERROR
;

2696 
bl
->
Çme
 = *
·¿ms
[
NGX_HTTP_SSI_BLOCK_NAME
];

2697 
bl
->
bufs
 = 
NULL
;

2698 
bl
->
couÁ
 = 0;

2700 
ùx
->
ouut
 = 0;

2701 
ùx
->
block
 = 1;

2703  
NGX_OK
;

2704 
	}
}

2707 
ngx_št_t


2708 
	$ngx_h‰p_ssi_’dblock
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ùx
,

2709 
ngx_¡r_t
 **
·¿ms
)

2711 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2714 
ùx
->
ouut
 = 1;

2715 
ùx
->
block
 = 0;

2717  
NGX_OK
;

2718 
	}
}

2721 
ngx_št_t


2722 
	$ngx_h‰p_ssi_d©e_gmt_loÿl_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

2723 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
gmt
)

2725 
ngx_h‰p_ssi_ùx_t
 *
ùx
;

2726 
ngx_time_t
 *

;

2727 
ngx_¡r_t
 *
timefmt
;

2728 
tm
m;

2729 
buf
[
NGX_HTTP_SSI_DATE_LEN
];

2731 
v
->
v®id
 = 1;

2732 
v
->
no_ÿch—bË
 = 0;

2733 
v
->
nÙ_found
 = 0;

2735 

 = 
	`ngx_timeofday
();

2737 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_ssi_fž‹r_moduË
);

2739 
timefmt
 = 
ùx
 ? &ùx->timefmˆ: &
ngx_h‰p_ssi_timefmt
;

2741 ià(
timefmt
->
Ën
 == ("%s") - 1

2742 && 
timefmt
->
d©a
[0] == '%' &&imefmt->data[1] == 's')

2744 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_TIME_T_LEN
);

2745 ià(
v
->
d©a
 =ð
NULL
) {

2746  
NGX_ERROR
;

2749 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%T", 

->
£c
) - v->data;

2751  
NGX_OK
;

2754 ià(
gmt
) {

2755 
	`ngx_libc_gmtime
(

->
£c
, &
tm
);

2757 
	`ngx_libc_loÿÉime
(

->
£c
, &
tm
);

2760 
v
->
Ën
 = 
	`¡ráime
(
buf
, 
NGX_HTTP_SSI_DATE_LEN
,

2761 (*è
timefmt
->
d©a
, &
tm
);

2762 ià(
v
->
Ën
 == 0) {

2763  
NGX_ERROR
;

2766 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, v->
Ën
);

2767 ià(
v
->
d©a
 =ð
NULL
) {

2768  
NGX_ERROR
;

2771 
	`ngx_memýy
(
v
->
d©a
, 
buf
, v->
Ën
);

2773  
NGX_OK
;

2774 
	}
}

2777 
ngx_št_t


2778 
	$ngx_h‰p_ssi_´ecÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
)

2780 
ngx_št_t
 
rc
;

2781 
ngx_h‰p_v¬ŸbË_t
 *
v¬
, *
v
;

2782 
ngx_h‰p_ssi_commªd_t
 *
cmd
;

2783 
ngx_h‰p_ssi_maš_cÚf_t
 *
smcf
;

2785 
v
 = 
ngx_h‰p_ssi_v¬s
; v->
Çme
.
Ën
; v++) {

2786 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

2787 ià(
v¬
 =ð
NULL
) {

2788  
NGX_ERROR
;

2791 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

2792 
v¬
->
d©a
 = 
v
->data;

2795 
smcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_ssi_fž‹r_moduË
);

2797 
cmd
 = 
ngx_h‰p_ssi_commªds
; cmd->
Çme
.
Ën
; cmd++) {

2798 
rc
 = 
	`ngx_hash_add_key
(&
smcf
->
commªds
, &
cmd
->
Çme
, cmd,

2799 
NGX_HASH_READONLY_KEY
);

2801 ià(
rc
 =ð
NGX_OK
) {

2805 ià(
rc
 =ð
NGX_BUSY
) {

2806 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2807 "cÚæiùšg SSI commªd \"%V\"", &
cmd
->
Çme
);

2810  
NGX_ERROR
;

2813  
NGX_OK
;

2814 
	}
}

2818 
	$ngx_h‰p_ssi_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

2820 
ngx_h‰p_ssi_maš_cÚf_t
 *
smcf
;

2822 
smcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_ssi_maš_cÚf_t
));

2823 ià(
smcf
 =ð
NULL
) {

2824  
NULL
;

2827 
smcf
->
commªds
.
poÞ
 = 
cf
->pool;

2828 
smcf
->
commªds
.
‹mp_poÞ
 = 
cf
->temp_pool;

2830 ià(
	`ngx_hash_keys_¬¿y_š™
(&
smcf
->
commªds
, 
NGX_HASH_SMALL
è!ð
NGX_OK
) {

2831  
NULL
;

2834  
smcf
;

2835 
	}
}

2839 
	$ngx_h‰p_ssi_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
)

2841 
ngx_h‰p_ssi_maš_cÚf_t
 *
smcf
 = 
cÚf
;

2843 
ngx_hash_š™_t
 
hash
;

2845 
hash
.hash = &
smcf
->hash;

2846 
hash
.
key
 = 
ngx_hash_key
;

2847 
hash
.
max_size
 = 1024;

2848 
hash
.
buck‘_size
 = 
ngx_ÿch–še_size
;

2849 
hash
.
Çme
 = "ssi_command_hash";

2850 
hash
.
poÞ
 = 
cf
->pool;

2851 
hash
.
‹mp_poÞ
 = 
NULL
;

2853 ià(
	`ngx_hash_š™
(&
hash
, 
smcf
->
commªds
.
keys
.
–ts
,

2854 
smcf
->
commªds
.
keys
.
ÃÉs
)

2855 !ð
NGX_OK
)

2857  
NGX_CONF_ERROR
;

2860  
NGX_CONF_OK
;

2861 
	}
}

2865 
	$ngx_h‰p_ssi_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

2867 
ngx_h‰p_ssi_loc_cÚf_t
 *
¦cf
;

2869 
¦cf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_ssi_loc_cÚf_t
));

2870 ià(
¦cf
 =ð
NULL
) {

2871  
NULL
;

2881 
¦cf
->
’abË
 = 
NGX_CONF_UNSET
;

2882 
¦cf
->
sž’t_”rÜs
 = 
NGX_CONF_UNSET
;

2883 
¦cf
->
ignÜe_»cyþed_bufãrs
 = 
NGX_CONF_UNSET
;

2884 
¦cf
->
Ï¡_modif›d
 = 
NGX_CONF_UNSET
;

2886 
¦cf
->
mš_fže_chunk
 = 
NGX_CONF_UNSET_SIZE
;

2887 
¦cf
->
v®ue_Ën
 = 
NGX_CONF_UNSET_SIZE
;

2889  
¦cf
;

2890 
	}
}

2894 
	$ngx_h‰p_ssi_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

2896 
ngx_h‰p_ssi_loc_cÚf_t
 *
´ev
 = 
·»Á
;

2897 
ngx_h‰p_ssi_loc_cÚf_t
 *
cÚf
 = 
chžd
;

2899 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

2900 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
sž’t_”rÜs
, 
´ev
->silent_errors, 0);

2901 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
ignÜe_»cyþed_bufãrs
,

2902 
´ev
->
ignÜe_»cyþed_bufãrs
, 0);

2903 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
Ï¡_modif›d
, 
´ev
->last_modified, 0);

2905 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
mš_fže_chunk
, 
´ev
->min_file_chunk, 1024);

2906 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
v®ue_Ën
, 
´ev
->value_len, 255);

2908 ià(
	`ngx_h‰p_m”ge_ty³s
(
cf
, &
cÚf
->
ty³s_keys
, &cÚf->
ty³s
,

2909 &
´ev
->
ty³s_keys
, &´ev->
ty³s
,

2910 
ngx_h‰p_html_deçuÉ_ty³s
)

2911 !ð
NGX_OK
)

2913  
NGX_CONF_ERROR
;

2916  
NGX_CONF_OK
;

2917 
	}
}

2920 
ngx_št_t


2921 
	$ngx_h‰p_ssi_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

2923 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

2924 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_ssi_h—d”_fž‹r
;

2926 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

2927 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_ssi_body_fž‹r
;

2929  
NGX_OK
;

2930 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_ssl_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
	$ngx_št_t
 (*
	tngx_s¦_v¬ŸbË_hªdËr_±
)(
	tngx_cÚÃùiÚ_t
 *
	tc
,

14 
	tngx_poÞ_t
 *
	tpoÞ
, 
	tngx_¡r_t
 *
	ts
);

17 
	#NGX_DEFAULT_CIPHERS
 "HIGH:!aNULL:!MD5"

	)

18 
	#NGX_DEFAULT_ECDH_CURVE
 "´ime256v1"

	)

20 
	#NGX_HTTP_NPN_ADVERTISE
 "\x08h‰p/1.1"

	)

23 #ifdeà
TLSEXT_TYPE_­¶iÿtiÚ_Ïy”_´ÙocÞ_ÃgÙŸtiÚ


24 
	`ngx_h‰p_s¦_®²_£Ëù
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
,

25 cÚ¡ **
out
, *
ouŽ’
,

26 cÚ¡ *
š
, 
šËn
, *
¬g
);

29 #ifdeà
TLSEXT_TYPE_Ãxt_´Ùo_Ãg


30 
	`ngx_h‰p_s¦_Ån_adv”ti£d
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
,

31 cÚ¡ **
out
, *
ouŽ’
, *
¬g
);

34 
ngx_št_t
 
	`ngx_h‰p_s¦_¡©ic_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

35 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

36 
ngx_št_t
 
	`ngx_h‰p_s¦_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

37 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

39 
ngx_št_t
 
	`ngx_h‰p_s¦_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

40 *
	`ngx_h‰p_s¦_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

41 *
	`ngx_h‰p_s¦_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
,

42 *
·»Á
, *
chžd
);

44 *
	`ngx_h‰p_s¦_’abË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

45 *
cÚf
);

46 *
	`ngx_h‰p_s¦_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

47 *
cÚf
);

48 *
	`ngx_h‰p_s¦_£ssiÚ_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

49 *
cÚf
);

51 
ngx_št_t
 
	`ngx_h‰p_s¦_š™
(
ngx_cÚf_t
 *
cf
);

54 
ngx_cÚf_b™mask_t
 
ngx_h‰p_s¦_´ÙocÞs
[] = {

55 { 
	`ngx_¡ršg
("SSLv2"), 
NGX_SSL_SSLv2
 },

56 { 
	`ngx_¡ršg
("SSLv3"), 
NGX_SSL_SSLv3
 },

57 { 
	`ngx_¡ršg
("TLSv1"), 
NGX_SSL_TLSv1
 },

58 { 
	`ngx_¡ršg
("TLSv1.1"), 
NGX_SSL_TLSv1_1
 },

59 { 
	`ngx_¡ršg
("TLSv1.2"), 
NGX_SSL_TLSv1_2
 },

60 { 
ngx_nuÎ_¡ršg
, 0 }

61 
	}
};

64 
ngx_cÚf_’um_t
 
	gngx_h‰p_s¦_v”ify
[] = {

65 { 
ngx_¡ršg
("off"), 0 },

66 { 
ngx_¡ršg
("on"), 1 },

67 { 
ngx_¡ršg
("optional"), 2 },

68 { 
ngx_¡ršg
("optional_no_ca"), 3 },

69 { 
ngx_nuÎ_¡ršg
, 0 }

73 
ngx_commªd_t
 
	gngx_h‰p_s¦_commªds
[] = {

75 { 
ngx_¡ršg
("ssl"),

76 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

77 
ngx_h‰p_s¦_’abË
,

78 
NGX_HTTP_SRV_CONF_OFFSET
,

79 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
’abË
),

80 
NULL
 },

82 { 
ngx_¡ršg
("ssl_certificate"),

83 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

84 
ngx_cÚf_£t_¡r_¦Ù
,

85 
NGX_HTTP_SRV_CONF_OFFSET
,

86 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
û¹ifiÿ‹
),

87 
NULL
 },

89 { 
ngx_¡ršg
("ssl_certificate_key"),

90 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

91 
ngx_cÚf_£t_¡r_¦Ù
,

92 
NGX_HTTP_SRV_CONF_OFFSET
,

93 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
û¹ifiÿ‹_key
),

94 
NULL
 },

96 { 
ngx_¡ršg
("ssl_password_file"),

97 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

98 
ngx_h‰p_s¦_·sswÜd_fže
,

99 
NGX_HTTP_SRV_CONF_OFFSET
,

101 
NULL
 },

103 { 
ngx_¡ršg
("ssl_dhparam"),

104 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

105 
ngx_cÚf_£t_¡r_¦Ù
,

106 
NGX_HTTP_SRV_CONF_OFFSET
,

107 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
dh·¿m
),

108 
NULL
 },

110 { 
ngx_¡ršg
("ssl_ecdh_curve"),

111 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

112 
ngx_cÚf_£t_¡r_¦Ù
,

113 
NGX_HTTP_SRV_CONF_OFFSET
,

114 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
ecdh_curve
),

115 
NULL
 },

117 { 
ngx_¡ršg
("ssl_protocols"),

118 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_1MORE
,

119 
ngx_cÚf_£t_b™mask_¦Ù
,

120 
NGX_HTTP_SRV_CONF_OFFSET
,

121 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
´ÙocÞs
),

122 &
ngx_h‰p_s¦_´ÙocÞs
 },

124 { 
ngx_¡ršg
("ssl_ciphers"),

125 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

126 
ngx_cÚf_£t_¡r_¦Ù
,

127 
NGX_HTTP_SRV_CONF_OFFSET
,

128 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
ch”s
),

129 
NULL
 },

131 { 
ngx_¡ršg
("ssl_buffer_size"),

132 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

133 
ngx_cÚf_£t_size_¦Ù
,

134 
NGX_HTTP_SRV_CONF_OFFSET
,

135 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
bufãr_size
),

136 
NULL
 },

138 { 
ngx_¡ršg
("ssl_verify_client"),

139 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

140 
ngx_cÚf_£t_’um_¦Ù
,

141 
NGX_HTTP_SRV_CONF_OFFSET
,

142 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
v”ify
),

143 &
ngx_h‰p_s¦_v”ify
 },

145 { 
ngx_¡ršg
("ssl_verify_depth"),

146 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

147 
ngx_cÚf_£t_num_¦Ù
,

148 
NGX_HTTP_SRV_CONF_OFFSET
,

149 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
v”ify_d•th
),

150 
NULL
 },

152 { 
ngx_¡ršg
("ssl_client_certificate"),

153 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

154 
ngx_cÚf_£t_¡r_¦Ù
,

155 
NGX_HTTP_SRV_CONF_OFFSET
,

156 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
þ›Á_û¹ifiÿ‹
),

157 
NULL
 },

159 { 
ngx_¡ršg
("ssl_trusted_certificate"),

160 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

161 
ngx_cÚf_£t_¡r_¦Ù
,

162 
NGX_HTTP_SRV_CONF_OFFSET
,

163 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
Œu¡ed_û¹ifiÿ‹
),

164 
NULL
 },

166 { 
ngx_¡ršg
("ssl_prefer_server_ciphers"),

167 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

168 
ngx_cÚf_£t_æag_¦Ù
,

169 
NGX_HTTP_SRV_CONF_OFFSET
,

170 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
´eãr_£rv”_ch”s
),

171 
NULL
 },

173 { 
ngx_¡ršg
("ssl_session_cache"),

174 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE12
,

175 
ngx_h‰p_s¦_£ssiÚ_ÿche
,

176 
NGX_HTTP_SRV_CONF_OFFSET
,

178 
NULL
 },

180 { 
ngx_¡ršg
("ssl_session_tickets"),

181 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

182 
ngx_cÚf_£t_æag_¦Ù
,

183 
NGX_HTTP_SRV_CONF_OFFSET
,

184 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
£ssiÚ_tick‘s
),

185 
NULL
 },

187 { 
ngx_¡ršg
("ssl_session_ticket_key"),

188 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

189 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

190 
NGX_HTTP_SRV_CONF_OFFSET
,

191 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
£ssiÚ_tick‘_keys
),

192 
NULL
 },

194 { 
ngx_¡ršg
("ssl_session_timeout"),

195 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

196 
ngx_cÚf_£t_£c_¦Ù
,

197 
NGX_HTTP_SRV_CONF_OFFSET
,

198 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
£ssiÚ_timeout
),

199 
NULL
 },

201 { 
ngx_¡ršg
("ssl_crl"),

202 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

203 
ngx_cÚf_£t_¡r_¦Ù
,

204 
NGX_HTTP_SRV_CONF_OFFSET
,

205 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
ül
),

206 
NULL
 },

208 { 
ngx_¡ršg
("ssl_stapling"),

209 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

210 
ngx_cÚf_£t_æag_¦Ù
,

211 
NGX_HTTP_SRV_CONF_OFFSET
,

212 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
¡­lšg
),

213 
NULL
 },

215 { 
ngx_¡ršg
("ssl_stapling_file"),

216 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

217 
ngx_cÚf_£t_¡r_¦Ù
,

218 
NGX_HTTP_SRV_CONF_OFFSET
,

219 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
¡­lšg_fže
),

220 
NULL
 },

222 { 
ngx_¡ršg
("ssl_stapling_responder"),

223 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

224 
ngx_cÚf_£t_¡r_¦Ù
,

225 
NGX_HTTP_SRV_CONF_OFFSET
,

226 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
¡­lšg_»¥Úd”
),

227 
NULL
 },

229 { 
ngx_¡ršg
("ssl_stapling_verify"),

230 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

231 
ngx_cÚf_£t_æag_¦Ù
,

232 
NGX_HTTP_SRV_CONF_OFFSET
,

233 
off£tof
(
ngx_h‰p_s¦_¤v_cÚf_t
, 
¡­lšg_v”ify
),

234 
NULL
 },

236 
ngx_nuÎ_commªd


240 
ngx_h‰p_moduË_t
 
	gngx_h‰p_s¦_moduË_ùx
 = {

241 
ngx_h‰p_s¦_add_v¬ŸbËs
,

242 
ngx_h‰p_s¦_š™
,

244 
NULL
,

245 
NULL
,

247 
ngx_h‰p_s¦_ü—‹_¤v_cÚf
,

248 
ngx_h‰p_s¦_m”ge_¤v_cÚf
,

250 
NULL
,

251 
NULL


255 
ngx_moduË_t
 
	gngx_h‰p_s¦_moduË
 = {

256 
NGX_MODULE_V1
,

257 &
ngx_h‰p_s¦_moduË_ùx
,

258 
ngx_h‰p_s¦_commªds
,

259 
NGX_HTTP_MODULE
,

260 
NULL
,

261 
NULL
,

262 
NULL
,

263 
NULL
,

264 
NULL
,

265 
NULL
,

266 
NULL
,

267 
NGX_MODULE_V1_PADDING


271 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_s¦_v¬s
[] = {

273 { 
ngx_¡ršg
("s¦_´ÙocÞ"), 
NULL
, 
ngx_h‰p_s¦_¡©ic_v¬ŸbË
,

274 (
ušŒ_t
è
ngx_s¦_g‘_´ÙocÞ
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

276 { 
ngx_¡ršg
("s¦_ch”"), 
NULL
, 
ngx_h‰p_s¦_¡©ic_v¬ŸbË
,

277 (
ušŒ_t
è
ngx_s¦_g‘_ch”_Çme
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

279 { 
ngx_¡ršg
("s¦_£ssiÚ_id"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

280 (
ušŒ_t
è
ngx_s¦_g‘_£ssiÚ_id
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

282 { 
ngx_¡ršg
("s¦_£ssiÚ_»u£d"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

283 (
ušŒ_t
è
ngx_s¦_g‘_£ssiÚ_»u£d
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

285 { 
ngx_¡ršg
("s¦_£rv”_Çme"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

286 (
ušŒ_t
è
ngx_s¦_g‘_£rv”_Çme
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

288 { 
ngx_¡ršg
("s¦_þ›Á_û¹"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

289 (
ušŒ_t
è
ngx_s¦_g‘_û¹ifiÿ‹
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

291 { 
ngx_¡ršg
("s¦_þ›Á_¿w_û¹"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

292 (
ušŒ_t
è
ngx_s¦_g‘_¿w_û¹ifiÿ‹
,

293 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

295 { 
ngx_¡ršg
("s¦_þ›Á_s_dn"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

296 (
ušŒ_t
è
ngx_s¦_g‘_subjeù_dn
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

298 { 
ngx_¡ršg
("s¦_þ›Á_i_dn"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

299 (
ušŒ_t
è
ngx_s¦_g‘_issu”_dn
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

301 { 
ngx_¡ršg
("s¦_þ›Á_£rŸl"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

302 (
ušŒ_t
è
ngx_s¦_g‘_£rŸl_numb”
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

304 { 
ngx_¡ršg
("s¦_þ›Á_fšg”´št"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

305 (
ušŒ_t
è
ngx_s¦_g‘_fšg”´št
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

307 { 
ngx_¡ršg
("s¦_þ›Á_v”ify"), 
NULL
, 
ngx_h‰p_s¦_v¬ŸbË
,

308 (
ušŒ_t
è
ngx_s¦_g‘_þ›Á_v”ify
, 
NGX_HTTP_VAR_CHANGEABLE
, 0 },

310 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

314 
ngx_¡r_t
 
	gngx_h‰p_s¦_£ss_id_ùx
 = 
ngx_¡ršg
("HTTP");

317 #ifdeà
TLSEXT_TYPE_­¶iÿtiÚ_Ïy”_´ÙocÞ_ÃgÙŸtiÚ


320 
	$ngx_h‰p_s¦_®²_£Ëù
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
, cÚ¡ **
out
,

321 *
ouŽ’
, cÚ¡ *
š
, 
šËn
,

322 *
¬g
)

324 
¤vËn
;

325 *
¤v
;

326 #ià(
NGX_DEBUG
)

327 
i
;

329 #ià(
NGX_HTTP_SPDY
)

330 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

332 #ià(
NGX_HTTP_SPDY
 || 
NGX_DEBUG
)

333 
ngx_cÚÃùiÚ_t
 *
c
;

335 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
(
s¦_cÚn
);

338 #ià(
NGX_DEBUG
)

339 
i
 = 0; i < 
šËn
; i +ð
š
[i] + 1) {

340 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

341 "SSL ALPN suµÜ‹d by cl›Á: %*s", 
š
[
i
], &in[i + 1]);

345 #ià(
NGX_HTTP_SPDY
)

346 
hc
 = 
c
->
d©a
;

348 ià(
hc
->
addr_cÚf
->
¥dy
) {

349 
¤v
 = (*è
NGX_SPDY_NPN_ADVERTISE
 
NGX_HTTP_NPN_ADVERTISE
;

350 
¤vËn
 = (
NGX_SPDY_NPN_ADVERTISE
 
NGX_HTTP_NPN_ADVERTISE
) - 1;

355 
¤v
 = (*è
NGX_HTTP_NPN_ADVERTISE
;

356 
¤vËn
 = (
NGX_HTTP_NPN_ADVERTISE
) - 1;

359 ià(
	`SSL_£Ëù_Ãxt_´Ùo
((**è
out
, 
ouŽ’
, 
¤v
, 
¤vËn
,

360 
š
, 
šËn
)

361 !ð
OPENSSL_NPN_NEGOTIATED
)

363  
SSL_TLSEXT_ERR_NOACK
;

366 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

367 "SSL ALPN s–eùed: %*s", *
ouŽ’
, *
out
);

369  
SSL_TLSEXT_ERR_OK
;

370 
	}
}

375 #ifdeà
TLSEXT_TYPE_Ãxt_´Ùo_Ãg


378 
	$ngx_h‰p_s¦_Ån_adv”ti£d
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
,

379 cÚ¡ **
out
, *
ouŽ’
, *
¬g
)

381 #ià(
NGX_HTTP_SPDY
 || 
NGX_DEBUG
)

382 
ngx_cÚÃùiÚ_t
 *
c
;

384 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
(
s¦_cÚn
);

385 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "SSL NPN‡dvertised");

388 #ià(
NGX_HTTP_SPDY
)

390 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

392 
hc
 = 
c
->
d©a
;

394 ià(
hc
->
addr_cÚf
->
¥dy
) {

395 *
out
 = (*è
NGX_SPDY_NPN_ADVERTISE
 
NGX_HTTP_NPN_ADVERTISE
;

396 *
ouŽ’
 = (
NGX_SPDY_NPN_ADVERTISE
 
NGX_HTTP_NPN_ADVERTISE
) - 1;

398  
SSL_TLSEXT_ERR_OK
;

403 *
out
 = (*è
NGX_HTTP_NPN_ADVERTISE
;

404 *
ouŽ’
 = (
NGX_HTTP_NPN_ADVERTISE
) - 1;

406  
SSL_TLSEXT_ERR_OK
;

407 
	}
}

412 
ngx_št_t


413 
	$ngx_h‰p_s¦_¡©ic_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

414 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

416 
ngx_s¦_v¬ŸbË_hªdËr_±
 
hªdËr
 = (ngx_s¦_v¬ŸbË_hªdËr_±è
d©a
;

418 
size_t
 
Ën
;

419 
ngx_¡r_t
 
s
;

421 ià(
r
->
cÚÃùiÚ
->
s¦
) {

423 (è
	`hªdËr
(
r
->
cÚÃùiÚ
, 
NULL
, &
s
);

425 
v
->
d©a
 = 
s
.data;

427 
Ën
 = 0; 
v
->
d©a
[len];†en++) { }

429 
v
->
Ën
 =†en;

430 
v
->
v®id
 = 1;

431 
v
->
no_ÿch—bË
 = 0;

432 
v
->
nÙ_found
 = 0;

434  
NGX_OK
;

437 
v
->
nÙ_found
 = 1;

439  
NGX_OK
;

440 
	}
}

443 
ngx_št_t


444 
	$ngx_h‰p_s¦_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

445 
ušŒ_t
 
d©a
)

447 
ngx_s¦_v¬ŸbË_hªdËr_±
 
hªdËr
 = (ngx_s¦_v¬ŸbË_hªdËr_±è
d©a
;

449 
ngx_¡r_t
 
s
;

451 ià(
r
->
cÚÃùiÚ
->
s¦
) {

453 ià(
	`hªdËr
(
r
->
cÚÃùiÚ
,„->
poÞ
, &
s
è!ð
NGX_OK
) {

454  
NGX_ERROR
;

457 
v
->
Ën
 = 
s
.len;

458 
v
->
d©a
 = 
s
.data;

460 ià(
v
->
Ën
) {

461 
v
->
v®id
 = 1;

462 
v
->
no_ÿch—bË
 = 0;

463 
v
->
nÙ_found
 = 0;

465  
NGX_OK
;

469 
v
->
nÙ_found
 = 1;

471  
NGX_OK
;

472 
	}
}

475 
ngx_št_t


476 
	$ngx_h‰p_s¦_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

478 
ngx_h‰p_v¬ŸbË_t
 *
v¬
, *
v
;

480 
v
 = 
ngx_h‰p_s¦_v¬s
; v->
Çme
.
Ën
; v++) {

481 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

482 ià(
v¬
 =ð
NULL
) {

483  
NGX_ERROR
;

486 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

487 
v¬
->
d©a
 = 
v
->data;

490  
NGX_OK
;

491 
	}
}

495 
	$ngx_h‰p_s¦_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

497 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
;

499 
sscf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_s¦_¤v_cÚf_t
));

500 ià(
sscf
 =ð
NULL
) {

501  
NULL
;

521 
sscf
->
’abË
 = 
NGX_CONF_UNSET
;

522 
sscf
->
´eãr_£rv”_ch”s
 = 
NGX_CONF_UNSET
;

523 
sscf
->
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

524 
sscf
->
v”ify
 = 
NGX_CONF_UNSET_UINT
;

525 
sscf
->
v”ify_d•th
 = 
NGX_CONF_UNSET_UINT
;

526 
sscf
->
·sswÜds
 = 
NGX_CONF_UNSET_PTR
;

527 
sscf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_CONF_UNSET
;

528 
sscf
->
£ssiÚ_timeout
 = 
NGX_CONF_UNSET
;

529 
sscf
->
£ssiÚ_tick‘s
 = 
NGX_CONF_UNSET
;

530 
sscf
->
£ssiÚ_tick‘_keys
 = 
NGX_CONF_UNSET_PTR
;

531 
sscf
->
¡­lšg
 = 
NGX_CONF_UNSET
;

532 
sscf
->
¡­lšg_v”ify
 = 
NGX_CONF_UNSET
;

534  
sscf
;

535 
	}
}

539 
	$ngx_h‰p_s¦_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

541 
ngx_h‰p_s¦_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

542 
ngx_h‰p_s¦_¤v_cÚf_t
 *
cÚf
 = 
chžd
;

544 
ngx_poÞ_þ—nup_t
 *
þn
;

546 ià(
cÚf
->
’abË
 =ð
NGX_CONF_UNSET
) {

547 ià(
´ev
->
’abË
 =ð
NGX_CONF_UNSET
) {

548 
cÚf
->
’abË
 = 0;

551 
cÚf
->
’abË
 = 
´ev
->enable;

552 
cÚf
->
fže
 = 
´ev
->file;

553 
cÚf
->
lše
 = 
´ev
->line;

557 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£ssiÚ_timeout
,

558 
´ev
->
£ssiÚ_timeout
, 300);

560 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
´eãr_£rv”_ch”s
,

561 
´ev
->
´eãr_£rv”_ch”s
, 0);

563 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
´ÙocÞs
, 
´ev
->protocols,

564 (
NGX_CONF_BITMASK_SET
|
NGX_SSL_SSLv3
|
NGX_SSL_TLSv1


565 |
NGX_SSL_TLSv1_1
|
NGX_SSL_TLSv1_2
));

567 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
bufãr_size
, 
´ev
->buffer_size,

568 
NGX_SSL_BUFSIZE
);

570 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
v”ify
, 
´ev
->verify, 0);

571 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
v”ify_d•th
, 
´ev
->verify_depth, 1);

573 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
û¹ifiÿ‹
, 
´ev
->certificate, "");

574 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
û¹ifiÿ‹_key
, 
´ev
->certificate_key, "");

576 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
·sswÜds
, 
´ev
->·sswÜds, 
NULL
);

578 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
dh·¿m
, 
´ev
->dhparam, "");

580 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
þ›Á_û¹ifiÿ‹
, 
´ev
->client_certificate,

582 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
Œu¡ed_û¹ifiÿ‹
,

583 
´ev
->
Œu¡ed_û¹ifiÿ‹
, "");

584 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
ül
, 
´ev
->crl, "");

586 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
ecdh_curve
, 
´ev
->ecdh_curve,

587 
NGX_DEFAULT_ECDH_CURVE
);

589 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
ch”s
, 
´ev
->ch”s, 
NGX_DEFAULT_CIPHERS
);

591 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
¡­lšg
, 
´ev
->stapling, 0);

592 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
¡­lšg_v”ify
, 
´ev
->stapling_verify, 0);

593 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
¡­lšg_fže
, 
´ev
->stapling_file, "");

594 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
¡­lšg_»¥Úd”
,

595 
´ev
->
¡­lšg_»¥Úd”
, "");

597 
cÚf
->
s¦
.
log
 = 
cf
->log;

599 ià(
cÚf
->
’abË
) {

601 ià(
cÚf
->
û¹ifiÿ‹
.
Ën
 == 0) {

602 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

605 
cÚf
->
fže
, cÚf->
lše
);

606  
NGX_CONF_ERROR
;

609 ià(
cÚf
->
û¹ifiÿ‹_key
.
Ën
 == 0) {

610 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

613 
cÚf
->
fže
, cÚf->
lše
);

614  
NGX_CONF_ERROR
;

619 ià(
cÚf
->
û¹ifiÿ‹
.
Ën
 == 0) {

620  
NGX_CONF_OK
;

623 ià(
cÚf
->
û¹ifiÿ‹_key
.
Ën
 == 0) {

624 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

626 "fÜ c”tifiÿ‹ \"%V\"", &
cÚf
->
û¹ifiÿ‹
);

627  
NGX_CONF_ERROR
;

631 ià(
	`ngx_s¦_ü—‹
(&
cÚf
->
s¦
, cÚf->
´ÙocÞs
, cÚfè!ð
NGX_OK
) {

632  
NGX_CONF_ERROR
;

635 #ifdeà
SSL_CTRL_SET_TLSEXT_HOSTNAME


637 ià(
	`SSL_CTX_£t_Ž£xt_£rv”Çme_ÿÎback
(
cÚf
->
s¦
.
ùx
,

638 
ngx_h‰p_s¦_£rv”Çme
)

641 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
cf
->
log
, 0,

649 #ifdeà
TLSEXT_TYPE_­¶iÿtiÚ_Ïy”_´ÙocÞ_ÃgÙŸtiÚ


650 
	`SSL_CTX_£t_®²_£Ëù_cb
(
cÚf
->
s¦
.
ùx
, 
ngx_h‰p_s¦_®²_£Ëù
, 
NULL
);

653 #ifdeà
TLSEXT_TYPE_Ãxt_´Ùo_Ãg


654 
	`SSL_CTX_£t_Ãxt_´Ùos_adv”ti£d_cb
(
cÚf
->
s¦
.
ùx
,

655 
ngx_h‰p_s¦_Ån_adv”ti£d
, 
NULL
);

658 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

659 ià(
þn
 =ð
NULL
) {

660  
NGX_CONF_ERROR
;

663 
þn
->
hªdËr
 = 
ngx_s¦_þ—nup_ùx
;

664 
þn
->
d©a
 = &
cÚf
->
s¦
;

666 ià(
	`ngx_s¦_û¹ifiÿ‹
(
cf
, &
cÚf
->
s¦
, &cÚf->
û¹ifiÿ‹
,

667 &
cÚf
->
û¹ifiÿ‹_key
, cÚf->
·sswÜds
)

668 !ð
NGX_OK
)

670  
NGX_CONF_ERROR
;

673 ià(
	`SSL_CTX_£t_ch”_li¡
(
cÚf
->
s¦
.
ùx
,

674 (cÚ¡ *è
cÚf
->
ch”s
.
d©a
)

677 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

679 &
cÚf
->
ch”s
);

680  
NGX_CONF_ERROR
;

683 
cÚf
->
s¦
.
bufãr_size
 = conf->buffer_size;

685 ià(
cÚf
->
v”ify
) {

687 ià(
cÚf
->
þ›Á_û¹ifiÿ‹
.
Ën
 =ð0 && cÚf->
v”ify
 != 3) {

688 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

690  
NGX_CONF_ERROR
;

693 ià(
	`ngx_s¦_þ›Á_û¹ifiÿ‹
(
cf
, &
cÚf
->
s¦
,

694 &
cÚf
->
þ›Á_û¹ifiÿ‹
,

695 
cÚf
->
v”ify_d•th
)

696 !ð
NGX_OK
)

698  
NGX_CONF_ERROR
;

702 ià(
	`ngx_s¦_Œu¡ed_û¹ifiÿ‹
(
cf
, &
cÚf
->
s¦
,

703 &
cÚf
->
Œu¡ed_û¹ifiÿ‹
,

704 
cÚf
->
v”ify_d•th
)

705 !ð
NGX_OK
)

707  
NGX_CONF_ERROR
;

710 ià(
	`ngx_s¦_ül
(
cf
, &
cÚf
->
s¦
, &cÚf->
ül
è!ð
NGX_OK
) {

711  
NGX_CONF_ERROR
;

714 ià(
cÚf
->
´eãr_£rv”_ch”s
) {

715 
	`SSL_CTX_£t_ÝtiÚs
(
cÚf
->
s¦
.
ùx
, 
SSL_OP_CIPHER_SERVER_PREFERENCE
);

719 
	`SSL_CTX_£t_tmp_r§_ÿÎback
(
cÚf
->
s¦
.
ùx
, 
ngx_s¦_r§512_key_ÿÎback
);

721 ià(
	`ngx_s¦_dh·¿m
(
cf
, &
cÚf
->
s¦
, &cÚf->
dh·¿m
è!ð
NGX_OK
) {

722  
NGX_CONF_ERROR
;

725 ià(
	`ngx_s¦_ecdh_curve
(
cf
, &
cÚf
->
s¦
, &cÚf->
ecdh_curve
è!ð
NGX_OK
) {

726  
NGX_CONF_ERROR
;

729 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
bužtš_£ssiÚ_ÿche
,

730 
´ev
->
bužtš_£ssiÚ_ÿche
, 
NGX_SSL_NONE_SCACHE
);

732 ià(
cÚf
->
shm_zÚe
 =ð
NULL
) {

733 
cÚf
->
shm_zÚe
 = 
´ev
->shm_zone;

736 ià(
	`ngx_s¦_£ssiÚ_ÿche
(&
cÚf
->
s¦
, &
ngx_h‰p_s¦_£ss_id_ùx
,

737 
cÚf
->
bužtš_£ssiÚ_ÿche
,

738 
cÚf
->
shm_zÚe
, cÚf->
£ssiÚ_timeout
)

739 !ð
NGX_OK
)

741  
NGX_CONF_ERROR
;

744 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£ssiÚ_tick‘s
, 
´ev
->session_tickets, 1);

746 #ifdeà
SSL_OP_NO_TICKET


747 ià(!
cÚf
->
£ssiÚ_tick‘s
) {

748 
	`SSL_CTX_£t_ÝtiÚs
(
cÚf
->
s¦
.
ùx
, 
SSL_OP_NO_TICKET
);

752 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
£ssiÚ_tick‘_keys
,

753 
´ev
->
£ssiÚ_tick‘_keys
, 
NULL
);

755 ià(
	`ngx_s¦_£ssiÚ_tick‘_keys
(
cf
, &
cÚf
->
s¦
, cÚf->
£ssiÚ_tick‘_keys
)

756 !ð
NGX_OK
)

758  
NGX_CONF_ERROR
;

761 ià(
cÚf
->
¡­lšg
) {

763 ià(
	`ngx_s¦_¡­lšg
(
cf
, &
cÚf
->
s¦
, &cÚf->
¡­lšg_fže
,

764 &
cÚf
->
¡­lšg_»¥Úd”
, cÚf->
¡­lšg_v”ify
)

765 !ð
NGX_OK
)

767  
NGX_CONF_ERROR
;

772  
NGX_CONF_OK
;

773 
	}
}

777 
	$ngx_h‰p_s¦_’abË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

779 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
 = 
cÚf
;

781 *
rv
;

783 
rv
 = 
	`ngx_cÚf_£t_æag_¦Ù
(
cf
, 
cmd
, 
cÚf
);

785 ià(
rv
 !ð
NGX_CONF_OK
) {

786  
rv
;

789 
sscf
->
fže
 = 
cf
->
cÚf_fže
->fže.
Çme
.
d©a
;

790 
sscf
->
lše
 = 
cf
->
cÚf_fže
->line;

792  
NGX_CONF_OK
;

793 
	}
}

797 
	$ngx_h‰p_s¦_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

799 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
 = 
cÚf
;

801 
ngx_¡r_t
 *
v®ue
;

803 ià(
sscf
->
·sswÜds
 !ð
NGX_CONF_UNSET_PTR
) {

807 
v®ue
 = 
cf
->
¬gs
->
–ts
;

809 
sscf
->
·sswÜds
 = 
	`ngx_s¦_»ad_·sswÜd_fže
(
cf
, &
v®ue
[1]);

811 ià(
sscf
->
·sswÜds
 =ð
NULL
) {

812  
NGX_CONF_ERROR
;

815  
NGX_CONF_OK
;

816 
	}
}

820 
	$ngx_h‰p_s¦_£ssiÚ_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

822 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
 = 
cÚf
;

824 
size_t
 
Ën
;

825 
ngx_¡r_t
 *
v®ue
, 
Çme
, 
size
;

826 
ngx_št_t
 
n
;

827 
ngx_ušt_t
 
i
, 
j
;

829 
v®ue
 = 
cf
->
¬gs
->
–ts
;

831 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

833 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "off") == 0) {

834 
sscf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_SSL_NO_SCACHE
;

838 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "none") == 0) {

839 
sscf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_SSL_NONE_SCACHE
;

843 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "builtin") == 0) {

844 
sscf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_SSL_DFLT_BUILTIN_SCACHE
;

848 ià(
v®ue
[
i
].
Ën
 > ("builtin:") - 1

849 && 
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "builtin:", ("builtin:") - 1)

852 
n
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + ("builtin:") - 1,

853 
v®ue
[
i
].
Ën
 - (("builtin:") - 1));

855 ià(
n
 =ð
NGX_ERROR
) {

856 
šv®id
;

859 
sscf
->
bužtš_£ssiÚ_ÿche
 = 
n
;

864 ià(
v®ue
[
i
].
Ën
 > ("shared:") - 1

865 && 
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "shared:", ("shared:") - 1)

868 
Ën
 = 0;

870 
j
 = ("sh¬ed:"è- 1; j < 
v®ue
[
i
].
Ën
; j++) {

871 ià(
v®ue
[
i
].
d©a
[
j
] == ':') {

875 
Ën
++;

878 ià(
Ën
 == 0) {

879 
šv®id
;

882 
Çme
.
Ën
 =†en;

883 
Çme
.
d©a
 = 
v®ue
[
i
].data + ("shared:") - 1;

885 
size
.
Ën
 = 
v®ue
[
i
].ËÀ- 
j
 - 1;

886 
size
.
d©a
 = 
Çme
.d©¨+ 
Ën
 + 1;

888 
n
 = 
	`ngx_·r£_size
(&
size
);

890 ià(
n
 =ð
NGX_ERROR
) {

891 
šv®id
;

894 ià(
n
 < (
ngx_št_t
è(8 * 
ngx_·gesize
)) {

895 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

897 &
v®ue
[
i
]);

899  
NGX_CONF_ERROR
;

902 
sscf
->
shm_zÚe
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
Çme
, 
n
,

903 &
ngx_h‰p_s¦_moduË
);

904 ià(
sscf
->
shm_zÚe
 =ð
NULL
) {

905  
NGX_CONF_ERROR
;

908 
sscf
->
shm_zÚe
->
š™
 = 
ngx_s¦_£ssiÚ_ÿche_š™
;

913 
šv®id
;

916 ià(
sscf
->
shm_zÚe
 && sscf->
bužtš_£ssiÚ_ÿche
 =ð
NGX_CONF_UNSET
) {

917 
sscf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_SSL_NO_BUILTIN_SCACHE
;

920  
NGX_CONF_OK
;

922 
šv®id
:

924 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

925 "šv®id sessiÚ cach\"%V\"", &
v®ue
[
i
]);

927  
NGX_CONF_ERROR
;

928 
	}
}

931 
ngx_št_t


932 
	$ngx_h‰p_s¦_š™
(
ngx_cÚf_t
 *
cf
)

934 
ngx_ušt_t
 
s
;

935 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
;

936 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

937 
ngx_h‰p_cÜe_¤v_cÚf_t
 **
cscå
;

938 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

940 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

941 
cscå
 = 
cmcf
->
£rv”s
.
–ts
;

943 
s
 = 0; s < 
cmcf
->
£rv”s
.
ÃÉs
; s++) {

945 
sscf
 = 
cscå
[
s
]->
ùx
->
¤v_cÚf
[
ngx_h‰p_s¦_moduË
.
ùx_šdex
];

947 ià(
sscf
->
s¦
.
ùx
 =ð
NULL
 || !sscf->
¡­lšg
) {

951 
þcf
 = 
cscå
[
s
]->
ùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

953 ià(
	`ngx_s¦_¡­lšg_»sÞv”
(
cf
, &
sscf
->
s¦
, 
þcf
->
»sÞv”
,

954 
þcf
->
»sÞv”_timeout
)

955 !ð
NGX_OK
)

957  
NGX_ERROR
;

961  
NGX_OK
;

962 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_static_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_št_t
 
ngx_h‰p_¡©ic_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

14 
ngx_št_t
 
ngx_h‰p_¡©ic_š™
(
ngx_cÚf_t
 *
cf
);

17 
ngx_h‰p_moduË_t
 
	gngx_h‰p_¡©ic_moduË_ùx
 = {

18 
NULL
,

19 
ngx_h‰p_¡©ic_š™
,

21 
NULL
,

22 
NULL
,

24 
NULL
,

25 
NULL
,

27 
NULL
,

28 
NULL


32 
ngx_moduË_t
 
	gngx_h‰p_¡©ic_moduË
 = {

33 
NGX_MODULE_V1
,

34 &
ngx_h‰p_¡©ic_moduË_ùx
,

35 
NULL
,

36 
NGX_HTTP_MODULE
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NGX_MODULE_V1_PADDING


48 
ngx_št_t


49 
	$ngx_h‰p_¡©ic_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

51 
u_ch¬
 *
Ï¡
, *
loÿtiÚ
;

52 
size_t
 
roÙ
, 
Ën
;

53 
ngx_¡r_t
 
·th
;

54 
ngx_št_t
 
rc
;

55 
ngx_ušt_t
 
Ëv–
;

56 
ngx_log_t
 *
log
;

57 
ngx_buf_t
 *
b
;

58 
ngx_chaš_t
 
out
;

59 
ngx_Ý’_fže_šfo_t
 
of
;

60 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

62 ià(!(
r
->
m‘hod
 & (
NGX_HTTP_GET
|
NGX_HTTP_HEAD
|
NGX_HTTP_POST
))) {

63  
NGX_HTTP_NOT_ALLOWED
;

66 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] == '/') {

67  
NGX_DECLINED
;

70 
log
 = 
r
->
cÚÃùiÚ
->log;

77 
Ï¡
 = 
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0);

78 ià(
Ï¡
 =ð
NULL
) {

79  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

82 
·th
.
Ën
 = 
Ï¡
 -…©h.
d©a
;

84 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0,

85 "h‰°fž’ame: \"%s\"", 
·th
.
d©a
);

87 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

89 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

91 
of
.
»ad_ah—d
 = 
þcf
->read_ahead;

92 
of
.
dœeùio
 = 
þcf
->directio;

93 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

94 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

95 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

96 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

98 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
·th
, &
of
è!ð
NGX_OK
) {

99  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

102 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
·th
, &
of
, 
r
->
poÞ
)

103 !ð
NGX_OK
)

105 
of
.
”r
) {

108  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

110 
NGX_ENOENT
:

111 
NGX_ENOTDIR
:

112 
NGX_ENAMETOOLONG
:

114 
Ëv–
 = 
NGX_LOG_ERR
;

115 
rc
 = 
NGX_HTTP_NOT_FOUND
;

118 
NGX_EACCES
:

119 #ià(
NGX_HAVE_OPENAT
)

120 
NGX_EMLINK
:

121 
NGX_ELOOP
:

124 
Ëv–
 = 
NGX_LOG_ERR
;

125 
rc
 = 
NGX_HTTP_FORBIDDEN
;

130 
Ëv–
 = 
NGX_LOG_CRIT
;

131 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

135 ià(
rc
 !ð
NGX_HTTP_NOT_FOUND
 || 
þcf
->
log_nÙ_found
) {

136 
	`ngx_log_”rÜ
(
Ëv–
, 
log
, 
of
.
”r
,

137 "% \"%s\" fažed", 
of
.
çžed
, 
·th
.
d©a
);

140  
rc
;

143 
r
->
roÙ_‹¡ed
 = !r->
”rÜ_·ge
;

145 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0, "h‰°¡©iøfd: %d", 
of
.
fd
);

147 ià(
of
.
is_dœ
) {

149 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0, "http dir");

151 
	`ngx_h‰p_þ—r_loÿtiÚ
(
r
);

153 
r
->
h—d”s_out
.
loÿtiÚ
 = 
	`ngx_·Îoc
Ô->
poÞ
, (
ngx_bË_–t_t
));

154 ià(
r
->
h—d”s_out
.
loÿtiÚ
 =ð
NULL
) {

155  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

158 
Ën
 = 
r
->
uri
.len + 1;

160 ià(!
þcf
->
®Ÿs
 && clcf->
roÙ_Ëngths
 =ð
NULL
 && 
r
->
¬gs
.
Ën
 == 0) {

161 
loÿtiÚ
 = 
·th
.
d©a
 + 
þcf
->
roÙ
.
Ën
;

163 *
Ï¡
 = '/';

166 ià(
r
->
¬gs
.
Ën
) {

167 
Ën
 +ð
r
->
¬gs
.len + 1;

170 
loÿtiÚ
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

171 ià(
loÿtiÚ
 =ð
NULL
) {

172  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

175 
Ï¡
 = 
	`ngx_cÝy
(
loÿtiÚ
, 
r
->
uri
.
d©a
,„->uri.
Ën
);

177 *
Ï¡
 = '/';

179 ià(
r
->
¬gs
.
Ën
) {

180 *++
Ï¡
 = '?';

181 
	`ngx_memýy
(++
Ï¡
, 
r
->
¬gs
.
d©a
,„->¬gs.
Ën
);

190 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
 =†en;

191 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
 =†ocation;

193  
NGX_HTTP_MOVED_PERMANENTLY
;

196 #ià!(
NGX_WIN32
)

198 ià(!
of
.
is_fže
) {

199 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
log
, 0,

200 "\"%s\" i nÙ‡„eguÏ¸fže", 
·th
.
d©a
);

202  
NGX_HTTP_NOT_FOUND
;

207 ià(
r
->
m‘hod
 & 
NGX_HTTP_POST
) {

208  
NGX_HTTP_NOT_ALLOWED
;

211 
rc
 = 
	`ngx_h‰p_disÿrd_»que¡_body
(
r
);

213 ià(
rc
 !ð
NGX_OK
) {

214  
rc
;

217 
log
->
aùiÚ
 = "sending„esponseo client";

219 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_OK
;

220 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
of
.
size
;

221 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = 
of
.
mtime
;

223 ià(
	`ngx_h‰p_£t_‘ag
(
r
è!ð
NGX_OK
) {

224  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

227 ià(
	`ngx_h‰p_£t_cÚ‹Á_ty³
(
r
è!ð
NGX_OK
) {

228  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

231 ià(
r
 !ðr->
maš
 && 
of
.
size
 == 0) {

232  
	`ngx_h‰p_£nd_h—d”
(
r
);

235 
r
->
®low_¿nges
 = 1;

239 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

240 ià(
b
 =ð
NULL
) {

241  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

244 
b
->
fže
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_fže_t
));

245 ià(
b
->
fže
 =ð
NULL
) {

246  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

249 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

251 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

252  
rc
;

255 
b
->
fže_pos
 = 0;

256 
b
->
fže_Ï¡
 = 
of
.
size
;

258 
b
->
š_fže
 = b->
fže_Ï¡
 ? 1: 0;

259 
b
->
Ï¡_buf
 = (
r
 =ðr->
maš
) ? 1: 0;

260 
b
->
Ï¡_š_chaš
 = 1;

262 
b
->
fže
->
fd
 = 
of
.fd;

263 
b
->
fže
->
Çme
 = 
·th
;

264 
b
->
fže
->
log
 =†og;

265 
b
->
fže
->
dœeùio
 = 
of
.
is_dœeùio
;

267 
out
.
buf
 = 
b
;

268 
out
.
Ãxt
 = 
NULL
;

270  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

271 
	}
}

274 
ngx_št_t


275 
	$ngx_h‰p_¡©ic_š™
(
ngx_cÚf_t
 *
cf
)

277 
ngx_h‰p_hªdËr_±
 *
h
;

278 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

280 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

282 
h
 = 
	`ngx_¬¿y_push
(&
cmcf
->
pha£s
[
NGX_HTTP_CONTENT_PHASE
].
hªdËrs
);

283 ià(
h
 =ð
NULL
) {

284  
NGX_ERROR
;

287 *
h
 = 
ngx_h‰p_¡©ic_hªdËr
;

289  
NGX_OK
;

290 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_stub_status_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_št_t
 
ngx_h‰p_¡ub_¡©us_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

14 
ngx_št_t
 
ngx_h‰p_¡ub_¡©us_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

15 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

16 
ngx_št_t
 
ngx_h‰p_¡ub_¡©us_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

17 *
ngx_h‰p_£t_¡ub_¡©us
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

18 *
cÚf
);

21 
ngx_commªd_t
 
	gngx_h‰p_¡©us_commªds
[] = {

23 { 
ngx_¡ršg
("stub_status"),

24 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_NOARGS
|
NGX_CONF_TAKE1
,

25 
ngx_h‰p_£t_¡ub_¡©us
,

28 
NULL
 },

30 
ngx_nuÎ_commªd


34 
ngx_h‰p_moduË_t
 
	gngx_h‰p_¡ub_¡©us_moduË_ùx
 = {

35 
ngx_h‰p_¡ub_¡©us_add_v¬ŸbËs
,

36 
NULL
,

38 
NULL
,

39 
NULL
,

41 
NULL
,

42 
NULL
,

44 
NULL
,

45 
NULL


49 
ngx_moduË_t
 
	gngx_h‰p_¡ub_¡©us_moduË
 = {

50 
NGX_MODULE_V1
,

51 &
ngx_h‰p_¡ub_¡©us_moduË_ùx
,

52 
ngx_h‰p_¡©us_commªds
,

53 
NGX_HTTP_MODULE
,

54 
NULL
,

55 
NULL
,

56 
NULL
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
NULL
,

61 
NGX_MODULE_V1_PADDING


65 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_¡ub_¡©us_v¬s
[] = {

67 { 
ngx_¡ršg
("cÚÃùiÚs_aùive"), 
NULL
, 
ngx_h‰p_¡ub_¡©us_v¬ŸbË
,

68 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

70 { 
ngx_¡ršg
("cÚÃùiÚs_»adšg"), 
NULL
, 
ngx_h‰p_¡ub_¡©us_v¬ŸbË
,

71 1, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

73 { 
ngx_¡ršg
("cÚÃùiÚs_wr™šg"), 
NULL
, 
ngx_h‰p_¡ub_¡©us_v¬ŸbË
,

74 2, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

76 { 
ngx_¡ršg
("cÚÃùiÚs_wa™šg"), 
NULL
, 
ngx_h‰p_¡ub_¡©us_v¬ŸbË
,

77 3, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

79 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

83 
ngx_št_t


84 
	$ngx_h‰p_¡ub_¡©us_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

86 
size_t
 
size
;

87 
ngx_št_t
 
rc
;

88 
ngx_buf_t
 *
b
;

89 
ngx_chaš_t
 
out
;

90 
ngx_©omic_št_t
 
­
, 
hn
, 
ac
, 
rq
, 
rd
, 
wr
, 
wa
;

92 ià(
r
->
m‘hod
 !ð
NGX_HTTP_GET
 &&„->m‘hod !ð
NGX_HTTP_HEAD
) {

93  
NGX_HTTP_NOT_ALLOWED
;

96 
rc
 = 
	`ngx_h‰p_disÿrd_»que¡_body
(
r
);

98 ià(
rc
 !ð
NGX_OK
) {

99  
rc
;

102 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = ("text/plain") - 1;

103 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
cÚ‹Á_ty³
, "text/plain");

104 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

106 ià(
r
->
m‘hod
 =ð
NGX_HTTP_HEAD
) {

107 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_OK
;

109 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

111 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

112  
rc
;

116 
size
 = ("AùivcÚÃùiÚs: \n"è+ 
NGX_ATOMIC_T_LEN


118 + 6 + 3 * 
NGX_ATOMIC_T_LEN


119 + ("R—dšg: Wr™šg: Wa™šg: \n"è+ 3 * 
NGX_ATOMIC_T_LEN
;

121 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
size
);

122 ià(
b
 =ð
NULL
) {

123  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

126 
out
.
buf
 = 
b
;

127 
out
.
Ãxt
 = 
NULL
;

129 
­
 = *
ngx_¡©_acû±ed
;

130 
hn
 = *
ngx_¡©_hªdËd
;

131 
ac
 = *
ngx_¡©_aùive
;

132 
rq
 = *
ngx_¡©_»que¡s
;

133 
rd
 = *
ngx_¡©_»adšg
;

134 
wr
 = *
ngx_¡©_wr™šg
;

135 
wa
 = *
ngx_¡©_wa™šg
;

137 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, "AùivcÚÃùiÚs: %uA \n", 
ac
);

139 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "server‡ccepts handled„equests\n",

142 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, " %uA %uA %uA \n", 
­
, 
hn
, 
rq
);

144 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->last, "Reading: %uA Writing: %uA Waiting: %uA \n",

145 
rd
, 
wr
, 
wa
);

147 
r
->
h—d”s_out
.
¡©us
 = 
NGX_HTTP_OK
;

148 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
b
->
Ï¡
 - b->
pos
;

150 
b
->
Ï¡_buf
 = (
r
 =ðr->
maš
) ? 1 : 0;

151 
b
->
Ï¡_š_chaš
 = 1;

153 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

155 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

156  
rc
;

159  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

160 
	}
}

163 
ngx_št_t


164 
	$ngx_h‰p_¡ub_¡©us_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

165 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

167 
u_ch¬
 *
p
;

168 
ngx_©omic_št_t
 
v®ue
;

170 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_ATOMIC_T_LEN
);

171 ià(
p
 =ð
NULL
) {

172  
NGX_ERROR
;

175 
d©a
) {

177 
v®ue
 = *
ngx_¡©_aùive
;

181 
v®ue
 = *
ngx_¡©_»adšg
;

185 
v®ue
 = *
ngx_¡©_wr™šg
;

189 
v®ue
 = *
ngx_¡©_wa™šg
;

194 
v®ue
 = 0;

198 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%uA", 
v®ue
) -…;

199 
v
->
v®id
 = 1;

200 
v
->
no_ÿch—bË
 = 0;

201 
v
->
nÙ_found
 = 0;

202 
v
->
d©a
 = 
p
;

204  
NGX_OK
;

205 
	}
}

208 
ngx_št_t


209 
	$ngx_h‰p_¡ub_¡©us_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

211 
ngx_h‰p_v¬ŸbË_t
 *
v¬
, *
v
;

213 
v
 = 
ngx_h‰p_¡ub_¡©us_v¬s
; v->
Çme
.
Ën
; v++) {

214 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

215 ià(
v¬
 =ð
NULL
) {

216  
NGX_ERROR
;

219 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

220 
v¬
->
d©a
 = 
v
->data;

223  
NGX_OK
;

224 
	}
}

228 
	$ngx_h‰p_£t_¡ub_¡©us
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

230 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

232 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

233 
þcf
->
hªdËr
 = 
ngx_h‰p_¡ub_¡©us_hªdËr
;

235  
NGX_CONF_OK
;

236 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_sub_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_¡r_t
 
	mm©ch
;

15 
ngx_h‰p_com¶ex_v®ue_t
 
	mv®ue
;

17 
ngx_hash_t
 
	mty³s
;

19 
ngx_æag_t
 
	mÚû
;

20 
ngx_æag_t
 
	mÏ¡_modif›d
;

22 
ngx_¬¿y_t
 *
	mty³s_keys
;

23 } 
	tngx_h‰p_sub_loc_cÚf_t
;

27 
	msub_¡¬t_¡©e
 = 0,

28 
	msub_m©ch_¡©e
,

29 } 
	tngx_h‰p_sub_¡©e_e
;

33 
ngx_¡r_t
 
	mm©ch
;

34 
ngx_¡r_t
 
	m§ved
;

35 
ngx_¡r_t
 
	mlooked
;

37 
ngx_ušt_t
 
	mÚû
;

39 
ngx_buf_t
 *
	mbuf
;

41 
u_ch¬
 *
	mpos
;

42 
u_ch¬
 *
	mcÝy_¡¬t
;

43 
u_ch¬
 *
	mcÝy_’d
;

45 
ngx_chaš_t
 *
	mš
;

46 
ngx_chaš_t
 *
	mout
;

47 
ngx_chaš_t
 **
	mÏ¡_out
;

48 
ngx_chaš_t
 *
	mbusy
;

49 
ngx_chaš_t
 *
	mä“
;

51 
ngx_¡r_t
 
	msub
;

53 
ngx_ušt_t
 
	m¡©e
;

54 } 
	tngx_h‰p_sub_ùx_t
;

57 
ngx_št_t
 
ngx_h‰p_sub_ouut
(
ngx_h‰p_»que¡_t
 *
r
,

58 
ngx_h‰p_sub_ùx_t
 *
ùx
);

59 
ngx_št_t
 
ngx_h‰p_sub_·r£
(
ngx_h‰p_»que¡_t
 *
r
,

60 
ngx_h‰p_sub_ùx_t
 *
ùx
);

62 * 
ngx_h‰p_sub_fž‹r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

63 *
cÚf
);

64 *
ngx_h‰p_sub_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

65 *
ngx_h‰p_sub_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
,

66 *
·»Á
, *
chžd
);

67 
ngx_št_t
 
ngx_h‰p_sub_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

70 
ngx_commªd_t
 
	gngx_h‰p_sub_fž‹r_commªds
[] = {

72 { 
ngx_¡ršg
("sub_filter"),

73 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

74 
ngx_h‰p_sub_fž‹r
,

75 
NGX_HTTP_LOC_CONF_OFFSET
,

77 
NULL
 },

79 { 
ngx_¡ršg
("sub_filter_types"),

80 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

81 
ngx_h‰p_ty³s_¦Ù
,

82 
NGX_HTTP_LOC_CONF_OFFSET
,

83 
off£tof
(
ngx_h‰p_sub_loc_cÚf_t
, 
ty³s_keys
),

84 &
ngx_h‰p_html_deçuÉ_ty³s
[0] },

86 { 
ngx_¡ršg
("sub_filter_once"),

87 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

88 
ngx_cÚf_£t_æag_¦Ù
,

89 
NGX_HTTP_LOC_CONF_OFFSET
,

90 
off£tof
(
ngx_h‰p_sub_loc_cÚf_t
, 
Úû
),

91 
NULL
 },

93 { 
ngx_¡ršg
("sub_filter_last_modified"),

94 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

95 
ngx_cÚf_£t_æag_¦Ù
,

96 
NGX_HTTP_LOC_CONF_OFFSET
,

97 
off£tof
(
ngx_h‰p_sub_loc_cÚf_t
, 
Ï¡_modif›d
),

98 
NULL
 },

100 
ngx_nuÎ_commªd


104 
ngx_h‰p_moduË_t
 
	gngx_h‰p_sub_fž‹r_moduË_ùx
 = {

105 
NULL
,

106 
ngx_h‰p_sub_fž‹r_š™
,

108 
NULL
,

109 
NULL
,

111 
NULL
,

112 
NULL
,

114 
ngx_h‰p_sub_ü—‹_cÚf
,

115 
ngx_h‰p_sub_m”ge_cÚf


119 
ngx_moduË_t
 
	gngx_h‰p_sub_fž‹r_moduË
 = {

120 
NGX_MODULE_V1
,

121 &
ngx_h‰p_sub_fž‹r_moduË_ùx
,

122 
ngx_h‰p_sub_fž‹r_commªds
,

123 
NGX_HTTP_MODULE
,

124 
NULL
,

125 
NULL
,

126 
NULL
,

127 
NULL
,

128 
NULL
,

129 
NULL
,

130 
NULL
,

131 
NGX_MODULE_V1_PADDING


135 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

136 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

139 
ngx_št_t


140 
	$ngx_h‰p_sub_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

142 
ngx_h‰p_sub_ùx_t
 *
ùx
;

143 
ngx_h‰p_sub_loc_cÚf_t
 *
¦cf
;

145 
¦cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_sub_fž‹r_moduË
);

147 ià(
¦cf
->
m©ch
.
Ën
 == 0

148 || 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 == 0

149 || 
	`ngx_h‰p_‹¡_cÚ‹Á_ty³
(
r
, &
¦cf
->
ty³s
è=ð
NULL
)

151  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

154 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_sub_ùx_t
));

155 ià(
ùx
 =ð
NULL
) {

156  
NGX_ERROR
;

159 
ùx
->
§ved
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
¦cf
->
m©ch
.
Ën
);

160 ià(
ùx
->
§ved
.
d©a
 =ð
NULL
) {

161  
NGX_ERROR
;

164 
ùx
->
looked
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
¦cf
->
m©ch
.
Ën
);

165 ià(
ùx
->
looked
.
d©a
 =ð
NULL
) {

166  
NGX_ERROR
;

169 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_sub_fž‹r_moduË
);

171 
ùx
->
m©ch
 = 
¦cf
->match;

172 
ùx
->
Ï¡_out
 = &ùx->
out
;

174 
r
->
fž‹r_Ãed_š_memÜy
 = 1;

176 ià(
r
 =ðr->
maš
) {

177 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
r
);

179 ià(!
¦cf
->
Ï¡_modif›d
) {

180 
	`ngx_h‰p_þ—r_Ï¡_modif›d
(
r
);

181 
	`ngx_h‰p_þ—r_‘ag
(
r
);

184 
	`ngx_h‰p_w—k_‘ag
(
r
);

188  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

189 
	}
}

192 
ngx_št_t


193 
	$ngx_h‰p_sub_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

195 
ngx_št_t
 
rc
;

196 
ngx_buf_t
 *
b
;

197 
ngx_chaš_t
 *
þ
;

198 
ngx_h‰p_sub_ùx_t
 *
ùx
;

199 
ngx_h‰p_sub_loc_cÚf_t
 *
¦cf
;

201 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_sub_fž‹r_moduË
);

203 ià(
ùx
 =ð
NULL
) {

204  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

207 ià((
š
 =ð
NULL


208 && 
ùx
->
buf
 =ð
NULL


209 && 
ùx
->
š
 =ð
NULL


210 && 
ùx
->
busy
 =ð
NULL
))

212  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

215 ià(
ùx
->
Úû
 && (ùx->
buf
 =ð
NULL
 || ctx->
š
 == NULL)) {

217 ià(
ùx
->
busy
) {

218 ià(
	`ngx_h‰p_sub_ouut
(
r
, 
ùx
è=ð
NGX_ERROR
) {

219  
NGX_ERROR
;

223  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

228 ià(
š
) {

229 ià(
	`ngx_chaš_add_cÝy
(
r
->
poÞ
, &
ùx
->
š
, inè!ð
NGX_OK
) {

230  
NGX_ERROR
;

234 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

235 "h‰°sub fž‹¸\"%V\"", &
r
->
uri
);

237 
ùx
->
š
 || ctx->
buf
) {

239 ià(
ùx
->
buf
 =ð
NULL
) {

240 
ùx
->
buf
 = ctx->
š
->buf;

241 
ùx
->
š
 = ctx->š->
Ãxt
;

242 
ùx
->
pos
 = ctx->
buf
->pos;

245 ià(
ùx
->
¡©e
 =ð
sub_¡¬t_¡©e
) {

246 
ùx
->
cÝy_¡¬t
 = ctx->
pos
;

247 
ùx
->
cÝy_’d
 = ctx->
pos
;

250 
b
 = 
NULL
;

252 
ùx
->
pos
 < ctx->
buf
->
Ï¡
) {

254 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

255 "§ved: \"%V\" s‹: %d", &
ùx
->
§ved
, ctx->
¡©e
);

257 
rc
 = 
	`ngx_h‰p_sub_·r£
(
r
, 
ùx
);

259 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

261 
rc
, &
ùx
->
looked
, ctx->
cÝy_¡¬t
, ctx->
cÝy_’d
);

263 ià(
rc
 =ð
NGX_ERROR
) {

264  
rc
;

267 ià(
ùx
->
§ved
.
Ën
) {

269 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

270 "§ved: \"%V\"", &
ùx
->
§ved
);

272 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
ùx
->
ä“
);

273 ià(
þ
 =ð
NULL
) {

274  
NGX_ERROR
;

277 
b
 = 
þ
->
buf
;

279 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

281 
b
->
pos
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
ùx
->
§ved
.
Ën
);

282 ià(
b
->
pos
 =ð
NULL
) {

283  
NGX_ERROR
;

286 
	`ngx_memýy
(
b
->
pos
, 
ùx
->
§ved
.
d©a
, ctx->§ved.
Ën
);

287 
b
->
Ï¡
 = b->
pos
 + 
ùx
->
§ved
.
Ën
;

288 
b
->
memÜy
 = 1;

290 *
ùx
->
Ï¡_out
 = 
þ
;

291 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

293 
ùx
->
§ved
.
Ën
 = 0;

296 ià(
ùx
->
cÝy_¡¬t
 !ðùx->
cÝy_’d
) {

298 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
ùx
->
ä“
);

299 ià(
þ
 =ð
NULL
) {

300  
NGX_ERROR
;

303 
b
 = 
þ
->
buf
;

305 
	`ngx_memýy
(
b
, 
ùx
->
buf
, (
ngx_buf_t
));

307 
b
->
pos
 = 
ùx
->
cÝy_¡¬t
;

308 
b
->
Ï¡
 = 
ùx
->
cÝy_’d
;

309 
b
->
shadow
 = 
NULL
;

310 
b
->
Ï¡_buf
 = 0;

311 
b
->
Ï¡_š_chaš
 = 0;

312 
b
->
»cyþed
 = 0;

314 ià(
b
->
š_fže
) {

315 
b
->
fže_Ï¡
 = b->
fže_pos
 + (b->
Ï¡
 - 
ùx
->
buf
->
pos
);

316 
b
->
fže_pos
 +ðb->
pos
 - 
ùx
->
buf
->pos;

319 *
ùx
->
Ï¡_out
 = 
þ
;

320 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

323 ià(
ùx
->
¡©e
 =ð
sub_¡¬t_¡©e
) {

324 
ùx
->
cÝy_¡¬t
 = ctx->
pos
;

325 
ùx
->
cÝy_’d
 = ctx->
pos
;

328 
ùx
->
cÝy_¡¬t
 = 
NULL
;

329 
ùx
->
cÝy_’d
 = 
NULL
;

332 ià(
ùx
->
looked
.
Ën
 > (
size_t
è(ùx->
pos
 - ctx->
buf
->pos)) {

333 
ùx
->
§ved
.
Ën
 = ctx->
looked
.ËÀ- (ùx->
pos
 - ctx->
buf
->pos);

334 
	`ngx_memýy
(
ùx
->
§ved
.
d©a
, ctx->
looked
.d©a, ctx->§ved.
Ën
);

337 ià(
rc
 =ð
NGX_AGAIN
) {

344 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
ùx
->
ä“
);

345 ià(
þ
 =ð
NULL
) {

346  
NGX_ERROR
;

349 
b
 = 
þ
->
buf
;

351 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

353 
¦cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_sub_fž‹r_moduË
);

355 ià(
ùx
->
sub
.
d©a
 =ð
NULL
) {

357 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
¦cf
->
v®ue
, &
ùx
->
sub
)

358 !ð
NGX_OK
)

360  
NGX_ERROR
;

364 ià(
ùx
->
sub
.
Ën
) {

365 
b
->
memÜy
 = 1;

366 
b
->
pos
 = 
ùx
->
sub
.
d©a
;

367 
b
->
Ï¡
 = 
ùx
->
sub
.
d©a
 + ctx->sub.
Ën
;

370 
b
->
sync
 = 1;

373 *
ùx
->
Ï¡_out
 = 
þ
;

374 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

376 
ùx
->
Úû
 = 
¦cf
->once;

381 ià(
ùx
->
looked
.
Ën


382 && (
ùx
->
buf
->
Ï¡_buf
 || ctx->buf->
Ï¡_š_chaš
))

384 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
ùx
->
ä“
);

385 ià(
þ
 =ð
NULL
) {

386  
NGX_ERROR
;

389 
b
 = 
þ
->
buf
;

391 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

393 
b
->
pos
 = 
ùx
->
looked
.
d©a
;

394 
b
->
Ï¡
 = b->
pos
 + 
ùx
->
looked
.
Ën
;

395 
b
->
memÜy
 = 1;

397 *
ùx
->
Ï¡_out
 = 
þ
;

398 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

400 
ùx
->
looked
.
Ën
 = 0;

403 ià(
ùx
->
buf
->
Ï¡_buf
 || ctx->buf->
æush
 || ctx->buf->
sync


404 || 
	`ngx_buf_š_memÜy
(
ùx
->
buf
))

406 ià(
b
 =ð
NULL
) {

407 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
ùx
->
ä“
);

408 ià(
þ
 =ð
NULL
) {

409  
NGX_ERROR
;

412 
b
 = 
þ
->
buf
;

414 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

416 
b
->
sync
 = 1;

418 *
ùx
->
Ï¡_out
 = 
þ
;

419 
ùx
->
Ï¡_out
 = &
þ
->
Ãxt
;

422 
b
->
Ï¡_buf
 = 
ùx
->
buf
->last_buf;

423 
b
->
Ï¡_š_chaš
 = 
ùx
->
buf
->last_in_chain;

424 
b
->
æush
 = 
ùx
->
buf
->flush;

425 
b
->
shadow
 = 
ùx
->
buf
;

427 
b
->
»cyþed
 = 
ùx
->
buf
->recycled;

430 
ùx
->
buf
 = 
NULL
;

432 
ùx
->
§ved
.
Ën
 = ctx->
looked
.len;

433 
	`ngx_memýy
(
ùx
->
§ved
.
d©a
, ctx->
looked
.d©a, ctx->looked.
Ën
);

436 ià(
ùx
->
out
 =ð
NULL
 && ctx->
busy
 == NULL) {

437  
NGX_OK
;

440  
	`ngx_h‰p_sub_ouut
(
r
, 
ùx
);

441 
	}
}

444 
ngx_št_t


445 
	$ngx_h‰p_sub_ouut
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_sub_ùx_t
 *
ùx
)

447 
ngx_št_t
 
rc
;

448 
ngx_buf_t
 *
b
;

449 
ngx_chaš_t
 *
þ
;

452 
b
 = 
NULL
;

453 
þ
 = 
ùx
->
out
; cl; cÈðþ->
Ãxt
) {

454 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

455 "sub out: %°%p", 
þ
->
buf
, cl->buf->
pos
);

456 ià(
þ
->
buf
 =ð
b
) {

457 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

459 
	`ngx_debug_pošt
();

460  
NGX_ERROR
;

462 
b
 = 
þ
->
buf
;

466 
rc
 = 
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
ùx
->
out
);

468 ià(
ùx
->
busy
 =ð
NULL
) {

469 
ùx
->
busy
 = ctx->
out
;

472 
þ
 = 
ùx
->
busy
; cl->
Ãxt
; cl = cl->next) { }

473 
þ
->
Ãxt
 = 
ùx
->
out
;

476 
ùx
->
out
 = 
NULL
;

477 
ùx
->
Ï¡_out
 = &ùx->
out
;

479 
ùx
->
busy
) {

481 
þ
 = 
ùx
->
busy
;

482 
b
 = 
þ
->
buf
;

484 ià(
	`ngx_buf_size
(
b
) != 0) {

488 ià(
b
->
shadow
) {

489 
b
->
shadow
->
pos
 = b->shadow->
Ï¡
;

492 
ùx
->
busy
 = 
þ
->
Ãxt
;

494 ià(
	`ngx_buf_š_memÜy
(
b
è|| b->
š_fže
) {

497 
þ
->
Ãxt
 = 
ùx
->
ä“
;

498 
ùx
->
ä“
 = 
þ
;

502 ià(
ùx
->
š
 || ctx->
buf
) {

503 
r
->
bufã»d
 |ð
NGX_HTTP_SUB_BUFFERED
;

506 
r
->
bufã»d
 &ð~
NGX_HTTP_SUB_BUFFERED
;

509  
rc
;

510 
	}
}

513 
ngx_št_t


514 
	$ngx_h‰p_sub_·r£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_sub_ùx_t
 *
ùx
)

516 
u_ch¬
 *
p
, *
Ï¡
, *
cÝy_’d
, 
ch
, 
m©ch
;

517 
size_t
 
looked
, 
i
;

518 
ngx_h‰p_sub_¡©e_e
 
¡©e
;

520 ià(
ùx
->
Úû
) {

521 
ùx
->
cÝy_¡¬t
 = ctx->
pos
;

522 
ùx
->
cÝy_’d
 = ctx->
buf
->
Ï¡
;

523 
ùx
->
pos
 = ctx->
buf
->
Ï¡
;

524 
ùx
->
looked
.
Ën
 = 0;

526 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0, "once");

528  
NGX_AGAIN
;

531 
¡©e
 = 
ùx
->state;

532 
looked
 = 
ùx
->looked.
Ën
;

533 
Ï¡
 = 
ùx
->
buf
->last;

534 
cÝy_’d
 = 
ùx
->copy_end;

536 
p
 = 
ùx
->
pos
;… < 
Ï¡
;…++) {

538 
ch
 = *
p
;

539 
ch
 = 
	`ngx_tÞow”
(ch);

541 ià(
¡©e
 =ð
sub_¡¬t_¡©e
) {

545 
m©ch
 = 
ùx
->m©ch.
d©a
[0];

548 ià(
ch
 =ð
m©ch
) {

550 ià(
ùx
->
m©ch
.
Ën
 == 1) {

551 
ùx
->
pos
 = 
p
 + 1;

552 
ùx
->
cÝy_’d
 = 
p
;

554  
NGX_OK
;

557 
cÝy_’d
 = 
p
;

558 
ùx
->
looked
.
d©a
[0] = *
p
;

559 
looked
 = 1;

560 
¡©e
 = 
sub_m©ch_¡©e
;

562 
m©ch_¡¬‹d
;

565 ià(++
p
 =ð
Ï¡
) {

569 
ch
 = *
p
;

570 
ch
 = 
	`ngx_tÞow”
(ch);

573 
ùx
->
¡©e
 = state;

574 
ùx
->
pos
 = 
p
;

575 
ùx
->
looked
.
Ën
 =†ooked;

576 
ùx
->
cÝy_’d
 = 
p
;

578 ià(
ùx
->
cÝy_¡¬t
 =ð
NULL
) {

579 
ùx
->
cÝy_¡¬t
 = ctx->
buf
->
pos
;

582  
NGX_AGAIN
;

584 
m©ch_¡¬‹d
:

591 ià(
ch
 =ð
ùx
->
m©ch
.
d©a
[
looked
]) {

592 
ùx
->
looked
.
d©a
[looked] = *
p
;

593 
looked
++;

595 ià(
looked
 =ð
ùx
->
m©ch
.
Ën
) {

597 
ùx
->
¡©e
 = 
sub_¡¬t_¡©e
;

598 
ùx
->
pos
 = 
p
 + 1;

599 
ùx
->
looked
.
Ën
 = 0;

600 
ùx
->
§ved
.
Ën
 = 0;

601 
ùx
->
cÝy_’d
 = copy_end;

603 ià(
ùx
->
cÝy_¡¬t
 =ð
NULL
 && 
cÝy_’d
) {

604 
ùx
->
cÝy_¡¬t
 = ctx->
buf
->
pos
;

607  
NGX_OK
;

616 
ùx
->
looked
.
d©a
[looked] = *
p
;

617 
looked
++;

619 
i
 = 1; i < 
looked
; i++) {

620 ià(
	`ngx_¡ºÿ£cmp
(
ùx
->
looked
.
d©a
 + 
i
,

621 
ùx
->
m©ch
.
d©a
, 
looked
 - 
i
)

628 ià(
i
 < 
looked
) {

629 ià(
ùx
->
§ved
.
Ën
 > 
i
) {

630 
ùx
->
§ved
.
Ën
 = 
i
;

633 ià((
size_t
è(
p
 + 1 - 
ùx
->
buf
->
pos
è>ð
looked
 - 
i
) {

634 
cÝy_’d
 = 
p
 + 1 - (
looked
 - 
i
);

637 
	`ngx_memmove
(
ùx
->
looked
.
d©a
, ctx->looked.d©¨+ 
i
,†ooked - i);

638 
looked
 =†ooked - 
i
;

641 
cÝy_’d
 = 
p
;

642 
looked
 = 0;

643 
¡©e
 = 
sub_¡¬t_¡©e
;

646 ià(
ùx
->
§ved
.
Ën
) {

647 
p
++;

648 
out
;

653 
ùx
->
§ved
.
Ën
 = 0;

655 
out
:

657 
ùx
->
¡©e
 = state;

658 
ùx
->
pos
 = 
p
;

659 
ùx
->
looked
.
Ën
 =†ooked;

661 
ùx
->
cÝy_’d
 = (
¡©e
 =ð
sub_¡¬t_¡©e
è? 
p
 : copy_end;

663 ià(
ùx
->
cÝy_¡¬t
 =ð
NULL
 && ctx->
cÝy_’d
) {

664 
ùx
->
cÝy_¡¬t
 = ctx->
buf
->
pos
;

667  
NGX_AGAIN
;

668 
	}
}

672 
	$ngx_h‰p_sub_fž‹r
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

674 
ngx_h‰p_sub_loc_cÚf_t
 *
¦cf
 = 
cÚf
;

676 
ngx_¡r_t
 *
v®ue
;

677 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

679 ià(
¦cf
->
m©ch
.
d©a
) {

683 
v®ue
 = 
cf
->
¬gs
->
–ts
;

685 
	`ngx_¡¾ow
(
v®ue
[1].
d©a
, v®ue[1].d©a, v®ue[1].
Ën
);

687 
¦cf
->
m©ch
 = 
v®ue
[1];

689 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

691 
ccv
.
cf
 = cf;

692 
ccv
.
v®ue
 = &value[2];

693 
ccv
.
com¶ex_v®ue
 = &
¦cf
->
v®ue
;

695 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

696  
NGX_CONF_ERROR
;

699  
NGX_CONF_OK
;

700 
	}
}

704 
	$ngx_h‰p_sub_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

706 
ngx_h‰p_sub_loc_cÚf_t
 *
¦cf
;

708 
¦cf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_sub_loc_cÚf_t
));

709 ià(
¦cf
 =ð
NULL
) {

710  
NULL
;

721 
¦cf
->
Úû
 = 
NGX_CONF_UNSET
;

722 
¦cf
->
Ï¡_modif›d
 = 
NGX_CONF_UNSET
;

724  
¦cf
;

725 
	}
}

729 
	$ngx_h‰p_sub_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

731 
ngx_h‰p_sub_loc_cÚf_t
 *
´ev
 = 
·»Á
;

732 
ngx_h‰p_sub_loc_cÚf_t
 *
cÚf
 = 
chžd
;

734 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
Úû
, 
´ev
->once, 1);

735 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
m©ch
, 
´ev
->match, "");

736 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
Ï¡_modif›d
, 
´ev
->last_modified, 0);

738 ià(
cÚf
->
v®ue
.v®ue.
d©a
 =ð
NULL
) {

739 
cÚf
->
v®ue
 = 
´ev
->value;

742 ià(
	`ngx_h‰p_m”ge_ty³s
(
cf
, &
cÚf
->
ty³s_keys
, &cÚf->
ty³s
,

743 &
´ev
->
ty³s_keys
, &´ev->
ty³s
,

744 
ngx_h‰p_html_deçuÉ_ty³s
)

745 !ð
NGX_OK
)

747  
NGX_CONF_ERROR
;

750  
NGX_CONF_OK
;

751 
	}
}

754 
ngx_št_t


755 
	$ngx_h‰p_sub_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

757 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

758 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_sub_h—d”_fž‹r
;

760 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

761 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_sub_body_fž‹r
;

763  
NGX_OK
;

764 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_upstream_hash_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ušt32_t
 
	mhash
;

15 
ngx_¡r_t
 *
	m£rv”
;

16 } 
	tngx_h‰p_up¡»am_chash_pošt_t
;

20 
ngx_ušt_t
 
	mnumb”
;

21 
ngx_h‰p_up¡»am_chash_pošt_t
 
	mpošt
[1];

22 } 
	tngx_h‰p_up¡»am_chash_pošts_t
;

26 
ngx_h‰p_com¶ex_v®ue_t
 
	mkey
;

27 
ngx_h‰p_up¡»am_chash_pošts_t
 *
	mpošts
;

28 } 
	tngx_h‰p_up¡»am_hash_¤v_cÚf_t
;

33 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 
	m¼p
;

34 
ngx_h‰p_up¡»am_hash_¤v_cÚf_t
 *
	mcÚf
;

35 
ngx_¡r_t
 
	mkey
;

36 
ngx_ušt_t
 
	mŒ›s
;

37 
ngx_ušt_t
 
	m»hash
;

38 
ušt32_t
 
	mhash
;

39 
ngx_ev’t_g‘_³”_±
 
	mg‘_¼_³”
;

40 } 
	tngx_h‰p_up¡»am_hash_³”_d©a_t
;

43 
ngx_št_t
 
ngx_h‰p_up¡»am_š™_hash
(
ngx_cÚf_t
 *
cf
,

44 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
);

45 
ngx_št_t
 
ngx_h‰p_up¡»am_š™_hash_³”
(
ngx_h‰p_»que¡_t
 *
r
,

46 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
);

47 
ngx_št_t
 
ngx_h‰p_up¡»am_g‘_hash_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

48 *
d©a
);

50 
ngx_št_t
 
ngx_h‰p_up¡»am_š™_chash
(
ngx_cÚf_t
 *
cf
,

51 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
);

52 
ngx_h‰p_up¡»am_add_chash_pošt
(

53 
ngx_h‰p_up¡»am_chash_pošts_t
 *
pošts
, 
ušt32_t
 
hash
, 
ngx_¡r_t
 *
£rv”
);

54 
ngx_ušt_t
 
ngx_h‰p_up¡»am_fšd_chash_pošt
(

55 
ngx_h‰p_up¡»am_chash_pošts_t
 *
pošts
, 
ušt32_t
 
hash
);

56 
ngx_št_t
 
ngx_h‰p_up¡»am_š™_chash_³”
(
ngx_h‰p_»que¡_t
 *
r
,

57 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
);

58 
ngx_št_t
 
ngx_h‰p_up¡»am_g‘_chash_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

59 *
d©a
);

61 *
ngx_h‰p_up¡»am_hash_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

62 *
ngx_h‰p_up¡»am_hash
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

63 *
cÚf
);

66 
ngx_commªd_t
 
	gngx_h‰p_up¡»am_hash_commªds
[] = {

68 { 
ngx_¡ršg
("hash"),

69 
NGX_HTTP_UPS_CONF
|
NGX_CONF_TAKE12
,

70 
ngx_h‰p_up¡»am_hash
,

71 
NGX_HTTP_SRV_CONF_OFFSET
,

73 
NULL
 },

75 
ngx_nuÎ_commªd


79 
ngx_h‰p_moduË_t
 
	gngx_h‰p_up¡»am_hash_moduË_ùx
 = {

80 
NULL
,

81 
NULL
,

83 
NULL
,

84 
NULL
,

86 
ngx_h‰p_up¡»am_hash_ü—‹_cÚf
,

87 
NULL
,

89 
NULL
,

90 
NULL


94 
ngx_moduË_t
 
	gngx_h‰p_up¡»am_hash_moduË
 = {

95 
NGX_MODULE_V1
,

96 &
ngx_h‰p_up¡»am_hash_moduË_ùx
,

97 
ngx_h‰p_up¡»am_hash_commªds
,

98 
NGX_HTTP_MODULE
,

99 
NULL
,

100 
NULL
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NGX_MODULE_V1_PADDING


110 
ngx_št_t


111 
	$ngx_h‰p_up¡»am_š™_hash
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

113 ià(
	`ngx_h‰p_up¡»am_š™_round_robš
(
cf
, 
us
è!ð
NGX_OK
) {

114  
NGX_ERROR
;

117 
us
->
³”
.
š™
 = 
ngx_h‰p_up¡»am_š™_hash_³”
;

119  
NGX_OK
;

120 
	}
}

123 
ngx_št_t


124 
	$ngx_h‰p_up¡»am_š™_hash_³”
(
ngx_h‰p_»que¡_t
 *
r
,

125 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

127 
ngx_h‰p_up¡»am_hash_¤v_cÚf_t
 *
hcf
;

128 
ngx_h‰p_up¡»am_hash_³”_d©a_t
 *
hp
;

130 
hp
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_hash_³”_d©a_t
));

131 ià(
hp
 =ð
NULL
) {

132  
NGX_ERROR
;

135 
r
->
up¡»am
->
³”
.
d©a
 = &
hp
->
¼p
;

137 ià(
	`ngx_h‰p_up¡»am_š™_round_robš_³”
(
r
, 
us
è!ð
NGX_OK
) {

138  
NGX_ERROR
;

141 
r
->
up¡»am
->
³”
.
g‘
 = 
ngx_h‰p_up¡»am_g‘_hash_³”
;

143 
hcf
 = 
	`ngx_h‰p_cÚf_up¡»am_¤v_cÚf
(
us
, 
ngx_h‰p_up¡»am_hash_moduË
);

145 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
hcf
->
key
, &
hp
->keyè!ð
NGX_OK
) {

146  
NGX_ERROR
;

149 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

150 "up¡»am hash key:\"%V\"", &
hp
->
key
);

152 
hp
->
cÚf
 = 
hcf
;

153 
hp
->
Œ›s
 = 0;

154 
hp
->
»hash
 = 0;

155 
hp
->
hash
 = 0;

156 
hp
->
g‘_¼_³”
 = 
ngx_h‰p_up¡»am_g‘_round_robš_³”
;

158  
NGX_OK
;

159 
	}
}

162 
ngx_št_t


163 
	$ngx_h‰p_up¡»am_g‘_hash_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

165 
ngx_h‰p_up¡»am_hash_³”_d©a_t
 *
hp
 = 
d©a
;

167 
time_t
 
now
;

168 
u_ch¬
 
buf
[
NGX_INT_T_LEN
];

169 
size_t
 
size
;

170 
ušt32_t
 
hash
;

171 
ngx_št_t
 
w
;

172 
ušŒ_t
 
m
;

173 
ngx_ušt_t
 
i
, 
n
, 
p
;

174 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

176 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

177 "g‘ hash…“r,ry: %ui", 
pc
->
Œ›s
);

179 ià(
hp
->
Œ›s
 > 20 || hp->
¼p
.
³”s
->
sšgË
) {

180  
hp
->
	`g‘_¼_³”
(
pc
, &hp->
¼p
);

183 
now
 = 
	`ngx_time
();

185 
pc
->
ÿched
 = 0;

186 
pc
->
cÚÃùiÚ
 = 
NULL
;

196 
	`ngx_üc32_š™
(
hash
);

198 ià(
hp
->
»hash
 > 0) {

199 
size
 = 
	`ngx_¥rštf
(
buf
, "%ui", 
hp
->
»hash
) - buf;

200 
	`ngx_üc32_upd©e
(&
hash
, 
buf
, 
size
);

203 
	`ngx_üc32_upd©e
(&
hash
, 
hp
->
key
.
d©a
, hp->key.
Ën
);

204 
	`ngx_üc32_fš®
(
hash
);

206 
hash
 = (hash >> 16) & 0x7fff;

208 
hp
->
hash
 += hash;

209 
hp
->
»hash
++;

211 ià(!
hp
->
¼p
.
³”s
->
weigh‹d
) {

212 
p
 = 
hp
->
hash
 % hp->
¼p
.
³”s
->
numb”
;

215 
w
 = 
hp
->
hash
 % hp->
¼p
.
³”s
->
tÙ®_weight
;

217 
i
 = 0; i < 
hp
->
¼p
.
³”s
->
numb”
; i++) {

218 
w
 -ð
hp
->
¼p
.
³”s
->
³”
[
i
].
weight
;

219 ià(
w
 < 0) {

224 
p
 = 
i
;

227 
n
 = 
p
 / (8 * (
ušŒ_t
));

228 
m
 = (
ušŒ_t
è1 << 
p
 % (8 * (uintptr_t));

230 ià(
hp
->
¼p
.
Œ›d
[
n
] & 
m
) {

231 
Ãxt
;

234 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

235 "g‘ hash…“r, v®ue:%uD,…“r:%ui", 
hp
->
hash
, 
p
);

237 
³”
 = &
hp
->
¼p
.
³”s
->³”[
p
];

239 ià(
³”
->
down
) {

240 
Ãxt
;

243 ià(
³”
->
max_çžs


244 && 
³”
->
çžs
 >ð³”->
max_çžs


245 && 
now
 - 
³”
->
checked
 <ð³”->
çž_timeout
)

247 
Ãxt
;

252 
Ãxt
:

254 ià(++
hp
->
Œ›s
 > 20) {

255  
hp
->
	`g‘_¼_³”
(
pc
, &hp->
¼p
);

259 
hp
->
¼p
.
cu¼’t
 = 
p
;

261 
pc
->
sockaddr
 = 
³”
->sockaddr;

262 
pc
->
sockËn
 = 
³”
->socklen;

263 
pc
->
Çme
 = &
³”
->name;

265 ià(
now
 - 
³”
->
checked
 >…“r->
çž_timeout
) {

266 
³”
->
checked
 = 
now
;

269 
hp
->
¼p
.
Œ›d
[
n
] |ð
m
;

271  
NGX_OK
;

272 
	}
}

275 
ngx_št_t


276 
	$ngx_h‰p_up¡»am_š™_chash
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

278 
u_ch¬
 *
ho¡
, *
pÜt
, 
c
;

279 
size_t
 
ho¡_Ën
, 
pÜt_Ën
, 
size
;

280 
ušt32_t
 
hash
, 
ba£_hash
, 
´ev_hash
;

281 
ngx_¡r_t
 *
£rv”
;

282 
ngx_ušt_t
 
Åošts
, 
i
, 
j
;

283 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

284 
ngx_h‰p_up¡»am_¼_³”s_t
 *
³”s
;

285 
ngx_h‰p_up¡»am_chash_pošts_t
 *
pošts
;

286 
ngx_h‰p_up¡»am_hash_¤v_cÚf_t
 *
hcf
;

288 ià(
	`ngx_h‰p_up¡»am_š™_round_robš
(
cf
, 
us
è!ð
NGX_OK
) {

289  
NGX_ERROR
;

292 
us
->
³”
.
š™
 = 
ngx_h‰p_up¡»am_š™_chash_³”
;

294 
³”s
 = 
us
->
³”
.
d©a
;

295 
Åošts
 = 
³”s
->
tÙ®_weight
 * 160;

297 
size
 = (
ngx_h‰p_up¡»am_chash_pošts_t
)

298 + (
ngx_h‰p_up¡»am_chash_pošt_t
è* (
Åošts
 - 1);

300 
pošts
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, 
size
);

301 ià(
pošts
 =ð
NULL
) {

302  
NGX_ERROR
;

305 
pošts
->
numb”
 = 0;

307 
i
 = 0; i < 
³”s
->
numb”
; i++) {

308 
³”
 = &
³”s
->³”[
i
];

309 
£rv”
 = &
³”
->server;

316 ià(
£rv”
->
Ën
 >= 5

317 && 
	`ngx_¡ºÿ£cmp
(
£rv”
->
d©a
, (
u_ch¬
 *) "unix:", 5) == 0)

319 
ho¡
 = 
£rv”
->
d©a
 + 5;

320 
ho¡_Ën
 = 
£rv”
->
Ën
 - 5;

321 
pÜt
 = 
NULL
;

322 
pÜt_Ën
 = 0;

323 
dÚe
;

326 
j
 = 0; j < 
£rv”
->
Ën
; j++) {

327 
c
 = 
£rv”
->
d©a
[£rv”->
Ën
 - 
j
 - 1];

329 ià(
c
 == ':') {

330 
ho¡
 = 
£rv”
->
d©a
;

331 
ho¡_Ën
 = 
£rv”
->
Ën
 - 
j
 - 1;

332 
pÜt
 = 
£rv”
->
d©a
 + s”v”->
Ën
 - 
j
;

333 
pÜt_Ën
 = 
j
;

334 
dÚe
;

337 ià(
c
 < '0' || c > '9') {

342 
ho¡
 = 
£rv”
->
d©a
;

343 
ho¡_Ën
 = 
£rv”
->
Ën
;

344 
pÜt
 = 
NULL
;

345 
pÜt_Ën
 = 0;

347 
dÚe
:

349 
	`ngx_üc32_š™
(
ba£_hash
);

350 
	`ngx_üc32_upd©e
(&
ba£_hash
, 
ho¡
, 
ho¡_Ën
);

351 
	`ngx_üc32_upd©e
(&
ba£_hash
, (
u_ch¬
 *) "", 1);

352 
	`ngx_üc32_upd©e
(&
ba£_hash
, 
pÜt
, 
pÜt_Ën
);

354 
´ev_hash
 = 0;

355 
Åošts
 = 
³”
->
weight
 * 160;

357 
j
 = 0; j < 
Åošts
; j++) {

358 
hash
 = 
ba£_hash
;

360 
	`ngx_üc32_upd©e
(&
hash
, (
u_ch¬
 *è&
´ev_hash
, (
ušt32_t
));

361 
	`ngx_üc32_fš®
(
hash
);

363 
	`ngx_h‰p_up¡»am_add_chash_pošt
(
pošts
, 
hash
, &
³”
->
£rv”
);

365 
´ev_hash
 = 
hash
;

369 
hcf
 = 
	`ngx_h‰p_cÚf_up¡»am_¤v_cÚf
(
us
, 
ngx_h‰p_up¡»am_hash_moduË
);

370 
hcf
->
pošts
 =…oints;

372  
NGX_OK
;

373 
	}
}

377 
	$ngx_h‰p_up¡»am_add_chash_pošt
(
ngx_h‰p_up¡»am_chash_pošts_t
 *
pošts
,

378 
ušt32_t
 
hash
, 
ngx_¡r_t
 *
£rv”
)

380 
size_t
 
size
;

381 
ngx_ušt_t
 
i
;

382 
ngx_h‰p_up¡»am_chash_pošt_t
 *
pošt
;

384 
i
 = 
	`ngx_h‰p_up¡»am_fšd_chash_pošt
(
pošts
, 
hash
);

385 
pošt
 = &
pošts
->pošt[
i
];

387 ià(
pošt
->
hash
 == hash) {

391 
size
 = (
pošts
->
numb”
 - 
i
è* (
ngx_h‰p_up¡»am_chash_pošt_t
);

393 
	`ngx_memmove
(
pošt
 + 1,…ošt, 
size
);

395 
pošts
->
numb”
++;

396 
pošt
->
hash
 = hash;

397 
pošt
->
£rv”
 = server;

398 
	}
}

401 
ngx_ušt_t


402 
	$ngx_h‰p_up¡»am_fšd_chash_pošt
(
ngx_h‰p_up¡»am_chash_pošts_t
 *
pošts
,

403 
ušt32_t
 
hash
)

405 
ngx_ušt_t
 
i
, 
j
, 
k
;

406 
ngx_h‰p_up¡»am_chash_pošt_t
 *
pošt
;

410 
pošt
 = &
pošts
->point[0];

412 
i
 = 0;

413 
j
 = 
pošts
->
numb”
;

415 
i
 < 
j
) {

416 
k
 = (
i
 + 
j
) / 2;

418 ià(
hash
 > 
pošt
[
k
].hash) {

419 
i
 = 
k
 + 1;

421 } ià(
hash
 < 
pošt
[
k
].hash) {

422 
j
 = 
k
;

425  
k
;

429  
i
;

430 
	}
}

433 
ngx_št_t


434 
	$ngx_h‰p_up¡»am_š™_chash_³”
(
ngx_h‰p_»que¡_t
 *
r
,

435 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

437 
ušt32_t
 
hash
;

438 
ngx_h‰p_up¡»am_hash_¤v_cÚf_t
 *
hcf
;

439 
ngx_h‰p_up¡»am_hash_³”_d©a_t
 *
hp
;

441 ià(
	`ngx_h‰p_up¡»am_š™_hash_³”
(
r
, 
us
è!ð
NGX_OK
) {

442  
NGX_ERROR
;

445 
r
->
up¡»am
->
³”
.
g‘
 = 
ngx_h‰p_up¡»am_g‘_chash_³”
;

447 
hp
 = 
r
->
up¡»am
->
³”
.
d©a
;

448 
hcf
 = 
	`ngx_h‰p_cÚf_up¡»am_¤v_cÚf
(
us
, 
ngx_h‰p_up¡»am_hash_moduË
);

450 
hash
 = 
	`ngx_üc32_lÚg
(
hp
->
key
.
d©a
, hp->key.
Ën
);

451 
hp
->
hash
 = 
	`ngx_h‰p_up¡»am_fšd_chash_pošt
(
hcf
->
pošts
, hash);

453  
NGX_OK
;

454 
	}
}

457 
ngx_št_t


458 
	$ngx_h‰p_up¡»am_g‘_chash_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

460 
ngx_h‰p_up¡»am_hash_³”_d©a_t
 *
hp
 = 
d©a
;

462 
time_t
 
now
;

463 
šŒ_t
 
m
;

464 
ngx_¡r_t
 *
£rv”
;

465 
ngx_št_t
 
tÙ®
;

466 
ngx_ušt_t
 
i
, 
n
;

467 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
, *
be¡
;

468 
ngx_h‰p_up¡»am_chash_pošt_t
 *
pošt
;

469 
ngx_h‰p_up¡»am_chash_pošts_t
 *
pošts
;

470 
ngx_h‰p_up¡»am_hash_¤v_cÚf_t
 *
hcf
;

472 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

473 "g‘ cÚsi¡’ˆhash…“r,ry: %ui", 
pc
->
Œ›s
);

475 
pc
->
ÿched
 = 0;

476 
pc
->
cÚÃùiÚ
 = 
NULL
;

478 
now
 = 
	`ngx_time
();

479 
hcf
 = 
hp
->
cÚf
;

481 
pošts
 = 
hcf
->points;

482 
pošt
 = &
pošts
->point[0];

485 
£rv”
 = 
pošt
[
hp
->
hash
 % 
pošts
->
numb”
].server;

487 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

489 
hp
->
hash
, 
£rv”
);

491 
be¡
 = 
NULL
;

492 
tÙ®
 = 0;

494 
i
 = 0; i < 
hp
->
¼p
.
³”s
->
numb”
; i++) {

496 
n
 = 
i
 / (8 * (
ušŒ_t
));

497 
m
 = (
ušŒ_t
è1 << 
i
 % (8 * (uintptr_t));

499 ià(
hp
->
¼p
.
Œ›d
[
n
] & 
m
) {

503 
³”
 = &
hp
->
¼p
.
³”s
->³”[
i
];

505 ià(
³”
->
down
) {

509 ià(
³”
->
£rv”
.
Ën
 != server->len

510 || 
	`ngx_¡ºcmp
(
³”
->
£rv”
.
d©a
, s”v”->d©a, s”v”->
Ën
)

516 ià(
³”
->
max_çžs


517 && 
³”
->
çžs
 >ð³”->
max_çžs


518 && 
now
 - 
³”
->
checked
 <ð³”->
çž_timeout
)

523 
³”
->
cu¼’t_weight
 +ð³”->
efãùive_weight
;

524 
tÙ®
 +ð
³”
->
efãùive_weight
;

526 ià(
³”
->
efãùive_weight
 <…“r->
weight
) {

527 
³”
->
efãùive_weight
++;

530 ià(
be¡
 =ð
NULL
 || 
³”
->
cu¼’t_weight
 > best->current_weight) {

531 
be¡
 = 
³”
;

535 ià(
be¡
) {

536 
be¡
->
cu¼’t_weight
 -ð
tÙ®
;

538 
i
 = 
be¡
 - &
hp
->
¼p
.
³”s
->
³”
[0];

540 
hp
->
¼p
.
cu¼’t
 = 
i
;

542 
n
 = 
i
 / (8 * (
ušŒ_t
));

543 
m
 = (
ušŒ_t
è1 << 
i
 % (8 * (uintptr_t));

545 
hp
->
¼p
.
Œ›d
[
n
] |ð
m
;

547 ià(
now
 - 
be¡
->
checked
 > be¡->
çž_timeout
) {

548 
be¡
->
checked
 = 
now
;

551 
pc
->
sockaddr
 = 
be¡
->sockaddr;

552 
pc
->
sockËn
 = 
be¡
->socklen;

553 
pc
->
Çme
 = &
be¡
->name;

555  
NGX_OK
;

558 
hp
->
hash
++;

559 
hp
->
Œ›s
++;

561 ià(
hp
->
Œ›s
 >ð
pošts
->
numb”
) {

562  
NGX_BUSY
;

565 
	}
}

569 
	$ngx_h‰p_up¡»am_hash_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

571 
ngx_h‰p_up¡»am_hash_¤v_cÚf_t
 *
cÚf
;

573 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_up¡»am_hash_¤v_cÚf_t
));

574 ià(
cÚf
 =ð
NULL
) {

575  
NULL
;

578 
cÚf
->
pošts
 = 
NULL
;

580  
cÚf
;

581 
	}
}

585 
	$ngx_h‰p_up¡»am_hash
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

587 
ngx_h‰p_up¡»am_hash_¤v_cÚf_t
 *
hcf
 = 
cÚf
;

589 
ngx_¡r_t
 *
v®ue
;

590 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
uscf
;

591 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

593 
v®ue
 = 
cf
->
¬gs
->
–ts
;

595 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

597 
ccv
.
cf
 = cf;

598 
ccv
.
v®ue
 = &value[1];

599 
ccv
.
com¶ex_v®ue
 = &
hcf
->
key
;

601 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

602  
NGX_CONF_ERROR
;

605 
uscf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_¤v_cÚf
(
cf
, 
ngx_h‰p_up¡»am_moduË
);

607 ià(
uscf
->
³”
.
š™_up¡»am
) {

608 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

612 
uscf
->
æags
 = 
NGX_HTTP_UPSTREAM_CREATE


613 |
NGX_HTTP_UPSTREAM_WEIGHT


614 |
NGX_HTTP_UPSTREAM_MAX_FAILS


615 |
NGX_HTTP_UPSTREAM_FAIL_TIMEOUT


616 |
NGX_HTTP_UPSTREAM_DOWN
;

618 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

619 
uscf
->
³”
.
š™_up¡»am
 = 
ngx_h‰p_up¡»am_š™_hash
;

621 } ià(
	`ngx_¡rcmp
(
v®ue
[2].
d©a
, "consistent") == 0) {

622 
uscf
->
³”
.
š™_up¡»am
 = 
ngx_h‰p_up¡»am_š™_chash
;

625 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

626 "šv®id…¬am‘” \"%V\"", &
v®ue
[2]);

627  
NGX_CONF_ERROR
;

630  
NGX_CONF_OK
;

631 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_upstream_ip_hash_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

15 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 
	m¼p
;

17 
ngx_ušt_t
 
	mhash
;

19 
u_ch¬
 
	madd¾’
;

20 
u_ch¬
 *
	maddr
;

22 
u_ch¬
 
	mŒ›s
;

24 
ngx_ev’t_g‘_³”_±
 
	mg‘_¼_³”
;

25 } 
	tngx_h‰p_up¡»am__hash_³”_d©a_t
;

28 
ngx_št_t
 
ngx_h‰p_up¡»am_š™__hash_³”
(
ngx_h‰p_»que¡_t
 *
r
,

29 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
);

30 
ngx_št_t
 
ngx_h‰p_up¡»am_g‘__hash_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

31 *
d©a
);

32 *
ngx_h‰p_up¡»am__hash
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

33 *
cÚf
);

36 
ngx_commªd_t
 
	gngx_h‰p_up¡»am__hash_commªds
[] = {

38 { 
ngx_¡ršg
("ip_hash"),

39 
NGX_HTTP_UPS_CONF
|
NGX_CONF_NOARGS
,

40 
ngx_h‰p_up¡»am__hash
,

43 
NULL
 },

45 
ngx_nuÎ_commªd


49 
ngx_h‰p_moduË_t
 
	gngx_h‰p_up¡»am__hash_moduË_ùx
 = {

50 
NULL
,

51 
NULL
,

53 
NULL
,

54 
NULL
,

56 
NULL
,

57 
NULL
,

59 
NULL
,

60 
NULL


64 
ngx_moduË_t
 
	gngx_h‰p_up¡»am__hash_moduË
 = {

65 
NGX_MODULE_V1
,

66 &
ngx_h‰p_up¡»am__hash_moduË_ùx
,

67 
ngx_h‰p_up¡»am__hash_commªds
,

68 
NGX_HTTP_MODULE
,

69 
NULL
,

70 
NULL
,

71 
NULL
,

72 
NULL
,

73 
NULL
,

74 
NULL
,

75 
NULL
,

76 
NGX_MODULE_V1_PADDING


80 
u_ch¬
 
	gngx_h‰p_up¡»am__hash_p£udo_addr
[3];

83 
ngx_št_t


84 
	$ngx_h‰p_up¡»am_š™__hash
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

86 ià(
	`ngx_h‰p_up¡»am_š™_round_robš
(
cf
, 
us
è!ð
NGX_OK
) {

87  
NGX_ERROR
;

90 
us
->
³”
.
š™
 = 
ngx_h‰p_up¡»am_š™__hash_³”
;

92  
NGX_OK
;

93 
	}
}

96 
ngx_št_t


97 
	$ngx_h‰p_up¡»am_š™__hash_³”
(
ngx_h‰p_»que¡_t
 *
r
,

98 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

100 
sockaddr_š
 *
sš
;

101 #ià(
NGX_HAVE_INET6
)

102 
sockaddr_š6
 *
sš6
;

104 
ngx_h‰p_up¡»am__hash_³”_d©a_t
 *
hp
;

106 
hp
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am__hash_³”_d©a_t
));

107 ià(
hp
 =ð
NULL
) {

108  
NGX_ERROR
;

111 
r
->
up¡»am
->
³”
.
d©a
 = &
hp
->
¼p
;

113 ià(
	`ngx_h‰p_up¡»am_š™_round_robš_³”
(
r
, 
us
è!ð
NGX_OK
) {

114  
NGX_ERROR
;

117 
r
->
up¡»am
->
³”
.
g‘
 = 
ngx_h‰p_up¡»am_g‘__hash_³”
;

119 
r
->
cÚÃùiÚ
->
sockaddr
->
§_çmžy
) {

121 
AF_INET
:

122 
sš
 = (
sockaddr_š
 *è
r
->
cÚÃùiÚ
->
sockaddr
;

123 
hp
->
addr
 = (
u_ch¬
 *è&
sš
->
sš_addr
.
s_addr
;

124 
hp
->
add¾’
 = 3;

127 #ià(
NGX_HAVE_INET6
)

128 
AF_INET6
:

129 
sš6
 = (
sockaddr_š6
 *è
r
->
cÚÃùiÚ
->
sockaddr
;

130 
hp
->
addr
 = (
u_ch¬
 *è&
sš6
->
sš6_addr
.
s6_addr
;

131 
hp
->
add¾’
 = 16;

136 
hp
->
addr
 = 
ngx_h‰p_up¡»am__hash_p£udo_addr
;

137 
hp
->
add¾’
 = 3;

140 
hp
->
hash
 = 89;

141 
hp
->
Œ›s
 = 0;

142 
hp
->
g‘_¼_³”
 = 
ngx_h‰p_up¡»am_g‘_round_robš_³”
;

144  
NGX_OK
;

145 
	}
}

148 
ngx_št_t


149 
	$ngx_h‰p_up¡»am_g‘__hash_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

151 
ngx_h‰p_up¡»am__hash_³”_d©a_t
 *
hp
 = 
d©a
;

153 
time_t
 
now
;

154 
ngx_št_t
 
w
;

155 
ušŒ_t
 
m
;

156 
ngx_ušt_t
 
i
, 
n
, 
p
, 
hash
;

157 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

159 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

160 "g‘ i°hash…“r,ry: %ui", 
pc
->
Œ›s
);

164 ià(
hp
->
Œ›s
 > 20 || iphp->
¼p
.
³”s
->
sšgË
) {

165  
hp
->
	`g‘_¼_³”
(
pc
, &hp->
¼p
);

168 
now
 = 
	`ngx_time
();

170 
pc
->
ÿched
 = 0;

171 
pc
->
cÚÃùiÚ
 = 
NULL
;

173 
hash
 = 
hp
->hash;

177 
i
 = 0; i < (
ngx_ušt_t
è
hp
->
add¾’
; i++) {

178 
hash
 = (hash * 113 + 
hp
->
addr
[
i
]) % 6271;

181 ià(!
hp
->
¼p
.
³”s
->
weigh‹d
) {

182 
p
 = 
hash
 % 
hp
->
¼p
.
³”s
->
numb”
;

185 
w
 = 
hash
 % 
hp
->
¼p
.
³”s
->
tÙ®_weight
;

187 
i
 = 0; i < 
hp
->
¼p
.
³”s
->
numb”
; i++) {

188 
w
 -ð
hp
->
¼p
.
³”s
->
³”
[
i
].
weight
;

189 ià(
w
 < 0) {

194 
p
 = 
i
;

197 
n
 = 
p
 / (8 * (
ušŒ_t
));

198 
m
 = (
ušŒ_t
è1 << 
p
 % (8 * (uintptr_t));

200 ià(
hp
->
¼p
.
Œ›d
[
n
] & 
m
) {

201 
Ãxt
;

204 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

205 "g‘ i°hash…“r, hash: %u˜%04XA", 
p
, 
m
);

207 
³”
 = &
hp
->
¼p
.
³”s
->³”[
p
];

211 ià(
³”
->
down
) {

212 
Ãxt_Œy
;

215 ià(
³”
->
max_çžs


216 && 
³”
->
çžs
 >ð³”->
max_çžs


217 && 
now
 - 
³”
->
checked
 <ð³”->
çž_timeout
)

219 
Ãxt_Œy
;

224 
Ãxt_Œy
:

226 
hp
->
¼p
.
Œ›d
[
n
] |ð
m
;

230 
pc
->
Œ›s
--;

232 
Ãxt
:

234 ià(++
hp
->
Œ›s
 > 20) {

235  
hp
->
	`g‘_¼_³”
(
pc
, &hp->
¼p
);

239 
hp
->
¼p
.
cu¼’t
 = 
p
;

241 
pc
->
sockaddr
 = 
³”
->sockaddr;

242 
pc
->
sockËn
 = 
³”
->socklen;

243 
pc
->
Çme
 = &
³”
->name;

245 ià(
now
 - 
³”
->
checked
 >…“r->
çž_timeout
) {

246 
³”
->
checked
 = 
now
;

251 
hp
->
¼p
.
Œ›d
[
n
] |ð
m
;

252 
hp
->
hash
 = hash;

254  
NGX_OK
;

255 
	}
}

259 
	$ngx_h‰p_up¡»am__hash
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

261 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
uscf
;

263 
uscf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_¤v_cÚf
(
cf
, 
ngx_h‰p_up¡»am_moduË
);

265 ià(
uscf
->
³”
.
š™_up¡»am
) {

266 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

270 
uscf
->
³”
.
š™_up¡»am
 = 
ngx_h‰p_up¡»am_š™__hash
;

272 
uscf
->
æags
 = 
NGX_HTTP_UPSTREAM_CREATE


273 |
NGX_HTTP_UPSTREAM_WEIGHT


274 |
NGX_HTTP_UPSTREAM_MAX_FAILS


275 |
NGX_HTTP_UPSTREAM_FAIL_TIMEOUT


276 |
NGX_HTTP_UPSTREAM_DOWN
;

278  
NGX_CONF_OK
;

279 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_upstream_keepalive_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_ušt_t
 
	mmax_ÿched
;

16 
ngx_queue_t
 
	mÿche
;

17 
ngx_queue_t
 
	mä“
;

19 
ngx_h‰p_up¡»am_š™_±
 
	mÜigš®_š™_up¡»am
;

20 
ngx_h‰p_up¡»am_š™_³”_±
 
	mÜigš®_š™_³”
;

22 } 
	tngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
;

26 
ngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
 *
	mcÚf
;

28 
ngx_h‰p_up¡»am_t
 *
	mup¡»am
;

30 *
	md©a
;

32 
ngx_ev’t_g‘_³”_±
 
	mÜigš®_g‘_³”
;

33 
ngx_ev’t_ä“_³”_±
 
	mÜigš®_ä“_³”
;

35 #ià(
NGX_HTTP_SSL
)

36 
ngx_ev’t_£t_³”_£ssiÚ_±
 
	mÜigš®_£t_£ssiÚ
;

37 
ngx_ev’t_§ve_³”_£ssiÚ_±
 
	mÜigš®_§ve_£ssiÚ
;

40 } 
	tngx_h‰p_up¡»am_k“·live_³”_d©a_t
;

44 
ngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
 *
	mcÚf
;

46 
ngx_queue_t
 
	mqueue
;

47 
ngx_cÚÃùiÚ_t
 *
	mcÚÃùiÚ
;

49 
sockËn_t
 
	msockËn
;

50 
u_ch¬
 
	msockaddr
[
NGX_SOCKADDRLEN
];

52 } 
	tngx_h‰p_up¡»am_k“·live_ÿche_t
;

55 
ngx_št_t
 
ngx_h‰p_up¡»am_š™_k“·live_³”
(
ngx_h‰p_»que¡_t
 *
r
,

56 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
);

57 
ngx_št_t
 
ngx_h‰p_up¡»am_g‘_k“·live_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

58 *
d©a
);

59 
ngx_h‰p_up¡»am_ä“_k“·live_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

60 *
d©a
, 
ngx_ušt_t
 
¡©e
);

62 
ngx_h‰p_up¡»am_k“·live_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
);

63 
ngx_h‰p_up¡»am_k“·live_þo£_hªdËr
(
ngx_ev’t_t
 *
ev
);

64 
ngx_h‰p_up¡»am_k“·live_þo£
(
ngx_cÚÃùiÚ_t
 *
c
);

67 #ià(
NGX_HTTP_SSL
)

68 
ngx_št_t
 
ngx_h‰p_up¡»am_k“·live_£t_£ssiÚ
(

69 
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
);

70 
ngx_h‰p_up¡»am_k“·live_§ve_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

71 *
d©a
);

74 *
ngx_h‰p_up¡»am_k“·live_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

75 *
ngx_h‰p_up¡»am_k“·live
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

76 *
cÚf
);

79 
ngx_commªd_t
 
	gngx_h‰p_up¡»am_k“·live_commªds
[] = {

81 { 
ngx_¡ršg
("keepalive"),

82 
NGX_HTTP_UPS_CONF
|
NGX_CONF_TAKE1
,

83 
ngx_h‰p_up¡»am_k“·live
,

84 
NGX_HTTP_SRV_CONF_OFFSET
,

86 
NULL
 },

88 
ngx_nuÎ_commªd


92 
ngx_h‰p_moduË_t
 
	gngx_h‰p_up¡»am_k“·live_moduË_ùx
 = {

93 
NULL
,

94 
NULL
,

96 
NULL
,

97 
NULL
,

99 
ngx_h‰p_up¡»am_k“·live_ü—‹_cÚf
,

100 
NULL
,

102 
NULL
,

103 
NULL


107 
ngx_moduË_t
 
	gngx_h‰p_up¡»am_k“·live_moduË
 = {

108 
NGX_MODULE_V1
,

109 &
ngx_h‰p_up¡»am_k“·live_moduË_ùx
,

110 
ngx_h‰p_up¡»am_k“·live_commªds
,

111 
NGX_HTTP_MODULE
,

112 
NULL
,

113 
NULL
,

114 
NULL
,

115 
NULL
,

116 
NULL
,

117 
NULL
,

118 
NULL
,

119 
NGX_MODULE_V1_PADDING


123 
ngx_št_t


124 
	$ngx_h‰p_up¡»am_š™_k“·live
(
ngx_cÚf_t
 *
cf
,

125 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

127 
ngx_ušt_t
 
i
;

128 
ngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
 *
kcf
;

129 
ngx_h‰p_up¡»am_k“·live_ÿche_t
 *
ÿched
;

131 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
cf
->
log
, 0,

134 
kcf
 = 
	`ngx_h‰p_cÚf_up¡»am_¤v_cÚf
(
us
,

135 
ngx_h‰p_up¡»am_k“·live_moduË
);

137 ià(
kcf
->
	`Üigš®_š™_up¡»am
(
cf
, 
us
è!ð
NGX_OK
) {

138  
NGX_ERROR
;

141 
kcf
->
Üigš®_š™_³”
 = 
us
->
³”
.
š™
;

143 
us
->
³”
.
š™
 = 
ngx_h‰p_up¡»am_š™_k“·live_³”
;

147 
ÿched
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

148 (
ngx_h‰p_up¡»am_k“·live_ÿche_t
è* 
kcf
->
max_ÿched
);

149 ià(
ÿched
 =ð
NULL
) {

150  
NGX_ERROR
;

153 
	`ngx_queue_š™
(&
kcf
->
ÿche
);

154 
	`ngx_queue_š™
(&
kcf
->
ä“
);

156 
i
 = 0; i < 
kcf
->
max_ÿched
; i++) {

157 
	`ngx_queue_š£¹_h—d
(&
kcf
->
ä“
, &
ÿched
[
i
].
queue
);

158 
ÿched
[
i
].
cÚf
 = 
kcf
;

161  
NGX_OK
;

162 
	}
}

165 
ngx_št_t


166 
	$ngx_h‰p_up¡»am_š™_k“·live_³”
(
ngx_h‰p_»que¡_t
 *
r
,

167 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

169 
ngx_h‰p_up¡»am_k“·live_³”_d©a_t
 *
kp
;

170 
ngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
 *
kcf
;

172 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

175 
kcf
 = 
	`ngx_h‰p_cÚf_up¡»am_¤v_cÚf
(
us
,

176 
ngx_h‰p_up¡»am_k“·live_moduË
);

178 
kp
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_k“·live_³”_d©a_t
));

179 ià(
kp
 =ð
NULL
) {

180  
NGX_ERROR
;

183 ià(
kcf
->
	`Üigš®_š™_³”
(
r
, 
us
è!ð
NGX_OK
) {

184  
NGX_ERROR
;

187 
kp
->
cÚf
 = 
kcf
;

188 
kp
->
up¡»am
 = 
r
->upstream;

189 
kp
->
d©a
 = 
r
->
up¡»am
->
³”
.data;

190 
kp
->
Üigš®_g‘_³”
 = 
r
->
up¡»am
->
³”
.
g‘
;

191 
kp
->
Üigš®_ä“_³”
 = 
r
->
up¡»am
->
³”
.
ä“
;

193 
r
->
up¡»am
->
³”
.
d©a
 = 
kp
;

194 
r
->
up¡»am
->
³”
.
g‘
 = 
ngx_h‰p_up¡»am_g‘_k“·live_³”
;

195 
r
->
up¡»am
->
³”
.
ä“
 = 
ngx_h‰p_up¡»am_ä“_k“·live_³”
;

197 #ià(
NGX_HTTP_SSL
)

198 
kp
->
Üigš®_£t_£ssiÚ
 = 
r
->
up¡»am
->
³”
.
£t_£ssiÚ
;

199 
kp
->
Üigš®_§ve_£ssiÚ
 = 
r
->
up¡»am
->
³”
.
§ve_£ssiÚ
;

200 
r
->
up¡»am
->
³”
.
£t_£ssiÚ
 = 
ngx_h‰p_up¡»am_k“·live_£t_£ssiÚ
;

201 
r
->
up¡»am
->
³”
.
§ve_£ssiÚ
 = 
ngx_h‰p_up¡»am_k“·live_§ve_£ssiÚ
;

204  
NGX_OK
;

205 
	}
}

208 
ngx_št_t


209 
	$ngx_h‰p_up¡»am_g‘_k“·live_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

211 
ngx_h‰p_up¡»am_k“·live_³”_d©a_t
 *
kp
 = 
d©a
;

212 
ngx_h‰p_up¡»am_k“·live_ÿche_t
 *
™em
;

214 
ngx_št_t
 
rc
;

215 
ngx_queue_t
 *
q
, *
ÿche
;

216 
ngx_cÚÃùiÚ_t
 *
c
;

218 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

223 
rc
 = 
kp
->
	`Üigš®_g‘_³”
(
pc
, kp->
d©a
);

225 ià(
rc
 !ð
NGX_OK
) {

226  
rc
;

231 
ÿche
 = &
kp
->
cÚf
->cache;

233 
q
 = 
	`ngx_queue_h—d
(
ÿche
);

234 
q
 !ð
	`ngx_queue_£Áš–
(
ÿche
);

235 
q
 = 
	`ngx_queue_Ãxt
(q))

237 
™em
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_up¡»am_k“·live_ÿche_t
, 
queue
);

238 
c
 = 
™em
->
cÚÃùiÚ
;

240 ià(
	`ngx_memn2cmp
((
u_ch¬
 *è&
™em
->
sockaddr
, (u_ch¬ *è
pc
->sockaddr,

241 
™em
->
sockËn
, 
pc
->socklen)

244 
	`ngx_queue_»move
(
q
);

245 
	`ngx_queue_š£¹_h—d
(&
kp
->
cÚf
->
ä“
, 
q
);

247 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

248 "g‘ k“·liv³”: usšg cÚÃùiÚ %p", 
c
);

250 
c
->
idË
 = 0;

251 
c
->
£Á
 = 0;

252 
c
->
log
 = 
pc
->log;

253 
c
->
»ad
->
log
 = 
pc
->log;

254 
c
->
wr™e
->
log
 = 
pc
->log;

255 
c
->
poÞ
->
log
 = 
pc
->log;

257 
pc
->
cÚÃùiÚ
 = 
c
;

258 
pc
->
ÿched
 = 1;

260  
NGX_DONE
;

264  
NGX_OK
;

265 
	}
}

269 
	$ngx_h‰p_up¡»am_ä“_k“·live_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
,

270 
ngx_ušt_t
 
¡©e
)

272 
ngx_h‰p_up¡»am_k“·live_³”_d©a_t
 *
kp
 = 
d©a
;

273 
ngx_h‰p_up¡»am_k“·live_ÿche_t
 *
™em
;

275 
ngx_queue_t
 *
q
;

276 
ngx_cÚÃùiÚ_t
 *
c
;

277 
ngx_h‰p_up¡»am_t
 *
u
;

279 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

284 
u
 = 
kp
->
up¡»am
;

285 
c
 = 
pc
->
cÚÃùiÚ
;

287 ià(
¡©e
 & 
NGX_PEER_FAILED


288 || 
c
 =ð
NULL


289 || 
c
->
»ad
->
eof


290 || 
c
->
»ad
->
”rÜ


291 || 
c
->
»ad
->
timedout


292 || 
c
->
wr™e
->
”rÜ


293 || 
c
->
wr™e
->
timedout
)

295 
šv®id
;

298 ià(!
u
->
k“·live
) {

299 
šv®id
;

302 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

303 
šv®id
;

306 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

307 "ä“ k“·liv³”: savšg cÚÃùiÚ %p", 
c
);

309 ià(
	`ngx_queue_em±y
(&
kp
->
cÚf
->
ä“
)) {

311 
q
 = 
	`ngx_queue_Ï¡
(&
kp
->
cÚf
->
ÿche
);

312 
	`ngx_queue_»move
(
q
);

314 
™em
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_up¡»am_k“·live_ÿche_t
, 
queue
);

316 
	`ngx_h‰p_up¡»am_k“·live_þo£
(
™em
->
cÚÃùiÚ
);

319 
q
 = 
	`ngx_queue_h—d
(&
kp
->
cÚf
->
ä“
);

320 
	`ngx_queue_»move
(
q
);

322 
™em
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_up¡»am_k“·live_ÿche_t
, 
queue
);

325 
™em
->
cÚÃùiÚ
 = 
c
;

326 
	`ngx_queue_š£¹_h—d
(&
kp
->
cÚf
->
ÿche
, 
q
);

328 
pc
->
cÚÃùiÚ
 = 
NULL
;

330 ià(
c
->
»ad
->
tim”_£t
) {

331 
	`ngx_d–_tim”
(
c
->
»ad
);

333 ià(
c
->
wr™e
->
tim”_£t
) {

334 
	`ngx_d–_tim”
(
c
->
wr™e
);

337 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_up¡»am_k“·live_dummy_hªdËr
;

338 
c
->
»ad
->
hªdËr
 = 
ngx_h‰p_up¡»am_k“·live_þo£_hªdËr
;

340 
c
->
d©a
 = 
™em
;

341 
c
->
idË
 = 1;

342 
c
->
log
 = 
ngx_cyþe
->log;

343 
c
->
»ad
->
log
 = 
ngx_cyþe
->log;

344 
c
->
wr™e
->
log
 = 
ngx_cyþe
->log;

345 
c
->
poÞ
->
log
 = 
ngx_cyþe
->log;

347 
™em
->
sockËn
 = 
pc
->socklen;

348 
	`ngx_memýy
(&
™em
->
sockaddr
, 
pc
->sockaddr,…c->
sockËn
);

350 ià(
c
->
»ad
->
»ady
) {

351 
	`ngx_h‰p_up¡»am_k“·live_þo£_hªdËr
(
c
->
»ad
);

354 
šv®id
:

356 
kp
->
	`Üigš®_ä“_³”
(
pc
, kp->
d©a
, 
¡©e
);

357 
	}
}

361 
	$ngx_h‰p_up¡»am_k“·live_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
)

363 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ev
->
log
, 0,

365 
	}
}

369 
	$ngx_h‰p_up¡»am_k“·live_þo£_hªdËr
(
ngx_ev’t_t
 *
ev
)

371 
ngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
 *
cÚf
;

372 
ngx_h‰p_up¡»am_k“·live_ÿche_t
 *
™em
;

374 
n
;

375 
buf
[1];

376 
ngx_cÚÃùiÚ_t
 *
c
;

378 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ev
->
log
, 0,

381 
c
 = 
ev
->
d©a
;

383 ià(
c
->
þo£
) {

384 
þo£
;

387 
n
 = 
	`»cv
(
c
->
fd
, 
buf
, 1, 
MSG_PEEK
);

389 ià(
n
 =ð-1 && 
ngx_sock‘_”ºo
 =ð
NGX_EAGAIN
) {

392 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

393 
þo£
;

399 
þo£
:

401 
™em
 = 
c
->
d©a
;

402 
cÚf
 = 
™em
->conf;

404 
	`ngx_h‰p_up¡»am_k“·live_þo£
(
c
);

406 
	`ngx_queue_»move
(&
™em
->
queue
);

407 
	`ngx_queue_š£¹_h—d
(&
cÚf
->
ä“
, &
™em
->
queue
);

408 
	}
}

412 
	$ngx_h‰p_up¡»am_k“·live_þo£
(
ngx_cÚÃùiÚ_t
 *
c
)

415 #ià(
NGX_HTTP_SSL
)

417 ià(
c
->
s¦
) {

418 
c
->
s¦
->
no_wa™_shutdown
 = 1;

419 
c
->
s¦
->
no_£nd_shutdown
 = 1;

421 ià(
	`ngx_s¦_shutdown
(
c
è=ð
NGX_AGAIN
) {

422 
c
->
s¦
->
hªdËr
 = 
ngx_h‰p_up¡»am_k“·live_þo£
;

429 
	`ngx_de¡roy_poÞ
(
c
->
poÞ
);

430 
	`ngx_þo£_cÚÃùiÚ
(
c
);

431 
	}
}

434 #ià(
NGX_HTTP_SSL
)

436 
ngx_št_t


437 
	$ngx_h‰p_up¡»am_k“·live_£t_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

439 
ngx_h‰p_up¡»am_k“·live_³”_d©a_t
 *
kp
 = 
d©a
;

441  
kp
->
	`Üigš®_£t_£ssiÚ
(
pc
, kp->
d©a
);

442 
	}
}

446 
	$ngx_h‰p_up¡»am_k“·live_§ve_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

448 
ngx_h‰p_up¡»am_k“·live_³”_d©a_t
 *
kp
 = 
d©a
;

450 
kp
->
	`Üigš®_§ve_£ssiÚ
(
pc
, kp->
d©a
);

452 
	}
}

458 
	$ngx_h‰p_up¡»am_k“·live_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

460 
ngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
 *
cÚf
;

462 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

463 (
ngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
));

464 ià(
cÚf
 =ð
NULL
) {

465  
NULL
;

475 
cÚf
->
max_ÿched
 = 1;

477  
cÚf
;

478 
	}
}

482 
	$ngx_h‰p_up¡»am_k“·live
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

484 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
uscf
;

485 
ngx_h‰p_up¡»am_k“·live_¤v_cÚf_t
 *
kcf
 = 
cÚf
;

487 
ngx_št_t
 
n
;

488 
ngx_¡r_t
 *
v®ue
;

490 
uscf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_¤v_cÚf
(
cf
, 
ngx_h‰p_up¡»am_moduË
);

492 ià(
kcf
->
Üigš®_š™_up¡»am
) {

496 
kcf
->
Üigš®_š™_up¡»am
 = 
uscf
->
³”
.
š™_up¡»am


497 ? 
uscf
->
³”
.
š™_up¡»am


498 : 
ngx_h‰p_up¡»am_š™_round_robš
;

500 
uscf
->
³”
.
š™_up¡»am
 = 
ngx_h‰p_up¡»am_š™_k“·live
;

504 
v®ue
 = 
cf
->
¬gs
->
–ts
;

506 
n
 = 
	`ngx_©oi
(
v®ue
[1].
d©a
, v®ue[1].
Ën
);

508 ià(
n
 =ð
NGX_ERROR
 ||‚ == 0) {

509 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

511 &
v®ue
[1], &
cmd
->
Çme
);

512  
NGX_CONF_ERROR
;

515 
kcf
->
max_ÿched
 = 
n
;

517  
NGX_CONF_OK
;

518 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_upstream_least_conn_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_ušt_t
 *
	mcÚns
;

15 } 
	tngx_h‰p_up¡»am_Ëa¡_cÚn_cÚf_t
;

20 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 
	m¼p
;

22 
ngx_ušt_t
 *
	mcÚns
;

24 
ngx_ev’t_g‘_³”_±
 
	mg‘_¼_³”
;

25 
ngx_ev’t_ä“_³”_±
 
	mä“_¼_³”
;

26 } 
	tngx_h‰p_up¡»am_lc_³”_d©a_t
;

29 
ngx_št_t
 
ngx_h‰p_up¡»am_š™_Ëa¡_cÚn_³”
(
ngx_h‰p_»que¡_t
 *
r
,

30 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
);

31 
ngx_št_t
 
ngx_h‰p_up¡»am_g‘_Ëa¡_cÚn_³”
(

32 
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
);

33 
ngx_h‰p_up¡»am_ä“_Ëa¡_cÚn_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

34 *
d©a
, 
ngx_ušt_t
 
¡©e
);

35 *
ngx_h‰p_up¡»am_Ëa¡_cÚn_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

36 *
ngx_h‰p_up¡»am_Ëa¡_cÚn
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

37 *
cÚf
);

40 
ngx_commªd_t
 
	gngx_h‰p_up¡»am_Ëa¡_cÚn_commªds
[] = {

42 { 
ngx_¡ršg
("least_conn"),

43 
NGX_HTTP_UPS_CONF
|
NGX_CONF_NOARGS
,

44 
ngx_h‰p_up¡»am_Ëa¡_cÚn
,

47 
NULL
 },

49 
ngx_nuÎ_commªd


53 
ngx_h‰p_moduË_t
 
	gngx_h‰p_up¡»am_Ëa¡_cÚn_moduË_ùx
 = {

54 
NULL
,

55 
NULL
,

57 
NULL
,

58 
NULL
,

60 
ngx_h‰p_up¡»am_Ëa¡_cÚn_ü—‹_cÚf
,

61 
NULL
,

63 
NULL
,

64 
NULL


68 
ngx_moduË_t
 
	gngx_h‰p_up¡»am_Ëa¡_cÚn_moduË
 = {

69 
NGX_MODULE_V1
,

70 &
ngx_h‰p_up¡»am_Ëa¡_cÚn_moduË_ùx
,

71 
ngx_h‰p_up¡»am_Ëa¡_cÚn_commªds
,

72 
NGX_HTTP_MODULE
,

73 
NULL
,

74 
NULL
,

75 
NULL
,

76 
NULL
,

77 
NULL
,

78 
NULL
,

79 
NULL
,

80 
NGX_MODULE_V1_PADDING


84 
ngx_št_t


85 
	$ngx_h‰p_up¡»am_š™_Ëa¡_cÚn
(
ngx_cÚf_t
 *
cf
,

86 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

88 
ngx_ušt_t
 
n
;

89 
ngx_h‰p_up¡»am_¼_³”s_t
 *
³”s
;

90 
ngx_h‰p_up¡»am_Ëa¡_cÚn_cÚf_t
 *
lcf
;

92 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
cf
->
log
, 0,

95 ià(
	`ngx_h‰p_up¡»am_š™_round_robš
(
cf
, 
us
è!ð
NGX_OK
) {

96  
NGX_ERROR
;

99 
³”s
 = 
us
->
³”
.
d©a
;

101 
n
 = 
³”s
->
numb”
;

103 ià(
³”s
->
Ãxt
) {

104 
n
 +ð
³”s
->
Ãxt
->
numb”
;

107 
lcf
 = 
	`ngx_h‰p_cÚf_up¡»am_¤v_cÚf
(
us
,

108 
ngx_h‰p_up¡»am_Ëa¡_cÚn_moduË
);

110 
lcf
->
cÚns
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_ušt_t
è* 
n
);

111 ià(
lcf
->
cÚns
 =ð
NULL
) {

112  
NGX_ERROR
;

115 
us
->
³”
.
š™
 = 
ngx_h‰p_up¡»am_š™_Ëa¡_cÚn_³”
;

117  
NGX_OK
;

118 
	}
}

121 
ngx_št_t


122 
	$ngx_h‰p_up¡»am_š™_Ëa¡_cÚn_³”
(
ngx_h‰p_»que¡_t
 *
r
,

123 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

125 
ngx_h‰p_up¡»am_lc_³”_d©a_t
 *
lý
;

126 
ngx_h‰p_up¡»am_Ëa¡_cÚn_cÚf_t
 *
lcf
;

128 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

131 
lcf
 = 
	`ngx_h‰p_cÚf_up¡»am_¤v_cÚf
(
us
,

132 
ngx_h‰p_up¡»am_Ëa¡_cÚn_moduË
);

134 
lý
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_lc_³”_d©a_t
));

135 ià(
lý
 =ð
NULL
) {

136  
NGX_ERROR
;

139 
lý
->
cÚns
 = 
lcf
->conns;

141 
r
->
up¡»am
->
³”
.
d©a
 = &
lý
->
¼p
;

143 ià(
	`ngx_h‰p_up¡»am_š™_round_robš_³”
(
r
, 
us
è!ð
NGX_OK
) {

144  
NGX_ERROR
;

147 
r
->
up¡»am
->
³”
.
g‘
 = 
ngx_h‰p_up¡»am_g‘_Ëa¡_cÚn_³”
;

148 
r
->
up¡»am
->
³”
.
ä“
 = 
ngx_h‰p_up¡»am_ä“_Ëa¡_cÚn_³”
;

150 
lý
->
g‘_¼_³”
 = 
ngx_h‰p_up¡»am_g‘_round_robš_³”
;

151 
lý
->
ä“_¼_³”
 = 
ngx_h‰p_up¡»am_ä“_round_robš_³”
;

153  
NGX_OK
;

154 
	}
}

157 
ngx_št_t


158 
	$ngx_h‰p_up¡»am_g‘_Ëa¡_cÚn_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

160 
ngx_h‰p_up¡»am_lc_³”_d©a_t
 *
lý
 = 
d©a
;

162 
time_t
 
now
;

163 
ušŒ_t
 
m
;

164 
ngx_št_t
 
rc
, 
tÙ®
;

165 
ngx_ušt_t
 
i
, 
n
, 
p
, 
mªy
;

166 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
, *
be¡
;

167 
ngx_h‰p_up¡»am_¼_³”s_t
 *
³”s
;

169 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

170 "g‘†—¡ cÚÀ³”,ry: %ui", 
pc
->
Œ›s
);

172 ià(
lý
->
¼p
.
³”s
->
sšgË
) {

173  
lý
->
	`g‘_¼_³”
(
pc
, &lý->
¼p
);

176 
pc
->
ÿched
 = 0;

177 
pc
->
cÚÃùiÚ
 = 
NULL
;

179 
now
 = 
	`ngx_time
();

181 
³”s
 = 
lý
->
¼p
.peers;

183 
be¡
 = 
NULL
;

184 
tÙ®
 = 0;

186 #ià(
NGX_SUPPRESS_WARN
)

187 
mªy
 = 0;

188 
p
 = 0;

191 
i
 = 0; i < 
³”s
->
numb”
; i++) {

193 
n
 = 
i
 / (8 * (
ušŒ_t
));

194 
m
 = (
ušŒ_t
è1 << 
i
 % (8 * (uintptr_t));

196 ià(
lý
->
¼p
.
Œ›d
[
n
] & 
m
) {

200 
³”
 = &
³”s
->³”[
i
];

202 ià(
³”
->
down
) {

206 ià(
³”
->
max_çžs


207 && 
³”
->
çžs
 >ð³”->
max_çžs


208 && 
now
 - 
³”
->
checked
 <ð³”->
çž_timeout
)

219 ià(
be¡
 =ð
NULL


220 || 
lý
->
cÚns
[
i
] * 
be¡
->
weight
 <†ý->cÚns[
p
] * 
³”
->weight)

222 
be¡
 = 
³”
;

223 
mªy
 = 0;

224 
p
 = 
i
;

226 } ià(
lý
->
cÚns
[
i
] * 
be¡
->
weight


227 =ð
lý
->
cÚns
[
p
] * 
³”
->
weight
)

229 
mªy
 = 1;

233 ià(
be¡
 =ð
NULL
) {

234 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

237 
çžed
;

240 ià(
mªy
) {

241 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

244 
i
 = 
p
; i < 
³”s
->
numb”
; i++) {

246 
n
 = 
i
 / (8 * (
ušŒ_t
));

247 
m
 = (
ušŒ_t
è1 << 
i
 % (8 * (uintptr_t));

249 ià(
lý
->
¼p
.
Œ›d
[
n
] & 
m
) {

253 
³”
 = &
³”s
->³”[
i
];

255 ià(
³”
->
down
) {

259 ià(
lý
->
cÚns
[
i
] * 
be¡
->
weight
 !ðlý->cÚns[
p
] * 
³”
->weight) {

263 ià(
³”
->
max_çžs


264 && 
³”
->
çžs
 >ð³”->
max_çžs


265 && 
now
 - 
³”
->
checked
 <ð³”->
çž_timeout
)

270 
³”
->
cu¼’t_weight
 +ð³”->
efãùive_weight
;

271 
tÙ®
 +ð
³”
->
efãùive_weight
;

273 ià(
³”
->
efãùive_weight
 <…“r->
weight
) {

274 
³”
->
efãùive_weight
++;

277 ià(
³”
->
cu¼’t_weight
 > 
be¡
->current_weight) {

278 
be¡
 = 
³”
;

279 
p
 = 
i
;

284 
be¡
->
cu¼’t_weight
 -ð
tÙ®
;

286 ià(
now
 - 
be¡
->
checked
 > be¡->
çž_timeout
) {

287 
be¡
->
checked
 = 
now
;

290 
pc
->
sockaddr
 = 
be¡
->sockaddr;

291 
pc
->
sockËn
 = 
be¡
->socklen;

292 
pc
->
Çme
 = &
be¡
->name;

294 
lý
->
¼p
.
cu¼’t
 = 
p
;

296 
n
 = 
p
 / (8 * (
ušŒ_t
));

297 
m
 = (
ušŒ_t
è1 << 
p
 % (8 * (uintptr_t));

299 
lý
->
¼p
.
Œ›d
[
n
] |ð
m
;

300 
lý
->
cÚns
[
p
]++;

302  
NGX_OK
;

304 
çžed
:

306 ià(
³”s
->
Ãxt
) {

307 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

310 
lý
->
cÚns
 +ð
³”s
->
numb”
;

312 
lý
->
¼p
.
³”s
 =…“rs->
Ãxt
;

314 
n
 = (
lý
->
¼p
.
³”s
->
numb”
 + (8 * (
ušŒ_t
) - 1))

315 / (8 * (
ušŒ_t
));

317 
i
 = 0; i < 
n
; i++) {

318 
lý
->
¼p
.
Œ›d
[
i
] = 0;

321 
rc
 = 
	`ngx_h‰p_up¡»am_g‘_Ëa¡_cÚn_³”
(
pc
, 
lý
);

323 ià(
rc
 !ð
NGX_BUSY
) {

324  
rc
;

330 
i
 = 0; i < 
³”s
->
numb”
; i++) {

331 
³”s
->
³”
[
i
].
çžs
 = 0;

334 
pc
->
Çme
 = 
³”s
->name;

336  
NGX_BUSY
;

337 
	}
}

341 
	$ngx_h‰p_up¡»am_ä“_Ëa¡_cÚn_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

342 *
d©a
, 
ngx_ušt_t
 
¡©e
)

344 
ngx_h‰p_up¡»am_lc_³”_d©a_t
 *
lý
 = 
d©a
;

346 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

347 "ä“†—¡ cÚÀ³” %u˜%ui", 
pc
->
Œ›s
, 
¡©e
);

349 ià(
lý
->
¼p
.
³”s
->
sšgË
) {

350 
lý
->
	`ä“_¼_³”
(
pc
, &lý->
¼p
, 
¡©e
);

354 
lý
->
cÚns
[lý->
¼p
.
cu¼’t
]--;

356 
lý
->
	`ä“_¼_³”
(
pc
, &lý->
¼p
, 
¡©e
);

357 
	}
}

361 
	$ngx_h‰p_up¡»am_Ëa¡_cÚn_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

363 
ngx_h‰p_up¡»am_Ëa¡_cÚn_cÚf_t
 *
cÚf
;

365 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

366 (
ngx_h‰p_up¡»am_Ëa¡_cÚn_cÚf_t
));

367 ià(
cÚf
 =ð
NULL
) {

368  
NULL
;

377  
cÚf
;

378 
	}
}

382 
	$ngx_h‰p_up¡»am_Ëa¡_cÚn
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

384 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
uscf
;

386 
uscf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_¤v_cÚf
(
cf
, 
ngx_h‰p_up¡»am_moduË
);

388 ià(
uscf
->
³”
.
š™_up¡»am
) {

389 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

393 
uscf
->
³”
.
š™_up¡»am
 = 
ngx_h‰p_up¡»am_š™_Ëa¡_cÚn
;

395 
uscf
->
æags
 = 
NGX_HTTP_UPSTREAM_CREATE


396 |
NGX_HTTP_UPSTREAM_WEIGHT


397 |
NGX_HTTP_UPSTREAM_MAX_FAILS


398 |
NGX_HTTP_UPSTREAM_FAIL_TIMEOUT


399 |
NGX_HTTP_UPSTREAM_DOWN


400 |
NGX_HTTP_UPSTREAM_BACKUP
;

402  
NGX_CONF_OK
;

403 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_userid_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
	#NGX_HTTP_USERID_OFF
 0

	)

14 
	#NGX_HTTP_USERID_LOG
 1

	)

15 
	#NGX_HTTP_USERID_V1
 2

	)

16 
	#NGX_HTTP_USERID_ON
 3

	)

19 
	#NGX_HTTP_USERID_MAX_EXPIRES
 2145916555

	)

23 
ngx_ušt_t
 
	m’abË
;

25 
ngx_št_t
 
	m£rviû
;

27 
ngx_¡r_t
 
	mÇme
;

28 
ngx_¡r_t
 
	mdomaš
;

29 
ngx_¡r_t
 
	m·th
;

30 
ngx_¡r_t
 
	mp3p
;

32 
time_t
 
	mexpœes
;

34 
u_ch¬
 
	mm¬k
;

35 } 
	tngx_h‰p_u£rid_cÚf_t
;

39 
ušt32_t
 
	muid_gÙ
[4];

40 
ušt32_t
 
	muid_£t
[4];

41 
ngx_¡r_t
 
	mcook›
;

42 
ngx_ušt_t
 
	m»£t
;

43 } 
	tngx_h‰p_u£rid_ùx_t
;

46 
ngx_h‰p_u£rid_ùx_t
 *
ngx_h‰p_u£rid_g‘_uid
(
ngx_h‰p_»que¡_t
 *
r
,

47 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
);

48 
ngx_št_t
 
ngx_h‰p_u£rid_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

49 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ngx_¡r_t
 *
Çme
, 
ušt32_t
 *
uid
);

50 
ngx_št_t
 
ngx_h‰p_u£rid_£t_uid
(
ngx_h‰p_»que¡_t
 *
r
,

51 
ngx_h‰p_u£rid_ùx_t
 *
ùx
, 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
);

52 
ngx_št_t
 
ngx_h‰p_u£rid_ü—‹_uid
(
ngx_h‰p_»que¡_t
 *
r
,

53 
ngx_h‰p_u£rid_ùx_t
 *
ùx
, 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
);

55 
ngx_št_t
 
ngx_h‰p_u£rid_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

56 
ngx_št_t
 
ngx_h‰p_u£rid_š™
(
ngx_cÚf_t
 *
cf
);

57 *
ngx_h‰p_u£rid_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

58 *
ngx_h‰p_u£rid_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

59 *
chžd
);

60 *
ngx_h‰p_u£rid_domaš
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

61 *
ngx_h‰p_u£rid_·th
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

62 *
ngx_h‰p_u£rid_expœes
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

63 *
cÚf
);

64 *
ngx_h‰p_u£rid_p3p
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

65 *
ngx_h‰p_u£rid_m¬k
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

66 *
cÚf
);

67 
ngx_št_t
 
ngx_h‰p_u£rid_š™_wÜk”
(
ngx_cyþe_t
 *
cyþe
);

71 
ušt32_t
 
	g¡¬t_v®ue
;

72 
ušt32_t
 
	g£qu’ûr_v1
 = 1;

73 
ušt32_t
 
	g£qu’ûr_v2
 = 0x03030302;

76 
u_ch¬
 
	gexpœes
[] = ";ƒxpires=Thu, 31-Dec-37 23:55:55 GMT";

79 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

82 
ngx_cÚf_’um_t
 
	gngx_h‰p_u£rid_¡©e
[] = {

83 { 
ngx_¡ršg
("off"), 
NGX_HTTP_USERID_OFF
 },

84 { 
ngx_¡ršg
("log"), 
NGX_HTTP_USERID_LOG
 },

85 { 
ngx_¡ršg
("v1"), 
NGX_HTTP_USERID_V1
 },

86 { 
ngx_¡ršg
("Ú"), 
NGX_HTTP_USERID_ON
 },

87 { 
ngx_nuÎ_¡ršg
, 0 }

91 
ngx_cÚf_po¡_hªdËr_±
 
	gngx_h‰p_u£rid_domaš_p
 =

92 
ngx_h‰p_u£rid_domaš
;

93 
ngx_cÚf_po¡_hªdËr_±
 
	gngx_h‰p_u£rid_·th_p
 = 
ngx_h‰p_u£rid_·th
;

94 
ngx_cÚf_po¡_hªdËr_±
 
	gngx_h‰p_u£rid_p3p_p
 = 
ngx_h‰p_u£rid_p3p
;

97 
ngx_commªd_t
 
	gngx_h‰p_u£rid_commªds
[] = {

99 { 
ngx_¡ršg
("userid"),

100 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

101 
ngx_cÚf_£t_’um_¦Ù
,

102 
NGX_HTTP_LOC_CONF_OFFSET
,

103 
off£tof
(
ngx_h‰p_u£rid_cÚf_t
, 
’abË
),

104 
ngx_h‰p_u£rid_¡©e
 },

106 { 
ngx_¡ršg
("userid_service"),

107 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

108 
ngx_cÚf_£t_num_¦Ù
,

109 
NGX_HTTP_LOC_CONF_OFFSET
,

110 
off£tof
(
ngx_h‰p_u£rid_cÚf_t
, 
£rviû
),

111 
NULL
 },

113 { 
ngx_¡ršg
("userid_name"),

114 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

115 
ngx_cÚf_£t_¡r_¦Ù
,

116 
NGX_HTTP_LOC_CONF_OFFSET
,

117 
off£tof
(
ngx_h‰p_u£rid_cÚf_t
, 
Çme
),

118 
NULL
 },

120 { 
ngx_¡ršg
("userid_domain"),

121 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

122 
ngx_cÚf_£t_¡r_¦Ù
,

123 
NGX_HTTP_LOC_CONF_OFFSET
,

124 
off£tof
(
ngx_h‰p_u£rid_cÚf_t
, 
domaš
),

125 &
ngx_h‰p_u£rid_domaš_p
 },

127 { 
ngx_¡ršg
("userid_path"),

128 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

129 
ngx_cÚf_£t_¡r_¦Ù
,

130 
NGX_HTTP_LOC_CONF_OFFSET
,

131 
off£tof
(
ngx_h‰p_u£rid_cÚf_t
, 
·th
),

132 &
ngx_h‰p_u£rid_·th_p
 },

134 { 
ngx_¡ršg
("userid_expires"),

135 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

136 
ngx_h‰p_u£rid_expœes
,

137 
NGX_HTTP_LOC_CONF_OFFSET
,

139 
NULL
 },

141 { 
ngx_¡ršg
("userid_p3p"),

142 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

143 
ngx_cÚf_£t_¡r_¦Ù
,

144 
NGX_HTTP_LOC_CONF_OFFSET
,

145 
off£tof
(
ngx_h‰p_u£rid_cÚf_t
, 
p3p
),

146 &
ngx_h‰p_u£rid_p3p_p
 },

148 { 
ngx_¡ršg
("userid_mark"),

149 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

150 
ngx_h‰p_u£rid_m¬k
,

151 
NGX_HTTP_LOC_CONF_OFFSET
,

153 
NULL
 },

155 
ngx_nuÎ_commªd


159 
ngx_h‰p_moduË_t
 
	gngx_h‰p_u£rid_fž‹r_moduË_ùx
 = {

160 
ngx_h‰p_u£rid_add_v¬ŸbËs
,

161 
ngx_h‰p_u£rid_š™
,

163 
NULL
,

164 
NULL
,

166 
NULL
,

167 
NULL
,

169 
ngx_h‰p_u£rid_ü—‹_cÚf
,

170 
ngx_h‰p_u£rid_m”ge_cÚf


174 
ngx_moduË_t
 
	gngx_h‰p_u£rid_fž‹r_moduË
 = {

175 
NGX_MODULE_V1
,

176 &
ngx_h‰p_u£rid_fž‹r_moduË_ùx
,

177 
ngx_h‰p_u£rid_commªds
,

178 
NGX_HTTP_MODULE
,

179 
NULL
,

180 
NULL
,

181 
ngx_h‰p_u£rid_š™_wÜk”
,

182 
NULL
,

183 
NULL
,

184 
NULL
,

185 
NULL
,

186 
NGX_MODULE_V1_PADDING


190 
ngx_¡r_t
 
	gngx_h‰p_u£rid_gÙ
 = 
ngx_¡ršg
("uid_got");

191 
ngx_¡r_t
 
	gngx_h‰p_u£rid_£t
 = 
ngx_¡ršg
("uid_set");

192 
ngx_¡r_t
 
	gngx_h‰p_u£rid_»£t
 = 
ngx_¡ršg
("uid_reset");

193 
ngx_ušt_t
 
	gngx_h‰p_u£rid_»£t_šdex
;

196 
ngx_št_t


197 
	$ngx_h‰p_u£rid_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

199 
ngx_h‰p_u£rid_ùx_t
 *
ùx
;

200 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
;

202 ià(
r
 !ðr->
maš
) {

203  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

206 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_u£rid_fž‹r_moduË
);

208 ià(
cÚf
->
’abË
 < 
NGX_HTTP_USERID_V1
) {

209  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

212 
ùx
 = 
	`ngx_h‰p_u£rid_g‘_uid
(
r
, 
cÚf
);

214 ià(
ùx
 =ð
NULL
) {

215  
NGX_ERROR
;

218 ià(
	`ngx_h‰p_u£rid_£t_uid
(
r
, 
ùx
, 
cÚf
è=ð
NGX_OK
) {

219  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

222  
NGX_ERROR
;

223 
	}
}

226 
ngx_št_t


227 
	$ngx_h‰p_u£rid_gÙ_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

228 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

230 
ngx_h‰p_u£rid_ùx_t
 *
ùx
;

231 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
;

233 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
->
maš
, 
ngx_h‰p_u£rid_fž‹r_moduË
);

235 ià(
cÚf
->
’abË
 =ð
NGX_HTTP_USERID_OFF
) {

236 
v
->
nÙ_found
 = 1;

237  
NGX_OK
;

240 
ùx
 = 
	`ngx_h‰p_u£rid_g‘_uid
(
r
->
maš
, 
cÚf
);

242 ià(
ùx
 =ð
NULL
) {

243  
NGX_ERROR
;

246 ià(
ùx
->
uid_gÙ
[3] != 0) {

247  
	`ngx_h‰p_u£rid_v¬ŸbË
(
r
->
maš
, 
v
, &
cÚf
->
Çme
, 
ùx
->
uid_gÙ
);

250 
v
->
nÙ_found
 = 1;

252  
NGX_OK
;

253 
	}
}

256 
ngx_št_t


257 
	$ngx_h‰p_u£rid_£t_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

258 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

260 
ngx_h‰p_u£rid_ùx_t
 *
ùx
;

261 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
;

263 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
->
maš
, 
ngx_h‰p_u£rid_fž‹r_moduË
);

265 ià(
cÚf
->
’abË
 < 
NGX_HTTP_USERID_V1
) {

266 
v
->
nÙ_found
 = 1;

267  
NGX_OK
;

270 
ùx
 = 
	`ngx_h‰p_u£rid_g‘_uid
(
r
->
maš
, 
cÚf
);

272 ià(
ùx
 =ð
NULL
) {

273  
NGX_ERROR
;

276 ià(
	`ngx_h‰p_u£rid_ü—‹_uid
(
r
->
maš
, 
ùx
, 
cÚf
è!ð
NGX_OK
) {

277  
NGX_ERROR
;

280 ià(
ùx
->
uid_£t
[3] == 0) {

281 
v
->
nÙ_found
 = 1;

282  
NGX_OK
;

285  
	`ngx_h‰p_u£rid_v¬ŸbË
(
r
->
maš
, 
v
, &
cÚf
->
Çme
, 
ùx
->
uid_£t
);

286 
	}
}

289 
ngx_h‰p_u£rid_ùx_t
 *

290 
	$ngx_h‰p_u£rid_g‘_uid
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
)

292 
ngx_št_t
 
n
;

293 
ngx_¡r_t
 
¤c
, 
d¡
;

294 
ngx_bË_–t_t
 **
cook›s
;

295 
ngx_h‰p_u£rid_ùx_t
 *
ùx
;

297 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_u£rid_fž‹r_moduË
);

299 ià(
ùx
) {

300  
ùx
;

303 ià(
ùx
 =ð
NULL
) {

304 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_u£rid_ùx_t
));

305 ià(
ùx
 =ð
NULL
) {

306  
NULL
;

309 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_u£rid_fž‹r_moduË
);

312 
n
 = 
	`ngx_h‰p_·r£_muÉi_h—d”_lšes
(&
r
->
h—d”s_š
.
cook›s
, &
cÚf
->
Çme
,

313 &
ùx
->
cook›
);

314 ià(
n
 =ð
NGX_DECLINED
) {

315  
ùx
;

318 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

319 "uid cook›: \"%V\"", &
ùx
->
cook›
);

321 ià(
ùx
->
cook›
.
Ën
 < 22) {

322 
cook›s
 = 
r
->
h—d”s_š
.cook›s.
–ts
;

323 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

325 &
cook›s
[
n
]->
v®ue
);

326  
ùx
;

329 
¤c
 = 
ùx
->
cook›
;

338 
¤c
.
Ën
 = 22;

340 
d¡
.
d©a
 = (
u_ch¬
 *è
ùx
->
uid_gÙ
;

342 ià(
	`ngx_decode_ba£64
(&
d¡
, &
¤c
è=ð
NGX_ERROR
) {

343 
cook›s
 = 
r
->
h—d”s_š
.cook›s.
–ts
;

344 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

346 &
cook›s
[
n
]->
v®ue
);

347  
ùx
;

350 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

352 
ùx
->
uid_gÙ
[0], ctx->uid_got[1],

353 
ùx
->
uid_gÙ
[2], ctx->uid_got[3]);

355  
ùx
;

356 
	}
}

359 
ngx_št_t


360 
	$ngx_h‰p_u£rid_£t_uid
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_u£rid_ùx_t
 *
ùx
,

361 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
)

363 
u_ch¬
 *
cook›
, *
p
;

364 
size_t
 
Ën
;

365 
ngx_¡r_t
 
¤c
, 
d¡
;

366 
ngx_bË_–t_t
 *
£t_cook›
, *
p3p
;

368 ià(
	`ngx_h‰p_u£rid_ü—‹_uid
(
r
, 
ùx
, 
cÚf
è!ð
NGX_OK
) {

369  
NGX_ERROR
;

372 ià(
ùx
->
uid_£t
[3] == 0) {

373  
NGX_OK
;

376 
Ën
 = 
cÚf
->
Çme
.ËÀ+ 1 + 
	`ngx_ba£64_’coded_Ëngth
(16è+ cÚf->
·th
.len;

378 ià(
cÚf
->
expœes
) {

379 
Ën
 +ð(
expœes
) - 1 + 2;

382 ià(
cÚf
->
domaš
.
Ën
) {

383 
Ën
 +ð
cÚf
->
domaš
.len;

386 
cook›
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

387 ià(
cook›
 =ð
NULL
) {

388  
NGX_ERROR
;

391 
p
 = 
	`ngx_cÝy
(
cook›
, 
cÚf
->
Çme
.
d©a
, cÚf->Çme.
Ën
);

392 *
p
++ = '=';

394 ià(
ùx
->
uid_gÙ
[3] =ð0 || ctx->
»£t
) {

395 
¤c
.
Ën
 = 16;

396 
¤c
.
d©a
 = (
u_ch¬
 *è
ùx
->
uid_£t
;

397 
d¡
.
d©a
 = 
p
;

399 
	`ngx_’code_ba£64
(&
d¡
, &
¤c
);

401 
p
 +ð
d¡
.
Ën
;

403 ià(
cÚf
->
m¬k
) {

404 *(
p
 - 2èð
cÚf
->
m¬k
;

408 
p
 = 
	`ngx_ýymem
Õ, 
ùx
->
cook›
.
d©a
, 22);

409 *
p
++ = 
cÚf
->
m¬k
;

410 *
p
++ = '=';

413 ià(
cÚf
->
expœes
 =ð
NGX_HTTP_USERID_MAX_EXPIRES
) {

414 
p
 = 
	`ngx_ýymem
Õ, 
expœes
, (expires) - 1);

416 } ià(
cÚf
->
expœes
) {

417 
p
 = 
	`ngx_ýymem
Õ, 
expœes
, (";ƒxpires=") - 1);

418 
p
 = 
	`ngx_h‰p_cook›_time
Õ, 
	`ngx_time
(è+ 
cÚf
->
expœes
);

421 
p
 = 
	`ngx_cÝy
Õ, 
cÚf
->
domaš
.
d©a
, cÚf->domaš.
Ën
);

423 
p
 = 
	`ngx_cÝy
Õ, 
cÚf
->
·th
.
d©a
, cÚf->·th.
Ën
);

425 
£t_cook›
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

426 ià(
£t_cook›
 =ð
NULL
) {

427  
NGX_ERROR
;

430 
£t_cook›
->
hash
 = 1;

431 
	`ngx_¡r_£t
(&
£t_cook›
->
key
, "Set-Cookie");

432 
£t_cook›
->
v®ue
.
Ën
 = 
p
 - 
cook›
;

433 
£t_cook›
->
v®ue
.
d©a
 = 
cook›
;

435 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

436 "uid cook›: \"%V\"", &
£t_cook›
->
v®ue
);

438 ià(
cÚf
->
p3p
.
Ën
 == 0) {

439  
NGX_OK
;

442 
p3p
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

443 ià(
p3p
 =ð
NULL
) {

444  
NGX_ERROR
;

447 
p3p
->
hash
 = 1;

448 
	`ngx_¡r_£t
(&
p3p
->
key
, "P3P");

449 
p3p
->
v®ue
 = 
cÚf
->p3p;

451  
NGX_OK
;

452 
	}
}

455 
ngx_št_t


456 
	$ngx_h‰p_u£rid_ü—‹_uid
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_u£rid_ùx_t
 *
ùx
,

457 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
)

459 
ngx_cÚÃùiÚ_t
 *
c
;

460 
sockaddr_š
 *
sš
;

461 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

462 #ià(
NGX_HAVE_INET6
)

463 
u_ch¬
 *
p
;

464 
sockaddr_š6
 *
sš6
;

467 ià(
ùx
->
uid_£t
[3] != 0) {

468  
NGX_OK
;

471 ià(
ùx
->
uid_gÙ
[3] != 0) {

473 
vv
 = 
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
r
, 
ngx_h‰p_u£rid_»£t_šdex
);

475 ià(
vv
->
Ën
 =ð0 || (vv->ËÀ=ð1 && vv->
d©a
[0] == '0')) {

477 ià(
cÚf
->
m¬k
 == '\0'

478 || (
ùx
->
cook›
.
Ën
 > 23

479 && 
ùx
->
cook›
.
d©a
[22] =ð
cÚf
->
m¬k


480 && 
ùx
->
cook›
.
d©a
[23] == '='))

482  
NGX_OK
;

485 
ùx
->
uid_£t
[0] = ctx->
uid_gÙ
[0];

486 
ùx
->
uid_£t
[1] = ctx->
uid_gÙ
[1];

487 
ùx
->
uid_£t
[2] = ctx->
uid_gÙ
[2];

488 
ùx
->
uid_£t
[3] = ctx->
uid_gÙ
[3];

490  
NGX_OK
;

493 
ùx
->
»£t
 = 1;

495 ià(
vv
->
Ën
 =ð3 && 
	`ngx_¡ºcmp
(vv->
d©a
, "log", 3) == 0) {

496 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
r
->
cÚÃùiÚ
->
log
, 0,

498 &
cÚf
->
Çme
, 
ùx
->
uid_gÙ
[0], ctx->uid_got[1],

499 
ùx
->
uid_gÙ
[2], ctx->uid_got[3]);

509 ià(
cÚf
->
’abË
 =ð
NGX_HTTP_USERID_V1
) {

510 ià(
cÚf
->
£rviû
 =ð
NGX_CONF_UNSET
) {

511 
ùx
->
uid_£t
[0] = 0;

513 
ùx
->
uid_£t
[0] = 
cÚf
->
£rviû
;

515 
ùx
->
uid_£t
[1] = (
ušt32_t
è
	`ngx_time
();

516 
ùx
->
uid_£t
[2] = 
¡¬t_v®ue
;

517 
ùx
->
uid_£t
[3] = 
£qu’ûr_v1
;

518 
£qu’ûr_v1
 += 0x100;

521 ià(
cÚf
->
£rviû
 =ð
NGX_CONF_UNSET
) {

523 
c
 = 
r
->
cÚÃùiÚ
;

525 ià(
	`ngx_cÚÃùiÚ_loÿl_sockaddr
(
c
, 
NULL
, 0è!ð
NGX_OK
) {

526  
NGX_ERROR
;

529 
c
->
loÿl_sockaddr
->
§_çmžy
) {

531 #ià(
NGX_HAVE_INET6
)

532 
AF_INET6
:

533 
sš6
 = (
sockaddr_š6
 *è
c
->
loÿl_sockaddr
;

535 
p
 = (
u_ch¬
 *è&
ùx
->
uid_£t
[0];

537 *
p
++ = 
sš6
->
sš6_addr
.
s6_addr
[12];

538 *
p
++ = 
sš6
->
sš6_addr
.
s6_addr
[13];

539 *
p
++ = 
sš6
->
sš6_addr
.
s6_addr
[14];

540 *
p
 = 
sš6
->
sš6_addr
.
s6_addr
[15];

545 
sš
 = (
sockaddr_š
 *è
c
->
loÿl_sockaddr
;

546 
ùx
->
uid_£t
[0] = 
sš
->
sš_addr
.
s_addr
;

551 
ùx
->
uid_£t
[0] = 
	`htÚl
(
cÚf
->
£rviû
);

554 
ùx
->
uid_£t
[1] = 
	`htÚl
((
ušt32_t
è
	`ngx_time
());

555 
ùx
->
uid_£t
[2] = 
	`htÚl
(
¡¬t_v®ue
);

556 
ùx
->
uid_£t
[3] = 
	`htÚl
(
£qu’ûr_v2
);

557 
£qu’ûr_v2
 += 0x100;

558 ià(
£qu’ûr_v2
 < 0x03030302) {

559 
£qu’ûr_v2
 = 0x03030302;

563  
NGX_OK
;

564 
	}
}

567 
ngx_št_t


568 
	$ngx_h‰p_u£rid_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

569 
ngx_¡r_t
 *
Çme
, 
ušt32_t
 *
uid
)

571 
v
->
Ën
 = 
Çme
->len + ("=00001111222233334444555566667777") - 1;

572 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, v->
Ën
);

573 ià(
v
->
d©a
 =ð
NULL
) {

574  
NGX_ERROR
;

577 
v
->
v®id
 = 1;

578 
v
->
no_ÿch—bË
 = 0;

579 
v
->
nÙ_found
 = 0;

581 
	`ngx_¥rštf
(
v
->
d©a
, "%V=%08XD%08XD%08XD%08XD",

582 
Çme
, 
uid
[0], uid[1], uid[2], uid[3]);

584  
NGX_OK
;

585 
	}
}

588 
ngx_št_t


589 
	$ngx_h‰p_u£rid_»£t_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

590 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

592 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

594  
NGX_OK
;

595 
	}
}

598 
ngx_št_t


599 
	$ngx_h‰p_u£rid_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

601 
ngx_št_t
 
n
;

602 
ngx_h‰p_v¬ŸbË_t
 *
v¬
;

604 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
ngx_h‰p_u£rid_gÙ
, 0);

605 ià(
v¬
 =ð
NULL
) {

606  
NGX_ERROR
;

609 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_u£rid_gÙ_v¬ŸbË
;

611 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
ngx_h‰p_u£rid_£t
, 0);

612 ià(
v¬
 =ð
NULL
) {

613  
NGX_ERROR
;

616 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_u£rid_£t_v¬ŸbË
;

618 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
ngx_h‰p_u£rid_»£t
,

619 
NGX_HTTP_VAR_CHANGEABLE
);

620 ià(
v¬
 =ð
NULL
) {

621  
NGX_ERROR
;

624 
v¬
->
g‘_hªdËr
 = 
ngx_h‰p_u£rid_»£t_v¬ŸbË
;

626 
n
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, &
ngx_h‰p_u£rid_»£t
);

627 ià(
n
 =ð
NGX_ERROR
) {

628  
NGX_ERROR
;

631 
ngx_h‰p_u£rid_»£t_šdex
 = 
n
;

633  
NGX_OK
;

634 
	}
}

638 
	$ngx_h‰p_u£rid_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

640 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
;

642 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_u£rid_cÚf_t
));

643 ià(
cÚf
 =ð
NULL
) {

644  
NULL
;

656 
cÚf
->
’abË
 = 
NGX_CONF_UNSET_UINT
;

657 
cÚf
->
£rviû
 = 
NGX_CONF_UNSET
;

658 
cÚf
->
expœes
 = 
NGX_CONF_UNSET
;

659 
cÚf
->
m¬k
 = (
u_ch¬
) '\xFF';

661  
cÚf
;

662 
	}
}

666 
	$ngx_h‰p_u£rid_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

668 
ngx_h‰p_u£rid_cÚf_t
 *
´ev
 = 
·»Á
;

669 
ngx_h‰p_u£rid_cÚf_t
 *
cÚf
 = 
chžd
;

671 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
’abË
, 
´ev
->enable,

672 
NGX_HTTP_USERID_OFF
);

674 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
Çme
, 
´ev
->name, "uid");

675 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
domaš
, 
´ev
->domain, "");

676 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
·th
, 
´ev
->path, ";…ath=/");

677 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
p3p
, 
´ev
->p3p, "");

679 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£rviû
, 
´ev
->£rviû, 
NGX_CONF_UNSET
);

680 
	`ngx_cÚf_m”ge_£c_v®ue
(
cÚf
->
expœes
, 
´ev
->expires, 0);

682 ià(
cÚf
->
m¬k
 =ð(
u_ch¬
) '\xFF') {

683 ià(
´ev
->
m¬k
 =ð(
u_ch¬
) '\xFF') {

684 
cÚf
->
m¬k
 = '\0';

686 
cÚf
->
m¬k
 = 
´ev
->mark;

690  
NGX_CONF_OK
;

691 
	}
}

694 
ngx_št_t


695 
	$ngx_h‰p_u£rid_š™
(
ngx_cÚf_t
 *
cf
)

697 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

698 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_u£rid_fž‹r
;

700  
NGX_OK
;

701 
	}
}

705 
	$ngx_h‰p_u£rid_domaš
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

707 
ngx_¡r_t
 *
domaš
 = 
d©a
;

709 
u_ch¬
 *
p
, *
Ãw
;

711 ià(
	`ngx_¡rcmp
(
domaš
->
d©a
, "none") == 0) {

712 
	`ngx_¡r_£t
(
domaš
, "");

713  
NGX_CONF_OK
;

716 
Ãw
 = 
	`ngx_²®loc
(
cf
->
poÞ
, ("; domaš="è- 1 + 
domaš
->
Ën
);

717 ià(
Ãw
 =ð
NULL
) {

718  
NGX_CONF_ERROR
;

721 
p
 = 
	`ngx_ýymem
(
Ãw
, "; domain=", ("; domain=") - 1);

722 
	`ngx_memýy
(
p
, 
domaš
->
d©a
, domaš->
Ën
);

724 
domaš
->
Ën
 += ("; domain=") - 1;

725 
domaš
->
d©a
 = 
Ãw
;

727  
NGX_CONF_OK
;

728 
	}
}

732 
	$ngx_h‰p_u£rid_·th
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

734 
ngx_¡r_t
 *
·th
 = 
d©a
;

736 
u_ch¬
 *
p
, *
Ãw
;

738 
Ãw
 = 
	`ngx_²®loc
(
cf
->
poÞ
, (";…©h="è- 1 + 
·th
->
Ën
);

739 ià(
Ãw
 =ð
NULL
) {

740  
NGX_CONF_ERROR
;

743 
p
 = 
	`ngx_ýymem
(
Ãw
, ";…ath=", (";…ath=") - 1);

744 
	`ngx_memýy
(
p
, 
·th
->
d©a
,…©h->
Ën
);

746 
·th
->
Ën
 += (";…ath=") - 1;

747 
·th
->
d©a
 = 
Ãw
;

749  
NGX_CONF_OK
;

750 
	}
}

754 
	$ngx_h‰p_u£rid_expœes
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

756 
ngx_h‰p_u£rid_cÚf_t
 *
ucf
 = 
cÚf
;

758 
ngx_¡r_t
 *
v®ue
;

760 ià(
ucf
->
expœes
 !ð
NGX_CONF_UNSET
) {

764 
v®ue
 = 
cf
->
¬gs
->
–ts
;

766 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "max") == 0) {

767 
ucf
->
expœes
 = 
NGX_HTTP_USERID_MAX_EXPIRES
;

768  
NGX_CONF_OK
;

771 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

772 
ucf
->
expœes
 = 0;

773  
NGX_CONF_OK
;

776 
ucf
->
expœes
 = 
	`ngx_·r£_time
(&
v®ue
[1], 1);

777 ià(
ucf
->
expœes
 =ð(
time_t
è
NGX_ERROR
) {

781  
NGX_CONF_OK
;

782 
	}
}

786 
	$ngx_h‰p_u£rid_p3p
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

788 
ngx_¡r_t
 *
p3p
 = 
d©a
;

790 ià(
	`ngx_¡rcmp
(
p3p
->
d©a
, "none") == 0) {

791 
	`ngx_¡r_£t
(
p3p
, "");

794  
NGX_CONF_OK
;

795 
	}
}

799 
	$ngx_h‰p_u£rid_m¬k
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

801 
ngx_h‰p_u£rid_cÚf_t
 *
ucf
 = 
cÚf
;

803 
ngx_¡r_t
 *
v®ue
;

805 ià(
ucf
->
m¬k
 !ð(
u_ch¬
) '\xFF') {

809 
v®ue
 = 
cf
->
¬gs
->
–ts
;

811 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

812 
ucf
->
m¬k
 = '\0';

813  
NGX_CONF_OK
;

816 ià(
v®ue
[1].
Ën
 != 1

817 || !((
v®ue
[1].
d©a
[0] >= '0' && value[1].data[0] <= '9')

818 || (
v®ue
[1].
d©a
[0] >= 'A' && value[1].data[0] <= 'Z')

819 || (
v®ue
[1].
d©a
[0] >= 'a' && value[1].data[0] <= 'z')

820 || 
v®ue
[1].
d©a
[0] == '='))

825 
ucf
->
m¬k
 = 
v®ue
[1].
d©a
[0];

827  
NGX_CONF_OK
;

828 
	}
}

831 
ngx_št_t


832 
	$ngx_h‰p_u£rid_š™_wÜk”
(
ngx_cyþe_t
 *
cyþe
)

834 
timev®
 

;

836 
	`ngx_g‘timeofday
(&

);

839 
¡¬t_v®ue
 = ((

.
tv_u£c
 / 20è<< 16è| 
ngx_pid
;

841  
NGX_OK
;

842 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_uwsgi_module.c

10 
	~<ngx_cÚfig.h
>

11 
	~<ngx_cÜe.h
>

12 
	~<ngx_h‰p.h
>

16 
ngx_¬¿y_t
 *
	mæushes
;

17 
ngx_¬¿y_t
 *
	mËngths
;

18 
ngx_¬¿y_t
 *
	mv®ues
;

19 
ngx_ušt_t
 
	mnumb”
;

20 
ngx_hash_t
 
	mhash
;

21 } 
	tngx_h‰p_uwsgi_·¿ms_t
;

25 
ngx_h‰p_up¡»am_cÚf_t
 
	mup¡»am
;

27 
ngx_h‰p_uwsgi_·¿ms_t
 
	m·¿ms
;

28 #ià(
NGX_HTTP_CACHE
)

29 
ngx_h‰p_uwsgi_·¿ms_t
 
	m·¿ms_ÿche
;

31 
ngx_¬¿y_t
 *
	m·¿ms_sourû
;

33 
ngx_¬¿y_t
 *
	muwsgi_Ëngths
;

34 
ngx_¬¿y_t
 *
	muwsgi_v®ues
;

36 #ià(
NGX_HTTP_CACHE
)

37 
ngx_h‰p_com¶ex_v®ue_t
 
	mÿche_key
;

40 
ngx_¡r_t
 
	muwsgi_¡ršg
;

42 
ngx_ušt_t
 
	mmodif›r1
;

43 
ngx_ušt_t
 
	mmodif›r2
;

45 #ià(
NGX_HTTP_SSL
)

46 
ngx_ušt_t
 
	ms¦
;

47 
ngx_ušt_t
 
	ms¦_´ÙocÞs
;

48 
ngx_¡r_t
 
	ms¦_ch”s
;

49 
ngx_ušt_t
 
	ms¦_v”ify_d•th
;

50 
ngx_¡r_t
 
	ms¦_Œu¡ed_û¹ifiÿ‹
;

51 
ngx_¡r_t
 
	ms¦_ül
;

52 
ngx_¡r_t
 
	ms¦_û¹ifiÿ‹
;

53 
ngx_¡r_t
 
	ms¦_û¹ifiÿ‹_key
;

54 
ngx_¬¿y_t
 *
	ms¦_·sswÜds
;

56 } 
	tngx_h‰p_uwsgi_loc_cÚf_t
;

59 
ngx_št_t
 
ngx_h‰p_uwsgi_ev®
(
ngx_h‰p_»que¡_t
 *
r
,

60 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
);

61 
ngx_št_t
 
ngx_h‰p_uwsgi_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

62 
ngx_št_t
 
ngx_h‰p_uwsgi_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

63 
ngx_št_t
 
ngx_h‰p_uwsgi_´oûss_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
);

64 
ngx_št_t
 
ngx_h‰p_uwsgi_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

65 
ngx_h‰p_uwsgi_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

66 
ngx_h‰p_uwsgi_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

67 
ngx_št_t
 
rc
);

69 *
ngx_h‰p_uwsgi_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

70 *
ngx_h‰p_uwsgi_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

71 *
chžd
);

72 
ngx_št_t
 
ngx_h‰p_uwsgi_š™_·¿ms
(
ngx_cÚf_t
 *
cf
,

73 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
cÚf
, 
ngx_h‰p_uwsgi_·¿ms_t
 *
·¿ms
,

74 
ngx_keyv®_t
 *
deçuÉ_·¿ms
);

76 *
ngx_h‰p_uwsgi_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

77 *
cÚf
);

78 *
ngx_h‰p_uwsgi_¡Üe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

79 *
cÚf
);

81 #ià(
NGX_HTTP_CACHE
)

82 
ngx_št_t
 
ngx_h‰p_uwsgi_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
);

83 *
ngx_h‰p_uwsgi_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

84 *
cÚf
);

85 *
ngx_h‰p_uwsgi_ÿche_key
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

86 *
cÚf
);

89 #ià(
NGX_HTTP_SSL
)

90 *
ngx_h‰p_uwsgi_s¦_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
,

91 
ngx_commªd_t
 *
cmd
, *
cÚf
);

92 
ngx_št_t
 
ngx_h‰p_uwsgi_£t_s¦
(
ngx_cÚf_t
 *
cf
,

93 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
);

97 
ngx_cÚf_num_bounds_t
 
	gngx_h‰p_uwsgi_modif›r_bounds
 = {

98 
ngx_cÚf_check_num_bounds
, 0, 255

102 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_uwsgi_Ãxt_up¡»am_masks
[] = {

103 { 
ngx_¡ršg
("”rÜ"), 
NGX_HTTP_UPSTREAM_FT_ERROR
 },

104 { 
ngx_¡ršg
("timeout"), 
NGX_HTTP_UPSTREAM_FT_TIMEOUT
 },

105 { 
ngx_¡ršg
("šv®id_h—d”"), 
NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
 },

106 { 
ngx_¡ršg
("h‰p_500"), 
NGX_HTTP_UPSTREAM_FT_HTTP_500
 },

107 { 
ngx_¡ršg
("h‰p_503"), 
NGX_HTTP_UPSTREAM_FT_HTTP_503
 },

108 { 
ngx_¡ršg
("h‰p_403"), 
NGX_HTTP_UPSTREAM_FT_HTTP_403
 },

109 { 
ngx_¡ršg
("h‰p_404"), 
NGX_HTTP_UPSTREAM_FT_HTTP_404
 },

110 { 
ngx_¡ršg
("upd©šg"), 
NGX_HTTP_UPSTREAM_FT_UPDATING
 },

111 { 
ngx_¡ršg
("off"), 
NGX_HTTP_UPSTREAM_FT_OFF
 },

112 { 
ngx_nuÎ_¡ršg
, 0 }

116 #ià(
NGX_HTTP_SSL
)

118 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_uwsgi_s¦_´ÙocÞs
[] = {

119 { 
ngx_¡ršg
("SSLv2"), 
NGX_SSL_SSLv2
 },

120 { 
ngx_¡ršg
("SSLv3"), 
NGX_SSL_SSLv3
 },

121 { 
ngx_¡ršg
("TLSv1"), 
NGX_SSL_TLSv1
 },

122 { 
ngx_¡ršg
("TLSv1.1"), 
NGX_SSL_TLSv1_1
 },

123 { 
ngx_¡ršg
("TLSv1.2"), 
NGX_SSL_TLSv1_2
 },

124 { 
ngx_nuÎ_¡ršg
, 0 }

130 
ngx_moduË_t
 
	gngx_h‰p_uwsgi_moduË
;

133 
ngx_commªd_t
 
	gngx_h‰p_uwsgi_commªds
[] = {

135 { 
ngx_¡ršg
("uwsgi_pass"),

136 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF
|
NGX_CONF_TAKE1
,

137 
ngx_h‰p_uwsgi_·ss
,

138 
NGX_HTTP_LOC_CONF_OFFSET
,

140 
NULL
 },

142 { 
ngx_¡ršg
("uwsgi_modifier1"),

143 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

144 
ngx_cÚf_£t_num_¦Ù
,

145 
NGX_HTTP_LOC_CONF_OFFSET
,

146 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
modif›r1
),

147 &
ngx_h‰p_uwsgi_modif›r_bounds
 },

149 { 
ngx_¡ršg
("uwsgi_modifier2"),

150 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

151 
ngx_cÚf_£t_num_¦Ù
,

152 
NGX_HTTP_LOC_CONF_OFFSET
,

153 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
modif›r2
),

154 &
ngx_h‰p_uwsgi_modif›r_bounds
 },

156 { 
ngx_¡ršg
("uwsgi_store"),

157 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

158 
ngx_h‰p_uwsgi_¡Üe
,

159 
NGX_HTTP_LOC_CONF_OFFSET
,

161 
NULL
 },

163 { 
ngx_¡ršg
("uwsgi_store_access"),

164 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE123
,

165 
ngx_cÚf_£t_acûss_¦Ù
,

166 
NGX_HTTP_LOC_CONF_OFFSET
,

167 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
¡Üe_acûss
),

168 
NULL
 },

170 { 
ngx_¡ršg
("uwsgi_buffering"),

171 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

172 
ngx_cÚf_£t_æag_¦Ù
,

173 
NGX_HTTP_LOC_CONF_OFFSET
,

174 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
bufãršg
),

175 
NULL
 },

177 { 
ngx_¡ršg
("uwsgi_ignore_client_abort"),

178 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

179 
ngx_cÚf_£t_æag_¦Ù
,

180 
NGX_HTTP_LOC_CONF_OFFSET
,

181 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ignÜe_þ›Á_abÜt
),

182 
NULL
 },

184 { 
ngx_¡ršg
("uwsgi_bind"),

185 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

186 
ngx_h‰p_up¡»am_bšd_£t_¦Ù
,

187 
NGX_HTTP_LOC_CONF_OFFSET
,

188 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
loÿl
),

189 
NULL
 },

191 { 
ngx_¡ršg
("uwsgi_connect_timeout"),

192 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

193 
ngx_cÚf_£t_m£c_¦Ù
,

194 
NGX_HTTP_LOC_CONF_OFFSET
,

195 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
cÚÃù_timeout
),

196 
NULL
 },

198 { 
ngx_¡ršg
("uwsgi_send_timeout"),

199 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

200 
ngx_cÚf_£t_m£c_¦Ù
,

201 
NGX_HTTP_LOC_CONF_OFFSET
,

202 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
£nd_timeout
),

203 
NULL
 },

205 { 
ngx_¡ršg
("uwsgi_buffer_size"),

206 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

207 
ngx_cÚf_£t_size_¦Ù
,

208 
NGX_HTTP_LOC_CONF_OFFSET
,

209 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
bufãr_size
),

210 
NULL
 },

212 { 
ngx_¡ršg
("uwsgi_pass_request_headers"),

213 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

214 
ngx_cÚf_£t_æag_¦Ù
,

215 
NGX_HTTP_LOC_CONF_OFFSET
,

216 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
·ss_»que¡_h—d”s
),

217 
NULL
 },

219 { 
ngx_¡ršg
("uwsgi_pass_request_body"),

220 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

221 
ngx_cÚf_£t_æag_¦Ù
,

222 
NGX_HTTP_LOC_CONF_OFFSET
,

223 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
·ss_»que¡_body
),

224 
NULL
 },

226 { 
ngx_¡ršg
("uwsgi_intercept_errors"),

227 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

228 
ngx_cÚf_£t_æag_¦Ù
,

229 
NGX_HTTP_LOC_CONF_OFFSET
,

230 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
š‹rû±_”rÜs
),

231 
NULL
 },

233 { 
ngx_¡ršg
("uwsgi_read_timeout"),

234 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

235 
ngx_cÚf_£t_m£c_¦Ù
,

236 
NGX_HTTP_LOC_CONF_OFFSET
,

237 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
»ad_timeout
),

238 
NULL
 },

240 { 
ngx_¡ršg
("uwsgi_buffers"),

241 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

242 
ngx_cÚf_£t_bufs_¦Ù
,

243 
NGX_HTTP_LOC_CONF_OFFSET
,

244 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
bufs
),

245 
NULL
 },

247 { 
ngx_¡ršg
("uwsgi_busy_buffers_size"),

248 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

249 
ngx_cÚf_£t_size_¦Ù
,

250 
NGX_HTTP_LOC_CONF_OFFSET
,

251 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
busy_bufãrs_size_cÚf
),

252 
NULL
 },

254 { 
ngx_¡ršg
("uwsgi_force_ranges"),

255 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

256 
ngx_cÚf_£t_æag_¦Ù
,

257 
NGX_HTTP_LOC_CONF_OFFSET
,

258 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
fÜû_¿nges
),

259 
NULL
 },

261 { 
ngx_¡ršg
("uwsgi_limit_rate"),

262 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

263 
ngx_cÚf_£t_size_¦Ù
,

264 
NGX_HTTP_LOC_CONF_OFFSET
,

265 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
lim™_¿‹
),

266 
NULL
 },

268 #ià(
NGX_HTTP_CACHE
)

270 { 
ngx_¡ršg
("uwsgi_cache"),

271 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

272 
ngx_h‰p_uwsgi_ÿche
,

273 
NGX_HTTP_LOC_CONF_OFFSET
,

275 
NULL
 },

277 { 
ngx_¡ršg
("uwsgi_cache_key"),

278 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

279 
ngx_h‰p_uwsgi_ÿche_key
,

280 
NGX_HTTP_LOC_CONF_OFFSET
,

282 
NULL
 },

284 { 
ngx_¡ršg
("uwsgi_cache_path"),

285 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_2MORE
,

286 
ngx_h‰p_fže_ÿche_£t_¦Ù
,

289 &
ngx_h‰p_uwsgi_moduË
 },

291 { 
ngx_¡ršg
("uwsgi_cache_bypass"),

292 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

293 
ngx_h‰p_£t_´ediÿ‹_¦Ù
,

294 
NGX_HTTP_LOC_CONF_OFFSET
,

295 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_by·ss
),

296 
NULL
 },

298 { 
ngx_¡ršg
("uwsgi_no_cache"),

299 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

300 
ngx_h‰p_£t_´ediÿ‹_¦Ù
,

301 
NGX_HTTP_LOC_CONF_OFFSET
,

302 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
no_ÿche
),

303 
NULL
 },

305 { 
ngx_¡ršg
("uwsgi_cache_valid"),

306 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

307 
ngx_h‰p_fže_ÿche_v®id_£t_¦Ù
,

308 
NGX_HTTP_LOC_CONF_OFFSET
,

309 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_v®id
),

310 
NULL
 },

312 { 
ngx_¡ršg
("uwsgi_cache_min_uses"),

313 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

314 
ngx_cÚf_£t_num_¦Ù
,

315 
NGX_HTTP_LOC_CONF_OFFSET
,

316 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_mš_u£s
),

317 
NULL
 },

319 { 
ngx_¡ršg
("uwsgi_cache_use_stale"),

320 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

321 
ngx_cÚf_£t_b™mask_¦Ù
,

322 
NGX_HTTP_LOC_CONF_OFFSET
,

323 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_u£_¡®e
),

324 &
ngx_h‰p_uwsgi_Ãxt_up¡»am_masks
 },

326 { 
ngx_¡ršg
("uwsgi_cache_methods"),

327 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

328 
ngx_cÚf_£t_b™mask_¦Ù
,

329 
NGX_HTTP_LOC_CONF_OFFSET
,

330 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_m‘hods
),

331 &
ngx_h‰p_up¡»am_ÿche_m‘hod_mask
 },

333 { 
ngx_¡ršg
("uwsgi_cache_lock"),

334 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

335 
ngx_cÚf_£t_æag_¦Ù
,

336 
NGX_HTTP_LOC_CONF_OFFSET
,

337 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock
),

338 
NULL
 },

340 { 
ngx_¡ršg
("uwsgi_cache_lock_timeout"),

341 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

342 
ngx_cÚf_£t_m£c_¦Ù
,

343 
NGX_HTTP_LOC_CONF_OFFSET
,

344 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock_timeout
),

345 
NULL
 },

347 { 
ngx_¡ršg
("uwsgi_cache_lock_age"),

348 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

349 
ngx_cÚf_£t_m£c_¦Ù
,

350 
NGX_HTTP_LOC_CONF_OFFSET
,

351 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_lock_age
),

352 
NULL
 },

354 { 
ngx_¡ršg
("uwsgi_cache_revalidate"),

355 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

356 
ngx_cÚf_£t_æag_¦Ù
,

357 
NGX_HTTP_LOC_CONF_OFFSET
,

358 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ÿche_»v®id©e
),

359 
NULL
 },

363 { 
ngx_¡ršg
("uwsgi_temp_path"),

364 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1234
,

365 
ngx_cÚf_£t_·th_¦Ù
,

366 
NGX_HTTP_LOC_CONF_OFFSET
,

367 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
‹mp_·th
),

368 
NULL
 },

370 { 
ngx_¡ršg
("uwsgi_max_temp_file_size"),

371 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

372 
ngx_cÚf_£t_size_¦Ù
,

373 
NGX_HTTP_LOC_CONF_OFFSET
,

374 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
max_‹mp_fže_size_cÚf
),

375 
NULL
 },

377 { 
ngx_¡ršg
("uwsgi_temp_file_write_size"),

378 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

379 
ngx_cÚf_£t_size_¦Ù
,

380 
NGX_HTTP_LOC_CONF_OFFSET
,

381 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
‹mp_fže_wr™e_size_cÚf
),

382 
NULL
 },

384 { 
ngx_¡ršg
("uwsgi_next_upstream"),

385 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

386 
ngx_cÚf_£t_b™mask_¦Ù
,

387 
NGX_HTTP_LOC_CONF_OFFSET
,

388 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am
),

389 &
ngx_h‰p_uwsgi_Ãxt_up¡»am_masks
 },

391 { 
ngx_¡ršg
("uwsgi_next_upstream_tries"),

392 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

393 
ngx_cÚf_£t_num_¦Ù
,

394 
NGX_HTTP_LOC_CONF_OFFSET
,

395 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_Œ›s
),

396 
NULL
 },

398 { 
ngx_¡ršg
("uwsgi_next_upstream_timeout"),

399 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

400 
ngx_cÚf_£t_m£c_¦Ù
,

401 
NGX_HTTP_LOC_CONF_OFFSET
,

402 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
Ãxt_up¡»am_timeout
),

403 
NULL
 },

405 { 
ngx_¡ršg
("uwsgi_param"),

406 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE23
,

407 
ngx_h‰p_up¡»am_·¿m_£t_¦Ù
,

408 
NGX_HTTP_LOC_CONF_OFFSET
,

409 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
·¿ms_sourû
),

410 
NULL
 },

412 { 
ngx_¡ršg
("uwsgi_string"),

413 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

414 
ngx_cÚf_£t_¡r_¦Ù
,

415 
NGX_HTTP_LOC_CONF_OFFSET
,

416 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
uwsgi_¡ršg
),

417 
NULL
 },

419 { 
ngx_¡ršg
("uwsgi_pass_header"),

420 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

421 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

422 
NGX_HTTP_LOC_CONF_OFFSET
,

423 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
·ss_h—d”s
),

424 
NULL
 },

426 { 
ngx_¡ršg
("uwsgi_hide_header"),

427 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

428 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

429 
NGX_HTTP_LOC_CONF_OFFSET
,

430 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
hide_h—d”s
),

431 
NULL
 },

433 { 
ngx_¡ršg
("uwsgi_ignore_headers"),

434 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

435 
ngx_cÚf_£t_b™mask_¦Ù
,

436 
NGX_HTTP_LOC_CONF_OFFSET
,

437 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
ignÜe_h—d”s
),

438 &
ngx_h‰p_up¡»am_ignÜe_h—d”s_masks
 },

440 #ià(
NGX_HTTP_SSL
)

442 { 
ngx_¡ršg
("uwsgi_ssl_session_reuse"),

443 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

444 
ngx_cÚf_£t_æag_¦Ù
,

445 
NGX_HTTP_LOC_CONF_OFFSET
,

446 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
s¦_£ssiÚ_»u£
),

447 
NULL
 },

449 { 
ngx_¡ršg
("uwsgi_ssl_protocols"),

450 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

451 
ngx_cÚf_£t_b™mask_¦Ù
,

452 
NGX_HTTP_LOC_CONF_OFFSET
,

453 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
s¦_´ÙocÞs
),

454 &
ngx_h‰p_uwsgi_s¦_´ÙocÞs
 },

456 { 
ngx_¡ršg
("uwsgi_ssl_ciphers"),

457 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

458 
ngx_cÚf_£t_¡r_¦Ù
,

459 
NGX_HTTP_LOC_CONF_OFFSET
,

460 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
s¦_ch”s
),

461 
NULL
 },

463 { 
ngx_¡ršg
("uwsgi_ssl_name"),

464 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

465 
ngx_h‰p_£t_com¶ex_v®ue_¦Ù
,

466 
NGX_HTTP_LOC_CONF_OFFSET
,

467 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
s¦_Çme
),

468 
NULL
 },

470 { 
ngx_¡ršg
("uwsgi_ssl_server_name"),

471 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

472 
ngx_cÚf_£t_æag_¦Ù
,

473 
NGX_HTTP_LOC_CONF_OFFSET
,

474 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
s¦_£rv”_Çme
),

475 
NULL
 },

477 { 
ngx_¡ršg
("uwsgi_ssl_verify"),

478 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

479 
ngx_cÚf_£t_æag_¦Ù
,

480 
NGX_HTTP_LOC_CONF_OFFSET
,

481 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
up¡»am
.
s¦_v”ify
),

482 
NULL
 },

484 { 
ngx_¡ršg
("uwsgi_ssl_verify_depth"),

485 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

486 
ngx_cÚf_£t_num_¦Ù
,

487 
NGX_HTTP_LOC_CONF_OFFSET
,

488 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
s¦_v”ify_d•th
),

489 
NULL
 },

491 { 
ngx_¡ršg
("uwsgi_ssl_trusted_certificate"),

492 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

493 
ngx_cÚf_£t_¡r_¦Ù
,

494 
NGX_HTTP_LOC_CONF_OFFSET
,

495 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
s¦_Œu¡ed_û¹ifiÿ‹
),

496 
NULL
 },

498 { 
ngx_¡ršg
("uwsgi_ssl_crl"),

499 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

500 
ngx_cÚf_£t_¡r_¦Ù
,

501 
NGX_HTTP_LOC_CONF_OFFSET
,

502 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
s¦_ül
),

503 
NULL
 },

505 { 
ngx_¡ršg
("uwsgi_ssl_certificate"),

506 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

507 
ngx_cÚf_£t_¡r_¦Ù
,

508 
NGX_HTTP_LOC_CONF_OFFSET
,

509 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
s¦_û¹ifiÿ‹
),

510 
NULL
 },

512 { 
ngx_¡ršg
("uwsgi_ssl_certificate_key"),

513 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

514 
ngx_cÚf_£t_¡r_¦Ù
,

515 
NGX_HTTP_LOC_CONF_OFFSET
,

516 
off£tof
(
ngx_h‰p_uwsgi_loc_cÚf_t
, 
s¦_û¹ifiÿ‹_key
),

517 
NULL
 },

519 { 
ngx_¡ršg
("uwsgi_ssl_password_file"),

520 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

521 
ngx_h‰p_uwsgi_s¦_·sswÜd_fže
,

522 
NGX_HTTP_LOC_CONF_OFFSET
,

524 
NULL
 },

528 
ngx_nuÎ_commªd


532 
ngx_h‰p_moduË_t
 
	gngx_h‰p_uwsgi_moduË_ùx
 = {

533 
NULL
,

534 
NULL
,

536 
NULL
,

537 
NULL
,

539 
NULL
,

540 
NULL
,

542 
ngx_h‰p_uwsgi_ü—‹_loc_cÚf
,

543 
ngx_h‰p_uwsgi_m”ge_loc_cÚf


547 
ngx_moduË_t
 
	gngx_h‰p_uwsgi_moduË
 = {

548 
NGX_MODULE_V1
,

549 &
ngx_h‰p_uwsgi_moduË_ùx
,

550 
ngx_h‰p_uwsgi_commªds
,

551 
NGX_HTTP_MODULE
,

552 
NULL
,

553 
NULL
,

554 
NULL
,

555 
NULL
,

556 
NULL
,

557 
NULL
,

558 
NULL
,

559 
NGX_MODULE_V1_PADDING


563 
ngx_¡r_t
 
	gngx_h‰p_uwsgi_hide_h—d”s
[] = {

564 
ngx_¡ršg
("X-Accel-Expires"),

565 
ngx_¡ršg
("X-Accel-Redirect"),

566 
ngx_¡ršg
("X-Accel-Limit-Rate"),

567 
ngx_¡ršg
("X-Accel-Buffering"),

568 
ngx_¡ršg
("X-Accel-Charset"),

569 
ngx_nuÎ_¡ršg


573 #ià(
NGX_HTTP_CACHE
)

575 
ngx_keyv®_t
 
	gngx_h‰p_uwsgi_ÿche_h—d”s
[] = {

576 { 
ngx_¡ršg
("HTTP_IF_MODIFIED_SINCE"),

577 
ngx_¡ršg
("$upstream_cache_last_modified") },

578 { 
ngx_¡ršg
("HTTP_IF_UNMODIFIED_SINCE"),‚gx_string("") },

579 { 
ngx_¡ršg
("HTTP_IF_NONE_MATCH"),‚gx_string("$upstream_cache_etag") },

580 { 
ngx_¡ršg
("HTTP_IF_MATCH"),‚gx_string("") },

581 { 
ngx_¡ršg
("HTTP_RANGE"),‚gx_string("") },

582 { 
ngx_¡ršg
("HTTP_IF_RANGE"),‚gx_string("") },

583 { 
ngx_nuÎ_¡ršg
,‚gx_null_string }

589 
ngx_·th_š™_t
 
	gngx_h‰p_uwsgi_‹mp_·th
 = {

590 
ngx_¡ršg
(
NGX_HTTP_UWSGI_TEMP_PATH
), { 1, 2, 0 }

594 
ngx_št_t


595 
	$ngx_h‰p_uwsgi_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

597 
ngx_št_t
 
rc
;

598 
ngx_h‰p_¡©us_t
 *
¡©us
;

599 
ngx_h‰p_up¡»am_t
 *
u
;

600 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
;

602 ià(
	`ngx_h‰p_up¡»am_ü—‹
(
r
è!ð
NGX_OK
) {

603  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

606 
¡©us
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_¡©us_t
));

607 ià(
¡©us
 =ð
NULL
) {

608  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

611 
	`ngx_h‰p_£t_ùx
(
r
, 
¡©us
, 
ngx_h‰p_uwsgi_moduË
);

613 
uwcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_uwsgi_moduË
);

615 
u
 = 
r
->
up¡»am
;

617 ià(
uwcf
->
uwsgi_Ëngths
 =ð
NULL
) {

619 #ià(
NGX_HTTP_SSL
)

620 
u
->
s¦
 = (
uwcf
->
up¡»am
.s¦ !ð
NULL
);

622 ià(
u
->
s¦
) {

623 
	`ngx_¡r_£t
(&
u
->
schema
, "suwsgi://");

626 
	`ngx_¡r_£t
(&
u
->
schema
, "uwsgi://");

629 
	`ngx_¡r_£t
(&
u
->
schema
, "uwsgi://");

633 ià(
	`ngx_h‰p_uwsgi_ev®
(
r
, 
uwcf
è!ð
NGX_OK
) {

634  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

638 
u
->
ouut
.
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_uwsgi_moduË
;

640 
u
->
cÚf
 = &
uwcf
->
up¡»am
;

642 #ià(
NGX_HTTP_CACHE
)

643 
u
->
ü—‹_key
 = 
ngx_h‰p_uwsgi_ü—‹_key
;

645 
u
->
ü—‹_»que¡
 = 
ngx_h‰p_uwsgi_ü—‹_»que¡
;

646 
u
->
»š™_»que¡
 = 
ngx_h‰p_uwsgi_»š™_»que¡
;

647 
u
->
´oûss_h—d”
 = 
ngx_h‰p_uwsgi_´oûss_¡©us_lše
;

648 
u
->
abÜt_»que¡
 = 
ngx_h‰p_uwsgi_abÜt_»que¡
;

649 
u
->
fš®ize_»que¡
 = 
ngx_h‰p_uwsgi_fš®ize_»que¡
;

650 
r
->
¡©e
 = 0;

652 
u
->
bufãršg
 = 
uwcf
->
up¡»am
.buffering;

654 
u
->
pe
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_ev’t_pe_t
));

655 ià(
u
->
pe
 =ð
NULL
) {

656  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

659 
u
->
pe
->
šput_fž‹r
 = 
ngx_ev’t_pe_cÝy_šput_fž‹r
;

660 
u
->
pe
->
šput_ùx
 = 
r
;

662 
rc
 = 
	`ngx_h‰p_»ad_þ›Á_»que¡_body
(
r
, 
ngx_h‰p_up¡»am_š™
);

664 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

665  
rc
;

668  
NGX_DONE
;

669 
	}
}

672 
ngx_št_t


673 
	$ngx_h‰p_uwsgi_ev®
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_uwsgi_loc_cÚf_t
 * 
uwcf
)

675 
size_t
 
add
;

676 
ngx_u¾_t
 
u¾
;

677 
ngx_h‰p_up¡»am_t
 *
u
;

679 
	`ngx_memz”o
(&
u¾
, (
ngx_u¾_t
));

681 ià(
	`ngx_h‰p_süt_run
(
r
, &
u¾
.u¾, 
uwcf
->
uwsgi_Ëngths
->
–ts
, 0,

682 
uwcf
->
uwsgi_v®ues
->
–ts
)

683 =ð
NULL
)

685  
NGX_ERROR
;

688 ià(
u¾
.u¾.
Ën
 > 8

689 && 
	`ngx_¡ºÿ£cmp
(
u¾
.u¾.
d©a
, (
u_ch¬
 *) "uwsgi://", 8) == 0)

691 
add
 = 8;

693 } ià(
u¾
.u¾.
Ën
 > 9

694 && 
	`ngx_¡ºÿ£cmp
(
u¾
.u¾.
d©a
, (
u_ch¬
 *) "suwsgi://", 9) == 0)

697 #ià(
NGX_HTTP_SSL
)

698 
add
 = 9;

699 
r
->
up¡»am
->
s¦
 = 1;

701 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

703  
NGX_ERROR
;

707 
add
 = 0;

710 
u
 = 
r
->
up¡»am
;

712 ià(
add
) {

713 
u
->
schema
.
Ën
 = 
add
;

714 
u
->
schema
.
d©a
 = 
u¾
.url.data;

716 
u¾
.u¾.
d©a
 +ð
add
;

717 
u¾
.u¾.
Ën
 -ð
add
;

720 
	`ngx_¡r_£t
(&
u
->
schema
, "uwsgi://");

723 
u¾
.
no_»sÞve
 = 1;

725 ià(
	`ngx_·r£_u¾
(
r
->
poÞ
, &
u¾
è!ð
NGX_OK
) {

726 ià(
u¾
.
”r
) {

727 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

728 "% š up¡»am \"%V\"", 
u¾
.
”r
, &url.url);

731  
NGX_ERROR
;

734 
u
->
»sÞved
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_»sÞved_t
));

735 ià(
u
->
»sÞved
 =ð
NULL
) {

736  
NGX_ERROR
;

739 ià(
u¾
.
addrs
 && u¾.addrs[0].
sockaddr
) {

740 
u
->
»sÞved
->
sockaddr
 = 
u¾
.
addrs
[0].sockaddr;

741 
u
->
»sÞved
->
sockËn
 = 
u¾
.
addrs
[0].socklen;

742 
u
->
»sÞved
->
Çddrs
 = 1;

743 
u
->
»sÞved
->
ho¡
 = 
u¾
.
addrs
[0].
Çme
;

746 
u
->
»sÞved
->
ho¡
 = 
u¾
.host;

747 
u
->
»sÞved
->
pÜt
 = 
u¾
.port;

748 
u
->
»sÞved
->
no_pÜt
 = 
u¾
.no_port;

751  
NGX_OK
;

752 
	}
}

755 #ià(
NGX_HTTP_CACHE
)

757 
ngx_št_t


758 
	$ngx_h‰p_uwsgi_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
)

760 
ngx_¡r_t
 *
key
;

761 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
;

763 
key
 = 
	`ngx_¬¿y_push
(&
r
->
ÿche
->
keys
);

764 ià(
key
 =ð
NULL
) {

765  
NGX_ERROR
;

768 
uwcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_uwsgi_moduË
);

770 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
uwcf
->
ÿche_key
, 
key
è!ð
NGX_OK
) {

771  
NGX_ERROR
;

774  
NGX_OK
;

775 
	}
}

780 
ngx_št_t


781 
	$ngx_h‰p_uwsgi_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

783 
u_ch¬
 
ch
, *
lowÿ£_key
;

784 
size_t
 
key_Ën
, 
v®_Ën
, 
Ën
, 
®loÿ‹d
;

785 
ngx_ušt_t
 
i
, 
n
, 
hash
, 
sk_em±y
, 
h—d”_·¿ms
;

786 
ngx_buf_t
 *
b
;

787 
ngx_chaš_t
 *
þ
, *
body
;

788 
ngx_li¡_·¹_t
 *
·¹
;

789 
ngx_bË_–t_t
 *
h—d”
, **
ignÜed
;

790 
ngx_h‰p_uwsgi_·¿ms_t
 *
·¿ms
;

791 
ngx_h‰p_süt_code_±
 
code
;

792 
ngx_h‰p_süt_’gše_t
 
e
, 
Ë
;

793 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
;

794 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

796 
Ën
 = 0;

797 
h—d”_·¿ms
 = 0;

798 
ignÜed
 = 
NULL
;

800 
uwcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_uwsgi_moduË
);

802 #ià(
NGX_HTTP_CACHE
)

803 
·¿ms
 = 
r
->
up¡»am
->
ÿch—bË
 ? &
uwcf
->
·¿ms_ÿche
 : &uwcf->params;

805 
·¿ms
 = &
uwcf
->params;

808 ià(
·¿ms
->
Ëngths
) {

809 
	`ngx_memz”o
(&
Ë
, (
ngx_h‰p_süt_’gše_t
));

811 
	`ngx_h‰p_süt_æush_no_ÿch—bË_v¬ŸbËs
(
r
, 
·¿ms
->
æushes
);

812 
Ë
.
æushed
 = 1;

814 
Ë
.

 = 
·¿ms
->
Ëngths
->
–ts
;

815 
Ë
.
»que¡
 = 
r
;

817 *(
ušŒ_t
 *è
Ë
.

) {

819 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

820 
key_Ën
 = 
	`lcode
(&
Ë
);

822 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

823 
sk_em±y
 = 
	`lcode
(&
Ë
);

825 
v®_Ën
 = 0; *(
ušŒ_t
 *è
Ë
.

; v®_ËÀ+ð
	`lcode
 (&le)) {

826 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

828 
Ë
.

 +ð(
ušŒ_t
);

830 ià(
sk_em±y
 && 
v®_Ën
 == 0) {

834 
Ën
 +ð2 + 
key_Ën
 + 2 + 
v®_Ën
;

838 ià(
uwcf
->
up¡»am
.
·ss_»que¡_h—d”s
) {

840 
®loÿ‹d
 = 0;

841 
lowÿ£_key
 = 
NULL
;

843 ià(
·¿ms
->
numb”
) {

844 
n
 = 0;

845 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

847 
·¹
) {

848 
n
 +ð
·¹
->
ÃÉs
;

849 
·¹
 =…¬t->
Ãxt
;

852 
ignÜed
 = 
	`ngx_·Îoc
(
r
->
poÞ
, 
n
 * (*));

853 ià(
ignÜed
 =ð
NULL
) {

854  
NGX_ERROR
;

858 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

859 
h—d”
 = 
·¹
->
–ts
;

861 
i
 = 0; ; i++) {

863 ià(
i
 >ð
·¹
->
ÃÉs
) {

864 ià(
·¹
->
Ãxt
 =ð
NULL
) {

868 
·¹
 =…¬t->
Ãxt
;

869 
h—d”
 = 
·¹
->
–ts
;

870 
i
 = 0;

873 ià(
·¿ms
->
numb”
) {

874 ià(
®loÿ‹d
 < 
h—d”
[
i
].
key
.
Ën
) {

875 
®loÿ‹d
 = 
h—d”
[
i
].
key
.
Ën
 + 16;

876 
lowÿ£_key
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
®loÿ‹d
);

877 ià(
lowÿ£_key
 =ð
NULL
) {

878  
NGX_ERROR
;

882 
hash
 = 0;

884 
n
 = 0;‚ < 
h—d”
[
i
].
key
.
Ën
;‚++) {

885 
ch
 = 
h—d”
[
i
].
key
.
d©a
[
n
];

887 ià(
ch
 >= 'A' && ch <= 'Z') {

888 
ch
 |= 0x20;

890 } ià(
ch
 == '-') {

891 
ch
 = '_';

894 
hash
 = 
	`ngx_hash
(hash, 
ch
);

895 
lowÿ£_key
[
n
] = 
ch
;

898 ià(
	`ngx_hash_fšd
(&
·¿ms
->
hash
, hash, 
lowÿ£_key
, 
n
)) {

899 
ignÜed
[
h—d”_·¿ms
++] = &
h—d”
[
i
];

904 
Ën
 +ð2 + ("HTTP_"è- 1 + 
h—d”
[
i
].
key
.len

905 + 2 + 
h—d”
[
i
].
v®ue
.
Ën
;

909 
Ën
 +ð
uwcf
->
uwsgi_¡ršg
.len;

913 ià(
Ën
 > 0 &&†en < 2) {

914 
	`ngx_log_”rÜ
 (
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

915 "uwsg˜»que¡ i toØl™Že: %uz", 
Ën
);

916  
NGX_ERROR
;

920 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
Ën
 + 4);

921 ià(
b
 =ð
NULL
) {

922  
NGX_ERROR
;

925 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

926 ià(
þ
 =ð
NULL
) {

927  
NGX_ERROR
;

930 
þ
->
buf
 = 
b
;

932 *
b
->
Ï¡
++ = (
u_ch¬
è
uwcf
->
modif›r1
;

933 *
b
->
Ï¡
++ = (
u_ch¬
è(
Ën
 & 0xff);

934 *
b
->
Ï¡
++ = (
u_ch¬
è((
Ën
 >> 8) & 0xff);

935 *
b
->
Ï¡
++ = (
u_ch¬
è
uwcf
->
modif›r2
;

937 ià(
·¿ms
->
Ëngths
) {

938 
	`ngx_memz”o
(&
e
, (
ngx_h‰p_süt_’gše_t
));

940 
e
.

 = 
·¿ms
->
v®ues
->
–ts
;

941 
e
.
pos
 = 
b
->
Ï¡
;

942 
e
.
»que¡
 = 
r
;

943 
e
.
æushed
 = 1;

945 
Ë
.

 = 
·¿ms
->
Ëngths
->
–ts
;

947 *(
ušŒ_t
 *è
Ë
.

) {

949 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

950 
key_Ën
 = (
u_ch¬
è
	`lcode
 (&
Ë
);

952 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

953 
sk_em±y
 = 
	`lcode
(&
Ë
);

955 
v®_Ën
 = 0; *(
ušŒ_t
 *è
Ë
.

; v®_ËÀ+ð
	`lcode
(&le)) {

956 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

958 
Ë
.

 +ð(
ušŒ_t
);

960 ià(
sk_em±y
 && 
v®_Ën
 == 0) {

961 
e
.
sk
 = 1;

963 *(
ušŒ_t
 *è
e
.

) {

964 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

965 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

967 
e
.

 +ð(
ušŒ_t
);

969 
e
.
sk
 = 0;

974 *
e
.
pos
++ = (
u_ch¬
è(
key_Ën
 & 0xff);

975 *
e
.
pos
++ = (
u_ch¬
è((
key_Ën
 >> 8) & 0xff);

977 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

978 
	`code
((
ngx_h‰p_süt_’gše_t
 *è& 
e
);

980 *
e
.
pos
++ = (
u_ch¬
è(
v®_Ën
 & 0xff);

981 *
e
.
pos
++ = (
u_ch¬
è((
v®_Ën
 >> 8) & 0xff);

983 *(
ušŒ_t
 *è
e
.

) {

984 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

985 
	`code
((
ngx_h‰p_süt_’gše_t
 *è& 
e
);

988 
e
.

 +ð(
ušŒ_t
);

990 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

992 
key_Ën
, 
e
.
pos
 - (key_ËÀ+ 2 + 
v®_Ën
),

993 
v®_Ën
, 
e
.
pos
 - val_len);

996 
b
->
Ï¡
 = 
e
.
pos
;

999 ià(
uwcf
->
up¡»am
.
·ss_»que¡_h—d”s
) {

1001 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

1002 
h—d”
 = 
·¹
->
–ts
;

1004 
i
 = 0; ; i++) {

1006 ià(
i
 >ð
·¹
->
ÃÉs
) {

1007 ià(
·¹
->
Ãxt
 =ð
NULL
) {

1011 
·¹
 =…¬t->
Ãxt
;

1012 
h—d”
 = 
·¹
->
–ts
;

1013 
i
 = 0;

1016 
n
 = 0;‚ < 
h—d”_·¿ms
;‚++) {

1017 ià(&
h—d”
[
i
] =ð
ignÜed
[
n
]) {

1018 
Ãxt
;

1022 
key_Ën
 = ("HTTP_"è- 1 + 
h—d”
[
i
].
key
.
Ën
;

1023 *
b
->
Ï¡
++ = (
u_ch¬
è(
key_Ën
 & 0xff);

1024 *
b
->
Ï¡
++ = (
u_ch¬
è((
key_Ën
 >> 8) & 0xff);

1026 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "HTTP_", ("HTTP_") - 1);

1027 
n
 = 0;‚ < 
h—d”
[
i
].
key
.
Ën
;‚++) {

1028 
ch
 = 
h—d”
[
i
].
key
.
d©a
[
n
];

1030 ià(
ch
 >= 'a' && ch <= 'z') {

1031 
ch
 &= ~0x20;

1033 } ià(
ch
 == '-') {

1034 
ch
 = '_';

1037 *
b
->
Ï¡
++ = 
ch
;

1040 
v®_Ën
 = 
h—d”
[
i
].
v®ue
.
Ën
;

1041 *
b
->
Ï¡
++ = (
u_ch¬
è(
v®_Ën
 & 0xff);

1042 *
b
->
Ï¡
++ = (
u_ch¬
è((
v®_Ën
 >> 8) & 0xff);

1043 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
h—d”
[
i
].
v®ue
.
d©a
, 
v®_Ën
);

1045 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1047 
key_Ën
, 
b
->
Ï¡
 - (key_ËÀ+ 2 + 
v®_Ën
),

1048 
v®_Ën
, 
b
->
Ï¡
 - val_len);

1049 
Ãxt
:

1055 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
uwcf
->
uwsgi_¡ršg
.
d©a
,

1056 
uwcf
->
uwsgi_¡ršg
.
Ën
);

1058 ià(
uwcf
->
up¡»am
.
·ss_»que¡_body
) {

1059 
body
 = 
r
->
up¡»am
->
»que¡_bufs
;

1060 
r
->
up¡»am
->
»que¡_bufs
 = 
þ
;

1062 
body
) {

1063 
b
 = 
	`ngx_®loc_buf
(
r
->
poÞ
);

1064 ià(
b
 =ð
NULL
) {

1065  
NGX_ERROR
;

1068 
	`ngx_memýy
(
b
, 
body
->
buf
, (
ngx_buf_t
));

1070 
þ
->
Ãxt
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

1071 ià(
þ
->
Ãxt
 =ð
NULL
) {

1072  
NGX_ERROR
;

1075 
þ
 = cl->
Ãxt
;

1076 
þ
->
buf
 = 
b
;

1078 
body
 = body->
Ãxt
;

1082 
r
->
up¡»am
->
»que¡_bufs
 = 
þ
;

1085 
þ
->
Ãxt
 = 
NULL
;

1087  
NGX_OK
;

1088 
	}
}

1091 
ngx_št_t


1092 
	$ngx_h‰p_uwsgi_»š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

1094 
ngx_h‰p_¡©us_t
 *
¡©us
;

1096 
¡©us
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_uwsgi_moduË
);

1098 ià(
¡©us
 =ð
NULL
) {

1099  
NGX_OK
;

1102 
¡©us
->
code
 = 0;

1103 
¡©us
->
couÁ
 = 0;

1104 
¡©us
->
¡¬t
 = 
NULL
;

1105 
¡©us
->
’d
 = 
NULL
;

1107 
r
->
up¡»am
->
´oûss_h—d”
 = 
ngx_h‰p_uwsgi_´oûss_¡©us_lše
;

1108 
r
->
¡©e
 = 0;

1110  
NGX_OK
;

1111 
	}
}

1114 
ngx_št_t


1115 
	$ngx_h‰p_uwsgi_´oûss_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
)

1117 
size_t
 
Ën
;

1118 
ngx_št_t
 
rc
;

1119 
ngx_h‰p_¡©us_t
 *
¡©us
;

1120 
ngx_h‰p_up¡»am_t
 *
u
;

1122 
¡©us
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_uwsgi_moduË
);

1124 ià(
¡©us
 =ð
NULL
) {

1125  
NGX_ERROR
;

1128 
u
 = 
r
->
up¡»am
;

1130 
rc
 = 
	`ngx_h‰p_·r£_¡©us_lše
(
r
, &
u
->
bufãr
, 
¡©us
);

1132 ià(
rc
 =ð
NGX_AGAIN
) {

1133  
rc
;

1136 ià(
rc
 =ð
NGX_ERROR
) {

1137 
u
->
´oûss_h—d”
 = 
ngx_h‰p_uwsgi_´oûss_h—d”
;

1138  
	`ngx_h‰p_uwsgi_´oûss_h—d”
(
r
);

1141 ià(
u
->
¡©e
 && u->¡©e->
¡©us
 == 0) {

1142 
u
->
¡©e
->
¡©us
 = stus->
code
;

1145 
u
->
h—d”s_š
.
¡©us_n
 = 
¡©us
->
code
;

1147 
Ën
 = 
¡©us
->
’d
 - stus->
¡¬t
;

1148 
u
->
h—d”s_š
.
¡©us_lše
.
Ën
 =†en;

1150 
u
->
h—d”s_š
.
¡©us_lše
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

1151 ià(
u
->
h—d”s_š
.
¡©us_lše
.
d©a
 =ð
NULL
) {

1152  
NGX_ERROR
;

1155 
	`ngx_memýy
(
u
->
h—d”s_š
.
¡©us_lše
.
d©a
, 
¡©us
->
¡¬t
, 
Ën
);

1157 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1159 
u
->
h—d”s_š
.
¡©us_n
, &u->h—d”s_š.
¡©us_lše
);

1161 
u
->
´oûss_h—d”
 = 
ngx_h‰p_uwsgi_´oûss_h—d”
;

1163  
	`ngx_h‰p_uwsgi_´oûss_h—d”
(
r
);

1164 
	}
}

1167 
ngx_št_t


1168 
	$ngx_h‰p_uwsgi_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

1170 
ngx_¡r_t
 *
¡©us_lše
;

1171 
ngx_št_t
 
rc
, 
¡©us
;

1172 
ngx_bË_–t_t
 *
h
;

1173 
ngx_h‰p_up¡»am_t
 *
u
;

1174 
ngx_h‰p_up¡»am_h—d”_t
 *
hh
;

1175 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

1177 
umcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_up¡»am_moduË
);

1181 
rc
 = 
	`ngx_h‰p_·r£_h—d”_lše
(
r
, &r->
up¡»am
->
bufãr
, 1);

1183 ià(
rc
 =ð
NGX_OK
) {

1187 
h
 = 
	`ngx_li¡_push
(&
r
->
up¡»am
->
h—d”s_š
.
h—d”s
);

1188 ià(
h
 =ð
NULL
) {

1189  
NGX_ERROR
;

1192 
h
->
hash
 = 
r
->
h—d”_hash
;

1194 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

1195 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

1197 
h
->
key
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

1198 
h
->
key
.
Ën
 + 1 + h->
v®ue
.len + 1

1199 + 
h
->
key
.
Ën
);

1200 ià(
h
->
key
.
d©a
 =ð
NULL
) {

1201  
NGX_ERROR
;

1204 
h
->
v®ue
.
d©a
 = h->
key
.d©¨+ h->key.
Ën
 + 1;

1205 
h
->
lowÿ£_key
 = h->
key
.
d©a
 + h->key.
Ën
 + 1 + h->
v®ue
.len + 1;

1207 
	`ngx_memýy
(
h
->
key
.
d©a
, 
r
->
h—d”_Çme_¡¬t
, h->key.
Ën
);

1208 
h
->
key
.
d©a
[h->key.
Ën
] = '\0';

1209 
	`ngx_memýy
(
h
->
v®ue
.
d©a
, 
r
->
h—d”_¡¬t
, h->v®ue.
Ën
);

1210 
h
->
v®ue
.
d©a
[h->v®ue.
Ën
] = '\0';

1212 ià(
h
->
key
.
Ën
 =ð
r
->
lowÿ£_šdex
) {

1213 
	`ngx_memýy
(
h
->
lowÿ£_key
, 
r
->
lowÿ£_h—d”
, h->
key
.
Ën
);

1216 
	`ngx_¡¾ow
(
h
->
lowÿ£_key
, h->
key
.
d©a
, h->key.
Ën
);

1219 
hh
 = 
	`ngx_hash_fšd
(&
umcf
->
h—d”s_š_hash
, 
h
->
hash
,

1220 
h
->
lowÿ£_key
, h->
key
.
Ën
);

1222 ià(
hh
 && hh->
	`hªdËr
(
r
, 
h
, hh->
off£t
è!ð
NGX_OK
) {

1223  
NGX_ERROR
;

1226 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1227 "h‰°uwsg˜h—d”: \"%V: %V\"", &
h
->
key
, &h->
v®ue
);

1232 ià(
rc
 =ð
NGX_HTTP_PARSE_HEADER_DONE
) {

1236 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1239 
u
 = 
r
->
up¡»am
;

1241 ià(
u
->
h—d”s_š
.
¡©us_n
) {

1242 
dÚe
;

1245 ià(
u
->
h—d”s_š
.
¡©us
) {

1246 
¡©us_lše
 = &
u
->
h—d”s_š
.
¡©us
->
v®ue
;

1248 
¡©us
 = 
	`ngx_©oi
(
¡©us_lše
->
d©a
, 3);

1249 ià(
¡©us
 =ð
NGX_ERROR
) {

1250 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1252 
¡©us_lše
);

1253  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1256 
u
->
h—d”s_š
.
¡©us_n
 = 
¡©us
;

1257 
u
->
h—d”s_š
.
¡©us_lše
 = *status_line;

1259 } ià(
u
->
h—d”s_š
.
loÿtiÚ
) {

1260 
u
->
h—d”s_š
.
¡©us_n
 = 302;

1261 
	`ngx_¡r_£t
(&
u
->
h—d”s_š
.
¡©us_lše
,

1265 
u
->
h—d”s_š
.
¡©us_n
 = 200;

1266 
	`ngx_¡r_£t
(&
u
->
h—d”s_š
.
¡©us_lše
, "200 OK");

1269 ià(
u
->
¡©e
 && u->¡©e->
¡©us
 == 0) {

1270 
u
->
¡©e
->
¡©us
 = u->
h—d”s_š
.
¡©us_n
;

1273 
dÚe
:

1275 ià(
u
->
h—d”s_š
.
¡©us_n
 =ð
NGX_HTTP_SWITCHING_PROTOCOLS


1276 && 
r
->
h—d”s_š
.
upg¿de
)

1278 
u
->
upg¿de
 = 1;

1281  
NGX_OK
;

1284 ià(
rc
 =ð
NGX_AGAIN
) {

1285  
NGX_AGAIN
;

1290 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1293  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

1295 
	}
}

1299 
	$ngx_h‰p_uwsgi_abÜt_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

1301 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1305 
	}
}

1309 
	$ngx_h‰p_uwsgi_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

1311 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1315 
	}
}

1319 
	$ngx_h‰p_uwsgi_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

1321 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
cÚf
;

1323 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_uwsgi_loc_cÚf_t
));

1324 ià(
cÚf
 =ð
NULL
) {

1325  
NULL
;

1328 
cÚf
->
modif›r1
 = 
NGX_CONF_UNSET_UINT
;

1329 
cÚf
->
modif›r2
 = 
NGX_CONF_UNSET_UINT
;

1331 
cÚf
->
up¡»am
.
¡Üe
 = 
NGX_CONF_UNSET
;

1332 
cÚf
->
up¡»am
.
¡Üe_acûss
 = 
NGX_CONF_UNSET_UINT
;

1333 
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
 = 
NGX_CONF_UNSET_UINT
;

1334 
cÚf
->
up¡»am
.
bufãršg
 = 
NGX_CONF_UNSET
;

1335 
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
 = 
NGX_CONF_UNSET
;

1336 
cÚf
->
up¡»am
.
fÜû_¿nges
 = 
NGX_CONF_UNSET
;

1338 
cÚf
->
up¡»am
.
loÿl
 = 
NGX_CONF_UNSET_PTR
;

1340 
cÚf
->
up¡»am
.
cÚÃù_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1341 
cÚf
->
up¡»am
.
£nd_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1342 
cÚf
->
up¡»am
.
»ad_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1343 
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1345 
cÚf
->
up¡»am
.
£nd_low©
 = 
NGX_CONF_UNSET_SIZE
;

1346 
cÚf
->
up¡»am
.
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

1347 
cÚf
->
up¡»am
.
lim™_¿‹
 = 
NGX_CONF_UNSET_SIZE
;

1349 
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

1350 
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

1351 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
 = 
NGX_CONF_UNSET_SIZE
;

1353 
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
 = 
NGX_CONF_UNSET
;

1354 
cÚf
->
up¡»am
.
·ss_»que¡_body
 = 
NGX_CONF_UNSET
;

1356 #ià(
NGX_HTTP_CACHE
)

1357 
cÚf
->
up¡»am
.
ÿche
 = 
NGX_CONF_UNSET_PTR
;

1358 
cÚf
->
up¡»am
.
ÿche_mš_u£s
 = 
NGX_CONF_UNSET_UINT
;

1359 
cÚf
->
up¡»am
.
ÿche_by·ss
 = 
NGX_CONF_UNSET_PTR
;

1360 
cÚf
->
up¡»am
.
no_ÿche
 = 
NGX_CONF_UNSET_PTR
;

1361 
cÚf
->
up¡»am
.
ÿche_v®id
 = 
NGX_CONF_UNSET_PTR
;

1362 
cÚf
->
up¡»am
.
ÿche_lock
 = 
NGX_CONF_UNSET
;

1363 
cÚf
->
up¡»am
.
ÿche_lock_timeout
 = 
NGX_CONF_UNSET_MSEC
;

1364 
cÚf
->
up¡»am
.
ÿche_lock_age
 = 
NGX_CONF_UNSET_MSEC
;

1365 
cÚf
->
up¡»am
.
ÿche_»v®id©e
 = 
NGX_CONF_UNSET
;

1368 
cÚf
->
up¡»am
.
hide_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

1369 
cÚf
->
up¡»am
.
·ss_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

1371 
cÚf
->
up¡»am
.
š‹rû±_”rÜs
 = 
NGX_CONF_UNSET
;

1373 #ià(
NGX_HTTP_SSL
)

1374 
cÚf
->
up¡»am
.
s¦_£ssiÚ_»u£
 = 
NGX_CONF_UNSET
;

1375 
cÚf
->
up¡»am
.
s¦_£rv”_Çme
 = 
NGX_CONF_UNSET
;

1376 
cÚf
->
up¡»am
.
s¦_v”ify
 = 
NGX_CONF_UNSET
;

1377 
cÚf
->
s¦_v”ify_d•th
 = 
NGX_CONF_UNSET_UINT
;

1378 
cÚf
->
s¦_·sswÜds
 = 
NGX_CONF_UNSET_PTR
;

1382 
cÚf
->
up¡»am
.
cyþic_‹mp_fže
 = 0;

1384 
cÚf
->
up¡»am
.
chªge_bufãršg
 = 1;

1386 
	`ngx_¡r_£t
(&
cÚf
->
up¡»am
.
moduË
, "uwsgi");

1388  
cÚf
;

1389 
	}
}

1393 
	$ngx_h‰p_uwsgi_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1395 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
´ev
 = 
·»Á
;

1396 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
cÚf
 = 
chžd
;

1398 
size_t
 
size
;

1399 
ngx_št_t
 
rc
;

1400 
ngx_hash_š™_t
 
hash
;

1401 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1403 ià(
cÚf
->
up¡»am
.
¡Üe
 != 0) {

1404 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
¡Üe
, 
´ev
->upstream.store, 0);

1406 ià(
cÚf
->
up¡»am
.
¡Üe_Ëngths
 =ð
NULL
) {

1407 
cÚf
->
up¡»am
.
¡Üe_Ëngths
 = 
´ev
->upstream.store_lengths;

1408 
cÚf
->
up¡»am
.
¡Üe_v®ues
 = 
´ev
->upstream.store_values;

1412 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
¡Üe_acûss
,

1413 
´ev
->
up¡»am
.
¡Üe_acûss
, 0600);

1415 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_Œ›s
,

1416 
´ev
->
up¡»am
.
Ãxt_up¡»am_Œ›s
, 0);

1418 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
bufãršg
,

1419 
´ev
->
up¡»am
.
bufãršg
, 1);

1421 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ignÜe_þ›Á_abÜt
,

1422 
´ev
->
up¡»am
.
ignÜe_þ›Á_abÜt
, 0);

1424 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
fÜû_¿nges
,

1425 
´ev
->
up¡»am
.
fÜû_¿nges
, 0);

1427 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
loÿl
,

1428 
´ev
->
up¡»am
.
loÿl
, 
NULL
);

1430 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
cÚÃù_timeout
,

1431 
´ev
->
up¡»am
.
cÚÃù_timeout
, 60000);

1433 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
£nd_timeout
,

1434 
´ev
->
up¡»am
.
£nd_timeout
, 60000);

1436 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
»ad_timeout
,

1437 
´ev
->
up¡»am
.
»ad_timeout
, 60000);

1439 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am_timeout
,

1440 
´ev
->
up¡»am
.
Ãxt_up¡»am_timeout
, 0);

1442 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
£nd_low©
,

1443 
´ev
->
up¡»am
.
£nd_low©
, 0);

1445 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
bufãr_size
,

1446 
´ev
->
up¡»am
.
bufãr_size
,

1447 (
size_t
è
ngx_·gesize
);

1449 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
lim™_¿‹
,

1450 
´ev
->
up¡»am
.
lim™_¿‹
, 0);

1453 
	`ngx_cÚf_m”ge_bufs_v®ue
(
cÚf
->
up¡»am
.
bufs
, 
´ev
->upstream.bufs,

1454 8, 
ngx_·gesize
);

1456 ià(
cÚf
->
up¡»am
.
bufs
.
num
 < 2) {

1457 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1459  
NGX_CONF_ERROR
;

1463 
size
 = 
cÚf
->
up¡»am
.
bufãr_size
;

1464 ià(
size
 < 
cÚf
->
up¡»am
.
bufs
.size) {

1465 
size
 = 
cÚf
->
up¡»am
.
bufs
.size;

1469 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
,

1470 
´ev
->
up¡»am
.
busy_bufãrs_size_cÚf
,

1471 
NGX_CONF_UNSET_SIZE
);

1473 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

1474 
cÚf
->
up¡»am
.
busy_bufãrs_size
 = 2 * 
size
;

1476 
cÚf
->
up¡»am
.
busy_bufãrs_size
 =

1477 
cÚf
->
up¡»am
.
busy_bufãrs_size_cÚf
;

1480 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size
 < 
size
) {

1481 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1486  
NGX_CONF_ERROR
;

1489 ià(
cÚf
->
up¡»am
.
busy_bufãrs_size


1490 > (
cÚf
->
up¡»am
.
bufs
.
num
 - 1è* cÚf->up¡»am.bufs.
size
)

1492 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1496  
NGX_CONF_ERROR
;

1500 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
,

1501 
´ev
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
,

1502 
NGX_CONF_UNSET_SIZE
);

1504 ià(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

1505 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 = 2 * 
size
;

1507 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 =

1508 
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size_cÚf
;

1511 ià(
cÚf
->
up¡»am
.
‹mp_fže_wr™e_size
 < 
size
) {

1512 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1517  
NGX_CONF_ERROR
;

1521 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
,

1522 
´ev
->
up¡»am
.
max_‹mp_fže_size_cÚf
,

1523 
NGX_CONF_UNSET_SIZE
);

1525 ià(
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
 =ð
NGX_CONF_UNSET_SIZE
) {

1526 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 = 1024 * 1024 * 1024;

1528 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 =

1529 
cÚf
->
up¡»am
.
max_‹mp_fže_size_cÚf
;

1532 ià(
cÚf
->
up¡»am
.
max_‹mp_fže_size
 != 0

1533 && 
cÚf
->
up¡»am
.
max_‹mp_fže_size
 < 
size
)

1535 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1541  
NGX_CONF_ERROR
;

1545 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
ignÜe_h—d”s
,

1546 
´ev
->
up¡»am
.
ignÜe_h—d”s
,

1547 
NGX_CONF_BITMASK_SET
);

1550 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
Ãxt_up¡»am
,

1551 
´ev
->
up¡»am
.
Ãxt_up¡»am
,

1552 (
NGX_CONF_BITMASK_SET


1553 |
NGX_HTTP_UPSTREAM_FT_ERROR


1554 |
NGX_HTTP_UPSTREAM_FT_TIMEOUT
));

1556 ià(
cÚf
->
up¡»am
.
Ãxt_up¡»am
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

1557 
cÚf
->
up¡»am
.
Ãxt_up¡»am
 = 
NGX_CONF_BITMASK_SET


1558 |
NGX_HTTP_UPSTREAM_FT_OFF
;

1561 ià(
	`ngx_cÚf_m”ge_·th_v®ue
(
cf
, &
cÚf
->
up¡»am
.
‹mp_·th
,

1562 
´ev
->
up¡»am
.
‹mp_·th
,

1563 &
ngx_h‰p_uwsgi_‹mp_·th
)

1564 !ð
NGX_OK
)

1566  
NGX_CONF_ERROR
;

1569 #ià(
NGX_HTTP_CACHE
)

1571 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche
,

1572 
´ev
->
up¡»am
.
ÿche
, 
NULL
);

1574 ià(
cÚf
->
up¡»am
.
ÿche
 && cÚf->up¡»am.ÿche->
d©a
 =ð
NULL
) {

1575 
ngx_shm_zÚe_t
 *
shm_zÚe
;

1577 
shm_zÚe
 = 
cÚf
->
up¡»am
.
ÿche
;

1579 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1581 &
shm_zÚe
->
shm
.
Çme
);

1583  
NGX_CONF_ERROR
;

1586 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
up¡»am
.
ÿche_mš_u£s
,

1587 
´ev
->
up¡»am
.
ÿche_mš_u£s
, 1);

1589 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
,

1590 
´ev
->
up¡»am
.
ÿche_u£_¡®e
,

1591 (
NGX_CONF_BITMASK_SET


1592 |
NGX_HTTP_UPSTREAM_FT_OFF
));

1594 ià(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_OFF
) {

1595 
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 = 
NGX_CONF_BITMASK_SET


1596 |
NGX_HTTP_UPSTREAM_FT_OFF
;

1599 ià(
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_ERROR
) {

1600 
cÚf
->
up¡»am
.
ÿche_u£_¡®e
 |ð
NGX_HTTP_UPSTREAM_FT_NOLIVE
;

1603 ià(
cÚf
->
up¡»am
.
ÿche_m‘hods
 == 0) {

1604 
cÚf
->
up¡»am
.
ÿche_m‘hods
 = 
´ev
->upstream.cache_methods;

1607 
cÚf
->
up¡»am
.
ÿche_m‘hods
 |ð
NGX_HTTP_GET
|
NGX_HTTP_HEAD
;

1609 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche_by·ss
,

1610 
´ev
->
up¡»am
.
ÿche_by·ss
, 
NULL
);

1612 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
no_ÿche
,

1613 
´ev
->
up¡»am
.
no_ÿche
, 
NULL
);

1615 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
up¡»am
.
ÿche_v®id
,

1616 
´ev
->
up¡»am
.
ÿche_v®id
, 
NULL
);

1618 ià(
cÚf
->
ÿche_key
.
v®ue
.
d©a
 =ð
NULL
) {

1619 
cÚf
->
ÿche_key
 = 
´ev
->cache_key;

1622 ià(
cÚf
->
up¡»am
.
ÿche
 && cÚf->
ÿche_key
.
v®ue
.
d©a
 =ð
NULL
) {

1623 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1627 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock
,

1628 
´ev
->
up¡»am
.
ÿche_lock
, 0);

1630 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock_timeout
,

1631 
´ev
->
up¡»am
.
ÿche_lock_timeout
, 5000);

1633 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
up¡»am
.
ÿche_lock_age
,

1634 
´ev
->
up¡»am
.
ÿche_lock_age
, 5000);

1636 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
ÿche_»v®id©e
,

1637 
´ev
->
up¡»am
.
ÿche_»v®id©e
, 0);

1641 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
·ss_»que¡_h—d”s
,

1642 
´ev
->
up¡»am
.
·ss_»que¡_h—d”s
, 1);

1643 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
·ss_»que¡_body
,

1644 
´ev
->
up¡»am
.
·ss_»que¡_body
, 1);

1646 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
š‹rû±_”rÜs
,

1647 
´ev
->
up¡»am
.
š‹rû±_”rÜs
, 0);

1649 #ià(
NGX_HTTP_SSL
)

1651 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
s¦_£ssiÚ_»u£
,

1652 
´ev
->
up¡»am
.
s¦_£ssiÚ_»u£
, 1);

1654 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
s¦_´ÙocÞs
, 
´ev
->ssl_protocols,

1655 (
NGX_CONF_BITMASK_SET
|
NGX_SSL_SSLv3


1656 |
NGX_SSL_TLSv1
|
NGX_SSL_TLSv1_1


1657 |
NGX_SSL_TLSv1_2
));

1659 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_ch”s
, 
´ev
->ssl_ciphers,

1662 ià(
cÚf
->
up¡»am
.
s¦_Çme
 =ð
NULL
) {

1663 
cÚf
->
up¡»am
.
s¦_Çme
 = 
´ev
->upstream.ssl_name;

1666 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
s¦_£rv”_Çme
,

1667 
´ev
->
up¡»am
.
s¦_£rv”_Çme
, 0);

1668 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
up¡»am
.
s¦_v”ify
,

1669 
´ev
->
up¡»am
.
s¦_v”ify
, 0);

1670 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
s¦_v”ify_d•th
,

1671 
´ev
->
s¦_v”ify_d•th
, 1);

1672 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_Œu¡ed_û¹ifiÿ‹
,

1673 
´ev
->
s¦_Œu¡ed_û¹ifiÿ‹
, "");

1674 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_ül
, 
´ev
->ssl_crl, "");

1676 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_û¹ifiÿ‹
,

1677 
´ev
->
s¦_û¹ifiÿ‹
, "");

1678 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
s¦_û¹ifiÿ‹_key
,

1679 
´ev
->
s¦_û¹ifiÿ‹_key
, "");

1680 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
s¦_·sswÜds
, 
´ev
->s¦_·sswÜds, 
NULL
);

1682 ià(
cÚf
->
s¦
 && 
	`ngx_h‰p_uwsgi_£t_s¦
(
cf
, cÚfè!ð
NGX_OK
) {

1683  
NGX_CONF_ERROR
;

1686 ià(
cÚf
->
up¡»am
.
s¦
 =ð
NULL
) {

1687 
cÚf
->
up¡»am
.
s¦
 = 
´ev
->upstream.ssl;

1692 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
uwsgi_¡ršg
, 
´ev
->uwsgi_string, "");

1694 
hash
.
max_size
 = 512;

1695 
hash
.
buck‘_size
 = 
	`ngx_®ign
(64, 
ngx_ÿch–še_size
);

1696 
hash
.
Çme
 = "uwsgi_hide_headers_hash";

1698 ià(
	`ngx_h‰p_up¡»am_hide_h—d”s_hash
(
cf
, &
cÚf
->
up¡»am
,

1699 &
´ev
->
up¡»am
, 
ngx_h‰p_uwsgi_hide_h—d”s
, &
hash
)

1700 !ð
NGX_OK
)

1702  
NGX_CONF_ERROR
;

1705 ià(
cÚf
->
up¡»am
.up¡»am =ð
NULL
) {

1706 
cÚf
->
up¡»am
.up¡»am = 
´ev
->upstream.upstream;

1709 ià(
cÚf
->
uwsgi_Ëngths
 =ð
NULL
) {

1710 
cÚf
->
uwsgi_Ëngths
 = 
´ev
->uwsgi_lengths;

1711 
cÚf
->
uwsgi_v®ues
 = 
´ev
->uwsgi_values;

1714 ià(
cÚf
->
up¡»am
.up¡»am || cÚf->
uwsgi_Ëngths
) {

1715 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

1716 ià(
þcf
->
hªdËr
 =ð
NULL
 && clcf->
lmt_exýt
) {

1717 
þcf
->
hªdËr
 = 
ngx_h‰p_uwsgi_hªdËr
;

1721 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
modif›r1
, 
´ev
->modifier1, 0);

1722 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
modif›r2
, 
´ev
->modifier2, 0);

1724 ià(
cÚf
->
·¿ms_sourû
 =ð
NULL
) {

1725 
cÚf
->
·¿ms
 = 
´ev
->params;

1726 #ià(
NGX_HTTP_CACHE
)

1727 
cÚf
->
·¿ms_ÿche
 = 
´ev
->params_cache;

1729 
cÚf
->
·¿ms_sourû
 = 
´ev
->params_source;

1732 
rc
 = 
	`ngx_h‰p_uwsgi_š™_·¿ms
(
cf
, 
cÚf
, &cÚf->
·¿ms
, 
NULL
);

1733 ià(
rc
 !ð
NGX_OK
) {

1734  
NGX_CONF_ERROR
;

1737 #ià(
NGX_HTTP_CACHE
)

1739 ià(
cÚf
->
up¡»am
.
ÿche
) {

1740 
rc
 = 
	`ngx_h‰p_uwsgi_š™_·¿ms
(
cf
, 
cÚf
, &cÚf->
·¿ms_ÿche
,

1741 
ngx_h‰p_uwsgi_ÿche_h—d”s
);

1742 ià(
rc
 !ð
NGX_OK
) {

1743  
NGX_CONF_ERROR
;

1749  
NGX_CONF_OK
;

1750 
	}
}

1753 
ngx_št_t


1754 
	$ngx_h‰p_uwsgi_š™_·¿ms
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
cÚf
,

1755 
ngx_h‰p_uwsgi_·¿ms_t
 *
·¿ms
, 
ngx_keyv®_t
 *
deçuÉ_·¿ms
)

1757 
u_ch¬
 *
p
;

1758 
size_t
 
size
;

1759 
ušŒ_t
 *
code
;

1760 
ngx_ušt_t
 
i
, 
n¤c
;

1761 
ngx_¬¿y_t
 
h—d”s_Çmes
, 
·¿ms_m”ged
;

1762 
ngx_keyv®_t
 *
h
;

1763 
ngx_hash_key_t
 *
hk
;

1764 
ngx_hash_š™_t
 
hash
;

1765 
ngx_h‰p_up¡»am_·¿m_t
 *
¤c
, *
s
;

1766 
ngx_h‰p_süt_compže_t
 
sc
;

1767 
ngx_h‰p_süt_cÝy_code_t
 *
cÝy
;

1769 ià(
·¿ms
->
hash
.
buck‘s
) {

1770  
NGX_OK
;

1773 ià(
cÚf
->
·¿ms_sourû
 =ð
NULL
 && 
deçuÉ_·¿ms
 == NULL) {

1774 
·¿ms
->
hash
.
buck‘s
 = (*) 1;

1775  
NGX_OK
;

1778 
·¿ms
->
Ëngths
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 64, 1);

1779 ià(
·¿ms
->
Ëngths
 =ð
NULL
) {

1780  
NGX_ERROR
;

1783 
·¿ms
->
v®ues
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 512, 1);

1784 ià(
·¿ms
->
v®ues
 =ð
NULL
) {

1785  
NGX_ERROR
;

1788 ià(
	`ngx_¬¿y_š™
(&
h—d”s_Çmes
, 
cf
->
‹mp_poÞ
, 4, (
ngx_hash_key_t
))

1789 !ð
NGX_OK
)

1791  
NGX_ERROR
;

1794 ià(
cÚf
->
·¿ms_sourû
) {

1795 
¤c
 = 
cÚf
->
·¿ms_sourû
->
–ts
;

1796 
n¤c
 = 
cÚf
->
·¿ms_sourû
->
ÃÉs
;

1799 
¤c
 = 
NULL
;

1800 
n¤c
 = 0;

1803 ià(
deçuÉ_·¿ms
) {

1804 ià(
	`ngx_¬¿y_š™
(&
·¿ms_m”ged
, 
cf
->
‹mp_poÞ
, 4,

1805 (
ngx_h‰p_up¡»am_·¿m_t
))

1806 !ð
NGX_OK
)

1808  
NGX_ERROR
;

1811 
i
 = 0; i < 
n¤c
; i++) {

1813 
s
 = 
	`ngx_¬¿y_push
(&
·¿ms_m”ged
);

1814 ià(
s
 =ð
NULL
) {

1815  
NGX_ERROR
;

1818 *
s
 = 
¤c
[
i
];

1821 
h
 = 
deçuÉ_·¿ms
;

1823 
h
->
key
.
Ën
) {

1825 
¤c
 = 
·¿ms_m”ged
.
–ts
;

1826 
n¤c
 = 
·¿ms_m”ged
.
ÃÉs
;

1828 
i
 = 0; i < 
n¤c
; i++) {

1829 ià(
	`ngx_¡rÿ£cmp
(
h
->
key
.
d©a
, 
¤c
[
i
].key.data) == 0) {

1830 
Ãxt
;

1834 
s
 = 
	`ngx_¬¿y_push
(&
·¿ms_m”ged
);

1835 ià(
s
 =ð
NULL
) {

1836  
NGX_ERROR
;

1839 
s
->
key
 = 
h
->key;

1840 
s
->
v®ue
 = 
h
->value;

1841 
s
->
sk_em±y
 = 1;

1843 
Ãxt
:

1845 
h
++;

1848 
¤c
 = 
·¿ms_m”ged
.
–ts
;

1849 
n¤c
 = 
·¿ms_m”ged
.
ÃÉs
;

1852 
i
 = 0; i < 
n¤c
; i++) {

1854 ià(
¤c
[
i
].
key
.
Ën
 > ("HTTP_") - 1

1855 && 
	`ngx_¡ºcmp
(
¤c
[
i
].
key
.
d©a
, "HTTP_", ("HTTP_") - 1) == 0)

1857 
hk
 = 
	`ngx_¬¿y_push
(&
h—d”s_Çmes
);

1858 ià(
hk
 =ð
NULL
) {

1859  
NGX_ERROR
;

1862 
hk
->
key
.
Ën
 = 
¤c
[
i
].key.len - 5;

1863 
hk
->
key
.
d©a
 = 
¤c
[
i
].key.data + 5;

1864 
hk
->
key_hash
 = 
	`ngx_hash_key_lc
(hk->
key
.
d©a
, hk->key.
Ën
);

1865 
hk
->
v®ue
 = (*) 1;

1867 ià(
¤c
[
i
].
v®ue
.
Ën
 == 0) {

1872 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
,

1873 (
ngx_h‰p_süt_cÝy_code_t
));

1874 ià(
cÝy
 =ð
NULL
) {

1875  
NGX_ERROR
;

1878 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_cÝy_Ën_code
;

1879 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len;

1881 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
,

1882 (
ngx_h‰p_süt_cÝy_code_t
));

1883 ià(
cÝy
 =ð
NULL
) {

1884  
NGX_ERROR
;

1887 
cÝy
->
code
 = (
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_cÝy_Ën_code
;

1888 
cÝy
->
Ën
 = 
¤c
[
i
].
sk_em±y
;

1891 
size
 = ((
ngx_h‰p_süt_cÝy_code_t
)

1892 + 
¤c
[
i
].
key
.
Ën
 + (
ušŒ_t
) - 1)

1893 & ~((
ušŒ_t
) - 1);

1895 
cÝy
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
v®ues
, 
size
);

1896 ià(
cÝy
 =ð
NULL
) {

1897  
NGX_ERROR
;

1900 
cÝy
->
code
 = 
ngx_h‰p_süt_cÝy_code
;

1901 
cÝy
->
Ën
 = 
¤c
[
i
].
key
.len;

1903 
p
 = (
u_ch¬
 *è
cÝy
 + (
ngx_h‰p_süt_cÝy_code_t
);

1904 
	`ngx_memýy
(
p
, 
¤c
[
i
].
key
.
d©a
, src[i].key.
Ën
);

1907 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

1909 
sc
.
cf
 = cf;

1910 
sc
.
sourû
 = &
¤c
[
i
].
v®ue
;

1911 
sc
.
æushes
 = &
·¿ms
->flushes;

1912 
sc
.
Ëngths
 = &
·¿ms
->lengths;

1913 
sc
.
v®ues
 = &
·¿ms
->values;

1915 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

1916  
NGX_ERROR
;

1919 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
, (
ušŒ_t
));

1920 ià(
code
 =ð
NULL
) {

1921  
NGX_ERROR
;

1924 *
code
 = (
ušŒ_t
è
NULL
;

1927 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
v®ues
, (
ušŒ_t
));

1928 ià(
code
 =ð
NULL
) {

1929  
NGX_ERROR
;

1932 *
code
 = (
ušŒ_t
è
NULL
;

1935 
code
 = 
	`ngx_¬¿y_push_n
(
·¿ms
->
Ëngths
, (
ušŒ_t
));

1936 ià(
code
 =ð
NULL
) {

1937  
NGX_ERROR
;

1940 *
code
 = (
ušŒ_t
è
NULL
;

1942 
·¿ms
->
numb”
 = 
h—d”s_Çmes
.
ÃÉs
;

1944 
hash
.hash = &
·¿ms
->hash;

1945 
hash
.
key
 = 
ngx_hash_key_lc
;

1946 
hash
.
max_size
 = 512;

1947 
hash
.
buck‘_size
 = 64;

1948 
hash
.
Çme
 = "uwsgi_params_hash";

1949 
hash
.
poÞ
 = 
cf
->pool;

1950 
hash
.
‹mp_poÞ
 = 
NULL
;

1952  
	`ngx_hash_š™
(&
hash
, 
h—d”s_Çmes
.
–ts
, h—d”s_Çmes.
ÃÉs
);

1953 
	}
}

1957 
	$ngx_h‰p_uwsgi_·ss
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1959 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
 = 
cÚf
;

1961 
size_t
 
add
;

1962 
ngx_u¾_t
 
u
;

1963 
ngx_¡r_t
 *
v®ue
, *
u¾
;

1964 
ngx_ušt_t
 
n
;

1965 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1966 
ngx_h‰p_süt_compže_t
 
sc
;

1968 ià(
uwcf
->
up¡»am
.up¡»am || uwcf->
uwsgi_Ëngths
) {

1972 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

1973 
þcf
->
hªdËr
 = 
ngx_h‰p_uwsgi_hªdËr
;

1975 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1977 
u¾
 = &
v®ue
[1];

1979 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(
u¾
);

1981 ià(
n
) {

1983 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

1985 
sc
.
cf
 = cf;

1986 
sc
.
sourû
 = 
u¾
;

1987 
sc
.
Ëngths
 = &
uwcf
->
uwsgi_Ëngths
;

1988 
sc
.
v®ues
 = &
uwcf
->
uwsgi_v®ues
;

1989 
sc
.
v¬ŸbËs
 = 
n
;

1990 
sc
.
com¶‘e_Ëngths
 = 1;

1991 
sc
.
com¶‘e_v®ues
 = 1;

1993 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

1994  
NGX_CONF_ERROR
;

1997 #ià(
NGX_HTTP_SSL
)

1998 
uwcf
->
s¦
 = 1;

2001  
NGX_CONF_OK
;

2004 ià(
	`ngx_¡ºÿ£cmp
(
u¾
->
d©a
, (
u_ch¬
 *) "uwsgi://", 8) == 0) {

2005 
add
 = 8;

2007 } ià(
	`ngx_¡ºÿ£cmp
(
u¾
->
d©a
, (
u_ch¬
 *) "suwsgi://", 9) == 0) {

2009 #ià(
NGX_HTTP_SSL
)

2010 
add
 = 9;

2011 
uwcf
->
s¦
 = 1;

2013 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2015  
NGX_CONF_ERROR
;

2019 
add
 = 0;

2022 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

2024 
u
.
u¾
.
Ën
 = u¾->ËÀ- 
add
;

2025 
u
.
u¾
.
d©a
 = u¾->d©¨+ 
add
;

2026 
u
.
no_»sÞve
 = 1;

2028 
uwcf
->
up¡»am
.up¡»am = 
	`ngx_h‰p_up¡»am_add
(
cf
, &
u
, 0);

2029 ià(
uwcf
->
up¡»am
.up¡»am =ð
NULL
) {

2030  
NGX_CONF_ERROR
;

2033 ià(
þcf
->
Çme
.
d©a
[þcf->Çme.
Ën
 - 1] == '/') {

2034 
þcf
->
auto_»dœeù
 = 1;

2037  
NGX_CONF_OK
;

2038 
	}
}

2042 
	$ngx_h‰p_uwsgi_¡Üe
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

2044 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
 = 
cÚf
;

2046 
ngx_¡r_t
 *
v®ue
;

2047 
ngx_h‰p_süt_compže_t
 
sc
;

2049 ià(
uwcf
->
up¡»am
.
¡Üe
 !ð
NGX_CONF_UNSET
 || uwcf->up¡»am.
¡Üe_Ëngths
)

2054 
v®ue
 = 
cf
->
¬gs
->
–ts
;

2056 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

2057 
uwcf
->
up¡»am
.
¡Üe
 = 0;

2058  
NGX_CONF_OK
;

2061 #ià(
NGX_HTTP_CACHE
)

2063 ià(
uwcf
->
up¡»am
.
ÿche
 !ð
NGX_CONF_UNSET_PTR


2064 && 
uwcf
->
up¡»am
.
ÿche
 !ð
NULL
)

2071 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "on") == 0) {

2072 
uwcf
->
up¡»am
.
¡Üe
 = 1;

2073  
NGX_CONF_OK
;

2077 
v®ue
[1].
Ën
++;

2079 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

2081 
sc
.
cf
 = cf;

2082 
sc
.
sourû
 = &
v®ue
[1];

2083 
sc
.
Ëngths
 = &
uwcf
->
up¡»am
.
¡Üe_Ëngths
;

2084 
sc
.
v®ues
 = &
uwcf
->
up¡»am
.
¡Üe_v®ues
;

2085 
sc
.
v¬ŸbËs
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
v®ue
[1]);

2086 
sc
.
com¶‘e_Ëngths
 = 1;

2087 
sc
.
com¶‘e_v®ues
 = 1;

2089 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

2090  
NGX_CONF_ERROR
;

2093  
NGX_CONF_OK
;

2094 
	}
}

2097 #ià(
NGX_HTTP_CACHE
)

2100 
	$ngx_h‰p_uwsgi_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

2102 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
 = 
cÚf
;

2104 
ngx_¡r_t
 *
v®ue
;

2106 
v®ue
 = 
cf
->
¬gs
->
–ts
;

2108 ià(
uwcf
->
up¡»am
.
ÿche
 !ð
NGX_CONF_UNSET_PTR
) {

2112 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

2113 
uwcf
->
up¡»am
.
ÿche
 = 
NULL
;

2114  
NGX_CONF_OK
;

2117 ià(
uwcf
->
up¡»am
.
¡Üe
 > 0 || uwcf->up¡»am.
¡Üe_Ëngths
) {

2121 
uwcf
->
up¡»am
.
ÿche
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
v®ue
[1], 0,

2122 &
ngx_h‰p_uwsgi_moduË
);

2123 ià(
uwcf
->
up¡»am
.
ÿche
 =ð
NULL
) {

2124  
NGX_CONF_ERROR
;

2127  
NGX_CONF_OK
;

2128 
	}
}

2132 
	$ngx_h‰p_uwsgi_ÿche_key
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

2134 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
 = 
cÚf
;

2136 
ngx_¡r_t
 *
v®ue
;

2137 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

2139 
v®ue
 = 
cf
->
¬gs
->
–ts
;

2141 ià(
uwcf
->
ÿche_key
.
v®ue
.
d©a
) {

2145 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

2147 
ccv
.
cf
 = cf;

2148 
ccv
.
v®ue
 = &value[1];

2149 
ccv
.
com¶ex_v®ue
 = &
uwcf
->
ÿche_key
;

2151 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

2152  
NGX_CONF_ERROR
;

2155  
NGX_CONF_OK
;

2156 
	}
}

2161 #ià(
NGX_HTTP_SSL
)

2164 
	$ngx_h‰p_uwsgi_s¦_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

2166 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
 = 
cÚf
;

2168 
ngx_¡r_t
 *
v®ue
;

2170 ià(
uwcf
->
s¦_·sswÜds
 !ð
NGX_CONF_UNSET_PTR
) {

2174 
v®ue
 = 
cf
->
¬gs
->
–ts
;

2176 
uwcf
->
s¦_·sswÜds
 = 
	`ngx_s¦_»ad_·sswÜd_fže
(
cf
, &
v®ue
[1]);

2178 ià(
uwcf
->
s¦_·sswÜds
 =ð
NULL
) {

2179  
NGX_CONF_ERROR
;

2182  
NGX_CONF_OK
;

2183 
	}
}

2186 
ngx_št_t


2187 
	$ngx_h‰p_uwsgi_£t_s¦
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_uwsgi_loc_cÚf_t
 *
uwcf
)

2189 
ngx_poÞ_þ—nup_t
 *
þn
;

2191 
uwcf
->
up¡»am
.
s¦
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_s¦_t
));

2192 ià(
uwcf
->
up¡»am
.
s¦
 =ð
NULL
) {

2193  
NGX_ERROR
;

2196 
uwcf
->
up¡»am
.
s¦
->
log
 = 
cf
->log;

2198 ià(
	`ngx_s¦_ü—‹
(
uwcf
->
up¡»am
.
s¦
, uwcf->
s¦_´ÙocÞs
, 
NULL
)

2199 !ð
NGX_OK
)

2201  
NGX_ERROR
;

2204 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

2205 ià(
þn
 =ð
NULL
) {

2206  
NGX_ERROR
;

2209 
þn
->
hªdËr
 = 
ngx_s¦_þ—nup_ùx
;

2210 
þn
->
d©a
 = 
uwcf
->
up¡»am
.
s¦
;

2212 ià(
uwcf
->
s¦_û¹ifiÿ‹
.
Ën
) {

2214 ià(
uwcf
->
s¦_û¹ifiÿ‹_key
.
Ën
 == 0) {

2215 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

2217 "fÜ c”tifiÿ‹ \"%V\"", &
uwcf
->
s¦_û¹ifiÿ‹
);

2218  
NGX_ERROR
;

2221 ià(
	`ngx_s¦_û¹ifiÿ‹
(
cf
, 
uwcf
->
up¡»am
.
s¦
, &uwcf->
s¦_û¹ifiÿ‹
,

2222 &
uwcf
->
s¦_û¹ifiÿ‹_key
, uwcf->
s¦_·sswÜds
)

2223 !ð
NGX_OK
)

2225  
NGX_ERROR
;

2229 ià(
	`SSL_CTX_£t_ch”_li¡
(
uwcf
->
up¡»am
.
s¦
->
ùx
,

2230 (cÚ¡ *è
uwcf
->
s¦_ch”s
.
d©a
)

2233 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

2235 &
uwcf
->
s¦_ch”s
);

2236  
NGX_ERROR
;

2239 ià(
uwcf
->
up¡»am
.
s¦_v”ify
) {

2240 ià(
uwcf
->
s¦_Œu¡ed_û¹ifiÿ‹
.
Ën
 == 0) {

2241 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

2243  
NGX_ERROR
;

2246 ià(
	`ngx_s¦_Œu¡ed_û¹ifiÿ‹
(
cf
, 
uwcf
->
up¡»am
.
s¦
,

2247 &
uwcf
->
s¦_Œu¡ed_û¹ifiÿ‹
,

2248 
uwcf
->
s¦_v”ify_d•th
)

2249 !ð
NGX_OK
)

2251  
NGX_ERROR
;

2254 ià(
	`ngx_s¦_ül
(
cf
, 
uwcf
->
up¡»am
.
s¦
, &uwcf->
s¦_ül
è!ð
NGX_OK
) {

2255  
NGX_ERROR
;

2259  
NGX_OK
;

2260 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_xslt_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

12 
	~<libxml/·r£r.h
>

13 
	~<libxml/Œ“.h
>

14 
	~<libx¦t/x¦t.h
>

15 
	~<libx¦t/x¦tIÁ”Çls.h
>

16 
	~<libx¦t/ŒªsfÜm.h
>

17 
	~<libx¦t/v¬ŸbËs.h
>

18 
	~<libx¦t/x¦tutžs.h
>

20 #ià(
NGX_HAVE_EXSLT
)

21 
	~<libex¦t/ex¦t.h
>

25 #iâdeà
NGX_HTTP_XSLT_REUSE_DTD


26 
	#NGX_HTTP_XSLT_REUSE_DTD
 1

	)

31 
u_ch¬
 *
	mÇme
;

32 *
	md©a
;

33 } 
	tngx_h‰p_x¦t_fže_t
;

37 
ngx_¬¿y_t
 
	mdtd_fžes
;

38 
ngx_¬¿y_t
 
	msh“t_fžes
;

39 } 
	tngx_h‰p_x¦t_fž‹r_maš_cÚf_t
;

43 
u_ch¬
 *
	mÇme
;

44 
ngx_h‰p_com¶ex_v®ue_t
 
	mv®ue
;

45 
ngx_ušt_t
 
	mquÙe
;

46 } 
	tngx_h‰p_x¦t_·¿m_t
;

50 
x¦tStyËsh“tPŒ
 
	m¡yËsh“t
;

51 
ngx_¬¿y_t
 
	m·¿ms
;

52 } 
	tngx_h‰p_x¦t_sh“t_t
;

56 
xmlDtdPŒ
 
	mdtd
;

57 
ngx_¬¿y_t
 
	msh“ts
;

58 
ngx_hash_t
 
	mty³s
;

59 
ngx_¬¿y_t
 *
	mty³s_keys
;

60 
ngx_¬¿y_t
 *
	m·¿ms
;

61 
ngx_æag_t
 
	mÏ¡_modif›d
;

62 } 
	tngx_h‰p_x¦t_fž‹r_loc_cÚf_t
;

66 
xmlDocPŒ
 
	mdoc
;

67 
xmlP¬£rCtxtPŒ
 
	mùxt
;

68 
x¦tT¿nsfÜmCÚ‹xtPŒ
 
	mŒªsfÜm
;

69 
ngx_h‰p_»que¡_t
 *
	m»que¡
;

70 
ngx_¬¿y_t
 
	m·¿ms
;

72 
ngx_ušt_t
 
	mdÚe
;

73 } 
	tngx_h‰p_x¦t_fž‹r_ùx_t
;

76 
ngx_št_t
 
ngx_h‰p_x¦t_£nd
(
ngx_h‰p_»que¡_t
 *
r
,

77 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
, 
ngx_buf_t
 *
b
);

78 
ngx_št_t
 
ngx_h‰p_x¦t_add_chunk
(
ngx_h‰p_»que¡_t
 *
r
,

79 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
, 
ngx_buf_t
 *
b
);

82 
ngx_h‰p_x¦t_§x_ex‹º®_sub£t
(*
d©a
, cÚ¡ 
xmlCh¬
 *
Çme
,

83 cÚ¡ 
xmlCh¬
 *
ex‹º®Id
, cÚ¡ xmlCh¬ *
sy¡emId
);

84 
ngx_cdeþ
 
ngx_h‰p_x¦t_§x_”rÜ
(*
d©a
, cÚ¡ *
msg
, ...);

87 
ngx_buf_t
 *
ngx_h‰p_x¦t_­¶y_¡yËsh“t
(
ngx_h‰p_»que¡_t
 *
r
,

88 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
);

89 
ngx_št_t
 
ngx_h‰p_x¦t_·¿ms
(
ngx_h‰p_»que¡_t
 *
r
,

90 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
, 
ngx_¬¿y_t
 *
·¿ms
, 
ngx_ušt_t
 
fš®
);

91 
u_ch¬
 *
ngx_h‰p_x¦t_cÚ‹Á_ty³
(
x¦tStyËsh“tPŒ
 
s
);

92 
u_ch¬
 *
ngx_h‰p_x¦t_’codšg
(
x¦tStyËsh“tPŒ
 
s
);

93 
ngx_h‰p_x¦t_þ—nup
(*
d©a
);

95 *
ngx_h‰p_x¦t_’t™›s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

96 *
cÚf
);

97 *
ngx_h‰p_x¦t_¡yËsh“t
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

98 *
cÚf
);

99 *
ngx_h‰p_x¦t_·¿m
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

100 *
cÚf
);

101 
ngx_h‰p_x¦t_þ—nup_dtd
(*
d©a
);

102 
ngx_h‰p_x¦t_þ—nup_¡yËsh“t
(*
d©a
);

103 *
ngx_h‰p_x¦t_fž‹r_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

104 *
ngx_h‰p_x¦t_fž‹r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

105 *
ngx_h‰p_x¦t_fž‹r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

106 *
chžd
);

107 
ngx_št_t
 
ngx_h‰p_x¦t_fž‹r_´ecÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
);

108 
ngx_št_t
 
ngx_h‰p_x¦t_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

109 
ngx_h‰p_x¦t_fž‹r_ex™
(
ngx_cyþe_t
 *
cyþe
);

112 
ngx_¡r_t
 
	gngx_h‰p_x¦t_deçuÉ_ty³s
[] = {

113 
ngx_¡ršg
("text/xml"),

114 
ngx_nuÎ_¡ršg


118 
ngx_commªd_t
 
	gngx_h‰p_x¦t_fž‹r_commªds
[] = {

120 { 
ngx_¡ršg
("xml_entities"),

121 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

122 
ngx_h‰p_x¦t_’t™›s
,

123 
NGX_HTTP_LOC_CONF_OFFSET
,

125 
NULL
 },

127 { 
ngx_¡ršg
("xslt_stylesheet"),

128 
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

129 
ngx_h‰p_x¦t_¡yËsh“t
,

130 
NGX_HTTP_LOC_CONF_OFFSET
,

132 
NULL
 },

134 { 
ngx_¡ršg
("xslt_param"),

135 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

136 
ngx_h‰p_x¦t_·¿m
,

137 
NGX_HTTP_LOC_CONF_OFFSET
,

139 
NULL
 },

141 { 
ngx_¡ršg
("xslt_string_param"),

142 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

143 
ngx_h‰p_x¦t_·¿m
,

144 
NGX_HTTP_LOC_CONF_OFFSET
,

148 { 
ngx_¡ršg
("xslt_types"),

149 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

150 
ngx_h‰p_ty³s_¦Ù
,

151 
NGX_HTTP_LOC_CONF_OFFSET
,

152 
off£tof
(
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
, 
ty³s_keys
),

153 &
ngx_h‰p_x¦t_deçuÉ_ty³s
[0] },

155 { 
ngx_¡ršg
("xslt_last_modified"),

156 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

157 
ngx_cÚf_£t_æag_¦Ù
,

158 
NGX_HTTP_LOC_CONF_OFFSET
,

159 
off£tof
(
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
, 
Ï¡_modif›d
),

160 
NULL
 },

162 
ngx_nuÎ_commªd


166 
ngx_h‰p_moduË_t
 
	gngx_h‰p_x¦t_fž‹r_moduË_ùx
 = {

167 
ngx_h‰p_x¦t_fž‹r_´ecÚfigu¿tiÚ
,

168 
ngx_h‰p_x¦t_fž‹r_š™
,

170 
ngx_h‰p_x¦t_fž‹r_ü—‹_maš_cÚf
,

171 
NULL
,

173 
NULL
,

174 
NULL
,

176 
ngx_h‰p_x¦t_fž‹r_ü—‹_cÚf
,

177 
ngx_h‰p_x¦t_fž‹r_m”ge_cÚf


181 
ngx_moduË_t
 
	gngx_h‰p_x¦t_fž‹r_moduË
 = {

182 
NGX_MODULE_V1
,

183 &
ngx_h‰p_x¦t_fž‹r_moduË_ùx
,

184 
ngx_h‰p_x¦t_fž‹r_commªds
,

185 
NGX_HTTP_MODULE
,

186 
NULL
,

187 
NULL
,

188 
NULL
,

189 
NULL
,

190 
NULL
,

191 
ngx_h‰p_x¦t_fž‹r_ex™
,

192 
ngx_h‰p_x¦t_fž‹r_ex™
,

193 
NGX_MODULE_V1_PADDING


197 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

198 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

201 
ngx_št_t


202 
	$ngx_h‰p_x¦t_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

204 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
;

205 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
cÚf
;

207 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

210 ià(
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_NOT_MODIFIED
) {

211  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

214 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

216 ià(
cÚf
->
sh“ts
.
ÃÉs
 == 0

217 || 
	`ngx_h‰p_‹¡_cÚ‹Á_ty³
(
r
, &
cÚf
->
ty³s
è=ð
NULL
)

219  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

222 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

224 ià(
ùx
) {

225  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

228 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_x¦t_fž‹r_ùx_t
));

229 ià(
ùx
 =ð
NULL
) {

230  
NGX_ERROR
;

233 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

235 
r
->
maš_fž‹r_Ãed_š_memÜy
 = 1;

237  
NGX_OK
;

238 
	}
}

241 
ngx_št_t


242 
	$ngx_h‰p_x¦t_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

244 
w–lFÜmed
;

245 
ngx_chaš_t
 *
þ
;

246 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
;

248 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

251 ià(
š
 =ð
NULL
) {

252  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

255 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

257 ià(
ùx
 =ð
NULL
 || ctx->
dÚe
) {

258  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, 
š
);

261 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

263 ià(
	`ngx_h‰p_x¦t_add_chunk
(
r
, 
ùx
, 
þ
->
buf
è!ð
NGX_OK
) {

265 ià(
ùx
->
ùxt
->
myDoc
) {

267 #ià(
NGX_HTTP_XSLT_REUSE_DTD
)

268 
ùx
->
ùxt
->
myDoc
->
extSub£t
 = 
NULL
;

270 
	`xmlF»eDoc
(
ùx
->
ùxt
->
myDoc
);

273 
	`xmlF»eP¬£rCtxt
(
ùx
->
ùxt
);

275  
	`ngx_h‰p_x¦t_£nd
(
r
, 
ùx
, 
NULL
);

278 ià(
þ
->
buf
->
Ï¡_buf
 || cl->buf->
Ï¡_š_chaš
) {

280 
ùx
->
doc
 = ctx->
ùxt
->
myDoc
;

282 #ià(
NGX_HTTP_XSLT_REUSE_DTD
)

283 
ùx
->
doc
->
extSub£t
 = 
NULL
;

286 
w–lFÜmed
 = 
ùx
->
ùxt
->wellFormed;

288 
	`xmlF»eP¬£rCtxt
(
ùx
->
ùxt
);

290 ià(
w–lFÜmed
) {

291  
	`ngx_h‰p_x¦t_£nd
(
r
, 
ùx
,

292 
	`ngx_h‰p_x¦t_­¶y_¡yËsh“t
(
r
, 
ùx
));

295 
	`xmlF»eDoc
(
ùx
->
doc
);

297 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

300  
	`ngx_h‰p_x¦t_£nd
(
r
, 
ùx
, 
NULL
);

304  
NGX_OK
;

305 
	}
}

308 
ngx_št_t


309 
	$ngx_h‰p_x¦t_£nd
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
,

310 
ngx_buf_t
 *
b
)

312 
ngx_št_t
 
rc
;

313 
ngx_chaš_t
 
out
;

314 
ngx_poÞ_þ—nup_t
 *
þn
;

315 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
cÚf
;

317 
ùx
->
dÚe
 = 1;

319 ià(
b
 =ð
NULL
) {

320  
	`ngx_h‰p_fž‹r_fš®ize_»que¡
(
r
, &
ngx_h‰p_x¦t_fž‹r_moduË
,

321 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

324 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
r
->
poÞ
, 0);

326 ià(
þn
 =ð
NULL
) {

327 
	`ngx_ä“
(
b
->
pos
);

328  
	`ngx_h‰p_fž‹r_fš®ize_»que¡
(
r
, &
ngx_h‰p_x¦t_fž‹r_moduË
,

329 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

332 ià(
r
 =ðr->
maš
) {

333 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
b
->
Ï¡
 - b->
pos
;

335 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
) {

336 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
->
hash
 = 0;

337 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 = 
NULL
;

340 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

342 ià(!
cÚf
->
Ï¡_modif›d
) {

343 
	`ngx_h‰p_þ—r_Ï¡_modif›d
(
r
);

344 
	`ngx_h‰p_þ—r_‘ag
(
r
);

347 
	`ngx_h‰p_w—k_‘ag
(
r
);

351 
rc
 = 
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

353 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

354 
	`ngx_ä“
(
b
->
pos
);

355  
rc
;

358 
þn
->
hªdËr
 = 
ngx_h‰p_x¦t_þ—nup
;

359 
þn
->
d©a
 = 
b
->
pos
;

361 
out
.
buf
 = 
b
;

362 
out
.
Ãxt
 = 
NULL
;

364  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
, &
out
);

365 
	}
}

368 
ngx_št_t


369 
	$ngx_h‰p_x¦t_add_chunk
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
,

370 
ngx_buf_t
 *
b
)

372 
”r
;

373 
xmlP¬£rCtxtPŒ
 
ùxt
;

375 ià(
ùx
->
ùxt
 =ð
NULL
) {

377 
ùxt
 = 
	`xmlC»©ePushP¬£rCtxt
(
NULL
, NULL, NULL, 0, NULL);

378 ià(
ùxt
 =ð
NULL
) {

379 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

381  
NGX_ERROR
;

383 
	`xmlCtxtU£O±iÚs
(
ùxt
, 
XML_PARSE_NOENT
|
XML_PARSE_DTDLOAD


384 |
XML_PARSE_NOWARNING
);

386 
ùxt
->
§x
->
ex‹º®Sub£t
 = 
ngx_h‰p_x¦t_§x_ex‹º®_sub£t
;

387 
ùxt
->
§x
->
£tDocum’tLoÿtÜ
 = 
NULL
;

388 
ùxt
->
§x
->
”rÜ
 = 
ngx_h‰p_x¦t_§x_”rÜ
;

389 
ùxt
->
§x
->
çlE¼Ü
 = 
ngx_h‰p_x¦t_§x_”rÜ
;

390 
ùxt
->
§x
->
_´iv©e
 = 
ùx
;

392 
ùx
->
ùxt
 = ctxt;

393 
ùx
->
»que¡
 = 
r
;

396 
”r
 = 
	`xmlP¬£Chunk
(
ùx
->
ùxt
, (*è
b
->
pos
, (è(b->
Ï¡
 - b->pos),

397 (
b
->
Ï¡_buf
è|| (b->
Ï¡_š_chaš
));

399 ià(
”r
 == 0) {

400 
b
->
pos
 = b->
Ï¡
;

401  
NGX_OK
;

404 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

405 "xmlP¬£Chunk(èçžed,ƒ¼Ü:%d", 
”r
);

407  
NGX_ERROR
;

408 
	}
}

412 
	$ngx_h‰p_x¦t_§x_ex‹º®_sub£t
(*
d©a
, cÚ¡ 
xmlCh¬
 *
Çme
,

413 cÚ¡ 
xmlCh¬
 *
ex‹º®Id
, cÚ¡ xmlCh¬ *
sy¡emId
)

415 
xmlP¬£rCtxtPŒ
 
ùxt
 = 
d©a
;

417 
xmlDocPŒ
 
doc
;

418 
xmlDtdPŒ
 
dtd
;

419 
ngx_h‰p_»que¡_t
 *
r
;

420 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
;

421 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
cÚf
;

423 
ùx
 = 
ùxt
->
§x
->
_´iv©e
;

424 
r
 = 
ùx
->
»que¡
;

426 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

428 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

430 
Çme
 ?‚am: (
xmlCh¬
 *) "",

431 
ex‹º®Id
 ?ƒx‹º®Id : (
xmlCh¬
 *) "",

432 
sy¡emId
 ? sy¡emId : (
xmlCh¬
 *) "");

434 
doc
 = 
ùxt
->
myDoc
;

436 #ià(
NGX_HTTP_XSLT_REUSE_DTD
)

438 
dtd
 = 
cÚf
->dtd;

442 
dtd
 = 
	`xmlCÝyDtd
(
cÚf
->dtd);

443 ià(
dtd
 =ð
NULL
) {

444 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

449 ià(
doc
->
chžd»n
 =ð
NULL
) {

450 
	`xmlAddChžd
((
xmlNodePŒ
è
doc
, (xmlNodePŒè
dtd
);

453 
	`xmlAddP»vSiblšg
(
doc
->
chžd»n
, (
xmlNodePŒ
è
dtd
);

458 
doc
->
extSub£t
 = 
dtd
;

459 
	}
}

462 
ngx_cdeþ


463 
	$ngx_h‰p_x¦t_§x_”rÜ
(*
d©a
, cÚ¡ *
msg
, ...)

465 
xmlP¬£rCtxtPŒ
 
ùxt
 = 
d©a
;

467 
size_t
 
n
;

468 
va_li¡
 
¬gs
;

469 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
;

470 
u_ch¬
 
buf
[
NGX_MAX_ERROR_STR
];

472 
ùx
 = 
ùxt
->
§x
->
_´iv©e
;

474 
buf
[0] = '\0';

476 
	`va_¡¬t
(
¬gs
, 
msg
);

477 
n
 = (
size_t
è
	`v¢´štf
((*è
buf
, 
NGX_MAX_ERROR_STR
, 
msg
, 
¬gs
);

478 
	`va_’d
(
¬gs
);

480 --
n
 && (
buf
[n] =ð
CR
 || buf[n] =ð
LF
)) { }

482 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
ùx
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

483 "libxml2ƒ¼Ü: \"%*s\"", 
n
 + 1, 
buf
);

484 
	}
}

487 
ngx_buf_t
 *

488 
	$ngx_h‰p_x¦t_­¶y_¡yËsh“t
(
ngx_h‰p_»que¡_t
 *
r
,

489 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
)

491 
Ën
, 
rc
, 
doc_ty³
;

492 
u_ch¬
 *
ty³
, *
’codšg
;

493 
ngx_buf_t
 *
b
;

494 
ngx_ušt_t
 
i
;

495 
xmlCh¬
 *
buf
;

496 
xmlDocPŒ
 
doc
, 
»s
;

497 
ngx_h‰p_x¦t_sh“t_t
 *
sh“t
;

498 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
cÚf
;

500 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

501 
sh“t
 = 
cÚf
->
sh“ts
.
–ts
;

502 
doc
 = 
ùx
->doc;

506 ià(
	`ngx_¬¿y_š™
(&
ùx
->
·¿ms
, 
r
->
poÞ
, 4 * 2 + 1, (*))

507 !ð
NGX_OK
)

509 
	`xmlF»eDoc
(
doc
);

510  
NULL
;

513 
i
 = 0; i < 
cÚf
->
sh“ts
.
ÃÉs
; i++) {

515 
ùx
->
ŒªsfÜm
 = 
	`x¦tNewT¿nsfÜmCÚ‹xt
(
sh“t
[
i
].
¡yËsh“t
, 
doc
);

516 ià(
ùx
->
ŒªsfÜm
 =ð
NULL
) {

517 
	`xmlF»eDoc
(
doc
);

518  
NULL
;

521 ià(
cÚf
->
·¿ms


522 && 
	`ngx_h‰p_x¦t_·¿ms
(
r
, 
ùx
, 
cÚf
->
·¿ms
, 0è!ð
NGX_OK
)

524 
	`x¦tF»eT¿nsfÜmCÚ‹xt
(
ùx
->
ŒªsfÜm
);

525 
	`xmlF»eDoc
(
doc
);

526  
NULL
;

529 ià(
	`ngx_h‰p_x¦t_·¿ms
(
r
, 
ùx
, &
sh“t
[
i
].
·¿ms
, 1è!ð
NGX_OK
) {

530 
	`x¦tF»eT¿nsfÜmCÚ‹xt
(
ùx
->
ŒªsfÜm
);

531 
	`xmlF»eDoc
(
doc
);

532  
NULL
;

535 
»s
 = 
	`x¦tAµlyStyËsh“tU£r
(
sh“t
[
i
].
¡yËsh“t
, 
doc
,

536 
ùx
->
·¿ms
.
–ts
, 
NULL
, NULL,

537 
ùx
->
ŒªsfÜm
);

539 
	`x¦tF»eT¿nsfÜmCÚ‹xt
(
ùx
->
ŒªsfÜm
);

540 
	`xmlF»eDoc
(
doc
);

542 ià(
»s
 =ð
NULL
) {

543 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

545  
NULL
;

548 
doc
 = 
»s
;

551 
ùx
->
·¿ms
.
ÃÉs
 = 0;

556 ià(
r
 =ðr->
maš
) {

557 
ty³
 = 
	`ngx_h‰p_x¦t_cÚ‹Á_ty³
(
sh“t
[
i
 - 1].
¡yËsh“t
);

560 
ty³
 = 
NULL
;

563 
’codšg
 = 
	`ngx_h‰p_x¦t_’codšg
(
sh“t
[
i
 - 1].
¡yËsh“t
);

564 
doc_ty³
 = 
doc
->
ty³
;

566 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

568 
doc_ty³
, 
ty³
 ?y³ : (
u_ch¬
 *) "(null)",

569 
’codšg
 ?ƒncodšg : (
u_ch¬
 *) "(null)");

571 
rc
 = 
	`x¦tSaveResuÉToSŒšg
(&
buf
, &
Ën
, 
doc
, 
sh“t
[
i
 - 1].
¡yËsh“t
);

573 
	`xmlF»eDoc
(
doc
);

575 ià(
rc
 != 0) {

576 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

578  
NULL
;

581 ià(
Ën
 == 0) {

582 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

584  
NULL
;

587 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

588 ià(
b
 =ð
NULL
) {

589 
	`ngx_ä“
(
buf
);

590  
NULL
;

593 
b
->
pos
 = 
buf
;

594 
b
->
Ï¡
 = 
buf
 + 
Ën
;

595 
b
->
memÜy
 = 1;

597 ià(
’codšg
) {

598 
r
->
h—d”s_out
.
ch¬£t
.
Ën
 = 
	`ngx_¡¾’
(
’codšg
);

599 
r
->
h—d”s_out
.
ch¬£t
.
d©a
 = 
’codšg
;

602 ià(
r
 !ðr->
maš
) {

603  
b
;

606 
b
->
Ï¡_buf
 = 1;

608 ià(
ty³
) {

609 
Ën
 = 
	`ngx_¡¾’
(
ty³
);

611 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = 
Ën
;

612 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 =†en;

613 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
 = 
ty³
;

615 } ià(
doc_ty³
 =ð
XML_HTML_DOCUMENT_NODE
) {

617 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = ("text/html") - 1;

618 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
cÚ‹Á_ty³
, "text/html");

621 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

623  
b
;

624 
	}
}

627 
ngx_št_t


628 
	$ngx_h‰p_x¦t_·¿ms
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_x¦t_fž‹r_ùx_t
 *
ùx
,

629 
ngx_¬¿y_t
 *
·¿ms
, 
ngx_ušt_t
 
fš®
)

631 
u_ch¬
 *
p
, *
Ï¡
, *
v®ue
, *
d¡
, *
¤c
, **
s
;

632 
size_t
 
Ën
;

633 
ngx_ušt_t
 
i
;

634 
ngx_¡r_t
 
¡ršg
;

635 
ngx_h‰p_x¦t_·¿m_t
 *
·¿m
;

637 
·¿m
 = 
·¿ms
->
–ts
;

639 
i
 = 0; i < 
·¿ms
->
ÃÉs
; i++) {

641 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
·¿m
[
i
].
v®ue
, &
¡ršg
è!ð
NGX_OK
) {

642  
NGX_ERROR
;

645 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

646 "x¦ˆfž‹¸·¿m: \"%s\"", 
¡ršg
.
d©a
);

648 ià(
·¿m
[
i
].
Çme
) {

650 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

651 "x¦ˆfž‹¸·¿m‚ame: \"%s\"", 
·¿m
[
i
].
Çme
);

653 ià(
·¿m
[
i
].
quÙe
) {

654 ià(
	`x¦tQuÙeOÃU£rP¬am
(
ùx
->
ŒªsfÜm
, 
·¿m
[
i
].
Çme
,

655 
¡ršg
.
d©a
)

658 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

660 
·¿m
[
i
].
Çme
, 
¡ršg
.
d©a
);

661  
NGX_ERROR
;

667 
s
 = 
	`ngx_¬¿y_push
(&
ùx
->
·¿ms
);

668 ià(
s
 =ð
NULL
) {

669  
NGX_ERROR
;

672 *
s
 = 
·¿m
[
i
].
Çme
;

674 
s
 = 
	`ngx_¬¿y_push
(&
ùx
->
·¿ms
);

675 ià(
s
 =ð
NULL
) {

676  
NGX_ERROR
;

679 *
s
 = 
¡ršg
.
d©a
;

689 
p
 = 
¡ršg
.
d©a
;

690 
Ï¡
 = 
¡ršg
.
d©a
 + sŒšg.
Ën
;

692 
p
 && *p) {

694 
v®ue
 = 
p
;

695 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(p, '=');

696 ià(
p
 =ð
NULL
) {

697 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

698 "šv®id†ibx¦ˆ·¿m‘” \"%s\"", 
v®ue
);

699  
NGX_ERROR
;

701 *
p
++ = '\0';

703 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

704 "x¦ˆfž‹¸·¿m‚ame: \"%s\"", 
v®ue
);

706 
s
 = 
	`ngx_¬¿y_push
(&
ùx
->
·¿ms
);

707 ià(
s
 =ð
NULL
) {

708  
NGX_ERROR
;

711 *
s
 = 
v®ue
;

713 
v®ue
 = 
p
;

714 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(p, ':');

716 ià(
p
) {

717 
Ën
 = 
p
 - 
v®ue
;

718 *
p
++ = '\0';

721 
Ën
 = 
Ï¡
 - 
v®ue
;

724 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

725 "x¦ˆfž‹¸·¿m v®ue: \"%s\"", 
v®ue
);

727 
d¡
 = 
v®ue
;

728 
¤c
 = 
v®ue
;

730 
	`ngx_uÃsÿ³_uri
(&
d¡
, &
¤c
, 
Ën
, 0);

732 *
d¡
 = '\0';

734 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

735 "x¦ˆfž‹¸·¿m uÃsÿ³d: \"%s\"", 
v®ue
);

737 
s
 = 
	`ngx_¬¿y_push
(&
ùx
->
·¿ms
);

738 ià(
s
 =ð
NULL
) {

739  
NGX_ERROR
;

742 *
s
 = 
v®ue
;

746 ià(
fš®
) {

747 
s
 = 
	`ngx_¬¿y_push
(&
ùx
->
·¿ms
);

748 ià(
s
 =ð
NULL
) {

749  
NGX_ERROR
;

752 *
s
 = 
NULL
;

755  
NGX_OK
;

756 
	}
}

759 
u_ch¬
 *

760 
	$ngx_h‰p_x¦t_cÚ‹Á_ty³
(
x¦tStyËsh“tPŒ
 
s
)

762 
u_ch¬
 *
ty³
;

764 ià(
s
->
medŸTy³
) {

765  
s
->
medŸTy³
;

768 
s
 = s->
impÜts
; s; s = s->
Ãxt
) {

770 
ty³
 = 
	`ngx_h‰p_x¦t_cÚ‹Á_ty³
(
s
);

772 ià(
ty³
) {

773  
ty³
;

777  
NULL
;

778 
	}
}

781 
u_ch¬
 *

782 
	$ngx_h‰p_x¦t_’codšg
(
x¦tStyËsh“tPŒ
 
s
)

784 
u_ch¬
 *
’codšg
;

786 ià(
s
->
’codšg
) {

787  
s
->
’codšg
;

790 
s
 = s->
impÜts
; s; s = s->
Ãxt
) {

792 
’codšg
 = 
	`ngx_h‰p_x¦t_’codšg
(
s
);

794 ià(
’codšg
) {

795  
’codšg
;

799  
NULL
;

800 
	}
}

804 
	$ngx_h‰p_x¦t_þ—nup
(*
d©a
)

806 
	`ngx_ä“
(
d©a
);

807 
	}
}

811 
	$ngx_h‰p_x¦t_’t™›s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

813 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
xlcf
 = 
cÚf
;

815 
ngx_¡r_t
 *
v®ue
;

816 
ngx_ušt_t
 
i
;

817 
ngx_poÞ_þ—nup_t
 *
þn
;

818 
ngx_h‰p_x¦t_fže_t
 *
fže
;

819 
ngx_h‰p_x¦t_fž‹r_maš_cÚf_t
 *
xmcf
;

821 ià(
xlcf
->
dtd
) {

825 
v®ue
 = 
cf
->
¬gs
->
–ts
;

827 
xmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

829 
fže
 = 
xmcf
->
dtd_fžes
.
–ts
;

830 
i
 = 0; i < 
xmcf
->
dtd_fžes
.
ÃÉs
; i++) {

831 ià(
	`ngx_¡rcmp
(
fže
[
i
].
Çme
, 
v®ue
[1].
d©a
) == 0) {

832 
xlcf
->
dtd
 = 
fže
[
i
].
d©a
;

833  
NGX_CONF_OK
;

837 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

838 ià(
þn
 =ð
NULL
) {

839  
NGX_CONF_ERROR
;

842 
xlcf
->
dtd
 = 
	`xmlP¬£DTD
(
NULL
, (
xmlCh¬
 *è
v®ue
[1].
d©a
);

844 ià(
xlcf
->
dtd
 =ð
NULL
) {

845 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_ERR
, 
cf
, 0, "xmlParseDTD() failed");

846  
NGX_CONF_ERROR
;

849 
þn
->
hªdËr
 = 
ngx_h‰p_x¦t_þ—nup_dtd
;

850 
þn
->
d©a
 = 
xlcf
->
dtd
;

852 
fže
 = 
	`ngx_¬¿y_push
(&
xmcf
->
dtd_fžes
);

853 ià(
fže
 =ð
NULL
) {

854  
NGX_CONF_ERROR
;

857 
fže
->
Çme
 = 
v®ue
[1].
d©a
;

858 
fže
->
d©a
 = 
xlcf
->
dtd
;

860  
NGX_CONF_OK
;

861 
	}
}

866 
	$ngx_h‰p_x¦t_¡yËsh“t
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

868 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
xlcf
 = 
cÚf
;

870 
ngx_¡r_t
 *
v®ue
;

871 
ngx_ušt_t
 
i
, 
n
;

872 
ngx_poÞ_þ—nup_t
 *
þn
;

873 
ngx_h‰p_x¦t_fže_t
 *
fže
;

874 
ngx_h‰p_x¦t_sh“t_t
 *
sh“t
;

875 
ngx_h‰p_x¦t_·¿m_t
 *
·¿m
;

876 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

877 
ngx_h‰p_x¦t_fž‹r_maš_cÚf_t
 *
xmcf
;

879 
v®ue
 = 
cf
->
¬gs
->
–ts
;

881 ià(
xlcf
->
sh“ts
.
–ts
 =ð
NULL
) {

882 ià(
	`ngx_¬¿y_š™
(&
xlcf
->
sh“ts
, 
cf
->
poÞ
, 1,

883 (
ngx_h‰p_x¦t_sh“t_t
))

884 !ð
NGX_OK
)

886  
NGX_CONF_ERROR
;

890 
sh“t
 = 
	`ngx_¬¿y_push
(&
xlcf
->
sh“ts
);

891 ià(
sh“t
 =ð
NULL
) {

892  
NGX_CONF_ERROR
;

895 
	`ngx_memz”o
(
sh“t
, (
ngx_h‰p_x¦t_sh“t_t
));

897 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
v®ue
[1], 0è!ð
NGX_OK
) {

898  
NGX_CONF_ERROR
;

901 
xmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_x¦t_fž‹r_moduË
);

903 
fže
 = 
xmcf
->
sh“t_fžes
.
–ts
;

904 
i
 = 0; i < 
xmcf
->
sh“t_fžes
.
ÃÉs
; i++) {

905 ià(
	`ngx_¡rcmp
(
fže
[
i
].
Çme
, 
v®ue
[1].
d©a
) == 0) {

906 
sh“t
->
¡yËsh“t
 = 
fže
[
i
].
d©a
;

907 
found
;

911 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

912 ià(
þn
 =ð
NULL
) {

913  
NGX_CONF_ERROR
;

916 
sh“t
->
¡yËsh“t
 = 
	`x¦tP¬£StyËsh“tFže
(
v®ue
[1].
d©a
);

917 ià(
sh“t
->
¡yËsh“t
 =ð
NULL
) {

918 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_ERR
, 
cf
, 0,

920 
v®ue
[1].
d©a
);

921  
NGX_CONF_ERROR
;

924 
þn
->
hªdËr
 = 
ngx_h‰p_x¦t_þ—nup_¡yËsh“t
;

925 
þn
->
d©a
 = 
sh“t
->
¡yËsh“t
;

927 
fže
 = 
	`ngx_¬¿y_push
(&
xmcf
->
sh“t_fžes
);

928 ià(
fže
 =ð
NULL
) {

929  
NGX_CONF_ERROR
;

932 
fže
->
Çme
 = 
v®ue
[1].
d©a
;

933 
fže
->
d©a
 = 
sh“t
->
¡yËsh“t
;

935 
found
:

937 
n
 = 
cf
->
¬gs
->
ÃÉs
;

939 ià(
n
 == 2) {

940  
NGX_CONF_OK
;

943 ià(
	`ngx_¬¿y_š™
(&
sh“t
->
·¿ms
, 
cf
->
poÞ
, 
n
 - 2,

944 (
ngx_h‰p_x¦t_·¿m_t
))

945 !ð
NGX_OK
)

947  
NGX_CONF_ERROR
;

950 
i
 = 2; i < 
n
; i++) {

952 
·¿m
 = 
	`ngx_¬¿y_push
(&
sh“t
->
·¿ms
);

953 ià(
·¿m
 =ð
NULL
) {

954  
NGX_CONF_ERROR
;

957 
	`ngx_memz”o
(
·¿m
, (
ngx_h‰p_x¦t_·¿m_t
));

958 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

960 
ccv
.
cf
 = cf;

961 
ccv
.
v®ue
 = &v®ue[
i
];

962 
ccv
.
com¶ex_v®ue
 = &
·¿m
->
v®ue
;

963 
ccv
.
z”o
 = 1;

965 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

966  
NGX_CONF_ERROR
;

970  
NGX_CONF_OK
;

971 
	}
}

975 
	$ngx_h‰p_x¦t_·¿m
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

977 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
xlcf
 = 
cÚf
;

979 
ngx_h‰p_x¦t_·¿m_t
 *
·¿m
;

980 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

981 
ngx_¡r_t
 *
v®ue
;

983 
v®ue
 = 
cf
->
¬gs
->
–ts
;

985 ià(
xlcf
->
·¿ms
 =ð
NULL
) {

986 
xlcf
->
·¿ms
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 2,

987 (
ngx_h‰p_x¦t_·¿m_t
));

988 ià(
xlcf
->
·¿ms
 =ð
NULL
) {

989  
NGX_CONF_ERROR
;

993 
·¿m
 = 
	`ngx_¬¿y_push
(
xlcf
->
·¿ms
);

994 ià(
·¿m
 =ð
NULL
) {

995  
NGX_CONF_ERROR
;

998 
·¿m
->
Çme
 = 
v®ue
[1].
d©a
;

999 
·¿m
->
quÙe
 = (
cmd
->
po¡
 =ð
NULL
) ? 0 : 1;

1001 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

1003 
ccv
.
cf
 = cf;

1004 
ccv
.
v®ue
 = &value[2];

1005 
ccv
.
com¶ex_v®ue
 = &
·¿m
->
v®ue
;

1006 
ccv
.
z”o
 = 1;

1008 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

1009  
NGX_CONF_ERROR
;

1012  
NGX_CONF_OK
;

1013 
	}
}

1017 
	$ngx_h‰p_x¦t_þ—nup_dtd
(*
d©a
)

1019 
	`xmlF»eDtd
(
d©a
);

1020 
	}
}

1024 
	$ngx_h‰p_x¦t_þ—nup_¡yËsh“t
(*
d©a
)

1026 
	`x¦tF»eStyËsh“t
(
d©a
);

1027 
	}
}

1031 
	$ngx_h‰p_x¦t_fž‹r_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

1033 
ngx_h‰p_x¦t_fž‹r_maš_cÚf_t
 *
cÚf
;

1035 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_x¦t_fž‹r_maš_cÚf_t
));

1036 ià(
cÚf
 =ð
NULL
) {

1037  
NULL
;

1040 ià(
	`ngx_¬¿y_š™
(&
cÚf
->
dtd_fžes
, 
cf
->
poÞ
, 1,

1041 (
ngx_h‰p_x¦t_fže_t
))

1042 !ð
NGX_OK
)

1044  
NULL
;

1047 ià(
	`ngx_¬¿y_š™
(&
cÚf
->
sh“t_fžes
, 
cf
->
poÞ
, 1,

1048 (
ngx_h‰p_x¦t_fže_t
))

1049 !ð
NGX_OK
)

1051  
NULL
;

1054  
cÚf
;

1055 
	}
}

1059 
	$ngx_h‰p_x¦t_fž‹r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

1061 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
cÚf
;

1063 
cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
));

1064 ià(
cÚf
 =ð
NULL
) {

1065  
NULL
;

1078 
cÚf
->
Ï¡_modif›d
 = 
NGX_CONF_UNSET
;

1080  
cÚf
;

1081 
	}
}

1085 
	$ngx_h‰p_x¦t_fž‹r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1087 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
´ev
 = 
·»Á
;

1088 
ngx_h‰p_x¦t_fž‹r_loc_cÚf_t
 *
cÚf
 = 
chžd
;

1090 ià(
cÚf
->
dtd
 =ð
NULL
) {

1091 
cÚf
->
dtd
 = 
´ev
->dtd;

1094 ià(
cÚf
->
sh“ts
.
ÃÉs
 == 0) {

1095 
cÚf
->
sh“ts
 = 
´ev
->sheets;

1098 ià(
cÚf
->
·¿ms
 =ð
NULL
) {

1099 
cÚf
->
·¿ms
 = 
´ev
->params;

1102 ià(
	`ngx_h‰p_m”ge_ty³s
(
cf
, &
cÚf
->
ty³s_keys
, &cÚf->
ty³s
,

1103 &
´ev
->
ty³s_keys
, &´ev->
ty³s
,

1104 
ngx_h‰p_x¦t_deçuÉ_ty³s
)

1105 !ð
NGX_OK
)

1107  
NGX_CONF_ERROR
;

1110 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
Ï¡_modif›d
, 
´ev
->last_modified, 0);

1112  
NGX_CONF_OK
;

1113 
	}
}

1116 
ngx_št_t


1117 
	$ngx_h‰p_x¦t_fž‹r_´ecÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
)

1119 
	`xmlIn™P¬£r
();

1121 #ià(
NGX_HAVE_EXSLT
)

1122 
	`ex¦tRegi¡”AÎ
();

1125  
NGX_OK
;

1126 
	}
}

1129 
ngx_št_t


1130 
	$ngx_h‰p_x¦t_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

1132 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

1133 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_x¦t_h—d”_fž‹r
;

1135 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

1136 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_x¦t_body_fž‹r
;

1138  
NGX_OK
;

1139 
	}
}

1143 
	$ngx_h‰p_x¦t_fž‹r_ex™
(
ngx_cyþe_t
 *
cyþe
)

1145 
	`x¦tCËªupGlob®s
();

1146 
	`xmlCËªupP¬£r
();

1147 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/modules/perl/ngx_http_perl_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngx_h‰p_³¾_moduË.h
>

15 
P”lIÁ”´‘”
 *
	m³¾
;

16 
HV
 *
	mngšx
;

17 
ngx_¬¿y_t
 *
	mmoduËs
;

18 
ngx_¬¿y_t
 *
	m»quœes
;

19 } 
	tngx_h‰p_³¾_maš_cÚf_t
;

23 
SV
 *
	msub
;

24 
ngx_¡r_t
 
	mhªdËr
;

25 } 
	tngx_h‰p_³¾_loc_cÚf_t
;

29 
SV
 *
	msub
;

30 
ngx_¡r_t
 
	mhªdËr
;

31 } 
	tngx_h‰p_³¾_v¬ŸbË_t
;

34 #ià(
NGX_HTTP_SSI
)

35 
ngx_št_t
 
ngx_h‰p_³¾_ssi
(
ngx_h‰p_»que¡_t
 *
r
,

36 
ngx_h‰p_ssi_ùx_t
 *
ssi_ùx
, 
ngx_¡r_t
 **
·¿ms
);

39 *
ngx_h‰p_³¾_š™_š‹½»‹r
(
ngx_cÚf_t
 *
cf
,

40 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
);

41 
P”lIÁ”´‘”
 *
ngx_h‰p_³¾_ü—‹_š‹½»‹r
(
ngx_cÚf_t
 *
cf
,

42 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
);

43 
ngx_št_t
 
ngx_h‰p_³¾_run_»quœes
(
pTHX_
 
ngx_¬¿y_t
 *
»quœes
,

44 
ngx_log_t
 *
log
);

45 
ngx_št_t
 
ngx_h‰p_³¾_ÿÎ_hªdËr
(
pTHX_
 
ngx_h‰p_»que¡_t
 *
r
,

46 
HV
 *
ngšx
, 
SV
 *
sub
, SV **
¬gs
, 
ngx_¡r_t
 *
hªdËr
,‚gx_¡r_ˆ*
rv
);

47 
ngx_h‰p_³¾_ev®_ªÚ_sub
(
pTHX_
 
ngx_¡r_t
 *
hªdËr
, 
SV
 **
sv
);

49 
ngx_št_t
 
ngx_h‰p_³¾_´ecÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
);

50 *
ngx_h‰p_³¾_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

51 *
ngx_h‰p_³¾_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
);

52 *
ngx_h‰p_³¾_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

53 *
ngx_h‰p_³¾_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

54 *
chžd
);

55 *
ngx_h‰p_³¾
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

56 *
ngx_h‰p_³¾_£t
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

58 #ià(
NGX_HAVE_PERL_MULTIPLICITY
)

59 
ngx_h‰p_³¾_þ—nup_³¾
(*
d©a
);

62 
ngx_št_t
 
ngx_h‰p_³¾_š™_wÜk”
(
ngx_cyþe_t
 *
cyþe
);

63 
ngx_h‰p_³¾_ex™
(
ngx_cyþe_t
 *
cyþe
);

66 
ngx_commªd_t
 
	gngx_h‰p_³¾_commªds
[] = {

68 { 
ngx_¡ršg
("perl_modules"),

69 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

70 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

71 
NGX_HTTP_MAIN_CONF_OFFSET
,

72 
off£tof
(
ngx_h‰p_³¾_maš_cÚf_t
, 
moduËs
),

73 
NULL
 },

75 { 
ngx_¡ršg
("perl_require"),

76 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

77 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

78 
NGX_HTTP_MAIN_CONF_OFFSET
,

79 
off£tof
(
ngx_h‰p_³¾_maš_cÚf_t
, 
»quœes
),

80 
NULL
 },

82 { 
ngx_¡ršg
("perl"),

83 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LMT_CONF
|
NGX_CONF_TAKE1
,

84 
ngx_h‰p_³¾
,

85 
NGX_HTTP_LOC_CONF_OFFSET
,

87 
NULL
 },

89 { 
ngx_¡ršg
("perl_set"),

90 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE2
,

91 
ngx_h‰p_³¾_£t
,

92 
NGX_HTTP_LOC_CONF_OFFSET
,

94 
NULL
 },

96 
ngx_nuÎ_commªd


100 
ngx_h‰p_moduË_t
 
	gngx_h‰p_³¾_moduË_ùx
 = {

101 
ngx_h‰p_³¾_´ecÚfigu¿tiÚ
,

102 
NULL
,

104 
ngx_h‰p_³¾_ü—‹_maš_cÚf
,

105 
ngx_h‰p_³¾_š™_maš_cÚf
,

107 
NULL
,

108 
NULL
,

110 
ngx_h‰p_³¾_ü—‹_loc_cÚf
,

111 
ngx_h‰p_³¾_m”ge_loc_cÚf


115 
ngx_moduË_t
 
	gngx_h‰p_³¾_moduË
 = {

116 
NGX_MODULE_V1
,

117 &
ngx_h‰p_³¾_moduË_ùx
,

118 
ngx_h‰p_³¾_commªds
,

119 
NGX_HTTP_MODULE
,

120 
NULL
,

121 
NULL
,

122 
ngx_h‰p_³¾_š™_wÜk”
,

123 
NULL
,

124 
NULL
,

125 
NULL
,

126 
ngx_h‰p_³¾_ex™
,

127 
NGX_MODULE_V1_PADDING


131 #ià(
NGX_HTTP_SSI
)

133 
	#NGX_HTTP_PERL_SSI_SUB
 0

	)

134 
	#NGX_HTTP_PERL_SSI_ARG
 1

	)

137 
ngx_h‰p_ssi_·¿m_t
 
	gngx_h‰p_³¾_ssi_·¿ms
[] = {

138 { 
ngx_¡ršg
("sub"), 
NGX_HTTP_PERL_SSI_SUB
, 1, 0 },

139 { 
ngx_¡ršg
("¬g"), 
NGX_HTTP_PERL_SSI_ARG
, 0, 1 },

140 { 
ngx_nuÎ_¡ršg
, 0, 0, 0 }

143 
ngx_h‰p_ssi_commªd_t
 
	gngx_h‰p_³¾_ssi_commªd
 = {

144 
ngx_¡ršg
("³¾"), 
ngx_h‰p_³¾_ssi
, 
ngx_h‰p_³¾_ssi_·¿ms
, 0, 0, 1

150 
ngx_¡r_t
 
	gngx_nuÎ_Çme
 = 
ngx_nuÎ_¡ršg
;

151 
HV
 *
	gngšx_¡ash
;

153 #ià(
NGX_HAVE_PERL_MULTIPLICITY
)

154 
ngx_ušt_t
 
	gngx_³¾_‹rm
;

156 
P”lIÁ”´‘”
 *
	g³¾
;

161 
	$ngx_h‰p_³¾_xs_š™
(
pTHX
)

163 
	`ÃwXS
("DyÇLßd”::boÙ_DyÇLßd”", 
boÙ_DyÇLßd”
, 
__FILE__
);

165 
ngšx_¡ash
 = 
	`gv_¡ashpv
("ngšx", 
TRUE
);

166 
	}
}

169 
ngx_št_t


170 
	$ngx_h‰p_³¾_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

172 
r
->
maš
->
couÁ
++;

174 
	`ngx_h‰p_³¾_hªdË_»que¡
(
r
);

176  
NGX_DONE
;

177 
	}
}

181 
	$ngx_h‰p_³¾_hªdË_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

183 
SV
 *
sub
;

184 
ngx_št_t
 
rc
;

185 
ngx_¡r_t
 
uri
, 
¬gs
, *
hªdËr
;

186 
ngx_h‰p_³¾_ùx_t
 *
ùx
;

187 
ngx_h‰p_³¾_loc_cÚf_t
 *
¶cf
;

188 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
;

190 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0, "perl handler");

192 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_³¾_moduË
);

194 ià(
ùx
 =ð
NULL
) {

195 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_³¾_ùx_t
));

196 ià(
ùx
 =ð
NULL
) {

197 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_ERROR
);

201 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_³¾_moduË
);

204 
pmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_³¾_moduË
);

208 
	`dTHXa
(
pmcf
->
³¾
);

209 
	`PERL_SET_CONTEXT
(
pmcf
->
³¾
);

211 ià(
ùx
->
Ãxt
 =ð
NULL
) {

212 
¶cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_³¾_moduË
);

213 
sub
 = 
¶cf
->sub;

214 
hªdËr
 = &
¶cf
->handler;

217 
sub
 = 
ùx
->
Ãxt
;

218 
hªdËr
 = &
ngx_nuÎ_Çme
;

219 
ùx
->
Ãxt
 = 
NULL
;

222 
rc
 = 
	`ngx_h‰p_³¾_ÿÎ_hªdËr
(
aTHX_
 
r
, 
pmcf
->
ngšx
, 
sub
, 
NULL
, 
hªdËr
,

223 
NULL
);

227 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

228 "³¾ hªdË¸dÚe: %i", 
rc
);

230 ià(
rc
 =ð
NGX_DONE
) {

231 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

235 ià(
rc
 > 600) {

236 
rc
 = 
NGX_OK
;

239 ià(
ùx
->
»dœeù_uri
.
Ën
) {

240 
uri
 = 
ùx
->
»dœeù_uri
;

241 
¬gs
 = 
ùx
->
»dœeù_¬gs
;

244 
uri
.
Ën
 = 0;

247 
ùx
->
fž’ame
.
d©a
 = 
NULL
;

248 
ùx
->
»dœeù_uri
.
Ën
 = 0;

250 ià(
ùx
->
dÚe
 || ctx->
Ãxt
) {

251 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_DONE
);

255 ià(
uri
.
Ën
) {

256 
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
uri
, &
¬gs
);

257 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_DONE
);

261 ià(
rc
 =ð
NGX_OK
 ||„ø=ð
NGX_HTTP_OK
) {

262 
	`ngx_h‰p_£nd_¥ecŸl
(
r
, 
NGX_HTTP_LAST
);

263 
ùx
->
dÚe
 = 1;

266 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

267 
	}
}

271 
	$ngx_h‰p_³¾_¦“p_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

273 
ngx_ev’t_t
 *
wev
;

275 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

278 
wev
 = 
r
->
cÚÃùiÚ
->
wr™e
;

280 ià(
wev
->
timedout
) {

281 
wev
->
timedout
 = 0;

282 
	`ngx_h‰p_³¾_hªdË_»que¡
(
r
);

286 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 0è!ð
NGX_OK
) {

287 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

289 
	}
}

292 
ngx_št_t


293 
	$ngx_h‰p_³¾_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

294 
ušŒ_t
 
d©a
)

296 
ngx_h‰p_³¾_v¬ŸbË_t
 *
pv
 = (ngx_h‰p_³¾_v¬ŸbË_ˆ*è
d©a
;

298 
ngx_št_t
 
rc
;

299 
ngx_¡r_t
 
v®ue
;

300 
ngx_h‰p_³¾_ùx_t
 *
ùx
;

301 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
;

303 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

306 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_³¾_moduË
);

308 ià(
ùx
 =ð
NULL
) {

309 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_³¾_ùx_t
));

310 ià(
ùx
 =ð
NULL
) {

311  
NGX_ERROR
;

314 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_³¾_moduË
);

317 
pmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_³¾_moduË
);

319 
v®ue
.
d©a
 = 
NULL
;

323 
	`dTHXa
(
pmcf
->
³¾
);

324 
	`PERL_SET_CONTEXT
(
pmcf
->
³¾
);

326 
rc
 = 
	`ngx_h‰p_³¾_ÿÎ_hªdËr
(
aTHX_
 
r
, 
pmcf
->
ngšx
, 
pv
->
sub
, 
NULL
,

327 &
pv
->
hªdËr
, &
v®ue
);

331 ià(
v®ue
.
d©a
) {

332 
v
->
Ën
 = 
v®ue
.len;

333 
v
->
v®id
 = 1;

334 
v
->
no_ÿch—bË
 = 0;

335 
v
->
nÙ_found
 = 0;

336 
v
->
d©a
 = 
v®ue
.data;

339 
v
->
nÙ_found
 = 1;

342 
ùx
->
fž’ame
.
d©a
 = 
NULL
;

343 
ùx
->
»dœeù_uri
.
Ën
 = 0;

345 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

348  
rc
;

349 
	}
}

352 #ià(
NGX_HTTP_SSI
)

354 
ngx_št_t


355 
	$ngx_h‰p_³¾_ssi
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ssi_ùx_t
 *
ssi_ùx
,

356 
ngx_¡r_t
 **
·¿ms
)

358 
SV
 *
sv
, **
asv
;

359 
ngx_št_t
 
rc
;

360 
ngx_¡r_t
 *
hªdËr
, **
¬gs
;

361 
ngx_ušt_t
 
i
;

362 
ngx_h‰p_³¾_ùx_t
 *
ùx
;

363 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
;

365 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

368 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_³¾_moduË
);

370 ià(
ùx
 =ð
NULL
) {

371 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_³¾_ùx_t
));

372 ià(
ùx
 =ð
NULL
) {

373  
NGX_ERROR
;

376 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_³¾_moduË
);

379 
pmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_³¾_moduË
);

381 
ùx
->
ssi
 = 
ssi_ùx
;

383 
hªdËr
 = 
·¿ms
[
NGX_HTTP_PERL_SSI_SUB
];

384 
hªdËr
->
d©a
[hªdËr->
Ën
] = '\0';

388 
	`dTHXa
(
pmcf
->
³¾
);

389 
	`PERL_SET_CONTEXT
(
pmcf
->
³¾
);

395 
	`ngx_h‰p_³¾_ev®_ªÚ_sub
(
aTHX_
 
hªdËr
, &
sv
);

397 ià(
sv
 =ð&
PL_sv_undef
) {

398 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

399 "ev®_pv(\"%V\"èçžed", 
hªdËr
);

400  
NGX_ERROR
;

403 ià(
sv
 =ð
NULL
) {

404 
sv
 = 
	`ÃwSVpvn
((*è
hªdËr
->
d©a
, hªdËr->
Ën
);

409 
sv
 = 
	`ÃwSVpvn
((*è
hªdËr
->
d©a
, hªdËr->
Ën
);

411 
¬gs
 = &
·¿ms
[
NGX_HTTP_PERL_SSI_ARG
];

413 ià(
¬gs
) {

415 
i
 = 0; 
¬gs
[i]; i++) { }

417 
asv
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
i
 + 1è* (
SV
 *));

419 ià(
asv
 =ð
NULL
) {

420 
	`SvREFCNT_dec
(
sv
);

421  
NGX_ERROR
;

424 
asv
[0] = (
SV
 *è(
ušŒ_t
è
i
;

426 
i
 = 0; 
¬gs
[i]; i++) {

427 
asv
[
i
 + 1] = 
	`ÃwSVpvn
((*è
¬gs
[i]->
d©a
,‡rgs[i]->
Ën
);

431 
asv
 = 
NULL
;

434 
rc
 = 
	`ngx_h‰p_³¾_ÿÎ_hªdËr
(
aTHX_
 
r
, 
pmcf
->
ngšx
, 
sv
, 
asv
, 
hªdËr
,

435 
NULL
);

437 
	`SvREFCNT_dec
(
sv
);

441 
ùx
->
fž’ame
.
d©a
 = 
NULL
;

442 
ùx
->
»dœeù_uri
.
Ën
 = 0;

443 
ùx
->
ssi
 = 
NULL
;

445 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0, "perl ssi done");

447  
rc
;

448 
	}
}

454 
	$ngx_h‰p_³¾_š™_š‹½»‹r
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
)

456 
ngx_¡r_t
 *
m
;

457 
ngx_ušt_t
 
i
;

458 #ià(
NGX_HAVE_PERL_MULTIPLICITY
)

459 
ngx_poÞ_þ—nup_t
 *
þn
;

461 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

462 ià(
þn
 =ð
NULL
) {

463  
NGX_CONF_ERROR
;

468 #ifdeà
NGX_PERL_MODULES


469 ià(
pmcf
->
moduËs
 =ð
NGX_CONF_UNSET_PTR
) {

471 
pmcf
->
moduËs
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1, (
ngx_¡r_t
));

472 ià(
pmcf
->
moduËs
 =ð
NULL
) {

473  
NGX_CONF_ERROR
;

476 
m
 = 
	`ngx_¬¿y_push
(
pmcf
->
moduËs
);

477 ià(
m
 =ð
NULL
) {

478  
NGX_CONF_ERROR
;

481 
	`ngx_¡r_£t
(
m
, 
NGX_PERL_MODULES
);

485 ià(
pmcf
->
moduËs
 !ð
NGX_CONF_UNSET_PTR
) {

486 
m
 = 
pmcf
->
moduËs
->
–ts
;

487 
i
 = 0; i < 
pmcf
->
moduËs
->
ÃÉs
; i++) {

488 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
m
[
i
], 0è!ð
NGX_OK
) {

489  
NGX_CONF_ERROR
;

494 #ià!(
NGX_HAVE_PERL_MULTIPLICITY
)

496 ià(
³¾
) {

498 ià(
	`ngx_£t_’vœÚm’t
(
cf
->
cyþe
, 
NULL
) == NULL) {

499  
NGX_CONF_ERROR
;

502 ià(
	`ngx_h‰p_³¾_run_»quœes
(
aTHX_
 
pmcf
->
»quœes
, 
cf
->
log
)

503 !ð
NGX_OK
)

505  
NGX_CONF_ERROR
;

508 
pmcf
->
³¾
 =…erl;

509 
pmcf
->
ngšx
 = 
ngšx_¡ash
;

511  
NGX_CONF_OK
;

516 ià(
ngšx_¡ash
 =ð
NULL
) {

517 
	`PERL_SYS_INIT
(&
ngx_¬gc
, &
ngx_¬gv
);

520 
pmcf
->
³¾
 = 
	`ngx_h‰p_³¾_ü—‹_š‹½»‹r
(
cf
,…mcf);

522 ià(
pmcf
->
³¾
 =ð
NULL
) {

523  
NGX_CONF_ERROR
;

526 
pmcf
->
ngšx
 = 
ngšx_¡ash
;

528 #ià(
NGX_HAVE_PERL_MULTIPLICITY
)

530 
þn
->
hªdËr
 = 
ngx_h‰p_³¾_þ—nup_³¾
;

531 
þn
->
d©a
 = 
pmcf
->
³¾
;

535 
³¾
 = 
pmcf
->perl;

539  
NGX_CONF_OK
;

540 
	}
}

543 
P”lIÁ”´‘”
 *

544 
	$ngx_h‰p_³¾_ü—‹_š‹½»‹r
(
ngx_cÚf_t
 *
cf
,

545 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
)

547 
n
;

548 
STRLEN
 
Ën
;

549 
SV
 *
sv
;

550 *
v”
, **
embeddšg
;

551 
ngx_¡r_t
 *
m
;

552 
ngx_ušt_t
 
i
;

553 
P”lIÁ”´‘”
 *
³¾
;

555 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
cf
->
log
, 0, "create…erl interpreter");

557 ià(
	`ngx_£t_’vœÚm’t
(
cf
->
cyþe
, 
NULL
) == NULL) {

558  
NULL
;

561 
³¾
 = 
	`³¾_®loc
();

562 ià(
³¾
 =ð
NULL
) {

563 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 0, "perl_alloc() failed");

564  
NULL
;

569 
	`dTHXa
(
³¾
);

570 
	`PERL_SET_CONTEXT
(
³¾
);

572 
	`³¾_cÚ¡ruù
(
³¾
);

574 #ifdeà
PERL_EXIT_DESTRUCT_END


575 
PL_ex™_æags
 |ð
PERL_EXIT_DESTRUCT_END
;

578 
n
 = (
pmcf
->
moduËs
 !ð
NGX_CONF_UNSET_PTR
è?…mcf->moduËs->
ÃÉs
 * 2 : 0;

580 
embeddšg
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (5 + 
n
) * (*));

581 ià(
embeddšg
 =ð
NULL
) {

582 
çž
;

585 
embeddšg
[0] = "";

587 ià(
n
++) {

588 
m
 = 
pmcf
->
moduËs
->
–ts
;

589 
i
 = 0; i < 
pmcf
->
moduËs
->
ÃÉs
; i++) {

590 
embeddšg
[2 * 
i
 + 1] = "-I";

591 
embeddšg
[2 * 
i
 + 2] = (*è
m
[i].
d©a
;

595 
embeddšg
[
n
++] = "-Mnginx";

596 
embeddšg
[
n
++] = "-e";

597 
embeddšg
[
n
++] = "0";

598 
embeddšg
[
n
] = 
NULL
;

600 
n
 = 
	`³¾_·r£
(
³¾
, 
ngx_h‰p_³¾_xs_š™
,‚, 
embeddšg
, 
NULL
);

602 ià(
n
 != 0) {

603 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 0, "³¾_·r£(èçžed: %d", 
n
);

604 
çž
;

607 
sv
 = 
	`g‘_sv
("ngšx::VERSION", 
FALSE
);

608 
v”
 = 
	`SvPV
(
sv
, 
Ën
);

610 ià(
	`ngx_¡rcmp
(
v”
, 
NGINX_VERSION
) != 0) {

611 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cf
->
log
, 0,

612 "v”siÚ " 
NGINX_VERSION
 " of‚ginx.pm is„equired, "

613 "buˆ% wa found", 
v”
);

614 
çž
;

617 ià(
	`ngx_h‰p_³¾_run_»quœes
(
aTHX_
 
pmcf
->
»quœes
, 
cf
->
log
è!ð
NGX_OK
) {

618 
çž
;

623  
³¾
;

625 
çž
:

627 (è
	`³¾_de¡ruù
(
³¾
);

629 
	`³¾_ä“
(
³¾
);

631  
NULL
;

632 
	}
}

635 
ngx_št_t


636 
	$ngx_h‰p_³¾_run_»quœes
(
pTHX_
 
ngx_¬¿y_t
 *
»quœes
, 
ngx_log_t
 *
log
)

638 
u_ch¬
 *
”r
;

639 
STRLEN
 
Ën
;

640 
ngx_¡r_t
 *
süt
;

641 
ngx_ušt_t
 
i
;

643 ià(
»quœes
 =ð
NGX_CONF_UNSET_PTR
) {

644  
NGX_OK
;

647 
süt
 = 
»quœes
->
–ts
;

648 
i
 = 0; i < 
»quœes
->
ÃÉs
; i++) {

650 
	`»quœe_pv
((*è
süt
[
i
].
d©a
);

652 ià(
	`SvTRUE
(
ERRSV
)) {

654 
”r
 = (
u_ch¬
 *è
	`SvPV
(
ERRSV
, 
Ën
);

655 --
Ën
 && (
”r
[Ën] =ð
CR
 ||ƒ¼[Ën] =ð
LF
)) { }

657 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 0,

659 
süt
[
i
].
d©a
, 
Ën
 + 1, 
”r
);

661  
NGX_ERROR
;

665  
NGX_OK
;

666 
	}
}

669 
ngx_št_t


670 
	$ngx_h‰p_³¾_ÿÎ_hªdËr
(
pTHX_
 
ngx_h‰p_»que¡_t
 *
r
, 
HV
 *
ngšx
, 
SV
 *
sub
,

671 
SV
 **
¬gs
, 
ngx_¡r_t
 *
hªdËr
,‚gx_¡r_ˆ*
rv
)

673 
SV
 *
sv
;

674 
n
, 
¡©us
;

675 *
lše
;

676 
u_ch¬
 *
”r
;

677 
STRLEN
 
Ën
, 
n_a
;

678 
ngx_ušt_t
 
i
;

679 
ngx_cÚÃùiÚ_t
 *
c
;

681 
dSP
;

683 
¡©us
 = 0;

685 
ENTER
;

686 
SAVETMPS
;

688 
	`PUSHMARK
(
¥
);

690 
sv
 = 
	`sv_2mÜl
(
	`sv_bËss
(
	`ÃwRV_nošc
(
	`ÃwSViv
(
	`PTR2IV
(
r
))), 
ngšx
));

691 
	`XPUSHs
(
sv
);

693 ià(
¬gs
) {

694 
	`EXTEND
(
¥
, (
šŒ_t
è
¬gs
[0]);

696 
i
 = 1; i <ð(
ušŒ_t
è
¬gs
[0]; i++) {

697 
	`PUSHs
(
	`sv_2mÜl
(
¬gs
[
i
]));

701 
PUTBACK
;

703 
c
 = 
r
->
cÚÃùiÚ
;

705 
n
 = 
	`ÿÎ_sv
(
sub
, 
G_EVAL
);

707 
SPAGAIN
;

709 ià(
n
) {

710 ià(
rv
 =ð
NULL
) {

711 
¡©us
 = 
POPi
;

713 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

714 "ÿÎ_sv: %d", 
¡©us
);

717 
lše
 = 
	`SvPVx
(
POPs
, 
n_a
);

718 
rv
->
Ën
 = 
n_a
;

720 
rv
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
n_a
);

721 ià(
rv
->
d©a
 =ð
NULL
) {

722  
NGX_ERROR
;

725 
	`ngx_memýy
(
rv
->
d©a
, 
lše
, 
n_a
);

729 
PUTBACK
;

731 
FREETMPS
;

732 
LEAVE
;

736 ià(
	`SvTRUE
(
ERRSV
)) {

738 
”r
 = (
u_ch¬
 *è
	`SvPV
(
ERRSV
, 
Ën
);

739 --
Ën
 && (
”r
[Ën] =ð
CR
 ||ƒ¼[Ën] =ð
LF
)) { }

741 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

742 "ÿÎ_sv(\"%V\"èçžed: \"%*s\"", 
hªdËr
, 
Ën
 + 1, 
”r
);

744 ià(
rv
) {

745  
NGX_ERROR
;

748  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

751 ià(
n
 != 1) {

752 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

753 "ÿÎ_sv(\"%V\"è»tuºed %d„esuÉs", 
hªdËr
, 
n
);

754 
¡©us
 = 
NGX_OK
;

757 ià(
rv
) {

758  
NGX_OK
;

761  (
ngx_št_t
è
¡©us
;

762 
	}
}

766 
	$ngx_h‰p_³¾_ev®_ªÚ_sub
(
pTHX_
 
ngx_¡r_t
 *
hªdËr
, 
SV
 **
sv
)

768 
u_ch¬
 *
p
;

770 
p
 = 
hªdËr
->
d©a
; *p;…++) {

771 ià(*
p
 !ð' ' && *°!ð'\t' && *°!ð
CR
 && *°!ð
LF
) {

776 ià(
	`ngx_¡ºcmp
(
p
, "sub ", 4) == 0

777 || 
	`ngx_¡ºcmp
(
p
, "sub{", 4) == 0

778 || 
	`ngx_¡ºcmp
(
p
, "use ", 4) == 0)

780 *
sv
 = 
	`ev®_pv
((*è
p
, 
FALSE
);

787 *
sv
 = 
NULL
;

788 
	}
}

792 
	$ngx_h‰p_³¾_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

794 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
;

796 
pmcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_³¾_maš_cÚf_t
));

797 ià(
pmcf
 =ð
NULL
) {

798  
NULL
;

801 
pmcf
->
moduËs
 = 
NGX_CONF_UNSET_PTR
;

802 
pmcf
->
»quœes
 = 
NGX_CONF_UNSET_PTR
;

804  
pmcf
;

805 
	}
}

809 
	$ngx_h‰p_³¾_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
)

811 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
 = 
cÚf
;

813 ià(
pmcf
->
³¾
 =ð
NULL
) {

814 ià(
	`ngx_h‰p_³¾_š™_š‹½»‹r
(
cf
, 
pmcf
è!ð
NGX_CONF_OK
) {

815  
NGX_CONF_ERROR
;

819  
NGX_CONF_OK
;

820 
	}
}

823 #ià(
NGX_HAVE_PERL_MULTIPLICITY
)

826 
	$ngx_h‰p_³¾_þ—nup_³¾
(*
d©a
)

828 
P”lIÁ”´‘”
 *
³¾
 = 
d©a
;

830 
	`PERL_SET_CONTEXT
(
³¾
);

832 (è
	`³¾_de¡ruù
(
³¾
);

834 
	`³¾_ä“
(
³¾
);

836 ià(
ngx_³¾_‹rm
) {

837 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0, "perlerm");

839 
	`PERL_SYS_TERM
();

841 
	}
}

846 
ngx_št_t


847 
	$ngx_h‰p_³¾_´ecÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
)

849 #ià(
NGX_HTTP_SSI
)

850 
ngx_št_t
 
rc
;

851 
ngx_h‰p_ssi_maš_cÚf_t
 *
smcf
;

853 
smcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_ssi_fž‹r_moduË
);

855 
rc
 = 
	`ngx_hash_add_key
(&
smcf
->
commªds
, &
ngx_h‰p_³¾_ssi_commªd
.
Çme
,

856 &
ngx_h‰p_³¾_ssi_commªd
, 
NGX_HASH_READONLY_KEY
);

858 ià(
rc
 !ð
NGX_OK
) {

859 ià(
rc
 =ð
NGX_BUSY
) {

860 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

862 &
ngx_h‰p_³¾_ssi_commªd
.
Çme
);

865  
NGX_ERROR
;

869  
NGX_OK
;

870 
	}
}

874 
	$ngx_h‰p_³¾_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

876 
ngx_h‰p_³¾_loc_cÚf_t
 *
¶cf
;

878 
¶cf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_³¾_loc_cÚf_t
));

879 ià(
¶cf
 =ð
NULL
) {

880  
NULL
;

889  
¶cf
;

890 
	}
}

894 
	$ngx_h‰p_³¾_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

896 
ngx_h‰p_³¾_loc_cÚf_t
 *
´ev
 = 
·»Á
;

897 
ngx_h‰p_³¾_loc_cÚf_t
 *
cÚf
 = 
chžd
;

899 ià(
cÚf
->
sub
 =ð
NULL
) {

900 
cÚf
->
sub
 = 
´ev
->sub;

901 
cÚf
->
hªdËr
 = 
´ev
->handler;

904  
NGX_CONF_OK
;

905 
	}
}

909 
	$ngx_h‰p_³¾
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

911 
ngx_h‰p_³¾_loc_cÚf_t
 *
¶cf
 = 
cÚf
;

913 
ngx_¡r_t
 *
v®ue
;

914 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

915 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
;

917 
v®ue
 = 
cf
->
¬gs
->
–ts
;

919 ià(
¶cf
->
hªdËr
.
d©a
) {

920 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

921 "du¶iÿ‹…”ÈhªdË¸\"%V\"", &
v®ue
[1]);

922  
NGX_CONF_ERROR
;

925 
pmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_³¾_moduË
);

927 ià(
pmcf
->
³¾
 =ð
NULL
) {

928 ià(
	`ngx_h‰p_³¾_š™_š‹½»‹r
(
cf
, 
pmcf
è!ð
NGX_CONF_OK
) {

929  
NGX_CONF_ERROR
;

933 
¶cf
->
hªdËr
 = 
v®ue
[1];

937 
	`dTHXa
(
pmcf
->
³¾
);

938 
	`PERL_SET_CONTEXT
(
pmcf
->
³¾
);

940 
	`ngx_h‰p_³¾_ev®_ªÚ_sub
(
aTHX_
 &
v®ue
[1], &
¶cf
->
sub
);

942 ià(
¶cf
->
sub
 =ð&
PL_sv_undef
) {

943 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_ERR
, 
cf
, 0,

944 "ev®_pv(\"%V\"èçžed", &
v®ue
[1]);

945  
NGX_CONF_ERROR
;

948 ià(
¶cf
->
sub
 =ð
NULL
) {

949 
¶cf
->
sub
 = 
	`ÃwSVpvn
((*è
v®ue
[1].
d©a
, v®ue[1].
Ën
);

954 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

955 
þcf
->
hªdËr
 = 
ngx_h‰p_³¾_hªdËr
;

957  
NGX_CONF_OK
;

958 
	}
}

962 
	$ngx_h‰p_³¾_£t
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

964 
ngx_št_t
 
šdex
;

965 
ngx_¡r_t
 *
v®ue
;

966 
ngx_h‰p_v¬ŸbË_t
 *
v
;

967 
ngx_h‰p_³¾_v¬ŸbË_t
 *
pv
;

968 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
;

970 
v®ue
 = 
cf
->
¬gs
->
–ts
;

972 ià(
v®ue
[1].
d©a
[0] != '$') {

973 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

974 "šv®id v¬ŸbË‚am\"%V\"", &
v®ue
[1]);

975  
NGX_CONF_ERROR
;

978 
v®ue
[1].
Ën
--;

979 
v®ue
[1].
d©a
++;

981 
v
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v®ue
[1], 
NGX_HTTP_VAR_CHANGEABLE
);

982 ià(
v
 =ð
NULL
) {

983  
NGX_CONF_ERROR
;

986 
pv
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_³¾_v¬ŸbË_t
));

987 ià(
pv
 =ð
NULL
) {

988  
NGX_CONF_ERROR
;

991 
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, &
v®ue
[1]);

992 ià(
šdex
 =ð
NGX_ERROR
) {

993  
NGX_CONF_ERROR
;

996 
pmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_³¾_moduË
);

998 ià(
pmcf
->
³¾
 =ð
NULL
) {

999 ià(
	`ngx_h‰p_³¾_š™_š‹½»‹r
(
cf
, 
pmcf
è!ð
NGX_CONF_OK
) {

1000  
NGX_CONF_ERROR
;

1004 
pv
->
hªdËr
 = 
v®ue
[2];

1008 
	`dTHXa
(
pmcf
->
³¾
);

1009 
	`PERL_SET_CONTEXT
(
pmcf
->
³¾
);

1011 
	`ngx_h‰p_³¾_ev®_ªÚ_sub
(
aTHX_
 &
v®ue
[2], &
pv
->
sub
);

1013 ià(
pv
->
sub
 =ð&
PL_sv_undef
) {

1014 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_ERR
, 
cf
, 0,

1015 "ev®_pv(\"%V\"èçžed", &
v®ue
[2]);

1016  
NGX_CONF_ERROR
;

1019 ià(
pv
->
sub
 =ð
NULL
) {

1020 
pv
->
sub
 = 
	`ÃwSVpvn
((*è
v®ue
[2].
d©a
, v®ue[2].
Ën
);

1025 
v
->
g‘_hªdËr
 = 
ngx_h‰p_³¾_v¬ŸbË
;

1026 
v
->
d©a
 = (
ušŒ_t
è
pv
;

1028  
NGX_CONF_OK
;

1029 
	}
}

1032 
ngx_št_t


1033 
	$ngx_h‰p_³¾_š™_wÜk”
(
ngx_cyþe_t
 *
cyþe
)

1035 
ngx_h‰p_³¾_maš_cÚf_t
 *
pmcf
;

1037 
pmcf
 = 
	`ngx_h‰p_cyþe_g‘_moduË_maš_cÚf
(
cyþe
, 
ngx_h‰p_³¾_moduË
);

1039 ià(
pmcf
) {

1040 
	`dTHXa
(
pmcf
->
³¾
);

1041 
	`PERL_SET_CONTEXT
(
pmcf
->
³¾
);

1045 
	`sv_£tiv
(
	`GvSV
(
	`gv_ãtchpv
("$", 
TRUE
, 
SVt_PV
)), (
I32
è
ngx_pid
);

1048  
NGX_OK
;

1049 
	}
}

1053 
	$ngx_h‰p_³¾_ex™
(
ngx_cyþe_t
 *
cyþe
)

1055 #ià(
NGX_HAVE_PERL_MULTIPLICITY
)

1062 
ngx_³¾_‹rm
 = 1;

1066 ià(
ngšx_¡ash
) {

1067 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
cyþe
->
log
, 0, "perlerm");

1069 (è
	`³¾_de¡ruù
(
³¾
);

1071 
	`³¾_ä“
(
³¾
);

1073 
	`PERL_SYS_TERM
();

1077 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 *
ngx_h‰p_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

14 
ngx_št_t
 
ngx_h‰p_š™_pha£s
(
ngx_cÚf_t
 *
cf
,

15 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
);

16 
ngx_št_t
 
ngx_h‰p_š™_h—d”s_š_hash
(
ngx_cÚf_t
 *
cf
,

17 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
);

18 
ngx_št_t
 
ngx_h‰p_š™_pha£_hªdËrs
(
ngx_cÚf_t
 *
cf
,

19 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
);

21 
ngx_št_t
 
ngx_h‰p_add_add»s£s
(
ngx_cÚf_t
 *
cf
,

22 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
, 
ngx_h‰p_cÚf_pÜt_t
 *
pÜt
,

23 
ngx_h‰p_li¡’_Ýt_t
 *
lsÝt
);

24 
ngx_št_t
 
ngx_h‰p_add_add»ss
(
ngx_cÚf_t
 *
cf
,

25 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
, 
ngx_h‰p_cÚf_pÜt_t
 *
pÜt
,

26 
ngx_h‰p_li¡’_Ýt_t
 *
lsÝt
);

27 
ngx_št_t
 
ngx_h‰p_add_£rv”
(
ngx_cÚf_t
 *
cf
,

28 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
, 
ngx_h‰p_cÚf_addr_t
 *
addr
);

30 *
ngx_h‰p_m”ge_£rv”s
(
ngx_cÚf_t
 *
cf
,

31 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
, 
ngx_h‰p_moduË_t
 *
moduË
,

32 
ngx_ušt_t
 
ùx_šdex
);

33 *
ngx_h‰p_m”ge_loÿtiÚs
(
ngx_cÚf_t
 *
cf
,

34 
ngx_queue_t
 *
loÿtiÚs
, **
loc_cÚf
, 
ngx_h‰p_moduË_t
 *
moduË
,

35 
ngx_ušt_t
 
ùx_šdex
);

36 
ngx_št_t
 
ngx_h‰p_š™_loÿtiÚs
(
ngx_cÚf_t
 *
cf
,

37 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
, 
ngx_h‰p_cÜe_loc_cÚf_t
 *
pþcf
);

38 
ngx_št_t
 
ngx_h‰p_š™_¡©ic_loÿtiÚ_Œ“s
(
ngx_cÚf_t
 *
cf
,

39 
ngx_h‰p_cÜe_loc_cÚf_t
 *
pþcf
);

40 
ngx_št_t
 
ngx_h‰p_cmp_loÿtiÚs
(cÚ¡ 
ngx_queue_t
 *
Úe
,

41 cÚ¡ 
ngx_queue_t
 *
two
);

42 
ngx_št_t
 
ngx_h‰p_još_exaù_loÿtiÚs
(
ngx_cÚf_t
 *
cf
,

43 
ngx_queue_t
 *
loÿtiÚs
);

44 
ngx_h‰p_ü—‹_loÿtiÚs_li¡
(
ngx_queue_t
 *
loÿtiÚs
,

45 
ngx_queue_t
 *
q
);

46 
ngx_h‰p_loÿtiÚ_Œ“_node_t
 *

47 
ngx_h‰p_ü—‹_loÿtiÚs_Œ“
(
ngx_cÚf_t
 *
cf
, 
ngx_queue_t
 *
loÿtiÚs
,

48 
size_t
 
´efix
);

50 
ngx_št_t
 
ngx_h‰p_Ýtimize_£rv”s
(
ngx_cÚf_t
 *
cf
,

51 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
, 
ngx_¬¿y_t
 *
pÜts
);

52 
ngx_št_t
 
ngx_h‰p_£rv”_Çmes
(
ngx_cÚf_t
 *
cf
,

53 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
, 
ngx_h‰p_cÚf_addr_t
 *
addr
);

54 
ngx_št_t
 
ngx_h‰p_cmp_cÚf_addrs
(cÚ¡ *
Úe
, cÚ¡ *
two
);

55 
ngx_libc_cdeþ
 
ngx_h‰p_cmp_dns_wždÿrds
(cÚ¡ *
Úe
,

56 cÚ¡ *
two
);

58 
ngx_št_t
 
ngx_h‰p_š™_li¡’šg
(
ngx_cÚf_t
 *
cf
,

59 
ngx_h‰p_cÚf_pÜt_t
 *
pÜt
);

60 
ngx_li¡’šg_t
 *
ngx_h‰p_add_li¡’šg
(
ngx_cÚf_t
 *
cf
,

61 
ngx_h‰p_cÚf_addr_t
 *
addr
);

62 
ngx_št_t
 
ngx_h‰p_add_addrs
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_pÜt_t
 *
hpÜt
,

63 
ngx_h‰p_cÚf_addr_t
 *
addr
);

64 #ià(
NGX_HAVE_INET6
)

65 
ngx_št_t
 
ngx_h‰p_add_addrs6
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_pÜt_t
 *
hpÜt
,

66 
ngx_h‰p_cÚf_addr_t
 *
addr
);

69 
ngx_ušt_t
 
	gngx_h‰p_max_moduË
;

72 
	$ngx_št_t
 (*
ngx_h‰p_tÝ_h—d”_fž‹r
è(
ngx_h‰p_»que¡_t
 *
r
);

73 
	$ngx_št_t
 (*
ngx_h‰p_tÝ_body_fž‹r
è(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
ch
);

76 
ngx_¡r_t
 
ngx_h‰p_html_deçuÉ_ty³s
[] = {

77 
	`ngx_¡ršg
("text/html"),

78 
ngx_nuÎ_¡ršg


79 
	}
};

82 
ngx_commªd_t
 
	gngx_h‰p_commªds
[] = {

84 { 
ngx_¡ršg
("http"),

85 
NGX_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

86 
ngx_h‰p_block
,

89 
NULL
 },

91 
ngx_nuÎ_commªd


95 
ngx_cÜe_moduË_t
 
	gngx_h‰p_moduË_ùx
 = {

96 
ngx_¡ršg
("http"),

97 
NULL
,

98 
NULL


102 
ngx_moduË_t
 
	gngx_h‰p_moduË
 = {

103 
NGX_MODULE_V1
,

104 &
ngx_h‰p_moduË_ùx
,

105 
ngx_h‰p_commªds
,

106 
NGX_CORE_MODULE
,

107 
NULL
,

108 
NULL
,

109 
NULL
,

110 
NULL
,

111 
NULL
,

112 
NULL
,

113 
NULL
,

114 
NGX_MODULE_V1_PADDING


119 
	$ngx_h‰p_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

121 *
rv
;

122 
ngx_ušt_t
 
mi
, 
m
, 
s
;

123 
ngx_cÚf_t
 
pcf
;

124 
ngx_h‰p_moduË_t
 *
moduË
;

125 
ngx_h‰p_cÚf_ùx_t
 *
ùx
;

126 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

127 
ngx_h‰p_cÜe_¤v_cÚf_t
 **
cscå
;

128 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

132 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÚf_ùx_t
));

133 ià(
ùx
 =ð
NULL
) {

134  
NGX_CONF_ERROR
;

137 *(
ngx_h‰p_cÚf_ùx_t
 **è
cÚf
 = 
ùx
;

142 
ngx_h‰p_max_moduË
 = 0;

143 
m
 = 0; 
ngx_moduËs
[m]; m++) {

144 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

148 
ngx_moduËs
[
m
]->
ùx_šdex
 = 
ngx_h‰p_max_moduË
++;

154 
ùx
->
maš_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

155 (*è* 
ngx_h‰p_max_moduË
);

156 ià(
ùx
->
maš_cÚf
 =ð
NULL
) {

157  
NGX_CONF_ERROR
;

166 
ùx
->
¤v_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

167 ià(
ùx
->
¤v_cÚf
 =ð
NULL
) {

168  
NGX_CONF_ERROR
;

177 
ùx
->
loc_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

178 ià(
ùx
->
loc_cÚf
 =ð
NULL
) {

179  
NGX_CONF_ERROR
;

188 
m
 = 0; 
ngx_moduËs
[m]; m++) {

189 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

193 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

194 
mi
 = 
ngx_moduËs
[
m
]->
ùx_šdex
;

196 ià(
moduË
->
ü—‹_maš_cÚf
) {

197 
ùx
->
maš_cÚf
[
mi
] = 
moduË
->
	`ü—‹_maš_cÚf
(
cf
);

198 ià(
ùx
->
maš_cÚf
[
mi
] =ð
NULL
) {

199  
NGX_CONF_ERROR
;

203 ià(
moduË
->
ü—‹_¤v_cÚf
) {

204 
ùx
->
¤v_cÚf
[
mi
] = 
moduË
->
	`ü—‹_¤v_cÚf
(
cf
);

205 ià(
ùx
->
¤v_cÚf
[
mi
] =ð
NULL
) {

206  
NGX_CONF_ERROR
;

210 ià(
moduË
->
ü—‹_loc_cÚf
) {

211 
ùx
->
loc_cÚf
[
mi
] = 
moduË
->
	`ü—‹_loc_cÚf
(
cf
);

212 ià(
ùx
->
loc_cÚf
[
mi
] =ð
NULL
) {

213  
NGX_CONF_ERROR
;

218 
pcf
 = *
cf
;

219 
cf
->
ùx
 = ctx;

221 
m
 = 0; 
ngx_moduËs
[m]; m++) {

222 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

226 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

228 ià(
moduË
->
´ecÚfigu¿tiÚ
) {

229 ià(
moduË
->
	`´ecÚfigu¿tiÚ
(
cf
è!ð
NGX_OK
) {

230  
NGX_CONF_ERROR
;

237 
cf
->
moduË_ty³
 = 
NGX_HTTP_MODULE
;

238 
cf
->
cmd_ty³
 = 
NGX_HTTP_MAIN_CONF
;

239 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

241 ià(
rv
 !ð
NGX_CONF_OK
) {

242 
çžed
;

250 
cmcf
 = 
ùx
->
maš_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

251 
cscå
 = 
cmcf
->
£rv”s
.
–ts
;

253 
m
 = 0; 
ngx_moduËs
[m]; m++) {

254 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

258 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

259 
mi
 = 
ngx_moduËs
[
m
]->
ùx_šdex
;

263 ià(
moduË
->
š™_maš_cÚf
) {

264 
rv
 = 
moduË
->
	`š™_maš_cÚf
(
cf
, 
ùx
->
maš_cÚf
[
mi
]);

265 ià(
rv
 !ð
NGX_CONF_OK
) {

266 
çžed
;

270 
rv
 = 
	`ngx_h‰p_m”ge_£rv”s
(
cf
, 
cmcf
, 
moduË
, 
mi
);

271 ià(
rv
 !ð
NGX_CONF_OK
) {

272 
çžed
;

279 
s
 = 0; s < 
cmcf
->
£rv”s
.
ÃÉs
; s++) {

281 
þcf
 = 
cscå
[
s
]->
ùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

283 ià(
	`ngx_h‰p_š™_loÿtiÚs
(
cf
, 
cscå
[
s
], 
þcf
è!ð
NGX_OK
) {

284  
NGX_CONF_ERROR
;

287 ià(
	`ngx_h‰p_š™_¡©ic_loÿtiÚ_Œ“s
(
cf
, 
þcf
è!ð
NGX_OK
) {

288  
NGX_CONF_ERROR
;

293 ià(
	`ngx_h‰p_š™_pha£s
(
cf
, 
cmcf
è!ð
NGX_OK
) {

294  
NGX_CONF_ERROR
;

297 ià(
	`ngx_h‰p_š™_h—d”s_š_hash
(
cf
, 
cmcf
è!ð
NGX_OK
) {

298  
NGX_CONF_ERROR
;

302 
m
 = 0; 
ngx_moduËs
[m]; m++) {

303 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

307 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

309 ià(
moduË
->
po¡cÚfigu¿tiÚ
) {

310 ià(
moduË
->
	`po¡cÚfigu¿tiÚ
(
cf
è!ð
NGX_OK
) {

311  
NGX_CONF_ERROR
;

316 ià(
	`ngx_h‰p_v¬ŸbËs_š™_v¬s
(
cf
è!ð
NGX_OK
) {

317  
NGX_CONF_ERROR
;

325 *
cf
 = 
pcf
;

328 ià(
	`ngx_h‰p_š™_pha£_hªdËrs
(
cf
, 
cmcf
è!ð
NGX_OK
) {

329  
NGX_CONF_ERROR
;

335 ià(
	`ngx_h‰p_Ýtimize_£rv”s
(
cf
, 
cmcf
, cmcf->
pÜts
è!ð
NGX_OK
) {

336  
NGX_CONF_ERROR
;

339  
NGX_CONF_OK
;

341 
çžed
:

343 *
cf
 = 
pcf
;

345  
rv
;

346 
	}
}

349 
ngx_št_t


350 
	$ngx_h‰p_š™_pha£s
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
)

352 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
pha£s
[
NGX_HTTP_POST_READ_PHASE
].
hªdËrs
,

353 
cf
->
poÞ
, 1, (
ngx_h‰p_hªdËr_±
))

354 !ð
NGX_OK
)

356  
NGX_ERROR
;

359 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
pha£s
[
NGX_HTTP_SERVER_REWRITE_PHASE
].
hªdËrs
,

360 
cf
->
poÞ
, 1, (
ngx_h‰p_hªdËr_±
))

361 !ð
NGX_OK
)

363  
NGX_ERROR
;

366 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
pha£s
[
NGX_HTTP_REWRITE_PHASE
].
hªdËrs
,

367 
cf
->
poÞ
, 1, (
ngx_h‰p_hªdËr_±
))

368 !ð
NGX_OK
)

370  
NGX_ERROR
;

373 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
pha£s
[
NGX_HTTP_PREACCESS_PHASE
].
hªdËrs
,

374 
cf
->
poÞ
, 1, (
ngx_h‰p_hªdËr_±
))

375 !ð
NGX_OK
)

377  
NGX_ERROR
;

380 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
pha£s
[
NGX_HTTP_ACCESS_PHASE
].
hªdËrs
,

381 
cf
->
poÞ
, 2, (
ngx_h‰p_hªdËr_±
))

382 !ð
NGX_OK
)

384  
NGX_ERROR
;

387 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
pha£s
[
NGX_HTTP_CONTENT_PHASE
].
hªdËrs
,

388 
cf
->
poÞ
, 4, (
ngx_h‰p_hªdËr_±
))

389 !ð
NGX_OK
)

391  
NGX_ERROR
;

394 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
pha£s
[
NGX_HTTP_LOG_PHASE
].
hªdËrs
,

395 
cf
->
poÞ
, 1, (
ngx_h‰p_hªdËr_±
))

396 !ð
NGX_OK
)

398  
NGX_ERROR
;

401  
NGX_OK
;

402 
	}
}

405 
ngx_št_t


406 
	$ngx_h‰p_š™_h—d”s_š_hash
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
)

408 
ngx_¬¿y_t
 
h—d”s_š
;

409 
ngx_hash_key_t
 *
hk
;

410 
ngx_hash_š™_t
 
hash
;

411 
ngx_h‰p_h—d”_t
 *
h—d”
;

413 ià(
	`ngx_¬¿y_š™
(&
h—d”s_š
, 
cf
->
‹mp_poÞ
, 32, (
ngx_hash_key_t
))

414 !ð
NGX_OK
)

416  
NGX_ERROR
;

419 
h—d”
 = 
ngx_h‰p_h—d”s_š
; h—d”->
Çme
.
Ën
; header++) {

420 
hk
 = 
	`ngx_¬¿y_push
(&
h—d”s_š
);

421 ià(
hk
 =ð
NULL
) {

422  
NGX_ERROR
;

425 
hk
->
key
 = 
h—d”
->
Çme
;

426 
hk
->
key_hash
 = 
	`ngx_hash_key_lc
(
h—d”
->
Çme
.
d©a
, h—d”->Çme.
Ën
);

427 
hk
->
v®ue
 = 
h—d”
;

430 
hash
.hash = &
cmcf
->
h—d”s_š_hash
;

431 
hash
.
key
 = 
ngx_hash_key_lc
;

432 
hash
.
max_size
 = 512;

433 
hash
.
buck‘_size
 = 
	`ngx_®ign
(64, 
ngx_ÿch–še_size
);

434 
hash
.
Çme
 = "headers_in_hash";

435 
hash
.
poÞ
 = 
cf
->pool;

436 
hash
.
‹mp_poÞ
 = 
NULL
;

438 ià(
	`ngx_hash_š™
(&
hash
, 
h—d”s_š
.
–ts
, h—d”s_š.
ÃÉs
è!ð
NGX_OK
) {

439  
NGX_ERROR
;

442  
NGX_OK
;

443 
	}
}

446 
ngx_št_t


447 
	$ngx_h‰p_š™_pha£_hªdËrs
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
)

449 
ngx_št_t
 
j
;

450 
ngx_ušt_t
 
i
, 
n
;

451 
ngx_ušt_t
 
fšd_cÚfig_šdex
, 
u£_»wr™e
, 
u£_acûss
;

452 
ngx_h‰p_hªdËr_±
 *
h
;

453 
ngx_h‰p_pha£_hªdËr_t
 *
ph
;

454 
ngx_h‰p_pha£_hªdËr_±
 
check”
;

456 
cmcf
->
pha£_’gše
.
£rv”_»wr™e_šdex
 = (
ngx_ušt_t
) -1;

457 
cmcf
->
pha£_’gše
.
loÿtiÚ_»wr™e_šdex
 = (
ngx_ušt_t
) -1;

458 
fšd_cÚfig_šdex
 = 0;

459 
u£_»wr™e
 = 
cmcf
->
pha£s
[
NGX_HTTP_REWRITE_PHASE
].
hªdËrs
.
ÃÉs
 ? 1 : 0;

460 
u£_acûss
 = 
cmcf
->
pha£s
[
NGX_HTTP_ACCESS_PHASE
].
hªdËrs
.
ÃÉs
 ? 1 : 0;

462 
n
 = 
u£_»wr™e
 + 
u£_acûss
 + 
cmcf
->
Œy_fžes
 + 1 ;

464 
i
 = 0; i < 
NGX_HTTP_LOG_PHASE
; i++) {

465 
n
 +ð
cmcf
->
pha£s
[
i
].
hªdËrs
.
ÃÉs
;

468 
ph
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

469 
n
 * (
ngx_h‰p_pha£_hªdËr_t
) + (*));

470 ià(
ph
 =ð
NULL
) {

471  
NGX_ERROR
;

474 
cmcf
->
pha£_’gše
.
hªdËrs
 = 
ph
;

475 
n
 = 0;

477 
i
 = 0; i < 
NGX_HTTP_LOG_PHASE
; i++) {

478 
h
 = 
cmcf
->
pha£s
[
i
].
hªdËrs
.
–ts
;

480 
i
) {

482 
NGX_HTTP_SERVER_REWRITE_PHASE
:

483 ià(
cmcf
->
pha£_’gše
.
£rv”_»wr™e_šdex
 =ð(
ngx_ušt_t
) -1) {

484 
cmcf
->
pha£_’gše
.
£rv”_»wr™e_šdex
 = 
n
;

486 
check”
 = 
ngx_h‰p_cÜe_»wr™e_pha£
;

490 
NGX_HTTP_FIND_CONFIG_PHASE
:

491 
fšd_cÚfig_šdex
 = 
n
;

493 
ph
->
check”
 = 
ngx_h‰p_cÜe_fšd_cÚfig_pha£
;

494 
n
++;

495 
ph
++;

499 
NGX_HTTP_REWRITE_PHASE
:

500 ià(
cmcf
->
pha£_’gše
.
loÿtiÚ_»wr™e_šdex
 =ð(
ngx_ušt_t
) -1) {

501 
cmcf
->
pha£_’gše
.
loÿtiÚ_»wr™e_šdex
 = 
n
;

503 
check”
 = 
ngx_h‰p_cÜe_»wr™e_pha£
;

507 
NGX_HTTP_POST_REWRITE_PHASE
:

508 ià(
u£_»wr™e
) {

509 
ph
->
check”
 = 
ngx_h‰p_cÜe_po¡_»wr™e_pha£
;

510 
ph
->
Ãxt
 = 
fšd_cÚfig_šdex
;

511 
n
++;

512 
ph
++;

517 
NGX_HTTP_ACCESS_PHASE
:

518 
check”
 = 
ngx_h‰p_cÜe_acûss_pha£
;

519 
n
++;

522 
NGX_HTTP_POST_ACCESS_PHASE
:

523 ià(
u£_acûss
) {

524 
ph
->
check”
 = 
ngx_h‰p_cÜe_po¡_acûss_pha£
;

525 
ph
->
Ãxt
 = 
n
;

526 
ph
++;

531 
NGX_HTTP_TRY_FILES_PHASE
:

532 ià(
cmcf
->
Œy_fžes
) {

533 
ph
->
check”
 = 
ngx_h‰p_cÜe_Œy_fžes_pha£
;

534 
n
++;

535 
ph
++;

540 
NGX_HTTP_CONTENT_PHASE
:

541 
check”
 = 
ngx_h‰p_cÜe_cÚ‹Á_pha£
;

545 
check”
 = 
ngx_h‰p_cÜe_g’”ic_pha£
;

548 
n
 +ð
cmcf
->
pha£s
[
i
].
hªdËrs
.
ÃÉs
;

550 
j
 = 
cmcf
->
pha£s
[
i
].
hªdËrs
.
ÃÉs
 - 1; j >=0; j--) {

551 
ph
->
check”
 = checker;

552 
ph
->
hªdËr
 = 
h
[
j
];

553 
ph
->
Ãxt
 = 
n
;

554 
ph
++;

558  
NGX_OK
;

559 
	}
}

563 
	$ngx_h‰p_m”ge_£rv”s
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
,

564 
ngx_h‰p_moduË_t
 *
moduË
, 
ngx_ušt_t
 
ùx_šdex
)

566 *
rv
;

567 
ngx_ušt_t
 
s
;

568 
ngx_h‰p_cÚf_ùx_t
 *
ùx
, 
§ved
;

569 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

570 
ngx_h‰p_cÜe_¤v_cÚf_t
 **
cscå
;

572 
cscå
 = 
cmcf
->
£rv”s
.
–ts
;

573 
ùx
 = (
ngx_h‰p_cÚf_ùx_t
 *è
cf
->ctx;

574 
§ved
 = *
ùx
;

575 
rv
 = 
NGX_CONF_OK
;

577 
s
 = 0; s < 
cmcf
->
£rv”s
.
ÃÉs
; s++) {

581 
ùx
->
¤v_cÚf
 = 
cscå
[
s
]->ctx->srv_conf;

583 ià(
moduË
->
m”ge_¤v_cÚf
) {

584 
rv
 = 
moduË
->
	`m”ge_¤v_cÚf
(
cf
, 
§ved
.
¤v_cÚf
[
ùx_šdex
],

585 
cscå
[
s
]->
ùx
->
¤v_cÚf
[
ùx_šdex
]);

586 ià(
rv
 !ð
NGX_CONF_OK
) {

587 
çžed
;

591 ià(
moduË
->
m”ge_loc_cÚf
) {

595 
ùx
->
loc_cÚf
 = 
cscå
[
s
]->ctx->loc_conf;

597 
rv
 = 
moduË
->
	`m”ge_loc_cÚf
(
cf
, 
§ved
.
loc_cÚf
[
ùx_šdex
],

598 
cscå
[
s
]->
ùx
->
loc_cÚf
[
ùx_šdex
]);

599 ià(
rv
 !ð
NGX_CONF_OK
) {

600 
çžed
;

605 
þcf
 = 
cscå
[
s
]->
ùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

607 
rv
 = 
	`ngx_h‰p_m”ge_loÿtiÚs
(
cf
, 
þcf
->
loÿtiÚs
,

608 
cscå
[
s
]->
ùx
->
loc_cÚf
,

609 
moduË
, 
ùx_šdex
);

610 ià(
rv
 !ð
NGX_CONF_OK
) {

611 
çžed
;

616 
çžed
:

618 *
ùx
 = 
§ved
;

620  
rv
;

621 
	}
}

625 
	$ngx_h‰p_m”ge_loÿtiÚs
(
ngx_cÚf_t
 *
cf
, 
ngx_queue_t
 *
loÿtiÚs
,

626 **
loc_cÚf
, 
ngx_h‰p_moduË_t
 *
moduË
, 
ngx_ušt_t
 
ùx_šdex
)

628 *
rv
;

629 
ngx_queue_t
 *
q
;

630 
ngx_h‰p_cÚf_ùx_t
 *
ùx
, 
§ved
;

631 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

632 
ngx_h‰p_loÿtiÚ_queue_t
 *
lq
;

634 ià(
loÿtiÚs
 =ð
NULL
) {

635  
NGX_CONF_OK
;

638 
ùx
 = (
ngx_h‰p_cÚf_ùx_t
 *è
cf
->ctx;

639 
§ved
 = *
ùx
;

641 
q
 = 
	`ngx_queue_h—d
(
loÿtiÚs
);

642 
q
 !ð
	`ngx_queue_£Áš–
(
loÿtiÚs
);

643 
q
 = 
	`ngx_queue_Ãxt
(q))

645 
lq
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
q
;

647 
þcf
 = 
lq
->
exaù
 ?†q->exaù :†q->
šþusive
;

648 
ùx
->
loc_cÚf
 = 
þcf
->loc_conf;

650 
rv
 = 
moduË
->
	`m”ge_loc_cÚf
(
cf
, 
loc_cÚf
[
ùx_šdex
],

651 
þcf
->
loc_cÚf
[
ùx_šdex
]);

652 ià(
rv
 !ð
NGX_CONF_OK
) {

653  
rv
;

656 
rv
 = 
	`ngx_h‰p_m”ge_loÿtiÚs
(
cf
, 
þcf
->
loÿtiÚs
, clcf->
loc_cÚf
,

657 
moduË
, 
ùx_šdex
);

658 ià(
rv
 !ð
NGX_CONF_OK
) {

659  
rv
;

663 *
ùx
 = 
§ved
;

665  
NGX_CONF_OK
;

666 
	}
}

669 
ngx_št_t


670 
	$ngx_h‰p_š™_loÿtiÚs
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
,

671 
ngx_h‰p_cÜe_loc_cÚf_t
 *
pþcf
)

673 
ngx_ušt_t
 
n
;

674 
ngx_queue_t
 *
q
, *
loÿtiÚs
, *
Çmed
, 
ž
;

675 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

676 
ngx_h‰p_loÿtiÚ_queue_t
 *
lq
;

677 
ngx_h‰p_cÜe_loc_cÚf_t
 **
þcå
;

678 #ià(
NGX_PCRE
)

679 
ngx_ušt_t
 
r
;

680 
ngx_queue_t
 *
»gex
;

683 
loÿtiÚs
 = 
pþcf
->locations;

685 ià(
loÿtiÚs
 =ð
NULL
) {

686  
NGX_OK
;

689 
	`ngx_queue_sÜt
(
loÿtiÚs
, 
ngx_h‰p_cmp_loÿtiÚs
);

691 
Çmed
 = 
NULL
;

692 
n
 = 0;

693 #ià(
NGX_PCRE
)

694 
»gex
 = 
NULL
;

695 
r
 = 0;

698 
q
 = 
	`ngx_queue_h—d
(
loÿtiÚs
);

699 
q
 !ð
	`ngx_queue_£Áš–
(
loÿtiÚs
);

700 
q
 = 
	`ngx_queue_Ãxt
(q))

702 
lq
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
q
;

704 
þcf
 = 
lq
->
exaù
 ?†q->exaù :†q->
šþusive
;

706 ià(
	`ngx_h‰p_š™_loÿtiÚs
(
cf
, 
NULL
, 
þcf
è!ð
NGX_OK
) {

707  
NGX_ERROR
;

710 #ià(
NGX_PCRE
)

712 ià(
þcf
->
»gex
) {

713 
r
++;

715 ià(
»gex
 =ð
NULL
) {

716 
»gex
 = 
q
;

724 ià(
þcf
->
Çmed
) {

725 
n
++;

727 ià(
Çmed
 =ð
NULL
) {

728 
Çmed
 = 
q
;

734 ià(
þcf
->
nÚame
) {

739 ià(
q
 !ð
	`ngx_queue_£Áš–
(
loÿtiÚs
)) {

740 
	`ngx_queue_¥l™
(
loÿtiÚs
, 
q
, &
ž
);

743 ià(
Çmed
) {

744 
þcå
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,

745 (
n
 + 1è* (
ngx_h‰p_cÜe_loc_cÚf_t
 *));

746 ià(
þcå
 =ð
NULL
) {

747  
NGX_ERROR
;

750 
cscf
->
Çmed_loÿtiÚs
 = 
þcå
;

752 
q
 = 
Çmed
;

753 
q
 !ð
	`ngx_queue_£Áš–
(
loÿtiÚs
);

754 
q
 = 
	`ngx_queue_Ãxt
(q))

756 
lq
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
q
;

758 *(
þcå
++èð
lq
->
exaù
;

761 *
þcå
 = 
NULL
;

763 
	`ngx_queue_¥l™
(
loÿtiÚs
, 
Çmed
, &
ž
);

766 #ià(
NGX_PCRE
)

768 ià(
»gex
) {

770 
þcå
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,

771 (
r
 + 1è* (
ngx_h‰p_cÜe_loc_cÚf_t
 *));

772 ià(
þcå
 =ð
NULL
) {

773  
NGX_ERROR
;

776 
pþcf
->
»gex_loÿtiÚs
 = 
þcå
;

778 
q
 = 
»gex
;

779 
q
 !ð
	`ngx_queue_£Áš–
(
loÿtiÚs
);

780 
q
 = 
	`ngx_queue_Ãxt
(q))

782 
lq
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
q
;

784 *(
þcå
++èð
lq
->
exaù
;

787 *
þcå
 = 
NULL
;

789 
	`ngx_queue_¥l™
(
loÿtiÚs
, 
»gex
, &
ž
);

794  
NGX_OK
;

795 
	}
}

798 
ngx_št_t


799 
	$ngx_h‰p_š™_¡©ic_loÿtiÚ_Œ“s
(
ngx_cÚf_t
 *
cf
,

800 
ngx_h‰p_cÜe_loc_cÚf_t
 *
pþcf
)

802 
ngx_queue_t
 *
q
, *
loÿtiÚs
;

803 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

804 
ngx_h‰p_loÿtiÚ_queue_t
 *
lq
;

806 
loÿtiÚs
 = 
pþcf
->locations;

808 ià(
loÿtiÚs
 =ð
NULL
) {

809  
NGX_OK
;

812 ià(
	`ngx_queue_em±y
(
loÿtiÚs
)) {

813  
NGX_OK
;

816 
q
 = 
	`ngx_queue_h—d
(
loÿtiÚs
);

817 
q
 !ð
	`ngx_queue_£Áš–
(
loÿtiÚs
);

818 
q
 = 
	`ngx_queue_Ãxt
(q))

820 
lq
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
q
;

822 
þcf
 = 
lq
->
exaù
 ?†q->exaù :†q->
šþusive
;

824 ià(
	`ngx_h‰p_š™_¡©ic_loÿtiÚ_Œ“s
(
cf
, 
þcf
è!ð
NGX_OK
) {

825  
NGX_ERROR
;

829 ià(
	`ngx_h‰p_još_exaù_loÿtiÚs
(
cf
, 
loÿtiÚs
è!ð
NGX_OK
) {

830  
NGX_ERROR
;

833 
	`ngx_h‰p_ü—‹_loÿtiÚs_li¡
(
loÿtiÚs
, 
	`ngx_queue_h—d
(locations));

835 
pþcf
->
¡©ic_loÿtiÚs
 = 
	`ngx_h‰p_ü—‹_loÿtiÚs_Œ“
(
cf
, 
loÿtiÚs
, 0);

836 ià(
pþcf
->
¡©ic_loÿtiÚs
 =ð
NULL
) {

837  
NGX_ERROR
;

840  
NGX_OK
;

841 
	}
}

844 
ngx_št_t


845 
	$ngx_h‰p_add_loÿtiÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_queue_t
 **
loÿtiÚs
,

846 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
)

848 
ngx_h‰p_loÿtiÚ_queue_t
 *
lq
;

850 ià(*
loÿtiÚs
 =ð
NULL
) {

851 *
loÿtiÚs
 = 
	`ngx_·Îoc
(
cf
->
‹mp_poÞ
,

852 (
ngx_h‰p_loÿtiÚ_queue_t
));

853 ià(*
loÿtiÚs
 =ð
NULL
) {

854  
NGX_ERROR
;

857 
	`ngx_queue_š™
(*
loÿtiÚs
);

860 
lq
 = 
	`ngx_·Îoc
(
cf
->
‹mp_poÞ
, (
ngx_h‰p_loÿtiÚ_queue_t
));

861 ià(
lq
 =ð
NULL
) {

862  
NGX_ERROR
;

865 ià(
þcf
->
exaù_m©ch


866 #ià(
NGX_PCRE
)

867 || 
þcf
->
»gex


869 || 
þcf
->
Çmed
 || clcf->
nÚame
)

871 
lq
->
exaù
 = 
þcf
;

872 
lq
->
šþusive
 = 
NULL
;

875 
lq
->
exaù
 = 
NULL
;

876 
lq
->
šþusive
 = 
þcf
;

879 
lq
->
Çme
 = &
þcf
->name;

880 
lq
->
fže_Çme
 = 
cf
->
cÚf_fže
->
fže
.
Çme
.
d©a
;

881 
lq
->
lše
 = 
cf
->
cÚf_fže
->line;

883 
	`ngx_queue_š™
(&
lq
->
li¡
);

885 
	`ngx_queue_š£¹_ž
(*
loÿtiÚs
, &
lq
->
queue
);

887  
NGX_OK
;

888 
	}
}

891 
ngx_št_t


892 
	$ngx_h‰p_cmp_loÿtiÚs
(cÚ¡ 
ngx_queue_t
 *
Úe
, cÚ¡‚gx_queue_ˆ*
two
)

894 
ngx_št_t
 
rc
;

895 
ngx_h‰p_cÜe_loc_cÚf_t
 *
fœ¡
, *
£cÚd
;

896 
ngx_h‰p_loÿtiÚ_queue_t
 *
lq1
, *
lq2
;

898 
lq1
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
Úe
;

899 
lq2
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
two
;

901 
fœ¡
 = 
lq1
->
exaù
 ?†q1->exaù :†q1->
šþusive
;

902 
£cÚd
 = 
lq2
->
exaù
 ?†q2->exaù :†q2->
šþusive
;

904 ià(
fœ¡
->
nÚame
 && !
£cÚd
->noname) {

909 ià(!
fœ¡
->
nÚame
 && 
£cÚd
->noname) {

914 ià(
fœ¡
->
nÚame
 || 
£cÚd
->noname) {

919 ià(
fœ¡
->
Çmed
 && !
£cÚd
->named) {

924 ià(!
fœ¡
->
Çmed
 && 
£cÚd
->named) {

929 ià(
fœ¡
->
Çmed
 && 
£cÚd
->named) {

930  
	`ngx_¡rcmp
(
fœ¡
->
Çme
.
d©a
, 
£cÚd
->name.data);

933 #ià(
NGX_PCRE
)

935 ià(
fœ¡
->
»gex
 && !
£cÚd
->regex) {

940 ià(!
fœ¡
->
»gex
 && 
£cÚd
->regex) {

945 ià(
fœ¡
->
»gex
 || 
£cÚd
->regex) {

952 
rc
 = 
	`ngx_fž’ame_cmp
(
fœ¡
->
Çme
.
d©a
, 
£cÚd
->name.data,

953 
	`ngx_mš
(
fœ¡
->
Çme
.
Ën
, 
£cÚd
->name.len) + 1);

955 ià(
rc
 =ð0 && !
fœ¡
->
exaù_m©ch
 && 
£cÚd
->exact_match) {

960  
rc
;

961 
	}
}

964 
ngx_št_t


965 
	$ngx_h‰p_još_exaù_loÿtiÚs
(
ngx_cÚf_t
 *
cf
, 
ngx_queue_t
 *
loÿtiÚs
)

967 
ngx_queue_t
 *
q
, *
x
;

968 
ngx_h‰p_loÿtiÚ_queue_t
 *
lq
, *
lx
;

970 
q
 = 
	`ngx_queue_h—d
(
loÿtiÚs
);

972 
q
 !ð
	`ngx_queue_Ï¡
(
loÿtiÚs
)) {

974 
x
 = 
	`ngx_queue_Ãxt
(
q
);

976 
lq
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
q
;

977 
lx
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
x
;

979 ià(
lq
->
Çme
->
Ën
 =ð
lx
->name->len

980 && 
	`ngx_fž’ame_cmp
(
lq
->
Çme
->
d©a
, 
lx
->Çme->d©a,†x->Çme->
Ën
)

983 ià((
lq
->
exaù
 && 
lx
->exaùè|| (lq->
šþusive
 &&†x->inclusive)) {

984 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

986 
lx
->
Çme
,†x->
fže_Çme
,†x->
lše
);

988  
NGX_ERROR
;

991 
lq
->
šþusive
 = 
lx
->inclusive;

993 
	`ngx_queue_»move
(
x
);

998 
q
 = 
	`ngx_queue_Ãxt
(q);

1001  
NGX_OK
;

1002 
	}
}

1006 
	$ngx_h‰p_ü—‹_loÿtiÚs_li¡
(
ngx_queue_t
 *
loÿtiÚs
,‚gx_queue_ˆ*
q
)

1008 
u_ch¬
 *
Çme
;

1009 
size_t
 
Ën
;

1010 
ngx_queue_t
 *
x
, 
ž
;

1011 
ngx_h‰p_loÿtiÚ_queue_t
 *
lq
, *
lx
;

1013 ià(
q
 =ð
	`ngx_queue_Ï¡
(
loÿtiÚs
)) {

1017 
lq
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
q
;

1019 ià(
lq
->
šþusive
 =ð
NULL
) {

1020 
	`ngx_h‰p_ü—‹_loÿtiÚs_li¡
(
loÿtiÚs
, 
	`ngx_queue_Ãxt
(
q
));

1024 
Ën
 = 
lq
->
Çme
->len;

1025 
Çme
 = 
lq
->Çme->
d©a
;

1027 
x
 = 
	`ngx_queue_Ãxt
(
q
);

1028 
x
 !ð
	`ngx_queue_£Áš–
(
loÿtiÚs
);

1029 
x
 = 
	`ngx_queue_Ãxt
(x))

1031 
lx
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
x
;

1033 ià(
Ën
 > 
lx
->
Çme
->len

1034 || 
	`ngx_fž’ame_cmp
(
Çme
, 
lx
->Çme->
d©a
, 
Ën
) != 0)

1040 
q
 = 
	`ngx_queue_Ãxt
(q);

1042 ià(
q
 =ð
x
) {

1043 
	`ngx_h‰p_ü—‹_loÿtiÚs_li¡
(
loÿtiÚs
, 
x
);

1047 
	`ngx_queue_¥l™
(
loÿtiÚs
, 
q
, &
ž
);

1048 
	`ngx_queue_add
(&
lq
->
li¡
, &
ž
);

1050 ià(
x
 =ð
	`ngx_queue_£Áš–
(
loÿtiÚs
)) {

1051 
	`ngx_h‰p_ü—‹_loÿtiÚs_li¡
(&
lq
->
li¡
, 
	`ngx_queue_h—d
(&lq->list));

1055 
	`ngx_queue_¥l™
(&
lq
->
li¡
, 
x
, &
ž
);

1056 
	`ngx_queue_add
(
loÿtiÚs
, &
ž
);

1058 
	`ngx_h‰p_ü—‹_loÿtiÚs_li¡
(&
lq
->
li¡
, 
	`ngx_queue_h—d
(&lq->list));

1060 
	`ngx_h‰p_ü—‹_loÿtiÚs_li¡
(
loÿtiÚs
, 
x
);

1061 
	}
}

1069 
ngx_h‰p_loÿtiÚ_Œ“_node_t
 *

1070 
	$ngx_h‰p_ü—‹_loÿtiÚs_Œ“
(
ngx_cÚf_t
 *
cf
, 
ngx_queue_t
 *
loÿtiÚs
,

1071 
size_t
 
´efix
)

1073 
size_t
 
Ën
;

1074 
ngx_queue_t
 *
q
, 
ž
;

1075 
ngx_h‰p_loÿtiÚ_queue_t
 *
lq
;

1076 
ngx_h‰p_loÿtiÚ_Œ“_node_t
 *
node
;

1078 
q
 = 
	`ngx_queue_middË
(
loÿtiÚs
);

1080 
lq
 = (
ngx_h‰p_loÿtiÚ_queue_t
 *è
q
;

1081 
Ën
 = 
lq
->
Çme
->ËÀ- 
´efix
;

1083 
node
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,

1084 
	`off£tof
(
ngx_h‰p_loÿtiÚ_Œ“_node_t
, 
Çme
è+ 
Ën
);

1085 ià(
node
 =ð
NULL
) {

1086  
NULL
;

1089 
node
->
Ëá
 = 
NULL
;

1090 
node
->
right
 = 
NULL
;

1091 
node
->
Œ“
 = 
NULL
;

1092 
node
->
exaù
 = 
lq
->exact;

1093 
node
->
šþusive
 = 
lq
->inclusive;

1095 
node
->
auto_»dœeù
 = (
u_ch¬
è((
lq
->
exaù
 &&†q->exact->auto_redirect)

1096 || (
lq
->
šþusive
 &&†q->šþusive->
auto_»dœeù
));

1098 
node
->
Ën
 = (
u_ch¬
)†en;

1099 
	`ngx_memýy
(
node
->
Çme
, &
lq
->Çme->
d©a
[
´efix
], 
Ën
);

1101 
	`ngx_queue_¥l™
(
loÿtiÚs
, 
q
, &
ž
);

1103 ià(
	`ngx_queue_em±y
(
loÿtiÚs
)) {

1108 
šþusive
;

1111 
node
->
Ëá
 = 
	`ngx_h‰p_ü—‹_loÿtiÚs_Œ“
(
cf
, 
loÿtiÚs
, 
´efix
);

1112 ià(
node
->
Ëá
 =ð
NULL
) {

1113  
NULL
;

1116 
	`ngx_queue_»move
(
q
);

1118 ià(
	`ngx_queue_em±y
(&
ž
)) {

1119 
šþusive
;

1122 
node
->
right
 = 
	`ngx_h‰p_ü—‹_loÿtiÚs_Œ“
(
cf
, &
ž
, 
´efix
);

1123 ià(
node
->
right
 =ð
NULL
) {

1124  
NULL
;

1127 
šþusive
:

1129 ià(
	`ngx_queue_em±y
(&
lq
->
li¡
)) {

1130  
node
;

1133 
node
->
Œ“
 = 
	`ngx_h‰p_ü—‹_loÿtiÚs_Œ“
(
cf
, &
lq
->
li¡
, 
´efix
 + 
Ën
);

1134 ià(
node
->
Œ“
 =ð
NULL
) {

1135  
NULL
;

1138  
node
;

1139 
	}
}

1142 
ngx_št_t


1143 
	$ngx_h‰p_add_li¡’
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
,

1144 
ngx_h‰p_li¡’_Ýt_t
 *
lsÝt
)

1146 
š_pÜt_t
 
p
;

1147 
ngx_ušt_t
 
i
;

1148 
sockaddr
 *
§
;

1149 
sockaddr_š
 *
sš
;

1150 
ngx_h‰p_cÚf_pÜt_t
 *
pÜt
;

1151 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

1152 #ià(
NGX_HAVE_INET6
)

1153 
sockaddr_š6
 *
sš6
;

1156 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

1158 ià(
cmcf
->
pÜts
 =ð
NULL
) {

1159 
cmcf
->
pÜts
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
‹mp_poÞ
, 2,

1160 (
ngx_h‰p_cÚf_pÜt_t
));

1161 ià(
cmcf
->
pÜts
 =ð
NULL
) {

1162  
NGX_ERROR
;

1166 
§
 = &
lsÝt
->
u
.
sockaddr
;

1168 
§
->
§_çmžy
) {

1170 #ià(
NGX_HAVE_INET6
)

1171 
AF_INET6
:

1172 
sš6
 = &
lsÝt
->
u
.
sockaddr_š6
;

1173 
p
 = 
sš6
->
sš6_pÜt
;

1177 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1178 
AF_UNIX
:

1179 
p
 = 0;

1184 
sš
 = &
lsÝt
->
u
.
sockaddr_š
;

1185 
p
 = 
sš
->
sš_pÜt
;

1189 
pÜt
 = 
cmcf
->
pÜts
->
–ts
;

1190 
i
 = 0; i < 
cmcf
->
pÜts
->
ÃÉs
; i++) {

1192 ià(
p
 !ð
pÜt
[
i
].pÜˆ|| 
§
->
§_çmžy
 !ðpÜt[i].
çmžy
) {

1198  
	`ngx_h‰p_add_add»s£s
(
cf
, 
cscf
, &
pÜt
[
i
], 
lsÝt
);

1203 
pÜt
 = 
	`ngx_¬¿y_push
(
cmcf
->
pÜts
);

1204 ià(
pÜt
 =ð
NULL
) {

1205  
NGX_ERROR
;

1208 
pÜt
->
çmžy
 = 
§
->
§_çmžy
;

1209 
pÜt
->pÜˆð
p
;

1210 
pÜt
->
addrs
.
–ts
 = 
NULL
;

1212  
	`ngx_h‰p_add_add»ss
(
cf
, 
cscf
, 
pÜt
, 
lsÝt
);

1213 
	}
}

1216 
ngx_št_t


1217 
	$ngx_h‰p_add_add»s£s
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
,

1218 
ngx_h‰p_cÚf_pÜt_t
 *
pÜt
, 
ngx_h‰p_li¡’_Ýt_t
 *
lsÝt
)

1220 
u_ch¬
 *
p
;

1221 
size_t
 
Ën
, 
off
;

1222 
ngx_ušt_t
 
i
, 
deçuÉ_£rv”
;

1223 
sockaddr
 *
§
;

1224 
ngx_h‰p_cÚf_addr_t
 *
addr
;

1225 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1226 
sockaddr_un
 *
§un
;

1228 #ià(
NGX_HTTP_SSL
)

1229 
ngx_ušt_t
 
s¦
;

1231 #ià(
NGX_HTTP_SPDY
)

1232 
ngx_ušt_t
 
¥dy
;

1240 
§
 = &
lsÝt
->
u
.
sockaddr
;

1242 
§
->
§_çmžy
) {

1244 #ià(
NGX_HAVE_INET6
)

1245 
AF_INET6
:

1246 
off
 = 
	`off£tof
(
sockaddr_š6
, 
sš6_addr
);

1247 
Ën
 = 16;

1251 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1252 
AF_UNIX
:

1253 
off
 = 
	`off£tof
(
sockaddr_un
, 
sun_·th
);

1254 
Ën
 = (
§un
->
sun_·th
);

1259 
off
 = 
	`off£tof
(
sockaddr_š
, 
sš_addr
);

1260 
Ën
 = 4;

1264 
p
 = 
lsÝt
->
u
.
sockaddr_d©a
 + 
off
;

1266 
addr
 = 
pÜt
->
addrs
.
–ts
;

1268 
i
 = 0; i < 
pÜt
->
addrs
.
ÃÉs
; i++) {

1270 ià(
	`ngx_memcmp
(
p
, 
addr
[
i
].
Ýt
.
u
.
sockaddr_d©a
 + 
off
, 
Ën
) != 0) {

1276 ià(
	`ngx_h‰p_add_£rv”
(
cf
, 
cscf
, &
addr
[
i
]è!ð
NGX_OK
) {

1277  
NGX_ERROR
;

1281 
deçuÉ_£rv”
 = 
addr
[
i
].
Ýt
.default_server;

1283 #ià(
NGX_HTTP_SSL
)

1284 
s¦
 = 
lsÝt
->s¦ || 
addr
[
i
].
Ýt
.ssl;

1286 #ià(
NGX_HTTP_SPDY
)

1287 
¥dy
 = 
lsÝt
->¥dy || 
addr
[
i
].
Ýt
.spdy;

1290 ià(
lsÝt
->
£t
) {

1292 ià(
addr
[
i
].
Ýt
.
£t
) {

1293 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1294 "du¶iÿ‹†i¡’ o±iÚ fÜ %s", 
addr
[
i
].
Ýt
.addr);

1295  
NGX_ERROR
;

1298 
addr
[
i
].
Ýt
 = *
lsÝt
;

1303 ià(
lsÝt
->
deçuÉ_£rv”
) {

1305 ià(
deçuÉ_£rv”
) {

1306 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1307 "¨du¶iÿ‹ deçuÉ s”v” fÜ %s", 
addr
[
i
].
Ýt
.addr);

1308  
NGX_ERROR
;

1311 
deçuÉ_£rv”
 = 1;

1312 
addr
[
i
].
deçuÉ_£rv”
 = 
cscf
;

1315 
addr
[
i
].
Ýt
.
deçuÉ_£rv”
 = default_server;

1316 #ià(
NGX_HTTP_SSL
)

1317 
addr
[
i
].
Ýt
.
s¦
 = ssl;

1319 #ià(
NGX_HTTP_SPDY
)

1320 
addr
[
i
].
Ýt
.
¥dy
 = spdy;

1323  
NGX_OK
;

1328  
	`ngx_h‰p_add_add»ss
(
cf
, 
cscf
, 
pÜt
, 
lsÝt
);

1329 
	}
}

1337 
ngx_št_t


1338 
	$ngx_h‰p_add_add»ss
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
,

1339 
ngx_h‰p_cÚf_pÜt_t
 *
pÜt
, 
ngx_h‰p_li¡’_Ýt_t
 *
lsÝt
)

1341 
ngx_h‰p_cÚf_addr_t
 *
addr
;

1343 ià(
pÜt
->
addrs
.
–ts
 =ð
NULL
) {

1344 ià(
	`ngx_¬¿y_š™
(&
pÜt
->
addrs
, 
cf
->
‹mp_poÞ
, 4,

1345 (
ngx_h‰p_cÚf_addr_t
))

1346 !ð
NGX_OK
)

1348  
NGX_ERROR
;

1352 #ià(
NGX_HTTP_SPDY
 && 
NGX_HTTP_SSL
 \

1353 && !
defšed
 
TLSEXT_TYPE_­¶iÿtiÚ_Ïy”_´ÙocÞ_ÃgÙŸtiÚ
 \

1354 && !
defšed
 
TLSEXT_TYPE_Ãxt_´Ùo_Ãg
)

1355 ià(
lsÝt
->
¥dy
 &&†sÝt->
s¦
) {

1356 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

1358 "suµÜt, SPDY i nÙƒÇbËd fÜ %s", 
lsÝt
->
addr
);

1362 
addr
 = 
	`ngx_¬¿y_push
(&
pÜt
->
addrs
);

1363 ià(
addr
 =ð
NULL
) {

1364  
NGX_ERROR
;

1367 
addr
->
Ýt
 = *
lsÝt
;

1368 
addr
->
hash
.
buck‘s
 = 
NULL
;

1369 
addr
->
hash
.
size
 = 0;

1370 
addr
->
wc_h—d
 = 
NULL
;

1371 
addr
->
wc_ž
 = 
NULL
;

1372 #ià(
NGX_PCRE
)

1373 
addr
->
Äegex
 = 0;

1374 
addr
->
»gex
 = 
NULL
;

1376 
addr
->
deçuÉ_£rv”
 = 
cscf
;

1377 
addr
->
£rv”s
.
–ts
 = 
NULL
;

1379  
	`ngx_h‰p_add_£rv”
(
cf
, 
cscf
, 
addr
);

1380 
	}
}

1385 
ngx_št_t


1386 
	$ngx_h‰p_add_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
,

1387 
ngx_h‰p_cÚf_addr_t
 *
addr
)

1389 
ngx_ušt_t
 
i
;

1390 
ngx_h‰p_cÜe_¤v_cÚf_t
 **
£rv”
;

1392 ià(
addr
->
£rv”s
.
–ts
 =ð
NULL
) {

1393 ià(
	`ngx_¬¿y_š™
(&
addr
->
£rv”s
, 
cf
->
‹mp_poÞ
, 4,

1394 (
ngx_h‰p_cÜe_¤v_cÚf_t
 *))

1395 !ð
NGX_OK
)

1397  
NGX_ERROR
;

1401 
£rv”
 = 
addr
->
£rv”s
.
–ts
;

1402 
i
 = 0; i < 
addr
->
£rv”s
.
ÃÉs
; i++) {

1403 ià(
£rv”
[
i
] =ð
cscf
) {

1404 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1405 "¨du¶iÿ‹†i¡’ %s", 
addr
->
Ýt
.addr);

1406  
NGX_ERROR
;

1411 
£rv”
 = 
	`ngx_¬¿y_push
(&
addr
->
£rv”s
);

1412 ià(
£rv”
 =ð
NULL
) {

1413  
NGX_ERROR
;

1416 *
£rv”
 = 
cscf
;

1418  
NGX_OK
;

1419 
	}
}

1422 
ngx_št_t


1423 
	$ngx_h‰p_Ýtimize_£rv”s
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
,

1424 
ngx_¬¿y_t
 *
pÜts
)

1426 
ngx_ušt_t
 
p
, 
a
;

1427 
ngx_h‰p_cÚf_pÜt_t
 *
pÜt
;

1428 
ngx_h‰p_cÚf_addr_t
 *
addr
;

1430 ià(
pÜts
 =ð
NULL
) {

1431  
NGX_OK
;

1434 
pÜt
 = 
pÜts
->
–ts
;

1435 
p
 = 0;… < 
pÜts
->
ÃÉs
;…++) {

1437 
	`ngx_sÜt
(
pÜt
[
p
].
addrs
.
–ts
, (
size_t
èpÜt[p].addrs.
ÃÉs
,

1438 (
ngx_h‰p_cÚf_addr_t
), 
ngx_h‰p_cmp_cÚf_addrs
);

1445 
addr
 = 
pÜt
[
p
].
addrs
.
–ts
;

1446 
a
 = 0;‡ < 
pÜt
[
p
].
addrs
.
ÃÉs
;‡++) {

1448 ià(
addr
[
a
].
£rv”s
.
ÃÉs
 > 1

1449 #ià(
NGX_PCRE
)

1450 || 
addr
[
a
].
deçuÉ_£rv”
->
ÿ±u»s


1454 ià(
	`ngx_h‰p_£rv”_Çmes
(
cf
, 
cmcf
, &
addr
[
a
]è!ð
NGX_OK
) {

1455  
NGX_ERROR
;

1460 ià(
	`ngx_h‰p_š™_li¡’šg
(
cf
, &
pÜt
[
p
]è!ð
NGX_OK
) {

1461  
NGX_ERROR
;

1465  
NGX_OK
;

1466 
	}
}

1469 
ngx_št_t


1470 
	$ngx_h‰p_£rv”_Çmes
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
,

1471 
ngx_h‰p_cÚf_addr_t
 *
addr
)

1473 
ngx_št_t
 
rc
;

1474 
ngx_ušt_t
 
n
, 
s
;

1475 
ngx_hash_š™_t
 
hash
;

1476 
ngx_hash_keys_¬¿ys_t
 
ha
;

1477 
ngx_h‰p_£rv”_Çme_t
 *
Çme
;

1478 
ngx_h‰p_cÜe_¤v_cÚf_t
 **
cscå
;

1479 #ià(
NGX_PCRE
)

1480 
ngx_ušt_t
 
»gex
, 
i
;

1482 
»gex
 = 0;

1485 
	`ngx_memz”o
(&
ha
, (
ngx_hash_keys_¬¿ys_t
));

1487 
ha
.
‹mp_poÞ
 = 
	`ngx_ü—‹_poÞ
(
NGX_DEFAULT_POOL_SIZE
, 
cf
->
log
);

1488 ià(
ha
.
‹mp_poÞ
 =ð
NULL
) {

1489  
NGX_ERROR
;

1492 
ha
.
poÞ
 = 
cf
->pool;

1494 ià(
	`ngx_hash_keys_¬¿y_š™
(&
ha
, 
NGX_HASH_LARGE
è!ð
NGX_OK
) {

1495 
çžed
;

1498 
cscå
 = 
addr
->
£rv”s
.
–ts
;

1500 
s
 = 0; s < 
addr
->
£rv”s
.
ÃÉs
; s++) {

1502 
Çme
 = 
cscå
[
s
]->
£rv”_Çmes
.
–ts
;

1504 
n
 = 0;‚ < 
cscå
[
s
]->
£rv”_Çmes
.
ÃÉs
;‚++) {

1506 #ià(
NGX_PCRE
)

1507 ià(
Çme
[
n
].
»gex
) {

1508 
»gex
++;

1513 
rc
 = 
	`ngx_hash_add_key
(&
ha
, &
Çme
[
n
].Çme,‚ame[n].
£rv”
,

1514 
NGX_HASH_WILDCARD_KEY
);

1516 ià(
rc
 =ð
NGX_ERROR
) {

1517  
NGX_ERROR
;

1520 ià(
rc
 =ð
NGX_DECLINED
) {

1521 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

1523 &
Çme
[
n
].Çme, 
addr
->
Ýt
.addr);

1524  
NGX_ERROR
;

1527 ià(
rc
 =ð
NGX_BUSY
) {

1528 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
cf
->
log
, 0,

1530 &
Çme
[
n
].Çme, 
addr
->
Ýt
.addr);

1535 
hash
.
key
 = 
ngx_hash_key_lc
;

1536 
hash
.
max_size
 = 
cmcf
->
£rv”_Çmes_hash_max_size
;

1537 
hash
.
buck‘_size
 = 
cmcf
->
£rv”_Çmes_hash_buck‘_size
;

1538 
hash
.
Çme
 = "server_names_hash";

1539 
hash
.
poÞ
 = 
cf
->pool;

1541 ià(
ha
.
keys
.
ÃÉs
) {

1542 
hash
.hash = &
addr
->hash;

1543 
hash
.
‹mp_poÞ
 = 
NULL
;

1545 ià(
	`ngx_hash_š™
(&
hash
, 
ha
.
keys
.
–ts
, ha.keys.
ÃÉs
è!ð
NGX_OK
) {

1546 
çžed
;

1550 ià(
ha
.
dns_wc_h—d
.
ÃÉs
) {

1552 
	`ngx_qsÜt
(
ha
.
dns_wc_h—d
.
–ts
, (
size_t
èha.dns_wc_h—d.
ÃÉs
,

1553 (
ngx_hash_key_t
), 
ngx_h‰p_cmp_dns_wždÿrds
);

1555 
hash
.hash = 
NULL
;

1556 
hash
.
‹mp_poÞ
 = 
ha
.temp_pool;

1558 ià(
	`ngx_hash_wždÿrd_š™
(&
hash
, 
ha
.
dns_wc_h—d
.
–ts
,

1559 
ha
.
dns_wc_h—d
.
ÃÉs
)

1560 !ð
NGX_OK
)

1562 
çžed
;

1565 
addr
->
wc_h—d
 = (
ngx_hash_wždÿrd_t
 *è
hash
.hash;

1568 ià(
ha
.
dns_wc_ž
.
ÃÉs
) {

1570 
	`ngx_qsÜt
(
ha
.
dns_wc_ž
.
–ts
, (
size_t
èha.dns_wc_ž.
ÃÉs
,

1571 (
ngx_hash_key_t
), 
ngx_h‰p_cmp_dns_wždÿrds
);

1573 
hash
.hash = 
NULL
;

1574 
hash
.
‹mp_poÞ
 = 
ha
.temp_pool;

1576 ià(
	`ngx_hash_wždÿrd_š™
(&
hash
, 
ha
.
dns_wc_ž
.
–ts
,

1577 
ha
.
dns_wc_ž
.
ÃÉs
)

1578 !ð
NGX_OK
)

1580 
çžed
;

1583 
addr
->
wc_ž
 = (
ngx_hash_wždÿrd_t
 *è
hash
.hash;

1586 
	`ngx_de¡roy_poÞ
(
ha
.
‹mp_poÞ
);

1588 #ià(
NGX_PCRE
)

1590 ià(
»gex
 == 0) {

1591  
NGX_OK
;

1594 
addr
->
Äegex
 = 
»gex
;

1595 
addr
->
»gex
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,„egex * (
ngx_h‰p_£rv”_Çme_t
));

1596 ià(
addr
->
»gex
 =ð
NULL
) {

1597  
NGX_ERROR
;

1600 
i
 = 0;

1602 
s
 = 0; s < 
addr
->
£rv”s
.
ÃÉs
; s++) {

1604 
Çme
 = 
cscå
[
s
]->
£rv”_Çmes
.
–ts
;

1606 
n
 = 0;‚ < 
cscå
[
s
]->
£rv”_Çmes
.
ÃÉs
;‚++) {

1607 ià(
Çme
[
n
].
»gex
) {

1608 
addr
->
»gex
[
i
++] = 
Çme
[
n
];

1615  
NGX_OK
;

1617 
çžed
:

1619 
	`ngx_de¡roy_poÞ
(
ha
.
‹mp_poÞ
);

1621  
NGX_ERROR
;

1622 
	}
}

1625 
ngx_št_t


1626 
	$ngx_h‰p_cmp_cÚf_addrs
(cÚ¡ *
Úe
, cÚ¡ *
two
)

1628 
ngx_h‰p_cÚf_addr_t
 *
fœ¡
, *
£cÚd
;

1630 
fœ¡
 = (
ngx_h‰p_cÚf_addr_t
 *è
Úe
;

1631 
£cÚd
 = (
ngx_h‰p_cÚf_addr_t
 *è
two
;

1633 ià(
fœ¡
->
Ýt
.
wždÿrd
) {

1638 ià(
£cÚd
->
Ýt
.
wždÿrd
) {

1643 ià(
fœ¡
->
Ýt
.
bšd
 && !
£cÚd
->opt.bind) {

1648 ià(!
fœ¡
->
Ýt
.
bšd
 && 
£cÚd
->opt.bind) {

1656 
	}
}

1659 
ngx_libc_cdeþ


1660 
	$ngx_h‰p_cmp_dns_wždÿrds
(cÚ¡ *
Úe
, cÚ¡ *
two
)

1662 
ngx_hash_key_t
 *
fœ¡
, *
£cÚd
;

1664 
fœ¡
 = (
ngx_hash_key_t
 *è
Úe
;

1665 
£cÚd
 = (
ngx_hash_key_t
 *è
two
;

1667  
	`ngx_dns_¡rcmp
(
fœ¡
->
key
.
d©a
, 
£cÚd
->key.data);

1668 
	}
}

1671 
ngx_št_t


1672 
	$ngx_h‰p_š™_li¡’šg
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÚf_pÜt_t
 *
pÜt
)

1674 
ngx_ušt_t
 
i
, 
Ï¡
, 
bšd_wždÿrd
;

1675 
ngx_li¡’šg_t
 *
ls
;

1676 
ngx_h‰p_pÜt_t
 *
hpÜt
;

1677 
ngx_h‰p_cÚf_addr_t
 *
addr
;

1679 
addr
 = 
pÜt
->
addrs
.
–ts
;

1680 
Ï¡
 = 
pÜt
->
addrs
.
ÃÉs
;

1689 ià(
addr
[
Ï¡
 - 1].
Ýt
.
wždÿrd
) {

1690 
addr
[
Ï¡
 - 1].
Ýt
.
bšd
 = 1;

1691 
bšd_wždÿrd
 = 1;

1694 
bšd_wždÿrd
 = 0;

1697 
i
 = 0;

1699 
i
 < 
Ï¡
) {

1701 ià(
bšd_wždÿrd
 && !
addr
[
i
].
Ýt
.
bšd
) {

1702 
i
++;

1706 
ls
 = 
	`ngx_h‰p_add_li¡’šg
(
cf
, &
addr
[
i
]);

1707 ià(
ls
 =ð
NULL
) {

1708  
NGX_ERROR
;

1711 
hpÜt
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_pÜt_t
));

1712 ià(
hpÜt
 =ð
NULL
) {

1713  
NGX_ERROR
;

1716 
ls
->
£rv”s
 = 
hpÜt
;

1718 ià(
i
 =ð
Ï¡
 - 1) {

1719 
hpÜt
->
Çddrs
 = 
Ï¡
;

1722 
hpÜt
->
Çddrs
 = 1;

1723 
i
 = 0;

1726 
ls
->
sockaddr
->
§_çmžy
) {

1728 #ià(
NGX_HAVE_INET6
)

1729 
AF_INET6
:

1730 ià(
	`ngx_h‰p_add_addrs6
(
cf
, 
hpÜt
, 
addr
è!ð
NGX_OK
) {

1731  
NGX_ERROR
;

1736 ià(
	`ngx_h‰p_add_addrs
(
cf
, 
hpÜt
, 
addr
è!ð
NGX_OK
) {

1737  
NGX_ERROR
;

1742 
addr
++;

1743 
Ï¡
--;

1746  
NGX_OK
;

1747 
	}
}

1750 
ngx_li¡’šg_t
 *

1751 
	$ngx_h‰p_add_li¡’šg
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÚf_addr_t
 *
addr
)

1753 
ngx_li¡’šg_t
 *
ls
;

1754 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1755 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

1757 
ls
 = 
	`ngx_ü—‹_li¡’šg
(
cf
, &
addr
->
Ýt
.
u
.
sockaddr
,‡ddr->Ýt.
sockËn
);

1758 ià(
ls
 =ð
NULL
) {

1759  
NULL
;

1762 
ls
->
addr_ÁÝ
 = 1;

1764 
ls
->
hªdËr
 = 
ngx_h‰p_š™_cÚÃùiÚ
;

1766 
cscf
 = 
addr
->
deçuÉ_£rv”
;

1767 
ls
->
poÞ_size
 = 
cscf
->
cÚÃùiÚ_poÞ_size
;

1768 
ls
->
po¡_acû±_timeout
 = 
cscf
->
þ›Á_h—d”_timeout
;

1770 
þcf
 = 
cscf
->
ùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

1772 
ls
->
logp
 = 
þcf
->
”rÜ_log
;

1773 
ls
->
log
.
d©a
 = &ls->
addr_‹xt
;

1774 
ls
->
log
.
hªdËr
 = 
ngx_acû±_log_”rÜ
;

1776 #ià(
NGX_WIN32
)

1778 
ngx_ioý_cÚf_t
 *
ioýcf
 = 
NULL
;

1780 ià(
	`ngx_g‘_cÚf
(
cf
->
cyþe
->
cÚf_ùx
, 
ngx_ev’ts_moduË
)) {

1781 
ioýcf
 = 
	`ngx_ev’t_g‘_cÚf
(
cf
->
cyþe
->
cÚf_ùx
, 
ngx_ioý_moduË
);

1783 ià(
ioýcf
 && ioýcf->
acû±ex_»ad
) {

1784 
ls
->
po¡_acû±_bufãr_size
 = 
cscf
->
þ›Á_h—d”_bufãr_size
;

1789 
ls
->
backlog
 = 
addr
->
Ýt
.backlog;

1790 
ls
->
rcvbuf
 = 
addr
->
Ýt
.rcvbuf;

1791 
ls
->
¢dbuf
 = 
addr
->
Ýt
.sndbuf;

1793 
ls
->
k“·live
 = 
addr
->
Ýt
.
so_k“·live
;

1794 #ià(
NGX_HAVE_KEEPALIVE_TUNABLE
)

1795 
ls
->
k“pidË
 = 
addr
->
Ýt
.
tý_k“pidË
;

1796 
ls
->
k“pštvl
 = 
addr
->
Ýt
.
tý_k“pštvl
;

1797 
ls
->
k“pút
 = 
addr
->
Ýt
.
tý_k“pút
;

1800 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
SO_ACCEPTFILTER
)

1801 
ls
->
acû±_fž‹r
 = 
addr
->
Ýt
.accept_filter;

1804 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
TCP_DEFER_ACCEPT
)

1805 
ls
->
deã¼ed_acû±
 = 
addr
->
Ýt
.deferred_accept;

1808 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

1809 
ls
->
v6Úly
 = 
addr
->
Ýt
.ipv6only;

1812 #ià(
NGX_HAVE_SETFIB
)

1813 
ls
->
£tfib
 = 
addr
->
Ýt
.setfib;

1816 #ià(
NGX_HAVE_TCP_FASTOPEN
)

1817 
ls
->
ç¡Ý’
 = 
addr
->
Ýt
.fastopen;

1820  
ls
;

1821 
	}
}

1824 
ngx_št_t


1825 
	$ngx_h‰p_add_addrs
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_pÜt_t
 *
hpÜt
,

1826 
ngx_h‰p_cÚf_addr_t
 *
addr
)

1828 
ngx_ušt_t
 
i
;

1829 
ngx_h‰p_š_addr_t
 *
addrs
;

1830 
sockaddr_š
 *
sš
;

1831 
ngx_h‰p_vœtu®_Çmes_t
 *
vn
;

1833 
hpÜt
->
addrs
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

1834 
hpÜt
->
Çddrs
 * (
ngx_h‰p_š_addr_t
));

1835 ià(
hpÜt
->
addrs
 =ð
NULL
) {

1836  
NGX_ERROR
;

1839 
addrs
 = 
hpÜt
->addrs;

1841 
i
 = 0; i < 
hpÜt
->
Çddrs
; i++) {

1843 
sš
 = &
addr
[
i
].
Ýt
.
u
.
sockaddr_š
;

1844 
addrs
[
i
].
addr
 = 
sš
->
sš_addr
.
s_addr
;

1845 
addrs
[
i
].
cÚf
.
deçuÉ_£rv”
 = 
addr
[i].default_server;

1846 #ià(
NGX_HTTP_SSL
)

1847 
addrs
[
i
].
cÚf
.
s¦
 = 
addr
[i].
Ýt
.ssl;

1849 #ià(
NGX_HTTP_SPDY
)

1850 
addrs
[
i
].
cÚf
.
¥dy
 = 
addr
[i].
Ýt
.spdy;

1852 
addrs
[
i
].
cÚf
.
´oxy_´ÙocÞ
 = 
addr
[i].
Ýt
.proxy_protocol;

1854 ià(
addr
[
i
].
hash
.
buck‘s
 =ð
NULL


1855 && (
addr
[
i
].
wc_h—d
 =ð
NULL


1856 || 
addr
[
i
].
wc_h—d
->
hash
.
buck‘s
 =ð
NULL
)

1857 && (
addr
[
i
].
wc_ž
 =ð
NULL


1858 || 
addr
[
i
].
wc_ž
->
hash
.
buck‘s
 =ð
NULL
)

1859 #ià(
NGX_PCRE
)

1860 && 
addr
[
i
].
Äegex
 == 0

1867 
vn
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_vœtu®_Çmes_t
));

1868 ià(
vn
 =ð
NULL
) {

1869  
NGX_ERROR
;

1872 
addrs
[
i
].
cÚf
.
vœtu®_Çmes
 = 
vn
;

1874 
vn
->
Çmes
.
hash
 = 
addr
[
i
].hash;

1875 
vn
->
Çmes
.
wc_h—d
 = 
addr
[
i
].wc_head;

1876 
vn
->
Çmes
.
wc_ž
 = 
addr
[
i
].wc_tail;

1877 #ià(
NGX_PCRE
)

1878 
vn
->
Äegex
 = 
addr
[
i
].nregex;

1879 
vn
->
»gex
 = 
addr
[
i
].regex;

1883  
NGX_OK
;

1884 
	}
}

1887 #ià(
NGX_HAVE_INET6
)

1889 
ngx_št_t


1890 
	$ngx_h‰p_add_addrs6
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_pÜt_t
 *
hpÜt
,

1891 
ngx_h‰p_cÚf_addr_t
 *
addr
)

1893 
ngx_ušt_t
 
i
;

1894 
ngx_h‰p_š6_addr_t
 *
addrs6
;

1895 
sockaddr_š6
 *
sš6
;

1896 
ngx_h‰p_vœtu®_Çmes_t
 *
vn
;

1898 
hpÜt
->
addrs
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

1899 
hpÜt
->
Çddrs
 * (
ngx_h‰p_š6_addr_t
));

1900 ià(
hpÜt
->
addrs
 =ð
NULL
) {

1901  
NGX_ERROR
;

1904 
addrs6
 = 
hpÜt
->
addrs
;

1906 
i
 = 0; i < 
hpÜt
->
Çddrs
; i++) {

1908 
sš6
 = &
addr
[
i
].
Ýt
.
u
.
sockaddr_š6
;

1909 
addrs6
[
i
].
addr6
 = 
sš6
->
sš6_addr
;

1910 
addrs6
[
i
].
cÚf
.
deçuÉ_£rv”
 = 
addr
[i].default_server;

1911 #ià(
NGX_HTTP_SSL
)

1912 
addrs6
[
i
].
cÚf
.
s¦
 = 
addr
[i].
Ýt
.ssl;

1914 #ià(
NGX_HTTP_SPDY
)

1915 
addrs6
[
i
].
cÚf
.
¥dy
 = 
addr
[i].
Ýt
.spdy;

1918 ià(
addr
[
i
].
hash
.
buck‘s
 =ð
NULL


1919 && (
addr
[
i
].
wc_h—d
 =ð
NULL


1920 || 
addr
[
i
].
wc_h—d
->
hash
.
buck‘s
 =ð
NULL
)

1921 && (
addr
[
i
].
wc_ž
 =ð
NULL


1922 || 
addr
[
i
].
wc_ž
->
hash
.
buck‘s
 =ð
NULL
)

1923 #ià(
NGX_PCRE
)

1924 && 
addr
[
i
].
Äegex
 == 0

1931 
vn
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_vœtu®_Çmes_t
));

1932 ià(
vn
 =ð
NULL
) {

1933  
NGX_ERROR
;

1936 
addrs6
[
i
].
cÚf
.
vœtu®_Çmes
 = 
vn
;

1938 
vn
->
Çmes
.
hash
 = 
addr
[
i
].hash;

1939 
vn
->
Çmes
.
wc_h—d
 = 
addr
[
i
].wc_head;

1940 
vn
->
Çmes
.
wc_ž
 = 
addr
[
i
].wc_tail;

1941 #ià(
NGX_PCRE
)

1942 
vn
->
Äegex
 = 
addr
[
i
].nregex;

1943 
vn
->
»gex
 = 
addr
[
i
].regex;

1947  
NGX_OK
;

1948 
	}
}

1954 
	$ngx_h‰p_ty³s_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1956 *
p
 = 
cÚf
;

1958 
ngx_¬¿y_t
 **
ty³s
;

1959 
ngx_¡r_t
 *
v®ue
, *
deçuÉ_ty³
;

1960 
ngx_ušt_t
 
i
, 
n
, 
hash
;

1961 
ngx_hash_key_t
 *
ty³
;

1963 
ty³s
 = (
ngx_¬¿y_t
 **è(
p
 + 
cmd
->
off£t
);

1965 ià(*
ty³s
 == (*) -1) {

1966  
NGX_CONF_OK
;

1969 
deçuÉ_ty³
 = 
cmd
->
po¡
;

1971 ià(*
ty³s
 =ð
NULL
) {

1972 *
ty³s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
‹mp_poÞ
, 1, (
ngx_hash_key_t
));

1973 ià(*
ty³s
 =ð
NULL
) {

1974  
NGX_CONF_ERROR
;

1977 ià(
deçuÉ_ty³
) {

1978 
ty³
 = 
	`ngx_¬¿y_push
(*
ty³s
);

1979 ià(
ty³
 =ð
NULL
) {

1980  
NGX_CONF_ERROR
;

1983 
ty³
->
key
 = *
deçuÉ_ty³
;

1984 
ty³
->
key_hash
 = 
	`ngx_hash_key
(
deçuÉ_ty³
->
d©a
,

1985 
deçuÉ_ty³
->
Ën
);

1986 
ty³
->
v®ue
 = (*) 4;

1990 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1992 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

1994 ià(
v®ue
[
i
].
Ën
 =ð1 && v®ue[i].
d©a
[0] == '*') {

1995 *
ty³s
 = (*) -1;

1996  
NGX_CONF_OK
;

1999 
hash
 = 
	`ngx_hash_¡¾ow
(
v®ue
[
i
].
d©a
, v®ue[i].d©a, v®ue[i].
Ën
);

2000 
v®ue
[
i
].
d©a
[v®ue[i].
Ën
] = '\0';

2002 
ty³
 = (*
ty³s
)->
–ts
;

2003 
n
 = 0;‚ < (*
ty³s
)->
ÃÉs
;‚++) {

2005 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, 
ty³
[
n
].
key
.data) == 0) {

2006 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

2007 "du¶iÿ‹ MIMEy³ \"%V\"", &
v®ue
[
i
]);

2008 
Ãxt
;

2012 
ty³
 = 
	`ngx_¬¿y_push
(*
ty³s
);

2013 ià(
ty³
 =ð
NULL
) {

2014  
NGX_CONF_ERROR
;

2017 
ty³
->
key
 = 
v®ue
[
i
];

2018 
ty³
->
key_hash
 = 
hash
;

2019 
ty³
->
v®ue
 = (*) 4;

2021 
Ãxt
:

2026  
NGX_CONF_OK
;

2027 
	}
}

2031 
	$ngx_h‰p_m”ge_ty³s
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 **
keys
, 
ngx_hash_t
 *
ty³s_hash
,

2032 
ngx_¬¿y_t
 **
´ev_keys
, 
ngx_hash_t
 *
´ev_ty³s_hash
,

2033 
ngx_¡r_t
 *
deçuÉ_ty³s
)

2035 
ngx_hash_š™_t
 
hash
;

2037 ià(*
keys
) {

2039 ià(*
keys
 == (*) -1) {

2040  
NGX_CONF_OK
;

2043 
hash
.hash = 
ty³s_hash
;

2044 
hash
.
key
 = 
NULL
;

2045 
hash
.
max_size
 = 2048;

2046 
hash
.
buck‘_size
 = 64;

2047 
hash
.
Çme
 = "test_types_hash";

2048 
hash
.
poÞ
 = 
cf
->pool;

2049 
hash
.
‹mp_poÞ
 = 
NULL
;

2051 ià(
	`ngx_hash_š™
(&
hash
, (*
keys
)->
–ts
, (*keys)->
ÃÉs
è!ð
NGX_OK
) {

2052  
NGX_CONF_ERROR
;

2055  
NGX_CONF_OK
;

2058 ià(
´ev_ty³s_hash
->
buck‘s
 =ð
NULL
) {

2060 ià(*
´ev_keys
 =ð
NULL
) {

2062 ià(
	`ngx_h‰p_£t_deçuÉ_ty³s
(
cf
, 
´ev_keys
, 
deçuÉ_ty³s
)

2063 !ð
NGX_OK
)

2065  
NGX_CONF_ERROR
;

2068 } ià(*
´ev_keys
 == (*) -1) {

2069 *
keys
 = *
´ev_keys
;

2070  
NGX_CONF_OK
;

2073 
hash
.hash = 
´ev_ty³s_hash
;

2074 
hash
.
key
 = 
NULL
;

2075 
hash
.
max_size
 = 2048;

2076 
hash
.
buck‘_size
 = 64;

2077 
hash
.
Çme
 = "test_types_hash";

2078 
hash
.
poÞ
 = 
cf
->pool;

2079 
hash
.
‹mp_poÞ
 = 
NULL
;

2081 ià(
	`ngx_hash_š™
(&
hash
, (*
´ev_keys
)->
–ts
, (*´ev_keys)->
ÃÉs
)

2082 !ð
NGX_OK
)

2084  
NGX_CONF_ERROR
;

2088 *
ty³s_hash
 = *
´ev_ty³s_hash
;

2090  
NGX_CONF_OK
;

2092 
	}
}

2095 
ngx_št_t


2096 
	$ngx_h‰p_£t_deçuÉ_ty³s
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 **
ty³s
,

2097 
ngx_¡r_t
 *
deçuÉ_ty³
)

2099 
ngx_hash_key_t
 *
ty³
;

2101 *
ty³s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
‹mp_poÞ
, 1, (
ngx_hash_key_t
));

2102 ià(*
ty³s
 =ð
NULL
) {

2103  
NGX_ERROR
;

2106 
deçuÉ_ty³
->
Ën
) {

2108 
ty³
 = 
	`ngx_¬¿y_push
(*
ty³s
);

2109 ià(
ty³
 =ð
NULL
) {

2110  
NGX_ERROR
;

2113 
ty³
->
key
 = *
deçuÉ_ty³
;

2114 
ty³
->
key_hash
 = 
	`ngx_hash_key
(
deçuÉ_ty³
->
d©a
,

2115 
deçuÉ_ty³
->
Ën
);

2116 
ty³
->
v®ue
 = (*) 4;

2118 
deçuÉ_ty³
++;

2121  
NGX_OK
;

2122 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_busy_lock.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_h‰p_busy_lock_look_ÿch—bË
(
ngx_h‰p_busy_lock_t
 *
bl
,

15 
ngx_h‰p_busy_lock_ùx_t
 *
bc
,

16 
lock
);

19 
	$ngx_h‰p_busy_lock
(
ngx_h‰p_busy_lock_t
 *
bl
, 
ngx_h‰p_busy_lock_ùx_t
 *
bc
)

21 ià(
bl
->
busy
 < bl->
max_busy
) {

22 
bl
->
busy
++;

24 ià(
bc
->
time
) {

25 
bc
->
time
 = 0;

26 
bl
->
wa™šg
--;

29  
NGX_OK
;

32 ià(
bc
->
time
) {

33 ià(
bc
->
time
 < 
bl
->
timeout
) {

34 
	`ngx_add_tim”
(
bc
->
ev’t
, 1000);

35  
NGX_AGAIN
;

38 
bl
->
wa™šg
--;

39  
NGX_DONE
;

43 ià(
bl
->
timeout
 == 0) {

44  
NGX_DONE
;

47 ià(
bl
->
wa™šg
 < bl->
max_wa™šg
) {

48 
bl
->
wa™šg
++;

51 
	`ngx_add_tim”
(
bc
->
ev’t
, 1000);

52 
bc
->
ev’t
->
ev’t_hªdËr
 = bc->event_handler;

57  
NGX_AGAIN
;

60  
NGX_ERROR
;

61 
	}
}

64 
	$ngx_h‰p_busy_lock_ÿch—bË
(
ngx_h‰p_busy_lock_t
 *
bl
,

65 
ngx_h‰p_busy_lock_ùx_t
 *
bc
, 
lock
)

67 
rc
;

69 
rc
 = 
	`ngx_h‰p_busy_lock_look_ÿch—bË
(
bl
, 
bc
, 
lock
);

71 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
bc
->
ev’t
->
log
, 0,

73 
rc
, 
bl
->
wa™šg
, bl->
max_wa™šg
);

75 ià(
rc
 =ð
NGX_OK
) {

76  
NGX_OK
;

79 ià(
rc
 =ð
NGX_ERROR
 && !
lock
) {

80  
NGX_OK
;

85 ià(
bc
->
time
) {

86 ià(
bc
->
time
 < 
bl
->
timeout
) {

87 
	`ngx_add_tim”
(
bc
->
ev’t
, 1000);

88  
NGX_AGAIN
;

91 
bl
->
wa™šg
--;

92  
NGX_DONE
;

96 ià(
bl
->
timeout
 == 0) {

97  
NGX_DONE
;

100 ià(
bl
->
wa™šg
 < bl->
max_wa™šg
) {

102 
bl
->
wa™šg
++;

103 
	`ngx_add_tim”
(
bc
->
ev’t
, 1000);

104 
bc
->
ev’t
->
ev’t_hªdËr
 = bc->event_handler;

109  
NGX_AGAIN
;

112  
NGX_ERROR
;

113 
	}
}

116 
	$ngx_h‰p_busy_uÆock
(
ngx_h‰p_busy_lock_t
 *
bl
,

117 
ngx_h‰p_busy_lock_ùx_t
 *
bc
)

119 ià(
bl
 =ð
NULL
) {

123 ià(
bl
->
md5
) {

124 
bl
->
md5_mask
[
bc
->
¦Ù
 / 8] &= ~(1 << (bc->slot & 7));

125 
bl
->
ÿch—bË
--;

128 
bl
->
busy
--;

129 
	}
}

132 
	$ngx_h‰p_busy_lock_look_ÿch—bË
(
ngx_h‰p_busy_lock_t
 *
bl
,

133 
ngx_h‰p_busy_lock_ùx_t
 *
bc
,

134 
lock
)

136 
i
, 
b
, 
ÿch—bË
, 
ä“
;

137 
u_št
 
mask
;

139 
b
 = 0;

140 
ÿch—bË
 = 0;

141 
ä“
 = -1;

143 #ià(
NGX_SUPPRESS_WARN
)

144 
mask
 = 0;

147 
i
 = 0; i < 
bl
->
max_busy
; i++) {

149 ià((
b
 & 7) == 0) {

150 
mask
 = 
bl
->
md5_mask
[
i
 / 8];

153 ià(
mask
 & 1) {

154 ià(
	`ngx_memcmp
(&
bl
->
md5
[
i
 * 16], 
bc
->md5, 16) == 0) {

155  
NGX_AGAIN
;

157 
ÿch—bË
++;

159 } ià(
ä“
 == -1) {

160 
ä“
 = 
i
;

164 ià(
ÿch—bË
 =ð
bl
->cacheable) {

165 ià(
ä“
 =ð-1 && 
ÿch—bË
 < 
bl
->
max_busy
) {

166 
ä“
 = 
i
 + 1;

173 
mask
 >>= 1;

174 
b
++;

177 ià(
ä“
 == -1) {

178  
NGX_ERROR
;

181 ià(
lock
) {

182 ià(
bl
->
busy
 =ðbl->
max_busy
) {

183  
NGX_ERROR
;

186 
	`ngx_memýy
(&
bl
->
md5
[
ä“
 * 16], 
bc
->md5, 16);

187 
bl
->
md5_mask
[
ä“
 / 8] |= 1 << (free & 7);

188 
bc
->
¦Ù
 = 
ä“
;

190 
bl
->
ÿch—bË
++;

191 
bl
->
busy
++;

194  
NGX_OK
;

195 
	}
}

198 *
	$ngx_h‰p_£t_busy_lock_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

199 *
cÚf
)

201 *
p
 = 
cÚf
;

203 
ngx_ušt_t
 
i
, 
dup
, 
šv®id
;

204 
ngx_¡r_t
 *
v®ue
, 
lše
;

205 
ngx_h‰p_busy_lock_t
 *
bl
, **
bÍ
;

207 
bÍ
 = (
ngx_h‰p_busy_lock_t
 **è(
p
 + 
cmd
->
off£t
);

208 ià(*
bÍ
) {

213 
bl
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_busy_lock_t
));

214 ià(
bl
 =ð
NULL
) {

215  
NGX_CONF_ERROR
;

217 *
bÍ
 = 
bl
;

220 
bl
->
mu‹x
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_ev’t_mu‹x_t
));

221 ià(
bl
->
mu‹x
 =ð
NULL
) {

222  
NGX_CONF_ERROR
;

225 
dup
 = 0;

226 
šv®id
 = 0;

227 
v®ue
 = 
cf
->
¬gs
->
–ts
;

229 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

231 ià(
v®ue
[
i
].
d©a
[1] != '=') {

232 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

233 "šv®id v®u\"%s\"", 
v®ue
[
i
].
d©a
);

234  
NGX_CONF_ERROR
;

237 
v®ue
[
i
].
d©a
[0]) {

240 ià(
bl
->
max_busy
) {

241 
dup
 = 1;

245 
bl
->
max_busy
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + 2, v®ue[i].
Ën
 - 2);

246 ià(
bl
->
max_busy
 =ð
NGX_ERROR
) {

247 
šv®id
 = 1;

254 ià(
bl
->
max_wa™šg
) {

255 
dup
 = 1;

259 
bl
->
max_wa™šg
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + 2, v®ue[i].
Ën
 - 2);

260 ià(
bl
->
max_wa™šg
 =ð
NGX_ERROR
) {

261 
šv®id
 = 1;

268 ià(
bl
->
timeout
) {

269 
dup
 = 1;

273 
lše
.
Ën
 = 
v®ue
[
i
].len - 2;

274 
lše
.
d©a
 = 
v®ue
[
i
].data + 2;

276 
bl
->
timeout
 = 
	`ngx_·r£_time
(&
lše
, 1);

277 ià(
bl
->
timeout
 =ð(
time_t
è
NGX_ERROR
) {

278 
šv®id
 = 1;

285 
šv®id
 = 1;

288 ià(
dup
) {

289 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

290 "du¶iÿ‹ v®u\"%s\"", 
v®ue
[
i
].
d©a
);

291  
NGX_CONF_ERROR
;

294 ià(
šv®id
) {

295 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

296 "šv®id v®u\"%s\"", 
v®ue
[
i
].
d©a
);

297  
NGX_CONF_ERROR
;

301 ià(
bl
->
timeout
 =ð0 && bl->
max_wa™šg
) {

302 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

306  
NGX_CONF_OK
;

307 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_copy_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
ngx_bufs_t
 
	mbufs
;

15 } 
	tngx_h‰p_cÝy_fž‹r_cÚf_t
;

18 #ià(
NGX_HAVE_FILE_AIO
)

19 
ngx_h‰p_cÝy_aio_hªdËr
(
ngx_ouut_chaš_ùx_t
 *
ùx
,

20 
ngx_fže_t
 *
fže
);

21 
ngx_h‰p_cÝy_aio_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
);

22 #ià(
NGX_HAVE_AIO_SENDFILE
)

23 
ngx_h‰p_cÝy_aio_£ndfže_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
);

27 *
ngx_h‰p_cÝy_fž‹r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

28 *
ngx_h‰p_cÝy_fž‹r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
,

29 *
·»Á
, *
chžd
);

30 
ngx_št_t
 
ngx_h‰p_cÝy_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

33 
ngx_commªd_t
 
	gngx_h‰p_cÝy_fž‹r_commªds
[] = {

35 { 
ngx_¡ršg
("output_buffers"),

36 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE2
,

37 
ngx_cÚf_£t_bufs_¦Ù
,

38 
NGX_HTTP_LOC_CONF_OFFSET
,

39 
off£tof
(
ngx_h‰p_cÝy_fž‹r_cÚf_t
, 
bufs
),

40 
NULL
 },

42 
ngx_nuÎ_commªd


46 
ngx_h‰p_moduË_t
 
	gngx_h‰p_cÝy_fž‹r_moduË_ùx
 = {

47 
NULL
,

48 
ngx_h‰p_cÝy_fž‹r_š™
,

50 
NULL
,

51 
NULL
,

53 
NULL
,

54 
NULL
,

56 
ngx_h‰p_cÝy_fž‹r_ü—‹_cÚf
,

57 
ngx_h‰p_cÝy_fž‹r_m”ge_cÚf


61 
ngx_moduË_t
 
	gngx_h‰p_cÝy_fž‹r_moduË
 = {

62 
NGX_MODULE_V1
,

63 &
ngx_h‰p_cÝy_fž‹r_moduË_ùx
,

64 
ngx_h‰p_cÝy_fž‹r_commªds
,

65 
NGX_HTTP_MODULE
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
NULL
,

71 
NULL
,

72 
NULL
,

73 
NGX_MODULE_V1_PADDING


77 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

80 
ngx_št_t


81 
	$ngx_h‰p_cÝy_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

83 
ngx_št_t
 
rc
;

84 
ngx_cÚÃùiÚ_t
 *
c
;

85 
ngx_ouut_chaš_ùx_t
 *
ùx
;

86 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

87 
ngx_h‰p_cÝy_fž‹r_cÚf_t
 *
cÚf
;

89 
c
 = 
r
->
cÚÃùiÚ
;

91 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

92 "h‰°cÝy fž‹r: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

94 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_cÝy_fž‹r_moduË
);

96 ià(
ùx
 =ð
NULL
) {

97 
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_ouut_chaš_ùx_t
));

98 ià(
ùx
 =ð
NULL
) {

99  
NGX_ERROR
;

102 
	`ngx_h‰p_£t_ùx
(
r
, 
ùx
, 
ngx_h‰p_cÝy_fž‹r_moduË
);

104 
cÚf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÝy_fž‹r_moduË
);

105 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

107 
ùx
->
£ndfže
 = 
c
->sendfile;

108 
ùx
->
Ãed_š_memÜy
 = 
r
->
maš_fž‹r_Ãed_š_memÜy


109 || 
r
->
fž‹r_Ãed_š_memÜy
;

110 
ùx
->
Ãed_š_‹mp
 = 
r
->
fž‹r_Ãed_‹mpÜ¬y
;

112 
ùx
->
®ignm’t
 = 
þcf
->
dœeùio_®ignm’t
;

114 
ùx
->
poÞ
 = 
r
->pool;

115 
ùx
->
bufs
 = 
cÚf
->bufs;

116 
ùx
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_cÝy_fž‹r_moduË
;

118 
ùx
->
ouut_fž‹r
 = (
ngx_ouut_chaš_fž‹r_±
)

119 
ngx_h‰p_Ãxt_body_fž‹r
;

120 
ùx
->
fž‹r_ùx
 = 
r
;

122 #ià(
NGX_HAVE_FILE_AIO
)

123 ià(
ngx_fže_aio
) {

124 ià(
þcf
->
aio
) {

125 
ùx
->
aio_hªdËr
 = 
ngx_h‰p_cÝy_aio_hªdËr
;

127 #ià(
NGX_HAVE_AIO_SENDFILE
)

128 
c
->
aio_£ndfže
 = (
þcf
->
aio
 =ð
NGX_HTTP_AIO_SENDFILE
);

133 ià(
š
 && in->
buf
 && 
	`ngx_buf_size
(in->buf)) {

134 
r
->
»que¡_ouut
 = 1;

138 #ià(
NGX_HAVE_FILE_AIO
)

139 
ùx
->
aio
 = 
r
->aio;

143 
rc
 = 
	`ngx_ouut_chaš
(
ùx
, 
š
);

145 ià(
ùx
->
š
 =ð
NULL
) {

146 
r
->
bufã»d
 &ð~
NGX_HTTP_COPY_BUFFERED
;

149 
r
->
bufã»d
 |ð
NGX_HTTP_COPY_BUFFERED
;

152 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

153 "h‰°cÝy fž‹r: %˜\"%V?%V\"", 
rc
, &
r
->
uri
, &r->
¬gs
);

155 #ià(
NGX_HAVE_FILE_AIO
 && 
NGX_HAVE_AIO_SENDFILE
)

157 ià(
c
->
busy_£ndfže
) {

158 
ssize_t
 
n
;

159 
off_t
 
off£t
;

160 
ngx_fže_t
 *
fže
;

161 
ngx_h‰p_•hem”®_t
 *
e
;

163 ià(
r
->
aio
) {

164 
c
->
busy_£ndfže
 = 
NULL
;

165  
rc
;

168 
fže
 = 
c
->
busy_£ndfže
->file;

169 
off£t
 = 
c
->
busy_£ndfže
->
fže_pos
;

171 ià(
fže
->
aio
) {

172 
c
->
busy_couÁ
 = (
off£t
 =ð
fže
->
aio
->
Ï¡_off£t
) ?

173 
c
->
busy_couÁ
 + 1 : 0;

174 
fže
->
aio
->
Ï¡_off£t
 = 
off£t
;

176 ià(
c
->
busy_couÁ
 > 2) {

177 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

179 &
fže
->
Çme
);

180 
c
->
aio_£ndfže
 = 0;

184 
c
->
busy_£ndfže
 = 
NULL
;

185 
e
 = (
ngx_h‰p_•hem”®_t
 *è&
r
->
uri_¡¬t
;

187 
n
 = 
	`ngx_fže_aio_»ad
(
fže
, &
e
->
aio_´–ßd
, 1, 
off£t
, 
r
->
poÞ
);

189 ià(
n
 > 0) {

190 
š
 = 
NULL
;

194 
rc
 = 
n
;

196 ià(
rc
 =ð
NGX_AGAIN
) {

197 
fže
->
aio
->
d©a
 = 
r
;

198 
fže
->
aio
->
hªdËr
 = 
ngx_h‰p_cÝy_aio_£ndfže_ev’t_hªdËr
;

200 
r
->
maš
->
blocked
++;

201 
r
->
aio
 = 1;

206  
rc
;

208 
	}
}

211 #ià(
NGX_HAVE_FILE_AIO
)

214 
	$ngx_h‰p_cÝy_aio_hªdËr
(
ngx_ouut_chaš_ùx_t
 *
ùx
, 
ngx_fže_t
 *
fže
)

216 
ngx_h‰p_»que¡_t
 *
r
;

218 
r
 = 
ùx
->
fž‹r_ùx
;

220 
fže
->
aio
->
d©a
 = 
r
;

221 
fže
->
aio
->
hªdËr
 = 
ngx_h‰p_cÝy_aio_ev’t_hªdËr
;

223 
r
->
maš
->
blocked
++;

224 
r
->
aio
 = 1;

225 
ùx
->
aio
 = 1;

226 
	}
}

230 
	$ngx_h‰p_cÝy_aio_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
)

232 
ngx_ev’t_aio_t
 *
aio
;

233 
ngx_h‰p_»que¡_t
 *
r
;

235 
aio
 = 
ev
->
d©a
;

236 
r
 = 
aio
->
d©a
;

238 
r
->
maš
->
blocked
--;

239 
r
->
aio
 = 0;

241 
r
->
cÚÃùiÚ
->
wr™e
->
	`hªdËr
(r->connection->write);

242 
	}
}

245 #ià(
NGX_HAVE_AIO_SENDFILE
)

248 
	$ngx_h‰p_cÝy_aio_£ndfže_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
)

250 
ngx_ev’t_aio_t
 *
aio
;

251 
ngx_h‰p_»que¡_t
 *
r
;

253 
aio
 = 
ev
->
d©a
;

254 
r
 = 
aio
->
d©a
;

256 
r
->
maš
->
blocked
--;

257 
r
->
aio
 = 0;

258 
ev
->
com¶‘e
 = 0;

260 
r
->
cÚÃùiÚ
->
wr™e
->
	`hªdËr
(r->connection->write);

261 
	}
}

268 
	$ngx_h‰p_cÝy_fž‹r_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

270 
ngx_h‰p_cÝy_fž‹r_cÚf_t
 *
cÚf
;

272 
cÚf
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_cÝy_fž‹r_cÚf_t
));

273 ià(
cÚf
 =ð
NULL
) {

274  
NULL
;

277 
cÚf
->
bufs
.
num
 = 0;

279  
cÚf
;

280 
	}
}

284 
	$ngx_h‰p_cÝy_fž‹r_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

286 
ngx_h‰p_cÝy_fž‹r_cÚf_t
 *
´ev
 = 
·»Á
;

287 
ngx_h‰p_cÝy_fž‹r_cÚf_t
 *
cÚf
 = 
chžd
;

289 
	`ngx_cÚf_m”ge_bufs_v®ue
(
cÚf
->
bufs
, 
´ev
->bufs, 1, 32768);

291  
NULL
;

292 
	}
}

295 
ngx_št_t


296 
	$ngx_h‰p_cÝy_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

298 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

299 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_cÝy_fž‹r
;

301  
NGX_OK
;

302 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_core_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

14 
u_ch¬
 *
	mÇme
;

15 
ušt32_t
 
	mm‘hod
;

16 } 
	tngx_h‰p_m‘hod_Çme_t
;

19 
	#NGX_HTTP_REQUEST_BODY_FILE_OFF
 0

	)

20 
	#NGX_HTTP_REQUEST_BODY_FILE_ON
 1

	)

21 
	#NGX_HTTP_REQUEST_BODY_FILE_CLEAN
 2

	)

24 
ngx_št_t
 
ngx_h‰p_cÜe_fšd_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
);

25 
ngx_št_t
 
ngx_h‰p_cÜe_fšd_¡©ic_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

26 
ngx_h‰p_loÿtiÚ_Œ“_node_t
 *
node
);

28 
ngx_št_t
 
ngx_h‰p_cÜe_´ecÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
);

29 *
ngx_h‰p_cÜe_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

30 *
ngx_h‰p_cÜe_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
);

31 *
ngx_h‰p_cÜe_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

32 *
ngx_h‰p_cÜe_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
,

33 *
·»Á
, *
chžd
);

34 *
ngx_h‰p_cÜe_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

35 *
ngx_h‰p_cÜe_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
,

36 *
·»Á
, *
chžd
);

38 *
ngx_h‰p_cÜe_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

39 *
dummy
);

40 *
ngx_h‰p_cÜe_loÿtiÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

41 *
dummy
);

42 
ngx_št_t
 
ngx_h‰p_cÜe_»gex_loÿtiÚ
(
ngx_cÚf_t
 *
cf
,

43 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, 
ngx_¡r_t
 *
»gex
, 
ngx_ušt_t
 
ÿ£Ëss
);

45 *
ngx_h‰p_cÜe_ty³s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

46 *
cÚf
);

47 *
ngx_h‰p_cÜe_ty³
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
,

48 *
cÚf
);

50 *
ngx_h‰p_cÜe_li¡’
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

51 *
cÚf
);

52 *
ngx_h‰p_cÜe_£rv”_Çme
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

53 *
cÚf
);

54 *
ngx_h‰p_cÜe_roÙ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

55 *
ngx_h‰p_cÜe_lim™_exû±
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

56 *
cÚf
);

57 *
ngx_h‰p_cÜe_dœeùio
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

58 *
cÚf
);

59 *
ngx_h‰p_cÜe_”rÜ_·ge
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

60 *
cÚf
);

61 *
ngx_h‰p_cÜe_Œy_fžes
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

62 *
cÚf
);

63 *
ngx_h‰p_cÜe_Ý’_fže_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

64 *
cÚf
);

65 *
ngx_h‰p_cÜe_”rÜ_log
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

66 *
cÚf
);

67 *
ngx_h‰p_cÜe_k“·live
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

68 *
cÚf
);

69 *
ngx_h‰p_cÜe_š‹º®
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

70 *
cÚf
);

71 *
ngx_h‰p_cÜe_»sÞv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

72 *
cÚf
);

73 #ià(
NGX_HTTP_GZIP
)

74 
ngx_št_t
 
ngx_h‰p_gz_acû±_’codšg
(
ngx_¡r_t
 *
«
);

75 
ngx_ušt_t
 
ngx_h‰p_gz_quªt™y
(
u_ch¬
 *
p
, u_ch¬ *
Ï¡
);

76 *
ngx_h‰p_gz_di§bË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

77 *
cÚf
);

79 
ngx_št_t
 
ngx_h‰p_g‘_fÜw¬ded_addr_š‹º®
(
ngx_h‰p_»que¡_t
 *
r
,

80 
ngx_addr_t
 *
addr
, 
u_ch¬
 *
xff
, 
size_t
 
xfæ’
, 
ngx_¬¿y_t
 *
´ox›s
,

81 
»cursive
);

82 #ià(
NGX_HAVE_OPENAT
)

83 *
ngx_h‰p_di§bË_symlšks
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

84 *
cÚf
);

87 *
ngx_h‰p_cÜe_low©_check
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

88 *
ngx_h‰p_cÜe_poÞ_size
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

90 
ngx_cÚf_po¡_t
 
	gngx_h‰p_cÜe_low©_po¡
 =

91 { 
ngx_h‰p_cÜe_low©_check
 };

93 
ngx_cÚf_po¡_hªdËr_±
 
	gngx_h‰p_cÜe_poÞ_size_p
 =

94 
ngx_h‰p_cÜe_poÞ_size
;

96 
ngx_cÚf_d•»ÿ‹d_t
 
	gngx_cÚf_d•»ÿ‹d_Ýtimize_£rv”_Çmes
 = {

97 
ngx_cÚf_d•»ÿ‹d
, "optimize_server_names", "server_name_in_redirect"

100 
ngx_cÚf_d•»ÿ‹d_t
 
	gngx_cÚf_d•»ÿ‹d_Ý’_fže_ÿche_»‹¡
 = {

101 
ngx_cÚf_d•»ÿ‹d
, "open_file_cache_retest", "open_file_cache_valid"

104 
ngx_cÚf_d•»ÿ‹d_t
 
	gngx_cÚf_d•»ÿ‹d_§tisfy_ªy
 = {

105 
ngx_cÚf_d•»ÿ‹d
, "satisfy_any", "satisfy"

109 
ngx_cÚf_’um_t
 
	gngx_h‰p_cÜe_»que¡_body_š_fže
[] = {

110 { 
ngx_¡ršg
("off"), 
NGX_HTTP_REQUEST_BODY_FILE_OFF
 },

111 { 
ngx_¡ršg
("Ú"), 
NGX_HTTP_REQUEST_BODY_FILE_ON
 },

112 { 
ngx_¡ršg
("þ—n"), 
NGX_HTTP_REQUEST_BODY_FILE_CLEAN
 },

113 { 
ngx_nuÎ_¡ršg
, 0 }

117 #ià(
NGX_HAVE_FILE_AIO
)

119 
ngx_cÚf_’um_t
 
	gngx_h‰p_cÜe_aio
[] = {

120 { 
ngx_¡ršg
("off"), 
NGX_HTTP_AIO_OFF
 },

121 { 
ngx_¡ršg
("Ú"), 
NGX_HTTP_AIO_ON
 },

122 #ià(
NGX_HAVE_AIO_SENDFILE
)

123 { 
ngx_¡ršg
("£ndfže"), 
NGX_HTTP_AIO_SENDFILE
 },

125 { 
ngx_nuÎ_¡ršg
, 0 }

131 
ngx_cÚf_’um_t
 
	gngx_h‰p_cÜe_§tisfy
[] = {

132 { 
ngx_¡ršg
("®l"), 
NGX_HTTP_SATISFY_ALL
 },

133 { 
ngx_¡ršg
("ªy"), 
NGX_HTTP_SATISFY_ANY
 },

134 { 
ngx_nuÎ_¡ršg
, 0 }

138 
ngx_cÚf_’um_t
 
	gngx_h‰p_cÜe_lšg”šg_þo£
[] = {

139 { 
ngx_¡ršg
("off"), 
NGX_HTTP_LINGERING_OFF
 },

140 { 
ngx_¡ršg
("Ú"), 
NGX_HTTP_LINGERING_ON
 },

141 { 
ngx_¡ršg
("®ways"), 
NGX_HTTP_LINGERING_ALWAYS
 },

142 { 
ngx_nuÎ_¡ršg
, 0 }

146 
ngx_cÚf_’um_t
 
	gngx_h‰p_cÜe_if_modif›d_sšû
[] = {

147 { 
ngx_¡ršg
("off"), 
NGX_HTTP_IMS_OFF
 },

148 { 
ngx_¡ršg
("exaù"), 
NGX_HTTP_IMS_EXACT
 },

149 { 
ngx_¡ršg
("befÜe"), 
NGX_HTTP_IMS_BEFORE
 },

150 { 
ngx_nuÎ_¡ršg
, 0 }

154 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_cÜe_k“·live_di§bË
[] = {

155 { 
ngx_¡ršg
("nÚe"), 
NGX_HTTP_KEEPALIVE_DISABLE_NONE
 },

156 { 
ngx_¡ršg
("ms›6"), 
NGX_HTTP_KEEPALIVE_DISABLE_MSIE6
 },

157 { 
ngx_¡ršg
("§çri"), 
NGX_HTTP_KEEPALIVE_DISABLE_SAFARI
 },

158 { 
ngx_nuÎ_¡ršg
, 0 }

162 
ngx_·th_š™_t
 
	gngx_h‰p_þ›Á_‹mp_·th
 = {

163 
ngx_¡ršg
(
NGX_HTTP_CLIENT_TEMP_PATH
), { 0, 0, 0 }

167 #ià(
NGX_HTTP_GZIP
)

169 
ngx_cÚf_’um_t
 
	gngx_h‰p_gz_h‰p_v”siÚ
[] = {

170 { 
ngx_¡ršg
("1.0"), 
NGX_HTTP_VERSION_10
 },

171 { 
ngx_¡ršg
("1.1"), 
NGX_HTTP_VERSION_11
 },

172 { 
ngx_nuÎ_¡ršg
, 0 }

176 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_gz_´ox›d_mask
[] = {

177 { 
ngx_¡ršg
("off"), 
NGX_HTTP_GZIP_PROXIED_OFF
 },

178 { 
ngx_¡ršg
("expœed"), 
NGX_HTTP_GZIP_PROXIED_EXPIRED
 },

179 { 
ngx_¡ršg
("no-ÿche"), 
NGX_HTTP_GZIP_PROXIED_NO_CACHE
 },

180 { 
ngx_¡ršg
("no-¡Üe"), 
NGX_HTTP_GZIP_PROXIED_NO_STORE
 },

181 { 
ngx_¡ršg
("´iv©e"), 
NGX_HTTP_GZIP_PROXIED_PRIVATE
 },

182 { 
ngx_¡ršg
("no_Ï¡_modif›d"), 
NGX_HTTP_GZIP_PROXIED_NO_LM
 },

183 { 
ngx_¡ršg
("no_‘ag"), 
NGX_HTTP_GZIP_PROXIED_NO_ETAG
 },

184 { 
ngx_¡ršg
("auth"), 
NGX_HTTP_GZIP_PROXIED_AUTH
 },

185 { 
ngx_¡ršg
("ªy"), 
NGX_HTTP_GZIP_PROXIED_ANY
 },

186 { 
ngx_nuÎ_¡ršg
, 0 }

190 
ngx_¡r_t
 
	gngx_h‰p_gz_no_ÿche
 = 
ngx_¡ršg
("no-cache");

191 
ngx_¡r_t
 
	gngx_h‰p_gz_no_¡Üe
 = 
ngx_¡ršg
("no-store");

192 
ngx_¡r_t
 
	gngx_h‰p_gz_´iv©e
 = 
ngx_¡ršg
("private");

197 
ngx_commªd_t
 
	gngx_h‰p_cÜe_commªds
[] = {

199 { 
ngx_¡ršg
("variables_hash_max_size"),

200 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

201 
ngx_cÚf_£t_num_¦Ù
,

202 
NGX_HTTP_MAIN_CONF_OFFSET
,

203 
off£tof
(
ngx_h‰p_cÜe_maš_cÚf_t
, 
v¬ŸbËs_hash_max_size
),

204 
NULL
 },

206 { 
ngx_¡ršg
("variables_hash_bucket_size"),

207 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

208 
ngx_cÚf_£t_num_¦Ù
,

209 
NGX_HTTP_MAIN_CONF_OFFSET
,

210 
off£tof
(
ngx_h‰p_cÜe_maš_cÚf_t
, 
v¬ŸbËs_hash_buck‘_size
),

211 
NULL
 },

213 { 
ngx_¡ršg
("server_names_hash_max_size"),

214 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

215 
ngx_cÚf_£t_num_¦Ù
,

216 
NGX_HTTP_MAIN_CONF_OFFSET
,

217 
off£tof
(
ngx_h‰p_cÜe_maš_cÚf_t
, 
£rv”_Çmes_hash_max_size
),

218 
NULL
 },

220 { 
ngx_¡ršg
("server_names_hash_bucket_size"),

221 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

222 
ngx_cÚf_£t_num_¦Ù
,

223 
NGX_HTTP_MAIN_CONF_OFFSET
,

224 
off£tof
(
ngx_h‰p_cÜe_maš_cÚf_t
, 
£rv”_Çmes_hash_buck‘_size
),

225 
NULL
 },

227 { 
ngx_¡ršg
("server"),

228 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

229 
ngx_h‰p_cÜe_£rv”
,

232 
NULL
 },

234 { 
ngx_¡ršg
("connection_pool_size"),

235 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

236 
ngx_cÚf_£t_size_¦Ù
,

237 
NGX_HTTP_SRV_CONF_OFFSET
,

238 
off£tof
(
ngx_h‰p_cÜe_¤v_cÚf_t
, 
cÚÃùiÚ_poÞ_size
),

239 &
ngx_h‰p_cÜe_poÞ_size_p
 },

241 { 
ngx_¡ršg
("request_pool_size"),

242 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

243 
ngx_cÚf_£t_size_¦Ù
,

244 
NGX_HTTP_SRV_CONF_OFFSET
,

245 
off£tof
(
ngx_h‰p_cÜe_¤v_cÚf_t
, 
»que¡_poÞ_size
),

246 &
ngx_h‰p_cÜe_poÞ_size_p
 },

248 { 
ngx_¡ršg
("client_header_timeout"),

249 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

250 
ngx_cÚf_£t_m£c_¦Ù
,

251 
NGX_HTTP_SRV_CONF_OFFSET
,

252 
off£tof
(
ngx_h‰p_cÜe_¤v_cÚf_t
, 
þ›Á_h—d”_timeout
),

253 
NULL
 },

255 { 
ngx_¡ršg
("client_header_buffer_size"),

256 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

257 
ngx_cÚf_£t_size_¦Ù
,

258 
NGX_HTTP_SRV_CONF_OFFSET
,

259 
off£tof
(
ngx_h‰p_cÜe_¤v_cÚf_t
, 
þ›Á_h—d”_bufãr_size
),

260 
NULL
 },

262 { 
ngx_¡ršg
("large_client_header_buffers"),

263 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE2
,

264 
ngx_cÚf_£t_bufs_¦Ù
,

265 
NGX_HTTP_SRV_CONF_OFFSET
,

266 
off£tof
(
ngx_h‰p_cÜe_¤v_cÚf_t
, 
Ïrge_þ›Á_h—d”_bufãrs
),

267 
NULL
 },

269 { 
ngx_¡ršg
("optimize_server_names"),

270 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

271 
ngx_cÚf_£t_æag_¦Ù
,

272 
NGX_HTTP_LOC_CONF_OFFSET
,

273 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
£rv”_Çme_š_»dœeù
),

274 &
ngx_cÚf_d•»ÿ‹d_Ýtimize_£rv”_Çmes
 },

276 { 
ngx_¡ršg
("ignore_invalid_headers"),

277 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

278 
ngx_cÚf_£t_æag_¦Ù
,

279 
NGX_HTTP_SRV_CONF_OFFSET
,

280 
off£tof
(
ngx_h‰p_cÜe_¤v_cÚf_t
, 
ignÜe_šv®id_h—d”s
),

281 
NULL
 },

283 { 
ngx_¡ršg
("merge_slashes"),

284 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

285 
ngx_cÚf_£t_æag_¦Ù
,

286 
NGX_HTTP_SRV_CONF_OFFSET
,

287 
off£tof
(
ngx_h‰p_cÜe_¤v_cÚf_t
, 
m”ge_¦ashes
),

288 
NULL
 },

290 { 
ngx_¡ršg
("underscores_in_headers"),

291 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_FLAG
,

292 
ngx_cÚf_£t_æag_¦Ù
,

293 
NGX_HTTP_SRV_CONF_OFFSET
,

294 
off£tof
(
ngx_h‰p_cÜe_¤v_cÚf_t
, 
und”scÜes_š_h—d”s
),

295 
NULL
 },

297 { 
ngx_¡ršg
("location"),

298 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_TAKE12
,

299 
ngx_h‰p_cÜe_loÿtiÚ
,

300 
NGX_HTTP_SRV_CONF_OFFSET
,

302 
NULL
 },

304 { 
ngx_¡ršg
("listen"),

305 
NGX_HTTP_SRV_CONF
|
NGX_CONF_1MORE
,

306 
ngx_h‰p_cÜe_li¡’
,

307 
NGX_HTTP_SRV_CONF_OFFSET
,

309 
NULL
 },

311 { 
ngx_¡ršg
("server_name"),

312 
NGX_HTTP_SRV_CONF
|
NGX_CONF_1MORE
,

313 
ngx_h‰p_cÜe_£rv”_Çme
,

314 
NGX_HTTP_SRV_CONF_OFFSET
,

316 
NULL
 },

318 { 
ngx_¡ršg
("types_hash_max_size"),

319 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

320 
ngx_cÚf_£t_num_¦Ù
,

321 
NGX_HTTP_LOC_CONF_OFFSET
,

322 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
ty³s_hash_max_size
),

323 
NULL
 },

325 { 
ngx_¡ršg
("types_hash_bucket_size"),

326 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

327 
ngx_cÚf_£t_num_¦Ù
,

328 
NGX_HTTP_LOC_CONF_OFFSET
,

329 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
ty³s_hash_buck‘_size
),

330 
NULL
 },

332 { 
ngx_¡ršg
("types"),

333 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF


334 |
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

335 
ngx_h‰p_cÜe_ty³s
,

336 
NGX_HTTP_LOC_CONF_OFFSET
,

338 
NULL
 },

340 { 
ngx_¡ršg
("default_type"),

341 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

342 
ngx_cÚf_£t_¡r_¦Ù
,

343 
NGX_HTTP_LOC_CONF_OFFSET
,

344 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
deçuÉ_ty³
),

345 
NULL
 },

347 { 
ngx_¡ršg
("root"),

348 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


349 |
NGX_CONF_TAKE1
,

350 
ngx_h‰p_cÜe_roÙ
,

351 
NGX_HTTP_LOC_CONF_OFFSET
,

353 
NULL
 },

355 { 
ngx_¡ršg
("alias"),

356 
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

357 
ngx_h‰p_cÜe_roÙ
,

358 
NGX_HTTP_LOC_CONF_OFFSET
,

360 
NULL
 },

362 { 
ngx_¡ršg
("limit_except"),

363 
NGX_HTTP_LOC_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_1MORE
,

364 
ngx_h‰p_cÜe_lim™_exû±
,

365 
NGX_HTTP_LOC_CONF_OFFSET
,

367 
NULL
 },

369 { 
ngx_¡ršg
("client_max_body_size"),

370 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

371 
ngx_cÚf_£t_off_¦Ù
,

372 
NGX_HTTP_LOC_CONF_OFFSET
,

373 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
þ›Á_max_body_size
),

374 
NULL
 },

376 { 
ngx_¡ršg
("client_body_buffer_size"),

377 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

378 
ngx_cÚf_£t_size_¦Ù
,

379 
NGX_HTTP_LOC_CONF_OFFSET
,

380 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
þ›Á_body_bufãr_size
),

381 
NULL
 },

383 { 
ngx_¡ršg
("client_body_timeout"),

384 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

385 
ngx_cÚf_£t_m£c_¦Ù
,

386 
NGX_HTTP_LOC_CONF_OFFSET
,

387 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
þ›Á_body_timeout
),

388 
NULL
 },

390 { 
ngx_¡ršg
("client_body_temp_path"),

391 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1234
,

392 
ngx_cÚf_£t_·th_¦Ù
,

393 
NGX_HTTP_LOC_CONF_OFFSET
,

394 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
þ›Á_body_‹mp_·th
),

395 
NULL
 },

397 { 
ngx_¡ršg
("client_body_in_file_only"),

398 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

399 
ngx_cÚf_£t_’um_¦Ù
,

400 
NGX_HTTP_LOC_CONF_OFFSET
,

401 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
þ›Á_body_š_fže_Úly
),

402 &
ngx_h‰p_cÜe_»que¡_body_š_fže
 },

404 { 
ngx_¡ršg
("client_body_in_single_buffer"),

405 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

406 
ngx_cÚf_£t_æag_¦Ù
,

407 
NGX_HTTP_LOC_CONF_OFFSET
,

408 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
þ›Á_body_š_sšgË_bufãr
),

409 
NULL
 },

411 { 
ngx_¡ršg
("sendfile"),

412 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


413 |
NGX_CONF_FLAG
,

414 
ngx_cÚf_£t_æag_¦Ù
,

415 
NGX_HTTP_LOC_CONF_OFFSET
,

416 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
£ndfže
),

417 
NULL
 },

419 { 
ngx_¡ršg
("sendfile_max_chunk"),

420 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

421 
ngx_cÚf_£t_size_¦Ù
,

422 
NGX_HTTP_LOC_CONF_OFFSET
,

423 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
£ndfže_max_chunk
),

424 
NULL
 },

426 #ià(
NGX_HAVE_FILE_AIO
)

428 { 
ngx_¡ršg
("aio"),

429 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

430 
ngx_cÚf_£t_’um_¦Ù
,

431 
NGX_HTTP_LOC_CONF_OFFSET
,

432 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
aio
),

433 &
ngx_h‰p_cÜe_aio
 },

437 { 
ngx_¡ršg
("read_ahead"),

438 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

439 
ngx_cÚf_£t_size_¦Ù
,

440 
NGX_HTTP_LOC_CONF_OFFSET
,

441 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
»ad_ah—d
),

442 
NULL
 },

444 { 
ngx_¡ršg
("directio"),

445 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

446 
ngx_h‰p_cÜe_dœeùio
,

447 
NGX_HTTP_LOC_CONF_OFFSET
,

449 
NULL
 },

451 { 
ngx_¡ršg
("directio_alignment"),

452 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

453 
ngx_cÚf_£t_off_¦Ù
,

454 
NGX_HTTP_LOC_CONF_OFFSET
,

455 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
dœeùio_®ignm’t
),

456 
NULL
 },

458 { 
ngx_¡ršg
("tcp_nopush"),

459 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

460 
ngx_cÚf_£t_æag_¦Ù
,

461 
NGX_HTTP_LOC_CONF_OFFSET
,

462 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
tý_nÝush
),

463 
NULL
 },

465 { 
ngx_¡ršg
("tcp_nodelay"),

466 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

467 
ngx_cÚf_£t_æag_¦Ù
,

468 
NGX_HTTP_LOC_CONF_OFFSET
,

469 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
tý_nod–ay
),

470 
NULL
 },

472 { 
ngx_¡ršg
("send_timeout"),

473 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

474 
ngx_cÚf_£t_m£c_¦Ù
,

475 
NGX_HTTP_LOC_CONF_OFFSET
,

476 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
£nd_timeout
),

477 
NULL
 },

479 { 
ngx_¡ršg
("send_lowat"),

480 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

481 
ngx_cÚf_£t_size_¦Ù
,

482 
NGX_HTTP_LOC_CONF_OFFSET
,

483 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
£nd_low©
),

484 &
ngx_h‰p_cÜe_low©_po¡
 },

486 { 
ngx_¡ršg
("postpone_output"),

487 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

488 
ngx_cÚf_£t_size_¦Ù
,

489 
NGX_HTTP_LOC_CONF_OFFSET
,

490 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
po¡pÚe_ouut
),

491 
NULL
 },

493 { 
ngx_¡ršg
("limit_rate"),

494 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


495 |
NGX_CONF_TAKE1
,

496 
ngx_cÚf_£t_size_¦Ù
,

497 
NGX_HTTP_LOC_CONF_OFFSET
,

498 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
lim™_¿‹
),

499 
NULL
 },

501 { 
ngx_¡ršg
("limit_rate_after"),

502 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


503 |
NGX_CONF_TAKE1
,

504 
ngx_cÚf_£t_size_¦Ù
,

505 
NGX_HTTP_LOC_CONF_OFFSET
,

506 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
lim™_¿‹_aá”
),

507 
NULL
 },

509 { 
ngx_¡ršg
("keepalive_timeout"),

510 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE12
,

511 
ngx_h‰p_cÜe_k“·live
,

512 
NGX_HTTP_LOC_CONF_OFFSET
,

514 
NULL
 },

516 { 
ngx_¡ršg
("keepalive_requests"),

517 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

518 
ngx_cÚf_£t_num_¦Ù
,

519 
NGX_HTTP_LOC_CONF_OFFSET
,

520 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
k“·live_»que¡s
),

521 
NULL
 },

523 { 
ngx_¡ršg
("keepalive_disable"),

524 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE12
,

525 
ngx_cÚf_£t_b™mask_¦Ù
,

526 
NGX_HTTP_LOC_CONF_OFFSET
,

527 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
k“·live_di§bË
),

528 &
ngx_h‰p_cÜe_k“·live_di§bË
 },

530 { 
ngx_¡ršg
("satisfy"),

531 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

532 
ngx_cÚf_£t_’um_¦Ù
,

533 
NGX_HTTP_LOC_CONF_OFFSET
,

534 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
§tisfy
),

535 &
ngx_h‰p_cÜe_§tisfy
 },

537 { 
ngx_¡ršg
("satisfy_any"),

538 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

539 
ngx_cÚf_£t_æag_¦Ù
,

540 
NGX_HTTP_LOC_CONF_OFFSET
,

541 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
§tisfy
),

542 &
ngx_cÚf_d•»ÿ‹d_§tisfy_ªy
 },

544 { 
ngx_¡ršg
("internal"),

545 
NGX_HTTP_LOC_CONF
|
NGX_CONF_NOARGS
,

546 
ngx_h‰p_cÜe_š‹º®
,

547 
NGX_HTTP_LOC_CONF_OFFSET
,

549 
NULL
 },

551 { 
ngx_¡ršg
("lingering_close"),

552 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

553 
ngx_cÚf_£t_’um_¦Ù
,

554 
NGX_HTTP_LOC_CONF_OFFSET
,

555 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
lšg”šg_þo£
),

556 &
ngx_h‰p_cÜe_lšg”šg_þo£
 },

558 { 
ngx_¡ršg
("lingering_time"),

559 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

560 
ngx_cÚf_£t_m£c_¦Ù
,

561 
NGX_HTTP_LOC_CONF_OFFSET
,

562 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
lšg”šg_time
),

563 
NULL
 },

565 { 
ngx_¡ršg
("lingering_timeout"),

566 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

567 
ngx_cÚf_£t_m£c_¦Ù
,

568 
NGX_HTTP_LOC_CONF_OFFSET
,

569 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
lšg”šg_timeout
),

570 
NULL
 },

572 { 
ngx_¡ršg
("reset_timedout_connection"),

573 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

574 
ngx_cÚf_£t_æag_¦Ù
,

575 
NGX_HTTP_LOC_CONF_OFFSET
,

576 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
»£t_timedout_cÚÃùiÚ
),

577 
NULL
 },

579 { 
ngx_¡ršg
("server_name_in_redirect"),

580 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

581 
ngx_cÚf_£t_æag_¦Ù
,

582 
NGX_HTTP_LOC_CONF_OFFSET
,

583 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
£rv”_Çme_š_»dœeù
),

584 
NULL
 },

586 { 
ngx_¡ršg
("port_in_redirect"),

587 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

588 
ngx_cÚf_£t_æag_¦Ù
,

589 
NGX_HTTP_LOC_CONF_OFFSET
,

590 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
pÜt_š_»dœeù
),

591 
NULL
 },

593 { 
ngx_¡ršg
("msie_padding"),

594 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

595 
ngx_cÚf_£t_æag_¦Ù
,

596 
NGX_HTTP_LOC_CONF_OFFSET
,

597 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
ms›_·ddšg
),

598 
NULL
 },

600 { 
ngx_¡ršg
("msie_refresh"),

601 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

602 
ngx_cÚf_£t_æag_¦Ù
,

603 
NGX_HTTP_LOC_CONF_OFFSET
,

604 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
ms›_»äesh
),

605 
NULL
 },

607 { 
ngx_¡ršg
("log_not_found"),

608 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

609 
ngx_cÚf_£t_æag_¦Ù
,

610 
NGX_HTTP_LOC_CONF_OFFSET
,

611 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
log_nÙ_found
),

612 
NULL
 },

614 { 
ngx_¡ršg
("log_subrequest"),

615 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

616 
ngx_cÚf_£t_æag_¦Ù
,

617 
NGX_HTTP_LOC_CONF_OFFSET
,

618 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
log_sub»que¡
),

619 
NULL
 },

621 { 
ngx_¡ršg
("recursive_error_pages"),

622 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

623 
ngx_cÚf_£t_æag_¦Ù
,

624 
NGX_HTTP_LOC_CONF_OFFSET
,

625 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
»cursive_”rÜ_·ges
),

626 
NULL
 },

628 { 
ngx_¡ršg
("server_tokens"),

629 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

630 
ngx_cÚf_£t_æag_¦Ù
,

631 
NGX_HTTP_LOC_CONF_OFFSET
,

632 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
£rv”_tok’s
),

633 
NULL
 },

635 { 
ngx_¡ršg
("if_modified_since"),

636 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

637 
ngx_cÚf_£t_’um_¦Ù
,

638 
NGX_HTTP_LOC_CONF_OFFSET
,

639 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
if_modif›d_sšû
),

640 &
ngx_h‰p_cÜe_if_modif›d_sšû
 },

642 { 
ngx_¡ršg
("max_ranges"),

643 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

644 
ngx_cÚf_£t_num_¦Ù
,

645 
NGX_HTTP_LOC_CONF_OFFSET
,

646 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
max_¿nges
),

647 
NULL
 },

649 { 
ngx_¡ršg
("chunked_transfer_encoding"),

650 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

651 
ngx_cÚf_£t_æag_¦Ù
,

652 
NGX_HTTP_LOC_CONF_OFFSET
,

653 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
chunked_Œªsãr_’codšg
),

654 
NULL
 },

656 { 
ngx_¡ršg
("etag"),

657 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

658 
ngx_cÚf_£t_æag_¦Ù
,

659 
NGX_HTTP_LOC_CONF_OFFSET
,

660 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
‘ag
),

661 
NULL
 },

663 { 
ngx_¡ršg
("error_page"),

664 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


665 |
NGX_CONF_2MORE
,

666 
ngx_h‰p_cÜe_”rÜ_·ge
,

667 
NGX_HTTP_LOC_CONF_OFFSET
,

669 
NULL
 },

671 { 
ngx_¡ršg
("try_files"),

672 
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_2MORE
,

673 
ngx_h‰p_cÜe_Œy_fžes
,

674 
NGX_HTTP_LOC_CONF_OFFSET
,

676 
NULL
 },

678 { 
ngx_¡ršg
("post_action"),

679 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_HTTP_LIF_CONF


680 |
NGX_CONF_TAKE1
,

681 
ngx_cÚf_£t_¡r_¦Ù
,

682 
NGX_HTTP_LOC_CONF_OFFSET
,

683 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
po¡_aùiÚ
),

684 
NULL
 },

686 { 
ngx_¡ršg
("error_log"),

687 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

688 
ngx_h‰p_cÜe_”rÜ_log
,

689 
NGX_HTTP_LOC_CONF_OFFSET
,

691 
NULL
 },

693 { 
ngx_¡ršg
("open_file_cache"),

694 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE12
,

695 
ngx_h‰p_cÜe_Ý’_fže_ÿche
,

696 
NGX_HTTP_LOC_CONF_OFFSET
,

697 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
Ý’_fže_ÿche
),

698 
NULL
 },

700 { 
ngx_¡ršg
("open_file_cache_valid"),

701 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

702 
ngx_cÚf_£t_£c_¦Ù
,

703 
NGX_HTTP_LOC_CONF_OFFSET
,

704 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
Ý’_fže_ÿche_v®id
),

705 
NULL
 },

707 { 
ngx_¡ršg
("open_file_cache_retest"),

708 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

709 
ngx_cÚf_£t_£c_¦Ù
,

710 
NGX_HTTP_LOC_CONF_OFFSET
,

711 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
Ý’_fže_ÿche_v®id
),

712 &
ngx_cÚf_d•»ÿ‹d_Ý’_fže_ÿche_»‹¡
 },

714 { 
ngx_¡ršg
("open_file_cache_min_uses"),

715 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

716 
ngx_cÚf_£t_num_¦Ù
,

717 
NGX_HTTP_LOC_CONF_OFFSET
,

718 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
Ý’_fže_ÿche_mš_u£s
),

719 
NULL
 },

721 { 
ngx_¡ršg
("open_file_cache_errors"),

722 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

723 
ngx_cÚf_£t_æag_¦Ù
,

724 
NGX_HTTP_LOC_CONF_OFFSET
,

725 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
Ý’_fže_ÿche_”rÜs
),

726 
NULL
 },

728 { 
ngx_¡ršg
("open_file_cache_events"),

729 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

730 
ngx_cÚf_£t_æag_¦Ù
,

731 
NGX_HTTP_LOC_CONF_OFFSET
,

732 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
Ý’_fže_ÿche_ev’ts
),

733 
NULL
 },

735 { 
ngx_¡ršg
("resolver"),

736 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

737 
ngx_h‰p_cÜe_»sÞv”
,

738 
NGX_HTTP_LOC_CONF_OFFSET
,

740 
NULL
 },

742 { 
ngx_¡ršg
("resolver_timeout"),

743 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

744 
ngx_cÚf_£t_m£c_¦Ù
,

745 
NGX_HTTP_LOC_CONF_OFFSET
,

746 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
»sÞv”_timeout
),

747 
NULL
 },

749 #ià(
NGX_HTTP_GZIP
)

751 { 
ngx_¡ršg
("gzip_vary"),

752 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

753 
ngx_cÚf_£t_æag_¦Ù
,

754 
NGX_HTTP_LOC_CONF_OFFSET
,

755 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
gz_v¬y
),

756 
NULL
 },

758 { 
ngx_¡ršg
("gzip_http_version"),

759 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

760 
ngx_cÚf_£t_’um_¦Ù
,

761 
NGX_HTTP_LOC_CONF_OFFSET
,

762 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
gz_h‰p_v”siÚ
),

763 &
ngx_h‰p_gz_h‰p_v”siÚ
 },

765 { 
ngx_¡ršg
("gzip_proxied"),

766 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

767 
ngx_cÚf_£t_b™mask_¦Ù
,

768 
NGX_HTTP_LOC_CONF_OFFSET
,

769 
off£tof
(
ngx_h‰p_cÜe_loc_cÚf_t
, 
gz_´ox›d
),

770 &
ngx_h‰p_gz_´ox›d_mask
 },

772 { 
ngx_¡ršg
("gzip_disable"),

773 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

774 
ngx_h‰p_gz_di§bË
,

775 
NGX_HTTP_LOC_CONF_OFFSET
,

777 
NULL
 },

781 #ià(
NGX_HAVE_OPENAT
)

783 { 
ngx_¡ršg
("disable_symlinks"),

784 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE12
,

785 
ngx_h‰p_di§bË_symlšks
,

786 
NGX_HTTP_LOC_CONF_OFFSET
,

788 
NULL
 },

792 
ngx_nuÎ_commªd


796 
ngx_h‰p_moduË_t
 
	gngx_h‰p_cÜe_moduË_ùx
 = {

797 
ngx_h‰p_cÜe_´ecÚfigu¿tiÚ
,

798 
NULL
,

800 
ngx_h‰p_cÜe_ü—‹_maš_cÚf
,

801 
ngx_h‰p_cÜe_š™_maš_cÚf
,

803 
ngx_h‰p_cÜe_ü—‹_¤v_cÚf
,

804 
ngx_h‰p_cÜe_m”ge_¤v_cÚf
,

806 
ngx_h‰p_cÜe_ü—‹_loc_cÚf
,

807 
ngx_h‰p_cÜe_m”ge_loc_cÚf


811 
ngx_moduË_t
 
	gngx_h‰p_cÜe_moduË
 = {

812 
NGX_MODULE_V1
,

813 &
ngx_h‰p_cÜe_moduË_ùx
,

814 
ngx_h‰p_cÜe_commªds
,

815 
NGX_HTTP_MODULE
,

816 
NULL
,

817 
NULL
,

818 
NULL
,

819 
NULL
,

820 
NULL
,

821 
NULL
,

822 
NULL
,

823 
NGX_MODULE_V1_PADDING


827 
ngx_¡r_t
 
	gngx_h‰p_cÜe_g‘_m‘hod
 = { 3, (
u_ch¬
 *) "GET " };

831 
	$ngx_h‰p_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

833 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

835 
r
->
cÚÃùiÚ
->
log
->
aùiÚ
 = 
NULL
;

837 
r
->
cÚÃùiÚ
->
uÃx³ùed_eof
 = 0;

839 ià(!
r
->
š‹º®
) {

840 
r
->
h—d”s_š
.
cÚÃùiÚ_ty³
) {

842 
r
->
k“·live
 = (r->
h‰p_v”siÚ
 > 
NGX_HTTP_VERSION_10
);

845 
NGX_HTTP_CONNECTION_CLOSE
:

846 
r
->
k“·live
 = 0;

849 
NGX_HTTP_CONNECTION_KEEP_ALIVE
:

850 
r
->
k“·live
 = 1;

854 
r
->
lšg”šg_þo£
 = (r->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 > 0

855 || 
r
->
h—d”s_š
.
chunked
);

856 
r
->
pha£_hªdËr
 = 0;

859 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

860 
r
->
pha£_hªdËr
 = 
cmcf
->
pha£_’gše
.
£rv”_»wr™e_šdex
;

863 
r
->
v®id_loÿtiÚ
 = 1;

864 #ià(
NGX_HTTP_GZIP
)

865 
r
->
gz_‹¡ed
 = 0;

866 
r
->
gz_ok
 = 0;

867 
r
->
gz_v¬y
 = 0;

870 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_cÜe_run_pha£s
;

871 
	`ngx_h‰p_cÜe_run_pha£s
(
r
);

872 
	}
}

876 
	$ngx_h‰p_cÜe_run_pha£s
(
ngx_h‰p_»que¡_t
 *
r
)

878 
ngx_št_t
 
rc
;

879 
ngx_h‰p_pha£_hªdËr_t
 *
ph
;

880 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

882 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

884 
ph
 = 
cmcf
->
pha£_’gše
.
hªdËrs
;

886 
ph
[
r
->
pha£_hªdËr
].
check”
) {

888 
rc
 = 
ph
[
r
->
pha£_hªdËr
].
	`check”
(r, &ph[r->phase_handler]);

890 ià(
rc
 =ð
NGX_OK
) {

894 
	}
}

897 
ngx_št_t


898 
	$ngx_h‰p_cÜe_g’”ic_pha£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_pha£_hªdËr_t
 *
ph
)

900 
ngx_št_t
 
rc
;

907 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

908 "g’”iøpha£: %ui", 
r
->
pha£_hªdËr
);

910 
rc
 = 
ph
->
	`hªdËr
(
r
);

912 ià(
rc
 =ð
NGX_OK
) {

913 
r
->
pha£_hªdËr
 = 
ph
->
Ãxt
;

914  
NGX_AGAIN
;

917 ià(
rc
 =ð
NGX_DECLINED
) {

918 
r
->
pha£_hªdËr
++;

919  
NGX_AGAIN
;

922 ià(
rc
 =ð
NGX_AGAIN
 ||„ø=ð
NGX_DONE
) {

923  
NGX_OK
;

928 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

930  
NGX_OK
;

931 
	}
}

934 
ngx_št_t


935 
	$ngx_h‰p_cÜe_»wr™e_pha£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_pha£_hªdËr_t
 *
ph
)

937 
ngx_št_t
 
rc
;

939 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

940 "»wr™pha£: %ui", 
r
->
pha£_hªdËr
);

942 
rc
 = 
ph
->
	`hªdËr
(
r
);

944 ià(
rc
 =ð
NGX_DECLINED
) {

945 
r
->
pha£_hªdËr
++;

946  
NGX_AGAIN
;

949 ià(
rc
 =ð
NGX_DONE
) {

950  
NGX_OK
;

955 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

957  
NGX_OK
;

958 
	}
}

961 
ngx_št_t


962 
	$ngx_h‰p_cÜe_fšd_cÚfig_pha£
(
ngx_h‰p_»que¡_t
 *
r
,

963 
ngx_h‰p_pha£_hªdËr_t
 *
ph
)

965 
u_ch¬
 *
p
;

966 
size_t
 
Ën
;

967 
ngx_št_t
 
rc
;

968 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

970 
r
->
cÚ‹Á_hªdËr
 = 
NULL
;

971 
r
->
uri_chªged
 = 0;

973 
rc
 = 
	`ngx_h‰p_cÜe_fšd_loÿtiÚ
(
r
);

975 ià(
rc
 =ð
NGX_ERROR
) {

976 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

977  
NGX_OK
;

980 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

982 ià(!
r
->
š‹º®
 && 
þcf
->internal) {

983 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_NOT_FOUND
);

984  
NGX_OK
;

987 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

989 (
þcf
->
nÚame
 ? "*" : (þcf->
exaù_m©ch
 ? "=" : "")),

990 &
þcf
->
Çme
);

992 
	`ngx_h‰p_upd©e_loÿtiÚ_cÚfig
(
r
);

994 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

996 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
, 
þcf
->
þ›Á_max_body_size
);

998 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 != -1

999 && !
r
->
disÿrd_body


1000 && 
þcf
->
þ›Á_max_body_size


1001 && 
þcf
->
þ›Á_max_body_size
 < 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
)

1003 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1005 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
);

1007 
r
->
ex³ù_‹¡ed
 = 1;

1008 (è
	`ngx_h‰p_disÿrd_»que¡_body
(
r
);

1009 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_REQUEST_ENTITY_TOO_LARGE
);

1010  
NGX_OK
;

1013 ià(
rc
 =ð
NGX_DONE
) {

1014 
	`ngx_h‰p_þ—r_loÿtiÚ
(
r
);

1016 
r
->
h—d”s_out
.
loÿtiÚ
 = 
	`ngx_li¡_push
(&r->h—d”s_out.
h—d”s
);

1017 ià(
r
->
h—d”s_out
.
loÿtiÚ
 =ð
NULL
) {

1018 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1019  
NGX_OK
;

1027 ià(
r
->
¬gs
.
Ën
 == 0) {

1028 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
 = 
þcf
->
Çme
;

1031 
Ën
 = 
þcf
->
Çme
.ËÀ+ 1 + 
r
->
¬gs
.len;

1032 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

1034 ià(
p
 =ð
NULL
) {

1035 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1036  
NGX_OK
;

1039 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
 =†en;

1040 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
 = 
p
;

1042 
p
 = 
	`ngx_ýymem
Õ, 
þcf
->
Çme
.
d©a
, clcf->Çme.
Ën
);

1043 *
p
++ = '?';

1044 
	`ngx_memýy
(
p
, 
r
->
¬gs
.
d©a
,„->¬gs.
Ën
);

1047 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_MOVED_PERMANENTLY
);

1048  
NGX_OK
;

1051 
r
->
pha£_hªdËr
++;

1052  
NGX_AGAIN
;

1053 
	}
}

1056 
ngx_št_t


1057 
	$ngx_h‰p_cÜe_po¡_»wr™e_pha£
(
ngx_h‰p_»que¡_t
 *
r
,

1058 
ngx_h‰p_pha£_hªdËr_t
 *
ph
)

1060 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

1062 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1063 "po¡„ewr™pha£: %ui", 
r
->
pha£_hªdËr
);

1065 ià(!
r
->
uri_chªged
) {

1066 
r
->
pha£_hªdËr
++;

1067  
NGX_AGAIN
;

1070 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1071 "ur˜chªges: %d", 
r
->
uri_chªges
);

1080 
r
->
uri_chªges
--;

1082 ià(
r
->
uri_chªges
 == 0) {

1083 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1085 "whž´oûssšg \"%V\"", &
r
->
uri
);

1087 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1088  
NGX_OK
;

1091 
r
->
pha£_hªdËr
 = 
ph
->
Ãxt
;

1093 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1094 
r
->
loc_cÚf
 = 
cscf
->
ùx
->loc_conf;

1096  
NGX_AGAIN
;

1097 
	}
}

1100 
ngx_št_t


1101 
	$ngx_h‰p_cÜe_acûss_pha£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_pha£_hªdËr_t
 *
ph
)

1103 
ngx_št_t
 
rc
;

1104 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1106 ià(
r
 !ðr->
maš
) {

1107 
r
->
pha£_hªdËr
 = 
ph
->
Ãxt
;

1108  
NGX_AGAIN
;

1111 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1112 "acûs pha£: %ui", 
r
->
pha£_hªdËr
);

1114 
rc
 = 
ph
->
	`hªdËr
(
r
);

1116 ià(
rc
 =ð
NGX_DECLINED
) {

1117 
r
->
pha£_hªdËr
++;

1118  
NGX_AGAIN
;

1121 ià(
rc
 =ð
NGX_AGAIN
 ||„ø=ð
NGX_DONE
) {

1122  
NGX_OK
;

1125 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1127 ià(
þcf
->
§tisfy
 =ð
NGX_HTTP_SATISFY_ALL
) {

1129 ià(
rc
 =ð
NGX_OK
) {

1130 
r
->
pha£_hªdËr
++;

1131  
NGX_AGAIN
;

1135 ià(
rc
 =ð
NGX_OK
) {

1136 
r
->
acûss_code
 = 0;

1138 ià(
r
->
h—d”s_out
.
www_auth’tiÿ‹
) {

1139 
r
->
h—d”s_out
.
www_auth’tiÿ‹
->
hash
 = 0;

1142 
r
->
pha£_hªdËr
 = 
ph
->
Ãxt
;

1143  
NGX_AGAIN
;

1146 ià(
rc
 =ð
NGX_HTTP_FORBIDDEN
 ||„ø=ð
NGX_HTTP_UNAUTHORIZED
) {

1147 ià(
r
->
acûss_code
 !ð
NGX_HTTP_UNAUTHORIZED
) {

1148 
r
->
acûss_code
 = 
rc
;

1151 
r
->
pha£_hªdËr
++;

1152  
NGX_AGAIN
;

1158 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

1159  
NGX_OK
;

1160 
	}
}

1163 
ngx_št_t


1164 
	$ngx_h‰p_cÜe_po¡_acûss_pha£
(
ngx_h‰p_»que¡_t
 *
r
,

1165 
ngx_h‰p_pha£_hªdËr_t
 *
ph
)

1167 
ngx_št_t
 
acûss_code
;

1169 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1170 "po¡‡cûs pha£: %ui", 
r
->
pha£_hªdËr
);

1172 
acûss_code
 = 
r
->access_code;

1174 ià(
acûss_code
) {

1175 ià(
acûss_code
 =ð
NGX_HTTP_FORBIDDEN
) {

1176 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1180 
r
->
acûss_code
 = 0;

1181 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
acûss_code
);

1182  
NGX_OK
;

1185 
r
->
pha£_hªdËr
++;

1186  
NGX_AGAIN
;

1187 
	}
}

1190 
ngx_št_t


1191 
	$ngx_h‰p_cÜe_Œy_fžes_pha£
(
ngx_h‰p_»que¡_t
 *
r
,

1192 
ngx_h‰p_pha£_hªdËr_t
 *
ph
)

1194 
size_t
 
Ën
, 
roÙ
, 
®Ÿs
, 
»£rve
, 
®loÿ‹d
;

1195 
u_ch¬
 *
p
, *
Çme
;

1196 
ngx_¡r_t
 
·th
, 
¬gs
;

1197 
ngx_ušt_t
 
‹¡_dœ
;

1198 
ngx_h‰p_Œy_fže_t
 *
tf
;

1199 
ngx_Ý’_fže_šfo_t
 
of
;

1200 
ngx_h‰p_süt_code_±
 
code
;

1201 
ngx_h‰p_süt_’gše_t
 
e
;

1202 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1203 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

1205 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1206 "Œy fže pha£: %ui", 
r
->
pha£_hªdËr
);

1208 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1210 ià(
þcf
->
Œy_fžes
 =ð
NULL
) {

1211 
r
->
pha£_hªdËr
++;

1212  
NGX_AGAIN
;

1215 
®loÿ‹d
 = 0;

1216 
roÙ
 = 0;

1217 
Çme
 = 
NULL
;

1219 
·th
.
d©a
 = 
NULL
;

1221 
tf
 = 
þcf
->
Œy_fžes
;

1223 
®Ÿs
 = 
þcf
->alias;

1227 ià(
tf
->
Ëngths
) {

1228 
	`ngx_memz”o
(&
e
, (
ngx_h‰p_süt_’gše_t
));

1230 
e
.

 = 
tf
->
Ëngths
->
–ts
;

1231 
e
.
»que¡
 = 
r
;

1234 
Ën
 = 1;

1236 *(
ušŒ_t
 *è
e
.

) {

1237 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
e
.

;

1238 
Ën
 +ð
	`lcode
(&
e
);

1242 
Ën
 = 
tf
->
Çme
.len;

1245 ià(!
®Ÿs
) {

1246 
»£rve
 = 
Ën
 > 
r
->
uri
.len ?†en -„->uri.len : 0;

1248 } ià(
®Ÿs
 =ð
NGX_MAX_SIZE_T_VALUE
) {

1249 
»£rve
 = 
Ën
;

1252 
»£rve
 = 
Ën
 > 
r
->
uri
.ËÀ- 
®Ÿs
 ?†en - (r->uri.len -‡lias) : 0;

1255 ià(
»£rve
 > 
®loÿ‹d
 || !allocated) {

1258 
®loÿ‹d
 = 
»£rve
 + 16;

1260 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 
®loÿ‹d
è=ð
NULL
) {

1261 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1262  
NGX_OK
;

1265 
Çme
 = 
·th
.
d©a
 + 
roÙ
;

1268 ià(
tf
->
v®ues
 =ð
NULL
) {

1272 
	`ngx_memýy
(
Çme
, 
tf
->Çme.
d©a
,f->Çme.
Ën
);

1274 
·th
.
Ën
 = (
Çme
 + 
tf
->Çme.ËÀ- 1è-…©h.
d©a
;

1277 
e
.

 = 
tf
->
v®ues
->
–ts
;

1278 
e
.
pos
 = 
Çme
;

1279 
e
.
æushed
 = 1;

1281 *(
ušŒ_t
 *è
e
.

) {

1282 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

1283 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

1286 
·th
.
Ën
 = 
e
.
pos
 -…©h.
d©a
;

1288 *
e
.
pos
 = '\0';

1290 ià(
®Ÿs
 && 
	`ngx_¡ºcmp
(
Çme
, 
þcf
->Çme.
d©a
,‡lias) == 0) {

1291 
	`ngx_memmove
(
Çme
,‚am+ 
®Ÿs
, 
Ën
 -‡lias);

1292 
·th
.
Ën
 -ð
®Ÿs
;

1296 
‹¡_dœ
 = 
tf
->test_dir;

1298 
tf
++;

1300 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1302 
‹¡_dœ
 ? "dœ" : "fže", 
Çme
, 
·th
.
d©a
);

1304 ià(
tf
->
Ëngths
 =ð
NULL
 &&f->
Çme
.
Ën
 == 0) {

1306 ià(
tf
->
code
) {

1307 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
tf
->
code
);

1308  
NGX_OK
;

1311 
·th
.
Ën
 -ð
roÙ
;

1312 
·th
.
d©a
 +ð
roÙ
;

1314 ià(
·th
.
d©a
[0] == '@') {

1315 (è
	`ngx_h‰p_Çmed_loÿtiÚ
(
r
, &
·th
);

1318 
	`ngx_h‰p_¥l™_¬gs
(
r
, &
·th
, &
¬gs
);

1320 (è
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
·th
, &
¬gs
);

1323 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_DONE
);

1324  
NGX_OK
;

1327 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

1329 
of
.
»ad_ah—d
 = 
þcf
->read_ahead;

1330 
of
.
dœeùio
 = 
þcf
->directio;

1331 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

1332 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

1333 
of
.
‹¡_Úly
 = 1;

1334 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

1335 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

1337 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
·th
, &
of
è!ð
NGX_OK
) {

1338 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1339  
NGX_OK
;

1342 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
·th
, &
of
, 
r
->
poÞ
)

1343 !ð
NGX_OK
)

1345 ià(
of
.
”r
 !ð
NGX_ENOENT


1346 && 
of
.
”r
 !ð
NGX_ENOTDIR


1347 && 
of
.
”r
 !ð
NGX_ENAMETOOLONG
)

1349 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
of
.
”r
,

1350 "% \"%s\" fažed", 
of
.
çžed
, 
·th
.
d©a
);

1356 ià(
of
.
is_dœ
 && !
‹¡_dœ
) {

1360 
·th
.
Ën
 -ð
roÙ
;

1361 
·th
.
d©a
 +ð
roÙ
;

1363 ià(!
®Ÿs
) {

1364 
r
->
uri
 = 
·th
;

1366 } ià(
®Ÿs
 =ð
NGX_MAX_SIZE_T_VALUE
) {

1367 ià(!
‹¡_dœ
) {

1368 
r
->
uri
 = 
·th
;

1369 
r
->
add_uri_to_®Ÿs
 = 1;

1373 
r
->
uri
.
Ën
 = 
®Ÿs
 + 
·th
.len;

1374 
r
->
uri
.
d©a
 = 
	`ngx_²®loc
Ô->
poÞ
,„->uri.
Ën
);

1375 ià(
r
->
uri
.
d©a
 =ð
NULL
) {

1376 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1377  
NGX_OK
;

1380 
p
 = 
	`ngx_cÝy
(
r
->
uri
.
d©a
, 
þcf
->
Çme
.d©a, 
®Ÿs
);

1381 
	`ngx_memýy
(
p
, 
Çme
, 
·th
.
Ën
);

1384 
	`ngx_h‰p_£t_ex‹n
(
r
);

1386 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1387 "Œy fžuri: \"%V\"", &
r
->
uri
);

1389 
r
->
pha£_hªdËr
++;

1390  
NGX_AGAIN
;

1394 
	}
}

1397 
ngx_št_t


1398 
	$ngx_h‰p_cÜe_cÚ‹Á_pha£
(
ngx_h‰p_»que¡_t
 *
r
,

1399 
ngx_h‰p_pha£_hªdËr_t
 *
ph
)

1401 
size_t
 
roÙ
;

1402 
ngx_št_t
 
rc
;

1403 
ngx_¡r_t
 
·th
;

1405 ià(
r
->
cÚ‹Á_hªdËr
) {

1406 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

1407 
	`ngx_h‰p_fš®ize_»que¡
(
r
,„->
	`cÚ‹Á_hªdËr
(r));

1408  
NGX_OK
;

1411 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1412 "cÚ‹Á…ha£: %ui", 
r
->
pha£_hªdËr
);

1414 
rc
 = 
ph
->
	`hªdËr
(
r
);

1416 ià(
rc
 !ð
NGX_DECLINED
) {

1417 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

1418  
NGX_OK
;

1423 
ph
++;

1425 ià(
ph
->
check”
) {

1426 
r
->
pha£_hªdËr
++;

1427  
NGX_AGAIN
;

1432 ià(
r
->
uri
.
d©a
[r->uri.
Ën
 - 1] == '/') {

1434 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0è!ð
NULL
) {

1435 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1436 "dœeùÜy index oà\"%s\" i fÜbidd’", 
·th
.
d©a
);

1439 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_FORBIDDEN
);

1440  
NGX_OK
;

1443 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0, "no handler found");

1445 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_NOT_FOUND
);

1446  
NGX_OK
;

1447 
	}
}

1451 
	$ngx_h‰p_upd©e_loÿtiÚ_cÚfig
(
ngx_h‰p_»que¡_t
 *
r
)

1453 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1455 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1457 ià(
r
->
m‘hod
 & 
þcf
->
lim™_exû±
) {

1458 
r
->
loc_cÚf
 = 
þcf
->
lim™_exû±_loc_cÚf
;

1459 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1462 ià(
r
 =ðr->
maš
) {

1463 
	`ngx_h‰p_£t_cÚÃùiÚ_log
(
r
->
cÚÃùiÚ
, 
þcf
->
”rÜ_log
);

1466 ià((
ngx_io
.
æags
 & 
NGX_IO_SENDFILE
è&& 
þcf
->
£ndfže
) {

1467 
r
->
cÚÃùiÚ
->
£ndfže
 = 1;

1470 
r
->
cÚÃùiÚ
->
£ndfže
 = 0;

1473 ià(
þcf
->
þ›Á_body_š_fže_Úly
) {

1474 
r
->
»que¡_body_š_fže_Úly
 = 1;

1475 
r
->
»que¡_body_š_³rsi¡’t_fže
 = 1;

1476 
r
->
»que¡_body_š_þ—n_fže
 =

1477 
þcf
->
þ›Á_body_š_fže_Úly
 =ð
NGX_HTTP_REQUEST_BODY_FILE_CLEAN
;

1478 
r
->
»que¡_body_fže_log_Ëv–
 = 
NGX_LOG_NOTICE
;

1481 
r
->
»que¡_body_fže_log_Ëv–
 = 
NGX_LOG_WARN
;

1484 
r
->
»que¡_body_š_sšgË_buf
 = 
þcf
->
þ›Á_body_š_sšgË_bufãr
;

1486 ià(
r
->
k“·live
) {

1487 ià(
þcf
->
k“·live_timeout
 == 0) {

1488 
r
->
k“·live
 = 0;

1490 } ià(
r
->
cÚÃùiÚ
->
»que¡s
 >ð
þcf
->
k“·live_»que¡s
) {

1491 
r
->
k“·live
 = 0;

1493 } ià(
r
->
h—d”s_š
.
ms›6


1494 && 
r
->
m‘hod
 =ð
NGX_HTTP_POST


1495 && (
þcf
->
k“·live_di§bË


1496 & 
NGX_HTTP_KEEPALIVE_DISABLE_MSIE6
))

1502 
r
->
k“·live
 = 0;

1504 } ià(
r
->
h—d”s_š
.
§çri


1505 && (
þcf
->
k“·live_di§bË


1506 & 
NGX_HTTP_KEEPALIVE_DISABLE_SAFARI
))

1513 
r
->
k“·live
 = 0;

1517 ià(!
þcf
->
tý_nÝush
) {

1519 
r
->
cÚÃùiÚ
->
tý_nÝush
 = 
NGX_TCP_NOPUSH_DISABLED
;

1522 ià(
r
->
lim™_¿‹
 == 0) {

1523 
r
->
lim™_¿‹
 = 
þcf
->limit_rate;

1526 ià(
þcf
->
hªdËr
) {

1527 
r
->
cÚ‹Á_hªdËr
 = 
þcf
->
hªdËr
;

1529 
	}
}

1540 
ngx_št_t


1541 
	$ngx_h‰p_cÜe_fšd_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
)

1543 
ngx_št_t
 
rc
;

1544 
ngx_h‰p_cÜe_loc_cÚf_t
 *
pþcf
;

1545 #ià(
NGX_PCRE
)

1546 
ngx_št_t
 
n
;

1547 
ngx_ušt_t
 
nÜegex
;

1548 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, **
þcå
;

1550 
nÜegex
 = 0;

1553 
pþcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1555 
rc
 = 
	`ngx_h‰p_cÜe_fšd_¡©ic_loÿtiÚ
(
r
, 
pþcf
->
¡©ic_loÿtiÚs
);

1557 ià(
rc
 =ð
NGX_AGAIN
) {

1559 #ià(
NGX_PCRE
)

1560 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1562 
nÜegex
 = 
þcf
->noregex;

1567 
rc
 = 
	`ngx_h‰p_cÜe_fšd_loÿtiÚ
(
r
);

1570 ià(
rc
 =ð
NGX_OK
 ||„ø=ð
NGX_DONE
) {

1571  
rc
;

1576 #ià(
NGX_PCRE
)

1578 ià(
nÜegex
 =ð0 && 
pþcf
->
»gex_loÿtiÚs
) {

1580 
þcå
 = 
pþcf
->
»gex_loÿtiÚs
; *clcfp; clcfp++) {

1582 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1583 "‹¡†oÿtiÚ: ~ \"%V\"", &(*
þcå
)->
Çme
);

1585 
n
 = 
	`ngx_h‰p_»gex_exec
(
r
, (*
þcå
)->
»gex
, &r->
uri
);

1587 ià(
n
 =ð
NGX_OK
) {

1588 
r
->
loc_cÚf
 = (*
þcå
)->loc_conf;

1592 
rc
 = 
	`ngx_h‰p_cÜe_fšd_loÿtiÚ
(
r
);

1594  (
rc
 =ð
NGX_ERROR
è?„ø: 
NGX_OK
;

1597 ià(
n
 =ð
NGX_DECLINED
) {

1601  
NGX_ERROR
;

1606  
rc
;

1607 
	}
}

1617 
ngx_št_t


1618 
	$ngx_h‰p_cÜe_fšd_¡©ic_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

1619 
ngx_h‰p_loÿtiÚ_Œ“_node_t
 *
node
)

1621 
u_ch¬
 *
uri
;

1622 
size_t
 
Ën
, 
n
;

1623 
ngx_št_t
 
rc
, 
rv
;

1625 
Ën
 = 
r
->
uri
.len;

1626 
uri
 = 
r
->uri.
d©a
;

1628 
rv
 = 
NGX_DECLINED
;

1632 ià(
node
 =ð
NULL
) {

1633  
rv
;

1636 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1637 "‹¡†oÿtiÚ: \"%*s\"", 
node
->
Ën
,‚ode->
Çme
);

1639 
n
 = (
Ën
 <ð(
size_t
è
node
->len) ?†en :‚ode->len;

1641 
rc
 = 
	`ngx_fž’ame_cmp
(
uri
, 
node
->
Çme
, 
n
);

1643 ià(
rc
 != 0) {

1644 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

1649 ià(
Ën
 > (
size_t
è
node
->len) {

1651 ià(
node
->
šþusive
) {

1653 
r
->
loc_cÚf
 = 
node
->
šþusive
->loc_conf;

1654 
rv
 = 
NGX_AGAIN
;

1656 
node
 =‚ode->
Œ“
;

1657 
uri
 +ð
n
;

1658 
Ën
 -ð
n
;

1665 
node
 =‚ode->
right
;

1670 ià(
Ën
 =ð(
size_t
è
node
->len) {

1672 ià(
node
->
exaù
) {

1673 
r
->
loc_cÚf
 = 
node
->
exaù
->loc_conf;

1674  
NGX_OK
;

1677 
r
->
loc_cÚf
 = 
node
->
šþusive
->loc_conf;

1678  
NGX_AGAIN
;

1684 ià(
Ën
 + 1 =ð(
size_t
è
node
->ËÀ&&‚ode->
auto_»dœeù
) {

1686 
r
->
loc_cÚf
 = (
node
->
exaù
) ?‚ode->exact->loc_conf:

1687 
node
->
šþusive
->
loc_cÚf
;

1688 
rv
 = 
NGX_DONE
;

1691 
node
 =‚ode->
Ëá
;

1693 
	}
}

1697 
	$ngx_h‰p_‹¡_cÚ‹Á_ty³
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_hash_t
 *
ty³s_hash
)

1699 
u_ch¬
 
c
, *
lowÿ£
;

1700 
size_t
 
Ën
;

1701 
ngx_ušt_t
 
i
, 
hash
;

1703 ià(
ty³s_hash
->
size
 == 0) {

1707 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 == 0) {

1708  
NULL
;

1711 
Ën
 = 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
;

1713 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 =ð
NULL
) {

1715 
lowÿ£
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

1716 ià(
lowÿ£
 =ð
NULL
) {

1717  
NULL
;

1720 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
lowÿ£
;

1722 
hash
 = 0;

1724 
i
 = 0; i < 
Ën
; i++) {

1725 
c
 = 
	`ngx_tÞow”
(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
[
i
]);

1726 
hash
 = 
	`ngx_hash
(hash, 
c
);

1727 
lowÿ£
[
i
] = 
c
;

1730 
r
->
h—d”s_out
.
cÚ‹Á_ty³_hash
 = 
hash
;

1733  
	`ngx_hash_fšd
(
ty³s_hash
, 
r
->
h—d”s_out
.
cÚ‹Á_ty³_hash
,

1734 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
, 
Ën
);

1735 
	}
}

1738 
ngx_št_t


1739 
	$ngx_h‰p_£t_cÚ‹Á_ty³
(
ngx_h‰p_»que¡_t
 *
r
)

1741 
u_ch¬
 
c
, *
ex‹n
;

1742 
ngx_¡r_t
 *
ty³
;

1743 
ngx_ušt_t
 
i
, 
hash
;

1744 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1746 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
) {

1747  
NGX_OK
;

1750 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1752 ià(
r
->
ex‹n
.
Ën
) {

1754 
hash
 = 0;

1756 
i
 = 0; i < 
r
->
ex‹n
.
Ën
; i++) {

1757 
c
 = 
r
->
ex‹n
.
d©a
[
i
];

1759 ià(
c
 >= 'A' && c <= 'Z') {

1761 
ex‹n
 = 
	`ngx_²®loc
(
r
->
poÞ
,„->ex‹n.
Ën
);

1762 ià(
ex‹n
 =ð
NULL
) {

1763  
NGX_ERROR
;

1766 
hash
 = 
	`ngx_hash_¡¾ow
(
ex‹n
, 
r
->ex‹n.
d©a
,„->ex‹n.
Ën
);

1768 
r
->
ex‹n
.
d©a
 =ƒxten;

1773 
hash
 = 
	`ngx_hash
(hash, 
c
);

1776 
ty³
 = 
	`ngx_hash_fšd
(&
þcf
->
ty³s_hash
, 
hash
,

1777 
r
->
ex‹n
.
d©a
,„->ex‹n.
Ën
);

1779 ià(
ty³
) {

1780 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = 
ty³
->
Ën
;

1781 
r
->
h—d”s_out
.
cÚ‹Á_ty³
 = *
ty³
;

1783  
NGX_OK
;

1787 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = 
þcf
->
deçuÉ_ty³
.
Ën
;

1788 
r
->
h—d”s_out
.
cÚ‹Á_ty³
 = 
þcf
->
deçuÉ_ty³
;

1790  
NGX_OK
;

1791 
	}
}

1795 
	$ngx_h‰p_£t_ex‹n
(
ngx_h‰p_»que¡_t
 *
r
)

1797 
ngx_št_t
 
i
;

1799 
	`ngx_¡r_nuÎ
(&
r
->
ex‹n
);

1801 
i
 = 
r
->
uri
.
Ën
 - 1; i > 1; i--) {

1802 ià(
r
->
uri
.
d©a
[
i
] == '.' &&„->uri.data[i - 1] != '/') {

1804 
r
->
ex‹n
.
Ën
 =„->
uri
.ËÀ- 
i
 - 1;

1805 
r
->
ex‹n
.
d©a
 = &r->
uri
.d©a[
i
 + 1];

1809 } ià(
r
->
uri
.
d©a
[
i
] == '/') {

1815 
	}
}

1818 
ngx_št_t


1819 
	$ngx_h‰p_£t_‘ag
(
ngx_h‰p_»que¡_t
 *
r
)

1821 
ngx_bË_–t_t
 *
‘ag
;

1822 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1824 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1826 ià(!
þcf
->
‘ag
) {

1827  
NGX_OK
;

1830 
‘ag
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

1831 ià(
‘ag
 =ð
NULL
) {

1832  
NGX_ERROR
;

1835 
‘ag
->
hash
 = 1;

1836 
	`ngx_¡r_£t
(&
‘ag
->
key
, "ETag");

1838 
‘ag
->
v®ue
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_OFF_T_LEN
 + 
NGX_TIME_T_LEN
 + 3);

1839 ià(
‘ag
->
v®ue
.
d©a
 =ð
NULL
) {

1840 
‘ag
->
hash
 = 0;

1841  
NGX_ERROR
;

1844 
‘ag
->
v®ue
.
Ën
 = 
	`ngx_¥rštf
Óg->v®ue.
d©a
, "\"%xT-%xO\"",

1845 
r
->
h—d”s_out
.
Ï¡_modif›d_time
,

1846 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
)

1847 - 
‘ag
->
v®ue
.
d©a
;

1849 
r
->
h—d”s_out
.
‘ag
 =ƒtag;

1851  
NGX_OK
;

1852 
	}
}

1856 
	$ngx_h‰p_w—k_‘ag
(
ngx_h‰p_»que¡_t
 *
r
)

1858 
size_t
 
Ën
;

1859 
u_ch¬
 *
p
;

1860 
ngx_bË_–t_t
 *
‘ag
;

1862 
‘ag
 = 
r
->
h—d”s_out
.etag;

1864 ià(
‘ag
 =ð
NULL
) {

1868 ià(
‘ag
->
v®ue
.
Ën
 > 2

1869 && 
‘ag
->
v®ue
.
d©a
[0] == 'W'

1870 && 
‘ag
->
v®ue
.
d©a
[1] == '/')

1875 ià(
‘ag
->
v®ue
.
Ën
 < 1 ||ƒg->v®ue.
d©a
[0] != '"') {

1876 
r
->
h—d”s_out
.
‘ag
->
hash
 = 0;

1877 
r
->
h—d”s_out
.
‘ag
 = 
NULL
;

1881 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
‘ag
->
v®ue
.
Ën
 + 2);

1882 ià(
p
 =ð
NULL
) {

1883 
r
->
h—d”s_out
.
‘ag
->
hash
 = 0;

1884 
r
->
h—d”s_out
.
‘ag
 = 
NULL
;

1888 
Ën
 = 
	`ngx_¥rštf
(
p
, "W/%V", &
‘ag
->
v®ue
) -…;

1890 
‘ag
->
v®ue
.
d©a
 = 
p
;

1891 
‘ag
->
v®ue
.
Ën
 =†en;

1892 
	}
}

1895 
ngx_št_t


1896 
	$ngx_h‰p_£nd_»¥Ú£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
¡©us
,

1897 
ngx_¡r_t
 *
ù
, 
ngx_h‰p_com¶ex_v®ue_t
 *
cv
)

1899 
ngx_št_t
 
rc
;

1900 
ngx_¡r_t
 
v®
;

1901 
ngx_buf_t
 *
b
;

1902 
ngx_chaš_t
 
out
;

1904 ià(
	`ngx_h‰p_disÿrd_»que¡_body
(
r
è!ð
NGX_OK
) {

1905  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1908 
r
->
h—d”s_out
.
¡©us
 = status;

1910 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
cv
, &
v®
è!ð
NGX_OK
) {

1911  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1914 ià(
¡©us
 =ð
NGX_HTTP_MOVED_PERMANENTLY


1915 || 
¡©us
 =ð
NGX_HTTP_MOVED_TEMPORARILY


1916 || 
¡©us
 =ð
NGX_HTTP_SEE_OTHER


1917 || 
¡©us
 =ð
NGX_HTTP_TEMPORARY_REDIRECT
)

1919 
	`ngx_h‰p_þ—r_loÿtiÚ
(
r
);

1921 
r
->
h—d”s_out
.
loÿtiÚ
 = 
	`ngx_li¡_push
(&r->h—d”s_out.
h—d”s
);

1922 ià(
r
->
h—d”s_out
.
loÿtiÚ
 =ð
NULL
) {

1923  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1926 
r
->
h—d”s_out
.
loÿtiÚ
->
hash
 = 1;

1927 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
loÿtiÚ
->
key
, "Location");

1928 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
 = 
v®
;

1930  
¡©us
;

1933 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
v®
.
Ën
;

1935 ià(
ù
) {

1936 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = 
ù
->
Ën
;

1937 
r
->
h—d”s_out
.
cÚ‹Á_ty³
 = *
ù
;

1940 ià(
	`ngx_h‰p_£t_cÚ‹Á_ty³
(
r
è!ð
NGX_OK
) {

1941  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1945 ià(
r
->
m‘hod
 =ð
NGX_HTTP_HEAD
 || (¸!ðr->
maš
 && 
v®
.
Ën
 == 0)) {

1946  
	`ngx_h‰p_£nd_h—d”
(
r
);

1949 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

1950 ià(
b
 =ð
NULL
) {

1951  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1954 
b
->
pos
 = 
v®
.
d©a
;

1955 
b
->
Ï¡
 = 
v®
.
d©a
 + v®.
Ën
;

1956 
b
->
memÜy
 = 
v®
.
Ën
 ? 1 : 0;

1957 
b
->
Ï¡_buf
 = (
r
 =ðr->
maš
) ? 1 : 0;

1958 
b
->
Ï¡_š_chaš
 = 1;

1960 
out
.
buf
 = 
b
;

1961 
out
.
Ãxt
 = 
NULL
;

1963 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

1965 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

1966  
rc
;

1969  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

1970 
	}
}

1973 
ngx_št_t


1974 
	$ngx_h‰p_£nd_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

1976 ià(
r
->
po¡_aùiÚ
) {

1977  
NGX_OK
;

1980 ià(
r
->
h—d”_£Á
) {

1981 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

1983  
NGX_ERROR
;

1986 ià(
r
->
”r_¡©us
) {

1987 
r
->
h—d”s_out
.
¡©us
 =„->
”r_¡©us
;

1988 
r
->
h—d”s_out
.
¡©us_lše
.
Ën
 = 0;

1991  
	`ngx_h‰p_tÝ_h—d”_fž‹r
(
r
);

1992 
	}
}

1995 
ngx_št_t


1996 
	$ngx_h‰p_ouut_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

1998 
ngx_št_t
 
rc
;

1999 
ngx_cÚÃùiÚ_t
 *
c
;

2001 
c
 = 
r
->
cÚÃùiÚ
;

2003 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2004 "h‰°ouuˆfž‹¸\"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

2006 
rc
 = 
	`ngx_h‰p_tÝ_body_fž‹r
(
r
, 
š
);

2008 ià(
rc
 =ð
NGX_ERROR
) {

2010 
c
->
”rÜ
 = 1;

2013  
rc
;

2014 
	}
}

2017 
u_ch¬
 *

2018 
	$ngx_h‰p_m­_uri_to_·th
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
·th
,

2019 
size_t
 *
roÙ_Ëngth
, size_ˆ
»£rved
)

2021 
u_ch¬
 *
Ï¡
;

2022 
size_t
 
®Ÿs
;

2023 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2025 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2027 
®Ÿs
 = 
þcf
->alias;

2029 ià(
®Ÿs
 && !
r
->
v®id_loÿtiÚ
) {

2030 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

2032 "wh”URI wa »wr™‹n", &
þcf
->
Çme
);

2033  
NULL
;

2036 ià(
þcf
->
roÙ_Ëngths
 =ð
NULL
) {

2038 *
roÙ_Ëngth
 = 
þcf
->
roÙ
.
Ën
;

2040 
·th
->
Ën
 = 
þcf
->
roÙ
.ËÀ+ 
»£rved
 + 
r
->
uri
.ËÀ- 
®Ÿs
 + 1;

2042 
·th
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,…©h->
Ën
);

2043 ià(
·th
->
d©a
 =ð
NULL
) {

2044  
NULL
;

2047 
Ï¡
 = 
	`ngx_cÝy
(
·th
->
d©a
, 
þcf
->
roÙ
.d©a, clcf->roÙ.
Ën
);

2051 ià(
®Ÿs
 =ð
NGX_MAX_SIZE_T_VALUE
) {

2052 
»£rved
 +ð
r
->
add_uri_to_®Ÿs
 ?„->
uri
.
Ën
 + 1 : 1;

2055 
»£rved
 +ð
r
->
uri
.
Ën
 - 
®Ÿs
 + 1;

2058 ià(
	`ngx_h‰p_süt_run
(
r
, 
·th
, 
þcf
->
roÙ_Ëngths
->
–ts
, 
»£rved
,

2059 
þcf
->
roÙ_v®ues
->
–ts
)

2060 =ð
NULL
)

2062  
NULL
;

2065 ià(
	`ngx_g‘_fuÎ_Çme
(
r
->
poÞ
, (
ngx_¡r_t
 *è&
ngx_cyþe
->
´efix
, 
·th
)

2066 !ð
NGX_OK
)

2068  
NULL
;

2071 *
roÙ_Ëngth
 = 
·th
->
Ën
 - 
»£rved
;

2072 
Ï¡
 = 
·th
->
d©a
 + *
roÙ_Ëngth
;

2074 ià(
®Ÿs
 =ð
NGX_MAX_SIZE_T_VALUE
) {

2075 ià(!
r
->
add_uri_to_®Ÿs
) {

2076 *
Ï¡
 = '\0';

2077  
Ï¡
;

2080 
®Ÿs
 = 0;

2084 
Ï¡
 = 
	`ngx_ýy¡º
Öa¡, 
r
->
uri
.
d©a
 + 
®Ÿs
,„->uri.
Ën
 -‡lias + 1);

2086  
Ï¡
;

2087 
	}
}

2090 
ngx_št_t


2091 
	$ngx_h‰p_auth_basic_u£r
(
ngx_h‰p_»que¡_t
 *
r
)

2093 
ngx_¡r_t
 
auth
, 
’coded
;

2094 
ngx_ušt_t
 
Ën
;

2096 ià(
r
->
h—d”s_š
.
u£r
.
Ën
 =ð0 &&„->h—d”s_š.u£r.
d©a
 !ð
NULL
) {

2097  
NGX_DECLINED
;

2100 ià(
r
->
h—d”s_š
.
authÜiz©iÚ
 =ð
NULL
) {

2101 
r
->
h—d”s_š
.
u£r
.
d©a
 = (
u_ch¬
 *) "";

2102  
NGX_DECLINED
;

2105 
’coded
 = 
r
->
h—d”s_š
.
authÜiz©iÚ
->
v®ue
;

2107 ià(
’coded
.
Ën
 < ("Basic ") - 1

2108 || 
	`ngx_¡ºÿ£cmp
(
’coded
.
d©a
, (
u_ch¬
 *) "Basic ",

2112 
r
->
h—d”s_š
.
u£r
.
d©a
 = (
u_ch¬
 *) "";

2113  
NGX_DECLINED
;

2116 
’coded
.
Ën
 -= ("Basic ") - 1;

2117 
’coded
.
d©a
 += ("Basic ") - 1;

2119 
’coded
.
Ën
 &&ƒncoded.
d©a
[0] == ' ') {

2120 
’coded
.
Ën
--;

2121 
’coded
.
d©a
++;

2124 ià(
’coded
.
Ën
 == 0) {

2125 
r
->
h—d”s_š
.
u£r
.
d©a
 = (
u_ch¬
 *) "";

2126  
NGX_DECLINED
;

2129 
auth
.
Ën
 = 
	`ngx_ba£64_decoded_Ëngth
(
’coded
.len);

2130 
auth
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,‡uth.
Ën
 + 1);

2131 ià(
auth
.
d©a
 =ð
NULL
) {

2132  
NGX_ERROR
;

2135 ià(
	`ngx_decode_ba£64
(&
auth
, &
’coded
è!ð
NGX_OK
) {

2136 
r
->
h—d”s_š
.
u£r
.
d©a
 = (
u_ch¬
 *) "";

2137  
NGX_DECLINED
;

2140 
auth
.
d©a
[auth.
Ën
] = '\0';

2142 
Ën
 = 0;†’ < 
auth
.len;†en++) {

2143 ià(
auth
.
d©a
[
Ën
] == ':') {

2148 ià(
Ën
 =ð0 ||†’ =ð
auth
.len) {

2149 
r
->
h—d”s_š
.
u£r
.
d©a
 = (
u_ch¬
 *) "";

2150  
NGX_DECLINED
;

2153 
r
->
h—d”s_š
.
u£r
.
Ën
 =†en;

2154 
r
->
h—d”s_š
.
u£r
.
d©a
 = 
auth
.data;

2155 
r
->
h—d”s_š
.
·sswd
.
Ën
 = 
auth
.len -†en - 1;

2156 
r
->
h—d”s_š
.
·sswd
.
d©a
 = &
auth
.d©a[
Ën
 + 1];

2158  
NGX_OK
;

2159 
	}
}

2162 #ià(
NGX_HTTP_GZIP
)

2164 
ngx_št_t


2165 
	$ngx_h‰p_gz_ok
(
ngx_h‰p_»que¡_t
 *
r
)

2167 
time_t
 
d©e
, 
expœes
;

2168 
ngx_ušt_t
 
p
;

2169 
ngx_¬¿y_t
 *
cc
;

2170 
ngx_bË_–t_t
 *
e
, *
d
, *
«
;

2171 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2173 
r
->
gz_‹¡ed
 = 1;

2175 ià(
r
 !ðr->
maš
) {

2176  
NGX_DECLINED
;

2179 #ià(
NGX_HTTP_SPDY
)

2180 ià(
r
->
¥dy_¡»am
) {

2181 
r
->
gz_ok
 = 1;

2182  
NGX_OK
;

2186 
«
 = 
r
->
h—d”s_š
.
acû±_’codšg
;

2187 ià(
«
 =ð
NULL
) {

2188  
NGX_DECLINED
;

2191 ià(
«
->
v®ue
.
Ën
 < ("gzip") - 1) {

2192  
NGX_DECLINED
;

2204 ià(
	`ngx_memcmp
(
«
->
v®ue
.
d©a
, "gzip,", 5) != 0

2205 && 
	`ngx_h‰p_gz_acû±_’codšg
(&
«
->
v®ue
è!ð
NGX_OK
)

2207  
NGX_DECLINED
;

2210 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2212 ià(
r
->
h—d”s_š
.
ms›6
 && 
þcf
->
gz_di§bË_ms›6
) {

2213  
NGX_DECLINED
;

2216 ià(
r
->
h‰p_v”siÚ
 < 
þcf
->
gz_h‰p_v”siÚ
) {

2217  
NGX_DECLINED
;

2220 ià(
r
->
h—d”s_š
.
vŸ
 =ð
NULL
) {

2221 
ok
;

2224 
p
 = 
þcf
->
gz_´ox›d
;

2226 ià(
p
 & 
NGX_HTTP_GZIP_PROXIED_OFF
) {

2227  
NGX_DECLINED
;

2230 ià(
p
 & 
NGX_HTTP_GZIP_PROXIED_ANY
) {

2231 
ok
;

2234 ià(
r
->
h—d”s_š
.
authÜiz©iÚ
 && (
p
 & 
NGX_HTTP_GZIP_PROXIED_AUTH
)) {

2235 
ok
;

2238 
e
 = 
r
->
h—d”s_out
.
expœes
;

2240 ià(
e
) {

2242 ià(!(
p
 & 
NGX_HTTP_GZIP_PROXIED_EXPIRED
)) {

2243  
NGX_DECLINED
;

2246 
expœes
 = 
	`ngx_h‰p_·r£_time
(
e
->
v®ue
.
d©a
,ƒ->v®ue.
Ën
);

2247 ià(
expœes
 =ð
NGX_ERROR
) {

2248  
NGX_DECLINED
;

2251 
d
 = 
r
->
h—d”s_out
.
d©e
;

2253 ià(
d
) {

2254 
d©e
 = 
	`ngx_h‰p_·r£_time
(
d
->
v®ue
.
d©a
, d->v®ue.
Ën
);

2255 ià(
d©e
 =ð
NGX_ERROR
) {

2256  
NGX_DECLINED
;

2260 
d©e
 = 
	`ngx_time
();

2263 ià(
expœes
 < 
d©e
) {

2264 
ok
;

2267  
NGX_DECLINED
;

2270 
cc
 = &
r
->
h—d”s_out
.
ÿche_cÚŒÞ
;

2272 ià(
cc
->
–ts
) {

2274 ià((
p
 & 
NGX_HTTP_GZIP_PROXIED_NO_CACHE
)

2275 && 
	`ngx_h‰p_·r£_muÉi_h—d”_lšes
(
cc
, &
ngx_h‰p_gz_no_ÿche
,

2276 
NULL
)

2279 
ok
;

2282 ià((
p
 & 
NGX_HTTP_GZIP_PROXIED_NO_STORE
)

2283 && 
	`ngx_h‰p_·r£_muÉi_h—d”_lšes
(
cc
, &
ngx_h‰p_gz_no_¡Üe
,

2284 
NULL
)

2287 
ok
;

2290 ià((
p
 & 
NGX_HTTP_GZIP_PROXIED_PRIVATE
)

2291 && 
	`ngx_h‰p_·r£_muÉi_h—d”_lšes
(
cc
, &
ngx_h‰p_gz_´iv©e
,

2292 
NULL
)

2295 
ok
;

2298  
NGX_DECLINED
;

2301 ià((
p
 & 
NGX_HTTP_GZIP_PROXIED_NO_LM
è&& 
r
->
h—d”s_out
.
Ï¡_modif›d
) {

2302  
NGX_DECLINED
;

2305 ià((
p
 & 
NGX_HTTP_GZIP_PROXIED_NO_ETAG
è&& 
r
->
h—d”s_out
.
‘ag
) {

2306  
NGX_DECLINED
;

2309 
ok
:

2311 #ià(
NGX_PCRE
)

2313 ià(
þcf
->
gz_di§bË
 && 
r
->
h—d”s_š
.
u£r_ag’t
) {

2315 ià(
	`ngx_»gex_exec_¬¿y
(
þcf
->
gz_di§bË
,

2316 &
r
->
h—d”s_š
.
u£r_ag’t
->
v®ue
,

2317 
r
->
cÚÃùiÚ
->
log
)

2318 !ð
NGX_DECLINED
)

2320  
NGX_DECLINED
;

2326 
r
->
gz_ok
 = 1;

2328  
NGX_OK
;

2329 
	}
}

2339 
ngx_št_t


2340 
	$ngx_h‰p_gz_acû±_’codšg
(
ngx_¡r_t
 *
«
)

2342 
u_ch¬
 *
p
, *
¡¬t
, *
Ï¡
;

2344 
¡¬t
 = 
«
->
d©a
;

2345 
Ï¡
 = 
¡¬t
 + 
«
->
Ën
;

2348 
p
 = 
	`ngx_¡rÿ£¡º
(
¡¬t
, "gzip", 4 - 1);

2349 ià(
p
 =ð
NULL
) {

2350  
NGX_DECLINED
;

2353 ià(
p
 =ð
¡¬t
 || (*(p - 1) == ',' || *(p - 1) == ' ')) {

2357 
¡¬t
 = 
p
 + 4;

2360 
p
 += 4;

2362 
p
 < 
Ï¡
) {

2363 *
p
++) {

2365  
NGX_OK
;

2367 
quªt™y
;

2371  
NGX_DECLINED
;

2375  
NGX_OK
;

2377 
quªt™y
:

2379 
p
 < 
Ï¡
) {

2380 *
p
++) {

2383 
equ®
;

2387  
NGX_DECLINED
;

2391  
NGX_OK
;

2393 
equ®
:

2395 ià(
p
 + 2 > 
Ï¡
 || *p++ != '=') {

2396  
NGX_DECLINED
;

2399 ià(
	`ngx_h‰p_gz_quªt™y
(
p
, 
Ï¡
) == 0) {

2400  
NGX_DECLINED
;

2403  
NGX_OK
;

2404 
	}
}

2407 
ngx_ušt_t


2408 
	$ngx_h‰p_gz_quªt™y
(
u_ch¬
 *
p
, u_ch¬ *
Ï¡
)

2410 
u_ch¬
 
c
;

2411 
ngx_ušt_t
 
n
, 
q
;

2413 
c
 = *
p
++;

2415 ià(
c
 != '0' && c != '1') {

2419 
q
 = (
c
 - '0') * 100;

2421 ià(
p
 =ð
Ï¡
) {

2422  
q
;

2425 
c
 = *
p
++;

2427 ià(
c
 == ',' || c == ' ') {

2428  
q
;

2431 ià(
c
 != '.') {

2435 
n
 = 0;

2437 
p
 < 
Ï¡
) {

2438 
c
 = *
p
++;

2440 ià(
c
 == ',' || c == ' ') {

2444 ià(
c
 >= '0' && c <= '9') {

2445 
q
 +ð
c
 - '0';

2446 
n
++;

2453 ià(
q
 > 100 || 
n
 > 3) {

2457  
q
;

2458 
	}
}

2463 
ngx_št_t


2464 
	$ngx_h‰p_sub»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

2465 
ngx_¡r_t
 *
uri
,‚gx_¡r_ˆ*
¬gs
, 
ngx_h‰p_»que¡_t
 **
p¤
,

2466 
ngx_h‰p_po¡_sub»que¡_t
 *
ps
, 
ngx_ušt_t
 
æags
)

2468 
ngx_time_t
 *

;

2469 
ngx_cÚÃùiÚ_t
 *
c
;

2470 
ngx_h‰p_»que¡_t
 *
¤
;

2471 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2472 
ngx_h‰p_po¡pÚed_»que¡_t
 *
´
, *
p
;

2474 
r
->
maš
->
sub»que¡s
--;

2476 ià(
r
->
maš
->
sub»que¡s
 == 0) {

2477 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2478 "sub»que¡ cyþwhž´oûssšg \"%V\"", 
uri
);

2479 
r
->
maš
->
sub»que¡s
 = 1;

2480  
NGX_ERROR
;

2483 
¤
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_»que¡_t
));

2484 ià(
¤
 =ð
NULL
) {

2485  
NGX_ERROR
;

2488 
¤
->
sigÇtu»
 = 
NGX_HTTP_MODULE
;

2490 
c
 = 
r
->
cÚÃùiÚ
;

2491 
¤
->
cÚÃùiÚ
 = 
c
;

2493 
¤
->
ùx
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

2494 ià(
¤
->
ùx
 =ð
NULL
) {

2495  
NGX_ERROR
;

2498 ià(
	`ngx_li¡_š™
(&
¤
->
h—d”s_out
.
h—d”s
, 
r
->
poÞ
, 20,

2499 (
ngx_bË_–t_t
))

2500 !ð
NGX_OK
)

2502  
NGX_ERROR
;

2505 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2506 
¤
->
maš_cÚf
 = 
cscf
->
ùx
->main_conf;

2507 
¤
->
¤v_cÚf
 = 
cscf
->
ùx
->srv_conf;

2508 
¤
->
loc_cÚf
 = 
cscf
->
ùx
->loc_conf;

2510 
¤
->
poÞ
 = 
r
->pool;

2512 
¤
->
h—d”s_š
 = 
r
->headers_in;

2514 
	`ngx_h‰p_þ—r_cÚ‹Á_Ëngth
(
¤
);

2515 
	`ngx_h‰p_þ—r_acû±_¿nges
(
¤
);

2516 
	`ngx_h‰p_þ—r_Ï¡_modif›d
(
¤
);

2518 
¤
->
»que¡_body
 = 
r
->request_body;

2520 #ià(
NGX_HTTP_SPDY
)

2521 
¤
->
¥dy_¡»am
 = 
r
->spdy_stream;

2524 
¤
->
m‘hod
 = 
NGX_HTTP_GET
;

2525 
¤
->
h‰p_v”siÚ
 = 
r
->http_version;

2527 
¤
->
»que¡_lše
 = 
r
->request_line;

2528 
¤
->
uri
 = *uri;

2530 ià(
¬gs
) {

2531 
¤
->
¬gs
 = *args;

2534 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2535 "h‰°sub»que¡ \"%V?%V\"", 
uri
, &
¤
->
¬gs
);

2537 
¤
->
sub»que¡_š_memÜy
 = (
æags
 & 
NGX_HTTP_SUBREQUEST_IN_MEMORY
) != 0;

2538 
¤
->
wa™ed
 = (
æags
 & 
NGX_HTTP_SUBREQUEST_WAITED
) != 0;

2540 
¤
->
uÅ¬£d_uri
 = 
r
->unparsed_uri;

2541 
¤
->
m‘hod_Çme
 = 
ngx_h‰p_cÜe_g‘_m‘hod
;

2542 
¤
->
h‰p_´ÙocÞ
 = 
r
->http_protocol;

2544 
	`ngx_h‰p_£t_ex‹n
(
¤
);

2546 
¤
->
maš
 = 
r
->main;

2547 
¤
->
·»Á
 = 
r
;

2548 
¤
->
po¡_sub»que¡
 = 
ps
;

2549 
¤
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

2550 
¤
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_hªdËr
;

2552 ià(
c
->
d©a
 =ð
r
 &&„->
po¡pÚed
 =ð
NULL
) {

2553 
c
->
d©a
 = 
¤
;

2556 
¤
->
v¬ŸbËs
 = 
r
->variables;

2558 
¤
->
log_hªdËr
 = 
r
->log_handler;

2560 
´
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_po¡pÚed_»que¡_t
));

2561 ià(
´
 =ð
NULL
) {

2562  
NGX_ERROR
;

2565 
´
->
»que¡
 = 
¤
;

2566 
´
->
out
 = 
NULL
;

2567 
´
->
Ãxt
 = 
NULL
;

2569 ià(
r
->
po¡pÚed
) {

2570 
p
 = 
r
->
po¡pÚed
;…->
Ãxt
;… =…->next) { }

2571 
p
->
Ãxt
 = 
´
;

2574 
r
->
po¡pÚed
 = 
´
;

2577 
¤
->
š‹º®
 = 1;

2579 
¤
->
disÿrd_body
 = 
r
->discard_body;

2580 
¤
->
ex³ù_‹¡ed
 = 1;

2581 
¤
->
maš_fž‹r_Ãed_š_memÜy
 = 
r
->main_filter_need_in_memory;

2583 
¤
->
uri_chªges
 = 
NGX_HTTP_MAX_URI_CHANGES
 + 1;

2585 

 = 
	`ngx_timeofday
();

2586 
¤
->
¡¬t_£c
 = 

->
£c
;

2587 
¤
->
¡¬t_m£c
 = 

->
m£c
;

2589 
r
->
maš
->
couÁ
++;

2591 *
p¤
 = 
¤
;

2593  
	`ngx_h‰p_po¡_»que¡
(
¤
, 
NULL
);

2594 
	}
}

2597 
ngx_št_t


2598 
	$ngx_h‰p_š‹º®_»dœeù
(
ngx_h‰p_»que¡_t
 *
r
,

2599 
ngx_¡r_t
 *
uri
,‚gx_¡r_ˆ*
¬gs
)

2601 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2603 
r
->
uri_chªges
--;

2605 ià(
r
->
uri_chªges
 == 0) {

2606 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2608 "whžš‹º®ly„edœeùšgØ\"%V\"", 
uri
);

2610 
r
->
maš
->
couÁ
++;

2611 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2612  
NGX_DONE
;

2615 
r
->
uri
 = *uri;

2617 ià(
¬gs
) {

2618 
r
->
¬gs
 = *args;

2621 
	`ngx_¡r_nuÎ
(&
r
->
¬gs
);

2624 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2625 "š‹º®„edœeù: \"%V?%V\"", 
uri
, &
r
->
¬gs
);

2627 
	`ngx_h‰p_£t_ex‹n
(
r
);

2630 
	`ngx_memz”o
(
r
->
ùx
, (*è* 
ngx_h‰p_max_moduË
);

2632 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2633 
r
->
loc_cÚf
 = 
cscf
->
ùx
->loc_conf;

2635 
	`ngx_h‰p_upd©e_loÿtiÚ_cÚfig
(
r
);

2637 #ià(
NGX_HTTP_CACHE
)

2638 
r
->
ÿche
 = 
NULL
;

2641 
r
->
š‹º®
 = 1;

2642 
r
->
v®id_uÅ¬£d_uri
 = 0;

2643 
r
->
add_uri_to_®Ÿs
 = 0;

2644 
r
->
maš
->
couÁ
++;

2646 
	`ngx_h‰p_hªdËr
(
r
);

2648  
NGX_DONE
;

2649 
	}
}

2652 
ngx_št_t


2653 
	$ngx_h‰p_Çmed_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
Çme
)

2655 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2656 
ngx_h‰p_cÜe_loc_cÚf_t
 **
þcå
;

2657 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

2659 
r
->
maš
->
couÁ
++;

2660 
r
->
uri_chªges
--;

2662 ià(
r
->
uri_chªges
 == 0) {

2663 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2665 "whž»dœeùØÇmed†oÿtiÚ \"%V\"", 
Çme
);

2667 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2668  
NGX_DONE
;

2671 ià(
r
->
uri
.
Ën
 == 0) {

2672 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2673 "em±y URI iÀ»dœeùØÇmed†oÿtiÚ \"%V\"", 
Çme
);

2675 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2676  
NGX_DONE
;

2679 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2681 ià(
cscf
->
Çmed_loÿtiÚs
) {

2683 
þcå
 = 
cscf
->
Çmed_loÿtiÚs
; *clcfp; clcfp++) {

2685 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2686 "‹¡†oÿtiÚ: \"%V\"", &(*
þcå
)->
Çme
);

2688 ià(
Çme
->
Ën
 !ð(*
þcå
)->name.len

2689 || 
	`ngx_¡ºcmp
(
Çme
->
d©a
, (*
þcå
)->Çme.d©a,‚ame->
Ën
) != 0)

2694 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2696 
Çme
, &
r
->
uri
, &r->
¬gs
);

2698 
r
->
š‹º®
 = 1;

2699 
r
->
cÚ‹Á_hªdËr
 = 
NULL
;

2700 
r
->
uri_chªged
 = 0;

2701 
r
->
loc_cÚf
 = (*
þcå
)->loc_conf;

2704 
	`ngx_memz”o
(
r
->
ùx
, (*è* 
ngx_h‰p_max_moduË
);

2706 
	`ngx_h‰p_upd©e_loÿtiÚ_cÚfig
(
r
);

2708 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2710 
r
->
pha£_hªdËr
 = 
cmcf
->
pha£_’gše
.
loÿtiÚ_»wr™e_šdex
;

2712 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_cÜe_run_pha£s
;

2713 
	`ngx_h‰p_cÜe_run_pha£s
(
r
);

2715  
NGX_DONE
;

2719 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

2720 "could‚Ù fšd‚amed†oÿtiÚ \"%V\"", 
Çme
);

2722 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2724  
NGX_DONE
;

2725 
	}
}

2728 
ngx_h‰p_þ—nup_t
 *

2729 
	$ngx_h‰p_þ—nup_add
(
ngx_h‰p_»que¡_t
 *
r
, 
size_t
 
size
)

2731 
ngx_h‰p_þ—nup_t
 *
þn
;

2733 
r
 =„->
maš
;

2735 
þn
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_þ—nup_t
));

2736 ià(
þn
 =ð
NULL
) {

2737  
NULL
;

2740 ià(
size
) {

2741 
þn
->
d©a
 = 
	`ngx_·Îoc
(
r
->
poÞ
, 
size
);

2742 ià(
þn
->
d©a
 =ð
NULL
) {

2743  
NULL
;

2747 
þn
->
d©a
 = 
NULL
;

2750 
þn
->
hªdËr
 = 
NULL
;

2751 
þn
->
Ãxt
 = 
r
->
þ—nup
;

2753 
r
->
þ—nup
 = 
þn
;

2755 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2756 "h‰°þ—nu°add: %p", 
þn
);

2758  
þn
;

2759 
	}
}

2762 
ngx_št_t


2763 
	$ngx_h‰p_£t_di§bË_symlšks
(
ngx_h‰p_»que¡_t
 *
r
,

2764 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, 
ngx_¡r_t
 *
·th
, 
ngx_Ý’_fže_šfo_t
 *
of
)

2766 #ià(
NGX_HAVE_OPENAT
)

2767 
u_ch¬
 *
p
;

2768 
ngx_¡r_t
 
äom
;

2770 
of
->
di§bË_symlšks
 = 
þcf
->disable_symlinks;

2772 ià(
þcf
->
di§bË_symlšks_äom
 =ð
NULL
) {

2773  
NGX_OK
;

2776 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
þcf
->
di§bË_symlšks_äom
, &
äom
)

2777 !ð
NGX_OK
)

2779  
NGX_ERROR
;

2782 ià(
äom
.
Ën
 == 0

2783 || 
äom
.
Ën
 > 
·th
->len

2784 || 
	`ngx_memcmp
(
·th
->
d©a
, 
äom
.d©a, from.
Ën
) != 0)

2786  
NGX_OK
;

2789 ià(
äom
.
Ën
 =ð
·th
->len) {

2790 
of
->
di§bË_symlšks
 = 
NGX_DISABLE_SYMLINKS_OFF
;

2791  
NGX_OK
;

2794 
p
 = 
·th
->
d©a
 + 
äom
.
Ën
;

2796 ià(*
p
 == '/') {

2797 
of
->
di§bË_symlšks_äom
 = 
äom
.
Ën
;

2798  
NGX_OK
;

2801 
p
--;

2803 ià(*
p
 == '/') {

2804 
of
->
di§bË_symlšks_äom
 = 
äom
.
Ën
 - 1;

2808  
NGX_OK
;

2809 
	}
}

2812 
ngx_št_t


2813 
	$ngx_h‰p_g‘_fÜw¬ded_addr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_addr_t
 *
addr
,

2814 
ngx_¬¿y_t
 *
h—d”s
, 
ngx_¡r_t
 *
v®ue
,‚gx_¬¿y_ˆ*
´ox›s
,

2815 
»cursive
)

2817 
ngx_št_t
 
rc
;

2818 
ngx_ušt_t
 
i
, 
found
;

2819 
ngx_bË_–t_t
 **
h
;

2821 ià(
h—d”s
 =ð
NULL
) {

2822  
	`ngx_h‰p_g‘_fÜw¬ded_addr_š‹º®
(
r
, 
addr
, 
v®ue
->
d©a
,

2823 
v®ue
->
Ën
, 
´ox›s
,

2824 
»cursive
);

2827 
i
 = 
h—d”s
->
ÃÉs
;

2828 
h
 = 
h—d”s
->
–ts
;

2830 
rc
 = 
NGX_DECLINED
;

2832 
found
 = 0;

2834 
i
-- > 0) {

2835 
rc
 = 
	`ngx_h‰p_g‘_fÜw¬ded_addr_š‹º®
(
r
, 
addr
, 
h
[
i
]->
v®ue
.
d©a
,

2836 
h
[
i
]->
v®ue
.
Ën
, 
´ox›s
,

2837 
»cursive
);

2839 ià(!
»cursive
) {

2843 ià(
rc
 =ð
NGX_DECLINED
 && 
found
) {

2844 
rc
 = 
NGX_DONE
;

2848 ià(
rc
 !ð
NGX_OK
) {

2852 
found
 = 1;

2855  
rc
;

2856 
	}
}

2859 
ngx_št_t


2860 
	$ngx_h‰p_g‘_fÜw¬ded_addr_š‹º®
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_addr_t
 *
addr
,

2861 
u_ch¬
 *
xff
, 
size_t
 
xfæ’
, 
ngx_¬¿y_t
 *
´ox›s
, 
»cursive
)

2863 
u_ch¬
 *
p
;

2864 
š_addr_t
 
šaddr
;

2865 
ngx_št_t
 
rc
;

2866 
ngx_addr_t
 
·ddr
;

2867 
ngx_cidr_t
 *
cidr
;

2868 
ngx_ušt_t
 
çmžy
, 
i
;

2869 #ià(
NGX_HAVE_INET6
)

2870 
ngx_ušt_t
 
n
;

2871 
š6_addr
 *
šaddr6
;

2874 #ià(
NGX_SUPPRESS_WARN
)

2875 
šaddr
 = 0;

2876 #ià(
NGX_HAVE_INET6
)

2877 
šaddr6
 = 
NULL
;

2881 
çmžy
 = 
addr
->
sockaddr
->
§_çmžy
;

2883 ià(
çmžy
 =ð
AF_INET
) {

2884 
šaddr
 = ((
sockaddr_š
 *è
addr
->
sockaddr
)->
sš_addr
.
s_addr
;

2887 #ià(
NGX_HAVE_INET6
)

2888 ià(
çmžy
 =ð
AF_INET6
) {

2889 
šaddr6
 = &((
sockaddr_š6
 *è
addr
->
sockaddr
)->
sš6_addr
;

2891 ià(
	`IN6_IS_ADDR_V4MAPPED
(
šaddr6
)) {

2892 
çmžy
 = 
AF_INET
;

2894 
p
 = 
šaddr6
->
s6_addr
;

2896 
šaddr
 = 
p
[12] << 24;

2897 
šaddr
 +ð
p
[13] << 16;

2898 
šaddr
 +ð
p
[14] << 8;

2899 
šaddr
 +ð
p
[15];

2901 
šaddr
 = 
	`htÚl
(inaddr);

2906 
cidr
 = 
´ox›s
->
–ts
, 
i
 = 0; i <…rox›s->
ÃÉs
; i++) {

2907 ià(
cidr
[
i
].
çmžy
 != family) {

2908 
Ãxt
;

2911 
çmžy
) {

2913 #ià(
NGX_HAVE_INET6
)

2914 
AF_INET6
:

2915 
n
 = 0;‚ < 16;‚++) {

2916 ià((
šaddr6
->
s6_addr
[
n
] & 
cidr
[
i
].
u
.
š6
.
mask
.s6_addr[n])

2917 !ð
cidr
[
i
].
u
.
š6
.
addr
.
s6_addr
[
n
])

2919 
Ãxt
;

2925 #ià(
NGX_HAVE_UNIX_DOMAIN
)

2926 
AF_UNIX
:

2931 ià((
šaddr
 & 
cidr
[
i
].
u
.
š
.
mask
è!ðcidr[i].u.š.
addr
) {

2932 
Ãxt
;

2937 
p
 = 
xff
 + 
xfæ’
 - 1;… > xff;…--, xfflen--) {

2938 ià(*
p
 != ' ' && *p != ',') {

2943  ; 
p
 > 
xff
;…--) {

2944 ià(*
p
 == ' ' || *p == ',') {

2945 
p
++;

2950 ià(
	`ngx_·r£_addr
(
r
->
poÞ
, &
·ddr
, 
p
, 
xfæ’
 - (°- 
xff
)è!ð
NGX_OK
) {

2951  
NGX_DECLINED
;

2954 *
addr
 = 
·ddr
;

2956 ià(
»cursive
 && 
p
 > 
xff
) {

2957 
rc
 = 
	`ngx_h‰p_g‘_fÜw¬ded_addr_š‹º®
(
r
, 
addr
, 
xff
, 
p
 - 1 - xff,

2958 
´ox›s
, 1);

2960 ià(
rc
 =ð
NGX_DECLINED
) {

2961  
NGX_DONE
;

2965  
rc
;

2968  
NGX_OK
;

2970 
Ãxt
:

2974  
NGX_DECLINED
;

2975 
	}
}

2979 
	$ngx_h‰p_cÜe_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
dummy
)

2981 *
rv
;

2982 *
mcÚf
;

2983 
ngx_ušt_t
 
i
;

2984 
ngx_cÚf_t
 
pcf
;

2985 
ngx_h‰p_moduË_t
 *
moduË
;

2986 
sockaddr_š
 *
sš
;

2987 
ngx_h‰p_cÚf_ùx_t
 *
ùx
, *
h‰p_ùx
;

2988 
ngx_h‰p_li¡’_Ýt_t
 
lsÝt
;

2989 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
, **
cscå
;

2990 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

2992 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÚf_ùx_t
));

2993 ià(
ùx
 =ð
NULL
) {

2994  
NGX_CONF_ERROR
;

2997 
h‰p_ùx
 = 
cf
->
ùx
;

2998 
ùx
->
maš_cÚf
 = 
h‰p_ùx
->main_conf;

3002 
ùx
->
¤v_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

3003 ià(
ùx
->
¤v_cÚf
 =ð
NULL
) {

3004  
NGX_CONF_ERROR
;

3009 
ùx
->
loc_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

3010 ià(
ùx
->
loc_cÚf
 =ð
NULL
) {

3011  
NGX_CONF_ERROR
;

3014 
i
 = 0; 
ngx_moduËs
[i]; i++) {

3015 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

3019 
moduË
 = 
ngx_moduËs
[
i
]->
ùx
;

3021 ià(
moduË
->
ü—‹_¤v_cÚf
) {

3022 
mcÚf
 = 
moduË
->
	`ü—‹_¤v_cÚf
(
cf
);

3023 ià(
mcÚf
 =ð
NULL
) {

3024  
NGX_CONF_ERROR
;

3027 
ùx
->
¤v_cÚf
[
ngx_moduËs
[
i
]->
ùx_šdex
] = 
mcÚf
;

3030 ià(
moduË
->
ü—‹_loc_cÚf
) {

3031 
mcÚf
 = 
moduË
->
	`ü—‹_loc_cÚf
(
cf
);

3032 ià(
mcÚf
 =ð
NULL
) {

3033  
NGX_CONF_ERROR
;

3036 
ùx
->
loc_cÚf
[
ngx_moduËs
[
i
]->
ùx_šdex
] = 
mcÚf
;

3043 
cscf
 = 
ùx
->
¤v_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

3044 
cscf
->
ùx
 = ctx;

3047 
cmcf
 = 
ùx
->
maš_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

3049 
cscå
 = 
	`ngx_¬¿y_push
(&
cmcf
->
£rv”s
);

3050 ià(
cscå
 =ð
NULL
) {

3051  
NGX_CONF_ERROR
;

3054 *
cscå
 = 
cscf
;

3059 
pcf
 = *
cf
;

3060 
cf
->
ùx
 = ctx;

3061 
cf
->
cmd_ty³
 = 
NGX_HTTP_SRV_CONF
;

3063 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

3065 *
cf
 = 
pcf
;

3067 ià(
rv
 =ð
NGX_CONF_OK
 && !
cscf
->
li¡’
) {

3068 
	`ngx_memz”o
(&
lsÝt
, (
ngx_h‰p_li¡’_Ýt_t
));

3070 
sš
 = &
lsÝt
.
u
.
sockaddr_š
;

3072 
sš
->
sš_çmžy
 = 
AF_INET
;

3073 #ià(
NGX_WIN32
)

3074 
sš
->
sš_pÜt
 = 
	`htÚs
(80);

3076 
sš
->
sš_pÜt
 = 
	`htÚs
((
	`g‘uid
() == 0) ? 80 : 8000);

3078 
sš
->
sš_addr
.
s_addr
 = 
INADDR_ANY
;

3080 
lsÝt
.
sockËn
 = (
sockaddr_š
);

3082 
lsÝt
.
backlog
 = 
NGX_LISTEN_BACKLOG
;

3083 
lsÝt
.
rcvbuf
 = -1;

3084 
lsÝt
.
¢dbuf
 = -1;

3085 #ià(
NGX_HAVE_SETFIB
)

3086 
lsÝt
.
£tfib
 = -1;

3088 #ià(
NGX_HAVE_TCP_FASTOPEN
)

3089 
lsÝt
.
ç¡Ý’
 = -1;

3091 
lsÝt
.
wždÿrd
 = 1;

3093 (è
	`ngx_sock_ÁÝ
(&
lsÝt
.
u
.
sockaddr
,†sÝt.
sockËn
,†sÝt.
addr
,

3094 
NGX_SOCKADDR_STRLEN
, 1);

3096 ià(
	`ngx_h‰p_add_li¡’
(
cf
, 
cscf
, &
lsÝt
è!ð
NGX_OK
) {

3097  
NGX_CONF_ERROR
;

3101  
rv
;

3102 
	}
}

3106 
	$ngx_h‰p_cÜe_loÿtiÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
dummy
)

3108 *
rv
;

3109 
u_ch¬
 *
mod
;

3110 
size_t
 
Ën
;

3111 
ngx_¡r_t
 *
v®ue
, *
Çme
;

3112 
ngx_ušt_t
 
i
;

3113 
ngx_cÚf_t
 
§ve
;

3114 
ngx_h‰p_moduË_t
 *
moduË
;

3115 
ngx_h‰p_cÚf_ùx_t
 *
ùx
, *
pùx
;

3116 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, *
pþcf
;

3118 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÚf_ùx_t
));

3119 ià(
ùx
 =ð
NULL
) {

3120  
NGX_CONF_ERROR
;

3123 
pùx
 = 
cf
->
ùx
;

3124 
ùx
->
maš_cÚf
 = 
pùx
->main_conf;

3125 
ùx
->
¤v_cÚf
 = 
pùx
->srv_conf;

3127 
ùx
->
loc_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

3128 ià(
ùx
->
loc_cÚf
 =ð
NULL
) {

3129  
NGX_CONF_ERROR
;

3132 
i
 = 0; 
ngx_moduËs
[i]; i++) {

3133 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

3137 
moduË
 = 
ngx_moduËs
[
i
]->
ùx
;

3139 ià(
moduË
->
ü—‹_loc_cÚf
) {

3140 
ùx
->
loc_cÚf
[
ngx_moduËs
[
i
]->
ùx_šdex
] =

3141 
moduË
->
	`ü—‹_loc_cÚf
(
cf
);

3142 ià(
ùx
->
loc_cÚf
[
ngx_moduËs
[
i
]->
ùx_šdex
] =ð
NULL
) {

3143  
NGX_CONF_ERROR
;

3148 
þcf
 = 
ùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

3149 
þcf
->
loc_cÚf
 = 
ùx
->loc_conf;

3151 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3153 ià(
cf
->
¬gs
->
ÃÉs
 == 3) {

3155 
Ën
 = 
v®ue
[1].len;

3156 
mod
 = 
v®ue
[1].
d©a
;

3157 
Çme
 = &
v®ue
[2];

3159 ià(
Ën
 =ð1 && 
mod
[0] == '=') {

3161 
þcf
->
Çme
 = *name;

3162 
þcf
->
exaù_m©ch
 = 1;

3164 } ià(
Ën
 =ð2 && 
mod
[0] == '^' && mod[1] == '~') {

3166 
þcf
->
Çme
 = *name;

3167 
þcf
->
nÜegex
 = 1;

3169 } ià(
Ën
 =ð1 && 
mod
[0] == '~') {

3171 ià(
	`ngx_h‰p_cÜe_»gex_loÿtiÚ
(
cf
, 
þcf
, 
Çme
, 0è!ð
NGX_OK
) {

3172  
NGX_CONF_ERROR
;

3175 } ià(
Ën
 =ð2 && 
mod
[0] == '~' && mod[1] == '*') {

3177 ià(
	`ngx_h‰p_cÜe_»gex_loÿtiÚ
(
cf
, 
þcf
, 
Çme
, 1è!ð
NGX_OK
) {

3178  
NGX_CONF_ERROR
;

3182 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3183 "šv®id†oÿtiÚ modif›¸\"%V\"", &
v®ue
[1]);

3184  
NGX_CONF_ERROR
;

3189 
Çme
 = &
v®ue
[1];

3191 ià(
Çme
->
d©a
[0] == '=') {

3193 
þcf
->
Çme
.
Ën
 =‚ame->len - 1;

3194 
þcf
->
Çme
.
d©a
 =‚ame->data + 1;

3195 
þcf
->
exaù_m©ch
 = 1;

3197 } ià(
Çme
->
d©a
[0] == '^' &&‚ame->data[1] == '~') {

3199 
þcf
->
Çme
.
Ën
 =‚ame->len - 2;

3200 
þcf
->
Çme
.
d©a
 =‚ame->data + 2;

3201 
þcf
->
nÜegex
 = 1;

3203 } ià(
Çme
->
d©a
[0] == '~') {

3205 
Çme
->
Ën
--;

3206 
Çme
->
d©a
++;

3208 ià(
Çme
->
d©a
[0] == '*') {

3210 
Çme
->
Ën
--;

3211 
Çme
->
d©a
++;

3213 ià(
	`ngx_h‰p_cÜe_»gex_loÿtiÚ
(
cf
, 
þcf
, 
Çme
, 1è!ð
NGX_OK
) {

3214  
NGX_CONF_ERROR
;

3218 ià(
	`ngx_h‰p_cÜe_»gex_loÿtiÚ
(
cf
, 
þcf
, 
Çme
, 0è!ð
NGX_OK
) {

3219  
NGX_CONF_ERROR
;

3225 
þcf
->
Çme
 = *name;

3227 ià(
Çme
->
d©a
[0] == '@') {

3228 
þcf
->
Çmed
 = 1;

3233 
pþcf
 = 
pùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

3235 ià(
pþcf
->
Çme
.
Ën
) {

3240 
þcf
->
´ev_loÿtiÚ
 = 
pþcf
;

3243 ià(
pþcf
->
exaù_m©ch
) {

3244 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3247 &
þcf
->
Çme
, &
pþcf
->name);

3248  
NGX_CONF_ERROR
;

3251 ià(
pþcf
->
Çmed
) {

3252 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3255 &
þcf
->
Çme
, &
pþcf
->name);

3256  
NGX_CONF_ERROR
;

3259 ià(
þcf
->
Çmed
) {

3260 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3263 &
þcf
->
Çme
);

3264  
NGX_CONF_ERROR
;

3267 
Ën
 = 
pþcf
->
Çme
.len;

3269 #ià(
NGX_PCRE
)

3270 ià(
þcf
->
»gex
 =ð
NULL


3271 && 
	`ngx_fž’ame_cmp
(
þcf
->
Çme
.
d©a
, 
pþcf
->Çme.d©a, 
Ën
) != 0)

3273 ià(
	`ngx_fž’ame_cmp
(
þcf
->
Çme
.
d©a
, 
pþcf
->Çme.d©a, 
Ën
) != 0)

3276 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3278 &
þcf
->
Çme
, &
pþcf
->name);

3279  
NGX_CONF_ERROR
;

3283 ià(
	`ngx_h‰p_add_loÿtiÚ
(
cf
, &
pþcf
->
loÿtiÚs
, 
þcf
è!ð
NGX_OK
) {

3284  
NGX_CONF_ERROR
;

3287 
§ve
 = *
cf
;

3288 
cf
->
ùx
 = ctx;

3289 
cf
->
cmd_ty³
 = 
NGX_HTTP_LOC_CONF
;

3291 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

3293 *
cf
 = 
§ve
;

3295  
rv
;

3296 
	}
}

3299 
ngx_št_t


3300 
	$ngx_h‰p_cÜe_»gex_loÿtiÚ
(
ngx_cÚf_t
 *
cf
, 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
,

3301 
ngx_¡r_t
 *
»gex
, 
ngx_ušt_t
 
ÿ£Ëss
)

3303 #ià(
NGX_PCRE
)

3304 
ngx_»gex_compže_t
 
rc
;

3305 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

3307 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

3309 
rc
.
·‰”n
 = *
»gex
;

3310 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

3311 
rc
.
”r
.
d©a
 = 
”r¡r
;

3313 #ià(
NGX_HAVE_CASELESS_FILESYSTEM
)

3314 
rc
.
ÝtiÚs
 = 
NGX_REGEX_CASELESS
;

3316 
rc
.
ÝtiÚs
 = 
ÿ£Ëss
 ? 
NGX_REGEX_CASELESS
 : 0;

3319 
þcf
->
»gex
 = 
	`ngx_h‰p_»gex_compže
(
cf
, &
rc
);

3320 ià(
þcf
->
»gex
 =ð
NULL
) {

3321  
NGX_ERROR
;

3324 
þcf
->
Çme
 = *
»gex
;

3326  
NGX_OK
;

3330 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3332 
»gex
);

3333  
NGX_ERROR
;

3336 
	}
}

3340 
	$ngx_h‰p_cÜe_ty³s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3342 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

3344 *
rv
;

3345 
ngx_cÚf_t
 
§ve
;

3347 ià(
þcf
->
ty³s
 =ð
NULL
) {

3348 
þcf
->
ty³s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 64, (
ngx_hash_key_t
));

3349 ià(
þcf
->
ty³s
 =ð
NULL
) {

3350  
NGX_CONF_ERROR
;

3354 
§ve
 = *
cf
;

3355 
cf
->
hªdËr
 = 
ngx_h‰p_cÜe_ty³
;

3356 
cf
->
hªdËr_cÚf
 = 
cÚf
;

3358 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

3360 *
cf
 = 
§ve
;

3362  
rv
;

3363 
	}
}

3367 
	$ngx_h‰p_cÜe_ty³
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
dummy
, *
cÚf
)

3369 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

3371 
ngx_¡r_t
 *
v®ue
, *
cÚ‹Á_ty³
, *
Þd
;

3372 
ngx_ušt_t
 
i
, 
n
, 
hash
;

3373 
ngx_hash_key_t
 *
ty³
;

3375 
v®ue
 = 
cf
->
¬gs
->
–ts
;

3377 ià(
	`ngx_¡rcmp
(
v®ue
[0].
d©a
, "include") == 0) {

3378 ià(
cf
->
¬gs
->
ÃÉs
 != 2) {

3379 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3382  
NGX_CONF_ERROR
;

3385  
	`ngx_cÚf_šþude
(
cf
, 
dummy
, 
cÚf
);

3388 
cÚ‹Á_ty³
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_¡r_t
));

3389 ià(
cÚ‹Á_ty³
 =ð
NULL
) {

3390  
NGX_CONF_ERROR
;

3393 *
cÚ‹Á_ty³
 = 
v®ue
[0];

3395 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

3397 
hash
 = 
	`ngx_hash_¡¾ow
(
v®ue
[
i
].
d©a
, v®ue[i].d©a, v®ue[i].
Ën
);

3399 
ty³
 = 
þcf
->
ty³s
->
–ts
;

3400 
n
 = 0;‚ < 
þcf
->
ty³s
->
ÃÉs
;‚++) {

3401 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, 
ty³
[
n
].
key
.data) == 0) {

3402 
Þd
 = 
ty³
[
n
].
v®ue
;

3403 
ty³
[
n
].
v®ue
 = 
cÚ‹Á_ty³
;

3405 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

3409 &
v®ue
[
i
], 
cÚ‹Á_ty³
, 
Þd
);

3410 
Ãxt
;

3415 
ty³
 = 
	`ngx_¬¿y_push
(
þcf
->
ty³s
);

3416 ià(
ty³
 =ð
NULL
) {

3417  
NGX_CONF_ERROR
;

3420 
ty³
->
key
 = 
v®ue
[
i
];

3421 
ty³
->
key_hash
 = 
hash
;

3422 
ty³
->
v®ue
 = 
cÚ‹Á_ty³
;

3424 
Ãxt
:

3428  
NGX_CONF_OK
;

3429 
	}
}

3432 
ngx_št_t


3433 
	$ngx_h‰p_cÜe_´ecÚfigu¿tiÚ
(
ngx_cÚf_t
 *
cf
)

3435  
	`ngx_h‰p_v¬ŸbËs_add_cÜe_v¬s
(
cf
);

3436 
	}
}

3440 
	$ngx_h‰p_cÜe_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

3442 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

3444 
cmcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÜe_maš_cÚf_t
));

3445 ià(
cmcf
 =ð
NULL
) {

3446  
NULL
;

3449 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
£rv”s
, 
cf
->
poÞ
, 4,

3450 (
ngx_h‰p_cÜe_¤v_cÚf_t
 *))

3451 !ð
NGX_OK
)

3453  
NULL
;

3456 
cmcf
->
£rv”_Çmes_hash_max_size
 = 
NGX_CONF_UNSET_UINT
;

3457 
cmcf
->
£rv”_Çmes_hash_buck‘_size
 = 
NGX_CONF_UNSET_UINT
;

3459 
cmcf
->
v¬ŸbËs_hash_max_size
 = 
NGX_CONF_UNSET_UINT
;

3460 
cmcf
->
v¬ŸbËs_hash_buck‘_size
 = 
NGX_CONF_UNSET_UINT
;

3462  
cmcf
;

3463 
	}
}

3467 
	$ngx_h‰p_cÜe_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
)

3469 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
 = 
cÚf
;

3471 
	`ngx_cÚf_š™_ušt_v®ue
(
cmcf
->
£rv”_Çmes_hash_max_size
, 512);

3472 
	`ngx_cÚf_š™_ušt_v®ue
(
cmcf
->
£rv”_Çmes_hash_buck‘_size
,

3473 
ngx_ÿch–še_size
);

3475 
cmcf
->
£rv”_Çmes_hash_buck‘_size
 =

3476 
	`ngx_®ign
(
cmcf
->
£rv”_Çmes_hash_buck‘_size
, 
ngx_ÿch–še_size
);

3479 
	`ngx_cÚf_š™_ušt_v®ue
(
cmcf
->
v¬ŸbËs_hash_max_size
, 1024);

3480 
	`ngx_cÚf_š™_ušt_v®ue
(
cmcf
->
v¬ŸbËs_hash_buck‘_size
, 64);

3482 
cmcf
->
v¬ŸbËs_hash_buck‘_size
 =

3483 
	`ngx_®ign
(
cmcf
->
v¬ŸbËs_hash_buck‘_size
, 
ngx_ÿch–še_size
);

3485 ià(
cmcf
->
nÿ±u»s
) {

3486 
cmcf
->
nÿ±u»s
 = (cmcf->ncaptures + 1) * 3;

3489  
NGX_CONF_OK
;

3490 
	}
}

3494 
	$ngx_h‰p_cÜe_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

3496 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

3498 
cscf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÜe_¤v_cÚf_t
));

3499 ià(
cscf
 =ð
NULL
) {

3500  
NULL
;

3509 ià(
	`ngx_¬¿y_š™
(&
cscf
->
£rv”_Çmes
, 
cf
->
‹mp_poÞ
, 4,

3510 (
ngx_h‰p_£rv”_Çme_t
))

3511 !ð
NGX_OK
)

3513  
NULL
;

3516 
cscf
->
cÚÃùiÚ_poÞ_size
 = 
NGX_CONF_UNSET_SIZE
;

3517 
cscf
->
»que¡_poÞ_size
 = 
NGX_CONF_UNSET_SIZE
;

3518 
cscf
->
þ›Á_h—d”_timeout
 = 
NGX_CONF_UNSET_MSEC
;

3519 
cscf
->
þ›Á_h—d”_bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

3520 
cscf
->
ignÜe_šv®id_h—d”s
 = 
NGX_CONF_UNSET
;

3521 
cscf
->
m”ge_¦ashes
 = 
NGX_CONF_UNSET
;

3522 
cscf
->
und”scÜes_š_h—d”s
 = 
NGX_CONF_UNSET
;

3524  
cscf
;

3525 
	}
}

3529 
	$ngx_h‰p_cÜe_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

3531 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

3532 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cÚf
 = 
chžd
;

3534 
ngx_¡r_t
 
Çme
;

3535 
ngx_h‰p_£rv”_Çme_t
 *
¢
;

3539 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
cÚÃùiÚ_poÞ_size
,

3540 
´ev
->
cÚÃùiÚ_poÞ_size
, 256);

3541 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
»que¡_poÞ_size
,

3542 
´ev
->
»que¡_poÞ_size
, 4096);

3543 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
þ›Á_h—d”_timeout
,

3544 
´ev
->
þ›Á_h—d”_timeout
, 60000);

3545 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
þ›Á_h—d”_bufãr_size
,

3546 
´ev
->
þ›Á_h—d”_bufãr_size
, 1024);

3547 
	`ngx_cÚf_m”ge_bufs_v®ue
(
cÚf
->
Ïrge_þ›Á_h—d”_bufãrs
,

3548 
´ev
->
Ïrge_þ›Á_h—d”_bufãrs
,

3551 ià(
cÚf
->
Ïrge_þ›Á_h—d”_bufãrs
.
size
 < cÚf->
cÚÃùiÚ_poÞ_size
) {

3552 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

3555  
NGX_CONF_ERROR
;

3558 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
ignÜe_šv®id_h—d”s
,

3559 
´ev
->
ignÜe_šv®id_h—d”s
, 1);

3561 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
m”ge_¦ashes
, 
´ev
->merge_slashes, 1);

3563 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
und”scÜes_š_h—d”s
,

3564 
´ev
->
und”scÜes_š_h—d”s
, 0);

3566 ià(
cÚf
->
£rv”_Çmes
.
ÃÉs
 == 0) {

3568 
¢
 = 
	`ngx_¬¿y_push
(&
cÚf
->
£rv”_Çmes
);

3569 #ià(
NGX_PCRE
)

3570 
¢
->
»gex
 = 
NULL
;

3572 
¢
->
£rv”
 = 
cÚf
;

3573 
	`ngx_¡r_£t
(&
¢
->
Çme
, "");

3576 
¢
 = 
cÚf
->
£rv”_Çmes
.
–ts
;

3577 
Çme
 = 
¢
[0].name;

3579 #ià(
NGX_PCRE
)

3580 ià(
¢
->
»gex
) {

3581 
Çme
.
Ën
++;

3582 
Çme
.
d©a
--;

3586 ià(
Çme
.
d©a
[0] == '.') {

3587 
Çme
.
Ën
--;

3588 
Çme
.
d©a
++;

3591 
cÚf
->
£rv”_Çme
.
Ën
 = 
Çme
.len;

3592 
cÚf
->
£rv”_Çme
.
d©a
 = 
	`ngx_p¡rdup
(
cf
->
poÞ
, &
Çme
);

3593 ià(
cÚf
->
£rv”_Çme
.
d©a
 =ð
NULL
) {

3594  
NGX_CONF_ERROR
;

3597  
NGX_CONF_OK
;

3598 
	}
}

3602 
	$ngx_h‰p_cÜe_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

3604 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3606 
þcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÜe_loc_cÚf_t
));

3607 ià(
þcf
 =ð
NULL
) {

3608  
NULL
;

3631 
þcf
->
þ›Á_max_body_size
 = 
NGX_CONF_UNSET
;

3632 
þcf
->
þ›Á_body_bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

3633 
þcf
->
þ›Á_body_timeout
 = 
NGX_CONF_UNSET_MSEC
;

3634 
þcf
->
§tisfy
 = 
NGX_CONF_UNSET_UINT
;

3635 
þcf
->
if_modif›d_sšû
 = 
NGX_CONF_UNSET_UINT
;

3636 
þcf
->
max_¿nges
 = 
NGX_CONF_UNSET_UINT
;

3637 
þcf
->
þ›Á_body_š_fže_Úly
 = 
NGX_CONF_UNSET_UINT
;

3638 
þcf
->
þ›Á_body_š_sšgË_bufãr
 = 
NGX_CONF_UNSET
;

3639 
þcf
->
š‹º®
 = 
NGX_CONF_UNSET
;

3640 
þcf
->
£ndfže
 = 
NGX_CONF_UNSET
;

3641 
þcf
->
£ndfže_max_chunk
 = 
NGX_CONF_UNSET_SIZE
;

3642 #ià(
NGX_HAVE_FILE_AIO
)

3643 
þcf
->
aio
 = 
NGX_CONF_UNSET
;

3645 
þcf
->
»ad_ah—d
 = 
NGX_CONF_UNSET_SIZE
;

3646 
þcf
->
dœeùio
 = 
NGX_CONF_UNSET
;

3647 
þcf
->
dœeùio_®ignm’t
 = 
NGX_CONF_UNSET
;

3648 
þcf
->
tý_nÝush
 = 
NGX_CONF_UNSET
;

3649 
þcf
->
tý_nod–ay
 = 
NGX_CONF_UNSET
;

3650 
þcf
->
£nd_timeout
 = 
NGX_CONF_UNSET_MSEC
;

3651 
þcf
->
£nd_low©
 = 
NGX_CONF_UNSET_SIZE
;

3652 
þcf
->
po¡pÚe_ouut
 = 
NGX_CONF_UNSET_SIZE
;

3653 
þcf
->
lim™_¿‹
 = 
NGX_CONF_UNSET_SIZE
;

3654 
þcf
->
lim™_¿‹_aá”
 = 
NGX_CONF_UNSET_SIZE
;

3655 
þcf
->
k“·live_timeout
 = 
NGX_CONF_UNSET_MSEC
;

3656 
þcf
->
k“·live_h—d”
 = 
NGX_CONF_UNSET
;

3657 
þcf
->
k“·live_»que¡s
 = 
NGX_CONF_UNSET_UINT
;

3658 
þcf
->
lšg”šg_þo£
 = 
NGX_CONF_UNSET_UINT
;

3659 
þcf
->
lšg”šg_time
 = 
NGX_CONF_UNSET_MSEC
;

3660 
þcf
->
lšg”šg_timeout
 = 
NGX_CONF_UNSET_MSEC
;

3661 
þcf
->
»sÞv”_timeout
 = 
NGX_CONF_UNSET_MSEC
;

3662 
þcf
->
»£t_timedout_cÚÃùiÚ
 = 
NGX_CONF_UNSET
;

3663 
þcf
->
£rv”_Çme_š_»dœeù
 = 
NGX_CONF_UNSET
;

3664 
þcf
->
pÜt_š_»dœeù
 = 
NGX_CONF_UNSET
;

3665 
þcf
->
ms›_·ddšg
 = 
NGX_CONF_UNSET
;

3666 
þcf
->
ms›_»äesh
 = 
NGX_CONF_UNSET
;

3667 
þcf
->
log_nÙ_found
 = 
NGX_CONF_UNSET
;

3668 
þcf
->
log_sub»que¡
 = 
NGX_CONF_UNSET
;

3669 
þcf
->
»cursive_”rÜ_·ges
 = 
NGX_CONF_UNSET
;

3670 
þcf
->
£rv”_tok’s
 = 
NGX_CONF_UNSET
;

3671 
þcf
->
chunked_Œªsãr_’codšg
 = 
NGX_CONF_UNSET
;

3672 
þcf
->
‘ag
 = 
NGX_CONF_UNSET
;

3673 
þcf
->
ty³s_hash_max_size
 = 
NGX_CONF_UNSET_UINT
;

3674 
þcf
->
ty³s_hash_buck‘_size
 = 
NGX_CONF_UNSET_UINT
;

3676 
þcf
->
Ý’_fže_ÿche
 = 
NGX_CONF_UNSET_PTR
;

3677 
þcf
->
Ý’_fže_ÿche_v®id
 = 
NGX_CONF_UNSET
;

3678 
þcf
->
Ý’_fže_ÿche_mš_u£s
 = 
NGX_CONF_UNSET_UINT
;

3679 
þcf
->
Ý’_fže_ÿche_”rÜs
 = 
NGX_CONF_UNSET
;

3680 
þcf
->
Ý’_fže_ÿche_ev’ts
 = 
NGX_CONF_UNSET
;

3682 #ià(
NGX_HTTP_GZIP
)

3683 
þcf
->
gz_v¬y
 = 
NGX_CONF_UNSET
;

3684 
þcf
->
gz_h‰p_v”siÚ
 = 
NGX_CONF_UNSET_UINT
;

3685 #ià(
NGX_PCRE
)

3686 
þcf
->
gz_di§bË
 = 
NGX_CONF_UNSET_PTR
;

3688 
þcf
->
gz_di§bË_ms›6
 = 3;

3689 #ià(
NGX_HTTP_DEGRADATION
)

3690 
þcf
->
gz_di§bË_deg¿d©iÚ
 = 3;

3694 #ià(
NGX_HAVE_OPENAT
)

3695 
þcf
->
di§bË_symlšks
 = 
NGX_CONF_UNSET_UINT
;

3696 
þcf
->
di§bË_symlšks_äom
 = 
NGX_CONF_UNSET_PTR
;

3699  
þcf
;

3700 
	}
}

3703 
ngx_¡r_t
 
	gngx_h‰p_cÜe_‹xt_html_ty³
 = 
ngx_¡ršg
("text/html");

3704 
ngx_¡r_t
 
	gngx_h‰p_cÜe_image_gif_ty³
 = 
ngx_¡ršg
("image/gif");

3705 
ngx_¡r_t
 
	gngx_h‰p_cÜe_image_j³g_ty³
 = 
ngx_¡ršg
("image/jpeg");

3707 
ngx_hash_key_t
 
	gngx_h‰p_cÜe_deçuÉ_ty³s
[] = {

3708 { 
ngx_¡ršg
("html"), 0, &
ngx_h‰p_cÜe_‹xt_html_ty³
 },

3709 { 
ngx_¡ršg
("gif"), 0, &
ngx_h‰p_cÜe_image_gif_ty³
 },

3710 { 
ngx_¡ršg
("jpg"), 0, &
ngx_h‰p_cÜe_image_j³g_ty³
 },

3711 { 
ngx_nuÎ_¡ršg
, 0, 
NULL
 }

3716 
	$ngx_h‰p_cÜe_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

3718 
ngx_h‰p_cÜe_loc_cÚf_t
 *
´ev
 = 
·»Á
;

3719 
ngx_h‰p_cÜe_loc_cÚf_t
 *
cÚf
 = 
chžd
;

3721 
ngx_ušt_t
 
i
;

3722 
ngx_hash_key_t
 *
ty³
;

3723 
ngx_hash_š™_t
 
ty³s_hash
;

3725 ià(
cÚf
->
roÙ
.
d©a
 =ð
NULL
) {

3727 
cÚf
->
®Ÿs
 = 
´ev
->alias;

3728 
cÚf
->
roÙ
 = 
´ev
->root;

3729 
cÚf
->
roÙ_Ëngths
 = 
´ev
->root_lengths;

3730 
cÚf
->
roÙ_v®ues
 = 
´ev
->root_values;

3732 ià(
´ev
->
roÙ
.
d©a
 =ð
NULL
) {

3733 
	`ngx_¡r_£t
(&
cÚf
->
roÙ
, "html");

3735 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
cÚf
->
roÙ
, 0è!ð
NGX_OK
) {

3736  
NGX_CONF_ERROR
;

3741 ià(
cÚf
->
po¡_aùiÚ
.
d©a
 =ð
NULL
) {

3742 
cÚf
->
po¡_aùiÚ
 = 
´ev
->post_action;

3745 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
ty³s_hash_max_size
,

3746 
´ev
->
ty³s_hash_max_size
, 1024);

3748 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
ty³s_hash_buck‘_size
,

3749 
´ev
->
ty³s_hash_buck‘_size
, 64);

3751 
cÚf
->
ty³s_hash_buck‘_size
 = 
	`ngx_®ign
(conf->types_hash_bucket_size,

3752 
ngx_ÿch–še_size
);

3759 ià(
´ev
->
ty³s
 &&…»v->
ty³s_hash
.
buck‘s
 =ð
NULL
) {

3761 
ty³s_hash
.
hash
 = &
´ev
->types_hash;

3762 
ty³s_hash
.
key
 = 
ngx_hash_key_lc
;

3763 
ty³s_hash
.
max_size
 = 
cÚf
->
ty³s_hash_max_size
;

3764 
ty³s_hash
.
buck‘_size
 = 
cÚf
->
ty³s_hash_buck‘_size
;

3765 
ty³s_hash
.
Çme
 = "types_hash";

3766 
ty³s_hash
.
poÞ
 = 
cf
->pool;

3767 
ty³s_hash
.
‹mp_poÞ
 = 
NULL
;

3769 ià(
	`ngx_hash_š™
(&
ty³s_hash
, 
´ev
->
ty³s
->
–ts
,…»v->ty³s->
ÃÉs
)

3770 !ð
NGX_OK
)

3772  
NGX_CONF_ERROR
;

3776 ià(
cÚf
->
ty³s
 =ð
NULL
) {

3777 
cÚf
->
ty³s
 = 
´ev
->types;

3778 
cÚf
->
ty³s_hash
 = 
´ev
->types_hash;

3781 ià(
cÚf
->
ty³s
 =ð
NULL
) {

3782 
cÚf
->
ty³s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 3, (
ngx_hash_key_t
));

3783 ià(
cÚf
->
ty³s
 =ð
NULL
) {

3784  
NGX_CONF_ERROR
;

3787 
i
 = 0; 
ngx_h‰p_cÜe_deçuÉ_ty³s
[i].
key
.
Ën
; i++) {

3788 
ty³
 = 
	`ngx_¬¿y_push
(
cÚf
->
ty³s
);

3789 ià(
ty³
 =ð
NULL
) {

3790  
NGX_CONF_ERROR
;

3793 
ty³
->
key
 = 
ngx_h‰p_cÜe_deçuÉ_ty³s
[
i
].key;

3794 
ty³
->
key_hash
 =

3795 
	`ngx_hash_key_lc
(
ngx_h‰p_cÜe_deçuÉ_ty³s
[
i
].
key
.
d©a
,

3796 
ngx_h‰p_cÜe_deçuÉ_ty³s
[
i
].
key
.
Ën
);

3797 
ty³
->
v®ue
 = 
ngx_h‰p_cÜe_deçuÉ_ty³s
[
i
].value;

3801 ià(
cÚf
->
ty³s_hash
.
buck‘s
 =ð
NULL
) {

3803 
ty³s_hash
.
hash
 = &
cÚf
->types_hash;

3804 
ty³s_hash
.
key
 = 
ngx_hash_key_lc
;

3805 
ty³s_hash
.
max_size
 = 
cÚf
->
ty³s_hash_max_size
;

3806 
ty³s_hash
.
buck‘_size
 = 
cÚf
->
ty³s_hash_buck‘_size
;

3807 
ty³s_hash
.
Çme
 = "types_hash";

3808 
ty³s_hash
.
poÞ
 = 
cf
->pool;

3809 
ty³s_hash
.
‹mp_poÞ
 = 
NULL
;

3811 ià(
	`ngx_hash_š™
(&
ty³s_hash
, 
cÚf
->
ty³s
->
–ts
, cÚf->ty³s->
ÃÉs
)

3812 !ð
NGX_OK
)

3814  
NGX_CONF_ERROR
;

3818 ià(
cÚf
->
”rÜ_log
 =ð
NULL
) {

3819 ià(
´ev
->
”rÜ_log
) {

3820 
cÚf
->
”rÜ_log
 = 
´ev
->error_log;

3822 
cÚf
->
”rÜ_log
 = &
cf
->
cyþe
->
Ãw_log
;

3826 ià(
cÚf
->
”rÜ_·ges
 =ð
NULL
 && 
´ev
->error_pages) {

3827 
cÚf
->
”rÜ_·ges
 = 
´ev
->error_pages;

3830 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
deçuÉ_ty³
,

3831 
´ev
->
deçuÉ_ty³
, "text/plain");

3833 
	`ngx_cÚf_m”ge_off_v®ue
(
cÚf
->
þ›Á_max_body_size
,

3834 
´ev
->
þ›Á_max_body_size
, 1 * 1024 * 1024);

3835 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
þ›Á_body_bufãr_size
,

3836 
´ev
->
þ›Á_body_bufãr_size
,

3837 (
size_t
è2 * 
ngx_·gesize
);

3838 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
þ›Á_body_timeout
,

3839 
´ev
->
þ›Á_body_timeout
, 60000);

3841 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
k“·live_di§bË
,

3842 
´ev
->
k“·live_di§bË
,

3843 (
NGX_CONF_BITMASK_SET


3844 |
NGX_HTTP_KEEPALIVE_DISABLE_MSIE6
));

3845 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
§tisfy
, 
´ev
->satisfy,

3846 
NGX_HTTP_SATISFY_ALL
);

3847 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
if_modif›d_sšû
, 
´ev
->if_modified_since,

3848 
NGX_HTTP_IMS_EXACT
);

3849 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
max_¿nges
, 
´ev
->max_ranges,

3850 
NGX_MAX_INT32_VALUE
);

3851 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
þ›Á_body_š_fže_Úly
,

3852 
´ev
->
þ›Á_body_š_fže_Úly
,

3853 
NGX_HTTP_REQUEST_BODY_FILE_OFF
);

3854 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
þ›Á_body_š_sšgË_bufãr
,

3855 
´ev
->
þ›Á_body_š_sšgË_bufãr
, 0);

3856 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
š‹º®
, 
´ev
->internal, 0);

3857 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£ndfže
, 
´ev
->sendfile, 0);

3858 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
£ndfže_max_chunk
,

3859 
´ev
->
£ndfže_max_chunk
, 0);

3860 #ià(
NGX_HAVE_FILE_AIO
)

3861 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
aio
, 
´ev
->aio, 
NGX_HTTP_AIO_OFF
);

3863 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
»ad_ah—d
, 
´ev
->read_ahead, 0);

3864 
	`ngx_cÚf_m”ge_off_v®ue
(
cÚf
->
dœeùio
, 
´ev
->directio,

3865 
NGX_OPEN_FILE_DIRECTIO_OFF
);

3866 
	`ngx_cÚf_m”ge_off_v®ue
(
cÚf
->
dœeùio_®ignm’t
, 
´ev
->directio_alignment,

3868 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
tý_nÝush
, 
´ev
->tcp_nopush, 0);

3869 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
tý_nod–ay
, 
´ev
->tcp_nodelay, 1);

3871 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
£nd_timeout
, 
´ev
->send_timeout, 60000);

3872 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
£nd_low©
, 
´ev
->send_lowat, 0);

3873 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
po¡pÚe_ouut
, 
´ev
->postpone_output,

3875 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
lim™_¿‹
, 
´ev
->limit_rate, 0);

3876 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
lim™_¿‹_aá”
, 
´ev
->limit_rate_after,

3878 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
k“·live_timeout
,

3879 
´ev
->
k“·live_timeout
, 75000);

3880 
	`ngx_cÚf_m”ge_£c_v®ue
(
cÚf
->
k“·live_h—d”
,

3881 
´ev
->
k“·live_h—d”
, 0);

3882 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
k“·live_»que¡s
,

3883 
´ev
->
k“·live_»que¡s
, 100);

3884 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
lšg”šg_þo£
,

3885 
´ev
->
lšg”šg_þo£
, 
NGX_HTTP_LINGERING_ON
);

3886 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
lšg”šg_time
,

3887 
´ev
->
lšg”šg_time
, 30000);

3888 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
lšg”šg_timeout
,

3889 
´ev
->
lšg”šg_timeout
, 5000);

3890 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
»sÞv”_timeout
,

3891 
´ev
->
»sÞv”_timeout
, 30000);

3893 ià(
cÚf
->
»sÞv”
 =ð
NULL
) {

3895 ià(
´ev
->
»sÞv”
 =ð
NULL
) {

3902 
´ev
->
»sÞv”
 = 
	`ngx_»sÞv”_ü—‹
(
cf
, 
NULL
, 0);

3903 ià(
´ev
->
»sÞv”
 =ð
NULL
) {

3904  
NGX_CONF_ERROR
;

3908 
cÚf
->
»sÞv”
 = 
´ev
->resolver;

3911 ià(
	`ngx_cÚf_m”ge_·th_v®ue
(
cf
, &
cÚf
->
þ›Á_body_‹mp_·th
,

3912 
´ev
->
þ›Á_body_‹mp_·th
,

3913 &
ngx_h‰p_þ›Á_‹mp_·th
)

3914 !ð
NGX_OK
)

3916  
NGX_CONF_ERROR
;

3919 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
»£t_timedout_cÚÃùiÚ
,

3920 
´ev
->
»£t_timedout_cÚÃùiÚ
, 0);

3921 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£rv”_Çme_š_»dœeù
,

3922 
´ev
->
£rv”_Çme_š_»dœeù
, 0);

3923 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
pÜt_š_»dœeù
, 
´ev
->port_in_redirect, 1);

3924 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
ms›_·ddšg
, 
´ev
->msie_padding, 1);

3925 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
ms›_»äesh
, 
´ev
->msie_refresh, 0);

3926 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
log_nÙ_found
, 
´ev
->log_not_found, 1);

3927 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
log_sub»que¡
, 
´ev
->log_subrequest, 0);

3928 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
»cursive_”rÜ_·ges
,

3929 
´ev
->
»cursive_”rÜ_·ges
, 0);

3930 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£rv”_tok’s
, 
´ev
->server_tokens, 1);

3931 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
chunked_Œªsãr_’codšg
,

3932 
´ev
->
chunked_Œªsãr_’codšg
, 1);

3933 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
‘ag
, 
´ev
->etag, 1);

3935 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
Ý’_fže_ÿche
,

3936 
´ev
->
Ý’_fže_ÿche
, 
NULL
);

3938 
	`ngx_cÚf_m”ge_£c_v®ue
(
cÚf
->
Ý’_fže_ÿche_v®id
,

3939 
´ev
->
Ý’_fže_ÿche_v®id
, 60);

3941 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
Ý’_fže_ÿche_mš_u£s
,

3942 
´ev
->
Ý’_fže_ÿche_mš_u£s
, 1);

3944 
	`ngx_cÚf_m”ge_£c_v®ue
(
cÚf
->
Ý’_fže_ÿche_”rÜs
,

3945 
´ev
->
Ý’_fže_ÿche_”rÜs
, 0);

3947 
	`ngx_cÚf_m”ge_£c_v®ue
(
cÚf
->
Ý’_fže_ÿche_ev’ts
,

3948 
´ev
->
Ý’_fže_ÿche_ev’ts
, 0);

3949 #ià(
NGX_HTTP_GZIP
)

3951 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
gz_v¬y
, 
´ev
->gzip_vary, 0);

3952 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
gz_h‰p_v”siÚ
, 
´ev
->gzip_http_version,

3953 
NGX_HTTP_VERSION_11
);

3954 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
gz_´ox›d
, 
´ev
->gzip_proxied,

3955 (
NGX_CONF_BITMASK_SET
|
NGX_HTTP_GZIP_PROXIED_OFF
));

3957 #ià(
NGX_PCRE
)

3958 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
gz_di§bË
, 
´ev
->gz_di§bË, 
NULL
);

3961 ià(
cÚf
->
gz_di§bË_ms›6
 == 3) {

3962 
cÚf
->
gz_di§bË_ms›6
 =

3963 (
´ev
->
gz_di§bË_ms›6
 == 3) ? 0 :…rev->gzip_disable_msie6;

3966 #ià(
NGX_HTTP_DEGRADATION
)

3968 ià(
cÚf
->
gz_di§bË_deg¿d©iÚ
 == 3) {

3969 
cÚf
->
gz_di§bË_deg¿d©iÚ
 =

3970 (
´ev
->
gz_di§bË_deg¿d©iÚ
 == 3) ?

3971 0 : 
´ev
->
gz_di§bË_deg¿d©iÚ
;

3977 #ià(
NGX_HAVE_OPENAT
)

3978 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
di§bË_symlšks
, 
´ev
->disable_symlinks,

3979 
NGX_DISABLE_SYMLINKS_OFF
);

3980 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
di§bË_symlšks_äom
,

3981 
´ev
->
di§bË_symlšks_äom
, 
NULL
);

3984  
NGX_CONF_OK
;

3985 
	}
}

3989 
	$ngx_h‰p_cÜe_li¡’
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

3991 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
 = 
cÚf
;

3993 
ngx_¡r_t
 *
v®ue
, 
size
;

3994 
ngx_u¾_t
 
u
;

3995 
ngx_ušt_t
 
n
;

3996 
ngx_h‰p_li¡’_Ýt_t
 
lsÝt
;

3998 
cscf
->
li¡’
 = 1;

4000 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4002 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

4004 
u
.
u¾
 = 
v®ue
[1];

4005 
u
.
li¡’
 = 1;

4006 
u
.
deçuÉ_pÜt
 = 80;

4008 ià(
	`ngx_·r£_u¾
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

4009 ià(
u
.
”r
) {

4010 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4012 
u
.
”r
, &u.
u¾
);

4015  
NGX_CONF_ERROR
;

4018 
	`ngx_memz”o
(&
lsÝt
, (
ngx_h‰p_li¡’_Ýt_t
));

4020 
	`ngx_memýy
(&
lsÝt
.
u
.
sockaddr
, u.sockaddr, u.
sockËn
);

4022 
lsÝt
.
sockËn
 = 
u
.socklen;

4023 
lsÝt
.
backlog
 = 
NGX_LISTEN_BACKLOG
;

4024 
lsÝt
.
rcvbuf
 = -1;

4025 
lsÝt
.
¢dbuf
 = -1;

4026 #ià(
NGX_HAVE_SETFIB
)

4027 
lsÝt
.
£tfib
 = -1;

4029 #ià(
NGX_HAVE_TCP_FASTOPEN
)

4030 
lsÝt
.
ç¡Ý’
 = -1;

4032 
lsÝt
.
wždÿrd
 = 
u
.wildcard;

4033 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

4034 
lsÝt
.
v6Úly
 = 1;

4037 (è
	`ngx_sock_ÁÝ
(&
lsÝt
.
u
.
sockaddr
,†sÝt.
sockËn
,†sÝt.
addr
,

4038 
NGX_SOCKADDR_STRLEN
, 1);

4040 
n
 = 2;‚ < 
cf
->
¬gs
->
ÃÉs
;‚++) {

4042 ià(
	`ngx_¡rcmp
(
v®ue
[
n
].
d©a
, "default_server") == 0

4043 || 
	`ngx_¡rcmp
(
v®ue
[
n
].
d©a
, "default") == 0)

4045 
lsÝt
.
deçuÉ_£rv”
 = 1;

4049 ià(
	`ngx_¡rcmp
(
v®ue
[
n
].
d©a
, "bind") == 0) {

4050 
lsÝt
.
£t
 = 1;

4051 
lsÝt
.
bšd
 = 1;

4055 #ià(
NGX_HAVE_SETFIB
)

4056 ià(
	`ngx_¡ºcmp
(
v®ue
[
n
].
d©a
, "setfib=", 7) == 0) {

4057 
lsÝt
.
£tfib
 = 
	`ngx_©oi
(
v®ue
[
n
].
d©a
 + 7, v®ue[n].
Ën
 - 7);

4058 
lsÝt
.
£t
 = 1;

4059 
lsÝt
.
bšd
 = 1;

4061 ià(
lsÝt
.
£tfib
 =ð
NGX_ERROR
) {

4062 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4063 "šv®id s‘fib \"%V\"", &
v®ue
[
n
]);

4064  
NGX_CONF_ERROR
;

4071 #ià(
NGX_HAVE_TCP_FASTOPEN
)

4072 ià(
	`ngx_¡ºcmp
(
v®ue
[
n
].
d©a
, "fastopen=", 9) == 0) {

4073 
lsÝt
.
ç¡Ý’
 = 
	`ngx_©oi
(
v®ue
[
n
].
d©a
 + 9, v®ue[n].
Ën
 - 9);

4074 
lsÝt
.
£t
 = 1;

4075 
lsÝt
.
bšd
 = 1;

4077 ià(
lsÝt
.
ç¡Ý’
 =ð
NGX_ERROR
) {

4078 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4079 "šv®id fa¡Ý’ \"%V\"", &
v®ue
[
n
]);

4080  
NGX_CONF_ERROR
;

4087 ià(
	`ngx_¡ºcmp
(
v®ue
[
n
].
d©a
, "backlog=", 8) == 0) {

4088 
lsÝt
.
backlog
 = 
	`ngx_©oi
(
v®ue
[
n
].
d©a
 + 8, v®ue[n].
Ën
 - 8);

4089 
lsÝt
.
£t
 = 1;

4090 
lsÝt
.
bšd
 = 1;

4092 ià(
lsÝt
.
backlog
 =ð
NGX_ERROR
 ||†sopt.backlog == 0) {

4093 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4094 "šv®id backlog \"%V\"", &
v®ue
[
n
]);

4095  
NGX_CONF_ERROR
;

4101 ià(
	`ngx_¡ºcmp
(
v®ue
[
n
].
d©a
, "rcvbuf=", 7) == 0) {

4102 
size
.
Ën
 = 
v®ue
[
n
].len - 7;

4103 
size
.
d©a
 = 
v®ue
[
n
].data + 7;

4105 
lsÝt
.
rcvbuf
 = 
	`ngx_·r£_size
(&
size
);

4106 
lsÝt
.
£t
 = 1;

4107 
lsÝt
.
bšd
 = 1;

4109 ià(
lsÝt
.
rcvbuf
 =ð
NGX_ERROR
) {

4110 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4111 "šv®id„cvbuà\"%V\"", &
v®ue
[
n
]);

4112  
NGX_CONF_ERROR
;

4118 ià(
	`ngx_¡ºcmp
(
v®ue
[
n
].
d©a
, "sndbuf=", 7) == 0) {

4119 
size
.
Ën
 = 
v®ue
[
n
].len - 7;

4120 
size
.
d©a
 = 
v®ue
[
n
].data + 7;

4122 
lsÝt
.
¢dbuf
 = 
	`ngx_·r£_size
(&
size
);

4123 
lsÝt
.
£t
 = 1;

4124 
lsÝt
.
bšd
 = 1;

4126 ià(
lsÝt
.
¢dbuf
 =ð
NGX_ERROR
) {

4127 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4128 "šv®id sndbuà\"%V\"", &
v®ue
[
n
]);

4129  
NGX_CONF_ERROR
;

4135 ià(
	`ngx_¡ºcmp
(
v®ue
[
n
].
d©a
, "accept_filter=", 14) == 0) {

4136 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
SO_ACCEPTFILTER
)

4137 
lsÝt
.
acû±_fž‹r
 = (*è&
v®ue
[
n
].
d©a
[14];

4138 
lsÝt
.
£t
 = 1;

4139 
lsÝt
.
bšd
 = 1;

4141 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4144 &
v®ue
[
n
]);

4149 ià(
	`ngx_¡rcmp
(
v®ue
[
n
].
d©a
, "deferred") == 0) {

4150 #ià(
NGX_HAVE_DEFERRED_ACCEPT
 && 
defšed
 
TCP_DEFER_ACCEPT
)

4151 
lsÝt
.
deã¼ed_acû±
 = 1;

4152 
lsÝt
.
£t
 = 1;

4153 
lsÝt
.
bšd
 = 1;

4155 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4162 ià(
	`ngx_¡ºcmp
(
v®ue
[
n
].
d©a
, "ipv6only=o", 10) == 0) {

4163 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

4164 
sockaddr
 *
§
;

4166 
§
 = &
lsÝt
.
u
.
sockaddr
;

4168 ià(
§
->
§_çmžy
 =ð
AF_INET6
) {

4170 ià(
	`ngx_¡rcmp
(&
v®ue
[
n
].
d©a
[10], "n") == 0) {

4171 
lsÝt
.
v6Úly
 = 1;

4173 } ià(
	`ngx_¡rcmp
(&
v®ue
[
n
].
d©a
[10], "ff") == 0) {

4174 
lsÝt
.
v6Úly
 = 0;

4177 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4179 &
v®ue
[
n
].
d©a
[9]);

4180  
NGX_CONF_ERROR
;

4183 
lsÝt
.
£t
 = 1;

4184 
lsÝt
.
bšd
 = 1;

4187 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4189 "Ú‡dd¸\"%s\", ignÜed", 
lsÝt
.
addr
);

4194 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4197  
NGX_CONF_ERROR
;

4201 ià(
	`ngx_¡rcmp
(
v®ue
[
n
].
d©a
, "ssl") == 0) {

4202 #ià(
NGX_HTTP_SSL
)

4203 
lsÝt
.
s¦
 = 1;

4206 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4209  
NGX_CONF_ERROR
;

4213 ià(
	`ngx_¡rcmp
(
v®ue
[
n
].
d©a
, "spdy") == 0) {

4214 #ià(
NGX_HTTP_SPDY
)

4215 
lsÝt
.
¥dy
 = 1;

4218 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4221  
NGX_CONF_ERROR
;

4225 ià(
	`ngx_¡ºcmp
(
v®ue
[
n
].
d©a
, "so_keepalive=", 13) == 0) {

4227 ià(
	`ngx_¡rcmp
(&
v®ue
[
n
].
d©a
[13], "on") == 0) {

4228 
lsÝt
.
so_k“·live
 = 1;

4230 } ià(
	`ngx_¡rcmp
(&
v®ue
[
n
].
d©a
[13], "off") == 0) {

4231 
lsÝt
.
so_k“·live
 = 2;

4235 #ià(
NGX_HAVE_KEEPALIVE_TUNABLE
)

4236 
u_ch¬
 *
p
, *
’d
;

4237 
ngx_¡r_t
 
s
;

4239 
’d
 = 
v®ue
[
n
].
d©a
 + v®ue[n].
Ën
;

4240 
s
.
d©a
 = 
v®ue
[
n
].data + 13;

4242 
p
 = 
	`ngx_¡¾chr
(
s
.
d©a
, 
’d
, ':');

4243 ià(
p
 =ð
NULL
) {

4244 
p
 = 
’d
;

4247 ià(
p
 > 
s
.
d©a
) {

4248 
s
.
Ën
 = 
p
 - s.
d©a
;

4250 
lsÝt
.
tý_k“pidË
 = 
	`ngx_·r£_time
(&
s
, 1);

4251 ià(
lsÝt
.
tý_k“pidË
 =ð(
time_t
è
NGX_ERROR
) {

4252 
šv®id_so_k“·live
;

4256 
s
.
d©a
 = (
p
 < 
’d
) ? (p + 1) :ƒnd;

4258 
p
 = 
	`ngx_¡¾chr
(
s
.
d©a
, 
’d
, ':');

4259 ià(
p
 =ð
NULL
) {

4260 
p
 = 
’d
;

4263 ià(
p
 > 
s
.
d©a
) {

4264 
s
.
Ën
 = 
p
 - s.
d©a
;

4266 
lsÝt
.
tý_k“pštvl
 = 
	`ngx_·r£_time
(&
s
, 1);

4267 ià(
lsÝt
.
tý_k“pštvl
 =ð(
time_t
è
NGX_ERROR
) {

4268 
šv®id_so_k“·live
;

4272 
s
.
d©a
 = (
p
 < 
’d
) ? (p + 1) :ƒnd;

4274 ià(
s
.
d©a
 < 
’d
) {

4275 
s
.
Ën
 = 
’d
 - s.
d©a
;

4277 
lsÝt
.
tý_k“pút
 = 
	`ngx_©oi
(
s
.
d©a
, s.
Ën
);

4278 ià(
lsÝt
.
tý_k“pút
 =ð
NGX_ERROR
) {

4279 
šv®id_so_k“·live
;

4283 ià(
lsÝt
.
tý_k“pidË
 =ð0 &&†sÝt.
tý_k“pštvl
 == 0

4284 && 
lsÝt
.
tý_k“pút
 == 0)

4286 
šv®id_so_k“·live
;

4289 
lsÝt
.
so_k“·live
 = 1;

4293 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4296  
NGX_CONF_ERROR
;

4301 
lsÝt
.
£t
 = 1;

4302 
lsÝt
.
bšd
 = 1;

4306 #ià(
NGX_HAVE_KEEPALIVE_TUNABLE
)

4307 
šv®id_so_k“·live
:

4309 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4311 &
v®ue
[
n
].
d©a
[13]);

4312  
NGX_CONF_ERROR
;

4316 ià(
	`ngx_¡rcmp
(
v®ue
[
n
].
d©a
, "proxy_protocol") == 0) {

4317 
lsÝt
.
´oxy_´ÙocÞ
 = 1;

4321 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4322 "šv®id…¬am‘” \"%V\"", &
v®ue
[
n
]);

4323  
NGX_CONF_ERROR
;

4326 ià(
	`ngx_h‰p_add_li¡’
(
cf
, 
cscf
, &
lsÝt
è=ð
NGX_OK
) {

4327  
NGX_CONF_OK
;

4330  
NGX_CONF_ERROR
;

4331 
	}
}

4335 
	$ngx_h‰p_cÜe_£rv”_Çme
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4337 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
 = 
cÚf
;

4339 
u_ch¬
 
ch
;

4340 
ngx_¡r_t
 *
v®ue
;

4341 
ngx_ušt_t
 
i
;

4342 
ngx_h‰p_£rv”_Çme_t
 *
¢
;

4344 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4346 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

4348 
ch
 = 
v®ue
[
i
].
d©a
[0];

4350 ià((
ch
 =ð'*' && (
v®ue
[
i
].
Ën
 < 3 || v®ue[i].
d©a
[1] != '.'))

4351 || (
ch
 =ð'.' && 
v®ue
[
i
].
Ën
 < 2))

4353 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4354 "£rv”‚am\"%V\" i šv®id", &
v®ue
[
i
]);

4355  
NGX_CONF_ERROR
;

4358 ià(
	`ngx_¡rchr
(
v®ue
[
i
].
d©a
, '/')) {

4359 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

4361 &
v®ue
[
i
]);

4364 
¢
 = 
	`ngx_¬¿y_push
(&
cscf
->
£rv”_Çmes
);

4365 ià(
¢
 =ð
NULL
) {

4366  
NGX_CONF_ERROR
;

4369 #ià(
NGX_PCRE
)

4370 
¢
->
»gex
 = 
NULL
;

4372 
¢
->
£rv”
 = 
cscf
;

4374 ià(
	`ngx_¡rÿ£cmp
(
v®ue
[
i
].
d©a
, (
u_ch¬
 *) "$hostname") == 0) {

4375 
¢
->
Çme
 = 
cf
->
cyþe
->
ho¡Çme
;

4378 
¢
->
Çme
 = 
v®ue
[
i
];

4381 ià(
v®ue
[
i
].
d©a
[0] != '~') {

4382 
	`ngx_¡¾ow
(
¢
->
Çme
.
d©a
, sn->Çme.d©a, sn->Çme.
Ën
);

4386 #ià(
NGX_PCRE
)

4388 
u_ch¬
 *
p
;

4389 
ngx_»gex_compže_t
 
rc
;

4390 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

4392 ià(
v®ue
[
i
].
Ën
 == 1) {

4393 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4394 "em±y„egex iÀ£rv”‚am\"%V\"", &
v®ue
[
i
]);

4395  
NGX_CONF_ERROR
;

4398 
v®ue
[
i
].
Ën
--;

4399 
v®ue
[
i
].
d©a
++;

4401 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

4403 
rc
.
·‰”n
 = 
v®ue
[
i
];

4404 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

4405 
rc
.
”r
.
d©a
 = 
”r¡r
;

4407 
p
 = 
v®ue
[
i
].
d©a
;… < v®ue[i].d©¨+ v®ue[i].
Ën
;…++) {

4408 ià(*
p
 >= 'A' && *p <= 'Z') {

4409 
rc
.
ÝtiÚs
 = 
NGX_REGEX_CASELESS
;

4414 
¢
->
»gex
 = 
	`ngx_h‰p_»gex_compže
(
cf
, &
rc
);

4415 ià(
¢
->
»gex
 =ð
NULL
) {

4416  
NGX_CONF_ERROR
;

4419 
¢
->
Çme
 = 
v®ue
[
i
];

4420 
cscf
->
ÿ±u»s
 = (
rc
.captures > 0);

4423 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4425 "»quœe PCRE†ib¿ry", &
v®ue
[
i
]);

4427  
NGX_CONF_ERROR
;

4431  
NGX_CONF_OK
;

4432 
	}
}

4436 
	$ngx_h‰p_cÜe_roÙ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4438 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

4440 
ngx_¡r_t
 *
v®ue
;

4441 
ngx_št_t
 
®Ÿs
;

4442 
ngx_ušt_t
 
n
;

4443 
ngx_h‰p_süt_compže_t
 
sc
;

4445 
®Ÿs
 = (
cmd
->
Çme
.
Ën
 == ("alias") - 1) ? 1 : 0;

4447 ià(
þcf
->
roÙ
.
d©a
) {

4449 ià((
þcf
->
®Ÿs
 != 0) ==‡lias) {

4450 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4452 &
cmd
->
Çme
);

4454 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4457 &
cmd
->
Çme
, 
þcf
->
®Ÿs
 ? "alias" : "root");

4460  
NGX_CONF_ERROR
;

4463 ià(
þcf
->
Çmed
 && 
®Ÿs
) {

4464 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4468  
NGX_CONF_ERROR
;

4471 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4473 ià(
	`ngx_¡r¡r
(
v®ue
[1].
d©a
, "$document_root")

4474 || 
	`ngx_¡r¡r
(
v®ue
[1].
d©a
, "${document_root}"))

4476 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4479 &
cmd
->
Çme
);

4481  
NGX_CONF_ERROR
;

4484 ià(
	`ngx_¡r¡r
(
v®ue
[1].
d©a
, "$realpath_root")

4485 || 
	`ngx_¡r¡r
(
v®ue
[1].
d©a
, "${realpath_root}"))

4487 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4490 &
cmd
->
Çme
);

4492  
NGX_CONF_ERROR
;

4495 
þcf
->
®Ÿs
 =‡lŸ ? clcf->
Çme
.
Ën
 : 0;

4496 
þcf
->
roÙ
 = 
v®ue
[1];

4498 ià(!
®Ÿs
 && 
þcf
->
roÙ
.
d©a
[þcf->roÙ.
Ën
 - 1] == '/') {

4499 
þcf
->
roÙ
.
Ën
--;

4502 ià(
þcf
->
roÙ
.
d©a
[0] != '$') {

4503 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
þcf
->
roÙ
, 0è!ð
NGX_OK
) {

4504  
NGX_CONF_ERROR
;

4508 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
þcf
->
roÙ
);

4510 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

4511 
sc
.
v¬ŸbËs
 = 
n
;

4513 #ià(
NGX_PCRE
)

4514 ià(
®Ÿs
 && 
þcf
->
»gex
) {

4515 
þcf
->
®Ÿs
 = 
NGX_MAX_SIZE_T_VALUE
;

4516 
n
 = 1;

4520 ià(
n
) {

4521 
sc
.
cf
 = cf;

4522 
sc
.
sourû
 = &
þcf
->
roÙ
;

4523 
sc
.
Ëngths
 = &
þcf
->
roÙ_Ëngths
;

4524 
sc
.
v®ues
 = &
þcf
->
roÙ_v®ues
;

4525 
sc
.
com¶‘e_Ëngths
 = 1;

4526 
sc
.
com¶‘e_v®ues
 = 1;

4528 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

4529  
NGX_CONF_ERROR
;

4533  
NGX_CONF_OK
;

4534 
	}
}

4537 
ngx_h‰p_m‘hod_Çme_t
 
	gngx_m‘hods_Çmes
[] = {

4538 { (
u_ch¬
 *è"GET", (
ušt32_t
è~
NGX_HTTP_GET
 },

4539 { (
u_ch¬
 *è"HEAD", (
ušt32_t
è~
NGX_HTTP_HEAD
 },

4540 { (
u_ch¬
 *è"POST", (
ušt32_t
è~
NGX_HTTP_POST
 },

4541 { (
u_ch¬
 *è"PUT", (
ušt32_t
è~
NGX_HTTP_PUT
 },

4542 { (
u_ch¬
 *è"DELETE", (
ušt32_t
è~
NGX_HTTP_DELETE
 },

4543 { (
u_ch¬
 *è"MKCOL", (
ušt32_t
è~
NGX_HTTP_MKCOL
 },

4544 { (
u_ch¬
 *è"COPY", (
ušt32_t
è~
NGX_HTTP_COPY
 },

4545 { (
u_ch¬
 *è"MOVE", (
ušt32_t
è~
NGX_HTTP_MOVE
 },

4546 { (
u_ch¬
 *è"OPTIONS", (
ušt32_t
è~
NGX_HTTP_OPTIONS
 },

4547 { (
u_ch¬
 *è"PROPFIND", (
ušt32_t
è~
NGX_HTTP_PROPFIND
 },

4548 { (
u_ch¬
 *è"PROPPATCH", (
ušt32_t
è~
NGX_HTTP_PROPPATCH
 },

4549 { (
u_ch¬
 *è"LOCK", (
ušt32_t
è~
NGX_HTTP_LOCK
 },

4550 { (
u_ch¬
 *è"UNLOCK", (
ušt32_t
è~
NGX_HTTP_UNLOCK
 },

4551 { (
u_ch¬
 *è"PATCH", (
ušt32_t
è~
NGX_HTTP_PATCH
 },

4552 { 
NULL
, 0 }

4557 
	$ngx_h‰p_cÜe_lim™_exû±
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4559 
ngx_h‰p_cÜe_loc_cÚf_t
 *
pþcf
 = 
cÚf
;

4561 *
rv
;

4562 *
mcÚf
;

4563 
ngx_¡r_t
 *
v®ue
;

4564 
ngx_ušt_t
 
i
;

4565 
ngx_cÚf_t
 
§ve
;

4566 
ngx_h‰p_moduË_t
 *
moduË
;

4567 
ngx_h‰p_cÚf_ùx_t
 *
ùx
, *
pùx
;

4568 
ngx_h‰p_m‘hod_Çme_t
 *
Çme
;

4569 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

4571 ià(
pþcf
->
lim™_exû±
) {

4575 
pþcf
->
lim™_exû±
 = 0xffffffff;

4577 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4579 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

4580 
Çme
 = 
ngx_m‘hods_Çmes
;‚ame->name;‚ame++) {

4582 ià(
	`ngx_¡rÿ£cmp
(
v®ue
[
i
].
d©a
, 
Çme
->name) == 0) {

4583 
pþcf
->
lim™_exû±
 &ð
Çme
->
m‘hod
;

4584 
Ãxt
;

4588 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4589 "šv®id m‘hod \"%V\"", &
v®ue
[
i
]);

4590  
NGX_CONF_ERROR
;

4592 
Ãxt
:

4596 ià(!(
pþcf
->
lim™_exû±
 & 
NGX_HTTP_GET
)) {

4597 
pþcf
->
lim™_exû±
 &ð(
ušt32_t
è~
NGX_HTTP_HEAD
;

4600 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÚf_ùx_t
));

4601 ià(
ùx
 =ð
NULL
) {

4602  
NGX_CONF_ERROR
;

4605 
pùx
 = 
cf
->
ùx
;

4606 
ùx
->
maš_cÚf
 = 
pùx
->main_conf;

4607 
ùx
->
¤v_cÚf
 = 
pùx
->srv_conf;

4609 
ùx
->
loc_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

4610 ià(
ùx
->
loc_cÚf
 =ð
NULL
) {

4611  
NGX_CONF_ERROR
;

4614 
i
 = 0; 
ngx_moduËs
[i]; i++) {

4615 ià(
ngx_moduËs
[
i
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

4619 
moduË
 = 
ngx_moduËs
[
i
]->
ùx
;

4621 ià(
moduË
->
ü—‹_loc_cÚf
) {

4623 
mcÚf
 = 
moduË
->
	`ü—‹_loc_cÚf
(
cf
);

4624 ià(
mcÚf
 =ð
NULL
) {

4625  
NGX_CONF_ERROR
;

4628 
ùx
->
loc_cÚf
[
ngx_moduËs
[
i
]->
ùx_šdex
] = 
mcÚf
;

4633 
þcf
 = 
ùx
->
loc_cÚf
[
ngx_h‰p_cÜe_moduË
.
ùx_šdex
];

4634 
pþcf
->
lim™_exû±_loc_cÚf
 = 
ùx
->
loc_cÚf
;

4635 
þcf
->
loc_cÚf
 = 
ùx
->loc_conf;

4636 
þcf
->
Çme
 = 
pþcf
->name;

4637 
þcf
->
nÚame
 = 1;

4638 
þcf
->
lmt_exýt
 = 1;

4640 ià(
	`ngx_h‰p_add_loÿtiÚ
(
cf
, &
pþcf
->
loÿtiÚs
, 
þcf
è!ð
NGX_OK
) {

4641  
NGX_CONF_ERROR
;

4644 
§ve
 = *
cf
;

4645 
cf
->
ùx
 = ctx;

4646 
cf
->
cmd_ty³
 = 
NGX_HTTP_LMT_CONF
;

4648 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

4650 *
cf
 = 
§ve
;

4652  
rv
;

4653 
	}
}

4657 
	$ngx_h‰p_cÜe_dœeùio
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4659 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

4661 
ngx_¡r_t
 *
v®ue
;

4663 ià(
þcf
->
dœeùio
 !ð
NGX_CONF_UNSET
) {

4667 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4669 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

4670 
þcf
->
dœeùio
 = 
NGX_OPEN_FILE_DIRECTIO_OFF
;

4671  
NGX_CONF_OK
;

4674 
þcf
->
dœeùio
 = 
	`ngx_·r£_off£t
(&
v®ue
[1]);

4675 ià(
þcf
->
dœeùio
 =ð(
off_t
è
NGX_ERROR
) {

4679  
NGX_CONF_OK
;

4680 
	}
}

4684 
	$ngx_h‰p_cÜe_”rÜ_·ge
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4686 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

4688 
u_ch¬
 *
p
;

4689 
ngx_št_t
 
ov”wr™e
;

4690 
ngx_¡r_t
 *
v®ue
, 
uri
, 
¬gs
;

4691 
ngx_ušt_t
 
i
, 
n
;

4692 
ngx_h‰p_”r_·ge_t
 *
”r
;

4693 
ngx_h‰p_com¶ex_v®ue_t
 
cv
;

4694 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

4696 ià(
þcf
->
”rÜ_·ges
 =ð
NULL
) {

4697 
þcf
->
”rÜ_·ges
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4,

4698 (
ngx_h‰p_”r_·ge_t
));

4699 ià(
þcf
->
”rÜ_·ges
 =ð
NULL
) {

4700  
NGX_CONF_ERROR
;

4704 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4706 
i
 = 
cf
->
¬gs
->
ÃÉs
 - 2;

4708 ià(
v®ue
[
i
].
d©a
[0] == '=') {

4709 ià(
i
 == 1) {

4710 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4711 "šv®id v®u\"%V\"", &
v®ue
[
i
]);

4712  
NGX_CONF_ERROR
;

4715 ià(
v®ue
[
i
].
Ën
 > 1) {

4716 
ov”wr™e
 = 
	`ngx_©oi
(&
v®ue
[
i
].
d©a
[1], v®ue[i].
Ën
 - 1);

4718 ià(
ov”wr™e
 =ð
NGX_ERROR
) {

4719 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4720 "šv®id v®u\"%V\"", &
v®ue
[
i
]);

4721  
NGX_CONF_ERROR
;

4725 
ov”wr™e
 = 0;

4728 
n
 = 2;

4731 
ov”wr™e
 = -1;

4732 
n
 = 1;

4735 
uri
 = 
v®ue
[
cf
->
¬gs
->
ÃÉs
 - 1];

4737 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

4739 
ccv
.
cf
 = cf;

4740 
ccv
.
v®ue
 = &
uri
;

4741 
ccv
.
com¶ex_v®ue
 = &
cv
;

4743 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

4744  
NGX_CONF_ERROR
;

4747 
	`ngx_¡r_nuÎ
(&
¬gs
);

4749 ià(
cv
.
Ëngths
 =ð
NULL
 && 
uri
.
Ën
 && uri.
d©a
[0] == '/') {

4750 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(
uri
.
d©a
, '?');

4752 ià(
p
) {

4753 
cv
.
v®ue
.
Ën
 = 
p
 - 
uri
.
d©a
;

4754 
cv
.
v®ue
.
d©a
 = 
uri
.data;

4755 
p
++;

4756 
¬gs
.
Ën
 = (
uri
.
d©a
 + uri.Ënè- 
p
;

4757 
¬gs
.
d©a
 = 
p
;

4761 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
 - 
n
; i++) {

4762 
”r
 = 
	`ngx_¬¿y_push
(
þcf
->
”rÜ_·ges
);

4763 ià(
”r
 =ð
NULL
) {

4764  
NGX_CONF_ERROR
;

4767 
”r
->
¡©us
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
, v®ue[i].
Ën
);

4769 ià(
”r
->
¡©us
 =ð
NGX_ERROR
 ||ƒrr->status == 499) {

4770 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4771 "šv®id v®u\"%V\"", &
v®ue
[
i
]);

4772  
NGX_CONF_ERROR
;

4775 ià(
”r
->
¡©us
 < 300 ||ƒrr->status > 599) {

4776 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4778 &
v®ue
[
i
]);

4779  
NGX_CONF_ERROR
;

4782 
”r
->
ov”wr™e
 = overwrite;

4784 ià(
ov”wr™e
 == -1) {

4785 
”r
->
¡©us
) {

4786 
NGX_HTTP_TO_HTTPS
:

4787 
NGX_HTTPS_CERT_ERROR
:

4788 
NGX_HTTPS_NO_CERT
:

4789 
”r
->
ov”wr™e
 = 
NGX_HTTP_BAD_REQUEST
;

4795 
”r
->
v®ue
 = 
cv
;

4796 
”r
->
¬gs
 =‡rgs;

4799  
NGX_CONF_OK
;

4800 
	}
}

4804 
	$ngx_h‰p_cÜe_Œy_fžes
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4806 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

4808 
ngx_¡r_t
 *
v®ue
;

4809 
ngx_št_t
 
code
;

4810 
ngx_ušt_t
 
i
, 
n
;

4811 
ngx_h‰p_Œy_fže_t
 *
tf
;

4812 
ngx_h‰p_süt_compže_t
 
sc
;

4813 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

4815 ià(
þcf
->
Œy_fžes
) {

4819 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

4821 
cmcf
->
Œy_fžes
 = 1;

4823 
tf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, cf->
¬gs
->
ÃÉs
 * (
ngx_h‰p_Œy_fže_t
));

4824 ià(
tf
 =ð
NULL
) {

4825  
NGX_CONF_ERROR
;

4828 
þcf
->
Œy_fžes
 = 
tf
;

4830 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4832 
i
 = 0; i < 
cf
->
¬gs
->
ÃÉs
 - 1; i++) {

4834 
tf
[
i
].
Çme
 = 
v®ue
[i + 1];

4836 ià(
tf
[
i
].
Çme
.
Ën
 > 0

4837 && 
tf
[
i
].
Çme
.
d©a
[tf[i].Çme.
Ën
 - 1] == '/'

4838 && 
i
 + 2 < 
cf
->
¬gs
->
ÃÉs
)

4840 
tf
[
i
].
‹¡_dœ
 = 1;

4841 
tf
[
i
].
Çme
.
Ën
--;

4842 
tf
[
i
].
Çme
.
d©a
[tf[i].Çme.
Ën
] = '\0';

4845 
n
 = 
	`ngx_h‰p_süt_v¬ŸbËs_couÁ
(&
tf
[
i
].
Çme
);

4847 ià(
n
) {

4848 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

4850 
sc
.
cf
 = cf;

4851 
sc
.
sourû
 = &
tf
[
i
].
Çme
;

4852 
sc
.
Ëngths
 = &
tf
[
i
].lengths;

4853 
sc
.
v®ues
 = &
tf
[
i
].values;

4854 
sc
.
v¬ŸbËs
 = 
n
;

4855 
sc
.
com¶‘e_Ëngths
 = 1;

4856 
sc
.
com¶‘e_v®ues
 = 1;

4858 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

4859  
NGX_CONF_ERROR
;

4864 
tf
[
i
].
Çme
.
Ën
++;

4868 ià(
tf
[
i
 - 1].
Çme
.
d©a
[0] == '=') {

4870 
code
 = 
	`ngx_©oi
(
tf
[
i
 - 1].
Çme
.
d©a
 + 1,f[˜- 1].Çme.
Ën
 - 2);

4872 ià(
code
 =ð
NGX_ERROR
 || code > 999) {

4873 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4875 
tf
[
i
 - 1].
Çme
.
Ën
 - 1,f[˜- 1].Çme.
d©a
);

4876  
NGX_CONF_ERROR
;

4879 
tf
[
i
].
code
 = code;

4882  
NGX_CONF_OK
;

4883 
	}
}

4887 
	$ngx_h‰p_cÜe_Ý’_fže_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4889 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

4891 
time_t
 
šaùive
;

4892 
ngx_¡r_t
 *
v®ue
, 
s
;

4893 
ngx_št_t
 
max
;

4894 
ngx_ušt_t
 
i
;

4896 ià(
þcf
->
Ý’_fže_ÿche
 !ð
NGX_CONF_UNSET_PTR
) {

4900 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4902 
max
 = 0;

4903 
šaùive
 = 60;

4905 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

4907 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "max=", 4) == 0) {

4909 
max
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + 4, v®ue[i].
Ën
 - 4);

4910 ià(
max
 <= 0) {

4911 
çžed
;

4917 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "inactive=", 9) == 0) {

4919 
s
.
Ën
 = 
v®ue
[
i
].len - 9;

4920 
s
.
d©a
 = 
v®ue
[
i
].data + 9;

4922 
šaùive
 = 
	`ngx_·r£_time
(&
s
, 1);

4923 ià(
šaùive
 =ð(
time_t
è
NGX_ERROR
) {

4924 
çžed
;

4930 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "off") == 0) {

4932 
þcf
->
Ý’_fže_ÿche
 = 
NULL
;

4937 
çžed
:

4939 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4941 &
v®ue
[
i
]);

4942  
NGX_CONF_ERROR
;

4945 ià(
þcf
->
Ý’_fže_ÿche
 =ð
NULL
) {

4946  
NGX_CONF_OK
;

4949 ià(
max
 == 0) {

4950 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

4952  
NGX_CONF_ERROR
;

4955 
þcf
->
Ý’_fže_ÿche
 = 
	`ngx_Ý’_fže_ÿche_š™
(
cf
->
poÞ
, 
max
, 
šaùive
);

4956 ià(
þcf
->
Ý’_fže_ÿche
) {

4957  
NGX_CONF_OK
;

4960  
NGX_CONF_ERROR
;

4961 
	}
}

4965 
	$ngx_h‰p_cÜe_”rÜ_log
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4967 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

4969  
	`ngx_log_£t_log
(
cf
, &
þcf
->
”rÜ_log
);

4970 
	}
}

4974 
	$ngx_h‰p_cÜe_k“·live
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

4976 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

4978 
ngx_¡r_t
 *
v®ue
;

4980 ià(
þcf
->
k“·live_timeout
 !ð
NGX_CONF_UNSET_MSEC
) {

4984 
v®ue
 = 
cf
->
¬gs
->
–ts
;

4986 
þcf
->
k“·live_timeout
 = 
	`ngx_·r£_time
(&
v®ue
[1], 0);

4988 ià(
þcf
->
k“·live_timeout
 =ð(
ngx_m£c_t
è
NGX_ERROR
) {

4992 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

4993  
NGX_CONF_OK
;

4996 
þcf
->
k“·live_h—d”
 = 
	`ngx_·r£_time
(&
v®ue
[2], 1);

4998 ià(
þcf
->
k“·live_h—d”
 =ð(
time_t
è
NGX_ERROR
) {

5002  
NGX_CONF_OK
;

5003 
	}
}

5007 
	$ngx_h‰p_cÜe_š‹º®
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

5009 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

5011 ià(
þcf
->
š‹º®
 !ð
NGX_CONF_UNSET
) {

5015 
þcf
->
š‹º®
 = 1;

5017  
NGX_CONF_OK
;

5018 
	}
}

5022 
	$ngx_h‰p_cÜe_»sÞv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

5024 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

5026 
ngx_¡r_t
 *
v®ue
;

5028 ià(
þcf
->
»sÞv”
) {

5032 
v®ue
 = 
cf
->
¬gs
->
–ts
;

5034 
þcf
->
»sÞv”
 = 
	`ngx_»sÞv”_ü—‹
(
cf
, &
v®ue
[1], cf->
¬gs
->
ÃÉs
 - 1);

5035 ià(
þcf
->
»sÞv”
 =ð
NULL
) {

5036  
NGX_CONF_ERROR
;

5039  
NGX_CONF_OK
;

5040 
	}
}

5043 #ià(
NGX_HTTP_GZIP
)

5046 
	$ngx_h‰p_gz_di§bË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

5048 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

5050 #ià(
NGX_PCRE
)

5052 
ngx_¡r_t
 *
v®ue
;

5053 
ngx_ušt_t
 
i
;

5054 
ngx_»gex_–t_t
 *
»
;

5055 
ngx_»gex_compže_t
 
rc
;

5056 
u_ch¬
 
”r¡r
[
NGX_MAX_CONF_ERRSTR
];

5058 ià(
þcf
->
gz_di§bË
 =ð
NGX_CONF_UNSET_PTR
) {

5059 
þcf
->
gz_di§bË
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 2,

5060 (
ngx_»gex_–t_t
));

5061 ià(
þcf
->
gz_di§bË
 =ð
NULL
) {

5062  
NGX_CONF_ERROR
;

5066 
v®ue
 = 
cf
->
¬gs
->
–ts
;

5068 
	`ngx_memz”o
(&
rc
, (
ngx_»gex_compže_t
));

5070 
rc
.
poÞ
 = 
cf
->pool;

5071 
rc
.
”r
.
Ën
 = 
NGX_MAX_CONF_ERRSTR
;

5072 
rc
.
”r
.
d©a
 = 
”r¡r
;

5074 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

5076 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "msie6") == 0) {

5077 
þcf
->
gz_di§bË_ms›6
 = 1;

5081 #ià(
NGX_HTTP_DEGRADATION
)

5083 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "degradation") == 0) {

5084 
þcf
->
gz_di§bË_deg¿d©iÚ
 = 1;

5090 
»
 = 
	`ngx_¬¿y_push
(
þcf
->
gz_di§bË
);

5091 ià(
»
 =ð
NULL
) {

5092  
NGX_CONF_ERROR
;

5095 
rc
.
·‰”n
 = 
v®ue
[
i
];

5096 
rc
.
ÝtiÚs
 = 
NGX_REGEX_CASELESS
;

5098 ià(
	`ngx_»gex_compže
(&
rc
è!ð
NGX_OK
) {

5099 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "%V", &
rc
.
”r
);

5100  
NGX_CONF_ERROR
;

5103 
»
->
»gex
 = 
rc
.regex;

5104 
»
->
Çme
 = 
v®ue
[
i
].
d©a
;

5107  
NGX_CONF_OK
;

5110 
ngx_¡r_t
 *
v®ue
;

5111 
ngx_ušt_t
 
i
;

5113 
v®ue
 = 
cf
->
¬gs
->
–ts
;

5115 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

5116 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "msie6") == 0) {

5117 
þcf
->
gz_di§bË_ms›6
 = 1;

5121 #ià(
NGX_HTTP_DEGRADATION
)

5123 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "degradation") == 0) {

5124 
þcf
->
gz_di§bË_deg¿d©iÚ
 = 1;

5130 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5134  
NGX_CONF_ERROR
;

5137  
NGX_CONF_OK
;

5140 
	}
}

5145 #ià(
NGX_HAVE_OPENAT
)

5148 
	$ngx_h‰p_di§bË_symlšks
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

5150 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
 = 
cÚf
;

5152 
ngx_¡r_t
 *
v®ue
;

5153 
ngx_ušt_t
 
i
;

5154 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

5156 ià(
þcf
->
di§bË_symlšks
 !ð
NGX_CONF_UNSET_UINT
) {

5160 
v®ue
 = 
cf
->
¬gs
->
–ts
;

5162 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

5164 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "off") == 0) {

5165 
þcf
->
di§bË_symlšks
 = 
NGX_DISABLE_SYMLINKS_OFF
;

5169 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "if_not_owner") == 0) {

5170 
þcf
->
di§bË_symlšks
 = 
NGX_DISABLE_SYMLINKS_NOTOWNER
;

5174 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "on") == 0) {

5175 
þcf
->
di§bË_symlšks
 = 
NGX_DISABLE_SYMLINKS_ON
;

5179 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "from=", 5) == 0) {

5180 
v®ue
[
i
].
Ën
 -= 5;

5181 
v®ue
[
i
].
d©a
 += 5;

5183 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

5185 
ccv
.
cf
 = cf;

5186 
ccv
.
v®ue
 = &v®ue[
i
];

5187 
ccv
.
com¶ex_v®ue
 = 
	`ngx_·Îoc
(
cf
->
poÞ
,

5188 (
ngx_h‰p_com¶ex_v®ue_t
));

5189 ià(
ccv
.
com¶ex_v®ue
 =ð
NULL
) {

5190  
NGX_CONF_ERROR
;

5193 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

5194  
NGX_CONF_ERROR
;

5197 
þcf
->
di§bË_symlšks_äom
 = 
ccv
.
com¶ex_v®ue
;

5202 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5203 "šv®id…¬am‘” \"%V\"", &
v®ue
[
i
]);

5204  
NGX_CONF_ERROR
;

5207 ià(
þcf
->
di§bË_symlšks
 =ð
NGX_CONF_UNSET_UINT
) {

5208 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5211 &
cmd
->
Çme
);

5212  
NGX_CONF_ERROR
;

5215 ià(
cf
->
¬gs
->
ÃÉs
 == 2) {

5216 
þcf
->
di§bË_symlšks_äom
 = 
NULL
;

5217  
NGX_CONF_OK
;

5220 ià(
þcf
->
di§bË_symlšks_äom
 =ð
NGX_CONF_UNSET_PTR
) {

5221 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5223 &
v®ue
[1], &value[2]);

5224  
NGX_CONF_ERROR
;

5227 ià(
þcf
->
di§bË_symlšks
 =ð
NGX_DISABLE_SYMLINKS_OFF
) {

5228 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5230  
NGX_CONF_ERROR
;

5233  
NGX_CONF_OK
;

5234 
	}
}

5240 
	$ngx_h‰p_cÜe_low©_check
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

5242 #ià(
NGX_FREEBSD
)

5243 
ssize_t
 *
Å
 = 
d©a
;

5245 ià((
u_lÚg
è*
Å
 >ð
ngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
) {

5246 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5249 
ngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
);

5251  
NGX_CONF_ERROR
;

5254 #–ià!(
NGX_HAVE_SO_SNDLOWAT
)

5255 
ssize_t
 *
Å
 = 
d©a
;

5257 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

5260 *
Å
 = 0;

5264  
NGX_CONF_OK
;

5265 
	}
}

5269 
	$ngx_h‰p_cÜe_poÞ_size
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

5271 
size_t
 *
¥
 = 
d©a
;

5273 ià(*
¥
 < 
NGX_MIN_POOL_SIZE
) {

5274 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5276 
NGX_MIN_POOL_SIZE
);

5277  
NGX_CONF_ERROR
;

5280 ià(*
¥
 % 
NGX_POOL_ALIGNMENT
) {

5281 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5283 
NGX_POOL_ALIGNMENT
);

5284  
NGX_CONF_ERROR
;

5287  
NGX_CONF_OK
;

5288 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_file_cache.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngx_md5.h
>

14 
ngx_št_t
 
ngx_h‰p_fže_ÿche_lock
(
ngx_h‰p_»que¡_t
 *
r
,

15 
ngx_h‰p_ÿche_t
 *
c
);

16 
ngx_h‰p_fže_ÿche_lock_wa™_hªdËr
(
ngx_ev’t_t
 *
ev
);

17 
ngx_h‰p_fže_ÿche_lock_wa™
(
ngx_h‰p_»que¡_t
 *
r
,

18 
ngx_h‰p_ÿche_t
 *
c
);

19 
ngx_št_t
 
ngx_h‰p_fže_ÿche_»ad
(
ngx_h‰p_»que¡_t
 *
r
,

20 
ngx_h‰p_ÿche_t
 *
c
);

21 
ssize_t
 
ngx_h‰p_fže_ÿche_aio_»ad
(
ngx_h‰p_»que¡_t
 *
r
,

22 
ngx_h‰p_ÿche_t
 *
c
);

23 #ià(
NGX_HAVE_FILE_AIO
)

24 
ngx_h‰p_ÿche_aio_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
);

26 
ngx_št_t
 
ngx_h‰p_fže_ÿche_exi¡s
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
,

27 
ngx_h‰p_ÿche_t
 *
c
);

28 
ngx_št_t
 
ngx_h‰p_fže_ÿche_Çme
(
ngx_h‰p_»que¡_t
 *
r
,

29 
ngx_·th_t
 *
·th
);

30 
ngx_h‰p_fže_ÿche_node_t
 *

31 
ngx_h‰p_fže_ÿche_lookup
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
, 
u_ch¬
 *
key
);

32 
ngx_h‰p_fže_ÿche_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

33 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
);

34 
ngx_h‰p_fže_ÿche_v¬y
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
v¬y
,

35 
size_t
 
Ën
, 
u_ch¬
 *
hash
);

36 
ngx_h‰p_fže_ÿche_v¬y_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

37 
ngx_md5_t
 *
md5
, 
ngx_¡r_t
 *
Çme
);

38 
ngx_št_t
 
ngx_h‰p_fže_ÿche_»Ý’
(
ngx_h‰p_»que¡_t
 *
r
,

39 
ngx_h‰p_ÿche_t
 *
c
);

40 
ngx_h‰p_fže_ÿche_þ—nup
(*
d©a
);

41 
time_t
 
ngx_h‰p_fže_ÿche_fÜûd_expœe
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
);

42 
time_t
 
ngx_h‰p_fže_ÿche_expœe
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
);

43 
ngx_h‰p_fže_ÿche_d–‘e
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
,

44 
ngx_queue_t
 *
q
, 
u_ch¬
 *
Çme
);

45 
ngx_h‰p_fže_ÿche_lßd”_¦“p
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
);

46 
ngx_št_t
 
ngx_h‰p_fže_ÿche_noÝ
(
ngx_Œ“_ùx_t
 *
ùx
,

47 
ngx_¡r_t
 *
·th
);

48 
ngx_št_t
 
ngx_h‰p_fže_ÿche_mªage_fže
(
ngx_Œ“_ùx_t
 *
ùx
,

49 
ngx_¡r_t
 *
·th
);

50 
ngx_št_t
 
ngx_h‰p_fže_ÿche_add_fže
(
ngx_Œ“_ùx_t
 *
ùx
,

51 
ngx_¡r_t
 *
·th
);

52 
ngx_št_t
 
ngx_h‰p_fže_ÿche_add
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
,

53 
ngx_h‰p_ÿche_t
 *
c
);

54 
ngx_št_t
 
ngx_h‰p_fže_ÿche_d–‘e_fže
(
ngx_Œ“_ùx_t
 *
ùx
,

55 
ngx_¡r_t
 *
·th
);

58 
ngx_¡r_t
 
	gngx_h‰p_ÿche_¡©us
[] = {

59 
ngx_¡ršg
("MISS"),

60 
ngx_¡ršg
("BYPASS"),

61 
ngx_¡ršg
("EXPIRED"),

62 
ngx_¡ršg
("STALE"),

63 
ngx_¡ršg
("UPDATING"),

64 
ngx_¡ršg
("REVALIDATED"),

65 
ngx_¡ršg
("HIT")

69 
u_ch¬
 
	gngx_h‰p_fže_ÿche_key
[] = { 
LF
, 'K', 'E', 'Y', ':', ' ' };

72 
ngx_št_t


73 
	$ngx_h‰p_fže_ÿche_š™
(
ngx_shm_zÚe_t
 *
shm_zÚe
, *
d©a
)

75 
ngx_h‰p_fže_ÿche_t
 *
oÿche
 = 
d©a
;

77 
size_t
 
Ën
;

78 
ngx_ušt_t
 
n
;

79 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

81 
ÿche
 = 
shm_zÚe
->
d©a
;

83 ià(
oÿche
) {

84 ià(
	`ngx_¡rcmp
(
ÿche
->
·th
->
Çme
.
d©a
, 
oÿche
->path->name.data) != 0) {

85 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
shm_zÚe
->
shm
.
log
, 0,

88 &
shm_zÚe
->
shm
.
Çme
, &
ÿche
->
·th
->name,

89 &
oÿche
->
·th
->
Çme
);

91  
NGX_ERROR
;

94 
n
 = 0;‚ < 3;‚++) {

95 ià(
ÿche
->
·th
->
Ëv–
[
n
] !ð
oÿche
->path->level[n]) {

96 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
shm_zÚe
->
shm
.
log
, 0,

98 &
shm_zÚe
->
shm
.
Çme
);

99  
NGX_ERROR
;

103 
ÿche
->
sh
 = 
oÿche
->sh;

105 
ÿche
->
shpoÞ
 = 
oÿche
->shpool;

106 
ÿche
->
bsize
 = 
oÿche
->bsize;

108 
ÿche
->
max_size
 /ðÿche->
bsize
;

110 ià(!
ÿche
->
sh
->
cÞd
 || cache->sh->
lßdšg
) {

111 
ÿche
->
·th
->
lßd”
 = 
NULL
;

114  
NGX_OK
;

117 
ÿche
->
shpoÞ
 = (
ngx_¦ab_poÞ_t
 *è
shm_zÚe
->
shm
.
addr
;

119 ià(
shm_zÚe
->
shm
.
exi¡s
) {

120 
ÿche
->
sh
 = cache->
shpoÞ
->
d©a
;

121 
ÿche
->
bsize
 = 
	`ngx_fs_bsize
(ÿche->
·th
->
Çme
.
d©a
);

123  
NGX_OK
;

126 
ÿche
->
sh
 = 
	`ngx_¦ab_®loc
(ÿche->
shpoÞ
, (
ngx_h‰p_fže_ÿche_sh_t
));

127 ià(
ÿche
->
sh
 =ð
NULL
) {

128  
NGX_ERROR
;

131 
ÿche
->
shpoÞ
->
d©a
 = cache->
sh
;

133 
	`ngx_rbŒ“_š™
(&
ÿche
->
sh
->
rbŒ“
, &ÿche->sh->
£Áš–
,

134 
ngx_h‰p_fže_ÿche_rbŒ“_š£¹_v®ue
);

136 
	`ngx_queue_š™
(&
ÿche
->
sh
->
queue
);

138 
ÿche
->
sh
->
cÞd
 = 1;

139 
ÿche
->
sh
->
lßdšg
 = 0;

140 
ÿche
->
sh
->
size
 = 0;

142 
ÿche
->
bsize
 = 
	`ngx_fs_bsize
(ÿche->
·th
->
Çme
.
d©a
);

144 
ÿche
->
max_size
 /ðÿche->
bsize
;

146 
Ën
 = (" iÀÿchkey zÚ\"\""è+ 
shm_zÚe
->
shm
.
Çme
.len;

148 
ÿche
->
shpoÞ
->
log_ùx
 = 
	`ngx_¦ab_®loc
(ÿche->shpoÞ, 
Ën
);

149 ià(
ÿche
->
shpoÞ
->
log_ùx
 =ð
NULL
) {

150  
NGX_ERROR
;

153 
	`ngx_¥rštf
(
ÿche
->
shpoÞ
->
log_ùx
, " in cache keys zone \"%V\"%Z",

154 &
shm_zÚe
->
shm
.
Çme
);

156 
ÿche
->
shpoÞ
->
log_nomem
 = 0;

158  
NGX_OK
;

159 
	}
}

162 
ngx_št_t


163 
	$ngx_h‰p_fže_ÿche_Ãw
(
ngx_h‰p_»que¡_t
 *
r
)

165 
ngx_h‰p_ÿche_t
 *
c
;

167 
c
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_ÿche_t
));

168 ià(
c
 =ð
NULL
) {

169  
NGX_ERROR
;

172 ià(
	`ngx_¬¿y_š™
(&
c
->
keys
, 
r
->
poÞ
, 4, (
ngx_¡r_t
)è!ð
NGX_OK
) {

173  
NGX_ERROR
;

176 
r
->
ÿche
 = 
c
;

177 
c
->
fže
.
log
 = 
r
->
cÚÃùiÚ
->log;

178 
c
->
fže
.
fd
 = 
NGX_INVALID_FILE
;

180  
NGX_OK
;

181 
	}
}

184 
ngx_št_t


185 
	$ngx_h‰p_fže_ÿche_ü—‹
(
ngx_h‰p_»que¡_t
 *
r
)

187 
ngx_h‰p_ÿche_t
 *
c
;

188 
ngx_poÞ_þ—nup_t
 *
þn
;

189 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

191 
c
 = 
r
->
ÿche
;

192 
ÿche
 = 
c
->
fže_ÿche
;

194 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
r
->
poÞ
, 0);

195 ià(
þn
 =ð
NULL
) {

196  
NGX_ERROR
;

199 
þn
->
hªdËr
 = 
ngx_h‰p_fže_ÿche_þ—nup
;

200 
þn
->
d©a
 = 
c
;

202 ià(
	`ngx_h‰p_fže_ÿche_exi¡s
(
ÿche
, 
c
è=ð
NGX_ERROR
) {

203  
NGX_ERROR
;

206 ià(
	`ngx_h‰p_fže_ÿche_Çme
(
r
, 
ÿche
->
·th
è!ð
NGX_OK
) {

207  
NGX_ERROR
;

210  
NGX_OK
;

211 
	}
}

215 
	$ngx_h‰p_fže_ÿche_ü—‹_key
(
ngx_h‰p_»que¡_t
 *
r
)

217 
size_t
 
Ën
;

218 
ngx_¡r_t
 *
key
;

219 
ngx_ušt_t
 
i
;

220 
ngx_md5_t
 
md5
;

221 
ngx_h‰p_ÿche_t
 *
c
;

223 
c
 = 
r
->
ÿche
;

225 
Ën
 = 0;

227 
	`ngx_üc32_š™
(
c
->
üc32
);

228 
	`ngx_md5_š™
(&
md5
);

230 
key
 = 
c
->
keys
.
–ts
;

231 
i
 = 0; i < 
c
->
keys
.
ÃÉs
; i++) {

232 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

233 "h‰°ÿchkey: \"%V\"", &
key
[
i
]);

235 
Ën
 +ð
key
[
i
].len;

237 
	`ngx_üc32_upd©e
(&
c
->
üc32
, 
key
[
i
].
d©a
, key[i].
Ën
);

238 
	`ngx_md5_upd©e
(&
md5
, 
key
[
i
].
d©a
, key[i].
Ën
);

241 
c
->
h—d”_¡¬t
 = (
ngx_h‰p_fže_ÿche_h—d”_t
)

242 + (
ngx_h‰p_fže_ÿche_key
è+ 
Ën
 + 1;

244 
	`ngx_üc32_fš®
(
c
->
üc32
);

245 
	`ngx_md5_fš®
(
c
->
key
, &
md5
);

247 
	`ngx_memýy
(
c
->
maš
, c->
key
, 
NGX_HTTP_CACHE_KEY_LEN
);

248 
	}
}

251 
ngx_št_t


252 
	$ngx_h‰p_fže_ÿche_Ý’
(
ngx_h‰p_»que¡_t
 *
r
)

254 
ngx_št_t
 
rc
, 
rv
;

255 
ngx_ušt_t
 
cÞd
, 
‹¡
;

256 
ngx_h‰p_ÿche_t
 *
c
;

257 
ngx_poÞ_þ—nup_t
 *
þn
;

258 
ngx_Ý’_fže_šfo_t
 
of
;

259 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

260 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

262 
c
 = 
r
->
ÿche
;

264 ià(
c
->
wa™šg
) {

265  
NGX_AGAIN
;

268 ià(
c
->
»adšg
) {

269  
	`ngx_h‰p_fže_ÿche_»ad
(
r
, 
c
);

272 
ÿche
 = 
c
->
fže_ÿche
;

274 ià(
c
->
node
 =ð
NULL
) {

275 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
r
->
poÞ
, 0);

276 ià(
þn
 =ð
NULL
) {

277  
NGX_ERROR
;

280 
þn
->
hªdËr
 = 
ngx_h‰p_fže_ÿche_þ—nup
;

281 
þn
->
d©a
 = 
c
;

284 
rc
 = 
	`ngx_h‰p_fže_ÿche_exi¡s
(
ÿche
, 
c
);

286 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

287 "h‰°fžÿchexi¡s: %˜e:%d", 
rc
, 
c
->
exi¡s
);

289 ià(
rc
 =ð
NGX_ERROR
) {

290  
rc
;

293 ià(
rc
 =ð
NGX_AGAIN
) {

294  
NGX_HTTP_CACHE_SCARCE
;

297 
cÞd
 = 
ÿche
->
sh
->cold;

299 ià(
rc
 =ð
NGX_OK
) {

301 ià(
c
->
”rÜ
) {

302  
c
->
”rÜ
;

305 
c
->
‹mp_fže
 = 1;

306 
‹¡
 = 
c
->
exi¡s
 ? 1 : 0;

307 
rv
 = 
NGX_DECLINED
;

311 ià(
c
->
mš_u£s
 > 1) {

313 ià(!
cÞd
) {

314  
NGX_HTTP_CACHE_SCARCE
;

317 
‹¡
 = 1;

318 
rv
 = 
NGX_HTTP_CACHE_SCARCE
;

321 
c
->
‹mp_fže
 = 1;

322 
‹¡
 = 
cÞd
 ? 1 : 0;

323 
rv
 = 
NGX_DECLINED
;

327 ià(
	`ngx_h‰p_fže_ÿche_Çme
(
r
, 
ÿche
->
·th
è!ð
NGX_OK
) {

328  
NGX_ERROR
;

331 ià(!
‹¡
) {

332 
dÚe
;

335 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

337 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

339 
of
.
uniq
 = 
c
->uniq;

340 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

341 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

342 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

343 
of
.
dœeùio
 = 
NGX_OPEN_FILE_DIRECTIO_OFF
;

344 
of
.
»ad_ah—d
 = 
þcf
->read_ahead;

346 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
c
->
fže
.
Çme
, &
of
, 
r
->
poÞ
)

347 !ð
NGX_OK
)

349 
of
.
”r
) {

352  
NGX_ERROR
;

354 
NGX_ENOENT
:

355 
NGX_ENOTDIR
:

356 
dÚe
;

359 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
of
.
”r
,

360 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
c
->
fže
.
Çme
.
d©a
);

361  
NGX_ERROR
;

365 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

366 "h‰°fžÿchfd: %d", 
of
.
fd
);

368 
c
->
fže
.
fd
 = 
of
.fd;

369 
c
->
fže
.
log
 = 
r
->
cÚÃùiÚ
->log;

370 
c
->
uniq
 = 
of
.uniq;

371 
c
->
Ëngth
 = 
of
.
size
;

372 
c
->
fs_size
 = (
of
.fs_siz+ 
ÿche
->
bsize
 - 1) / cache->bsize;

374 
c
->
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, c->
body_¡¬t
);

375 ià(
c
->
buf
 =ð
NULL
) {

376  
NGX_ERROR
;

379  
	`ngx_h‰p_fže_ÿche_»ad
(
r
, 
c
);

381 
dÚe
:

383 ià(
rv
 =ð
NGX_DECLINED
) {

384  
	`ngx_h‰p_fže_ÿche_lock
(
r
, 
c
);

387  
rv
;

388 
	}
}

391 
ngx_št_t


392 
	$ngx_h‰p_fže_ÿche_lock
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ÿche_t
 *
c
)

394 
ngx_m£c_t
 
now
, 
tim”
;

395 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

397 ià(!
c
->
lock
) {

398  
NGX_DECLINED
;

401 
now
 = 
ngx_cu¼’t_m£c
;

403 
ÿche
 = 
c
->
fže_ÿche
;

405 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

407 
tim”
 = 
c
->
node
->
lock_time
 - 
now
;

409 ià(!
c
->
node
->
upd©šg
 || (
ngx_m£c_št_t
è
tim”
 <= 0) {

410 
c
->
node
->
upd©šg
 = 1;

411 
c
->
node
->
lock_time
 = 
now
 + c->
lock_age
;

412 
c
->
upd©šg
 = 1;

413 
c
->
lock_time
 = c->
node
->lock_time;

416 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

418 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

420 
c
->
upd©šg
, c->
wa™_time
);

422 ià(
c
->
upd©šg
) {

423  
NGX_DECLINED
;

426 ià(
c
->
lock_timeout
 == 0) {

427  
NGX_HTTP_CACHE_SCARCE
;

430 
c
->
wa™šg
 = 1;

432 ià(
c
->
wa™_time
 == 0) {

433 
c
->
wa™_time
 = 
now
 + c->
lock_timeout
;

435 
c
->
wa™_ev’t
.
hªdËr
 = 
ngx_h‰p_fže_ÿche_lock_wa™_hªdËr
;

436 
c
->
wa™_ev’t
.
d©a
 = 
r
;

437 
c
->
wa™_ev’t
.
log
 = 
r
->
cÚÃùiÚ
->log;

440 
tim”
 = 
c
->
wa™_time
 - 
now
;

442 
	`ngx_add_tim”
(&
c
->
wa™_ev’t
, (
tim”
 > 500) ? 500 :imer);

444 
r
->
maš
->
blocked
++;

446  
NGX_AGAIN
;

447 
	}
}

451 
	$ngx_h‰p_fže_ÿche_lock_wa™_hªdËr
(
ngx_ev’t_t
 *
ev
)

453 
ngx_cÚÃùiÚ_t
 *
c
;

454 
ngx_h‰p_»que¡_t
 *
r
;

456 
r
 = 
ev
->
d©a
;

457 
c
 = 
r
->
cÚÃùiÚ
;

459 
	`ngx_h‰p_£t_log_»que¡
(
c
->
log
, 
r
);

461 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

462 "h‰°fžÿchwa™: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

464 
	`ngx_h‰p_fže_ÿche_lock_wa™
(
r
,„->
ÿche
);

466 
	`ngx_h‰p_run_po¡ed_»que¡s
(
c
);

467 
	}
}

471 
	$ngx_h‰p_fže_ÿche_lock_wa™
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ÿche_t
 *
c
)

473 
ngx_ušt_t
 
wa™
;

474 
ngx_m£c_t
 
now
, 
tim”
;

475 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

477 
now
 = 
ngx_cu¼’t_m£c
;

479 
tim”
 = 
c
->
wa™_time
 - 
now
;

481 ià((
ngx_m£c_št_t
è
tim”
 <= 0) {

482 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

484 
c
->
lock_timeout
 = 0;

485 
wakeup
;

488 
ÿche
 = 
c
->
fže_ÿche
;

489 
wa™
 = 0;

491 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

493 
tim”
 = 
c
->
node
->
lock_time
 - 
now
;

495 ià(
c
->
node
->
upd©šg
 && (
ngx_m£c_št_t
è
tim”
 > 0) {

496 
wa™
 = 1;

499 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

501 ià(
wa™
) {

502 
	`ngx_add_tim”
(&
c
->
wa™_ev’t
, (
tim”
 > 500) ? 500 :imer);

506 
wakeup
:

508 
c
->
wa™šg
 = 0;

509 
r
->
maš
->
blocked
--;

510 
r
->
	`wr™e_ev’t_hªdËr
(r);

511 
	}
}

514 
ngx_št_t


515 
	$ngx_h‰p_fže_ÿche_»ad
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ÿche_t
 *
c
)

517 
time_t
 
now
;

518 
ssize_t
 
n
;

519 
ngx_št_t
 
rc
;

520 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

521 
ngx_h‰p_fže_ÿche_h—d”_t
 *
h
;

523 
n
 = 
	`ngx_h‰p_fže_ÿche_aio_»ad
(
r
, 
c
);

525 ià(
n
 < 0) {

526  
n
;

529 ià((
size_t
è
n
 < 
c
->
h—d”_¡¬t
) {

530 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 0,

531 "ÿchfž\"%s\" i toØsm®l", 
c
->
fže
.
Çme
.
d©a
);

532  
NGX_DECLINED
;

535 
h
 = (
ngx_h‰p_fže_ÿche_h—d”_t
 *è
c
->
buf
->
pos
;

537 ià(
h
->
v”siÚ
 !ð
NGX_HTTP_CACHE_VERSION
) {

538 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

539 "ÿchfž\"%s\" v”siÚ mism©ch", 
c
->
fže
.
Çme
.
d©a
);

540  
NGX_DECLINED
;

543 ià(
h
->
üc32
 !ð
c
->crc32) {

544 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 0,

545 "ÿchfž\"%s\" ha md5 cÞlisiÚ", 
c
->
fže
.
Çme
.
d©a
);

546  
NGX_DECLINED
;

549 ià((
size_t
è
h
->
body_¡¬t
 > 
c
->body_start) {

550 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 0,

552 
c
->
fže
.
Çme
.
d©a
);

553  
NGX_DECLINED
;

556 ià(
h
->
v¬y_Ën
 > 
NGX_HTTP_CACHE_VARY_LEN
) {

557 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 0,

559 
c
->
fže
.
Çme
.
d©a
);

560  
NGX_DECLINED
;

563 ià(
h
->
v¬y_Ën
) {

564 
	`ngx_h‰p_fže_ÿche_v¬y
(
r
, 
h
->
v¬y
, h->
v¬y_Ën
, 
c
->
v¬ŸÁ
);

566 ià(
	`ngx_memcmp
(
c
->
v¬ŸÁ
, 
h
->v¬ŸÁ, 
NGX_HTTP_CACHE_KEY_LEN
) != 0) {

567 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

569  
	`ngx_h‰p_fže_ÿche_»Ý’
(
r
, 
c
);

573 
c
->
buf
->
Ï¡
 +ð
n
;

575 
c
->
v®id_£c
 = 
h
->valid_sec;

576 
c
->
Ï¡_modif›d
 = 
h
->last_modified;

577 
c
->
d©e
 = 
h
->date;

578 
c
->
v®id_m£c
 = 
h
->valid_msec;

579 
c
->
h—d”_¡¬t
 = 
h
->header_start;

580 
c
->
body_¡¬t
 = 
h
->body_start;

581 
c
->
‘ag
.
Ën
 = 
h
->
‘ag_Ën
;

582 
c
->
‘ag
.
d©a
 = 
h
->etag;

584 
r
->
ÿched
 = 1;

586 
ÿche
 = 
c
->
fže_ÿche
;

588 ià(
ÿche
->
sh
->
cÞd
) {

590 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

592 ià(!
c
->
node
->
exi¡s
) {

593 
c
->
node
->
u£s
 = 1;

594 
c
->
node
->
body_¡¬t
 = c->body_start;

595 
c
->
node
->
exi¡s
 = 1;

596 
c
->
node
->
uniq
 = c->uniq;

597 
c
->
node
->
fs_size
 = c->fs_size;

599 
ÿche
->
sh
->
size
 +ð
c
->
fs_size
;

602 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

605 
now
 = 
	`ngx_time
();

607 ià(
c
->
v®id_£c
 < 
now
) {

609 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

611 ià(
c
->
node
->
upd©šg
) {

612 
rc
 = 
NGX_HTTP_CACHE_UPDATING
;

615 
c
->
node
->
upd©šg
 = 1;

616 
c
->
upd©šg
 = 1;

617 
c
->
lock_time
 = c->
node
->lock_time;

618 
rc
 = 
NGX_HTTP_CACHE_STALE
;

621 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

623 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

625 
rc
, 
c
->
v®id_£c
, 
now
);

627  
rc
;

630  
NGX_OK
;

631 
	}
}

634 
ssize_t


635 
	$ngx_h‰p_fže_ÿche_aio_»ad
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ÿche_t
 *
c
)

637 #ià(
NGX_HAVE_FILE_AIO
)

638 
ssize_t
 
n
;

639 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

641 ià(!
ngx_fže_aio
) {

642 
nßio
;

645 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

647 ià(!
þcf
->
aio
) {

648 
nßio
;

651 
n
 = 
	`ngx_fže_aio_»ad
(&
c
->
fže
, c->
buf
->
pos
, c->
body_¡¬t
, 0, 
r
->
poÞ
);

653 ià(
n
 !ð
NGX_AGAIN
) {

654 
c
->
»adšg
 = 0;

655  
n
;

658 
c
->
»adšg
 = 1;

660 
c
->
fže
.
aio
->
d©a
 = 
r
;

661 
c
->
fže
.
aio
->
hªdËr
 = 
ngx_h‰p_ÿche_aio_ev’t_hªdËr
;

663 
r
->
maš
->
blocked
++;

664 
r
->
aio
 = 1;

666  
NGX_AGAIN
;

668 
nßio
:

672  
	`ngx_»ad_fže
(&
c
->
fže
, c->
buf
->
pos
, c->
body_¡¬t
, 0);

673 
	}
}

676 #ià(
NGX_HAVE_FILE_AIO
)

679 
	$ngx_h‰p_ÿche_aio_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
)

681 
ngx_ev’t_aio_t
 *
aio
;

682 
ngx_cÚÃùiÚ_t
 *
c
;

683 
ngx_h‰p_»que¡_t
 *
r
;

685 
aio
 = 
ev
->
d©a
;

686 
r
 = 
aio
->
d©a
;

687 
c
 = 
r
->
cÚÃùiÚ
;

689 
	`ngx_h‰p_£t_log_»que¡
(
c
->
log
, 
r
);

691 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

692 "h‰°fžÿchaio: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

694 
r
->
maš
->
blocked
--;

695 
r
->
aio
 = 0;

697 
r
->
	`wr™e_ev’t_hªdËr
(r);

699 
	`ngx_h‰p_run_po¡ed_»que¡s
(
c
);

700 
	}
}

705 
ngx_št_t


706 
	$ngx_h‰p_fže_ÿche_exi¡s
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
, 
ngx_h‰p_ÿche_t
 *
c
)

708 
ngx_št_t
 
rc
;

709 
ngx_h‰p_fže_ÿche_node_t
 *
fú
;

711 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

713 
fú
 = 
c
->
node
;

715 ià(
fú
 =ð
NULL
) {

716 
fú
 = 
	`ngx_h‰p_fže_ÿche_lookup
(
ÿche
, 
c
->
key
);

719 ià(
fú
) {

720 
	`ngx_queue_»move
(&
fú
->
queue
);

722 ià(
c
->
node
 =ð
NULL
) {

723 
fú
->
u£s
++;

724 
fú
->
couÁ
++;

727 ià(
fú
->
”rÜ
) {

729 ià(
fú
->
v®id_£c
 < 
	`ngx_time
()) {

730 
»Ãw
;

733 
rc
 = 
NGX_OK
;

735 
dÚe
;

738 ià(
fú
->
exi¡s
 || fú->
u£s
 >ð
c
->
mš_u£s
) {

740 
c
->
exi¡s
 = 
fú
->exists;

741 ià(
fú
->
body_¡¬t
) {

742 
c
->
body_¡¬t
 = 
fú
->body_start;

745 
rc
 = 
NGX_OK
;

747 
dÚe
;

750 
rc
 = 
NGX_AGAIN
;

752 
dÚe
;

755 
fú
 = 
	`ngx_¦ab_ÿÎoc_locked
(
ÿche
->
shpoÞ
,

756 (
ngx_h‰p_fže_ÿche_node_t
));

757 ià(
fú
 =ð
NULL
) {

758 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

760 (è
	`ngx_h‰p_fže_ÿche_fÜûd_expœe
(
ÿche
);

762 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

764 
fú
 = 
	`ngx_¦ab_ÿÎoc_locked
(
ÿche
->
shpoÞ
,

765 (
ngx_h‰p_fže_ÿche_node_t
));

766 ià(
fú
 =ð
NULL
) {

767 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

768 "could‚Ù‡Îoÿ‹‚ode%s", 
ÿche
->
shpoÞ
->
log_ùx
);

769 
rc
 = 
NGX_ERROR
;

770 
çžed
;

774 
	`ngx_memýy
((
u_ch¬
 *è&
fú
->
node
.
key
, 
c
->key, (
ngx_rbŒ“_key_t
));

776 
	`ngx_memýy
(
fú
->
key
, &
c
->key[(
ngx_rbŒ“_key_t
)],

777 
NGX_HTTP_CACHE_KEY_LEN
 - (
ngx_rbŒ“_key_t
));

779 
	`ngx_rbŒ“_š£¹
(&
ÿche
->
sh
->
rbŒ“
, &
fú
->
node
);

781 
fú
->
u£s
 = 1;

782 
fú
->
couÁ
 = 1;

784 
»Ãw
:

786 
rc
 = 
NGX_DECLINED
;

788 
fú
->
v®id_m£c
 = 0;

789 
fú
->
”rÜ
 = 0;

790 
fú
->
exi¡s
 = 0;

791 
fú
->
v®id_£c
 = 0;

792 
fú
->
uniq
 = 0;

793 
fú
->
body_¡¬t
 = 0;

794 
fú
->
fs_size
 = 0;

796 
dÚe
:

798 
fú
->
expœe
 = 
	`ngx_time
(è+ 
ÿche
->
šaùive
;

800 
	`ngx_queue_š£¹_h—d
(&
ÿche
->
sh
->
queue
, &
fú
->queue);

802 
c
->
uniq
 = 
fú
->uniq;

803 
c
->
”rÜ
 = 
fú
->error;

804 
c
->
node
 = 
fú
;

806 
çžed
:

808 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

810  
rc
;

811 
	}
}

814 
ngx_št_t


815 
	$ngx_h‰p_fže_ÿche_Çme
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_·th_t
 *
·th
)

817 
u_ch¬
 *
p
;

818 
ngx_h‰p_ÿche_t
 *
c
;

820 
c
 = 
r
->
ÿche
;

822 ià(
c
->
fže
.
Çme
.
Ën
) {

823  
NGX_OK
;

826 
c
->
fže
.
Çme
.
Ën
 = 
·th
->name.len + 1 +…ath->len

827 + 2 * 
NGX_HTTP_CACHE_KEY_LEN
;

829 
c
->
fže
.
Çme
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, c->fže.Çme.
Ën
 + 1);

830 ià(
c
->
fže
.
Çme
.
d©a
 =ð
NULL
) {

831  
NGX_ERROR
;

834 
	`ngx_memýy
(
c
->
fže
.
Çme
.
d©a
, 
·th
->Çme.d©a,…©h->Çme.
Ën
);

836 
p
 = 
c
->
fže
.
Çme
.
d©a
 + 
·th
->Çme.
Ën
 + 1 +…ath->len;

837 
p
 = 
	`ngx_hex_dump
Õ, 
c
->
key
, 
NGX_HTTP_CACHE_KEY_LEN
);

838 *
p
 = '\0';

840 
	`ngx_ü—‹_hashed_fž’ame
(
·th
, 
c
->
fže
.
Çme
.
d©a
, c->fže.Çme.
Ën
);

842 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

843 "ÿchfže: \"%s\"", 
c
->
fže
.
Çme
.
d©a
);

845  
NGX_OK
;

846 
	}
}

849 
ngx_h‰p_fže_ÿche_node_t
 *

850 
	$ngx_h‰p_fže_ÿche_lookup
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
, 
u_ch¬
 *
key
)

852 
ngx_št_t
 
rc
;

853 
ngx_rbŒ“_key_t
 
node_key
;

854 
ngx_rbŒ“_node_t
 *
node
, *
£Áš–
;

855 
ngx_h‰p_fže_ÿche_node_t
 *
fú
;

857 
	`ngx_memýy
((
u_ch¬
 *è&
node_key
, 
key
, (
ngx_rbŒ“_key_t
));

859 
node
 = 
ÿche
->
sh
->
rbŒ“
.
roÙ
;

860 
£Áš–
 = 
ÿche
->
sh
->
rbŒ“
.sentinel;

862 
node
 !ð
£Áš–
) {

864 ià(
node_key
 < 
node
->
key
) {

865 
node
 =‚ode->
Ëá
;

869 ià(
node_key
 > 
node
->
key
) {

870 
node
 =‚ode->
right
;

876 
fú
 = (
ngx_h‰p_fže_ÿche_node_t
 *è
node
;

878 
rc
 = 
	`ngx_memcmp
(&
key
[(
ngx_rbŒ“_key_t
)], 
fú
->key,

879 
NGX_HTTP_CACHE_KEY_LEN
 - (
ngx_rbŒ“_key_t
));

881 ià(
rc
 == 0) {

882  
fú
;

885 
node
 = (
rc
 < 0è?‚ode->
Ëá
 :‚ode->
right
;

890  
NULL
;

891 
	}
}

895 
	$ngx_h‰p_fže_ÿche_rbŒ“_š£¹_v®ue
(
ngx_rbŒ“_node_t
 *
‹mp
,

896 
ngx_rbŒ“_node_t
 *
node
,‚gx_rbŒ“_node_ˆ*
£Áš–
)

898 
ngx_rbŒ“_node_t
 **
p
;

899 
ngx_h‰p_fže_ÿche_node_t
 *
ú
, *
út
;

903 ià(
node
->
key
 < 
‹mp
->key) {

905 
p
 = &
‹mp
->
Ëá
;

907 } ià(
node
->
key
 > 
‹mp
->key) {

909 
p
 = &
‹mp
->
right
;

913 
ú
 = (
ngx_h‰p_fže_ÿche_node_t
 *è
node
;

914 
út
 = (
ngx_h‰p_fže_ÿche_node_t
 *è
‹mp
;

916 
p
 = (
	`ngx_memcmp
(
ú
->
key
, 
út
->key,

917 
NGX_HTTP_CACHE_KEY_LEN
 - (
ngx_rbŒ“_key_t
))

919 ? &
‹mp
->
Ëá
 : &‹mp->
right
;

922 ià(*
p
 =ð
£Áš–
) {

926 
‹mp
 = *
p
;

929 *
p
 = 
node
;

930 
node
->
·»Á
 = 
‹mp
;

931 
node
->
Ëá
 = 
£Áš–
;

932 
node
->
right
 = 
£Áš–
;

933 
	`ngx_rbt_»d
(
node
);

934 
	}
}

938 
	$ngx_h‰p_fže_ÿche_v¬y
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
v¬y
, 
size_t
 
Ën
,

939 
u_ch¬
 *
hash
)

941 
u_ch¬
 *
p
, *
Ï¡
;

942 
ngx_¡r_t
 
Çme
;

943 
ngx_md5_t
 
md5
;

944 
u_ch¬
 
buf
[
NGX_HTTP_CACHE_VARY_LEN
];

946 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

947 "h‰°fžÿchv¬y: \"%*s\"", 
Ën
, 
v¬y
);

949 
	`ngx_md5_š™
(&
md5
);

950 
	`ngx_md5_upd©e
(&
md5
, 
r
->
ÿche
->
maš
, 
NGX_HTTP_CACHE_KEY_LEN
);

952 
	`ngx_¡¾ow
(
buf
, 
v¬y
, 
Ën
);

954 
p
 = 
buf
;

955 
Ï¡
 = 
buf
 + 
Ën
;

957 
p
 < 
Ï¡
) {

959 
p
 < 
Ï¡
 && (*p == ' ' || *p == ',')) {…++; }

961 
Çme
.
d©a
 = 
p
;

963 
p
 < 
Ï¡
 && *p != ',' && *p != ' ') {…++; }

965 
Çme
.
Ën
 = 
p
 -‚ame.
d©a
;

967 ià(
Çme
.
Ën
 == 0) {

971 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

972 "h‰°fžÿchv¬y: %V", &
Çme
);

974 
	`ngx_md5_upd©e
(&
md5
, 
Çme
.
d©a
,‚ame.
Ën
);

975 
	`ngx_md5_upd©e
(&
md5
, (
u_ch¬
 *) ":", (":") - 1);

977 
	`ngx_h‰p_fže_ÿche_v¬y_h—d”
(
r
, &
md5
, &
Çme
);

979 
	`ngx_md5_upd©e
(&
md5
, (
u_ch¬
 *è
CRLF
, (CRLF) - 1);

982 
	`ngx_md5_fš®
(
hash
, &
md5
);

983 
	}
}

987 
	$ngx_h‰p_fže_ÿche_v¬y_h—d”
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_md5_t
 *
md5
,

988 
ngx_¡r_t
 *
Çme
)

990 
size_t
 
Ën
;

991 
u_ch¬
 *
p
, *
¡¬t
, *
Ï¡
;

992 
ngx_ušt_t
 
i
, 
muÉË
, 
nÜm®ize
;

993 
ngx_li¡_·¹_t
 *
·¹
;

994 
ngx_bË_–t_t
 *
h—d”
;

996 
muÉË
 = 0;

997 
nÜm®ize
 = 0;

999 ià(
Çme
->
Ën
 == ("Accept-Charset") - 1

1000 && 
	`ngx_¡ºÿ£cmp
(
Çme
->
d©a
, (
u_ch¬
 *) "Accept-Charset",

1003 
nÜm®ize
 = 1;

1005 } ià(
Çme
->
Ën
 == ("Accept-Encoding") - 1

1006 && 
	`ngx_¡ºÿ£cmp
(
Çme
->
d©a
, (
u_ch¬
 *) "Accept-Encoding",

1009 
nÜm®ize
 = 1;

1011 } ià(
Çme
->
Ën
 == ("Accept-Language") - 1

1012 && 
	`ngx_¡ºÿ£cmp
(
Çme
->
d©a
, (
u_ch¬
 *) "Accept-Language",

1015 
nÜm®ize
 = 1;

1018 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

1019 
h—d”
 = 
·¹
->
–ts
;

1021 
i
 = 0; ; i++) {

1023 ià(
i
 >ð
·¹
->
ÃÉs
) {

1024 ià(
·¹
->
Ãxt
 =ð
NULL
) {

1028 
·¹
 =…¬t->
Ãxt
;

1029 
h—d”
 = 
·¹
->
–ts
;

1030 
i
 = 0;

1033 ià(
h—d”
[
i
].
hash
 == 0) {

1037 ià(
h—d”
[
i
].
key
.
Ën
 !ð
Çme
->len) {

1041 ià(
	`ngx_¡ºÿ£cmp
(
h—d”
[
i
].
key
.
d©a
, 
Çme
->d©a,‚ame->
Ën
) != 0) {

1045 ià(!
nÜm®ize
) {

1047 ià(
muÉË
) {

1048 
	`ngx_md5_upd©e
(
md5
, (
u_ch¬
 *) ",", (",") - 1);

1051 
	`ngx_md5_upd©e
(
md5
, 
h—d”
[
i
].
v®ue
.
d©a
, h—d”[i].v®ue.
Ën
);

1053 
muÉË
 = 1;

1060 
p
 = 
h—d”
[
i
].
v®ue
.
d©a
;

1061 
Ï¡
 = 
p
 + 
h—d”
[
i
].
v®ue
.
Ën
;

1063 
p
 < 
Ï¡
) {

1065 
p
 < 
Ï¡
 && (*p == ' ' || *p == ',')) {…++; }

1067 
¡¬t
 = 
p
;

1069 
p
 < 
Ï¡
 && *p != ',' && *p != ' ') {…++; }

1071 
Ën
 = 
p
 - 
¡¬t
;

1073 ià(
Ën
 == 0) {

1077 ià(
muÉË
) {

1078 
	`ngx_md5_upd©e
(
md5
, (
u_ch¬
 *) ",", (",") - 1);

1081 
	`ngx_md5_upd©e
(
md5
, 
¡¬t
, 
Ën
);

1083 
muÉË
 = 1;

1086 
	}
}

1089 
ngx_št_t


1090 
	$ngx_h‰p_fže_ÿche_»Ý’
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_ÿche_t
 *
c
)

1092 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

1094 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
fže
.
log
, 0,

1097 ià(
c
->
£cÚd¬y
) {

1098 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 0,

1100 
c
->
fže
.
Çme
.
d©a
);

1101  
NGX_DECLINED
;

1104 
ÿche
 = 
c
->
fže_ÿche
;

1106 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1108 
c
->
node
->
couÁ
--;

1109 
c
->
node
 = 
NULL
;

1111 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1113 
c
->
£cÚd¬y
 = 1;

1114 
c
->
fže
.
Çme
.
Ën
 = 0;

1115 
c
->
body_¡¬t
 = c->
buf
->
’d
 - c->buf->
¡¬t
;

1117 
	`ngx_memýy
(
c
->
key
, c->
v¬ŸÁ
, 
NGX_HTTP_CACHE_KEY_LEN
);

1119  
	`ngx_h‰p_fže_ÿche_Ý’
(
r
);

1120 
	}
}

1124 
	$ngx_h‰p_fže_ÿche_£t_h—d”
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
buf
)

1126 
ngx_h‰p_fže_ÿche_h—d”_t
 *
h
 = (ngx_h‰p_fže_ÿche_h—d”_ˆ*è
buf
;

1128 
u_ch¬
 *
p
;

1129 
ngx_¡r_t
 *
key
;

1130 
ngx_ušt_t
 
i
;

1131 
ngx_h‰p_ÿche_t
 *
c
;

1133 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1136 
c
 = 
r
->
ÿche
;

1138 
	`ngx_memz”o
(
h
, (
ngx_h‰p_fže_ÿche_h—d”_t
));

1140 
h
->
v”siÚ
 = 
NGX_HTTP_CACHE_VERSION
;

1141 
h
->
v®id_£c
 = 
c
->valid_sec;

1142 
h
->
Ï¡_modif›d
 = 
c
->last_modified;

1143 
h
->
d©e
 = 
c
->date;

1144 
h
->
üc32
 = 
c
->crc32;

1145 
h
->
v®id_m£c
 = (
u_shÜt
è
c
->valid_msec;

1146 
h
->
h—d”_¡¬t
 = (
u_shÜt
è
c
->header_start;

1147 
h
->
body_¡¬t
 = (
u_shÜt
è
c
->body_start;

1149 ià(
c
->
‘ag
.
Ën
 <ð
NGX_HTTP_CACHE_ETAG_LEN
) {

1150 
h
->
‘ag_Ën
 = (
u_ch¬
è
c
->
‘ag
.
Ën
;

1151 
	`ngx_memýy
(
h
->
‘ag
, 
c
->‘ag.
d©a
, c->‘ag.
Ën
);

1154 ià(
c
->
v¬y
.
Ën
) {

1155 ià(
c
->
v¬y
.
Ën
 > 
NGX_HTTP_CACHE_VARY_LEN
) {

1157 
c
->
v¬y
.
Ën
 = 
NGX_HTTP_CACHE_VARY_LEN
;

1160 
h
->
v¬y_Ën
 = (
u_ch¬
è
c
->
v¬y
.
Ën
;

1161 
	`ngx_memýy
(
h
->
v¬y
, 
c
->v¬y.
d©a
, c->v¬y.
Ën
);

1163 
	`ngx_h‰p_fže_ÿche_v¬y
(
r
, 
c
->
v¬y
.
d©a
, c->v¬y.
Ën
, c->
v¬ŸÁ
);

1164 
	`ngx_memýy
(
h
->
v¬ŸÁ
, 
c
->v¬ŸÁ, 
NGX_HTTP_CACHE_KEY_LEN
);

1167 
	`ngx_memz”o
(
c
->
v¬ŸÁ
, 
NGX_HTTP_CACHE_KEY_LEN
);

1170 
p
 = 
buf
 + (
ngx_h‰p_fže_ÿche_h—d”_t
);

1172 
p
 = 
	`ngx_ýymem
Õ, 
ngx_h‰p_fže_ÿche_key
, (ngx_http_file_cache_key));

1174 
key
 = 
c
->
keys
.
–ts
;

1175 
i
 = 0; i < 
c
->
keys
.
ÃÉs
; i++) {

1176 
p
 = 
	`ngx_cÝy
Õ, 
key
[
i
].
d©a
, key[i].
Ën
);

1179 *
p
 = 
LF
;

1180 
	}
}

1184 
	$ngx_h‰p_fže_ÿche_upd©e
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_‹mp_fže_t
 *
tf
)

1186 
off_t
 
fs_size
;

1187 
ngx_št_t
 
rc
;

1188 
ngx_fže_uniq_t
 
uniq
;

1189 
ngx_fže_šfo_t
 
fi
;

1190 
ngx_h‰p_ÿche_t
 *
c
;

1191 
ngx_ext_»Çme_fže_t
 
ext
;

1192 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

1194 
c
 = 
r
->
ÿche
;

1196 ià(
c
->
upd©ed
) {

1200 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1203 
ÿche
 = 
c
->
fže_ÿche
;

1205 ià(
c
->
£cÚd¬y


1206 && 
	`ngx_memcmp
(
c
->
v¬ŸÁ
, c->
key
, 
NGX_HTTP_CACHE_KEY_LEN
) != 0)

1213 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1216 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1218 
c
->
node
->
couÁ
--;

1219 
c
->
node
->
upd©šg
 = 0;

1220 
c
->
node
 = 
NULL
;

1222 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1224 
c
->
fže
.
Çme
.
Ën
 = 0;

1226 
	`ngx_memýy
(
c
->
key
, c->
maš
, 
NGX_HTTP_CACHE_KEY_LEN
);

1228 ià(
	`ngx_h‰p_fže_ÿche_exi¡s
(
ÿche
, 
c
è=ð
NGX_ERROR
) {

1232 ià(
	`ngx_h‰p_fže_ÿche_Çme
(
r
, 
ÿche
->
·th
è!ð
NGX_OK
) {

1237 
c
->
upd©ed
 = 1;

1238 
c
->
upd©šg
 = 0;

1240 
uniq
 = 0;

1241 
fs_size
 = 0;

1243 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1245 
tf
->
fže
.
Çme
.
d©a
, 
c
->file.name.data);

1247 
ext
.
acûss
 = 
NGX_FILE_OWNER_ACCESS
;

1248 
ext
.
·th_acûss
 = 
NGX_FILE_OWNER_ACCESS
;

1249 
ext
.
time
 = -1;

1250 
ext
.
ü—‹_·th
 = 1;

1251 
ext
.
d–‘e_fže
 = 1;

1252 
ext
.
log
 = 
r
->
cÚÃùiÚ
->log;

1254 
rc
 = 
	`ngx_ext_»Çme_fže
(&
tf
->
fže
.
Çme
, &
c
->fže.Çme, &
ext
);

1256 ià(
rc
 =ð
NGX_OK
) {

1258 ià(
	`ngx_fd_šfo
(
tf
->
fže
.
fd
, &
fi
è=ð
NGX_FILE_ERROR
) {

1259 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

1260 
ngx_fd_šfo_n
 " \"%s\" fažed", 
tf
->
fže
.
Çme
.
d©a
);

1262 
rc
 = 
NGX_ERROR
;

1265 
uniq
 = 
	`ngx_fže_uniq
(&
fi
);

1266 
fs_size
 = (
	`ngx_fže_fs_size
(&
fi
è+ 
ÿche
->
bsize
 - 1) / cache->bsize;

1270 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1272 
c
->
node
->
couÁ
--;

1273 
c
->
node
->
uniq
 = uniq;

1274 
c
->
node
->
body_¡¬t
 = c->body_start;

1276 
ÿche
->
sh
->
size
 +ð
fs_size
 - 
c
->
node
->fs_size;

1277 
c
->
node
->
fs_size
 = fs_size;

1279 ià(
rc
 =ð
NGX_OK
) {

1280 
c
->
node
->
exi¡s
 = 1;

1283 
c
->
node
->
upd©šg
 = 0;

1285 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1286 
	}
}

1290 
	$ngx_h‰p_fže_ÿche_upd©e_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

1292 
ssize_t
 
n
;

1293 
ngx_”r_t
 
”r
;

1294 
ngx_fže_t
 
fže
;

1295 
ngx_fže_šfo_t
 
fi
;

1296 
ngx_h‰p_ÿche_t
 *
c
;

1297 
ngx_h‰p_fže_ÿche_h—d”_t
 
h
;

1299 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1302 
c
 = 
r
->
ÿche
;

1304 
	`ngx_memz”o
(&
fže
, (
ngx_fže_t
));

1306 
fže
.
Çme
 = 
c
->file.name;

1307 
fže
.
log
 = 
r
->
cÚÃùiÚ
->log;

1308 
fže
.
fd
 = 
	`ngx_Ý’_fže
(fže.
Çme
.
d©a
, 
NGX_FILE_RDWR
, 
NGX_FILE_OPEN
, 0);

1310 ià(
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

1311 
”r
 = 
ngx_”ºo
;

1315 ià(
”r
 =ð
NGX_ENOENT
) {

1316 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1318 
fže
.
Çme
.
d©a
);

1322 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
”r
,

1323 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
fže
.
Çme
.
d©a
);

1332 ià(
	`ngx_fd_šfo
(
fže
.
fd
, &
fi
è=ð
NGX_FILE_ERROR
) {

1333 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

1334 
ngx_fd_šfo_n
 " \"%s\" fažed", 
fže
.
Çme
.
d©a
);

1335 
dÚe
;

1338 ià(
c
->
uniq
 !ð
	`ngx_fže_uniq
(&
fi
)

1339 || 
c
->
Ëngth
 !ð
	`ngx_fže_size
(&
fi
))

1341 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1343 
fže
.
Çme
.
d©a
);

1344 
dÚe
;

1347 
n
 = 
	`ngx_»ad_fže
(&
fže
, (
u_ch¬
 *è&
h
,

1348 (
ngx_h‰p_fže_ÿche_h—d”_t
), 0);

1350 ià(
n
 =ð
NGX_ERROR
) {

1351 
dÚe
;

1354 ià((
size_t
è
n
 !ð(
ngx_h‰p_fže_ÿche_h—d”_t
)) {

1355 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 0,

1356 
ngx_»ad_fže_n
 "„ead only %z of %z from \"%s\"",

1357 
n
, (
ngx_h‰p_fže_ÿche_h—d”_t
), 
fže
.
Çme
.
d©a
);

1358 
dÚe
;

1361 ià(
h
.
v”siÚ
 !ð
NGX_HTTP_CACHE_VERSION


1362 || 
h
.
Ï¡_modif›d
 !ð
c
->last_modified

1363 || 
h
.
üc32
 !ð
c
->crc32

1364 || 
h
.
h—d”_¡¬t
 !ð
c
->header_start

1365 || 
h
.
body_¡¬t
 !ð
c
->body_start)

1367 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1369 
fže
.
Çme
.
d©a
);

1370 
dÚe
;

1378 
	`ngx_memz”o
(&
h
, (
ngx_h‰p_fže_ÿche_h—d”_t
));

1380 
h
.
v”siÚ
 = 
NGX_HTTP_CACHE_VERSION
;

1381 
h
.
v®id_£c
 = 
c
->valid_sec;

1382 
h
.
Ï¡_modif›d
 = 
c
->last_modified;

1383 
h
.
d©e
 = 
c
->date;

1384 
h
.
üc32
 = 
c
->crc32;

1385 
h
.
v®id_m£c
 = (
u_shÜt
è
c
->valid_msec;

1386 
h
.
h—d”_¡¬t
 = (
u_shÜt
è
c
->header_start;

1387 
h
.
body_¡¬t
 = (
u_shÜt
è
c
->body_start;

1389 ià(
c
->
‘ag
.
Ën
 <ð
NGX_HTTP_CACHE_ETAG_LEN
) {

1390 
h
.
‘ag_Ën
 = (
u_ch¬
è
c
->
‘ag
.
Ën
;

1391 
	`ngx_memýy
(
h
.
‘ag
, 
c
->‘ag.
d©a
, c->‘ag.
Ën
);

1394 ià(
c
->
v¬y
.
Ën
) {

1395 ià(
c
->
v¬y
.
Ën
 > 
NGX_HTTP_CACHE_VARY_LEN
) {

1397 
c
->
v¬y
.
Ën
 = 
NGX_HTTP_CACHE_VARY_LEN
;

1400 
h
.
v¬y_Ën
 = (
u_ch¬
è
c
->
v¬y
.
Ën
;

1401 
	`ngx_memýy
(
h
.
v¬y
, 
c
->v¬y.
d©a
, c->v¬y.
Ën
);

1403 
	`ngx_h‰p_fže_ÿche_v¬y
(
r
, 
c
->
v¬y
.
d©a
, c->v¬y.
Ën
, c->
v¬ŸÁ
);

1404 
	`ngx_memýy
(
h
.
v¬ŸÁ
, 
c
->v¬ŸÁ, 
NGX_HTTP_CACHE_KEY_LEN
);

1407 (è
	`ngx_wr™e_fže
(&
fže
, (
u_ch¬
 *è&
h
,

1408 (
ngx_h‰p_fže_ÿche_h—d”_t
), 0);

1410 
dÚe
:

1412 ià(
	`ngx_þo£_fže
(
fže
.
fd
è=ð
NGX_FILE_ERROR
) {

1413 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

1414 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fže
.
Çme
.
d©a
);

1416 
	}
}

1419 
ngx_št_t


1420 
	$ngx_h‰p_ÿche_£nd
(
ngx_h‰p_»que¡_t
 *
r
)

1422 
ngx_št_t
 
rc
;

1423 
ngx_buf_t
 *
b
;

1424 
ngx_chaš_t
 
out
;

1425 
ngx_h‰p_ÿche_t
 *
c
;

1427 
c
 = 
r
->
ÿche
;

1429 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1430 "h‰°fžÿch£nd: %s", 
c
->
fže
.
Çme
.
d©a
);

1432 ià(
r
 !ðr->
maš
 && 
c
->
Ëngth
 - c->
body_¡¬t
 == 0) {

1433  
	`ngx_h‰p_£nd_h—d”
(
r
);

1438 
b
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_buf_t
));

1439 ià(
b
 =ð
NULL
) {

1440  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1443 
b
->
fže
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_fže_t
));

1444 ià(
b
->
fže
 =ð
NULL
) {

1445  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1448 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

1450 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
h—d”_Úly
) {

1451  
rc
;

1454 
b
->
fže_pos
 = 
c
->
body_¡¬t
;

1455 
b
->
fže_Ï¡
 = 
c
->
Ëngth
;

1457 
b
->
š_fže
 = (
c
->
Ëngth
 - c->
body_¡¬t
) ? 1: 0;

1458 
b
->
Ï¡_buf
 = (
r
 =ðr->
maš
) ? 1: 0;

1459 
b
->
Ï¡_š_chaš
 = 1;

1461 
b
->
fže
->
fd
 = 
c
->file.fd;

1462 
b
->
fže
->
Çme
 = 
c
->file.name;

1463 
b
->
fže
->
log
 = 
r
->
cÚÃùiÚ
->log;

1465 
out
.
buf
 = 
b
;

1466 
out
.
Ãxt
 = 
NULL
;

1468  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

1469 
	}
}

1473 
	$ngx_h‰p_fže_ÿche_ä“
(
ngx_h‰p_ÿche_t
 *
c
, 
ngx_‹mp_fže_t
 *
tf
)

1475 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

1476 
ngx_h‰p_fže_ÿche_node_t
 *
fú
;

1478 ià(
c
->
upd©ed
 || c->
node
 =ð
NULL
) {

1482 
ÿche
 = 
c
->
fže_ÿche
;

1484 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
fže
.
log
, 0,

1485 "h‰°fžÿchä“, fd: %d", 
c
->
fže
.
fd
);

1487 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1489 
fú
 = 
c
->
node
;

1490 
fú
->
couÁ
--;

1492 ià(
c
->
upd©šg
 && 
fú
->
lock_time
 == c->lock_time) {

1493 
fú
->
upd©šg
 = 0;

1496 ià(
c
->
”rÜ
) {

1497 
fú
->
”rÜ
 = 
c
->error;

1499 ià(
c
->
v®id_£c
) {

1500 
fú
->
v®id_£c
 = 
c
->valid_sec;

1501 
fú
->
v®id_m£c
 = 
c
->valid_msec;

1504 } ià(!
fú
->
exi¡s
 && fú->
couÁ
 =ð0 && 
c
->
mš_u£s
 == 1) {

1505 
	`ngx_queue_»move
(&
fú
->
queue
);

1506 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
sh
->
rbŒ“
, &
fú
->
node
);

1507 
	`ngx_¦ab_ä“_locked
(
ÿche
->
shpoÞ
, 
fú
);

1508 
c
->
node
 = 
NULL
;

1511 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1513 
c
->
upd©ed
 = 1;

1514 
c
->
upd©šg
 = 0;

1516 ià(
c
->
‹mp_fže
) {

1517 ià(
tf
 &&f->
fže
.
fd
 !ð
NGX_INVALID_FILE
) {

1518 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
fže
.
log
, 0,

1520 
tf
->
fže
.
Çme
.
d©a
);

1522 ià(
	`ngx_d–‘e_fže
(
tf
->
fže
.
Çme
.
d©a
è=ð
NGX_FILE_ERROR
) {

1523 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
c
->
fže
.
log
, 
ngx_”ºo
,

1524 
ngx_d–‘e_fže_n
 " \"%s\" failed",

1525 
tf
->
fže
.
Çme
.
d©a
);

1530 ià(
c
->
wa™_ev’t
.
tim”_£t
) {

1531 
	`ngx_d–_tim”
(&
c
->
wa™_ev’t
);

1533 
	}
}

1537 
	$ngx_h‰p_fže_ÿche_þ—nup
(*
d©a
)

1539 
ngx_h‰p_ÿche_t
 *
c
 = 
d©a
;

1541 ià(
c
->
upd©ed
) {

1545 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
fže
.
log
, 0,

1548 ià(
c
->
upd©šg
) {

1549 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
fže
.
log
, 0,

1550 "¡®Ëd cachupd©šg,ƒ¼Ü:%ui", 
c
->
”rÜ
);

1553 
	`ngx_h‰p_fže_ÿche_ä“
(
c
, 
NULL
);

1554 
	}
}

1557 
time_t


1558 
	$ngx_h‰p_fže_ÿche_fÜûd_expœe
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
)

1560 
u_ch¬
 *
Çme
;

1561 
size_t
 
Ën
;

1562 
time_t
 
wa™
;

1563 
ngx_ušt_t
 
Œ›s
;

1564 
ngx_·th_t
 *
·th
;

1565 
ngx_queue_t
 *
q
;

1566 
ngx_h‰p_fže_ÿche_node_t
 *
fú
;

1568 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0,

1571 
·th
 = 
ÿche
->path;

1572 
Ën
 = 
·th
->
Çme
.ËÀ+ 1 +…©h->ËÀ+ 2 * 
NGX_HTTP_CACHE_KEY_LEN
;

1574 
Çme
 = 
	`ngx_®loc
(
Ën
 + 1, 
ngx_cyþe
->
log
);

1575 ià(
Çme
 =ð
NULL
) {

1579 
	`ngx_memýy
(
Çme
, 
·th
->Çme.
d©a
,…©h->Çme.
Ën
);

1581 
wa™
 = 10;

1582 
Œ›s
 = 20;

1584 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1586 
q
 = 
	`ngx_queue_Ï¡
(&
ÿche
->
sh
->
queue
);

1587 
q
 !ð
	`ngx_queue_£Áš–
(&
ÿche
->
sh
->
queue
);

1588 
q
 = 
	`ngx_queue_´ev
(q))

1590 
fú
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_fže_ÿche_node_t
, 
queue
);

1592 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0,

1594 
fú
->
couÁ
, fú->
exi¡s
,

1595 
fú
->
key
[0], fcn->key[1], fcn->key[2], fcn->key[3]);

1597 ià(
fú
->
couÁ
 == 0) {

1598 
	`ngx_h‰p_fže_ÿche_d–‘e
(
ÿche
, 
q
, 
Çme
);

1599 
wa™
 = 0;

1602 ià(--
Œ›s
) {

1606 
wa™
 = 1;

1612 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1614 
	`ngx_ä“
(
Çme
);

1616  
wa™
;

1617 
	}
}

1620 
time_t


1621 
	$ngx_h‰p_fže_ÿche_expœe
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
)

1623 
u_ch¬
 *
Çme
, *
p
;

1624 
size_t
 
Ën
;

1625 
time_t
 
now
, 
wa™
;

1626 
ngx_·th_t
 *
·th
;

1627 
ngx_queue_t
 *
q
;

1628 
ngx_h‰p_fže_ÿche_node_t
 *
fú
;

1629 
u_ch¬
 
key
[2 * 
NGX_HTTP_CACHE_KEY_LEN
];

1631 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0,

1634 
·th
 = 
ÿche
->path;

1635 
Ën
 = 
·th
->
Çme
.ËÀ+ 1 +…©h->ËÀ+ 2 * 
NGX_HTTP_CACHE_KEY_LEN
;

1637 
Çme
 = 
	`ngx_®loc
(
Ën
 + 1, 
ngx_cyþe
->
log
);

1638 ià(
Çme
 =ð
NULL
) {

1642 
	`ngx_memýy
(
Çme
, 
·th
->Çme.
d©a
,…©h->Çme.
Ën
);

1644 
now
 = 
	`ngx_time
();

1646 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1650 ià(
ngx_qu™
 || 
ngx_‹rmš©e
) {

1651 
wa™
 = 1;

1655 ià(
	`ngx_queue_em±y
(&
ÿche
->
sh
->
queue
)) {

1656 
wa™
 = 10;

1660 
q
 = 
	`ngx_queue_Ï¡
(&
ÿche
->
sh
->
queue
);

1662 
fú
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_fže_ÿche_node_t
, 
queue
);

1664 
wa™
 = 
fú
->
expœe
 - 
now
;

1666 ià(
wa™
 > 0) {

1667 
wa™
 = wait > 10 ? 10 : wait;

1671 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0,

1673 
fú
->
couÁ
, fú->
exi¡s
,

1674 
fú
->
key
[0], fcn->key[1], fcn->key[2], fcn->key[3]);

1676 ià(
fú
->
couÁ
 == 0) {

1677 
	`ngx_h‰p_fže_ÿche_d–‘e
(
ÿche
, 
q
, 
Çme
);

1681 ià(
fú
->
d–‘šg
) {

1682 
wa™
 = 1;

1686 
p
 = 
	`ngx_hex_dump
(
key
, (
u_ch¬
 *è&
fú
->
node
.key,

1687 (
ngx_rbŒ“_key_t
));

1688 
Ën
 = 
NGX_HTTP_CACHE_KEY_LEN
 - (
ngx_rbŒ“_key_t
);

1689 (è
	`ngx_hex_dump
(
p
, 
fú
->
key
, 
Ën
);

1697 
	`ngx_queue_»move
(
q
);

1698 
fú
->
expœe
 = 
	`ngx_time
(è+ 
ÿche
->
šaùive
;

1699 
	`ngx_queue_š£¹_h—d
(&
ÿche
->
sh
->
queue
, &
fú
->queue);

1701 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

1703 2 * 
NGX_HTTP_CACHE_KEY_LEN
, 
key
, 
fú
->
couÁ
);

1706 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1708 
	`ngx_ä“
(
Çme
);

1710  
wa™
;

1711 
	}
}

1715 
	$ngx_h‰p_fže_ÿche_d–‘e
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
, 
ngx_queue_t
 *
q
,

1716 
u_ch¬
 *
Çme
)

1718 
u_ch¬
 *
p
;

1719 
size_t
 
Ën
;

1720 
ngx_·th_t
 *
·th
;

1721 
ngx_h‰p_fže_ÿche_node_t
 *
fú
;

1723 
fú
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_fže_ÿche_node_t
, 
queue
);

1725 ià(
fú
->
exi¡s
) {

1726 
ÿche
->
sh
->
size
 -ð
fú
->
fs_size
;

1728 
·th
 = 
ÿche
->path;

1729 
p
 = 
Çme
 + 
·th
->Çme.
Ën
 + 1 +…ath->len;

1730 
p
 = 
	`ngx_hex_dump
Õ, (
u_ch¬
 *è&
fú
->
node
.
key
,

1731 (
ngx_rbŒ“_key_t
));

1732 
Ën
 = 
NGX_HTTP_CACHE_KEY_LEN
 - (
ngx_rbŒ“_key_t
);

1733 
p
 = 
	`ngx_hex_dump
Õ, 
fú
->
key
, 
Ën
);

1734 *
p
 = '\0';

1736 
fú
->
couÁ
++;

1737 
fú
->
d–‘šg
 = 1;

1738 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1740 
Ën
 = 
·th
->
Çme
.ËÀ+ 1 +…©h->ËÀ+ 2 * 
NGX_HTTP_CACHE_KEY_LEN
;

1741 
	`ngx_ü—‹_hashed_fž’ame
(
·th
, 
Çme
, 
Ën
);

1743 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0,

1744 "h‰°fžÿchexpœe: \"%s\"", 
Çme
);

1746 ià(
	`ngx_d–‘e_fže
(
Çme
è=ð
NGX_FILE_ERROR
) {

1747 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ngx_cyþe
->
log
, 
ngx_”ºo
,

1748 
ngx_d–‘e_fže_n
 " \"%s\" fažed", 
Çme
);

1751 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1752 
fú
->
couÁ
--;

1753 
fú
->
d–‘šg
 = 0;

1756 ià(
fú
->
couÁ
 == 0) {

1757 
	`ngx_queue_»move
(
q
);

1758 
	`ngx_rbŒ“_d–‘e
(&
ÿche
->
sh
->
rbŒ“
, &
fú
->
node
);

1759 
	`ngx_¦ab_ä“_locked
(
ÿche
->
shpoÞ
, 
fú
);

1761 
	}
}

1764 
time_t


1765 
	$ngx_h‰p_fže_ÿche_mªag”
(*
d©a
)

1767 
ngx_h‰p_fže_ÿche_t
 *
ÿche
 = 
d©a
;

1769 
off_t
 
size
;

1770 
time_t
 
Ãxt
, 
wa™
;

1772 
Ãxt
 = 
	`ngx_h‰p_fže_ÿche_expœe
(
ÿche
);

1774 
ÿche
->
Ï¡
 = 
ngx_cu¼’t_m£c
;

1775 
ÿche
->
fžes
 = 0;

1778 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1780 
size
 = 
ÿche
->
sh
->size;

1782 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1784 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0,

1785 "h‰°fžÿchsize: %O", 
size
);

1787 ià(
size
 < 
ÿche
->
max_size
) {

1788  
Ãxt
;

1791 
wa™
 = 
	`ngx_h‰p_fže_ÿche_fÜûd_expœe
(
ÿche
);

1793 ià(
wa™
 > 0) {

1794  
wa™
;

1797 ià(
ngx_qu™
 || 
ngx_‹rmš©e
) {

1798  
Ãxt
;

1801 
	}
}

1805 
	$ngx_h‰p_fže_ÿche_lßd”
(*
d©a
)

1807 
ngx_h‰p_fže_ÿche_t
 *
ÿche
 = 
d©a
;

1809 
ngx_Œ“_ùx_t
 
Œ“
;

1811 ià(!
ÿche
->
sh
->
cÞd
 || cache->sh->
lßdšg
) {

1815 ià(!
	`ngx_©omic_cmp_£t
(&
ÿche
->
sh
->
lßdšg
, 0, 
ngx_pid
)) {

1819 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0,

1822 
Œ“
.
š™_hªdËr
 = 
NULL
;

1823 
Œ“
.
fže_hªdËr
 = 
ngx_h‰p_fže_ÿche_mªage_fže
;

1824 
Œ“
.
´e_Œ“_hªdËr
 = 
ngx_h‰p_fže_ÿche_noÝ
;

1825 
Œ“
.
po¡_Œ“_hªdËr
 = 
ngx_h‰p_fže_ÿche_noÝ
;

1826 
Œ“
.
¥ec_hªdËr
 = 
ngx_h‰p_fže_ÿche_d–‘e_fže
;

1827 
Œ“
.
d©a
 = 
ÿche
;

1828 
Œ“
.
®loc
 = 0;

1829 
Œ“
.
log
 = 
ngx_cyþe
->log;

1831 
ÿche
->
Ï¡
 = 
ngx_cu¼’t_m£c
;

1832 
ÿche
->
fžes
 = 0;

1834 ià(
	`ngx_w®k_Œ“
(&
Œ“
, &
ÿche
->
·th
->
Çme
è=ð
NGX_ABORT
) {

1835 
ÿche
->
sh
->
lßdšg
 = 0;

1839 
ÿche
->
sh
->
cÞd
 = 0;

1840 
ÿche
->
sh
->
lßdšg
 = 0;

1842 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
ngx_cyþe
->
log
, 0,

1844 &
ÿche
->
·th
->
Çme
,

1845 ((è
ÿche
->
sh
->
size
 * cache->
bsize
) / (1024 * 1024),

1846 
ÿche
->
bsize
);

1847 
	}
}

1850 
ngx_št_t


1851 
	$ngx_h‰p_fže_ÿche_noÝ
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

1853  
NGX_OK
;

1854 
	}
}

1857 
ngx_št_t


1858 
	$ngx_h‰p_fže_ÿche_mªage_fže
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

1860 
ngx_m£c_t
 
–­£d
;

1861 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

1863 
ÿche
 = 
ùx
->
d©a
;

1865 ià(
	`ngx_h‰p_fže_ÿche_add_fže
(
ùx
, 
·th
è!ð
NGX_OK
) {

1866 (è
	`ngx_h‰p_fže_ÿche_d–‘e_fže
(
ùx
, 
·th
);

1869 ià(++
ÿche
->
fžes
 >ðÿche->
lßd”_fžes
) {

1870 
	`ngx_h‰p_fže_ÿche_lßd”_¦“p
(
ÿche
);

1873 
	`ngx_time_upd©e
();

1875 
–­£d
 = 
	`ngx_abs
((
ngx_m£c_št_t
è(
ngx_cu¼’t_m£c
 - 
ÿche
->
Ï¡
));

1877 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ngx_cyþe
->
log
, 0,

1878 "h‰°fžÿchlßd”im–­£d: %M", 
–­£d
);

1880 ià(
–­£d
 >ð
ÿche
->
lßd”_th»shÞd
) {

1881 
	`ngx_h‰p_fže_ÿche_lßd”_¦“p
(
ÿche
);

1885  (
ngx_qu™
 || 
ngx_‹rmš©e
è? 
NGX_ABORT
 : 
NGX_OK
;

1886 
	}
}

1890 
	$ngx_h‰p_fže_ÿche_lßd”_¦“p
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
)

1892 
	`ngx_m¦“p
(
ÿche
->
lßd”_¦“p
);

1894 
	`ngx_time_upd©e
();

1896 
ÿche
->
Ï¡
 = 
ngx_cu¼’t_m£c
;

1897 
ÿche
->
fžes
 = 0;

1898 
	}
}

1901 
ngx_št_t


1902 
	$ngx_h‰p_fže_ÿche_add_fže
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
Çme
)

1904 
u_ch¬
 *
p
;

1905 
ngx_št_t
 
n
;

1906 
ngx_ušt_t
 
i
;

1907 
ngx_h‰p_ÿche_t
 
c
;

1908 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

1910 ià(
Çme
->
Ën
 < 2 * 
NGX_HTTP_CACHE_KEY_LEN
) {

1911  
NGX_ERROR
;

1914 ià(
ùx
->
size
 < (
off_t
è(
ngx_h‰p_fže_ÿche_h—d”_t
)) {

1915 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 0,

1916 "ÿchfž\"%s\" i toØsm®l", 
Çme
->
d©a
);

1917  
NGX_ERROR
;

1920 
	`ngx_memz”o
(&
c
, (
ngx_h‰p_ÿche_t
));

1921 
ÿche
 = 
ùx
->
d©a
;

1923 
c
.
Ëngth
 = 
ùx
->
size
;

1924 
c
.
fs_size
 = (
ùx
->fs_siz+ 
ÿche
->
bsize
 - 1) / cache->bsize;

1926 
p
 = &
Çme
->
d©a
[Çme->
Ën
 - 2 * 
NGX_HTTP_CACHE_KEY_LEN
];

1928 
i
 = 0; i < 
NGX_HTTP_CACHE_KEY_LEN
; i++) {

1929 
n
 = 
	`ngx_hextoi
(
p
, 2);

1931 ià(
n
 =ð
NGX_ERROR
) {

1932  
NGX_ERROR
;

1935 
p
 += 2;

1937 
c
.
key
[
i
] = (
u_ch¬
è
n
;

1940  
	`ngx_h‰p_fže_ÿche_add
(
ÿche
, &
c
);

1941 
	}
}

1944 
ngx_št_t


1945 
	$ngx_h‰p_fže_ÿche_add
(
ngx_h‰p_fže_ÿche_t
 *
ÿche
, 
ngx_h‰p_ÿche_t
 *
c
)

1947 
ngx_h‰p_fže_ÿche_node_t
 *
fú
;

1949 
	`ngx_shmtx_lock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1951 
fú
 = 
	`ngx_h‰p_fže_ÿche_lookup
(
ÿche
, 
c
->
key
);

1953 ià(
fú
 =ð
NULL
) {

1955 
fú
 = 
	`ngx_¦ab_ÿÎoc_locked
(
ÿche
->
shpoÞ
,

1956 (
ngx_h‰p_fže_ÿche_node_t
));

1957 ià(
fú
 =ð
NULL
) {

1958 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1959  
NGX_ERROR
;

1962 
	`ngx_memýy
((
u_ch¬
 *è&
fú
->
node
.
key
, 
c
->key, (
ngx_rbŒ“_key_t
));

1964 
	`ngx_memýy
(
fú
->
key
, &
c
->key[(
ngx_rbŒ“_key_t
)],

1965 
NGX_HTTP_CACHE_KEY_LEN
 - (
ngx_rbŒ“_key_t
));

1967 
	`ngx_rbŒ“_š£¹
(&
ÿche
->
sh
->
rbŒ“
, &
fú
->
node
);

1969 
fú
->
u£s
 = 1;

1970 
fú
->
exi¡s
 = 1;

1971 
fú
->
fs_size
 = 
c
->fs_size;

1973 
ÿche
->
sh
->
size
 +ð
c
->
fs_size
;

1976 
	`ngx_queue_»move
(&
fú
->
queue
);

1979 
fú
->
expœe
 = 
	`ngx_time
(è+ 
ÿche
->
šaùive
;

1981 
	`ngx_queue_š£¹_h—d
(&
ÿche
->
sh
->
queue
, &
fú
->queue);

1983 
	`ngx_shmtx_uÆock
(&
ÿche
->
shpoÞ
->
mu‹x
);

1985  
NGX_OK
;

1986 
	}
}

1989 
ngx_št_t


1990 
	$ngx_h‰p_fže_ÿche_d–‘e_fže
(
ngx_Œ“_ùx_t
 *
ùx
, 
ngx_¡r_t
 *
·th
)

1992 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ùx
->
log
, 0,

1993 "h‰°fžÿchd–‘e: \"%s\"", 
·th
->
d©a
);

1995 ià(
	`ngx_d–‘e_fže
(
·th
->
d©a
è=ð
NGX_FILE_ERROR
) {

1996 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ùx
->
log
, 
ngx_”ºo
,

1997 
ngx_d–‘e_fže_n
 " \"%s\" fažed", 
·th
->
d©a
);

2000  
NGX_OK
;

2001 
	}
}

2004 
time_t


2005 
	$ngx_h‰p_fže_ÿche_v®id
(
ngx_¬¿y_t
 *
ÿche_v®id
, 
ngx_ušt_t
 
¡©us
)

2007 
ngx_ušt_t
 
i
;

2008 
ngx_h‰p_ÿche_v®id_t
 *
v®id
;

2010 ià(
ÿche_v®id
 =ð
NULL
) {

2014 
v®id
 = 
ÿche_v®id
->
–ts
;

2015 
i
 = 0; i < 
ÿche_v®id
->
ÃÉs
; i++) {

2017 ià(
v®id
[
i
].
¡©us
 == 0) {

2018  
v®id
[
i
].valid;

2021 ià(
v®id
[
i
].
¡©us
 == status) {

2022  
v®id
[
i
].valid;

2027 
	}
}

2031 
	$ngx_h‰p_fže_ÿche_£t_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

2033 
off_t
 
max_size
;

2034 
u_ch¬
 *
Ï¡
, *
p
;

2035 
time_t
 
šaùive
;

2036 
ssize_t
 
size
;

2037 
ngx_¡r_t
 
s
, 
Çme
, *
v®ue
;

2038 
ngx_št_t
 
lßd”_fžes
;

2039 
ngx_m£c_t
 
lßd”_¦“p
, 
lßd”_th»shÞd
;

2040 
ngx_ušt_t
 
i
, 
n
;

2041 
ngx_h‰p_fže_ÿche_t
 *
ÿche
;

2043 
ÿche
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_fže_ÿche_t
));

2044 ià(
ÿche
 =ð
NULL
) {

2045  
NGX_CONF_ERROR
;

2048 
ÿche
->
·th
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_·th_t
));

2049 ià(
ÿche
->
·th
 =ð
NULL
) {

2050  
NGX_CONF_ERROR
;

2053 
šaùive
 = 600;

2054 
lßd”_fžes
 = 100;

2055 
lßd”_¦“p
 = 50;

2056 
lßd”_th»shÞd
 = 200;

2058 
Çme
.
Ën
 = 0;

2059 
size
 = 0;

2060 
max_size
 = 
NGX_MAX_OFF_T_VALUE
;

2062 
v®ue
 = 
cf
->
¬gs
->
–ts
;

2064 
ÿche
->
·th
->
Çme
 = 
v®ue
[1];

2066 ià(
ÿche
->
·th
->
Çme
.
d©a
[ÿche->·th->Çme.
Ën
 - 1] == '/') {

2067 
ÿche
->
·th
->
Çme
.
Ën
--;

2070 ià(
	`ngx_cÚf_fuÎ_Çme
(
cf
->
cyþe
, &
ÿche
->
·th
->
Çme
, 0è!ð
NGX_OK
) {

2071  
NGX_CONF_ERROR
;

2074 
i
 = 2; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

2076 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "levels=", 7) == 0) {

2078 
p
 = 
v®ue
[
i
].
d©a
 + 7;

2079 
Ï¡
 = 
v®ue
[
i
].
d©a
 + v®ue[i].
Ën
;

2081 
n
 = 0;‚ < 3 && 
p
 < 
Ï¡
;‚++) {

2083 ià(*
p
 > '0' && *p < '3') {

2085 
ÿche
->
·th
->
Ëv–
[
n
] = *
p
++ - '0';

2086 
ÿche
->
·th
->
Ën
 +ðÿche->·th->
Ëv–
[
n
] + 1;

2088 ià(
p
 =ð
Ï¡
) {

2092 ià(*
p
++ =ð':' && 
n
 < 2 &&… !ð
Ï¡
) {

2096 
šv®id_Ëv–s
;

2099 
šv®id_Ëv–s
;

2102 ià(
ÿche
->
·th
->
Ën
 < 10 + 3) {

2106 
šv®id_Ëv–s
:

2108 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2109 "šv®id \"Ëv–s\" \"%V\"", &
v®ue
[
i
]);

2110  
NGX_CONF_ERROR
;

2113 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "keys_zone=", 10) == 0) {

2115 
Çme
.
d©a
 = 
v®ue
[
i
].data + 10;

2117 
p
 = (
u_ch¬
 *è
	`ngx_¡rchr
(
Çme
.
d©a
, ':');

2119 ià(
p
) {

2120 
Çme
.
Ën
 = 
p
 -‚ame.
d©a
;

2122 
p
++;

2124 
s
.
Ën
 = 
v®ue
[
i
].
d©a
 + v®ue[i].ËÀ- 
p
;

2125 
s
.
d©a
 = 
p
;

2127 
size
 = 
	`ngx_·r£_size
(&
s
);

2128 ià(
size
 > 8191) {

2133 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2134 "šv®id key zÚsiz\"%V\"", &
v®ue
[
i
]);

2135  
NGX_CONF_ERROR
;

2138 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "inactive=", 9) == 0) {

2140 
s
.
Ën
 = 
v®ue
[
i
].len - 9;

2141 
s
.
d©a
 = 
v®ue
[
i
].data + 9;

2143 
šaùive
 = 
	`ngx_·r£_time
(&
s
, 1);

2144 ià(
šaùive
 =ð(
time_t
è
NGX_ERROR
) {

2145 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2146 "šv®id iÇùivv®u\"%V\"", &
v®ue
[
i
]);

2147  
NGX_CONF_ERROR
;

2153 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "max_size=", 9) == 0) {

2155 
s
.
Ën
 = 
v®ue
[
i
].len - 9;

2156 
s
.
d©a
 = 
v®ue
[
i
].data + 9;

2158 
max_size
 = 
	`ngx_·r£_off£t
(&
s
);

2159 ià(
max_size
 < 0) {

2160 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2161 "šv®id max_sizv®u\"%V\"", &
v®ue
[
i
]);

2162  
NGX_CONF_ERROR
;

2168 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "loader_files=", 13) == 0) {

2170 
lßd”_fžes
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + 13, v®ue[i].
Ën
 - 13);

2171 ià(
lßd”_fžes
 =ð
NGX_ERROR
) {

2172 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2173 "šv®id†ßd”_fže v®u\"%V\"", &
v®ue
[
i
]);

2174  
NGX_CONF_ERROR
;

2180 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "loader_sleep=", 13) == 0) {

2182 
s
.
Ën
 = 
v®ue
[
i
].len - 13;

2183 
s
.
d©a
 = 
v®ue
[
i
].data + 13;

2185 
lßd”_¦“p
 = 
	`ngx_·r£_time
(&
s
, 0);

2186 ià(
lßd”_¦“p
 =ð(
ngx_m£c_t
è
NGX_ERROR
) {

2187 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2188 "šv®id†ßd”_¦“°v®u\"%V\"", &
v®ue
[
i
]);

2189  
NGX_CONF_ERROR
;

2195 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "loader_threshold=", 17) == 0) {

2197 
s
.
Ën
 = 
v®ue
[
i
].len - 17;

2198 
s
.
d©a
 = 
v®ue
[
i
].data + 17;

2200 
lßd”_th»shÞd
 = 
	`ngx_·r£_time
(&
s
, 0);

2201 ià(
lßd”_th»shÞd
 =ð(
ngx_m£c_t
è
NGX_ERROR
) {

2202 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2203 "šv®id†ßd”_th»shÞd v®u\"%V\"", &
v®ue
[
i
]);

2204  
NGX_CONF_ERROR
;

2210 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2211 "šv®id…¬am‘” \"%V\"", &
v®ue
[
i
]);

2212  
NGX_CONF_ERROR
;

2215 ià(
Çme
.
Ën
 =ð0 || 
size
 == 0) {

2216 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2218 &
cmd
->
Çme
);

2219  
NGX_CONF_ERROR
;

2222 
ÿche
->
·th
->
mªag”
 = 
ngx_h‰p_fže_ÿche_mªag”
;

2223 
ÿche
->
·th
->
lßd”
 = 
ngx_h‰p_fže_ÿche_lßd”
;

2224 
ÿche
->
·th
->
d©a
 = cache;

2225 
ÿche
->
·th
->
cÚf_fže
 = 
cf
->cÚf_fže->
fže
.
Çme
.
d©a
;

2226 
ÿche
->
·th
->
lše
 = 
cf
->
cÚf_fže
->line;

2227 
ÿche
->
lßd”_fžes
 =†oader_files;

2228 
ÿche
->
lßd”_¦“p
 =†oader_sleep;

2229 
ÿche
->
lßd”_th»shÞd
 =†oader_threshold;

2231 ià(
	`ngx_add_·th
(
cf
, &
ÿche
->
·th
è!ð
NGX_OK
) {

2232  
NGX_CONF_ERROR
;

2235 
ÿche
->
shm_zÚe
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
Çme
, 
size
, 
cmd
->
po¡
);

2236 ià(
ÿche
->
shm_zÚe
 =ð
NULL
) {

2237  
NGX_CONF_ERROR
;

2240 ià(
ÿche
->
shm_zÚe
->
d©a
) {

2241 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2242 "du¶iÿ‹ zÚ\"%V\"", &
Çme
);

2243  
NGX_CONF_ERROR
;

2247 
ÿche
->
shm_zÚe
->
š™
 = 
ngx_h‰p_fže_ÿche_š™
;

2248 
ÿche
->
shm_zÚe
->
d©a
 = cache;

2250 
ÿche
->
šaùive
 = inactive;

2251 
ÿche
->
max_size
 = max_size;

2253  
NGX_CONF_OK
;

2254 
	}
}

2258 
	$ngx_h‰p_fže_ÿche_v®id_£t_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

2259 *
cÚf
)

2261 *
p
 = 
cÚf
;

2263 
time_t
 
v®id
;

2264 
ngx_¡r_t
 *
v®ue
;

2265 
ngx_ušt_t
 
i
, 
n
, 
¡©us
;

2266 
ngx_¬¿y_t
 **
a
;

2267 
ngx_h‰p_ÿche_v®id_t
 *
v
;

2268 
ngx_ušt_t
 
¡©u£s
[] = { 200, 301, 302 };

2270 
a
 = (
ngx_¬¿y_t
 **è(
p
 + 
cmd
->
off£t
);

2272 ià(*
a
 =ð
NGX_CONF_UNSET_PTR
) {

2273 *
a
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1, (
ngx_h‰p_ÿche_v®id_t
));

2274 ià(*
a
 =ð
NULL
) {

2275  
NGX_CONF_ERROR
;

2279 
v®ue
 = 
cf
->
¬gs
->
–ts
;

2280 
n
 = 
cf
->
¬gs
->
ÃÉs
 - 1;

2282 
v®id
 = 
	`ngx_·r£_time
(&
v®ue
[
n
], 1);

2283 ià(
v®id
 =ð(
time_t
è
NGX_ERROR
) {

2284 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2285 "šv®idimv®u\"%V\"", &
v®ue
[
n
]);

2286  
NGX_CONF_ERROR
;

2289 ià(
n
 == 1) {

2291 
i
 = 0; i < 3; i++) {

2292 
v
 = 
	`ngx_¬¿y_push
(*
a
);

2293 ià(
v
 =ð
NULL
) {

2294  
NGX_CONF_ERROR
;

2297 
v
->
¡©us
 = 
¡©u£s
[
i
];

2298 
v
->
v®id
 = valid;

2301  
NGX_CONF_OK
;

2304 
i
 = 1; i < 
n
; i++) {

2306 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "any") == 0) {

2308 
¡©us
 = 0;

2312 
¡©us
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
, v®ue[i].
Ën
);

2313 ià(
¡©us
 < 100) {

2314 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2315 "šv®id stu \"%V\"", &
v®ue
[
i
]);

2316  
NGX_CONF_ERROR
;

2320 
v
 = 
	`ngx_¬¿y_push
(*
a
);

2321 ià(
v
 =ð
NULL
) {

2322  
NGX_CONF_ERROR
;

2325 
v
->
¡©us
 = status;

2326 
v
->
v®id
 = valid;

2329  
NGX_CONF_OK
;

2330 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_header_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngšx.h
>

14 
ngx_št_t
 
ngx_h‰p_h—d”_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

15 
ngx_št_t
 
ngx_h‰p_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
);

18 
ngx_h‰p_moduË_t
 
	gngx_h‰p_h—d”_fž‹r_moduË_ùx
 = {

19 
NULL
,

20 
ngx_h‰p_h—d”_fž‹r_š™
,

22 
NULL
,

23 
NULL
,

25 
NULL
,

26 
NULL
,

28 
NULL
,

29 
NULL
,

33 
ngx_moduË_t
 
	gngx_h‰p_h—d”_fž‹r_moduË
 = {

34 
NGX_MODULE_V1
,

35 &
ngx_h‰p_h—d”_fž‹r_moduË_ùx
,

36 
NULL
,

37 
NGX_HTTP_MODULE
,

38 
NULL
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NGX_MODULE_V1_PADDING


49 
	gngx_h‰p_£rv”_¡ršg
[] = "S”v”:‚gšx" 
CRLF
;

50 
	gngx_h‰p_£rv”_fuÎ_¡ršg
[] = "S”v”: " 
NGINX_VER
 
CRLF
;

53 
ngx_¡r_t
 
	gngx_h‰p_¡©us_lšes
[] = {

55 
ngx_¡ršg
("200 OK"),

56 
ngx_¡ršg
("201 Created"),

57 
ngx_¡ršg
("202 Accepted"),

58 
ngx_nuÎ_¡ršg
,

59 
ngx_¡ršg
("204 No Content"),

60 
ngx_nuÎ_¡ršg
,

61 
ngx_¡ršg
("206 Partial Content"),

65 
	#NGX_HTTP_LAST_2XX
 207

	)

66 
	#NGX_HTTP_OFF_3XX
 (
NGX_HTTP_LAST_2XX
 - 200)

	)

70 
ngx_¡ršg
("301 Moved Permanently"),

71 
ngx_¡ršg
("302 Moved Temporarily"),

72 
ngx_¡ršg
("303 See Other"),

73 
ngx_¡ršg
("304 Not Modified"),

74 
ngx_nuÎ_¡ršg
,

75 
ngx_nuÎ_¡ršg
,

76 
ngx_¡ršg
("307 Temporary Redirect"),

78 
	#NGX_HTTP_LAST_3XX
 308

	)

79 
	#NGX_HTTP_OFF_4XX
 (
NGX_HTTP_LAST_3XX
 - 301 + 
NGX_HTTP_OFF_3XX
)

	)

81 
ngx_¡ršg
("400 Bad Request"),

82 
ngx_¡ršg
("401 Unauthorized"),

83 
ngx_¡ršg
("402 Payment Required"),

84 
ngx_¡ršg
("403 Forbidden"),

85 
ngx_¡ršg
("404 Not Found"),

86 
ngx_¡ršg
("405 Not Allowed"),

87 
ngx_¡ršg
("406 Not Acceptable"),

88 
ngx_nuÎ_¡ršg
,

89 
ngx_¡ršg
("408 Request Time-out"),

90 
ngx_¡ršg
("409 Conflict"),

91 
ngx_¡ršg
("410 Gone"),

92 
ngx_¡ršg
("411 Length Required"),

93 
ngx_¡ršg
("412 Precondition Failed"),

94 
ngx_¡ršg
("413 Request Entity Too Large"),

95 
ngx_¡ršg
("414 Request-URI Too Large"),

96 
ngx_¡ršg
("415 Unsupported Media Type"),

97 
ngx_¡ršg
("416 Requested Range Not Satisfiable"),

108 
	#NGX_HTTP_LAST_4XX
 417

	)

109 
	#NGX_HTTP_OFF_5XX
 (
NGX_HTTP_LAST_4XX
 - 400 + 
NGX_HTTP_OFF_4XX
)

	)

111 
ngx_¡ršg
("500 Internal Server Error"),

112 
ngx_¡ršg
("501 Not Implemented"),

113 
ngx_¡ršg
("502 Bad Gateway"),

114 
ngx_¡ršg
("503 Service Temporarily Unavailable"),

115 
ngx_¡ršg
("504 Gateway Time-out"),

117 
ngx_nuÎ_¡ršg
,

118 
ngx_nuÎ_¡ršg
,

119 
ngx_¡ršg
("507 Insufficient Storage"),

124 
	#NGX_HTTP_LAST_5XX
 508

	)

129 
ngx_h‰p_h—d”_out_t
 
	gngx_h‰p_h—d”s_out
[] = {

130 { 
ngx_¡ršg
("S”v”"), 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
£rv”
) },

131 { 
ngx_¡ršg
("D©e"), 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
d©e
) },

132 { 
ngx_¡ršg
("Content-Length"),

133 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
cÚ‹Á_Ëngth
) },

134 { 
ngx_¡ršg
("Content-Encoding"),

135 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
cÚ‹Á_’codšg
) },

136 { 
ngx_¡ršg
("LoÿtiÚ"), 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
loÿtiÚ
) },

137 { 
ngx_¡ršg
("Last-Modified"),

138 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
Ï¡_modif›d
) },

139 { 
ngx_¡ršg
("Accept-Ranges"),

140 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
acû±_¿nges
) },

141 { 
ngx_¡ršg
("Expœes"), 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
expœes
) },

142 { 
ngx_¡ršg
("Cache-Control"),

143 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
ÿche_cÚŒÞ
) },

144 { 
ngx_¡ršg
("ETag"), 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
‘ag
) },

146 { 
ngx_nuÎ_¡ršg
, 0 }

150 
ngx_št_t


151 
	$ngx_h‰p_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

153 
u_ch¬
 *
p
;

154 
size_t
 
Ën
;

155 
ngx_¡r_t
 
ho¡
, *
¡©us_lše
;

156 
ngx_buf_t
 *
b
;

157 
ngx_ušt_t
 
¡©us
, 
i
, 
pÜt
;

158 
ngx_chaš_t
 
out
;

159 
ngx_li¡_·¹_t
 *
·¹
;

160 
ngx_bË_–t_t
 *
h—d”
;

161 
ngx_cÚÃùiÚ_t
 *
c
;

162 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

163 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

164 
sockaddr_š
 *
sš
;

165 #ià(
NGX_HAVE_INET6
)

166 
sockaddr_š6
 *
sš6
;

168 
u_ch¬
 
addr
[
NGX_SOCKADDR_STRLEN
];

170 ià(
r
->
h—d”_£Á
) {

171  
NGX_OK
;

174 
r
->
h—d”_£Á
 = 1;

176 ià(
r
 !ðr->
maš
) {

177  
NGX_OK
;

180 ià(
r
->
h‰p_v”siÚ
 < 
NGX_HTTP_VERSION_10
) {

181  
NGX_OK
;

184 ià(
r
->
m‘hod
 =ð
NGX_HTTP_HEAD
) {

185 
r
->
h—d”_Úly
 = 1;

188 ià(
r
->
h—d”s_out
.
Ï¡_modif›d_time
 != -1) {

189 ià(
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_OK


190 && 
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_PARTIAL_CONTENT


191 && 
r
->
h—d”s_out
.
¡©us
 !ð
NGX_HTTP_NOT_MODIFIED
)

193 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = -1;

194 
r
->
h—d”s_out
.
Ï¡_modif›d
 = 
NULL
;

198 
Ën
 = ("HTTP/1.x "è- 1 + (
CRLF
) - 1

200 + (
CRLF
) - 1;

204 ià(
r
->
h—d”s_out
.
¡©us_lše
.
Ën
) {

205 
Ën
 +ð
r
->
h—d”s_out
.
¡©us_lše
.len;

206 
¡©us_lše
 = &
r
->
h—d”s_out
.status_line;

207 #ià(
NGX_SUPPRESS_WARN
)

208 
¡©us
 = 0;

213 
¡©us
 = 
r
->
h—d”s_out
.status;

215 ià(
¡©us
 >ð
NGX_HTTP_OK


216 && 
¡©us
 < 
NGX_HTTP_LAST_2XX
)

220 ià(
¡©us
 =ð
NGX_HTTP_NO_CONTENT
) {

221 
r
->
h—d”_Úly
 = 1;

222 
	`ngx_¡r_nuÎ
(&
r
->
h—d”s_out
.
cÚ‹Á_ty³
);

223 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = -1;

224 
r
->
h—d”s_out
.
Ï¡_modif›d
 = 
NULL
;

225 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 = 
NULL
;

226 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = -1;

229 
¡©us
 -ð
NGX_HTTP_OK
;

230 
¡©us_lše
 = &
ngx_h‰p_¡©us_lšes
[
¡©us
];

231 
Ën
 +ð
ngx_h‰p_¡©us_lšes
[
¡©us
].len;

233 } ià(
¡©us
 >ð
NGX_HTTP_MOVED_PERMANENTLY


234 && 
¡©us
 < 
NGX_HTTP_LAST_3XX
)

238 ià(
¡©us
 =ð
NGX_HTTP_NOT_MODIFIED
) {

239 
r
->
h—d”_Úly
 = 1;

242 
¡©us
 = stu - 
NGX_HTTP_MOVED_PERMANENTLY
 + 
NGX_HTTP_OFF_3XX
;

243 
¡©us_lše
 = &
ngx_h‰p_¡©us_lšes
[
¡©us
];

244 
Ën
 +ð
ngx_h‰p_¡©us_lšes
[
¡©us
].len;

246 } ià(
¡©us
 >ð
NGX_HTTP_BAD_REQUEST


247 && 
¡©us
 < 
NGX_HTTP_LAST_4XX
)

250 
¡©us
 = stu - 
NGX_HTTP_BAD_REQUEST


251 + 
NGX_HTTP_OFF_4XX
;

253 
¡©us_lše
 = &
ngx_h‰p_¡©us_lšes
[
¡©us
];

254 
Ën
 +ð
ngx_h‰p_¡©us_lšes
[
¡©us
].len;

256 } ià(
¡©us
 >ð
NGX_HTTP_INTERNAL_SERVER_ERROR


257 && 
¡©us
 < 
NGX_HTTP_LAST_5XX
)

260 
¡©us
 = stu - 
NGX_HTTP_INTERNAL_SERVER_ERROR


261 + 
NGX_HTTP_OFF_5XX
;

263 
¡©us_lše
 = &
ngx_h‰p_¡©us_lšes
[
¡©us
];

264 
Ën
 +ð
ngx_h‰p_¡©us_lšes
[
¡©us
].len;

267 
Ën
 +ð
NGX_INT_T_LEN
 + 1 ;

268 
¡©us_lše
 = 
NULL
;

271 ià(
¡©us_lše
 && stus_lše->
Ën
 == 0) {

272 
¡©us
 = 
r
->
h—d”s_out
.status;

273 
Ën
 +ð
NGX_INT_T_LEN
 + 1 ;

274 
¡©us_lše
 = 
NULL
;

278 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

280 ià(
r
->
h—d”s_out
.
£rv”
 =ð
NULL
) {

281 
Ën
 +ð
þcf
->
£rv”_tok’s
 ? (
ngx_h‰p_£rv”_fuÎ_¡ršg
) - 1:

282 (
ngx_h‰p_£rv”_¡ršg
) - 1;

285 ià(
r
->
h—d”s_out
.
d©e
 =ð
NULL
) {

286 
Ën
 +ð("D©e: MÚ, 28 S• 1970 06:00:00 GMT" 
CRLF
) - 1;

289 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
) {

290 
Ën
 += ("Content-Type: ") - 1

291 + 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 + 2;

293 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 =ðr->h—d”s_out.
cÚ‹Á_ty³
.
Ën


294 && 
r
->
h—d”s_out
.
ch¬£t
.
Ën
)

296 
Ën
 +ð("; ch¬£t="è- 1 + 
r
->
h—d”s_out
.
ch¬£t
.len;

300 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 =ð
NULL


301 && 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 >= 0)

303 
Ën
 +ð("CÚ‹Á-L’gth: "è- 1 + 
NGX_OFF_T_LEN
 + 2;

306 ià(
r
->
h—d”s_out
.
Ï¡_modif›d
 =ð
NULL


307 && 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 != -1)

309 
Ën
 +ð("La¡-Modif›d: MÚ, 28 S• 1970 06:00:00 GMT" 
CRLF
) - 1;

312 
c
 = 
r
->
cÚÃùiÚ
;

314 ià(
r
->
h—d”s_out
.
loÿtiÚ


315 && 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën


316 && 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
[0] == '/')

318 
r
->
h—d”s_out
.
loÿtiÚ
->
hash
 = 0;

320 ià(
þcf
->
£rv”_Çme_š_»dœeù
) {

321 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

322 
ho¡
 = 
cscf
->
£rv”_Çme
;

324 } ià(
r
->
h—d”s_š
.
£rv”
.
Ën
) {

325 
ho¡
 = 
r
->
h—d”s_š
.
£rv”
;

328 
ho¡
.
Ën
 = 
NGX_SOCKADDR_STRLEN
;

329 
ho¡
.
d©a
 = 
addr
;

331 ià(
	`ngx_cÚÃùiÚ_loÿl_sockaddr
(
c
, &
ho¡
, 0è!ð
NGX_OK
) {

332  
NGX_ERROR
;

336 
c
->
loÿl_sockaddr
->
§_çmžy
) {

338 #ià(
NGX_HAVE_INET6
)

339 
AF_INET6
:

340 
sš6
 = (
sockaddr_š6
 *è
c
->
loÿl_sockaddr
;

341 
pÜt
 = 
	`Áohs
(
sš6
->
sš6_pÜt
);

344 #ià(
NGX_HAVE_UNIX_DOMAIN
)

345 
AF_UNIX
:

346 
pÜt
 = 0;

350 
sš
 = (
sockaddr_š
 *è
c
->
loÿl_sockaddr
;

351 
pÜt
 = 
	`Áohs
(
sš
->
sš_pÜt
);

355 
Ën
 += ("Location: https://") - 1

356 + 
ho¡
.
Ën


357 + 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
 + 2;

359 ià(
þcf
->
pÜt_š_»dœeù
) {

361 #ià(
NGX_HTTP_SSL
)

362 ià(
c
->
s¦
)

363 
pÜt
 = (port == 443) ? 0 :…ort;

366 
pÜt
 = (port == 80) ? 0 :…ort;

369 
pÜt
 = 0;

372 ià(
pÜt
) {

373 
Ën
 += (":65535") - 1;

377 
	`ngx_¡r_nuÎ
(&
ho¡
);

378 
pÜt
 = 0;

381 ià(
r
->
chunked
) {

382 
Ën
 +ð("T¿nsãr-Encodšg: chunked" 
CRLF
) - 1;

385 ià(
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_SWITCHING_PROTOCOLS
) {

386 
Ën
 +ð("CÚÃùiÚ: upg¿de" 
CRLF
) - 1;

388 } ià(
r
->
k“·live
) {

389 
Ën
 +ð("CÚÃùiÚ: k“p-®ive" 
CRLF
) - 1;

399 ià(
þcf
->
k“·live_h—d”
) {

400 
Ën
 +ð("K“p-Alive:imeout="è- 1 + 
NGX_TIME_T_LEN
 + 2;

404 
Ën
 +ð("CÚÃùiÚ: clo£" 
CRLF
) - 1;

407 #ià(
NGX_HTTP_GZIP
)

408 ià(
r
->
gz_v¬y
) {

409 ià(
þcf
->
gz_v¬y
) {

410 
Ën
 +ð("V¬y: Acû±-Encodšg" 
CRLF
) - 1;

413 
r
->
gz_v¬y
 = 0;

418 
·¹
 = &
r
->
h—d”s_out
.
h—d”s
.part;

419 
h—d”
 = 
·¹
->
–ts
;

421 
i
 = 0; ; i++) {

423 ià(
i
 >ð
·¹
->
ÃÉs
) {

424 ià(
·¹
->
Ãxt
 =ð
NULL
) {

428 
·¹
 =…¬t->
Ãxt
;

429 
h—d”
 = 
·¹
->
–ts
;

430 
i
 = 0;

433 ià(
h—d”
[
i
].
hash
 == 0) {

437 
Ën
 +ð
h—d”
[
i
].
key
.ËÀ+ (": "è- 1 + h—d”[i].
v®ue
.len

438 + (
CRLF
) - 1;

441 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
Ën
);

442 ià(
b
 =ð
NULL
) {

443  
NGX_ERROR
;

447 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "HTTP/1.1 ", ("HTTP/1.x ") - 1);

450 ià(
¡©us_lše
) {

451 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
¡©us_lše
->
d©a
, stus_lše->
Ën
);

454 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, "%03u˜", 
¡©us
);

456 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

458 ià(
r
->
h—d”s_out
.
£rv”
 =ð
NULL
) {

459 ià(
þcf
->
£rv”_tok’s
) {

460 
p
 = (
u_ch¬
 *è
ngx_h‰p_£rv”_fuÎ_¡ršg
;

461 
Ën
 = (
ngx_h‰p_£rv”_fuÎ_¡ršg
) - 1;

464 
p
 = (
u_ch¬
 *è
ngx_h‰p_£rv”_¡ršg
;

465 
Ën
 = (
ngx_h‰p_£rv”_¡ršg
) - 1;

468 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
p
, 
Ën
);

471 ià(
r
->
h—d”s_out
.
d©e
 =ð
NULL
) {

472 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Date: ", ("Date: ") - 1);

473 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
ngx_ÿched_h‰p_time
.
d©a
,

474 
ngx_ÿched_h‰p_time
.
Ën
);

476 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

479 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
) {

480 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Content-Type: ",

482 
p
 = 
b
->
Ï¡
;

483 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
,

484 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
);

486 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 =ðr->h—d”s_out.
cÚ‹Á_ty³
.
Ën


487 && 
r
->
h—d”s_out
.
ch¬£t
.
Ën
)

489 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "; charset=",

491 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
r
->
h—d”s_out
.
ch¬£t
.
d©a
,

492 
r
->
h—d”s_out
.
ch¬£t
.
Ën
);

496 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 = 
b
->
Ï¡
 - 
p
;

497 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
 = 
p
;

500 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

503 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 =ð
NULL


504 && 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 >= 0)

506 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, "CÚ‹Á-L’gth: %O" 
CRLF
,

507 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
);

510 ià(
r
->
h—d”s_out
.
Ï¡_modif›d
 =ð
NULL


511 && 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 != -1)

513 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Last-Modified: ",

515 
b
->
Ï¡
 = 
	`ngx_h‰p_time
(b->Ï¡, 
r
->
h—d”s_out
.
Ï¡_modif›d_time
);

517 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

520 ià(
ho¡
.
d©a
) {

522 
p
 = 
b
->
Ï¡
 + ("Location: ") - 1;

524 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Location: http",

527 #ià(
NGX_HTTP_SSL
)

528 ià(
c
->
s¦
) {

529 *
b
->
Ï¡
++ ='s';

533 *
b
->
Ï¡
++ = ':'; *b->last++ = '/'; *b->last++ = '/';

534 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
ho¡
.
d©a
, ho¡.
Ën
);

536 ià(
pÜt
) {

537 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, ":%ui", 
pÜt
);

540 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
,

541 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
);

545 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
 = 
b
->
Ï¡
 - 
p
;

546 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
 = 
p
;

547 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
loÿtiÚ
->
key
, "Location");

549 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

552 ià(
r
->
chunked
) {

553 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, "T¿nsãr-Encodšg: chunked" 
CRLF
,

554 ("T¿nsãr-Encodšg: chunked" 
CRLF
) - 1);

557 ià(
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_SWITCHING_PROTOCOLS
) {

558 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, "CÚÃùiÚ: upg¿de" 
CRLF
,

559 ("CÚÃùiÚ: upg¿de" 
CRLF
) - 1);

561 } ià(
r
->
k“·live
) {

562 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, "CÚÃùiÚ: k“p-®ive" 
CRLF
,

563 ("CÚÃùiÚ: k“p-®ive" 
CRLF
) - 1);

565 ià(
þcf
->
k“·live_h—d”
) {

566 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, "K“p-Alive:imeout=%T" 
CRLF
,

567 
þcf
->
k“·live_h—d”
);

571 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, "CÚÃùiÚ: clo£" 
CRLF
,

572 ("CÚÃùiÚ: clo£" 
CRLF
) - 1);

575 #ià(
NGX_HTTP_GZIP
)

576 ià(
r
->
gz_v¬y
) {

577 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, "V¬y: Acû±-Encodšg" 
CRLF
,

578 ("V¬y: Acû±-Encodšg" 
CRLF
) - 1);

582 
·¹
 = &
r
->
h—d”s_out
.
h—d”s
.part;

583 
h—d”
 = 
·¹
->
–ts
;

585 
i
 = 0; ; i++) {

587 ià(
i
 >ð
·¹
->
ÃÉs
) {

588 ià(
·¹
->
Ãxt
 =ð
NULL
) {

592 
·¹
 =…¬t->
Ãxt
;

593 
h—d”
 = 
·¹
->
–ts
;

594 
i
 = 0;

597 ià(
h—d”
[
i
].
hash
 == 0) {

601 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
h—d”
[
i
].
key
.
d©a
, h—d”[i].key.
Ën
);

602 *
b
->
Ï¡
++ = ':'; *b->last++ = ' ';

604 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
h—d”
[
i
].
v®ue
.
d©a
, h—d”[i].v®ue.
Ën
);

605 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

608 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

609 "%*s", (
size_t
è(
b
->
Ï¡
 - b->
pos
), b->pos);

612 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

614 
r
->
h—d”_size
 = 
b
->
Ï¡
 - b->
pos
;

616 ià(
r
->
h—d”_Úly
) {

617 
b
->
Ï¡_buf
 = 1;

620 
out
.
buf
 = 
b
;

621 
out
.
Ãxt
 = 
NULL
;

623  
	`ngx_h‰p_wr™e_fž‹r
(
r
, &
out
);

624 
	}
}

627 
ngx_št_t


628 
	$ngx_h‰p_h—d”_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

630 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_h—d”_fž‹r
;

632  
NGX_OK
;

633 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_parse.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ušt32_t
 
	gusu®
[] = {

20 #ià(
NGX_WIN32
)

36 #ià(
NGX_HAVE_LITTLE_ENDIAN
 && 
NGX_HAVE_NONALIGNED
)

38 
	#ngx_¡r3_cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
) \

39 *(
ušt32_t
 *è
m
 =ð((
c3
 << 24è| (
c2
 << 16è| (
c1
 << 8è| 
c0
)

	)

41 
	#ngx_¡r3Ocmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
) \

42 *(
ušt32_t
 *è
m
 =ð((
c3
 << 24è| (
c2
 << 16è| (
c1
 << 8è| 
c0
)

	)

44 
	#ngx_¡r4cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
) \

45 *(
ušt32_t
 *è
m
 =ð((
c3
 << 24è| (
c2
 << 16è| (
c1
 << 8è| 
c0
)

	)

47 
	#ngx_¡r5cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
) \

48 *(
ušt32_t
 *è
m
 =ð((
c3
 << 24è| (
c2
 << 16è| (
c1
 << 8è| 
c0
) \

49 && 
m
[4] =ð
c4


	)

51 
	#ngx_¡r6cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
, 
c5
) \

52 *(
ušt32_t
 *è
m
 =ð((
c3
 << 24è| (
c2
 << 16è| (
c1
 << 8è| 
c0
) \

53 && (((
ušt32_t
 *è
m
)[1] & 0xffffè=ð((
c5
 << 8è| 
c4
)

	)

55 
	#ngx_¡r7_cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
, 
c5
, 
c6
, 
c7
) \

56 *(
ušt32_t
 *è
m
 =ð((
c3
 << 24è| (
c2
 << 16è| (
c1
 << 8è| 
c0
) \

57 && ((
ušt32_t
 *è
m
)[1] =ð((
c7
 << 24è| (
c6
 << 16è| (
c5
 << 8è| 
c4
)

	)

59 
	#ngx_¡r8cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
, 
c5
, 
c6
, 
c7
) \

60 *(
ušt32_t
 *è
m
 =ð((
c3
 << 24è| (
c2
 << 16è| (
c1
 << 8è| 
c0
) \

61 && ((
ušt32_t
 *è
m
)[1] =ð((
c7
 << 24è| (
c6
 << 16è| (
c5
 << 8è| 
c4
)

	)

63 
	#ngx_¡r9cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
, 
c5
, 
c6
, 
c7
, 
c8
) \

64 *(
ušt32_t
 *è
m
 =ð((
c3
 << 24è| (
c2
 << 16è| (
c1
 << 8è| 
c0
) \

65 && ((
ušt32_t
 *è
m
)[1] =ð((
c7
 << 24è| (
c6
 << 16è| (
c5
 << 8è| 
c4
) \

66 && 
m
[8] =ð
c8


	)

70 
	#ngx_¡r3_cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
) \

71 
m
[0] =ð
c0
 && m[1] =ð
c1
 && m[2] =ð
c2


	)

73 
	#ngx_¡r3Ocmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
) \

74 
m
[0] =ð
c0
 && m[2] =ð
c2
 && m[3] =ð
c3


	)

76 
	#ngx_¡r4cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
) \

77 
m
[0] =ð
c0
 && m[1] =ð
c1
 && m[2] =ð
c2
 && m[3] =ð
c3


	)

79 
	#ngx_¡r5cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
) \

80 
m
[0] =ð
c0
 && m[1] =ð
c1
 && m[2] =ð
c2
 && m[3] =ð
c3
 && m[4] =ð
c4


	)

82 
	#ngx_¡r6cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
, 
c5
) \

83 
m
[0] =ð
c0
 && m[1] =ð
c1
 && m[2] =ð
c2
 && m[3] =ð
c3
 \

84 && 
m
[4] =ð
c4
 && m[5] =ð
c5


	)

86 
	#ngx_¡r7_cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
, 
c5
, 
c6
, 
c7
) \

87 
m
[0] =ð
c0
 && m[1] =ð
c1
 && m[2] =ð
c2
 && m[3] =ð
c3
 \

88 && 
m
[4] =ð
c4
 && m[5] =ð
c5
 && m[6] =ð
c6


	)

90 
	#ngx_¡r8cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
, 
c5
, 
c6
, 
c7
) \

91 
m
[0] =ð
c0
 && m[1] =ð
c1
 && m[2] =ð
c2
 && m[3] =ð
c3
 \

92 && 
m
[4] =ð
c4
 && m[5] =ð
c5
 && m[6] =ð
c6
 && m[7] =ð
c7


	)

94 
	#ngx_¡r9cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
, 
c5
, 
c6
, 
c7
, 
c8
) \

95 
m
[0] =ð
c0
 && m[1] =ð
c1
 && m[2] =ð
c2
 && m[3] =ð
c3
 \

96 && 
m
[4] =ð
c4
 && m[5] =ð
c5
 && m[6] =ð
c6
 && m[7] =ð
c7
 && m[8] =ð
c8


	)

103 
ngx_št_t


104 
	$ngx_h‰p_·r£_»que¡_lše
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_buf_t
 *
b
)

106 
u_ch¬
 
c
, 
ch
, *
p
, *
m
;

108 
sw_¡¬t
 = 0,

109 
sw_m‘hod
,

110 
sw_¥aûs_befÜe_uri
,

111 
sw_schema
,

112 
sw_schema_¦ash
,

113 
sw_schema_¦ash_¦ash
,

114 
sw_ho¡_¡¬t
,

115 
sw_ho¡
,

116 
sw_ho¡_’d
,

117 
sw_ho¡__l™”®
,

118 
sw_pÜt
,

119 
sw_ho¡_h‰p_09
,

120 
sw_aá”_¦ash_š_uri
,

121 
sw_check_uri
,

122 
sw_check_uri_h‰p_09
,

123 
sw_uri
,

124 
sw_h‰p_09
,

125 
sw_h‰p_H
,

126 
sw_h‰p_HT
,

127 
sw_h‰p_HTT
,

128 
sw_h‰p_HTTP
,

129 
sw_fœ¡_majÜ_dig™
,

130 
sw_majÜ_dig™
,

131 
sw_fœ¡_mšÜ_dig™
,

132 
sw_mšÜ_dig™
,

133 
sw_¥aûs_aá”_dig™
,

134 
sw_®mo¡_dÚe


135 } 
¡©e
;

137 
¡©e
 = 
r
->state;

139 
p
 = 
b
->
pos
;… < b->
Ï¡
;…++) {

140 
ch
 = *
p
;

142 
¡©e
) {

145 
sw_¡¬t
:

146 
r
->
»que¡_¡¬t
 = 
p
;

148 ià(
ch
 =ð
CR
 || ch =ð
LF
) {

152 ià((
ch
 < 'A' || ch > 'Z') && ch != '_') {

153  
NGX_HTTP_PARSE_INVALID_METHOD
;

156 
¡©e
 = 
sw_m‘hod
;

159 
sw_m‘hod
:

160 ià(
ch
 == ' ') {

161 
r
->
m‘hod_’d
 = 
p
 - 1;

162 
m
 = 
r
->
»que¡_¡¬t
;

164 
p
 - 
m
) {

167 ià(
	`ngx_¡r3_cmp
(
m
, 'G', 'E', 'T', ' ')) {

168 
r
->
m‘hod
 = 
NGX_HTTP_GET
;

172 ià(
	`ngx_¡r3_cmp
(
m
, 'P', 'U', 'T', ' ')) {

173 
r
->
m‘hod
 = 
NGX_HTTP_PUT
;

180 ià(
m
[1] == 'O') {

182 ià(
	`ngx_¡r3Ocmp
(
m
, 'P', 'O', 'S', 'T')) {

183 
r
->
m‘hod
 = 
NGX_HTTP_POST
;

187 ià(
	`ngx_¡r3Ocmp
(
m
, 'C', 'O', 'P', 'Y')) {

188 
r
->
m‘hod
 = 
NGX_HTTP_COPY
;

192 ià(
	`ngx_¡r3Ocmp
(
m
, 'M', 'O', 'V', 'E')) {

193 
r
->
m‘hod
 = 
NGX_HTTP_MOVE
;

197 ià(
	`ngx_¡r3Ocmp
(
m
, 'L', 'O', 'C', 'K')) {

198 
r
->
m‘hod
 = 
NGX_HTTP_LOCK
;

204 ià(
	`ngx_¡r4cmp
(
m
, 'H', 'E', 'A', 'D')) {

205 
r
->
m‘hod
 = 
NGX_HTTP_HEAD
;

213 ià(
	`ngx_¡r5cmp
(
m
, 'M', 'K', 'C', 'O', 'L')) {

214 
r
->
m‘hod
 = 
NGX_HTTP_MKCOL
;

218 ià(
	`ngx_¡r5cmp
(
m
, 'P', 'A', 'T', 'C', 'H')) {

219 
r
->
m‘hod
 = 
NGX_HTTP_PATCH
;

223 ià(
	`ngx_¡r5cmp
(
m
, 'T', 'R', 'A', 'C', 'E')) {

224 
r
->
m‘hod
 = 
NGX_HTTP_TRACE
;

231 ià(
	`ngx_¡r6cmp
(
m
, 'D', 'E', 'L', 'E', 'T', 'E')) {

232 
r
->
m‘hod
 = 
NGX_HTTP_DELETE
;

236 ià(
	`ngx_¡r6cmp
(
m
, 'U', 'N', 'L', 'O', 'C', 'K')) {

237 
r
->
m‘hod
 = 
NGX_HTTP_UNLOCK
;

244 ià(
	`ngx_¡r7_cmp
(
m
, 'O', 'P', 'T', 'I', 'O', 'N', 'S', ' '))

246 
r
->
m‘hod
 = 
NGX_HTTP_OPTIONS
;

252 ià(
	`ngx_¡r8cmp
(
m
, 'P', 'R', 'O', 'P', 'F', 'I', 'N', 'D'))

254 
r
->
m‘hod
 = 
NGX_HTTP_PROPFIND
;

260 ià(
	`ngx_¡r9cmp
(
m
,

263 
r
->
m‘hod
 = 
NGX_HTTP_PROPPATCH
;

269 
¡©e
 = 
sw_¥aûs_befÜe_uri
;

273 ià((
ch
 < 'A' || ch > 'Z') && ch != '_') {

274  
NGX_HTTP_PARSE_INVALID_METHOD
;

280 
sw_¥aûs_befÜe_uri
:

282 ià(
ch
 == '/') {

283 
r
->
uri_¡¬t
 = 
p
;

284 
¡©e
 = 
sw_aá”_¦ash_š_uri
;

288 
c
 = (
u_ch¬
è(
ch
 | 0x20);

289 ià(
c
 >= 'a' && c <= 'z') {

290 
r
->
schema_¡¬t
 = 
p
;

291 
¡©e
 = 
sw_schema
;

295 
ch
) {

299  
NGX_HTTP_PARSE_INVALID_REQUEST
;

303 
sw_schema
:

305 
c
 = (
u_ch¬
è(
ch
 | 0x20);

306 ià(
c
 >= 'a' && c <= 'z') {

310 
ch
) {

312 
r
->
schema_’d
 = 
p
;

313 
¡©e
 = 
sw_schema_¦ash
;

316  
NGX_HTTP_PARSE_INVALID_REQUEST
;

320 
sw_schema_¦ash
:

321 
ch
) {

323 
¡©e
 = 
sw_schema_¦ash_¦ash
;

326  
NGX_HTTP_PARSE_INVALID_REQUEST
;

330 
sw_schema_¦ash_¦ash
:

331 
ch
) {

333 
¡©e
 = 
sw_ho¡_¡¬t
;

336  
NGX_HTTP_PARSE_INVALID_REQUEST
;

340 
sw_ho¡_¡¬t
:

342 
r
->
ho¡_¡¬t
 = 
p
;

344 ià(
ch
 == '[') {

345 
¡©e
 = 
sw_ho¡__l™”®
;

349 
¡©e
 = 
sw_ho¡
;

353 
sw_ho¡
:

355 
c
 = (
u_ch¬
è(
ch
 | 0x20);

356 ià(
c
 >= 'a' && c <= 'z') {

360 ià((
ch
 >= '0' && ch <= '9') || ch == '.' || ch == '-') {

366 
sw_ho¡_’d
:

368 
r
->
ho¡_’d
 = 
p
;

370 
ch
) {

372 
¡©e
 = 
sw_pÜt
;

375 
r
->
uri_¡¬t
 = 
p
;

376 
¡©e
 = 
sw_aá”_¦ash_š_uri
;

383 
r
->
uri_¡¬t
 =„->
schema_’d
 + 1;

384 
r
->
uri_’d
 =„->
schema_’d
 + 2;

385 
¡©e
 = 
sw_ho¡_h‰p_09
;

388  
NGX_HTTP_PARSE_INVALID_REQUEST
;

392 
sw_ho¡__l™”®
:

394 ià(
ch
 >= '0' && ch <= '9') {

398 
c
 = (
u_ch¬
è(
ch
 | 0x20);

399 ià(
c
 >= 'a' && c <= 'z') {

403 
ch
) {

407 
¡©e
 = 
sw_ho¡_’d
;

429  
NGX_HTTP_PARSE_INVALID_REQUEST
;

433 
sw_pÜt
:

434 ià(
ch
 >= '0' && ch <= '9') {

438 
ch
) {

440 
r
->
pÜt_’d
 = 
p
;

441 
r
->
uri_¡¬t
 = 
p
;

442 
¡©e
 = 
sw_aá”_¦ash_š_uri
;

445 
r
->
pÜt_’d
 = 
p
;

450 
r
->
uri_¡¬t
 =„->
schema_’d
 + 1;

451 
r
->
uri_’d
 =„->
schema_’d
 + 2;

452 
¡©e
 = 
sw_ho¡_h‰p_09
;

455  
NGX_HTTP_PARSE_INVALID_REQUEST
;

460 
sw_ho¡_h‰p_09
:

461 
ch
) {

464 
CR
:

465 
r
->
h‰p_mšÜ
 = 9;

466 
¡©e
 = 
sw_®mo¡_dÚe
;

468 
LF
:

469 
r
->
h‰p_mšÜ
 = 9;

470 
dÚe
;

472 
r
->
h‰p_´ÙocÞ
.
d©a
 = 
p
;

473 
¡©e
 = 
sw_h‰p_H
;

476  
NGX_HTTP_PARSE_INVALID_REQUEST
;

482 
sw_aá”_¦ash_š_uri
:

484 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

485 
¡©e
 = 
sw_check_uri
;

489 
ch
) {

491 
r
->
uri_’d
 = 
p
;

492 
¡©e
 = 
sw_check_uri_h‰p_09
;

494 
CR
:

495 
r
->
uri_’d
 = 
p
;

496 
r
->
h‰p_mšÜ
 = 9;

497 
¡©e
 = 
sw_®mo¡_dÚe
;

499 
LF
:

500 
r
->
uri_’d
 = 
p
;

501 
r
->
h‰p_mšÜ
 = 9;

502 
dÚe
;

504 
r
->
com¶ex_uri
 = 1;

505 
¡©e
 = 
sw_uri
;

508 
r
->
quÙed_uri
 = 1;

509 
¡©e
 = 
sw_uri
;

512 
r
->
com¶ex_uri
 = 1;

513 
¡©e
 = 
sw_uri
;

515 #ià(
NGX_WIN32
)

517 
r
->
com¶ex_uri
 = 1;

518 
¡©e
 = 
sw_uri
;

522 
r
->
¬gs_¡¬t
 = 
p
 + 1;

523 
¡©e
 = 
sw_uri
;

526 
r
->
com¶ex_uri
 = 1;

527 
¡©e
 = 
sw_uri
;

530 
r
->
¶us_š_uri
 = 1;

533  
NGX_HTTP_PARSE_INVALID_REQUEST
;

535 
¡©e
 = 
sw_check_uri
;

541 
sw_check_uri
:

543 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

547 
ch
) {

549 #ià(
NGX_WIN32
)

550 ià(
r
->
uri_ext
 =ð
p
) {

551 
r
->
com¶ex_uri
 = 1;

552 
¡©e
 = 
sw_uri
;

556 
r
->
uri_ext
 = 
NULL
;

557 
¡©e
 = 
sw_aá”_¦ash_š_uri
;

560 
r
->
uri_ext
 = 
p
 + 1;

563 
r
->
uri_’d
 = 
p
;

564 
¡©e
 = 
sw_check_uri_h‰p_09
;

566 
CR
:

567 
r
->
uri_’d
 = 
p
;

568 
r
->
h‰p_mšÜ
 = 9;

569 
¡©e
 = 
sw_®mo¡_dÚe
;

571 
LF
:

572 
r
->
uri_’d
 = 
p
;

573 
r
->
h‰p_mšÜ
 = 9;

574 
dÚe
;

575 #ià(
NGX_WIN32
)

577 
r
->
com¶ex_uri
 = 1;

578 
¡©e
 = 
sw_aá”_¦ash_š_uri
;

582 
r
->
quÙed_uri
 = 1;

583 
¡©e
 = 
sw_uri
;

586 
r
->
¬gs_¡¬t
 = 
p
 + 1;

587 
¡©e
 = 
sw_uri
;

590 
r
->
com¶ex_uri
 = 1;

591 
¡©e
 = 
sw_uri
;

594 
r
->
¶us_š_uri
 = 1;

597  
NGX_HTTP_PARSE_INVALID_REQUEST
;

602 
sw_check_uri_h‰p_09
:

603 
ch
) {

606 
CR
:

607 
r
->
h‰p_mšÜ
 = 9;

608 
¡©e
 = 
sw_®mo¡_dÚe
;

610 
LF
:

611 
r
->
h‰p_mšÜ
 = 9;

612 
dÚe
;

614 
r
->
h‰p_´ÙocÞ
.
d©a
 = 
p
;

615 
¡©e
 = 
sw_h‰p_H
;

618 
r
->
¥aû_š_uri
 = 1;

619 
¡©e
 = 
sw_check_uri
;

620 
p
--;

627 
sw_uri
:

629 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

633 
ch
) {

635 
r
->
uri_’d
 = 
p
;

636 
¡©e
 = 
sw_h‰p_09
;

638 
CR
:

639 
r
->
uri_’d
 = 
p
;

640 
r
->
h‰p_mšÜ
 = 9;

641 
¡©e
 = 
sw_®mo¡_dÚe
;

643 
LF
:

644 
r
->
uri_’d
 = 
p
;

645 
r
->
h‰p_mšÜ
 = 9;

646 
dÚe
;

648 
r
->
com¶ex_uri
 = 1;

651  
NGX_HTTP_PARSE_INVALID_REQUEST
;

656 
sw_h‰p_09
:

657 
ch
) {

660 
CR
:

661 
r
->
h‰p_mšÜ
 = 9;

662 
¡©e
 = 
sw_®mo¡_dÚe
;

664 
LF
:

665 
r
->
h‰p_mšÜ
 = 9;

666 
dÚe
;

668 
r
->
h‰p_´ÙocÞ
.
d©a
 = 
p
;

669 
¡©e
 = 
sw_h‰p_H
;

672 
r
->
¥aû_š_uri
 = 1;

673 
¡©e
 = 
sw_uri
;

674 
p
--;

679 
sw_h‰p_H
:

680 
ch
) {

682 
¡©e
 = 
sw_h‰p_HT
;

685  
NGX_HTTP_PARSE_INVALID_REQUEST
;

689 
sw_h‰p_HT
:

690 
ch
) {

692 
¡©e
 = 
sw_h‰p_HTT
;

695  
NGX_HTTP_PARSE_INVALID_REQUEST
;

699 
sw_h‰p_HTT
:

700 
ch
) {

702 
¡©e
 = 
sw_h‰p_HTTP
;

705  
NGX_HTTP_PARSE_INVALID_REQUEST
;

709 
sw_h‰p_HTTP
:

710 
ch
) {

712 
¡©e
 = 
sw_fœ¡_majÜ_dig™
;

715  
NGX_HTTP_PARSE_INVALID_REQUEST
;

720 
sw_fœ¡_majÜ_dig™
:

721 ià(
ch
 < '1' || ch > '9') {

722  
NGX_HTTP_PARSE_INVALID_REQUEST
;

725 
r
->
h‰p_majÜ
 = 
ch
 - '0';

726 
¡©e
 = 
sw_majÜ_dig™
;

730 
sw_majÜ_dig™
:

731 ià(
ch
 == '.') {

732 
¡©e
 = 
sw_fœ¡_mšÜ_dig™
;

736 ià(
ch
 < '0' || ch > '9') {

737  
NGX_HTTP_PARSE_INVALID_REQUEST
;

740 
r
->
h‰p_majÜ
 =„->h‰p_majÜ * 10 + 
ch
 - '0';

744 
sw_fœ¡_mšÜ_dig™
:

745 ià(
ch
 < '0' || ch > '9') {

746  
NGX_HTTP_PARSE_INVALID_REQUEST
;

749 
r
->
h‰p_mšÜ
 = 
ch
 - '0';

750 
¡©e
 = 
sw_mšÜ_dig™
;

754 
sw_mšÜ_dig™
:

755 ià(
ch
 =ð
CR
) {

756 
¡©e
 = 
sw_®mo¡_dÚe
;

760 ià(
ch
 =ð
LF
) {

761 
dÚe
;

764 ià(
ch
 == ' ') {

765 
¡©e
 = 
sw_¥aûs_aá”_dig™
;

769 ià(
ch
 < '0' || ch > '9') {

770  
NGX_HTTP_PARSE_INVALID_REQUEST
;

773 
r
->
h‰p_mšÜ
 =„->h‰p_mšÜ * 10 + 
ch
 - '0';

776 
sw_¥aûs_aá”_dig™
:

777 
ch
) {

780 
CR
:

781 
¡©e
 = 
sw_®mo¡_dÚe
;

783 
LF
:

784 
dÚe
;

786  
NGX_HTTP_PARSE_INVALID_REQUEST
;

791 
sw_®mo¡_dÚe
:

792 
r
->
»que¡_’d
 = 
p
 - 1;

793 
ch
) {

794 
LF
:

795 
dÚe
;

797  
NGX_HTTP_PARSE_INVALID_REQUEST
;

802 
b
->
pos
 = 
p
;

803 
r
->
¡©e
 = state;

805  
NGX_AGAIN
;

807 
dÚe
:

809 
b
->
pos
 = 
p
 + 1;

811 ià(
r
->
»que¡_’d
 =ð
NULL
) {

812 
r
->
»que¡_’d
 = 
p
;

815 
r
->
h‰p_v”siÚ
 =„->
h‰p_majÜ
 * 1000 +„->
h‰p_mšÜ
;

816 
r
->
¡©e
 = 
sw_¡¬t
;

818 ià(
r
->
h‰p_v”siÚ
 =ð9 &&„->
m‘hod
 !ð
NGX_HTTP_GET
) {

819  
NGX_HTTP_PARSE_INVALID_09_METHOD
;

822  
NGX_OK
;

823 
	}
}

826 
ngx_št_t


827 
	$ngx_h‰p_·r£_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_buf_t
 *
b
,

828 
ngx_ušt_t
 
®low_und”scÜes
)

830 
u_ch¬
 
c
, 
ch
, *
p
;

831 
ngx_ušt_t
 
hash
, 
i
;

833 
sw_¡¬t
 = 0,

834 
sw_Çme
,

835 
sw_¥aû_befÜe_v®ue
,

836 
sw_v®ue
,

837 
sw_¥aû_aá”_v®ue
,

838 
sw_ignÜe_lše
,

839 
sw_®mo¡_dÚe
,

840 
sw_h—d”_®mo¡_dÚe


841 } 
¡©e
;

845 
u_ch¬
 
lowÿ£
[] =

855 
¡©e
 = 
r
->state;

856 
hash
 = 
r
->
h—d”_hash
;

857 
i
 = 
r
->
lowÿ£_šdex
;

859 
p
 = 
b
->
pos
;… < b->
Ï¡
;…++) {

860 
ch
 = *
p
;

862 
¡©e
) {

865 
sw_¡¬t
:

866 
r
->
h—d”_Çme_¡¬t
 = 
p
;

867 
r
->
šv®id_h—d”
 = 0;

869 
ch
) {

870 
CR
:

871 
r
->
h—d”_’d
 = 
p
;

872 
¡©e
 = 
sw_h—d”_®mo¡_dÚe
;

874 
LF
:

875 
r
->
h—d”_’d
 = 
p
;

876 
h—d”_dÚe
;

878 
¡©e
 = 
sw_Çme
;

880 
c
 = 
lowÿ£
[
ch
];

882 ià(
c
) {

883 
hash
 = 
	`ngx_hash
(0, 
c
);

884 
r
->
lowÿ£_h—d”
[0] = 
c
;

885 
i
 = 1;

889 ià(
ch
 == '_') {

890 ià(
®low_und”scÜes
) {

891 
hash
 = 
	`ngx_hash
(0, 
ch
);

892 
r
->
lowÿ£_h—d”
[0] = 
ch
;

893 
i
 = 1;

896 
r
->
šv®id_h—d”
 = 1;

902 ià(
ch
 == '\0') {

903  
NGX_HTTP_PARSE_INVALID_HEADER
;

906 
r
->
šv®id_h—d”
 = 1;

914 
sw_Çme
:

915 
c
 = 
lowÿ£
[
ch
];

917 ià(
c
) {

918 
hash
 = 
	`ngx_hash
(hash, 
c
);

919 
r
->
lowÿ£_h—d”
[
i
++] = 
c
;

920 
i
 &ð(
NGX_HTTP_LC_HEADER_LEN
 - 1);

924 ià(
ch
 == '_') {

925 ià(
®low_und”scÜes
) {

926 
hash
 = 
	`ngx_hash
(hash, 
ch
);

927 
r
->
lowÿ£_h—d”
[
i
++] = 
ch
;

928 
i
 &ð(
NGX_HTTP_LC_HEADER_LEN
 - 1);

931 
r
->
šv®id_h—d”
 = 1;

937 ià(
ch
 == ':') {

938 
r
->
h—d”_Çme_’d
 = 
p
;

939 
¡©e
 = 
sw_¥aû_befÜe_v®ue
;

943 ià(
ch
 =ð
CR
) {

944 
r
->
h—d”_Çme_’d
 = 
p
;

945 
r
->
h—d”_¡¬t
 = 
p
;

946 
r
->
h—d”_’d
 = 
p
;

947 
¡©e
 = 
sw_®mo¡_dÚe
;

951 ià(
ch
 =ð
LF
) {

952 
r
->
h—d”_Çme_’d
 = 
p
;

953 
r
->
h—d”_¡¬t
 = 
p
;

954 
r
->
h—d”_’d
 = 
p
;

955 
dÚe
;

959 ià(
ch
 == '/'

960 && 
r
->
up¡»am


961 && 
p
 - 
r
->
h—d”_Çme_¡¬t
 == 4

962 && 
	`ngx_¡ºcmp
(
r
->
h—d”_Çme_¡¬t
, "HTTP", 4) == 0)

964 
¡©e
 = 
sw_ignÜe_lše
;

968 ià(
ch
 == '\0') {

969  
NGX_HTTP_PARSE_INVALID_HEADER
;

972 
r
->
šv®id_h—d”
 = 1;

977 
sw_¥aû_befÜe_v®ue
:

978 
ch
) {

981 
CR
:

982 
r
->
h—d”_¡¬t
 = 
p
;

983 
r
->
h—d”_’d
 = 
p
;

984 
¡©e
 = 
sw_®mo¡_dÚe
;

986 
LF
:

987 
r
->
h—d”_¡¬t
 = 
p
;

988 
r
->
h—d”_’d
 = 
p
;

989 
dÚe
;

991  
NGX_HTTP_PARSE_INVALID_HEADER
;

993 
r
->
h—d”_¡¬t
 = 
p
;

994 
¡©e
 = 
sw_v®ue
;

1000 
sw_v®ue
:

1001 
ch
) {

1003 
r
->
h—d”_’d
 = 
p
;

1004 
¡©e
 = 
sw_¥aû_aá”_v®ue
;

1006 
CR
:

1007 
r
->
h—d”_’d
 = 
p
;

1008 
¡©e
 = 
sw_®mo¡_dÚe
;

1010 
LF
:

1011 
r
->
h—d”_’d
 = 
p
;

1012 
dÚe
;

1014  
NGX_HTTP_PARSE_INVALID_HEADER
;

1019 
sw_¥aû_aá”_v®ue
:

1020 
ch
) {

1023 
CR
:

1024 
¡©e
 = 
sw_®mo¡_dÚe
;

1026 
LF
:

1027 
dÚe
;

1029  
NGX_HTTP_PARSE_INVALID_HEADER
;

1031 
¡©e
 = 
sw_v®ue
;

1037 
sw_ignÜe_lše
:

1038 
ch
) {

1039 
LF
:

1040 
¡©e
 = 
sw_¡¬t
;

1048 
sw_®mo¡_dÚe
:

1049 
ch
) {

1050 
LF
:

1051 
dÚe
;

1052 
CR
:

1055  
NGX_HTTP_PARSE_INVALID_HEADER
;

1060 
sw_h—d”_®mo¡_dÚe
:

1061 
ch
) {

1062 
LF
:

1063 
h—d”_dÚe
;

1065  
NGX_HTTP_PARSE_INVALID_HEADER
;

1070 
b
->
pos
 = 
p
;

1071 
r
->
¡©e
 = state;

1072 
r
->
h—d”_hash
 = 
hash
;

1073 
r
->
lowÿ£_šdex
 = 
i
;

1075  
NGX_AGAIN
;

1077 
dÚe
:

1079 
b
->
pos
 = 
p
 + 1;

1080 
r
->
¡©e
 = 
sw_¡¬t
;

1081 
r
->
h—d”_hash
 = 
hash
;

1082 
r
->
lowÿ£_šdex
 = 
i
;

1084  
NGX_OK
;

1086 
h—d”_dÚe
:

1088 
b
->
pos
 = 
p
 + 1;

1089 
r
->
¡©e
 = 
sw_¡¬t
;

1091  
NGX_HTTP_PARSE_HEADER_DONE
;

1092 
	}
}

1095 
ngx_št_t


1096 
	$ngx_h‰p_·r£_uri
(
ngx_h‰p_»que¡_t
 *
r
)

1098 
u_ch¬
 *
p
, 
ch
;

1100 
sw_¡¬t
 = 0,

1101 
sw_aá”_¦ash_š_uri
,

1102 
sw_check_uri
,

1103 
sw_uri


1104 } 
¡©e
;

1106 
¡©e
 = 
sw_¡¬t
;

1108 
p
 = 
r
->
uri_¡¬t
;… !ðr->
uri_’d
;…++) {

1110 
ch
 = *
p
;

1112 
¡©e
) {

1114 
sw_¡¬t
:

1116 ià(
ch
 != '/') {

1117  
NGX_ERROR
;

1120 
¡©e
 = 
sw_aá”_¦ash_š_uri
;

1124 
sw_aá”_¦ash_š_uri
:

1126 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

1127 
¡©e
 = 
sw_check_uri
;

1131 
ch
) {

1133 
r
->
¥aû_š_uri
 = 1;

1134 
¡©e
 = 
sw_check_uri
;

1137 
r
->
com¶ex_uri
 = 1;

1138 
¡©e
 = 
sw_uri
;

1141 
r
->
quÙed_uri
 = 1;

1142 
¡©e
 = 
sw_uri
;

1145 
r
->
com¶ex_uri
 = 1;

1146 
¡©e
 = 
sw_uri
;

1148 #ià(
NGX_WIN32
)

1150 
r
->
com¶ex_uri
 = 1;

1151 
¡©e
 = 
sw_uri
;

1155 
r
->
¬gs_¡¬t
 = 
p
 + 1;

1156 
¡©e
 = 
sw_uri
;

1159 
r
->
com¶ex_uri
 = 1;

1160 
¡©e
 = 
sw_uri
;

1163 
r
->
¶us_š_uri
 = 1;

1166 
¡©e
 = 
sw_check_uri
;

1172 
sw_check_uri
:

1174 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

1178 
ch
) {

1180 #ià(
NGX_WIN32
)

1181 ià(
r
->
uri_ext
 =ð
p
) {

1182 
r
->
com¶ex_uri
 = 1;

1183 
¡©e
 = 
sw_uri
;

1187 
r
->
uri_ext
 = 
NULL
;

1188 
¡©e
 = 
sw_aá”_¦ash_š_uri
;

1191 
r
->
uri_ext
 = 
p
 + 1;

1194 
r
->
¥aû_š_uri
 = 1;

1196 #ià(
NGX_WIN32
)

1198 
r
->
com¶ex_uri
 = 1;

1199 
¡©e
 = 
sw_aá”_¦ash_š_uri
;

1203 
r
->
quÙed_uri
 = 1;

1204 
¡©e
 = 
sw_uri
;

1207 
r
->
¬gs_¡¬t
 = 
p
 + 1;

1208 
¡©e
 = 
sw_uri
;

1211 
r
->
com¶ex_uri
 = 1;

1212 
¡©e
 = 
sw_uri
;

1215 
r
->
¶us_š_uri
 = 1;

1221 
sw_uri
:

1223 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

1227 
ch
) {

1229 
r
->
¥aû_š_uri
 = 1;

1232 
r
->
com¶ex_uri
 = 1;

1239  
NGX_OK
;

1240 
	}
}

1243 
ngx_št_t


1244 
	$ngx_h‰p_·r£_com¶ex_uri
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
m”ge_¦ashes
)

1246 
u_ch¬
 
c
, 
ch
, 
decoded
, *
p
, *
u
;

1248 
sw_usu®
 = 0,

1249 
sw_¦ash
,

1250 
sw_dÙ
,

1251 
sw_dÙ_dÙ
,

1252 
sw_quÙed
,

1253 
sw_quÙed_£cÚd


1254 } 
¡©e
, 
quÙed_¡©e
;

1256 #ià(
NGX_SUPPRESS_WARN
)

1257 
decoded
 = '\0';

1258 
quÙed_¡©e
 = 
sw_usu®
;

1261 
¡©e
 = 
sw_usu®
;

1262 
p
 = 
r
->
uri_¡¬t
;

1263 
u
 = 
r
->
uri
.
d©a
;

1264 
r
->
uri_ext
 = 
NULL
;

1265 
r
->
¬gs_¡¬t
 = 
NULL
;

1267 
ch
 = *
p
++;

1269 
p
 <ð
r
->
uri_’d
) {

1277 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1278 "s:%d in:'%Xd:%c'", 
¡©e
, 
ch
, ch);

1280 
¡©e
) {

1282 
sw_usu®
:

1284 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

1285 *
u
++ = 
ch
;

1286 
ch
 = *
p
++;

1290 
ch
) {

1291 #ià(
NGX_WIN32
)

1293 ià(
u
 - 2 >ð
r
->
uri
.
d©a


1294 && *(
u
 - 1) == '.' && *(u - 2) != '.')

1296 
u
--;

1299 
r
->
uri_ext
 = 
NULL
;

1301 ià(
p
 =ð
r
->
uri_¡¬t
 +„->
uri
.
Ën
) {

1311 
¡©e
 = 
sw_¦ash
;

1312 *
u
++ = '/';

1316 #ià(
NGX_WIN32
)

1317 ià(
u
 - 2 >ð
r
->
uri
.
d©a


1318 && *(
u
 - 1) == '.' && *(u - 2) != '.')

1320 
u
--;

1323 
r
->
uri_ext
 = 
NULL
;

1324 
¡©e
 = 
sw_¦ash
;

1325 *
u
++ = 
ch
;

1328 
quÙed_¡©e
 = 
¡©e
;

1329 
¡©e
 = 
sw_quÙed
;

1332 
r
->
¬gs_¡¬t
 = 
p
;

1333 
¬gs
;

1335 
dÚe
;

1337 
r
->
uri_ext
 = 
u
 + 1;

1338 *
u
++ = 
ch
;

1341 
r
->
¶us_š_uri
 = 1;

1344 *
u
++ = 
ch
;

1348 
ch
 = *
p
++;

1351 
sw_¦ash
:

1353 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

1354 
¡©e
 = 
sw_usu®
;

1355 *
u
++ = 
ch
;

1356 
ch
 = *
p
++;

1360 
ch
) {

1361 #ià(
NGX_WIN32
)

1366 ià(!
m”ge_¦ashes
) {

1367 *
u
++ = 
ch
;

1371 
¡©e
 = 
sw_dÙ
;

1372 *
u
++ = 
ch
;

1375 
quÙed_¡©e
 = 
¡©e
;

1376 
¡©e
 = 
sw_quÙed
;

1379 
r
->
¬gs_¡¬t
 = 
p
;

1380 
¬gs
;

1382 
dÚe
;

1384 
r
->
¶us_š_uri
 = 1;

1386 
¡©e
 = 
sw_usu®
;

1387 *
u
++ = 
ch
;

1391 
ch
 = *
p
++;

1394 
sw_dÙ
:

1396 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

1397 
¡©e
 = 
sw_usu®
;

1398 *
u
++ = 
ch
;

1399 
ch
 = *
p
++;

1403 
ch
) {

1404 #ià(
NGX_WIN32
)

1408 
¡©e
 = 
sw_¦ash
;

1409 
u
--;

1412 
¡©e
 = 
sw_dÙ_dÙ
;

1413 *
u
++ = 
ch
;

1416 
quÙed_¡©e
 = 
¡©e
;

1417 
¡©e
 = 
sw_quÙed
;

1420 
r
->
¬gs_¡¬t
 = 
p
;

1421 
¬gs
;

1423 
dÚe
;

1425 
r
->
¶us_š_uri
 = 1;

1427 
¡©e
 = 
sw_usu®
;

1428 *
u
++ = 
ch
;

1432 
ch
 = *
p
++;

1435 
sw_dÙ_dÙ
:

1437 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

1438 
¡©e
 = 
sw_usu®
;

1439 *
u
++ = 
ch
;

1440 
ch
 = *
p
++;

1444 
ch
) {

1445 #ià(
NGX_WIN32
)

1449 
¡©e
 = 
sw_¦ash
;

1450 
u
 -= 5;

1452 ià(
u
 < 
r
->
uri
.
d©a
) {

1453  
NGX_HTTP_PARSE_INVALID_REQUEST
;

1455 ià(*
u
 == '/') {

1456 
u
++;

1459 
u
--;

1463 
quÙed_¡©e
 = 
¡©e
;

1464 
¡©e
 = 
sw_quÙed
;

1467 
r
->
¬gs_¡¬t
 = 
p
;

1468 
¬gs
;

1470 
dÚe
;

1472 
r
->
¶us_š_uri
 = 1;

1474 
¡©e
 = 
sw_usu®
;

1475 *
u
++ = 
ch
;

1479 
ch
 = *
p
++;

1482 
sw_quÙed
:

1483 
r
->
quÙed_uri
 = 1;

1485 ià(
ch
 >= '0' && ch <= '9') {

1486 
decoded
 = (
u_ch¬
è(
ch
 - '0');

1487 
¡©e
 = 
sw_quÙed_£cÚd
;

1488 
ch
 = *
p
++;

1492 
c
 = (
u_ch¬
è(
ch
 | 0x20);

1493 ià(
c
 >= 'a' && c <= 'f') {

1494 
decoded
 = (
u_ch¬
è(
c
 - 'a' + 10);

1495 
¡©e
 = 
sw_quÙed_£cÚd
;

1496 
ch
 = *
p
++;

1500  
NGX_HTTP_PARSE_INVALID_REQUEST
;

1502 
sw_quÙed_£cÚd
:

1503 ià(
ch
 >= '0' && ch <= '9') {

1504 
ch
 = (
u_ch¬
è((
decoded
 << 4) + ch - '0');

1506 ià(
ch
 == '%' || ch == '#') {

1507 
¡©e
 = 
sw_usu®
;

1508 *
u
++ = 
ch
;

1509 
ch
 = *
p
++;

1512 } ià(
ch
 == '\0') {

1513  
NGX_HTTP_PARSE_INVALID_REQUEST
;

1516 
¡©e
 = 
quÙed_¡©e
;

1520 
c
 = (
u_ch¬
è(
ch
 | 0x20);

1521 ià(
c
 >= 'a' && c <= 'f') {

1522 
ch
 = (
u_ch¬
è((
decoded
 << 4è+ 
c
 - 'a' + 10);

1524 ià(
ch
 == '?') {

1525 
¡©e
 = 
sw_usu®
;

1526 *
u
++ = 
ch
;

1527 
ch
 = *
p
++;

1530 } ià(
ch
 == '+') {

1531 
r
->
¶us_š_uri
 = 1;

1534 
¡©e
 = 
quÙed_¡©e
;

1538  
NGX_HTTP_PARSE_INVALID_REQUEST
;

1542 
dÚe
:

1544 
r
->
uri
.
Ën
 = 
u
 -„->uri.
d©a
;

1546 ià(
r
->
uri_ext
) {

1547 
r
->
ex‹n
.
Ën
 = 
u
 -„->
uri_ext
;

1548 
r
->
ex‹n
.
d©a
 =„->
uri_ext
;

1551 
r
->
uri_ext
 = 
NULL
;

1553  
NGX_OK
;

1555 
¬gs
:

1557 
p
 < 
r
->
uri_’d
) {

1558 ià(*
p
++ != '#') {

1562 
r
->
¬gs
.
Ën
 = 
p
 - 1 -„->
¬gs_¡¬t
;

1563 
r
->
¬gs
.
d©a
 =„->
¬gs_¡¬t
;

1564 
r
->
¬gs_¡¬t
 = 
NULL
;

1569 
r
->
uri
.
Ën
 = 
u
 -„->uri.
d©a
;

1571 ià(
r
->
uri_ext
) {

1572 
r
->
ex‹n
.
Ën
 = 
u
 -„->
uri_ext
;

1573 
r
->
ex‹n
.
d©a
 =„->
uri_ext
;

1576 
r
->
uri_ext
 = 
NULL
;

1578  
NGX_OK
;

1579 
	}
}

1582 
ngx_št_t


1583 
	$ngx_h‰p_·r£_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_buf_t
 *
b
,

1584 
ngx_h‰p_¡©us_t
 *
¡©us
)

1586 
u_ch¬
 
ch
;

1587 
u_ch¬
 *
p
;

1589 
sw_¡¬t
 = 0,

1590 
sw_H
,

1591 
sw_HT
,

1592 
sw_HTT
,

1593 
sw_HTTP
,

1594 
sw_fœ¡_majÜ_dig™
,

1595 
sw_majÜ_dig™
,

1596 
sw_fœ¡_mšÜ_dig™
,

1597 
sw_mšÜ_dig™
,

1598 
sw_¡©us
,

1599 
sw_¥aû_aá”_¡©us
,

1600 
sw_¡©us_‹xt
,

1601 
sw_®mo¡_dÚe


1602 } 
¡©e
;

1604 
¡©e
 = 
r
->state;

1606 
p
 = 
b
->
pos
;… < b->
Ï¡
;…++) {

1607 
ch
 = *
p
;

1609 
¡©e
) {

1612 
sw_¡¬t
:

1613 
ch
) {

1615 
¡©e
 = 
sw_H
;

1618  
NGX_ERROR
;

1622 
sw_H
:

1623 
ch
) {

1625 
¡©e
 = 
sw_HT
;

1628  
NGX_ERROR
;

1632 
sw_HT
:

1633 
ch
) {

1635 
¡©e
 = 
sw_HTT
;

1638  
NGX_ERROR
;

1642 
sw_HTT
:

1643 
ch
) {

1645 
¡©e
 = 
sw_HTTP
;

1648  
NGX_ERROR
;

1652 
sw_HTTP
:

1653 
ch
) {

1655 
¡©e
 = 
sw_fœ¡_majÜ_dig™
;

1658  
NGX_ERROR
;

1663 
sw_fœ¡_majÜ_dig™
:

1664 ià(
ch
 < '1' || ch > '9') {

1665  
NGX_ERROR
;

1668 
r
->
h‰p_majÜ
 = 
ch
 - '0';

1669 
¡©e
 = 
sw_majÜ_dig™
;

1673 
sw_majÜ_dig™
:

1674 ià(
ch
 == '.') {

1675 
¡©e
 = 
sw_fœ¡_mšÜ_dig™
;

1679 ià(
ch
 < '0' || ch > '9') {

1680  
NGX_ERROR
;

1683 
r
->
h‰p_majÜ
 =„->h‰p_majÜ * 10 + 
ch
 - '0';

1687 
sw_fœ¡_mšÜ_dig™
:

1688 ià(
ch
 < '0' || ch > '9') {

1689  
NGX_ERROR
;

1692 
r
->
h‰p_mšÜ
 = 
ch
 - '0';

1693 
¡©e
 = 
sw_mšÜ_dig™
;

1697 
sw_mšÜ_dig™
:

1698 ià(
ch
 == ' ') {

1699 
¡©e
 = 
sw_¡©us
;

1703 ià(
ch
 < '0' || ch > '9') {

1704  
NGX_ERROR
;

1707 
r
->
h‰p_mšÜ
 =„->h‰p_mšÜ * 10 + 
ch
 - '0';

1711 
sw_¡©us
:

1712 ià(
ch
 == ' ') {

1716 ià(
ch
 < '0' || ch > '9') {

1717  
NGX_ERROR
;

1720 
¡©us
->
code
 = stus->cod* 10 + 
ch
 - '0';

1722 ià(++
¡©us
->
couÁ
 == 3) {

1723 
¡©e
 = 
sw_¥aû_aá”_¡©us
;

1724 
¡©us
->
¡¬t
 = 
p
 - 2;

1730 
sw_¥aû_aá”_¡©us
:

1731 
ch
) {

1733 
¡©e
 = 
sw_¡©us_‹xt
;

1736 
¡©e
 = 
sw_¡©us_‹xt
;

1738 
CR
:

1739 
¡©e
 = 
sw_®mo¡_dÚe
;

1741 
LF
:

1742 
dÚe
;

1744  
NGX_ERROR
;

1749 
sw_¡©us_‹xt
:

1750 
ch
) {

1751 
CR
:

1752 
¡©e
 = 
sw_®mo¡_dÚe
;

1755 
LF
:

1756 
dÚe
;

1761 
sw_®mo¡_dÚe
:

1762 
¡©us
->
’d
 = 
p
 - 1;

1763 
ch
) {

1764 
LF
:

1765 
dÚe
;

1767  
NGX_ERROR
;

1772 
b
->
pos
 = 
p
;

1773 
r
->
¡©e
 = state;

1775  
NGX_AGAIN
;

1777 
dÚe
:

1779 
b
->
pos
 = 
p
 + 1;

1781 ià(
¡©us
->
’d
 =ð
NULL
) {

1782 
¡©us
->
’d
 = 
p
;

1785 
¡©us
->
h‰p_v”siÚ
 = 
r
->
h‰p_majÜ
 * 1000 +„->
h‰p_mšÜ
;

1786 
r
->
¡©e
 = 
sw_¡¬t
;

1788  
NGX_OK
;

1789 
	}
}

1792 
ngx_št_t


1793 
	$ngx_h‰p_·r£_un§ã_uri
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
uri
,

1794 
ngx_¡r_t
 *
¬gs
, 
ngx_ušt_t
 *
æags
)

1796 
u_ch¬
 
ch
, *
p
, *
¤c
, *
d¡
;

1797 
size_t
 
Ën
;

1798 
ngx_ušt_t
 
quÙed
;

1800 
Ën
 = 
uri
->len;

1801 
p
 = 
uri
->
d©a
;

1802 
quÙed
 = 0;

1804 ià(
Ën
 =ð0 || 
p
[0] == '?') {

1805 
un§ã
;

1808 ià(
p
[0] =ð'.' && 
Ën
 > 1 &&…[1] == '.'

1809 && (
Ën
 =ð2 || 
	`ngx_·th_£·¿tÜ
(
p
[2])))

1811 
un§ã
;

1814  ; 
Ën
;†en--) {

1816 
ch
 = *
p
++;

1818 ià(
ch
 == '%') {

1819 
quÙed
 = 1;

1823 ià(
usu®
[
ch
 >> 5] & (1 << (ch & 0x1f))) {

1827 ià(
ch
 == '?') {

1828 
¬gs
->
Ën
 =†en - 1;

1829 
¬gs
->
d©a
 = 
p
;

1830 
uri
->
Ën
 -=†en;

1835 ià(
ch
 == '\0') {

1836 
un§ã
;

1839 ià(
	`ngx_·th_£·¿tÜ
(
ch
è&& 
Ën
 > 2) {

1843 ià(
p
[0] == '.' &&…[1] == '.'

1844 && (
Ën
 =ð3 || 
	`ngx_·th_£·¿tÜ
(
p
[2])))

1846 
un§ã
;

1851 ià(
quÙed
) {

1852 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1853 "esÿ³d URI: \"%V\"", 
uri
);

1855 
¤c
 = 
uri
->
d©a
;

1857 
d¡
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
uri
->
Ën
);

1858 ià(
d¡
 =ð
NULL
) {

1859  
NGX_ERROR
;

1862 
uri
->
d©a
 = 
d¡
;

1864 
	`ngx_uÃsÿ³_uri
(&
d¡
, &
¤c
, 
uri
->
Ën
, 0);

1866 
uri
->
Ën
 = 
d¡
 - uri->
d©a
;

1868 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1869 "uÃsÿ³d URI: \"%V\"", 
uri
);

1871 
Ën
 = 
uri
->len;

1872 
p
 = 
uri
->
d©a
;

1874 ià(
p
[0] =ð'.' && 
Ën
 > 1 &&…[1] == '.'

1875 && (
Ën
 =ð2 || 
	`ngx_·th_£·¿tÜ
(
p
[2])))

1877 
un§ã
;

1880  ; 
Ën
;†en--) {

1882 
ch
 = *
p
++;

1884 ià(
ch
 == '\0') {

1885 
un§ã
;

1888 ià(
	`ngx_·th_£·¿tÜ
(
ch
è&& 
Ën
 > 2) {

1892 ià(
p
[0] == '.' &&…[1] == '.'

1893 && (
Ën
 =ð3 || 
	`ngx_·th_£·¿tÜ
(
p
[2])))

1895 
un§ã
;

1901  
NGX_OK
;

1903 
un§ã
:

1905 ià(*
æags
 & 
NGX_HTTP_LOG_UNSAFE
) {

1906 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1907 "un§ã URI \"%V\" wa d‘eùed", 
uri
);

1910  
NGX_ERROR
;

1911 
	}
}

1914 
ngx_št_t


1915 
	$ngx_h‰p_·r£_muÉi_h—d”_lšes
(
ngx_¬¿y_t
 *
h—d”s
, 
ngx_¡r_t
 *
Çme
,

1916 
ngx_¡r_t
 *
v®ue
)

1918 
ngx_ušt_t
 
i
;

1919 
u_ch¬
 *
¡¬t
, *
Ï¡
, *
’d
, 
ch
;

1920 
ngx_bË_–t_t
 **
h
;

1922 
h
 = 
h—d”s
->
–ts
;

1924 
i
 = 0; i < 
h—d”s
->
ÃÉs
; i++) {

1926 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
h—d”s
->
poÞ
->
log
, 0,

1927 "·r£ h—d”: \"%V: %V\"", &
h
[
i
]->
key
, &h[i]->
v®ue
);

1929 ià(
Çme
->
Ën
 > 
h
[
i
]->
v®ue
.len) {

1933 
¡¬t
 = 
h
[
i
]->
v®ue
.
d©a
;

1934 
’d
 = 
h
[
i
]->
v®ue
.
d©a
 + h[i]->v®ue.
Ën
;

1936 
¡¬t
 < 
’d
) {

1938 ià(
	`ngx_¡ºÿ£cmp
(
¡¬t
, 
Çme
->
d©a
,‚ame->
Ën
) != 0) {

1939 
sk
;

1942 
¡¬t
 +ð
Çme
->
Ën
; s¹ < 
’d
 && *start == ' '; start++) {

1946 ià(
v®ue
 =ð
NULL
) {

1947 ià(
¡¬t
 =ð
’d
 || *start == ',') {

1948  
i
;

1951 
sk
;

1954 ià(
¡¬t
 =ð
’d
 || *start++ != '=') {

1956 
sk
;

1959 
¡¬t
 < 
’d
 && *start == ' ') { start++; }

1961 
Ï¡
 = 
¡¬t
;†a¡ < 
’d
 && *last != ';';†ast++) {

1965 
v®ue
->
Ën
 = 
Ï¡
 - 
¡¬t
;

1966 
v®ue
->
d©a
 = 
¡¬t
;

1968  
i
;

1970 
sk
:

1972 
¡¬t
 < 
’d
) {

1973 
ch
 = *
¡¬t
++;

1974 ià(
ch
 == ';' || ch == ',') {

1979 
¡¬t
 < 
’d
 && *start == ' ') { start++; }

1983  
NGX_DECLINED
;

1984 
	}
}

1987 
ngx_št_t


1988 
	$ngx_h‰p_·r£_£t_cook›_lšes
(
ngx_¬¿y_t
 *
h—d”s
, 
ngx_¡r_t
 *
Çme
,

1989 
ngx_¡r_t
 *
v®ue
)

1991 
ngx_ušt_t
 
i
;

1992 
u_ch¬
 *
¡¬t
, *
Ï¡
, *
’d
;

1993 
ngx_bË_–t_t
 **
h
;

1995 
h
 = 
h—d”s
->
–ts
;

1997 
i
 = 0; i < 
h—d”s
->
ÃÉs
; i++) {

1999 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
h—d”s
->
poÞ
->
log
, 0,

2000 "·r£ h—d”: \"%V: %V\"", &
h
[
i
]->
key
, &h[i]->
v®ue
);

2002 ià(
Çme
->
Ën
 >ð
h
[
i
]->
v®ue
.len) {

2006 
¡¬t
 = 
h
[
i
]->
v®ue
.
d©a
;

2007 
’d
 = 
h
[
i
]->
v®ue
.
d©a
 + h[i]->v®ue.
Ën
;

2009 ià(
	`ngx_¡ºÿ£cmp
(
¡¬t
, 
Çme
->
d©a
,‚ame->
Ën
) != 0) {

2013 
¡¬t
 +ð
Çme
->
Ën
; s¹ < 
’d
 && *start == ' '; start++) {

2017 ià(
¡¬t
 =ð
’d
 || *start++ != '=') {

2022 
¡¬t
 < 
’d
 && *start == ' ') { start++; }

2024 
Ï¡
 = 
¡¬t
;†a¡ < 
’d
 && *last != ';';†ast++) {

2028 
v®ue
->
Ën
 = 
Ï¡
 - 
¡¬t
;

2029 
v®ue
->
d©a
 = 
¡¬t
;

2031  
i
;

2034  
NGX_DECLINED
;

2035 
	}
}

2038 
ngx_št_t


2039 
	$ngx_h‰p_¬g
(
ngx_h‰p_»que¡_t
 *
r
, 
u_ch¬
 *
Çme
, 
size_t
 
Ën
, 
ngx_¡r_t
 *
v®ue
)

2041 
u_ch¬
 *
p
, *
Ï¡
;

2043 ià(
r
->
¬gs
.
Ën
 == 0) {

2044  
NGX_DECLINED
;

2047 
p
 = 
r
->
¬gs
.
d©a
;

2048 
Ï¡
 = 
p
 + 
r
->
¬gs
.
Ën
;

2050  ; 
p
 < 
Ï¡
;…++) {

2054 
p
 = 
	`ngx_¡¾ÿ£¡º
Õ, 
Ï¡
 - 1, 
Çme
, 
Ën
 - 1);

2056 ià(
p
 =ð
NULL
) {

2057  
NGX_DECLINED
;

2060 ià((
p
 =ð
r
->
¬gs
.
d©a
 || *Õ - 1è=ð'&'è&& *Õ + 
Ën
) == '=') {

2062 
v®ue
->
d©a
 = 
p
 + 
Ën
 + 1;

2064 
p
 = 
	`ngx_¡¾chr
Õ, 
Ï¡
, '&');

2066 ià(
p
 =ð
NULL
) {

2067 
p
 = 
r
->
¬gs
.
d©a
 +„->¬gs.
Ën
;

2070 
v®ue
->
Ën
 = 
p
 - v®ue->
d©a
;

2072  
NGX_OK
;

2076  
NGX_DECLINED
;

2077 
	}
}

2081 
	$ngx_h‰p_¥l™_¬gs
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
uri
,‚gx_¡r_ˆ*
¬gs
)

2083 
u_ch¬
 *
p
, *
Ï¡
;

2085 
Ï¡
 = 
uri
->
d©a
 + uri->
Ën
;

2087 
p
 = 
	`ngx_¡¾chr
(
uri
->
d©a
, 
Ï¡
, '?');

2089 ià(
p
) {

2090 
uri
->
Ën
 = 
p
 - uri->
d©a
;

2091 
p
++;

2092 
¬gs
->
Ën
 = 
Ï¡
 - 
p
;

2093 
¬gs
->
d©a
 = 
p
;

2096 
¬gs
->
Ën
 = 0;

2098 
	}
}

2101 
ngx_št_t


2102 
	$ngx_h‰p_·r£_chunked
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_buf_t
 *
b
,

2103 
ngx_h‰p_chunked_t
 *
ùx
)

2105 
u_ch¬
 *
pos
, 
ch
, 
c
;

2106 
ngx_št_t
 
rc
;

2108 
sw_chunk_¡¬t
 = 0,

2109 
sw_chunk_size
,

2110 
sw_chunk_ex‹nsiÚ
,

2111 
sw_chunk_ex‹nsiÚ_®mo¡_dÚe
,

2112 
sw_chunk_d©a
,

2113 
sw_aá”_d©a
,

2114 
sw_aá”_d©a_®mo¡_dÚe
,

2115 
sw_Ï¡_chunk_ex‹nsiÚ
,

2116 
sw_Ï¡_chunk_ex‹nsiÚ_®mo¡_dÚe
,

2117 
sw_Œaž”
,

2118 
sw_Œaž”_®mo¡_dÚe
,

2119 
sw_Œaž”_h—d”
,

2120 
sw_Œaž”_h—d”_®mo¡_dÚe


2121 } 
¡©e
;

2123 
¡©e
 = 
ùx
->state;

2125 ià(
¡©e
 =ð
sw_chunk_d©a
 && 
ùx
->
size
 == 0) {

2126 
¡©e
 = 
sw_aá”_d©a
;

2129 
rc
 = 
NGX_AGAIN
;

2131 
pos
 = 
b
->pos;…o < b->
Ï¡
;…os++) {

2133 
ch
 = *
pos
;

2135 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2136 "h‰°chunked by‹: %02Xd s:%d", 
ch
, 
¡©e
);

2138 
¡©e
) {

2140 
sw_chunk_¡¬t
:

2141 ià(
ch
 >= '0' && ch <= '9') {

2142 
¡©e
 = 
sw_chunk_size
;

2143 
ùx
->
size
 = 
ch
 - '0';

2147 
c
 = (
u_ch¬
è(
ch
 | 0x20);

2149 ià(
c
 >= 'a' && c <= 'f') {

2150 
¡©e
 = 
sw_chunk_size
;

2151 
ùx
->
size
 = 
c
 - 'a' + 10;

2155 
šv®id
;

2157 
sw_chunk_size
:

2158 ià(
ch
 >= '0' && ch <= '9') {

2159 
ùx
->
size
 = ctx->siz* 16 + (
ch
 - '0');

2163 
c
 = (
u_ch¬
è(
ch
 | 0x20);

2165 ià(
c
 >= 'a' && c <= 'f') {

2166 
ùx
->
size
 = ctx->siz* 16 + (
c
 - 'a' + 10);

2170 ià(
ùx
->
size
 == 0) {

2172 
ch
) {

2173 
CR
:

2174 
¡©e
 = 
sw_Ï¡_chunk_ex‹nsiÚ_®mo¡_dÚe
;

2176 
LF
:

2177 
¡©e
 = 
sw_Œaž”
;

2182 
¡©e
 = 
sw_Ï¡_chunk_ex‹nsiÚ
;

2185 
šv®id
;

2191 
ch
) {

2192 
CR
:

2193 
¡©e
 = 
sw_chunk_ex‹nsiÚ_®mo¡_dÚe
;

2195 
LF
:

2196 
¡©e
 = 
sw_chunk_d©a
;

2201 
¡©e
 = 
sw_chunk_ex‹nsiÚ
;

2204 
šv®id
;

2209 
sw_chunk_ex‹nsiÚ
:

2210 
ch
) {

2211 
CR
:

2212 
¡©e
 = 
sw_chunk_ex‹nsiÚ_®mo¡_dÚe
;

2214 
LF
:

2215 
¡©e
 = 
sw_chunk_d©a
;

2219 
sw_chunk_ex‹nsiÚ_®mo¡_dÚe
:

2220 ià(
ch
 =ð
LF
) {

2221 
¡©e
 = 
sw_chunk_d©a
;

2224 
šv®id
;

2226 
sw_chunk_d©a
:

2227 
rc
 = 
NGX_OK
;

2228 
d©a
;

2230 
sw_aá”_d©a
:

2231 
ch
) {

2232 
CR
:

2233 
¡©e
 = 
sw_aá”_d©a_®mo¡_dÚe
;

2235 
LF
:

2236 
¡©e
 = 
sw_chunk_¡¬t
;

2240 
sw_aá”_d©a_®mo¡_dÚe
:

2241 ià(
ch
 =ð
LF
) {

2242 
¡©e
 = 
sw_chunk_¡¬t
;

2245 
šv®id
;

2247 
sw_Ï¡_chunk_ex‹nsiÚ
:

2248 
ch
) {

2249 
CR
:

2250 
¡©e
 = 
sw_Ï¡_chunk_ex‹nsiÚ_®mo¡_dÚe
;

2252 
LF
:

2253 
¡©e
 = 
sw_Œaž”
;

2257 
sw_Ï¡_chunk_ex‹nsiÚ_®mo¡_dÚe
:

2258 ià(
ch
 =ð
LF
) {

2259 
¡©e
 = 
sw_Œaž”
;

2262 
šv®id
;

2264 
sw_Œaž”
:

2265 
ch
) {

2266 
CR
:

2267 
¡©e
 = 
sw_Œaž”_®mo¡_dÚe
;

2269 
LF
:

2270 
dÚe
;

2272 
¡©e
 = 
sw_Œaž”_h—d”
;

2276 
sw_Œaž”_®mo¡_dÚe
:

2277 ià(
ch
 =ð
LF
) {

2278 
dÚe
;

2280 
šv®id
;

2282 
sw_Œaž”_h—d”
:

2283 
ch
) {

2284 
CR
:

2285 
¡©e
 = 
sw_Œaž”_h—d”_®mo¡_dÚe
;

2287 
LF
:

2288 
¡©e
 = 
sw_Œaž”
;

2292 
sw_Œaž”_h—d”_®mo¡_dÚe
:

2293 ià(
ch
 =ð
LF
) {

2294 
¡©e
 = 
sw_Œaž”
;

2297 
šv®id
;

2302 
d©a
:

2304 
ùx
->
¡©e
 = state;

2305 
b
->
pos
 =…os;

2307 
¡©e
) {

2309 
sw_chunk_¡¬t
:

2310 
ùx
->
Ëngth
 = 3 ;

2312 
sw_chunk_size
:

2313 
ùx
->
Ëngth
 = 1

2314 + (
ùx
->
size
 ? ctx->size + 4

2317 
sw_chunk_ex‹nsiÚ
:

2318 
sw_chunk_ex‹nsiÚ_®mo¡_dÚe
:

2319 
ùx
->
Ëngth
 = 1 + ctx->
size
 + 4 ;

2321 
sw_chunk_d©a
:

2322 
ùx
->
Ëngth
 = ctx->
size
 + 4 ;

2324 
sw_aá”_d©a
:

2325 
sw_aá”_d©a_®mo¡_dÚe
:

2326 
ùx
->
Ëngth
 = 4 ;

2328 
sw_Ï¡_chunk_ex‹nsiÚ
:

2329 
sw_Ï¡_chunk_ex‹nsiÚ_®mo¡_dÚe
:

2330 
ùx
->
Ëngth
 = 2 ;

2332 
sw_Œaž”
:

2333 
sw_Œaž”_®mo¡_dÚe
:

2334 
ùx
->
Ëngth
 = 1 ;

2336 
sw_Œaž”_h—d”
:

2337 
sw_Œaž”_h—d”_®mo¡_dÚe
:

2338 
ùx
->
Ëngth
 = 2 ;

2343 ià(
ùx
->
size
 < 0 || ctx->
Ëngth
 < 0) {

2344 
šv®id
;

2347  
rc
;

2349 
dÚe
:

2351 
ùx
->
¡©e
 = 0;

2352 
b
->
pos
 =…os + 1;

2354  
NGX_DONE
;

2356 
šv®id
:

2358  
NGX_ERROR
;

2359 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_parse_time.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_ušt_t
 
	gmday
[] = { 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 };

15 
time_t


16 
	$ngx_h‰p_·r£_time
(
u_ch¬
 *
v®ue
, 
size_t
 
Ën
)

18 
u_ch¬
 *
p
, *
’d
;

19 
ngx_št_t
 
mÚth
;

20 
ngx_ušt_t
 
day
, 
y—r
, 
hour
, 
mš
, 
£c
;

21 
ušt64_t
 
time
;

23 
no
 = 0,

24 
rfc822
,

25 
rfc850
,

26 
isoc


27 } 
fmt
;

29 
fmt
 = 0;

30 
’d
 = 
v®ue
 + 
Ën
;

32 #ià(
NGX_SUPPRESS_WARN
)

33 
day
 = 32;

34 
y—r
 = 2038;

37 
p
 = 
v®ue
;… < 
’d
;…++) {

38 ià(*
p
 == ',') {

42 ià(*
p
 == ' ') {

43 
fmt
 = 
isoc
;

48 
p
++;… < 
’d
;…++)

49 ià(*
p
 != ' ') {

53 ià(
’d
 - 
p
 < 18) {

54  
NGX_ERROR
;

57 ià(
fmt
 !ð
isoc
) {

58 ià(*
p
 < '0' || *p > '9' || *(p + 1) < '0' || *(p + 1) > '9') {

59  
NGX_ERROR
;

62 
day
 = (*
p
 - '0') * 10 + *(p + 1) - '0';

63 
p
 += 2;

65 ià(*
p
 == ' ') {

66 ià(
’d
 - 
p
 < 18) {

67  
NGX_ERROR
;

69 
fmt
 = 
rfc822
;

71 } ià(*
p
 == '-') {

72 
fmt
 = 
rfc850
;

75  
NGX_ERROR
;

78 
p
++;

81 *
p
) {

84 
mÚth
 = *(
p
 + 1) == 'a' ? 0 : *(p + 2) == 'n' ? 5 : 6;

88 
mÚth
 = 1;

92 
mÚth
 = *(
p
 + 2) == 'r' ? 2 : 4;

96 
mÚth
 = *(
p
 + 1) == 'p' ? 3 : 7;

100 
mÚth
 = 8;

104 
mÚth
 = 9;

108 
mÚth
 = 10;

112 
mÚth
 = 11;

116  
NGX_ERROR
;

119 
p
 += 3;

121 ià((
fmt
 =ð
rfc822
 && *
p
 !ð' 'è|| (fmˆ=ð
rfc850
 && *p != '-')) {

122  
NGX_ERROR
;

125 
p
++;

127 ià(
fmt
 =ð
rfc822
) {

128 ià(*
p
 < '0' || *p > '9' || *(p + 1) < '0' || *(p + 1) > '9'

129 || *(
p
 + 2) < '0' || *(p + 2) > '9'

130 || *(
p
 + 3) < '0' || *(p + 3) > '9')

132  
NGX_ERROR
;

135 
y—r
 = (*
p
 - '0') * 1000 + (*(p + 1) - '0') * 100

136 + (*(
p
 + 2) - '0') * 10 + *(p + 3) - '0';

137 
p
 += 4;

139 } ià(
fmt
 =ð
rfc850
) {

140 ià(*
p
 < '0' || *p > '9' || *(p + 1) < '0' || *(p + 1) > '9') {

141  
NGX_ERROR
;

144 
y—r
 = (*
p
 - '0') * 10 + *(p + 1) - '0';

145 
y—r
 += (year < 70) ? 2000 : 1900;

146 
p
 += 2;

149 ià(
fmt
 =ð
isoc
) {

150 ià(*
p
 == ' ') {

151 
p
++;

154 ià(*
p
 < '0' || *p > '9') {

155  
NGX_ERROR
;

158 
day
 = *
p
++ - '0';

160 ià(*
p
 != ' ') {

161 ià(*
p
 < '0' || *p > '9') {

162  
NGX_ERROR
;

165 
day
 = day * 10 + *
p
++ - '0';

168 ià(
’d
 - 
p
 < 14) {

169  
NGX_ERROR
;

173 ià(*
p
++ != ' ') {

174  
NGX_ERROR
;

177 ià(*
p
 < '0' || *p > '9' || *(p + 1) < '0' || *(p + 1) > '9') {

178  
NGX_ERROR
;

181 
hour
 = (*
p
 - '0') * 10 + *(p + 1) - '0';

182 
p
 += 2;

184 ià(*
p
++ != ':') {

185  
NGX_ERROR
;

188 ià(*
p
 < '0' || *p > '9' || *(p + 1) < '0' || *(p + 1) > '9') {

189  
NGX_ERROR
;

192 
mš
 = (*
p
 - '0') * 10 + *(p + 1) - '0';

193 
p
 += 2;

195 ià(*
p
++ != ':') {

196  
NGX_ERROR
;

199 ià(*
p
 < '0' || *p > '9' || *(p + 1) < '0' || *(p + 1) > '9') {

200  
NGX_ERROR
;

203 
£c
 = (*
p
 - '0') * 10 + *(p + 1) - '0';

205 ià(
fmt
 =ð
isoc
) {

206 
p
 += 2;

208 ià(*
p
++ != ' ') {

209  
NGX_ERROR
;

212 ià(*
p
 < '0' || *p > '9' || *(p + 1) < '0' || *(p + 1) > '9'

213 || *(
p
 + 2) < '0' || *(p + 2) > '9'

214 || *(
p
 + 3) < '0' || *(p + 3) > '9')

216  
NGX_ERROR
;

219 
y—r
 = (*
p
 - '0') * 1000 + (*(p + 1) - '0') * 100

220 + (*(
p
 + 2) - '0') * 10 + *(p + 3) - '0';

223 ià(
hour
 > 23 || 
mš
 > 59 || 
£c
 > 59) {

224  
NGX_ERROR
;

227 ià(
day
 =ð29 && 
mÚth
 == 1) {

228 ià((
y—r
 & 3) || ((year % 100 == 0) && (year % 400) != 0)) {

229  
NGX_ERROR
;

232 } ià(
day
 > 
mday
[
mÚth
]) {

233  
NGX_ERROR
;

241 ià(--
mÚth
 <= 0) {

242 
mÚth
 += 12;

243 
y—r
 -= 1;

248 
time
 = (
ušt64_t
) (

251 365 * 
y—r
 + year / 4 - year / 100 + year / 400

255 + 367 * 
mÚth
 / 12 - 30

259 + 
day
 - 1

266 - 719527 + 31 + 28è* 86400 + 
hour
 * 3600 + 
mš
 * 60 + 
£c
;

268 #ià(
NGX_TIME_T_SIZE
 <= 4)

270 ià(
time
 > 0x7fffffff) {

271  
NGX_ERROR
;

276  (
time_t
è
time
;

277 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_postpone_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_št_t
 
ngx_h‰p_po¡pÚe_fž‹r_add
(
ngx_h‰p_»que¡_t
 *
r
,

14 
ngx_chaš_t
 *
š
);

15 
ngx_št_t
 
ngx_h‰p_po¡pÚe_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

18 
ngx_h‰p_moduË_t
 
	gngx_h‰p_po¡pÚe_fž‹r_moduË_ùx
 = {

19 
NULL
,

20 
ngx_h‰p_po¡pÚe_fž‹r_š™
,

22 
NULL
,

23 
NULL
,

25 
NULL
,

26 
NULL
,

28 
NULL
,

29 
NULL


33 
ngx_moduË_t
 
	gngx_h‰p_po¡pÚe_fž‹r_moduË
 = {

34 
NGX_MODULE_V1
,

35 &
ngx_h‰p_po¡pÚe_fž‹r_moduË_ùx
,

36 
NULL
,

37 
NGX_HTTP_MODULE
,

38 
NULL
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NGX_MODULE_V1_PADDING


49 
ngx_h‰p_ouut_body_fž‹r_±
 
	gngx_h‰p_Ãxt_body_fž‹r
;

52 
ngx_št_t


53 
	$ngx_h‰p_po¡pÚe_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

55 
ngx_cÚÃùiÚ_t
 *
c
;

56 
ngx_h‰p_po¡pÚed_»que¡_t
 *
´
;

58 
c
 = 
r
->
cÚÃùiÚ
;

60 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

61 "h‰°po¡pÚfž‹¸\"%V?%V\" %p", &
r
->
uri
, &r->
¬gs
, 
š
);

63 ià(
r
 !ð
c
->
d©a
) {

65 ià(
š
) {

66 
	`ngx_h‰p_po¡pÚe_fž‹r_add
(
r
, 
š
);

67  
NGX_OK
;

72 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

76  
NGX_OK
;

79 ià(
r
->
po¡pÚed
 =ð
NULL
) {

81 ià(
š
 || 
c
->
bufã»d
) {

82  
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
->
maš
, 
š
);

85  
NGX_OK
;

88 ià(
š
) {

89 
	`ngx_h‰p_po¡pÚe_fž‹r_add
(
r
, 
š
);

93 
´
 = 
r
->
po¡pÚed
;

95 ià(
´
->
»que¡
) {

97 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

99 &
´
->
»que¡
->
uri
, &´->»que¡->
¬gs
);

101 
r
->
po¡pÚed
 = 
´
->
Ãxt
;

103 
c
->
d©a
 = 
´
->
»que¡
;

105  
	`ngx_h‰p_po¡_»que¡
(
´
->
»que¡
, 
NULL
);

108 ià(
´
->
out
 =ð
NULL
) {

109 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

113 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

115 &
r
->
uri
, &r->
¬gs
);

117 ià(
	`ngx_h‰p_Ãxt_body_fž‹r
(
r
->
maš
, 
´
->
out
è=ð
NGX_ERROR
) {

118  
NGX_ERROR
;

122 
r
->
po¡pÚed
 = 
´
->
Ãxt
;

124 } 
r
->
po¡pÚed
);

126  
NGX_OK
;

127 
	}
}

130 
ngx_št_t


131 
	$ngx_h‰p_po¡pÚe_fž‹r_add
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

133 
ngx_h‰p_po¡pÚed_»que¡_t
 *
´
, **
µr
;

135 ià(
r
->
po¡pÚed
) {

136 
´
 = 
r
->
po¡pÚed
;…r->
Ãxt
;…r =…r->next) { }

138 ià(
´
->
»que¡
 =ð
NULL
) {

139 
found
;

142 
µr
 = &
´
->
Ãxt
;

145 
µr
 = &
r
->
po¡pÚed
;

148 
´
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_po¡pÚed_»que¡_t
));

149 ià(
´
 =ð
NULL
) {

150  
NGX_ERROR
;

153 *
µr
 = 
´
;

155 
´
->
»que¡
 = 
NULL
;

156 
´
->
out
 = 
NULL
;

157 
´
->
Ãxt
 = 
NULL
;

159 
found
:

161 ià(
	`ngx_chaš_add_cÝy
(
r
->
poÞ
, &
´
->
out
, 
š
è=ð
NGX_OK
) {

162  
NGX_OK
;

165  
NGX_ERROR
;

166 
	}
}

169 
ngx_št_t


170 
	$ngx_h‰p_po¡pÚe_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

172 
ngx_h‰p_Ãxt_body_fž‹r
 = 
ngx_h‰p_tÝ_body_fž‹r
;

173 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_po¡pÚe_fž‹r
;

175  
NGX_OK
;

176 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_request.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_h‰p_wa™_»que¡_hªdËr
(
ngx_ev’t_t
 *
ev
);

14 
ngx_h‰p_´oûss_»que¡_lše
(
ngx_ev’t_t
 *
»v
);

15 
ngx_h‰p_´oûss_»que¡_h—d”s
(
ngx_ev’t_t
 *
»v
);

16 
ssize_t
 
ngx_h‰p_»ad_»que¡_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

17 
ngx_št_t
 
ngx_h‰p_®loc_Ïrge_h—d”_bufãr
(
ngx_h‰p_»que¡_t
 *
r
,

18 
ngx_ušt_t
 
»que¡_lše
);

20 
ngx_št_t
 
ngx_h‰p_´oûss_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
,

21 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

22 
ngx_št_t
 
ngx_h‰p_´oûss_unique_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
,

23 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

24 
ngx_št_t
 
ngx_h‰p_´oûss_muÉi_h—d”_lšes
(
ngx_h‰p_»que¡_t
 *
r
,

25 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

26 
ngx_št_t
 
ngx_h‰p_´oûss_ho¡
(
ngx_h‰p_»que¡_t
 *
r
,

27 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

28 
ngx_št_t
 
ngx_h‰p_´oûss_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

29 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

30 
ngx_št_t
 
ngx_h‰p_´oûss_u£r_ag’t
(
ngx_h‰p_»que¡_t
 *
r
,

31 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

33 
ngx_št_t
 
ngx_h‰p_v®id©e_ho¡
(
ngx_¡r_t
 *
ho¡
, 
ngx_poÞ_t
 *
poÞ
,

34 
ngx_ušt_t
 
®loc
);

35 
ngx_št_t
 
ngx_h‰p_£t_vœtu®_£rv”
(
ngx_h‰p_»que¡_t
 *
r
,

36 
ngx_¡r_t
 *
ho¡
);

37 
ngx_št_t
 
ngx_h‰p_fšd_vœtu®_£rv”
(
ngx_cÚÃùiÚ_t
 *
c
,

38 
ngx_h‰p_vœtu®_Çmes_t
 *
vœtu®_Çmes
, 
ngx_¡r_t
 *
ho¡
,

39 
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_cÜe_¤v_cÚf_t
 **
cscå
);

41 
ngx_h‰p_»que¡_hªdËr
(
ngx_ev’t_t
 *
ev
);

42 
ngx_h‰p_‹rmš©e_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
);

43 
ngx_h‰p_‹rmš©e_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

44 
ngx_h‰p_fš®ize_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
);

45 
ngx_št_t
 
ngx_h‰p_£t_wr™e_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

46 
ngx_h‰p_wr™”
(
ngx_h‰p_»que¡_t
 *
r
);

47 
ngx_h‰p_»que¡_fš®iz”
(
ngx_h‰p_»que¡_t
 *
r
);

49 
ngx_h‰p_£t_k“·live
(
ngx_h‰p_»que¡_t
 *
r
);

50 
ngx_h‰p_k“·live_hªdËr
(
ngx_ev’t_t
 *
ev
);

51 
ngx_h‰p_£t_lšg”šg_þo£
(
ngx_h‰p_»que¡_t
 *
r
);

52 
ngx_h‰p_lšg”šg_þo£_hªdËr
(
ngx_ev’t_t
 *
ev
);

53 
ngx_št_t
 
ngx_h‰p_po¡_aùiÚ
(
ngx_h‰p_»que¡_t
 *
r
);

54 
ngx_h‰p_þo£_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
”rÜ
);

55 
ngx_h‰p_log_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

57 
u_ch¬
 *
ngx_h‰p_log_”rÜ
(
ngx_log_t
 *
log
, u_ch¬ *
buf
, 
size_t
 
Ën
);

58 
u_ch¬
 *
ngx_h‰p_log_”rÜ_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

59 
ngx_h‰p_»que¡_t
 *
¤
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
);

61 #ià(
NGX_HTTP_SSL
)

62 
ngx_h‰p_s¦_hªdshake
(
ngx_ev’t_t
 *
»v
);

63 
ngx_h‰p_s¦_hªdshake_hªdËr
(
ngx_cÚÃùiÚ_t
 *
c
);

67 *
	gngx_h‰p_þ›Á_”rÜs
[] = {

80 
ngx_h‰p_h—d”_t
 
	gngx_h‰p_h—d”s_š
[] = {

81 { 
ngx_¡ršg
("Ho¡"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
ho¡
),

82 
ngx_h‰p_´oûss_ho¡
 },

84 { 
ngx_¡ršg
("CÚÃùiÚ"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
cÚÃùiÚ
),

85 
ngx_h‰p_´oûss_cÚÃùiÚ
 },

87 { 
ngx_¡ršg
("If-Modified-Since"),

88 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
if_modif›d_sšû
),

89 
ngx_h‰p_´oûss_unique_h—d”_lše
 },

91 { 
ngx_¡ršg
("If-Unmodified-Since"),

92 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
if_unmodif›d_sšû
),

93 
ngx_h‰p_´oûss_unique_h—d”_lše
 },

95 { 
ngx_¡ršg
("If-Match"),

96 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
if_m©ch
),

97 
ngx_h‰p_´oûss_unique_h—d”_lše
 },

99 { 
ngx_¡ršg
("If-None-Match"),

100 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
if_nÚe_m©ch
),

101 
ngx_h‰p_´oûss_unique_h—d”_lše
 },

103 { 
ngx_¡ršg
("U£r-Ag’t"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
u£r_ag’t
),

104 
ngx_h‰p_´oûss_u£r_ag’t
 },

106 { 
ngx_¡ršg
("Reã»r"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
»ã»r
),

107 
ngx_h‰p_´oûss_h—d”_lše
 },

109 { 
ngx_¡ršg
("Content-Length"),

110 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
cÚ‹Á_Ëngth
),

111 
ngx_h‰p_´oûss_unique_h—d”_lše
 },

113 { 
ngx_¡ršg
("Content-Type"),

114 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
cÚ‹Á_ty³
),

115 
ngx_h‰p_´oûss_h—d”_lše
 },

117 { 
ngx_¡ršg
("Rªge"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
¿nge
),

118 
ngx_h‰p_´oûss_h—d”_lše
 },

120 { 
ngx_¡ršg
("If-Range"),

121 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
if_¿nge
),

122 
ngx_h‰p_´oûss_unique_h—d”_lše
 },

124 { 
ngx_¡ršg
("Transfer-Encoding"),

125 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
Œªsãr_’codšg
),

126 
ngx_h‰p_´oûss_h—d”_lše
 },

128 { 
ngx_¡ršg
("Expect"),

129 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
ex³ù
),

130 
ngx_h‰p_´oûss_unique_h—d”_lše
 },

132 { 
ngx_¡ršg
("Upgrade"),

133 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
upg¿de
),

134 
ngx_h‰p_´oûss_h—d”_lše
 },

136 #ià(
NGX_HTTP_GZIP
)

137 { 
ngx_¡ršg
("Accept-Encoding"),

138 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
acû±_’codšg
),

139 
ngx_h‰p_´oûss_h—d”_lše
 },

141 { 
ngx_¡ršg
("VŸ"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
vŸ
),

142 
ngx_h‰p_´oûss_h—d”_lše
 },

145 { 
ngx_¡ršg
("Authorization"),

146 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
authÜiz©iÚ
),

147 
ngx_h‰p_´oûss_unique_h—d”_lše
 },

149 { 
ngx_¡ršg
("K“p-Alive"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
k“p_®ive
),

150 
ngx_h‰p_´oûss_h—d”_lše
 },

152 #ià(
NGX_HTTP_X_FORWARDED_FOR
)

153 { 
ngx_¡ršg
("X-Forwarded-For"),

154 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
x_fÜw¬ded_fÜ
),

155 
ngx_h‰p_´oûss_muÉi_h—d”_lšes
 },

158 #ià(
NGX_HTTP_REALIP
)

159 { 
ngx_¡ršg
("X-Real-IP"),

160 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
x_»®_
),

161 
ngx_h‰p_´oûss_h—d”_lše
 },

164 #ià(
NGX_HTTP_HEADERS
)

165 { 
ngx_¡ršg
("Acû±"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
acû±
),

166 
ngx_h‰p_´oûss_h—d”_lše
 },

168 { 
ngx_¡ršg
("Accept-Language"),

169 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
acû±_Ïnguage
),

170 
ngx_h‰p_´oûss_h—d”_lše
 },

173 #ià(
NGX_HTTP_DAV
)

174 { 
ngx_¡ršg
("D•th"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
d•th
),

175 
ngx_h‰p_´oûss_h—d”_lše
 },

177 { 
ngx_¡ršg
("De¡š©iÚ"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
de¡š©iÚ
),

178 
ngx_h‰p_´oûss_h—d”_lše
 },

180 { 
ngx_¡ršg
("Ov”wr™e"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
ov”wr™e
),

181 
ngx_h‰p_´oûss_h—d”_lše
 },

183 { 
ngx_¡ršg
("D©e"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
d©e
),

184 
ngx_h‰p_´oûss_h—d”_lše
 },

187 { 
ngx_¡ršg
("Cook›"), 
off£tof
(
ngx_h‰p_h—d”s_š_t
, 
cook›s
),

188 
ngx_h‰p_´oûss_muÉi_h—d”_lšes
 },

190 { 
ngx_nuÎ_¡ršg
, 0, 
NULL
 }

195 
	$ngx_h‰p_š™_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

197 
ngx_ušt_t
 
i
;

198 
ngx_ev’t_t
 *
»v
;

199 
sockaddr_š
 *
sš
;

200 
ngx_h‰p_pÜt_t
 *
pÜt
;

201 
ngx_h‰p_š_addr_t
 *
addr
;

202 
ngx_h‰p_log_ùx_t
 *
ùx
;

203 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

204 #ià(
NGX_HAVE_INET6
)

205 
sockaddr_š6
 *
sš6
;

206 
ngx_h‰p_š6_addr_t
 *
addr6
;

209 
hc
 = 
	`ngx_pÿÎoc
(
c
->
poÞ
, (
ngx_h‰p_cÚÃùiÚ_t
));

210 ià(
hc
 =ð
NULL
) {

211 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

215 
c
->
d©a
 = 
hc
;

219 
pÜt
 = 
c
->
li¡’šg
->
£rv”s
;

221 ià(
pÜt
->
Çddrs
 > 1) {

229 ià(
	`ngx_cÚÃùiÚ_loÿl_sockaddr
(
c
, 
NULL
, 0è!ð
NGX_OK
) {

230 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

234 
c
->
loÿl_sockaddr
->
§_çmžy
) {

236 #ià(
NGX_HAVE_INET6
)

237 
AF_INET6
:

238 
sš6
 = (
sockaddr_š6
 *è
c
->
loÿl_sockaddr
;

240 
addr6
 = 
pÜt
->
addrs
;

244 
i
 = 0; i < 
pÜt
->
Çddrs
 - 1; i++) {

245 ià(
	`ngx_memcmp
(&
addr6
[
i
].addr6, &
sš6
->
sš6_addr
, 16) == 0) {

250 
hc
->
addr_cÚf
 = &
addr6
[
i
].
cÚf
;

256 
sš
 = (
sockaddr_š
 *è
c
->
loÿl_sockaddr
;

258 
addr
 = 
pÜt
->
addrs
;

262 
i
 = 0; i < 
pÜt
->
Çddrs
 - 1; i++) {

263 ià(
addr
[
i
].add¸=ð
sš
->
sš_addr
.
s_addr
) {

268 
hc
->
addr_cÚf
 = &
addr
[
i
].
cÚf
;

275 
c
->
loÿl_sockaddr
->
§_çmžy
) {

277 #ià(
NGX_HAVE_INET6
)

278 
AF_INET6
:

279 
addr6
 = 
pÜt
->
addrs
;

280 
hc
->
addr_cÚf
 = &
addr6
[0].
cÚf
;

285 
addr
 = 
pÜt
->
addrs
;

286 
hc
->
addr_cÚf
 = &
addr
[0].
cÚf
;

292 
hc
->
cÚf_ùx
 = hc->
addr_cÚf
->
deçuÉ_£rv”
->
ùx
;

294 
ùx
 = 
	`ngx_·Îoc
(
c
->
poÞ
, (
ngx_h‰p_log_ùx_t
));

295 ià(
ùx
 =ð
NULL
) {

296 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

300 
ùx
->
cÚÃùiÚ
 = 
c
;

301 
ùx
->
»que¡
 = 
NULL
;

302 
ùx
->
cu¼’t_»que¡
 = 
NULL
;

304 
c
->
log
->
cÚÃùiÚ
 = c->
numb”
;

305 
c
->
log
->
hªdËr
 = 
ngx_h‰p_log_”rÜ
;

306 
c
->
log
->
d©a
 = 
ùx
;

307 
c
->
log
->
aùiÚ
 = "waiting for„equest";

309 
c
->
log_”rÜ
 = 
NGX_ERROR_INFO
;

311 
»v
 = 
c
->
»ad
;

312 
»v
->
hªdËr
 = 
ngx_h‰p_wa™_»que¡_hªdËr
;

313 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_em±y_hªdËr
;

315 #ià(
NGX_HTTP_SPDY
)

316 ià(
hc
->
addr_cÚf
->
¥dy
) {

317 
»v
->
hªdËr
 = 
ngx_h‰p_¥dy_š™
;

321 #ià(
NGX_HTTP_SSL
)

323 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
;

325 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
hc
->
cÚf_ùx
, 
ngx_h‰p_s¦_moduË
);

327 ià(
sscf
->
’abË
 || 
hc
->
addr_cÚf
->
s¦
) {

329 
c
->
log
->
aùiÚ
 = "SSL handshaking";

331 ià(
hc
->
addr_cÚf
->
s¦
 && 
sscf
->s¦.
ùx
 =ð
NULL
) {

332 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

335 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

339 
hc
->
s¦
 = 1;

341 
»v
->
hªdËr
 = 
ngx_h‰p_s¦_hªdshake
;

346 ià(
hc
->
addr_cÚf
->
´oxy_´ÙocÞ
) {

347 
hc
->
´oxy_´ÙocÞ
 = 1;

348 
c
->
log
->
aùiÚ
 = "reading PROXY…rotocol";

351 ià(
»v
->
»ady
) {

354 ià(
ngx_u£_acû±_mu‹x
) {

355 
	`ngx_po¡_ev’t
(
»v
, &
ngx_po¡ed_ev’ts
);

359 
»v
->
	`hªdËr
(rev);

363 
	`ngx_add_tim”
(
»v
, 
c
->
li¡’šg
->
po¡_acû±_timeout
);

364 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 1);

366 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

367 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

370 
	}
}

374 
	$ngx_h‰p_wa™_»que¡_hªdËr
(
ngx_ev’t_t
 *
»v
)

376 
u_ch¬
 *
p
;

377 
size_t
 
size
;

378 
ssize_t
 
n
;

379 
ngx_buf_t
 *
b
;

380 
ngx_cÚÃùiÚ_t
 *
c
;

381 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

382 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

384 
c
 = 
»v
->
d©a
;

386 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "http wait„equest handler");

388 ià(
»v
->
timedout
) {

389 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

390 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

394 ià(
c
->
þo£
) {

395 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

399 
hc
 = 
c
->
d©a
;

400 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
hc
->
cÚf_ùx
, 
ngx_h‰p_cÜe_moduË
);

402 
size
 = 
cscf
->
þ›Á_h—d”_bufãr_size
;

404 
b
 = 
c
->
bufãr
;

406 ià(
b
 =ð
NULL
) {

407 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
c
->
poÞ
, 
size
);

408 ià(
b
 =ð
NULL
) {

409 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

413 
c
->
bufãr
 = 
b
;

415 } ià(
b
->
¡¬t
 =ð
NULL
) {

417 
b
->
¡¬t
 = 
	`ngx_·Îoc
(
c
->
poÞ
, 
size
);

418 ià(
b
->
¡¬t
 =ð
NULL
) {

419 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

423 
b
->
pos
 = b->
¡¬t
;

424 
b
->
Ï¡
 = b->
¡¬t
;

425 
b
->
’d
 = b->
Ï¡
 + 
size
;

428 
n
 = 
c
->
	`»cv
(c, 
b
->
Ï¡
, 
size
);

430 ià(
n
 =ð
NGX_AGAIN
) {

432 ià(!
»v
->
tim”_£t
) {

433 
	`ngx_add_tim”
(
»v
, 
c
->
li¡’šg
->
po¡_acû±_timeout
);

434 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 1);

437 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

438 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

446 ià(
	`ngx_pä“
(
c
->
poÞ
, 
b
->
¡¬t
è=ð
NGX_OK
) {

447 
b
->
¡¬t
 = 
NULL
;

453 ià(
n
 =ð
NGX_ERROR
) {

454 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

458 ià(
n
 == 0) {

459 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

461 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

465 
b
->
Ï¡
 +ð
n
;

467 ià(
hc
->
´oxy_´ÙocÞ
) {

468 
hc
->
´oxy_´ÙocÞ
 = 0;

470 
p
 = 
	`ngx_´oxy_´ÙocÞ_·r£
(
c
, 
b
->
pos
, b->
Ï¡
);

472 ià(
p
 =ð
NULL
) {

473 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

477 
b
->
pos
 = 
p
;

479 ià(
b
->
pos
 =ðb->
Ï¡
) {

480 
c
->
log
->
aùiÚ
 = "waiting for„equest";

481 
b
->
pos
 = b->
¡¬t
;

482 
b
->
Ï¡
 = b->
¡¬t
;

483 
	`ngx_po¡_ev’t
(
»v
, &
ngx_po¡ed_ev’ts
);

488 
c
->
log
->
aùiÚ
 = "reading client„equest†ine";

490 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 0);

492 
c
->
d©a
 = 
	`ngx_h‰p_ü—‹_»que¡
(c);

493 ià(
c
->
d©a
 =ð
NULL
) {

494 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

498 
»v
->
hªdËr
 = 
ngx_h‰p_´oûss_»que¡_lše
;

499 
	`ngx_h‰p_´oûss_»que¡_lše
(
»v
);

500 
	}
}

503 
ngx_h‰p_»que¡_t
 *

504 
	$ngx_h‰p_ü—‹_»que¡
(
ngx_cÚÃùiÚ_t
 *
c
)

506 
ngx_poÞ_t
 *
poÞ
;

507 
ngx_time_t
 *

;

508 
ngx_h‰p_»que¡_t
 *
r
;

509 
ngx_h‰p_log_ùx_t
 *
ùx
;

510 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

511 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

512 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

513 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

515 
c
->
»que¡s
++;

517 
hc
 = 
c
->
d©a
;

519 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
hc
->
cÚf_ùx
, 
ngx_h‰p_cÜe_moduË
);

521 
poÞ
 = 
	`ngx_ü—‹_poÞ
(
cscf
->
»que¡_poÞ_size
, 
c
->
log
);

522 ià(
poÞ
 =ð
NULL
) {

523  
NULL
;

526 
r
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_h‰p_»que¡_t
));

527 ià(
r
 =ð
NULL
) {

528 
	`ngx_de¡roy_poÞ
(
poÞ
);

529  
NULL
;

532 
r
->
poÞ
 =…ool;

534 
r
->
h‰p_cÚÃùiÚ
 = 
hc
;

535 
r
->
sigÇtu»
 = 
NGX_HTTP_MODULE
;

536 
r
->
cÚÃùiÚ
 = 
c
;

538 
r
->
maš_cÚf
 = 
hc
->
cÚf_ùx
->main_conf;

539 
r
->
¤v_cÚf
 = 
hc
->
cÚf_ùx
->srv_conf;

540 
r
->
loc_cÚf
 = 
hc
->
cÚf_ùx
->loc_conf;

542 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_block_»adšg
;

544 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

546 
	`ngx_h‰p_£t_cÚÃùiÚ_log
(
r
->
cÚÃùiÚ
, 
þcf
->
”rÜ_log
);

548 
r
->
h—d”_š
 = 
hc
->
nbusy
 ? hc->
busy
[0] : 
c
->
bufãr
;

550 ià(
	`ngx_li¡_š™
(&
r
->
h—d”s_out
.
h—d”s
,„->
poÞ
, 20,

551 (
ngx_bË_–t_t
))

552 !ð
NGX_OK
)

554 
	`ngx_de¡roy_poÞ
(
r
->
poÞ
);

555  
NULL
;

558 
r
->
ùx
 = 
	`ngx_pÿÎoc
Ô->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

559 ià(
r
->
ùx
 =ð
NULL
) {

560 
	`ngx_de¡roy_poÞ
(
r
->
poÞ
);

561  
NULL
;

564 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

566 
r
->
v¬ŸbËs
 = 
	`ngx_pÿÎoc
Ô->
poÞ
, 
cmcf
->v¬ŸbËs.
ÃÉs


567 * (
ngx_h‰p_v¬ŸbË_v®ue_t
));

568 ià(
r
->
v¬ŸbËs
 =ð
NULL
) {

569 
	`ngx_de¡roy_poÞ
(
r
->
poÞ
);

570  
NULL
;

573 #ià(
NGX_HTTP_SSL
)

574 ià(
c
->
s¦
) {

575 
r
->
maš_fž‹r_Ãed_š_memÜy
 = 1;

579 
r
->
maš
 =„;

580 
r
->
couÁ
 = 1;

582 

 = 
	`ngx_timeofday
();

583 
r
->
¡¬t_£c
 = 

->
£c
;

584 
r
->
¡¬t_m£c
 = 

->
m£c
;

586 
r
->
m‘hod
 = 
NGX_HTTP_UNKNOWN
;

587 
r
->
h‰p_v”siÚ
 = 
NGX_HTTP_VERSION_10
;

589 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = -1;

590 
r
->
h—d”s_š
.
k“p_®ive_n
 = -1;

591 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = -1;

592 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = -1;

594 
r
->
uri_chªges
 = 
NGX_HTTP_MAX_URI_CHANGES
 + 1;

595 
r
->
sub»que¡s
 = 
NGX_HTTP_MAX_SUBREQUESTS
 + 1;

597 
r
->
h‰p_¡©e
 = 
NGX_HTTP_READING_REQUEST_STATE
;

599 
ùx
 = 
c
->
log
->
d©a
;

600 
ùx
->
»que¡
 = 
r
;

601 
ùx
->
cu¼’t_»que¡
 = 
r
;

602 
r
->
log_hªdËr
 = 
ngx_h‰p_log_”rÜ_hªdËr
;

604 #ià(
NGX_STAT_STUB
)

605 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_»adšg
, 1);

606 
r
->
¡©_»adšg
 = 1;

607 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_»que¡s
, 1);

610  
r
;

611 
	}
}

614 #ià(
NGX_HTTP_SSL
)

617 
	$ngx_h‰p_s¦_hªdshake
(
ngx_ev’t_t
 *
»v
)

619 
u_ch¬
 *
p
, 
buf
[
NGX_PROXY_PROTOCOL_MAX_HEADER
 + 1];

620 
size_t
 
size
;

621 
ssize_t
 
n
;

622 
ngx_”r_t
 
”r
;

623 
ngx_št_t
 
rc
;

624 
ngx_cÚÃùiÚ_t
 *
c
;

625 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

626 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
;

628 
c
 = 
»v
->
d©a
;

629 
hc
 = 
c
->
d©a
;

631 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
»v
->
log
, 0,

634 ià(
»v
->
timedout
) {

635 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

636 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

640 ià(
c
->
þo£
) {

641 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

645 
size
 = 
hc
->
´oxy_´ÙocÞ
 ? (
buf
) : 1;

647 
n
 = 
	`»cv
(
c
->
fd
, (*è
buf
, 
size
, 
MSG_PEEK
);

649 
”r
 = 
ngx_sock‘_”ºo
;

651 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
»v
->
log
, 0, "h‰°»cv(): %d", 
n
);

653 ià(
n
 == -1) {

654 ià(
”r
 =ð
NGX_EAGAIN
) {

656 ià(!
»v
->
tim”_£t
) {

657 
	`ngx_add_tim”
(
»v
, 
c
->
li¡’šg
->
po¡_acû±_timeout
);

658 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 1);

661 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

662 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

668 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "recv() failed");

669 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

674 ià(
hc
->
´oxy_´ÙocÞ
) {

675 
hc
->
´oxy_´ÙocÞ
 = 0;

677 
p
 = 
	`ngx_´oxy_´ÙocÞ_·r£
(
c
, 
buf
, buà+ 
n
);

679 ià(
p
 =ð
NULL
) {

680 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

684 
size
 = 
p
 - 
buf
;

686 ià(
c
->
	`»cv
(c, 
buf
, 
size
è!ð(
ssize_t
) size) {

687 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

691 
c
->
log
->
aùiÚ
 = "SSL handshaking";

693 ià(
n
 =ð(
ssize_t
è
size
) {

694 
	`ngx_po¡_ev’t
(
»v
, &
ngx_po¡ed_ev’ts
);

698 
n
 = 1;

699 
buf
[0] = *
p
;

702 ià(
n
 == 1) {

703 ià(
buf
[0] & 0x80 || buf[0] == 0x16 ) {

704 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
»v
->
log
, 0,

705 "h‰p s¦ hªdshake: 0x%02Xd", 
buf
[0]);

707 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
hc
->
cÚf_ùx
,

708 
ngx_h‰p_s¦_moduË
);

710 ià(
	`ngx_s¦_ü—‹_cÚÃùiÚ
(&
sscf
->
s¦
, 
c
, 
NGX_SSL_BUFFER
)

711 !ð
NGX_OK
)

713 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

717 
rc
 = 
	`ngx_s¦_hªdshake
(
c
);

719 ià(
rc
 =ð
NGX_AGAIN
) {

721 ià(!
»v
->
tim”_£t
) {

722 
	`ngx_add_tim”
(
»v
, 
c
->
li¡’šg
->
po¡_acû±_timeout
);

725 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 0);

727 
c
->
s¦
->
hªdËr
 = 
ngx_h‰p_s¦_hªdshake_hªdËr
;

731 
	`ngx_h‰p_s¦_hªdshake_hªdËr
(
c
);

736 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
»v
->
log
, 0, "plain http");

738 
c
->
log
->
aùiÚ
 = "waiting for„equest";

740 
»v
->
hªdËr
 = 
ngx_h‰p_wa™_»que¡_hªdËr
;

741 
	`ngx_h‰p_wa™_»que¡_hªdËr
(
»v
);

746 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "client closed connection");

747 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

748 
	}
}

752 
	$ngx_h‰p_s¦_hªdshake_hªdËr
(
ngx_cÚÃùiÚ_t
 *
c
)

754 ià(
c
->
s¦
->
hªdshaked
) {

764 
c
->
s¦
->
no_wa™_shutdown
 = 1;

766 #ià(
NGX_HTTP_SPDY
 \

767 && (
defšed
 
TLSEXT_TYPE_­¶iÿtiÚ_Ïy”_´ÙocÞ_ÃgÙŸtiÚ
 \

768 || 
defšed
 
TLSEXT_TYPE_Ãxt_´Ùo_Ãg
))

770 
Ën
;

771 cÚ¡ *
d©a
;

772 cÚ¡ 
ngx_¡r_t
 
¥dy
 = 
	`ngx_¡ršg
(
NGX_SPDY_NPN_NEGOTIATED
);

774 #ifdeà
TLSEXT_TYPE_­¶iÿtiÚ_Ïy”_´ÙocÞ_ÃgÙŸtiÚ


775 
	`SSL_g‘0_®²_£Ëùed
(
c
->
s¦
->
cÚÃùiÚ
, &
d©a
, &
Ën
);

777 #ifdeà
TLSEXT_TYPE_Ãxt_´Ùo_Ãg


778 ià(
Ën
 == 0) {

779 
	`SSL_g‘0_Ãxt_´Ùo_ÃgÙŸ‹d
(
c
->
s¦
->
cÚÃùiÚ
, &
d©a
, &
Ën
);

784 
	`SSL_g‘0_Ãxt_´Ùo_ÃgÙŸ‹d
(
c
->
s¦
->
cÚÃùiÚ
, &
d©a
, &
Ën
);

787 ià(
Ën
 =ð
¥dy
.ËÀ&& 
	`ngx_¡ºcmp
(
d©a
, spdy.data, spdy.len) == 0) {

788 
	`ngx_h‰p_¥dy_š™
(
c
->
»ad
);

794 
c
->
log
->
aùiÚ
 = "waiting for„equest";

796 
c
->
»ad
->
hªdËr
 = 
ngx_h‰p_wa™_»que¡_hªdËr
;

797  
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_em±y_hªdËr
;

799 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 1);

801 
	`ngx_h‰p_wa™_»que¡_hªdËr
(
c
->
»ad
);

806 ià(
c
->
»ad
->
timedout
) {

807 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

810 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

811 
	}
}

813 #ifdeà
SSL_CTRL_SET_TLSEXT_HOSTNAME


816 
	$ngx_h‰p_s¦_£rv”Çme
(
ngx_s¦_cÚn_t
 *
s¦_cÚn
, *
ad
, *
¬g
)

818 
ngx_¡r_t
 
ho¡
;

819 cÚ¡ *
£rv”Çme
;

820 
ngx_cÚÃùiÚ_t
 *
c
;

821 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

822 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
;

823 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

824 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

826 
£rv”Çme
 = 
	`SSL_g‘_£rv”Çme
(
s¦_cÚn
, 
TLSEXT_NAMETYPE_ho¡_Çme
);

828 ià(
£rv”Çme
 =ð
NULL
) {

829  
SSL_TLSEXT_ERR_NOACK
;

832 
c
 = 
	`ngx_s¦_g‘_cÚÃùiÚ
(
s¦_cÚn
);

834 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

835 "SSL s”v”‚ame: \"%s\"", 
£rv”Çme
);

837 
ho¡
.
Ën
 = 
	`ngx_¡¾’
(
£rv”Çme
);

839 ià(
ho¡
.
Ën
 == 0) {

840  
SSL_TLSEXT_ERR_NOACK
;

843 
ho¡
.
d©a
 = (
u_ch¬
 *è
£rv”Çme
;

845 ià(
	`ngx_h‰p_v®id©e_ho¡
(&
ho¡
, 
c
->
poÞ
, 1è!ð
NGX_OK
) {

846  
SSL_TLSEXT_ERR_NOACK
;

849 
hc
 = 
c
->
d©a
;

851 ià(
	`ngx_h‰p_fšd_vœtu®_£rv”
(
c
, 
hc
->
addr_cÚf
->
vœtu®_Çmes
, &
ho¡
,

852 
NULL
, &
cscf
)

853 !ð
NGX_OK
)

855  
SSL_TLSEXT_ERR_NOACK
;

858 
hc
->
s¦_£rv”Çme
 = 
	`ngx_·Îoc
(
c
->
poÞ
, (
ngx_¡r_t
));

859 ià(
hc
->
s¦_£rv”Çme
 =ð
NULL
) {

860  
SSL_TLSEXT_ERR_NOACK
;

863 *
hc
->
s¦_£rv”Çme
 = 
ho¡
;

865 
hc
->
cÚf_ùx
 = 
cscf
->
ùx
;

867 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
hc
->
cÚf_ùx
, 
ngx_h‰p_cÜe_moduË
);

869 
	`ngx_h‰p_£t_cÚÃùiÚ_log
(
c
, 
þcf
->
”rÜ_log
);

871 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
hc
->
cÚf_ùx
, 
ngx_h‰p_s¦_moduË
);

873 ià(
sscf
->
s¦
.
ùx
) {

874 
	`SSL_£t_SSL_CTX
(
s¦_cÚn
, 
sscf
->
s¦
.
ùx
);

881 
	`SSL_£t_v”ify
(
s¦_cÚn
, 
	`SSL_CTX_g‘_v”ify_mode
(
sscf
->
s¦
.
ùx
),

882 
	`SSL_CTX_g‘_v”ify_ÿÎback
(
sscf
->
s¦
.
ùx
));

884 
	`SSL_£t_v”ify_d•th
(
s¦_cÚn
, 
	`SSL_CTX_g‘_v”ify_d•th
(
sscf
->
s¦
.
ùx
));

886 #ifdeà
SSL_CTRL_CLEAR_OPTIONS


888 
	`SSL_þ—r_ÝtiÚs
(
s¦_cÚn
, 
	`SSL_g‘_ÝtiÚs
(ssl_conn) &

889 ~
	`SSL_CTX_g‘_ÝtiÚs
(
sscf
->
s¦
.
ùx
));

892 
	`SSL_£t_ÝtiÚs
(
s¦_cÚn
, 
	`SSL_CTX_g‘_ÝtiÚs
(
sscf
->
s¦
.
ùx
));

895  
SSL_TLSEXT_ERR_OK
;

896 
	}
}

904 
	$ngx_h‰p_´oûss_»que¡_lše
(
ngx_ev’t_t
 *
»v
)

906 
ssize_t
 
n
;

907 
ngx_št_t
 
rc
, 
rv
;

908 
ngx_¡r_t
 
ho¡
;

909 
ngx_cÚÃùiÚ_t
 *
c
;

910 
ngx_h‰p_»que¡_t
 *
r
;

912 
c
 = 
»v
->
d©a
;

913 
r
 = 
c
->
d©a
;

915 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
»v
->
log
, 0,

918 ià(
»v
->
timedout
) {

919 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

920 
c
->
timedout
 = 1;

921 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_REQUEST_TIME_OUT
);

925 
rc
 = 
NGX_AGAIN
;

929 ià(
rc
 =ð
NGX_AGAIN
) {

930 
n
 = 
	`ngx_h‰p_»ad_»que¡_h—d”
(
r
);

932 ià(
n
 =ð
NGX_AGAIN
 ||‚ =ð
NGX_ERROR
) {

937 
rc
 = 
	`ngx_h‰p_·r£_»que¡_lše
(
r
,„->
h—d”_š
);

939 ià(
rc
 =ð
NGX_OK
) {

943 
r
->
»que¡_lše
.
Ën
 =„->
»que¡_’d
 -„->
»que¡_¡¬t
;

944 
r
->
»que¡_lše
.
d©a
 =„->
»que¡_¡¬t
;

945 
r
->
»que¡_Ëngth
 =„->
h—d”_š
->
pos
 -„->
»que¡_¡¬t
;

947 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

948 "h‰°»que¡†še: \"%V\"", &
r
->
»que¡_lše
);

950 
r
->
m‘hod_Çme
.
Ën
 =„->
m‘hod_’d
 -„->
»que¡_¡¬t
 + 1;

951 
r
->
m‘hod_Çme
.
d©a
 =„->
»que¡_lše
.data;

953 ià(
r
->
h‰p_´ÙocÞ
.
d©a
) {

954 
r
->
h‰p_´ÙocÞ
.
Ën
 =„->
»que¡_’d
 -„->h‰p_´ÙocÞ.
d©a
;

957 ià(
	`ngx_h‰p_´oûss_»que¡_uri
(
r
è!ð
NGX_OK
) {

961 ià(
r
->
ho¡_¡¬t
 &&„->
ho¡_’d
) {

963 
ho¡
.
Ën
 = 
r
->
ho¡_’d
 -„->
ho¡_¡¬t
;

964 
ho¡
.
d©a
 = 
r
->
ho¡_¡¬t
;

966 
rc
 = 
	`ngx_h‰p_v®id©e_ho¡
(&
ho¡
, 
r
->
poÞ
, 0);

968 ià(
rc
 =ð
NGX_DECLINED
) {

969 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

971 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

975 ià(
rc
 =ð
NGX_ERROR
) {

976 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

980 ià(
	`ngx_h‰p_£t_vœtu®_£rv”
(
r
, &
ho¡
è=ð
NGX_ERROR
) {

984 
r
->
h—d”s_š
.
£rv”
 = 
ho¡
;

987 ià(
r
->
h‰p_v”siÚ
 < 
NGX_HTTP_VERSION_10
) {

989 ià(
r
->
h—d”s_š
.
£rv”
.
Ën
 == 0

990 && 
	`ngx_h‰p_£t_vœtu®_£rv”
(
r
, &r->
h—d”s_š
.
£rv”
)

991 =ð
NGX_ERROR
)

996 
	`ngx_h‰p_´oûss_»que¡
(
r
);

1001 ià(
	`ngx_li¡_š™
(&
r
->
h—d”s_š
.
h—d”s
,„->
poÞ
, 20,

1002 (
ngx_bË_–t_t
))

1003 !ð
NGX_OK
)

1005 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1009 
c
->
log
->
aùiÚ
 = "reading client„equest headers";

1011 
»v
->
hªdËr
 = 
ngx_h‰p_´oûss_»que¡_h—d”s
;

1012 
	`ngx_h‰p_´oûss_»que¡_h—d”s
(
»v
);

1017 ià(
rc
 !ð
NGX_AGAIN
) {

1021 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1022 
ngx_h‰p_þ›Á_”rÜs
[
rc
 - 
NGX_HTTP_CLIENT_ERROR
]);

1023 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1029 ià(
r
->
h—d”_š
->
pos
 =ðr->h—d”_š->
’d
) {

1031 
rv
 = 
	`ngx_h‰p_®loc_Ïrge_h—d”_bufãr
(
r
, 1);

1033 ià(
rv
 =ð
NGX_ERROR
) {

1034 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1038 ià(
rv
 =ð
NGX_DECLINED
) {

1039 
r
->
»que¡_lše
.
Ën
 =„->
h—d”_š
->
’d
 -„->
»que¡_¡¬t
;

1040 
r
->
»que¡_lše
.
d©a
 =„->
»que¡_¡¬t
;

1042 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1044 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_REQUEST_URI_TOO_LARGE
);

1049 
	}
}

1052 
ngx_št_t


1053 
	$ngx_h‰p_´oûss_»que¡_uri
(
ngx_h‰p_»que¡_t
 *
r
)

1055 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

1057 ià(
r
->
¬gs_¡¬t
) {

1058 
r
->
uri
.
Ën
 =„->
¬gs_¡¬t
 - 1 -„->
uri_¡¬t
;

1060 
r
->
uri
.
Ën
 =„->
uri_’d
 -„->
uri_¡¬t
;

1063 ià(
r
->
com¶ex_uri
 ||„->
quÙed_uri
) {

1065 
r
->
uri
.
d©a
 = 
	`ngx_²®loc
Ô->
poÞ
,„->uri.
Ën
 + 1);

1066 ià(
r
->
uri
.
d©a
 =ð
NULL
) {

1067 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1068  
NGX_ERROR
;

1071 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1073 ià(
	`ngx_h‰p_·r£_com¶ex_uri
(
r
, 
cscf
->
m”ge_¦ashes
è!ð
NGX_OK
) {

1074 
r
->
uri
.
Ën
 = 0;

1076 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1078 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1079  
NGX_ERROR
;

1083 
r
->
uri
.
d©a
 =„->
uri_¡¬t
;

1086 
r
->
uÅ¬£d_uri
.
Ën
 =„->
uri_’d
 -„->
uri_¡¬t
;

1087 
r
->
uÅ¬£d_uri
.
d©a
 =„->
uri_¡¬t
;

1089 
r
->
v®id_uÅ¬£d_uri
 =„->
¥aû_š_uri
 ? 0 : 1;

1091 ià(
r
->
uri_ext
) {

1092 ià(
r
->
¬gs_¡¬t
) {

1093 
r
->
ex‹n
.
Ën
 =„->
¬gs_¡¬t
 - 1 -„->
uri_ext
;

1095 
r
->
ex‹n
.
Ën
 =„->
uri_’d
 -„->
uri_ext
;

1098 
r
->
ex‹n
.
d©a
 =„->
uri_ext
;

1101 ià(
r
->
¬gs_¡¬t
 &&„->
uri_’d
 >„->args_start) {

1102 
r
->
¬gs
.
Ën
 =„->
uri_’d
 -„->
¬gs_¡¬t
;

1103 
r
->
¬gs
.
d©a
 =„->
¬gs_¡¬t
;

1106 #ià(
NGX_WIN32
)

1108 
u_ch¬
 *
p
, *
Ï¡
;

1110 
p
 = 
r
->
uri
.
d©a
;

1111 
Ï¡
 = 
r
->
uri
.
d©a
 +„->uri.
Ën
;

1113 
p
 < 
Ï¡
) {

1115 ià(*
p
++ == ':') {

1122 ià(
p
 < 
Ï¡
 && *p == '$') {

1123 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1125 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1126  
NGX_ERROR
;

1131 
p
 = 
r
->
uri
.
d©a
 +„->uri.
Ën
 - 1;

1133 
p
 > 
r
->
uri
.
d©a
) {

1135 ià(*
p
 == ' ') {

1136 
p
--;

1140 ià(*
p
 == '.') {

1141 
p
--;

1148 ià(
p
 !ð
r
->
uri
.
d©a
 +„->uri.
Ën
 - 1) {

1149 
r
->
uri
.
Ën
 = 
p
 + 1 -„->uri.
d©a
;

1150 
	`ngx_h‰p_£t_ex‹n
(
r
);

1156 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1157 "h‰°uri: \"%V\"", &
r
->
uri
);

1159 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1160 "h‰°¬gs: \"%V\"", &
r
->
¬gs
);

1162 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1163 "h‰°ex‹n: \"%V\"", &
r
->
ex‹n
);

1165  
NGX_OK
;

1166 
	}
}

1170 
	$ngx_h‰p_´oûss_»que¡_h—d”s
(
ngx_ev’t_t
 *
»v
)

1172 
u_ch¬
 *
p
;

1173 
size_t
 
Ën
;

1174 
ssize_t
 
n
;

1175 
ngx_št_t
 
rc
, 
rv
;

1176 
ngx_bË_–t_t
 *
h
;

1177 
ngx_cÚÃùiÚ_t
 *
c
;

1178 
ngx_h‰p_h—d”_t
 *
hh
;

1179 
ngx_h‰p_»que¡_t
 *
r
;

1180 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

1181 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

1183 
c
 = 
»v
->
d©a
;

1184 
r
 = 
c
->
d©a
;

1186 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
»v
->
log
, 0,

1189 ià(
»v
->
timedout
) {

1190 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

1191 
c
->
timedout
 = 1;

1192 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_REQUEST_TIME_OUT
);

1196 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1198 
rc
 = 
NGX_AGAIN
;

1202 ià(
rc
 =ð
NGX_AGAIN
) {

1204 ià(
r
->
h—d”_š
->
pos
 =ðr->h—d”_š->
’d
) {

1206 
rv
 = 
	`ngx_h‰p_®loc_Ïrge_h—d”_bufãr
(
r
, 0);

1208 ià(
rv
 =ð
NGX_ERROR
) {

1209 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1213 ià(
rv
 =ð
NGX_DECLINED
) {

1214 
p
 = 
r
->
h—d”_Çme_¡¬t
;

1216 
r
->
lšg”šg_þo£
 = 1;

1218 ià(
p
 =ð
NULL
) {

1219 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1221 
	`ngx_h‰p_fš®ize_»que¡
(
r
,

1222 
NGX_HTTP_REQUEST_HEADER_TOO_LARGE
);

1226 
Ën
 = 
r
->
h—d”_š
->
’d
 - 
p
;

1228 ià(
Ën
 > 
NGX_MAX_ERROR_STR
 - 300) {

1229 
Ën
 = 
NGX_MAX_ERROR_STR
 - 300;

1232 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1234 
Ën
, 
r
->
h—d”_Çme_¡¬t
);

1236 
	`ngx_h‰p_fš®ize_»que¡
(
r
,

1237 
NGX_HTTP_REQUEST_HEADER_TOO_LARGE
);

1242 
n
 = 
	`ngx_h‰p_»ad_»que¡_h—d”
(
r
);

1244 ià(
n
 =ð
NGX_AGAIN
 ||‚ =ð
NGX_ERROR
) {

1250 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1252 
rc
 = 
	`ngx_h‰p_·r£_h—d”_lše
(
r
,„->
h—d”_š
,

1253 
cscf
->
und”scÜes_š_h—d”s
);

1255 ià(
rc
 =ð
NGX_OK
) {

1257 
r
->
»que¡_Ëngth
 +ðr->
h—d”_š
->
pos
 -„->
h—d”_Çme_¡¬t
;

1259 ià(
r
->
šv®id_h—d”
 && 
cscf
->
ignÜe_šv®id_h—d”s
) {

1263 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1265 
r
->
h—d”_’d
 -„->
h—d”_Çme_¡¬t
,

1266 
r
->
h—d”_Çme_¡¬t
);

1272 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_š
.
h—d”s
);

1273 ià(
h
 =ð
NULL
) {

1274 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1278 
h
->
hash
 = 
r
->
h—d”_hash
;

1280 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

1281 
h
->
key
.
d©a
 = 
r
->
h—d”_Çme_¡¬t
;

1282 
h
->
key
.
d©a
[h->key.
Ën
] = '\0';

1284 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

1285 
h
->
v®ue
.
d©a
 = 
r
->
h—d”_¡¬t
;

1286 
h
->
v®ue
.
d©a
[h->v®ue.
Ën
] = '\0';

1288 
h
->
lowÿ£_key
 = 
	`ngx_²®loc
(
r
->
poÞ
, h->
key
.
Ën
);

1289 ià(
h
->
lowÿ£_key
 =ð
NULL
) {

1290 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1294 ià(
h
->
key
.
Ën
 =ð
r
->
lowÿ£_šdex
) {

1295 
	`ngx_memýy
(
h
->
lowÿ£_key
, 
r
->
lowÿ£_h—d”
, h->
key
.
Ën
);

1298 
	`ngx_¡¾ow
(
h
->
lowÿ£_key
, h->
key
.
d©a
, h->key.
Ën
);

1301 
hh
 = 
	`ngx_hash_fšd
(&
cmcf
->
h—d”s_š_hash
, 
h
->
hash
,

1302 
h
->
lowÿ£_key
, h->
key
.
Ën
);

1304 ià(
hh
 && hh->
	`hªdËr
(
r
, 
h
, hh->
off£t
è!ð
NGX_OK
) {

1308 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1310 &
h
->
key
, &h->
v®ue
);

1315 ià(
rc
 =ð
NGX_HTTP_PARSE_HEADER_DONE
) {

1319 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1322 
r
->
»que¡_Ëngth
 +ðr->
h—d”_š
->
pos
 -„->
h—d”_Çme_¡¬t
;

1324 
r
->
h‰p_¡©e
 = 
NGX_HTTP_PROCESS_REQUEST_STATE
;

1326 
rc
 = 
	`ngx_h‰p_´oûss_»que¡_h—d”
(
r
);

1328 ià(
rc
 !ð
NGX_OK
) {

1332 
	`ngx_h‰p_´oûss_»que¡
(
r
);

1337 ià(
rc
 =ð
NGX_AGAIN
) {

1346 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1348 
r
->
h—d”_’d
 -„->
h—d”_Çme_¡¬t
,

1349 
r
->
h—d”_Çme_¡¬t
);

1350 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1353 
	}
}

1356 
ssize_t


1357 
	$ngx_h‰p_»ad_»que¡_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

1359 
ssize_t
 
n
;

1360 
ngx_ev’t_t
 *
»v
;

1361 
ngx_cÚÃùiÚ_t
 *
c
;

1362 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

1364 
c
 = 
r
->
cÚÃùiÚ
;

1365 
»v
 = 
c
->
»ad
;

1367 
n
 = 
r
->
h—d”_š
->
Ï¡
 -„->h—d”_š->
pos
;

1369 ià(
n
 > 0) {

1370  
n
;

1373 ià(
»v
->
»ady
) {

1374 
n
 = 
c
->
	`»cv
(c, 
r
->
h—d”_š
->
Ï¡
,

1375 
r
->
h—d”_š
->
’d
 -„->h—d”_š->
Ï¡
);

1377 
n
 = 
NGX_AGAIN
;

1380 ià(
n
 =ð
NGX_AGAIN
) {

1381 ià(!
»v
->
tim”_£t
) {

1382 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1383 
	`ngx_add_tim”
(
»v
, 
cscf
->
þ›Á_h—d”_timeout
);

1386 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

1387 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1388  
NGX_ERROR
;

1391  
NGX_AGAIN
;

1394 ià(
n
 == 0) {

1395 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1399 ià(
n
 =ð0 ||‚ =ð
NGX_ERROR
) {

1400 
c
->
”rÜ
 = 1;

1401 
c
->
log
->
aùiÚ
 = "reading client„equest headers";

1403 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1404  
NGX_ERROR
;

1407 
r
->
h—d”_š
->
Ï¡
 +ð
n
;

1409  
n
;

1410 
	}
}

1413 
ngx_št_t


1414 
	$ngx_h‰p_®loc_Ïrge_h—d”_bufãr
(
ngx_h‰p_»que¡_t
 *
r
,

1415 
ngx_ušt_t
 
»que¡_lše
)

1417 
u_ch¬
 *
Þd
, *
Ãw
;

1418 
ngx_buf_t
 *
b
;

1419 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

1420 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

1422 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1425 ià(
»que¡_lše
 && 
r
->
¡©e
 == 0) {

1429 
r
->
h—d”_š
->
pos
 =„->h—d”_š->
¡¬t
;

1430 
r
->
h—d”_š
->
Ï¡
 =„->h—d”_š->
¡¬t
;

1432  
NGX_OK
;

1435 
Þd
 = 
»que¡_lše
 ? 
r
->
»que¡_¡¬t
 :„->
h—d”_Çme_¡¬t
;

1437 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1439 ià(
r
->
¡©e
 != 0

1440 && (
size_t
è(
r
->
h—d”_š
->
pos
 - 
Þd
)

1441 >ð
cscf
->
Ïrge_þ›Á_h—d”_bufãrs
.
size
)

1443  
NGX_DECLINED
;

1446 
hc
 = 
r
->
h‰p_cÚÃùiÚ
;

1448 ià(
hc
->
nä“
) {

1449 
b
 = 
hc
->
ä“
[--hc->
nä“
];

1451 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1453 
b
->
pos
, b->
’d
 - b->
Ï¡
);

1455 } ià(
hc
->
nbusy
 < 
cscf
->
Ïrge_þ›Á_h—d”_bufãrs
.
num
) {

1457 ià(
hc
->
busy
 =ð
NULL
) {

1458 
hc
->
busy
 = 
	`ngx_·Îoc
(
r
->
cÚÃùiÚ
->
poÞ
,

1459 
cscf
->
Ïrge_þ›Á_h—d”_bufãrs
.
num
 * (
ngx_buf_t
 *));

1460 ià(
hc
->
busy
 =ð
NULL
) {

1461  
NGX_ERROR
;

1465 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
cÚÃùiÚ
->
poÞ
,

1466 
cscf
->
Ïrge_þ›Á_h—d”_bufãrs
.
size
);

1467 ià(
b
 =ð
NULL
) {

1468  
NGX_ERROR
;

1471 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1473 
b
->
pos
, b->
’d
 - b->
Ï¡
);

1476  
NGX_DECLINED
;

1479 
hc
->
busy
[hc->
nbusy
++] = 
b
;

1481 ià(
r
->
¡©e
 == 0) {

1488 
r
->
h—d”_š
 = 
b
;

1490  
NGX_OK
;

1493 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1494 "h‰°Ïrgh—d” cÝy: %d", 
r
->
h—d”_š
->
pos
 - 
Þd
);

1496 
Ãw
 = 
b
->
¡¬t
;

1498 
	`ngx_memýy
(
Ãw
, 
Þd
, 
r
->
h—d”_š
->
pos
 - old);

1500 
b
->
pos
 = 
Ãw
 + (
r
->
h—d”_š
->po - 
Þd
);

1501 
b
->
Ï¡
 = 
Ãw
 + (
r
->
h—d”_š
->
pos
 - 
Þd
);

1503 ià(
»que¡_lše
) {

1504 
r
->
»que¡_¡¬t
 = 
Ãw
;

1506 ià(
r
->
»que¡_’d
) {

1507 
r
->
»que¡_’d
 = 
Ãw
 + (r->»que¡_’d - 
Þd
);

1510 
r
->
m‘hod_’d
 = 
Ãw
 + (r->m‘hod_’d - 
Þd
);

1512 
r
->
uri_¡¬t
 = 
Ãw
 + (r->uri_¡¬ˆ- 
Þd
);

1513 
r
->
uri_’d
 = 
Ãw
 + (r->uri_’d - 
Þd
);

1515 ià(
r
->
schema_¡¬t
) {

1516 
r
->
schema_¡¬t
 = 
Ãw
 + (r->schema_¡¬ˆ- 
Þd
);

1517 
r
->
schema_’d
 = 
Ãw
 + (r->schema_’d - 
Þd
);

1520 ià(
r
->
ho¡_¡¬t
) {

1521 
r
->
ho¡_¡¬t
 = 
Ãw
 + (r->ho¡_¡¬ˆ- 
Þd
);

1522 ià(
r
->
ho¡_’d
) {

1523 
r
->
ho¡_’d
 = 
Ãw
 + (r->ho¡_’d - 
Þd
);

1527 ià(
r
->
pÜt_¡¬t
) {

1528 
r
->
pÜt_¡¬t
 = 
Ãw
 + (r->pÜt_¡¬ˆ- 
Þd
);

1529 
r
->
pÜt_’d
 = 
Ãw
 + (r->pÜt_’d - 
Þd
);

1532 ià(
r
->
uri_ext
) {

1533 
r
->
uri_ext
 = 
Ãw
 + (r->uri_exˆ- 
Þd
);

1536 ià(
r
->
¬gs_¡¬t
) {

1537 
r
->
¬gs_¡¬t
 = 
Ãw
 + (r->¬gs_¡¬ˆ- 
Þd
);

1540 ià(
r
->
h‰p_´ÙocÞ
.
d©a
) {

1541 
r
->
h‰p_´ÙocÞ
.
d©a
 = 
Ãw
 + (r->h‰p_´ÙocÞ.d©¨- 
Þd
);

1545 
r
->
h—d”_Çme_¡¬t
 = 
Ãw
;

1546 
r
->
h—d”_Çme_’d
 = 
Ãw
 + (r->h—d”_Çme_’d - 
Þd
);

1547 
r
->
h—d”_¡¬t
 = 
Ãw
 + (r->h—d”_¡¬ˆ- 
Þd
);

1548 
r
->
h—d”_’d
 = 
Ãw
 + (r->h—d”_’d - 
Þd
);

1551 
r
->
h—d”_š
 = 
b
;

1553  
NGX_OK
;

1554 
	}
}

1557 
ngx_št_t


1558 
	$ngx_h‰p_´oûss_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

1559 
ngx_ušt_t
 
off£t
)

1561 
ngx_bË_–t_t
 **
ph
;

1563 
ph
 = (
ngx_bË_–t_t
 **è((*è&
r
->
h—d”s_š
 + 
off£t
);

1565 ià(*
ph
 =ð
NULL
) {

1566 *
ph
 = 
h
;

1569  
NGX_OK
;

1570 
	}
}

1573 
ngx_št_t


1574 
	$ngx_h‰p_´oûss_unique_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

1575 
ngx_ušt_t
 
off£t
)

1577 
ngx_bË_–t_t
 **
ph
;

1579 
ph
 = (
ngx_bË_–t_t
 **è((*è&
r
->
h—d”s_š
 + 
off£t
);

1581 ià(*
ph
 =ð
NULL
) {

1582 *
ph
 = 
h
;

1583  
NGX_OK
;

1586 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1589 &
h
->
key
, &h->
v®ue
, &(*
ph
)->key, &(*ph)->value);

1591 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1593  
NGX_ERROR
;

1594 
	}
}

1597 
ngx_št_t


1598 
	$ngx_h‰p_´oûss_ho¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

1599 
ngx_ušt_t
 
off£t
)

1601 
ngx_št_t
 
rc
;

1602 
ngx_¡r_t
 
ho¡
;

1604 ià(
r
->
h—d”s_š
.
ho¡
 =ð
NULL
) {

1605 
r
->
h—d”s_š
.
ho¡
 = 
h
;

1608 
ho¡
 = 
h
->
v®ue
;

1610 
rc
 = 
	`ngx_h‰p_v®id©e_ho¡
(&
ho¡
, 
r
->
poÞ
, 0);

1612 ià(
rc
 =ð
NGX_DECLINED
) {

1613 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1615 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1616  
NGX_ERROR
;

1619 ià(
rc
 =ð
NGX_ERROR
) {

1620 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1621  
NGX_ERROR
;

1624 ià(
r
->
h—d”s_š
.
£rv”
.
Ën
) {

1625  
NGX_OK
;

1628 ià(
	`ngx_h‰p_£t_vœtu®_£rv”
(
r
, &
ho¡
è=ð
NGX_ERROR
) {

1629  
NGX_ERROR
;

1632 
r
->
h—d”s_š
.
£rv”
 = 
ho¡
;

1634  
NGX_OK
;

1635 
	}
}

1638 
ngx_št_t


1639 
	$ngx_h‰p_´oûss_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

1640 
ngx_ušt_t
 
off£t
)

1642 ià(
	`ngx_¡rÿ£¡º
(
h
->
v®ue
.
d©a
, "close", 5 - 1)) {

1643 
r
->
h—d”s_š
.
cÚÃùiÚ_ty³
 = 
NGX_HTTP_CONNECTION_CLOSE
;

1645 } ià(
	`ngx_¡rÿ£¡º
(
h
->
v®ue
.
d©a
, "keep-alive", 10 - 1)) {

1646 
r
->
h—d”s_š
.
cÚÃùiÚ_ty³
 = 
NGX_HTTP_CONNECTION_KEEP_ALIVE
;

1649  
NGX_OK
;

1650 
	}
}

1653 
ngx_št_t


1654 
	$ngx_h‰p_´oûss_u£r_ag’t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

1655 
ngx_ušt_t
 
off£t
)

1657 
u_ch¬
 *
u£r_ag’t
, *
ms›
;

1659 ià(
r
->
h—d”s_š
.
u£r_ag’t
) {

1660  
NGX_OK
;

1663 
r
->
h—d”s_š
.
u£r_ag’t
 = 
h
;

1667 
u£r_ag’t
 = 
h
->
v®ue
.
d©a
;

1669 
ms›
 = 
	`ngx_¡r¡º
(
u£r_ag’t
, "MSIE ", 5 - 1);

1671 ià(
ms›
 && ms› + 7 < 
u£r_ag’t
 + 
h
->
v®ue
.
Ën
) {

1673 
r
->
h—d”s_š
.
ms›
 = 1;

1675 ià(
ms›
[6] == '.') {

1677 
ms›
[5]) {

1680 
r
->
h—d”s_š
.
ms›6
 = 1;

1683 ià(
	`ngx_¡r¡º
(
ms›
 + 8, "SV1", 3 - 1è=ð
NULL
) {

1684 
r
->
h—d”s_š
.
ms›6
 = 1;

1692 ià(
c
->
s¦
) {

1693 
c
->
s¦
->
no_£nd_shutdown
 = 1;

1698 ià(
	`ngx_¡r¡º
(
u£r_ag’t
, "Opera", 5 - 1)) {

1699 
r
->
h—d”s_š
.
Ý”a
 = 1;

1700 
r
->
h—d”s_š
.
ms›
 = 0;

1701 
r
->
h—d”s_š
.
ms›6
 = 0;

1704 ià(!
r
->
h—d”s_š
.
ms›
 && !r->h—d”s_š.
Ý”a
) {

1706 ià(
	`ngx_¡r¡º
(
u£r_ag’t
, "Gecko/", 6 - 1)) {

1707 
r
->
h—d”s_š
.
gecko
 = 1;

1709 } ià(
	`ngx_¡r¡º
(
u£r_ag’t
, "Chrome/", 7 - 1)) {

1710 
r
->
h—d”s_š
.
chrome
 = 1;

1712 } ià(
	`ngx_¡r¡º
(
u£r_ag’t
, "Safari/", 7 - 1)

1713 && 
	`ngx_¡r¡º
(
u£r_ag’t
, "Mac OS X", 8 - 1))

1715 
r
->
h—d”s_š
.
§çri
 = 1;

1717 } ià(
	`ngx_¡r¡º
(
u£r_ag’t
, "Konqueror", 9 - 1)) {

1718 
r
->
h—d”s_š
.
kÚqu”Ü
 = 1;

1722  
NGX_OK
;

1723 
	}
}

1726 
ngx_št_t


1727 
	$ngx_h‰p_´oûss_muÉi_h—d”_lšes
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

1728 
ngx_ušt_t
 
off£t
)

1730 
ngx_¬¿y_t
 *
h—d”s
;

1731 
ngx_bË_–t_t
 **
ph
;

1733 
h—d”s
 = (
ngx_¬¿y_t
 *è((*è&
r
->
h—d”s_š
 + 
off£t
);

1735 ià(
h—d”s
->
–ts
 =ð
NULL
) {

1736 ià(
	`ngx_¬¿y_š™
(
h—d”s
, 
r
->
poÞ
, 1, (
ngx_bË_–t_t
 *))

1737 !ð
NGX_OK
)

1739 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1740  
NGX_ERROR
;

1744 
ph
 = 
	`ngx_¬¿y_push
(
h—d”s
);

1745 ià(
ph
 =ð
NULL
) {

1746 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1747  
NGX_ERROR
;

1750 *
ph
 = 
h
;

1751  
NGX_OK
;

1752 
	}
}

1755 
ngx_št_t


1756 
	$ngx_h‰p_´oûss_»que¡_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

1758 ià(
r
->
h—d”s_š
.
£rv”
.
Ën
 == 0

1759 && 
	`ngx_h‰p_£t_vœtu®_£rv”
(
r
, &r->
h—d”s_š
.
£rv”
)

1760 =ð
NGX_ERROR
)

1762  
NGX_ERROR
;

1765 ià(
r
->
h—d”s_š
.
ho¡
 =ð
NULL
 &&„->
h‰p_v”siÚ
 > 
NGX_HTTP_VERSION_10
) {

1766 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1768 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1769  
NGX_ERROR
;

1772 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth
) {

1773 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 =

1774 
	`ngx_©oof
(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth
->
v®ue
.
d©a
,

1775 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth
->
v®ue
.
Ën
);

1777 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 =ð
NGX_ERROR
) {

1778 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1780 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1781  
NGX_ERROR
;

1785 ià(
r
->
m‘hod
 & 
NGX_HTTP_TRACE
) {

1786 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1788 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_NOT_ALLOWED
);

1789  
NGX_ERROR
;

1792 ià(
r
->
h—d”s_š
.
Œªsãr_’codšg
) {

1793 ià(
r
->
h—d”s_š
.
Œªsãr_’codšg
->
v®ue
.
Ën
 == 7

1794 && 
	`ngx_¡ºÿ£cmp
(
r
->
h—d”s_š
.
Œªsãr_’codšg
->
v®ue
.
d©a
,

1795 (
u_ch¬
 *) "chunked", 7) == 0)

1797 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth
 = 
NULL
;

1798 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = -1;

1799 
r
->
h—d”s_š
.
chunked
 = 1;

1801 } ià(
r
->
h—d”s_š
.
Œªsãr_’codšg
->
v®ue
.
Ën
 != 8

1802 || 
	`ngx_¡ºÿ£cmp
(
r
->
h—d”s_š
.
Œªsãr_’codšg
->
v®ue
.
d©a
,

1803 (
u_ch¬
 *) "identity", 8) != 0)

1805 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1807 &
r
->
h—d”s_š
.
Œªsãr_’codšg
->
v®ue
);

1808 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_NOT_IMPLEMENTED
);

1809  
NGX_ERROR
;

1813 ià(
r
->
h—d”s_š
.
cÚÃùiÚ_ty³
 =ð
NGX_HTTP_CONNECTION_KEEP_ALIVE
) {

1814 ià(
r
->
h—d”s_š
.
k“p_®ive
) {

1815 
r
->
h—d”s_š
.
k“p_®ive_n
 =

1816 
	`ngx_©Ùm
(
r
->
h—d”s_š
.
k“p_®ive
->
v®ue
.
d©a
,

1817 
r
->
h—d”s_š
.
k“p_®ive
->
v®ue
.
Ën
);

1821  
NGX_OK
;

1822 
	}
}

1826 
	$ngx_h‰p_´oûss_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

1828 
ngx_cÚÃùiÚ_t
 *
c
;

1830 
c
 = 
r
->
cÚÃùiÚ
;

1832 #ià(
NGX_HTTP_SSL
)

1834 ià(
r
->
h‰p_cÚÃùiÚ
->
s¦
) {

1835 
rc
;

1836 
X509
 *
û¹
;

1837 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
;

1839 ià(
c
->
s¦
 =ð
NULL
) {

1840 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1842 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_TO_HTTPS
);

1846 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_s¦_moduË
);

1848 ià(
sscf
->
v”ify
) {

1849 
rc
 = 
	`SSL_g‘_v”ify_»suÉ
(
c
->
s¦
->
cÚÃùiÚ
);

1851 ià(
rc
 !ð
X509_V_OK


1852 && (
sscf
->
v”ify
 !ð3 || !
	`ngx_s¦_v”ify_”rÜ_ÝtiÚ®
(
rc
)))

1854 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1856 
rc
, 
	`X509_v”ify_û¹_”rÜ_¡ršg
(rc));

1858 
	`ngx_s¦_»move_ÿched_£ssiÚ
(
sscf
->
s¦
.
ùx
,

1859 (
	`SSL_g‘0_£ssiÚ
(
c
->
s¦
->
cÚÃùiÚ
)));

1861 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTPS_CERT_ERROR
);

1865 ià(
sscf
->
v”ify
 == 1) {

1866 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
c
->
s¦
->
cÚÃùiÚ
);

1868 ià(
û¹
 =ð
NULL
) {

1869 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

1872 
	`ngx_s¦_»move_ÿched_£ssiÚ
(
sscf
->
s¦
.
ùx
,

1873 (
	`SSL_g‘0_£ssiÚ
(
c
->
s¦
->
cÚÃùiÚ
)));

1875 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTPS_NO_CERT
);

1879 
	`X509_ä“
(
û¹
);

1886 ià(
c
->
»ad
->
tim”_£t
) {

1887 
	`ngx_d–_tim”
(
c
->
»ad
);

1890 #ià(
NGX_STAT_STUB
)

1891 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_»adšg
, -1);

1892 
r
->
¡©_»adšg
 = 0;

1893 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_wr™šg
, 1);

1894 
r
->
¡©_wr™šg
 = 1;

1897 
c
->
»ad
->
hªdËr
 = 
ngx_h‰p_»que¡_hªdËr
;

1898 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_»que¡_hªdËr
;

1899 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_block_»adšg
;

1901 
	`ngx_h‰p_hªdËr
(
r
);

1903 
	`ngx_h‰p_run_po¡ed_»que¡s
(
c
);

1904 
	}
}

1907 
ngx_št_t


1908 
	$ngx_h‰p_v®id©e_ho¡
(
ngx_¡r_t
 *
ho¡
, 
ngx_poÞ_t
 *
poÞ
, 
ngx_ušt_t
 
®loc
)

1910 
u_ch¬
 *
h
, 
ch
;

1911 
size_t
 
i
, 
dÙ_pos
, 
ho¡_Ën
;

1914 
sw_usu®
 = 0,

1915 
sw_l™”®
,

1916 
sw_»¡


1917 } 
¡©e
;

1919 
dÙ_pos
 = 
ho¡
->
Ën
;

1920 
ho¡_Ën
 = 
ho¡
->
Ën
;

1922 
h
 = 
ho¡
->
d©a
;

1924 
¡©e
 = 
sw_usu®
;

1926 
i
 = 0; i < 
ho¡
->
Ën
; i++) {

1927 
ch
 = 
h
[
i
];

1929 
ch
) {

1932 ià(
dÙ_pos
 =ð
i
 - 1) {

1933  
NGX_DECLINED
;

1935 
dÙ_pos
 = 
i
;

1939 ià(
¡©e
 =ð
sw_usu®
) {

1940 
ho¡_Ën
 = 
i
;

1941 
¡©e
 = 
sw_»¡
;

1946 ià(
i
 == 0) {

1947 
¡©e
 = 
sw_l™”®
;

1952 ià(
¡©e
 =ð
sw_l™”®
) {

1953 
ho¡_Ën
 = 
i
 + 1;

1954 
¡©e
 = 
sw_»¡
;

1959  
NGX_DECLINED
;

1963 ià(
	`ngx_·th_£·¿tÜ
(
ch
)) {

1964  
NGX_DECLINED
;

1967 ià(
ch
 >= 'A' && ch <= 'Z') {

1968 
®loc
 = 1;

1975 ià(
dÙ_pos
 =ð
ho¡_Ën
 - 1) {

1976 
ho¡_Ën
--;

1979 ià(
ho¡_Ën
 == 0) {

1980  
NGX_DECLINED
;

1983 ià(
®loc
) {

1984 
ho¡
->
d©a
 = 
	`ngx_²®loc
(
poÞ
, 
ho¡_Ën
);

1985 ià(
ho¡
->
d©a
 =ð
NULL
) {

1986  
NGX_ERROR
;

1989 
	`ngx_¡¾ow
(
ho¡
->
d©a
, 
h
, 
ho¡_Ën
);

1992 
ho¡
->
Ën
 = 
ho¡_Ën
;

1994  
NGX_OK
;

1995 
	}
}

1998 
ngx_št_t


1999 
	$ngx_h‰p_£t_vœtu®_£rv”
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
ho¡
)

2001 
ngx_št_t
 
rc
;

2002 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

2003 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2004 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2006 #ià(
NGX_SUPPRESS_WARN
)

2007 
cscf
 = 
NULL
;

2010 
hc
 = 
r
->
h‰p_cÚÃùiÚ
;

2012 #ià(
NGX_HTTP_SSL
 && 
defšed
 
SSL_CTRL_SET_TLSEXT_HOSTNAME
)

2014 ià(
hc
->
s¦_£rv”Çme
) {

2015 ià(
hc
->
s¦_£rv”Çme
->
Ën
 =ð
ho¡
->len

2016 && 
	`ngx_¡ºcmp
(
hc
->
s¦_£rv”Çme
->
d©a
,

2017 
ho¡
->
d©a
, ho¡->
Ën
) == 0)

2019 #ià(
NGX_PCRE
)

2020 ià(
hc
->
s¦_£rv”Çme_»gex


2021 && 
	`ngx_h‰p_»gex_exec
(
r
, 
hc
->
s¦_£rv”Çme_»gex
,

2022 
hc
->
s¦_£rv”Çme
è!ð
NGX_OK
)

2024 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2025  
NGX_ERROR
;

2028  
NGX_OK
;

2034 
rc
 = 
	`ngx_h‰p_fšd_vœtu®_£rv”
(
r
->
cÚÃùiÚ
,

2035 
hc
->
addr_cÚf
->
vœtu®_Çmes
,

2036 
ho¡
, 
r
, &
cscf
);

2038 ià(
rc
 =ð
NGX_ERROR
) {

2039 
	`ngx_h‰p_þo£_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2040  
NGX_ERROR
;

2043 #ià(
NGX_HTTP_SSL
 && 
defšed
 
SSL_CTRL_SET_TLSEXT_HOSTNAME
)

2045 ià(
hc
->
s¦_£rv”Çme
) {

2046 
ngx_h‰p_s¦_¤v_cÚf_t
 *
sscf
;

2048 ià(
rc
 =ð
NGX_DECLINED
) {

2049 
cscf
 = 
hc
->
addr_cÚf
->
deçuÉ_£rv”
;

2050 
rc
 = 
NGX_OK
;

2053 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
cscf
->
ùx
, 
ngx_h‰p_s¦_moduË
);

2055 ià(
sscf
->
v”ify
) {

2056 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2059 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

2060  
NGX_ERROR
;

2066 ià(
rc
 =ð
NGX_DECLINED
) {

2067  
NGX_OK
;

2070 
r
->
¤v_cÚf
 = 
cscf
->
ùx
->srv_conf;

2071 
r
->
loc_cÚf
 = 
cscf
->
ùx
->loc_conf;

2073 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2075 
	`ngx_h‰p_£t_cÚÃùiÚ_log
(
r
->
cÚÃùiÚ
, 
þcf
->
”rÜ_log
);

2077  
NGX_OK
;

2078 
	}
}

2081 
ngx_št_t


2082 
	$ngx_h‰p_fšd_vœtu®_£rv”
(
ngx_cÚÃùiÚ_t
 *
c
,

2083 
ngx_h‰p_vœtu®_Çmes_t
 *
vœtu®_Çmes
, 
ngx_¡r_t
 *
ho¡
,

2084 
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_cÜe_¤v_cÚf_t
 **
cscå
)

2086 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2088 ià(
vœtu®_Çmes
 =ð
NULL
) {

2089  
NGX_DECLINED
;

2092 
cscf
 = 
	`ngx_hash_fšd_combšed
(&
vœtu®_Çmes
->
Çmes
,

2093 
	`ngx_hash_key
(
ho¡
->
d©a
, ho¡->
Ën
),

2094 
ho¡
->
d©a
, ho¡->
Ën
);

2096 ià(
cscf
) {

2097 *
cscå
 = 
cscf
;

2098  
NGX_OK
;

2101 #ià(
NGX_PCRE
)

2103 ià(
ho¡
->
Ën
 && 
vœtu®_Çmes
->
Äegex
) {

2104 
ngx_št_t
 
n
;

2105 
ngx_ušt_t
 
i
;

2106 
ngx_h‰p_£rv”_Çme_t
 *
¢
;

2108 
¢
 = 
vœtu®_Çmes
->
»gex
;

2110 #ià(
NGX_HTTP_SSL
 && 
defšed
 
SSL_CTRL_SET_TLSEXT_HOSTNAME
)

2112 ià(
r
 =ð
NULL
) {

2113 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

2115 
i
 = 0; i < 
vœtu®_Çmes
->
Äegex
; i++) {

2117 
n
 = 
	`ngx_»gex_exec
(
¢
[
i
].
»gex
->»gex, 
ho¡
, 
NULL
, 0);

2119 ià(
n
 =ð
NGX_REGEX_NO_MATCHED
) {

2123 ià(
n
 >= 0) {

2124 
hc
 = 
c
->
d©a
;

2125 
hc
->
s¦_£rv”Çme_»gex
 = 
¢
[
i
].
»gex
;

2127 *
cscå
 = 
¢
[
i
].
£rv”
;

2128  
NGX_OK
;

2131 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

2132 
ngx_»gex_exec_n
 " failed: %i "

2134 
n
, 
ho¡
, &
¢
[
i
].
»gex
->
Çme
);

2136  
NGX_ERROR
;

2139  
NGX_DECLINED
;

2144 
i
 = 0; i < 
vœtu®_Çmes
->
Äegex
; i++) {

2146 
n
 = 
	`ngx_h‰p_»gex_exec
(
r
, 
¢
[
i
].
»gex
, 
ho¡
);

2148 ià(
n
 =ð
NGX_DECLINED
) {

2152 ià(
n
 =ð
NGX_OK
) {

2153 *
cscå
 = 
¢
[
i
].
£rv”
;

2154  
NGX_OK
;

2157  
NGX_ERROR
;

2163  
NGX_DECLINED
;

2164 
	}
}

2168 
	$ngx_h‰p_»que¡_hªdËr
(
ngx_ev’t_t
 *
ev
)

2170 
ngx_cÚÃùiÚ_t
 *
c
;

2171 
ngx_h‰p_»que¡_t
 *
r
;

2173 
c
 = 
ev
->
d©a
;

2174 
r
 = 
c
->
d©a
;

2176 
	`ngx_h‰p_£t_log_»que¡
(
c
->
log
, 
r
);

2178 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2179 "h‰°ruÀ»que¡: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

2181 ià(
ev
->
wr™e
) {

2182 
r
->
	`wr™e_ev’t_hªdËr
(r);

2185 
r
->
	`»ad_ev’t_hªdËr
(r);

2188 
	`ngx_h‰p_run_po¡ed_»que¡s
(
c
);

2189 
	}
}

2193 
	$ngx_h‰p_run_po¡ed_»que¡s
(
ngx_cÚÃùiÚ_t
 *
c
)

2195 
ngx_h‰p_»que¡_t
 *
r
;

2196 
ngx_h‰p_po¡ed_»que¡_t
 *
´
;

2200 ià(
c
->
de¡royed
) {

2204 
r
 = 
c
->
d©a
;

2205 
´
 = 
r
->
maš
->
po¡ed_»que¡s
;

2207 ià(
´
 =ð
NULL
) {

2211 
r
->
maš
->
po¡ed_»que¡s
 = 
´
->
Ãxt
;

2213 
r
 = 
´
->
»que¡
;

2215 
	`ngx_h‰p_£t_log_»que¡
(
c
->
log
, 
r
);

2217 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2218 "h‰°po¡ed„eque¡: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

2220 
r
->
	`wr™e_ev’t_hªdËr
(r);

2222 
	}
}

2225 
ngx_št_t


2226 
	$ngx_h‰p_po¡_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_po¡ed_»que¡_t
 *
´
)

2228 
ngx_h‰p_po¡ed_»que¡_t
 **
p
;

2230 ià(
´
 =ð
NULL
) {

2231 
´
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_po¡ed_»que¡_t
));

2232 ià(
´
 =ð
NULL
) {

2233  
NGX_ERROR
;

2237 
´
->
»que¡
 = 
r
;

2238 
´
->
Ãxt
 = 
NULL
;

2240 
p
 = &
r
->
maš
->
po¡ed_»que¡s
; *p;… = &(*p)->
Ãxt
) { }

2242 *
p
 = 
´
;

2244  
NGX_OK
;

2245 
	}
}

2249 
	$ngx_h‰p_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

2251 
ngx_cÚÃùiÚ_t
 *
c
;

2252 
ngx_h‰p_»que¡_t
 *
´
;

2253 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2255 
c
 = 
r
->
cÚÃùiÚ
;

2257 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2259 
rc
, &
r
->
uri
, &r->
¬gs
,„ =ð
c
->
d©a
,„->
maš
->
couÁ
);

2261 ià(
rc
 =ð
NGX_DONE
) {

2262 
	`ngx_h‰p_fš®ize_cÚÃùiÚ
(
r
);

2266 ià(
rc
 =ð
NGX_OK
 && 
r
->
fž‹r_fš®ize
) {

2267 
c
->
”rÜ
 = 1;

2270 ià(
rc
 =ð
NGX_DECLINED
) {

2271 
r
->
cÚ‹Á_hªdËr
 = 
NULL
;

2272 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_cÜe_run_pha£s
;

2273 
	`ngx_h‰p_cÜe_run_pha£s
(
r
);

2277 ià(
r
 !ðr->
maš
 &&„->
po¡_sub»que¡
) {

2278 
rc
 = 
r
->
po¡_sub»que¡
->
	`hªdËr
Ô,„->po¡_sub»que¡->
d©a
,„c);

2281 ià(
rc
 =ð
NGX_ERROR


2282 || 
rc
 =ð
NGX_HTTP_REQUEST_TIME_OUT


2283 || 
rc
 =ð
NGX_HTTP_CLIENT_CLOSED_REQUEST


2284 || 
c
->
”rÜ
)

2286 ià(
	`ngx_h‰p_po¡_aùiÚ
(
r
è=ð
NGX_OK
) {

2290 ià(
r
->
maš
->
blocked
) {

2291 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_fš®iz”
;

2294 
	`ngx_h‰p_‹rmš©e_»que¡
(
r
, 
rc
);

2298 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE


2299 || 
rc
 =ð
NGX_HTTP_CREATED


2300 || 
rc
 =ð
NGX_HTTP_NO_CONTENT
)

2302 ià(
rc
 =ð
NGX_HTTP_CLOSE
) {

2303 
	`ngx_h‰p_‹rmš©e_»que¡
(
r
, 
rc
);

2307 ià(
r
 =ðr->
maš
) {

2308 ià(
c
->
»ad
->
tim”_£t
) {

2309 
	`ngx_d–_tim”
(
c
->
»ad
);

2312 ià(
c
->
wr™e
->
tim”_£t
) {

2313 
	`ngx_d–_tim”
(
c
->
wr™e
);

2317 
c
->
»ad
->
hªdËr
 = 
ngx_h‰p_»que¡_hªdËr
;

2318 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_»que¡_hªdËr
;

2320 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
	`ngx_h‰p_¥ecŸl_»¥Ú£_hªdËr
Ô, 
rc
));

2324 ià(
r
 !ðr->
maš
) {

2326 ià(
r
->
bufã»d
 ||„->
po¡pÚed
) {

2328 ià(
	`ngx_h‰p_£t_wr™e_hªdËr
(
r
è!ð
NGX_OK
) {

2329 
	`ngx_h‰p_‹rmš©e_»que¡
(
r
, 0);

2335 
´
 = 
r
->
·»Á
;

2337 ià(
r
 =ð
c
->
d©a
) {

2339 
r
->
maš
->
couÁ
--;

2340 
r
->
maš
->
sub»que¡s
++;

2342 ià(!
r
->
logged
) {

2344 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2346 ià(
þcf
->
log_sub»que¡
) {

2347 
	`ngx_h‰p_log_»que¡
(
r
);

2350 
r
->
logged
 = 1;

2353 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

2355 &
r
->
uri
, &r->
¬gs
);

2358 
r
->
dÚe
 = 1;

2360 ià(
´
->
po¡pÚed
 &&…r->po¡pÚed->
»que¡
 =ð
r
) {

2361 
´
->
po¡pÚed
 =…r->po¡pÚed->
Ãxt
;

2364 
c
->
d©a
 = 
´
;

2368 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2370 &
r
->
uri
, &r->
¬gs
);

2372 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_fš®iz”
;

2374 ià(
r
->
wa™ed
) {

2375 
r
->
dÚe
 = 1;

2379 ià(
	`ngx_h‰p_po¡_»que¡
(
´
, 
NULL
è!ð
NGX_OK
) {

2380 
r
->
maš
->
couÁ
++;

2381 
	`ngx_h‰p_‹rmš©e_»que¡
(
r
, 0);

2385 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2387 &
´
->
uri
, &´->
¬gs
);

2392 ià(
r
->
bufã»d
 || 
c
->bufã»d ||„->
po¡pÚed
 ||„->
blocked
) {

2394 ià(
	`ngx_h‰p_£t_wr™e_hªdËr
(
r
è!ð
NGX_OK
) {

2395 
	`ngx_h‰p_‹rmš©e_»que¡
(
r
, 0);

2401 ià(
r
 !ð
c
->
d©a
) {

2402 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

2404 &
r
->
uri
, &r->
¬gs
);

2408 
r
->
dÚe
 = 1;

2409 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

2411 ià(!
r
->
po¡_aùiÚ
) {

2412 
r
->
»que¡_com¶‘e
 = 1;

2415 ià(
	`ngx_h‰p_po¡_aùiÚ
(
r
è=ð
NGX_OK
) {

2419 ià(
c
->
»ad
->
tim”_£t
) {

2420 
	`ngx_d–_tim”
(
c
->
»ad
);

2423 ià(
c
->
wr™e
->
tim”_£t
) {

2424 
c
->
wr™e
->
d–ayed
 = 0;

2425 
	`ngx_d–_tim”
(
c
->
wr™e
);

2428 ià(
c
->
»ad
->
eof
) {

2429 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2433 
	`ngx_h‰p_fš®ize_cÚÃùiÚ
(
r
);

2434 
	}
}

2438 
	$ngx_h‰p_‹rmš©e_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

2440 
ngx_h‰p_þ—nup_t
 *
þn
;

2441 
ngx_h‰p_»que¡_t
 *
mr
;

2442 
ngx_h‰p_•hem”®_t
 *
e
;

2444 
mr
 = 
r
->
maš
;

2446 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2447 "h‰°‹rmš©»que¡ couÁ:%d", 
mr
->
couÁ
);

2449 ià(
rc
 > 0 && (
mr
->
h—d”s_out
.
¡©us
 =ð0 || mr->
cÚÃùiÚ
->
£Á
 == 0)) {

2450 
mr
->
h—d”s_out
.
¡©us
 = 
rc
;

2453 
þn
 = 
mr
->
þ—nup
;

2454 
mr
->
þ—nup
 = 
NULL
;

2456 
þn
) {

2457 ià(
þn
->
hªdËr
) {

2458 
þn
->
	`hªdËr
(þn->
d©a
);

2461 
þn
 = cÊ->
Ãxt
;

2464 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2466 
mr
->
couÁ
, mr->
blocked
);

2468 ià(
mr
->
wr™e_ev’t_hªdËr
) {

2470 ià(
mr
->
blocked
) {

2474 
e
 = 
	`ngx_h‰p_•hem”®
(
mr
);

2475 
mr
->
po¡ed_»que¡s
 = 
NULL
;

2476 
mr
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_‹rmš©e_hªdËr
;

2477 (è
	`ngx_h‰p_po¡_»que¡
(
mr
, &
e
->
‹rmš®_po¡ed_»que¡
);

2481 
	`ngx_h‰p_þo£_»que¡
(
mr
, 
rc
);

2482 
	}
}

2486 
	$ngx_h‰p_‹rmš©e_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

2488 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2489 "h‰°‹rmš©hªdË¸couÁ:%d", 
r
->
couÁ
);

2491 
r
->
couÁ
 = 1;

2493 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2494 
	}
}

2498 
	$ngx_h‰p_fš®ize_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
)

2500 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2502 #ià(
NGX_HTTP_SPDY
)

2503 ià(
r
->
¥dy_¡»am
) {

2504 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2509 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2511 ià(
r
->
maš
->
couÁ
 != 1) {

2513 ià(
r
->
disÿrd_body
) {

2514 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_disÿrded_»que¡_body_hªdËr
;

2515 
	`ngx_add_tim”
(
r
->
cÚÃùiÚ
->
»ad
, 
þcf
->
lšg”šg_timeout
);

2517 ià(
r
->
lšg”šg_time
 == 0) {

2518 
r
->
lšg”šg_time
 = 
	`ngx_time
()

2519 + (
time_t
è(
þcf
->
lšg”šg_time
 / 1000);

2523 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2527 ià(!
ngx_‹rmš©e


2528 && !
ngx_ex™šg


2529 && 
r
->
k“·live


2530 && 
þcf
->
k“·live_timeout
 > 0)

2532 
	`ngx_h‰p_£t_k“·live
(
r
);

2536 ià(
þcf
->
lšg”šg_þo£
 =ð
NGX_HTTP_LINGERING_ALWAYS


2537 || (
þcf
->
lšg”šg_þo£
 =ð
NGX_HTTP_LINGERING_ON


2538 && (
r
->
lšg”šg_þo£


2539 || 
r
->
h—d”_š
->
pos
 <„->h—d”_š->
Ï¡


2540 || 
r
->
cÚÃùiÚ
->
»ad
->
»ady
)))

2542 
	`ngx_h‰p_£t_lšg”šg_þo£
(
r
);

2546 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2547 
	}
}

2550 
ngx_št_t


2551 
	$ngx_h‰p_£t_wr™e_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

2553 
ngx_ev’t_t
 *
wev
;

2554 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2556 
r
->
h‰p_¡©e
 = 
NGX_HTTP_WRITING_REQUEST_STATE
;

2558 
r
->
»ad_ev’t_hªdËr
 =„->
disÿrd_body
 ?

2559 
ngx_h‰p_disÿrded_»que¡_body_hªdËr
:

2560 
ngx_h‰p_‹¡_»adšg
;

2561 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_wr™”
;

2563 #ià(
NGX_HTTP_SPDY
)

2564 ià(
r
->
¥dy_¡»am
) {

2565  
NGX_OK
;

2569 
wev
 = 
r
->
cÚÃùiÚ
->
wr™e
;

2571 ià(
wev
->
»ady
 && wev->
d–ayed
) {

2572  
NGX_OK
;

2575 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2576 ià(!
wev
->
d–ayed
) {

2577 
	`ngx_add_tim”
(
wev
, 
þcf
->
£nd_timeout
);

2580 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 
þcf
->
£nd_low©
è!ð
NGX_OK
) {

2581 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2582  
NGX_ERROR
;

2585  
NGX_OK
;

2586 
	}
}

2590 
	$ngx_h‰p_wr™”
(
ngx_h‰p_»que¡_t
 *
r
)

2592 
rc
;

2593 
ngx_ev’t_t
 *
wev
;

2594 
ngx_cÚÃùiÚ_t
 *
c
;

2595 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2597 
c
 = 
r
->
cÚÃùiÚ
;

2598 
wev
 = 
c
->
wr™e
;

2600 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
wev
->
log
, 0,

2601 "h‰°wr™” hªdËr: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

2603 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
->
maš
, 
ngx_h‰p_cÜe_moduË
);

2605 ià(
wev
->
timedout
) {

2606 ià(!
wev
->
d–ayed
) {

2607 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

2609 
c
->
timedout
 = 1;

2611 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_REQUEST_TIME_OUT
);

2615 
wev
->
timedout
 = 0;

2616 
wev
->
d–ayed
 = 0;

2618 ià(!
wev
->
»ady
) {

2619 
	`ngx_add_tim”
(
wev
, 
þcf
->
£nd_timeout
);

2621 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 
þcf
->
£nd_low©
è!ð
NGX_OK
) {

2622 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2630 ià(
wev
->
d–ayed
 || 
r
->
aio
) {

2631 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
wev
->
log
, 0,

2634 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 
þcf
->
£nd_low©
è!ð
NGX_OK
) {

2635 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2641 
rc
 = 
	`ngx_h‰p_ouut_fž‹r
(
r
, 
NULL
);

2643 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2645 
rc
, &
r
->
uri
, &r->
¬gs
);

2647 ià(
rc
 =ð
NGX_ERROR
) {

2648 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

2652 ià(
r
->
bufã»d
 ||„->
po¡pÚed
 || (¸=ðr->
maš
 && 
c
->buffered)) {

2654 #ià(
NGX_HTTP_SPDY
)

2655 ià(
r
->
¥dy_¡»am
) {

2660 ià(!
wev
->
d–ayed
) {

2661 
	`ngx_add_tim”
(
wev
, 
þcf
->
£nd_timeout
);

2664 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 
þcf
->
£nd_low©
è!ð
NGX_OK
) {

2665 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2671 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
wev
->
log
, 0,

2672 "h‰°wr™” dÚe: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

2674 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

2676 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

2677 
	}
}

2681 
	$ngx_h‰p_»que¡_fš®iz”
(
ngx_h‰p_»que¡_t
 *
r
)

2683 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2684 "h‰°fš®iz” dÚe: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

2686 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 0);

2687 
	}
}

2691 
	$ngx_h‰p_block_»adšg
(
ngx_h‰p_»que¡_t
 *
r
)

2693 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2698 ià((
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT
)

2699 && 
r
->
cÚÃùiÚ
->
»ad
->
aùive
)

2701 ià(
	`ngx_d–_ev’t
(
r
->
cÚÃùiÚ
->
»ad
, 
NGX_READ_EVENT
, 0è!ð
NGX_OK
) {

2702 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2705 
	}
}

2709 
	$ngx_h‰p_‹¡_»adšg
(
ngx_h‰p_»que¡_t
 *
r
)

2711 
n
;

2712 
buf
[1];

2713 
ngx_”r_t
 
”r
;

2714 
ngx_ev’t_t
 *
»v
;

2715 
ngx_cÚÃùiÚ_t
 *
c
;

2717 
c
 = 
r
->
cÚÃùiÚ
;

2718 
»v
 = 
c
->
»ad
;

2720 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "httpest„eading");

2722 #ià(
NGX_HTTP_SPDY
)

2724 ià(
r
->
¥dy_¡»am
) {

2725 ià(
c
->
”rÜ
) {

2726 
”r
 = 0;

2727 
þo£d
;

2735 #ià(
NGX_HAVE_KQUEUE
)

2737 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

2739 ià(!
»v
->
³ndšg_eof
) {

2743 
»v
->
eof
 = 1;

2744 
c
->
”rÜ
 = 1;

2745 
”r
 = 
»v
->
kq_”ºo
;

2747 
þo£d
;

2752 #ià(
NGX_HAVE_EPOLLRDHUP
)

2754 ià((
ngx_ev’t_æags
 & 
NGX_USE_EPOLL_EVENT
è&& 
»v
->
³ndšg_eof
) {

2755 
sockËn_t
 
Ën
;

2757 
»v
->
eof
 = 1;

2758 
c
->
”rÜ
 = 1;

2760 
”r
 = 0;

2761 
Ën
 = (
ngx_”r_t
);

2768 ià(
	`g‘sockÝt
(
c
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, (*è&
”r
, &
Ën
)

2771 
”r
 = 
ngx_sock‘_”ºo
;

2774 
þo£d
;

2779 
n
 = 
	`»cv
(
c
->
fd
, 
buf
, 1, 
MSG_PEEK
);

2781 ià(
n
 == 0) {

2782 
»v
->
eof
 = 1;

2783 
c
->
”rÜ
 = 1;

2784 
”r
 = 0;

2786 
þo£d
;

2788 } ià(
n
 == -1) {

2789 
”r
 = 
ngx_sock‘_”ºo
;

2791 ià(
”r
 !ð
NGX_EAGAIN
) {

2792 
»v
->
eof
 = 1;

2793 
c
->
”rÜ
 = 1;

2795 
þo£d
;

2801 ià((
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT
è&& 
»v
->
aùive
) {

2803 ià(
	`ngx_d–_ev’t
(
»v
, 
NGX_READ_EVENT
, 0è!ð
NGX_OK
) {

2804 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2810 
þo£d
:

2812 ià(
”r
) {

2813 
»v
->
”rÜ
 = 1;

2816 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
”r
,

2819 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

2820 
	}
}

2824 
	$ngx_h‰p_£t_k“·live
(
ngx_h‰p_»que¡_t
 *
r
)

2826 
tý_nod–ay
;

2827 
ngx_št_t
 
i
;

2828 
ngx_buf_t
 *
b
, *
f
;

2829 
ngx_ev’t_t
 *
»v
, *
wev
;

2830 
ngx_cÚÃùiÚ_t
 *
c
;

2831 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

2832 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2833 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2835 
c
 = 
r
->
cÚÃùiÚ
;

2836 
»v
 = 
c
->
»ad
;

2838 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2840 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "set http keepalive handler");

2842 ià(
r
->
disÿrd_body
) {

2843 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

2844 
r
->
lšg”šg_time
 = 
	`ngx_time
(è+ (
time_t
è(
þcf
->lingering_time / 1000);

2845 
	`ngx_add_tim”
(
»v
, 
þcf
->
lšg”šg_timeout
);

2849 
c
->
log
->
aùiÚ
 = "closing„equest";

2851 
hc
 = 
r
->
h‰p_cÚÃùiÚ
;

2852 
b
 = 
r
->
h—d”_š
;

2854 ià(
b
->
pos
 < b->
Ï¡
) {

2858 ià(
b
 !ð
c
->
bufãr
) {

2868 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2870 ià(
hc
->
ä“
 =ð
NULL
) {

2871 
hc
->
ä“
 = 
	`ngx_·Îoc
(
c
->
poÞ
,

2872 
cscf
->
Ïrge_þ›Á_h—d”_bufãrs
.
num
 * (
ngx_buf_t
 *));

2874 ià(
hc
->
ä“
 =ð
NULL
) {

2875 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

2880 
i
 = 0; i < 
hc
->
nbusy
 - 1; i++) {

2881 
f
 = 
hc
->
busy
[
i
];

2882 
hc
->
ä“
[hc->
nä“
++] = 
f
;

2883 
f
->
pos
 = f->
¡¬t
;

2884 
f
->
Ï¡
 = f->
¡¬t
;

2887 
hc
->
busy
[0] = 
b
;

2888 
hc
->
nbusy
 = 1;

2893 
r
->
k“·live
 = 0;

2895 
	`ngx_h‰p_ä“_»que¡
(
r
, 0);

2897 
c
->
d©a
 = 
hc
;

2899 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

2900 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

2904 
wev
 = 
c
->
wr™e
;

2905 
wev
->
hªdËr
 = 
ngx_h‰p_em±y_hªdËr
;

2907 ià(
b
->
pos
 < b->
Ï¡
) {

2909 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "pipelined„equest");

2911 
c
->
log
->
aùiÚ
 = "reading client…ipelined„equest†ine";

2913 
r
 = 
	`ngx_h‰p_ü—‹_»que¡
(
c
);

2914 ià(
r
 =ð
NULL
) {

2915 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

2919 
r
->
p–še
 = 1;

2921 
c
->
d©a
 = 
r
;

2923 
c
->
£Á
 = 0;

2924 
c
->
de¡royed
 = 0;

2926 ià(
»v
->
tim”_£t
) {

2927 
	`ngx_d–_tim”
(
»v
);

2930 
»v
->
hªdËr
 = 
ngx_h‰p_´oûss_»que¡_lše
;

2931 
	`ngx_po¡_ev’t
(
»v
, &
ngx_po¡ed_ev’ts
);

2942 
b
 = 
c
->
bufãr
;

2944 ià(
	`ngx_pä“
(
c
->
poÞ
, 
b
->
¡¬t
è=ð
NGX_OK
) {

2951 
b
->
pos
 = 
NULL
;

2954 
b
->
pos
 = b->
¡¬t
;

2955 
b
->
Ï¡
 = b->
¡¬t
;

2958 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "hc free: %p %d",

2959 
hc
->
ä“
, hc->
nä“
);

2961 ià(
hc
->
ä“
) {

2962 
i
 = 0; i < 
hc
->
nä“
; i++) {

2963 
	`ngx_pä“
(
c
->
poÞ
, 
hc
->
ä“
[
i
]->
¡¬t
);

2964 
hc
->
ä“
[
i
] = 
NULL
;

2967 
hc
->
nä“
 = 0;

2970 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "hc busy: %p %d",

2971 
hc
->
busy
, hc->
nbusy
);

2973 ià(
hc
->
busy
) {

2974 
i
 = 0; i < 
hc
->
nbusy
; i++) {

2975 
	`ngx_pä“
(
c
->
poÞ
, 
hc
->
busy
[
i
]->
¡¬t
);

2976 
hc
->
busy
[
i
] = 
NULL
;

2979 
hc
->
nbusy
 = 0;

2982 #ià(
NGX_HTTP_SSL
)

2983 ià(
c
->
s¦
) {

2984 
	`ngx_s¦_ä“_bufãr
(
c
);

2988 
»v
->
hªdËr
 = 
ngx_h‰p_k“·live_hªdËr
;

2990 ià(
wev
->
aùive
 && (
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT
)) {

2991 ià(
	`ngx_d–_ev’t
(
wev
, 
NGX_WRITE_EVENT
, 0è!ð
NGX_OK
) {

2992 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

2997 
c
->
log
->
aùiÚ
 = "keepalive";

2999 ià(
c
->
tý_nÝush
 =ð
NGX_TCP_NOPUSH_SET
) {

3000 ià(
	`ngx_tý_push
(
c
->
fd
) == -1) {

3001 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
, 
ngx_tý_push_n
 " failed");

3002 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3006 
c
->
tý_nÝush
 = 
NGX_TCP_NOPUSH_UNSET
;

3007 
tý_nod–ay
 = 
ngx_tý_nod–ay_ªd_tý_nÝush
 ? 1 : 0;

3010 
tý_nod–ay
 = 1;

3013 ià(
tý_nod–ay


3014 && 
þcf
->
tý_nod–ay


3015 && 
c
->
tý_nod–ay
 =ð
NGX_TCP_NODELAY_UNSET
)

3017 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "tcp_nodelay");

3019 ià(
	`£tsockÝt
(
c
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

3020 (cÚ¡ *è&
tý_nod–ay
, ())

3023 #ià(
NGX_SOLARIS
)

3025 
c
->
log_”rÜ
 = 
NGX_ERROR_IGNORE_EINVAL
;

3028 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
,

3031 
c
->
log_”rÜ
 = 
NGX_ERROR_INFO
;

3032 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3036 
c
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_SET
;

3041 
r
->
h‰p_¡©e
 = 
NGX_HTTP_KEEPALIVE_STATE
;

3044 
c
->
idË
 = 1;

3045 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 1);

3047 
	`ngx_add_tim”
(
»v
, 
þcf
->
k“·live_timeout
);

3049 ià(
»v
->
»ady
) {

3050 
	`ngx_po¡_ev’t
(
»v
, &
ngx_po¡ed_ev’ts
);

3052 
	}
}

3056 
	$ngx_h‰p_k“·live_hªdËr
(
ngx_ev’t_t
 *
»v
)

3058 
size_t
 
size
;

3059 
ssize_t
 
n
;

3060 
ngx_buf_t
 *
b
;

3061 
ngx_cÚÃùiÚ_t
 *
c
;

3063 
c
 = 
»v
->
d©a
;

3065 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "http keepalive handler");

3067 ià(
»v
->
timedout
 || 
c
->
þo£
) {

3068 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3072 #ià(
NGX_HAVE_KQUEUE
)

3074 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

3075 ià(
»v
->
³ndšg_eof
) {

3076 
c
->
log
->
hªdËr
 = 
NULL
;

3077 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
»v
->
kq_”ºo
,

3079 "k“·livcÚÃùiÚ", &
c
->
addr_‹xt
);

3080 #ià(
NGX_HTTP_SSL
)

3081 ià(
c
->
s¦
) {

3082 
c
->
s¦
->
no_£nd_shutdown
 = 1;

3085 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3092 
b
 = 
c
->
bufãr
;

3093 
size
 = 
b
->
’d
 - b->
¡¬t
;

3095 ià(
b
->
pos
 =ð
NULL
) {

3103 
b
->
pos
 = 
	`ngx_·Îoc
(
c
->
poÞ
, 
size
);

3104 ià(
b
->
pos
 =ð
NULL
) {

3105 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3109 
b
->
¡¬t
 = b->
pos
;

3110 
b
->
Ï¡
 = b->
pos
;

3111 
b
->
’d
 = b->
pos
 + 
size
;

3119 
c
->
log_”rÜ
 = 
NGX_ERROR_IGNORE_ECONNRESET
;

3120 
	`ngx_£t_sock‘_”ºo
(0);

3122 
n
 = 
c
->
	`»cv
(c, 
b
->
Ï¡
, 
size
);

3123 
c
->
log_”rÜ
 = 
NGX_ERROR_INFO
;

3125 ià(
n
 =ð
NGX_AGAIN
) {

3126 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

3127 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3136 ià(
	`ngx_pä“
(
c
->
poÞ
, 
b
->
¡¬t
è=ð
NGX_OK
) {

3142 
b
->
pos
 = 
NULL
;

3148 ià(
n
 =ð
NGX_ERROR
) {

3149 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3153 
c
->
log
->
hªdËr
 = 
NULL
;

3155 ià(
n
 == 0) {

3156 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
ngx_sock‘_”ºo
,

3157 "þ›Á %V clo£d k“·livcÚÃùiÚ", &
c
->
addr_‹xt
);

3158 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3162 
b
->
Ï¡
 +ð
n
;

3164 
c
->
log
->
hªdËr
 = 
ngx_h‰p_log_”rÜ
;

3165 
c
->
log
->
aùiÚ
 = "reading client„equest†ine";

3167 
c
->
idË
 = 0;

3168 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 0);

3170 
c
->
d©a
 = 
	`ngx_h‰p_ü—‹_»que¡
(c);

3171 ià(
c
->
d©a
 =ð
NULL
) {

3172 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3176 
c
->
£Á
 = 0;

3177 
c
->
de¡royed
 = 0;

3179 
	`ngx_d–_tim”
(
»v
);

3181 
»v
->
hªdËr
 = 
ngx_h‰p_´oûss_»que¡_lše
;

3182 
	`ngx_h‰p_´oûss_»que¡_lše
(
»v
);

3183 
	}
}

3187 
	$ngx_h‰p_£t_lšg”šg_þo£
(
ngx_h‰p_»que¡_t
 *
r
)

3189 
ngx_ev’t_t
 *
»v
, *
wev
;

3190 
ngx_cÚÃùiÚ_t
 *
c
;

3191 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3193 
c
 = 
r
->
cÚÃùiÚ
;

3195 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3197 
»v
 = 
c
->
»ad
;

3198 
»v
->
hªdËr
 = 
ngx_h‰p_lšg”šg_þo£_hªdËr
;

3200 
r
->
lšg”šg_time
 = 
	`ngx_time
(è+ (
time_t
è(
þcf
->lingering_time / 1000);

3201 
	`ngx_add_tim”
(
»v
, 
þcf
->
lšg”šg_timeout
);

3203 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

3204 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

3208 
wev
 = 
c
->
wr™e
;

3209 
wev
->
hªdËr
 = 
ngx_h‰p_em±y_hªdËr
;

3211 ià(
wev
->
aùive
 && (
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT
)) {

3212 ià(
	`ngx_d–_ev’t
(
wev
, 
NGX_WRITE_EVENT
, 0è!ð
NGX_OK
) {

3213 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

3218 ià(
	`ngx_shutdown_sock‘
(
c
->
fd
, 
NGX_WRITE_SHUTDOWN
) == -1) {

3219 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
,

3220 
ngx_shutdown_sock‘_n
 " failed");

3221 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

3225 ià(
»v
->
»ady
) {

3226 
	`ngx_h‰p_lšg”šg_þo£_hªdËr
(
»v
);

3228 
	}
}

3232 
	$ngx_h‰p_lšg”šg_þo£_hªdËr
(
ngx_ev’t_t
 *
»v
)

3234 
ssize_t
 
n
;

3235 
ngx_m£c_t
 
tim”
;

3236 
ngx_cÚÃùiÚ_t
 *
c
;

3237 
ngx_h‰p_»que¡_t
 *
r
;

3238 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3239 
u_ch¬
 
bufãr
[
NGX_HTTP_LINGERING_BUFFER_SIZE
];

3241 
c
 = 
»v
->
d©a
;

3242 
r
 = 
c
->
d©a
;

3244 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

3247 ià(
»v
->
timedout
) {

3248 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

3252 
tim”
 = (
ngx_m£c_t
è
r
->
lšg”šg_time
 - (ngx_m£c_tè
	`ngx_time
();

3253 ià((
ngx_m£c_št_t
è
tim”
 <= 0) {

3254 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

3259 
n
 = 
c
->
	`»cv
(c, 
bufãr
, 
NGX_HTTP_LINGERING_BUFFER_SIZE
);

3261 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "lšg”šg„—d: %d", 
n
);

3263 ià(
n
 =ð
NGX_ERROR
 ||‚ == 0) {

3264 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

3268 } 
»v
->
»ady
);

3270 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

3271 
	`ngx_h‰p_þo£_»que¡
(
r
, 0);

3275 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3277 
tim”
 *= 1000;

3279 ià(
tim”
 > 
þcf
->
lšg”šg_timeout
) {

3280 
tim”
 = 
þcf
->
lšg”šg_timeout
;

3283 
	`ngx_add_tim”
(
»v
, 
tim”
);

3284 
	}
}

3288 
	$ngx_h‰p_em±y_hªdËr
(
ngx_ev’t_t
 *
wev
)

3290 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
wev
->
log
, 0, "httpƒmpty handler");

3293 
	}
}

3297 
	$ngx_h‰p_»que¡_em±y_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

3299 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3303 
	}
}

3306 
ngx_št_t


3307 
	$ngx_h‰p_£nd_¥ecŸl
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
æags
)

3309 
ngx_buf_t
 *
b
;

3310 
ngx_chaš_t
 
out
;

3312 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

3313 ià(
b
 =ð
NULL
) {

3314  
NGX_ERROR
;

3317 ià(
æags
 & 
NGX_HTTP_LAST
) {

3319 ià(
r
 =ðr->
maš
 && !r->
po¡_aùiÚ
) {

3320 
b
->
Ï¡_buf
 = 1;

3323 
b
->
sync
 = 1;

3324 
b
->
Ï¡_š_chaš
 = 1;

3328 ià(
æags
 & 
NGX_HTTP_FLUSH
) {

3329 
b
->
æush
 = 1;

3332 
out
.
buf
 = 
b
;

3333 
out
.
Ãxt
 = 
NULL
;

3335  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

3336 
	}
}

3339 
ngx_št_t


3340 
	$ngx_h‰p_po¡_aùiÚ
(
ngx_h‰p_»que¡_t
 *
r
)

3342 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3344 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3346 ià(
þcf
->
po¡_aùiÚ
.
d©a
 =ð
NULL
) {

3347  
NGX_DECLINED
;

3350 ià(
r
->
po¡_aùiÚ
 &&„->
uri_chªges
 == 0) {

3351  
NGX_DECLINED
;

3354 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3355 "po¡‡ùiÚ: \"%V\"", &
þcf
->
po¡_aùiÚ
);

3357 
r
->
maš
->
couÁ
--;

3359 
r
->
h‰p_v”siÚ
 = 
NGX_HTTP_VERSION_9
;

3360 
r
->
h—d”_Úly
 = 1;

3361 
r
->
po¡_aùiÚ
 = 1;

3363 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_block_»adšg
;

3365 ià(
þcf
->
po¡_aùiÚ
.
d©a
[0] == '/') {

3366 
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
þcf
->
po¡_aùiÚ
, 
NULL
);

3369 
	`ngx_h‰p_Çmed_loÿtiÚ
(
r
, &
þcf
->
po¡_aùiÚ
);

3372  
NGX_OK
;

3373 
	}
}

3377 
	$ngx_h‰p_þo£_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

3379 
ngx_cÚÃùiÚ_t
 *
c
;

3381 
r
 =„->
maš
;

3382 
c
 = 
r
->
cÚÃùiÚ
;

3384 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

3385 "h‰°»que¡ couÁ:%d blk:%d", 
r
->
couÁ
,„->
blocked
);

3387 ià(
r
->
couÁ
 == 0) {

3388 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "http„equest count is zero");

3391 
r
->
couÁ
--;

3393 ià(
r
->
couÁ
 ||„->
blocked
) {

3397 #ià(
NGX_HTTP_SPDY
)

3398 ià(
r
->
¥dy_¡»am
) {

3399 
	`ngx_h‰p_¥dy_þo£_¡»am
(
r
->
¥dy_¡»am
, 
rc
);

3404 
	`ngx_h‰p_ä“_»que¡
(
r
, 
rc
);

3405 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3406 
	}
}

3410 
	$ngx_h‰p_ä“_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

3412 
ngx_log_t
 *
log
;

3413 
ngx_poÞ_t
 *
poÞ
;

3414 
lšg”
†inger;

3415 
ngx_h‰p_þ—nup_t
 *
þn
;

3416 
ngx_h‰p_log_ùx_t
 *
ùx
;

3417 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3419 
log
 = 
r
->
cÚÃùiÚ
->log;

3421 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
log
, 0, "http close„equest");

3423 ià(
r
->
poÞ
 =ð
NULL
) {

3424 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0, "http„equest‡lready closed");

3428 
þn
 = 
r
->
þ—nup
;

3429 
r
->
þ—nup
 = 
NULL
;

3431 
þn
) {

3432 ià(
þn
->
hªdËr
) {

3433 
þn
->
	`hªdËr
(þn->
d©a
);

3436 
þn
 = cÊ->
Ãxt
;

3439 #ià(
NGX_STAT_STUB
)

3441 ià(
r
->
¡©_»adšg
) {

3442 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_»adšg
, -1);

3445 ià(
r
->
¡©_wr™šg
) {

3446 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_wr™šg
, -1);

3451 ià(
rc
 > 0 && (
r
->
h—d”s_out
.
¡©us
 =ð0 ||„->
cÚÃùiÚ
->
£Á
 == 0)) {

3452 
r
->
h—d”s_out
.
¡©us
 = 
rc
;

3455 
log
->
aùiÚ
 = "logging„equest";

3457 
	`ngx_h‰p_log_»que¡
(
r
);

3459 
log
->
aùiÚ
 = "closing„equest";

3461 ià(
r
->
cÚÃùiÚ
->
timedout
) {

3462 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3464 ià(
þcf
->
»£t_timedout_cÚÃùiÚ
) {

3465 
lšg”
.
l_Úoff
 = 1;

3466 
lšg”
.
l_lšg”
 = 0;

3468 ià(
	`£tsockÝt
(
r
->
cÚÃùiÚ
->
fd
, 
SOL_SOCKET
, 
SO_LINGER
,

3469 (cÚ¡ *è&
lšg”
, (linger)) == -1)

3471 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_sock‘_”ºo
,

3478 
ùx
 = 
log
->
d©a
;

3479 
ùx
->
»que¡
 = 
NULL
;

3481 
r
->
»que¡_lše
.
Ën
 = 0;

3483 
r
->
cÚÃùiÚ
->
de¡royed
 = 1;

3490 
poÞ
 = 
r
->pool;

3491 
r
->
poÞ
 = 
NULL
;

3493 
	`ngx_de¡roy_poÞ
(
poÞ
);

3494 
	}
}

3498 
	$ngx_h‰p_log_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

3500 
ngx_ušt_t
 
i
, 
n
;

3501 
ngx_h‰p_hªdËr_±
 *
log_hªdËr
;

3502 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

3504 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3506 
log_hªdËr
 = 
cmcf
->
pha£s
[
NGX_HTTP_LOG_PHASE
].
hªdËrs
.
–ts
;

3507 
n
 = 
cmcf
->
pha£s
[
NGX_HTTP_LOG_PHASE
].
hªdËrs
.
ÃÉs
;

3509 
i
 = 0; i < 
n
; i++) {

3510 
log_hªdËr
[
i
](
r
);

3512 
	}
}

3516 
	$ngx_h‰p_þo£_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

3518 
ngx_poÞ_t
 *
poÞ
;

3520 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

3521 "þo£ h‰°cÚÃùiÚ: %d", 
c
->
fd
);

3523 #ià(
NGX_HTTP_SSL
)

3525 ià(
c
->
s¦
) {

3526 ià(
	`ngx_s¦_shutdown
(
c
è=ð
NGX_AGAIN
) {

3527 
c
->
s¦
->
hªdËr
 = 
ngx_h‰p_þo£_cÚÃùiÚ
;

3534 #ià(
NGX_STAT_STUB
)

3535 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_aùive
, -1);

3538 
c
->
de¡royed
 = 1;

3540 
poÞ
 = 
c
->pool;

3542 
	`ngx_þo£_cÚÃùiÚ
(
c
);

3544 
	`ngx_de¡roy_poÞ
(
poÞ
);

3545 
	}
}

3548 
u_ch¬
 *

3549 
	$ngx_h‰p_log_”rÜ
(
ngx_log_t
 *
log
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
)

3551 
u_ch¬
 *
p
;

3552 
ngx_h‰p_»que¡_t
 *
r
;

3553 
ngx_h‰p_log_ùx_t
 *
ùx
;

3555 ià(
log
->
aùiÚ
) {

3556 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, " whž%s", 
log
->
aùiÚ
);

3557 
Ën
 -ð
p
 - 
buf
;

3558 
buf
 = 
p
;

3561 
ùx
 = 
log
->
d©a
;

3563 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", cl›Á: %V", &
ùx
->
cÚÃùiÚ
->
addr_‹xt
);

3564 
Ën
 -ð
p
 - 
buf
;

3566 
r
 = 
ùx
->
»que¡
;

3568 ià(
r
) {

3569  
r
->
	`log_hªdËr
Ô, 
ùx
->
cu¼’t_»que¡
, 
p
, 
Ën
);

3572 
p
 = 
	`ngx_¢´štf
Õ, 
Ën
, ", server: %V",

3573 &
ùx
->
cÚÃùiÚ
->
li¡’šg
->
addr_‹xt
);

3576  
p
;

3577 
	}
}

3580 
u_ch¬
 *

3581 
	$ngx_h‰p_log_”rÜ_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,‚gx_h‰p_»que¡_ˆ*
¤
,

3582 
u_ch¬
 *
buf
, 
size_t
 
Ën
)

3584 *
uri_£·¿tÜ
;

3585 
u_ch¬
 *
p
;

3586 
ngx_h‰p_up¡»am_t
 *
u
;

3587 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

3589 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3591 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", s”v”: %V", &
cscf
->
£rv”_Çme
);

3592 
Ën
 -ð
p
 - 
buf
;

3593 
buf
 = 
p
;

3595 ià(
r
->
»que¡_lše
.
d©a
 =ð
NULL
 &&„->
»que¡_¡¬t
) {

3596 
p
 = 
r
->
»que¡_¡¬t
;… <„->
h—d”_š
->
Ï¡
;…++) {

3597 ià(*
p
 =ð
CR
 || *°=ð
LF
) {

3602 
r
->
»que¡_lše
.
Ën
 = 
p
 -„->
»que¡_¡¬t
;

3603 
r
->
»que¡_lše
.
d©a
 =„->
»que¡_¡¬t
;

3606 ià(
r
->
»que¡_lše
.
Ën
) {

3607 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ",„eque¡: \"%V\"", &
r
->
»que¡_lše
);

3608 
Ën
 -ð
p
 - 
buf
;

3609 
buf
 = 
p
;

3612 ià(
r
 !ð
¤
) {

3613 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", sub»que¡: \"%V\"", &
¤
->
uri
);

3614 
Ën
 -ð
p
 - 
buf
;

3615 
buf
 = 
p
;

3618 
u
 = 
¤
->
up¡»am
;

3620 ià(
u
 && u->
³”
.
Çme
) {

3622 
uri_£·¿tÜ
 = "";

3624 #ià(
NGX_HAVE_UNIX_DOMAIN
)

3625 ià(
u
->
³”
.
sockaddr
 && u->³”.sockaddr->
§_çmžy
 =ð
AF_UNIX
) {

3626 
uri_£·¿tÜ
 = ":";

3630 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", upstream: \"%V%V%s%V\"",

3631 &
u
->
schema
, u->
³”
.
Çme
,

3632 
uri_£·¿tÜ
, &
u
->
uri
);

3633 
Ën
 -ð
p
 - 
buf
;

3634 
buf
 = 
p
;

3637 ià(
r
->
h—d”s_š
.
ho¡
) {

3638 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", host: \"%V\"",

3639 &
r
->
h—d”s_š
.
ho¡
->
v®ue
);

3640 
Ën
 -ð
p
 - 
buf
;

3641 
buf
 = 
p
;

3644 ià(
r
->
h—d”s_š
.
»ã»r
) {

3645 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ",„eferrer: \"%V\"",

3646 &
r
->
h—d”s_š
.
»ã»r
->
v®ue
);

3647 
buf
 = 
p
;

3650  
buf
;

3651 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_request_body.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_h‰p_»ad_þ›Á_»que¡_body_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

14 
ngx_št_t
 
ngx_h‰p_do_»ad_þ›Á_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
);

15 
ngx_št_t
 
ngx_h‰p_wr™e_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
);

16 
ngx_št_t
 
ngx_h‰p_»ad_disÿrded_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
);

17 
ngx_št_t
 
ngx_h‰p_disÿrd_»que¡_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
,

18 
ngx_buf_t
 *
b
);

19 
ngx_št_t
 
ngx_h‰p_‹¡_ex³ù
(
ngx_h‰p_»que¡_t
 *
r
);

21 
ngx_št_t
 
ngx_h‰p_»que¡_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
,

22 
ngx_chaš_t
 *
š
);

23 
ngx_št_t
 
ngx_h‰p_»que¡_body_Ëngth_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
,

24 
ngx_chaš_t
 *
š
);

25 
ngx_št_t
 
ngx_h‰p_»que¡_body_chunked_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
,

26 
ngx_chaš_t
 *
š
);

27 
ngx_št_t
 
ngx_h‰p_»que¡_body_§ve_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
,

28 
ngx_chaš_t
 *
š
);

31 
ngx_št_t


32 
	$ngx_h‰p_»ad_þ›Á_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
,

33 
ngx_h‰p_þ›Á_body_hªdËr_±
 
po¡_hªdËr
)

35 
size_t
 
´”—d
;

36 
ssize_t
 
size
;

37 
ngx_št_t
 
rc
;

38 
ngx_buf_t
 *
b
;

39 
ngx_chaš_t
 
out
, *
þ
;

40 
ngx_h‰p_»que¡_body_t
 *
rb
;

41 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

43 
r
->
maš
->
couÁ
++;

45 #ià(
NGX_HTTP_SPDY
)

46 ià(
r
->
¥dy_¡»am
 &&„ =ðr->
maš
) {

47 
rc
 = 
	`ngx_h‰p_¥dy_»ad_»que¡_body
(
r
, 
po¡_hªdËr
);

48 
dÚe
;

52 ià(
r
 !ðr->
maš
 ||„->
»que¡_body
 ||„->
disÿrd_body
) {

53 
	`po¡_hªdËr
(
r
);

54  
NGX_OK
;

57 ià(
	`ngx_h‰p_‹¡_ex³ù
(
r
è!ð
NGX_OK
) {

58 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

59 
dÚe
;

62 
rb
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_»que¡_body_t
));

63 ià(
rb
 =ð
NULL
) {

64 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

65 
dÚe
;

78 
rb
->
»¡
 = -1;

79 
rb
->
po¡_hªdËr
 =…ost_handler;

81 
r
->
»que¡_body
 = 
rb
;

83 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 < 0 && !r->h—d”s_š.
chunked
) {

84 
	`po¡_hªdËr
(
r
);

85  
NGX_OK
;

88 
´”—d
 = 
r
->
h—d”_š
->
Ï¡
 -„->h—d”_š->
pos
;

90 ià(
´”—d
) {

94 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

95 "h‰°þ›Á„eque¡ body…»»ad %uz", 
´”—d
);

97 
out
.
buf
 = 
r
->
h—d”_š
;

98 
out
.
Ãxt
 = 
NULL
;

100 
rc
 = 
	`ngx_h‰p_»que¡_body_fž‹r
(
r
, &
out
);

102 ià(
rc
 !ð
NGX_OK
) {

103 
dÚe
;

106 
r
->
»que¡_Ëngth
 +ð
´”—d
 - (r->
h—d”_š
->
Ï¡
 -„->h—d”_š->
pos
);

108 ià(!
r
->
h—d”s_š
.
chunked


109 && 
rb
->
»¡
 > 0

110 && 
rb
->
»¡
 <ð(
off_t
è(
r
->
h—d”_š
->
’d
 -„->h—d”_š->
Ï¡
))

114 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

115 ià(
b
 =ð
NULL
) {

116 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

117 
dÚe
;

120 
b
->
‹mpÜ¬y
 = 1;

121 
b
->
¡¬t
 = 
r
->
h—d”_š
->
pos
;

122 
b
->
pos
 = 
r
->
h—d”_š
->pos;

123 
b
->
Ï¡
 = 
r
->
h—d”_š
->last;

124 
b
->
’d
 = 
r
->
h—d”_š
->end;

126 
rb
->
buf
 = 
b
;

128 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_»ad_þ›Á_»que¡_body_hªdËr
;

129 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

131 
rc
 = 
	`ngx_h‰p_do_»ad_þ›Á_»que¡_body
(
r
);

132 
dÚe
;

138 ià(
	`ngx_h‰p_»que¡_body_fž‹r
(
r
, 
NULL
è!ð
NGX_OK
) {

139 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

140 
dÚe
;

144 ià(
rb
->
»¡
 == 0) {

147 ià(
r
->
»que¡_body_š_fže_Úly
) {

148 ià(
	`ngx_h‰p_wr™e_»que¡_body
(
r
è!ð
NGX_OK
) {

149 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

150 
dÚe
;

153 ià(
rb
->
‹mp_fže
->
fže
.
off£t
 != 0) {

155 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
rb
->
ä“
);

156 ià(
þ
 =ð
NULL
) {

157 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

158 
dÚe
;

161 
b
 = 
þ
->
buf
;

163 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

165 
b
->
š_fže
 = 1;

166 
b
->
fže_Ï¡
 = 
rb
->
‹mp_fže
->
fže
.
off£t
;

167 
b
->
fže
 = &
rb
->
‹mp_fže
->file;

169 
rb
->
bufs
 = 
þ
;

172 
rb
->
bufs
 = 
NULL
;

176 
	`po¡_hªdËr
(
r
);

178  
NGX_OK
;

181 ià(
rb
->
»¡
 < 0) {

182 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

184 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

185 
dÚe
;

188 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

190 
size
 = 
þcf
->
þ›Á_body_bufãr_size
;

191 
size
 += size >> 2;

195 ià(!
r
->
h—d”s_š
.
chunked
 && 
rb
->
»¡
 < 
size
) {

196 
size
 = (
ssize_t
è
rb
->
»¡
;

198 ià(
r
->
»que¡_body_š_sšgË_buf
) {

199 
size
 +ð
´”—d
;

203 
size
 = 
þcf
->
þ›Á_body_bufãr_size
;

206 
rb
->
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
size
);

207 ià(
rb
->
buf
 =ð
NULL
) {

208 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

209 
dÚe
;

212 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_»ad_þ›Á_»que¡_body_hªdËr
;

213 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

215 
rc
 = 
	`ngx_h‰p_do_»ad_þ›Á_»que¡_body
(
r
);

217 
dÚe
:

219 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

220 
r
->
maš
->
couÁ
--;

223  
rc
;

224 
	}
}

228 
	$ngx_h‰p_»ad_þ›Á_»que¡_body_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

230 
ngx_št_t
 
rc
;

232 ià(
r
->
cÚÃùiÚ
->
»ad
->
timedout
) {

233 
r
->
cÚÃùiÚ
->
timedout
 = 1;

234 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_REQUEST_TIME_OUT
);

238 
rc
 = 
	`ngx_h‰p_do_»ad_þ›Á_»que¡_body
(
r
);

240 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

241 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

243 
	}
}

246 
ngx_št_t


247 
	$ngx_h‰p_do_»ad_þ›Á_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
)

249 
off_t
 
»¡
;

250 
size_t
 
size
;

251 
ssize_t
 
n
;

252 
ngx_št_t
 
rc
;

253 
ngx_buf_t
 *
b
;

254 
ngx_chaš_t
 *
þ
, 
out
;

255 
ngx_cÚÃùiÚ_t
 *
c
;

256 
ngx_h‰p_»que¡_body_t
 *
rb
;

257 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

259 
c
 = 
r
->
cÚÃùiÚ
;

260 
rb
 = 
r
->
»que¡_body
;

262 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

267 ià(
rb
->
buf
->
Ï¡
 =ðrb->buf->
’d
) {

271 
out
.
buf
 = 
rb
->buf;

272 
out
.
Ãxt
 = 
NULL
;

274 
rc
 = 
	`ngx_h‰p_»que¡_body_fž‹r
(
r
, &
out
);

276 ià(
rc
 !ð
NGX_OK
) {

277  
rc
;

282 ià(
	`ngx_h‰p_wr™e_»que¡_body
(
r
è!ð
NGX_OK
) {

283  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

288 
rc
 = 
	`ngx_h‰p_»que¡_body_fž‹r
(
r
, 
NULL
);

290 ià(
rc
 !ð
NGX_OK
) {

291  
rc
;

294 ià(
rb
->
busy
 !ð
NULL
) {

295  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

298 
rb
->
buf
->
pos
 =„b->buf->
¡¬t
;

299 
rb
->
buf
->
Ï¡
 =„b->buf->
¡¬t
;

302 
size
 = 
rb
->
buf
->
’d
 -„b->buf->
Ï¡
;

303 
»¡
 = 
rb
->»¡ - (rb->
buf
->
Ï¡
 -„b->buf->
pos
);

305 ià((
off_t
è
size
 > 
»¡
) {

306 
size
 = (
size_t
è
»¡
;

309 
n
 = 
c
->
	`»cv
(c, 
rb
->
buf
->
Ï¡
, 
size
);

311 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

312 "h‰°þ›Á„eque¡ body„ecv %z", 
n
);

314 ià(
n
 =ð
NGX_AGAIN
) {

318 ià(
n
 == 0) {

319 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

323 ià(
n
 =ð0 ||‚ =ð
NGX_ERROR
) {

324 
c
->
”rÜ
 = 1;

325  
NGX_HTTP_BAD_REQUEST
;

328 
rb
->
buf
->
Ï¡
 +ð
n
;

329 
r
->
»que¡_Ëngth
 +ð
n
;

331 ià(
n
 =ð
»¡
) {

334 
out
.
buf
 = 
rb
->buf;

335 
out
.
Ãxt
 = 
NULL
;

337 
rc
 = 
	`ngx_h‰p_»que¡_body_fž‹r
(
r
, &
out
);

339 ià(
rc
 !ð
NGX_OK
) {

340  
rc
;

344 ià(
rb
->
»¡
 == 0) {

348 ià(
rb
->
buf
->
Ï¡
 <„b->buf->
’d
) {

353 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

354 "h‰°þ›Á„eque¡ body„e¡ %O", 
rb
->
»¡
);

356 ià(
rb
->
»¡
 == 0) {

360 ià(!
c
->
»ad
->
»ady
) {

361 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

362 
	`ngx_add_tim”
(
c
->
»ad
, 
þcf
->
þ›Á_body_timeout
);

364 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

365  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

368  
NGX_AGAIN
;

372 ià(
c
->
»ad
->
tim”_£t
) {

373 
	`ngx_d–_tim”
(
c
->
»ad
);

376 ià(
rb
->
‹mp_fže
 || 
r
->
»que¡_body_š_fže_Úly
) {

380 ià(
	`ngx_h‰p_wr™e_»que¡_body
(
r
è!ð
NGX_OK
) {

381  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

384 ià(
rb
->
‹mp_fže
->
fže
.
off£t
 != 0) {

386 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
rb
->
ä“
);

387 ià(
þ
 =ð
NULL
) {

388  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

391 
b
 = 
þ
->
buf
;

393 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

395 
b
->
š_fže
 = 1;

396 
b
->
fže_Ï¡
 = 
rb
->
‹mp_fže
->
fže
.
off£t
;

397 
b
->
fže
 = &
rb
->
‹mp_fže
->file;

399 
rb
->
bufs
 = 
þ
;

402 
rb
->
bufs
 = 
NULL
;

406 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_block_»adšg
;

408 
rb
->
	`po¡_hªdËr
(
r
);

410  
NGX_OK
;

411 
	}
}

414 
ngx_št_t


415 
	$ngx_h‰p_wr™e_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
)

417 
ssize_t
 
n
;

418 
ngx_chaš_t
 *
þ
;

419 
ngx_‹mp_fže_t
 *
tf
;

420 
ngx_h‰p_»que¡_body_t
 *
rb
;

421 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

423 
rb
 = 
r
->
»que¡_body
;

425 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

426 "h‰°wr™þ›Á„eque¡ body, buf %p", 
rb
->
bufs
);

428 ià(
rb
->
‹mp_fže
 =ð
NULL
) {

429 
tf
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_‹mp_fže_t
));

430 ià(
tf
 =ð
NULL
) {

431  
NGX_ERROR
;

434 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

436 
tf
->
fže
.
fd
 = 
NGX_INVALID_FILE
;

437 
tf
->
fže
.
log
 = 
r
->
cÚÃùiÚ
->log;

438 
tf
->
·th
 = 
þcf
->
þ›Á_body_‹mp_·th
;

439 
tf
->
poÞ
 = 
r
->pool;

440 
tf
->
w¬n
 = "a client„equest body is bufferedo‡emporary file";

441 
tf
->
log_Ëv–
 = 
r
->
»que¡_body_fže_log_Ëv–
;

442 
tf
->
³rsi¡’t
 = 
r
->
»que¡_body_š_³rsi¡’t_fže
;

443 
tf
->
þ—n
 = 
r
->
»que¡_body_š_þ—n_fže
;

445 ià(
r
->
»que¡_body_fže_group_acûss
) {

446 
tf
->
acûss
 = 0660;

449 
rb
->
‹mp_fže
 = 
tf
;

451 ià(
rb
->
bufs
 =ð
NULL
) {

454 ià(
	`ngx_ü—‹_‹mp_fže
(&
tf
->
fže
,f->
·th
,f->
poÞ
,

455 
tf
->
³rsi¡’t
,f->
þ—n
,f->
acûss
)

456 !ð
NGX_OK
)

458  
NGX_ERROR
;

461  
NGX_OK
;

465 ià(
rb
->
bufs
 =ð
NULL
) {

466  
NGX_OK
;

469 
n
 = 
	`ngx_wr™e_chaš_to_‹mp_fže
(
rb
->
‹mp_fže
,„b->
bufs
);

473 ià(
n
 =ð
NGX_ERROR
) {

474  
NGX_ERROR
;

477 
rb
->
‹mp_fže
->
off£t
 +ð
n
;

481 
þ
 = 
rb
->
bufs
; cl; cÈðþ->
Ãxt
) {

482 
þ
->
buf
->
pos
 = cl->buf->
Ï¡
;

485 
rb
->
bufs
 = 
NULL
;

487  
NGX_OK
;

488 
	}
}

491 
ngx_št_t


492 
	$ngx_h‰p_disÿrd_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
)

494 
ssize_t
 
size
;

495 
ngx_št_t
 
rc
;

496 
ngx_ev’t_t
 *
»v
;

498 #ià(
NGX_HTTP_SPDY
)

499 ià(
r
->
¥dy_¡»am
 &&„ =ðr->
maš
) {

500 
r
->
¥dy_¡»am
->
sk_d©a
 = 
NGX_SPDY_DATA_DISCARD
;

501  
NGX_OK
;

505 ià(
r
 !ðr->
maš
 ||„->
disÿrd_body
 ||„->
»que¡_body
) {

506  
NGX_OK
;

509 ià(
	`ngx_h‰p_‹¡_ex³ù
(
r
è!ð
NGX_OK
) {

510  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

513 
»v
 = 
r
->
cÚÃùiÚ
->
»ad
;

515 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
»v
->
log
, 0, "http set discard body");

517 ià(
»v
->
tim”_£t
) {

518 
	`ngx_d–_tim”
(
»v
);

521 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 <ð0 && !r->h—d”s_š.
chunked
) {

522  
NGX_OK
;

525 
size
 = 
r
->
h—d”_š
->
Ï¡
 -„->h—d”_š->
pos
;

527 ià(
size
 || 
r
->
h—d”s_š
.
chunked
) {

528 
rc
 = 
	`ngx_h‰p_disÿrd_»que¡_body_fž‹r
(
r
,„->
h—d”_š
);

530 ià(
rc
 !ð
NGX_OK
) {

531  
rc
;

534 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 == 0) {

535  
NGX_OK
;

539 
rc
 = 
	`ngx_h‰p_»ad_disÿrded_»que¡_body
(
r
);

541 ià(
rc
 =ð
NGX_OK
) {

542 
r
->
lšg”šg_þo£
 = 0;

543  
NGX_OK
;

546 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

547  
rc
;

552 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_disÿrded_»que¡_body_hªdËr
;

554 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

555  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

558 
r
->
couÁ
++;

559 
r
->
disÿrd_body
 = 1;

561  
NGX_OK
;

562 
	}
}

566 
	$ngx_h‰p_disÿrded_»que¡_body_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

568 
ngx_št_t
 
rc
;

569 
ngx_m£c_t
 
tim”
;

570 
ngx_ev’t_t
 *
»v
;

571 
ngx_cÚÃùiÚ_t
 *
c
;

572 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

574 
c
 = 
r
->
cÚÃùiÚ
;

575 
»v
 = 
c
->
»ad
;

577 ià(
»v
->
timedout
) {

578 
c
->
timedout
 = 1;

579 
c
->
”rÜ
 = 1;

580 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_ERROR
);

584 ià(
r
->
lšg”šg_time
) {

585 
tim”
 = (
ngx_m£c_t
è
r
->
lšg”šg_time
 - (ngx_m£c_tè
	`ngx_time
();

587 ià((
ngx_m£c_št_t
è
tim”
 <= 0) {

588 
r
->
disÿrd_body
 = 0;

589 
r
->
lšg”šg_þo£
 = 0;

590 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_ERROR
);

595 
tim”
 = 0;

598 
rc
 = 
	`ngx_h‰p_»ad_disÿrded_»que¡_body
(
r
);

600 ià(
rc
 =ð
NGX_OK
) {

601 
r
->
disÿrd_body
 = 0;

602 
r
->
lšg”šg_þo£
 = 0;

603 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_DONE
);

607 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

608 
c
->
”rÜ
 = 1;

609 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_ERROR
);

615 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

616 
c
->
”rÜ
 = 1;

617 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_ERROR
);

621 ià(
tim”
) {

623 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

625 
tim”
 *= 1000;

627 ià(
tim”
 > 
þcf
->
lšg”šg_timeout
) {

628 
tim”
 = 
þcf
->
lšg”šg_timeout
;

631 
	`ngx_add_tim”
(
»v
, 
tim”
);

633 
	}
}

636 
ngx_št_t


637 
	$ngx_h‰p_»ad_disÿrded_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
)

639 
size_t
 
size
;

640 
ssize_t
 
n
;

641 
ngx_št_t
 
rc
;

642 
ngx_buf_t
 
b
;

643 
u_ch¬
 
bufãr
[
NGX_HTTP_DISCARD_BUFFER_SIZE
];

645 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

648 
	`ngx_memz”o
(&
b
, (
ngx_buf_t
));

650 
b
.
‹mpÜ¬y
 = 1;

653 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 == 0) {

654 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_block_»adšg
;

655  
NGX_OK
;

658 ià(!
r
->
cÚÃùiÚ
->
»ad
->
»ady
) {

659  
NGX_AGAIN
;

662 
size
 = (
size_t
è
	`ngx_mš
(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
,

663 
NGX_HTTP_DISCARD_BUFFER_SIZE
);

665 
n
 = 
r
->
cÚÃùiÚ
->
	`»cv
Ô->cÚÃùiÚ, 
bufãr
, 
size
);

667 ià(
n
 =ð
NGX_ERROR
) {

668 
r
->
cÚÃùiÚ
->
”rÜ
 = 1;

669  
NGX_OK
;

672 ià(
n
 =ð
NGX_AGAIN
) {

673  
NGX_AGAIN
;

676 ià(
n
 == 0) {

677  
NGX_OK
;

680 
b
.
pos
 = 
bufãr
;

681 
b
.
Ï¡
 = 
bufãr
 + 
n
;

683 
rc
 = 
	`ngx_h‰p_disÿrd_»que¡_body_fž‹r
(
r
, &
b
);

685 ià(
rc
 !ð
NGX_OK
) {

686  
rc
;

689 
	}
}

692 
ngx_št_t


693 
	$ngx_h‰p_disÿrd_»que¡_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_buf_t
 *
b
)

695 
size_t
 
size
;

696 
ngx_št_t
 
rc
;

697 
ngx_h‰p_»que¡_body_t
 *
rb
;

699 ià(
r
->
h—d”s_š
.
chunked
) {

701 
rb
 = 
r
->
»que¡_body
;

703 ià(
rb
 =ð
NULL
) {

705 
rb
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_»que¡_body_t
));

706 ià(
rb
 =ð
NULL
) {

707  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

710 
rb
->
chunked
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_chunked_t
));

711 ià(
rb
->
chunked
 =ð
NULL
) {

712  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

715 
r
->
»que¡_body
 = 
rb
;

720 
rc
 = 
	`ngx_h‰p_·r£_chunked
(
r
, 
b
, 
rb
->
chunked
);

722 ià(
rc
 =ð
NGX_OK
) {

726 
size
 = 
b
->
Ï¡
 - b->
pos
;

728 ià((
off_t
è
size
 > 
rb
->
chunked
->size) {

729 
b
->
pos
 +ð(
size_t
è
rb
->
chunked
->
size
;

730 
rb
->
chunked
->
size
 = 0;

733 
rb
->
chunked
->
size
 -= size;

734 
b
->
pos
 = b->
Ï¡
;

740 ià(
rc
 =ð
NGX_DONE
) {

744 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = 0;

748 ià(
rc
 =ð
NGX_AGAIN
) {

752 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = 
rb
->
chunked
->
Ëngth
;

758 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

761  
NGX_HTTP_BAD_REQUEST
;

765 
size
 = 
b
->
Ï¡
 - b->
pos
;

767 ià((
off_t
è
size
 > 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
) {

768 
b
->
pos
 +ð(
size_t
è
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
;

769 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = 0;

772 
b
->
pos
 = b->
Ï¡
;

773 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 -ð
size
;

777  
NGX_OK
;

778 
	}
}

781 
ngx_št_t


782 
	$ngx_h‰p_‹¡_ex³ù
(
ngx_h‰p_»que¡_t
 *
r
)

784 
ngx_št_t
 
n
;

785 
ngx_¡r_t
 *
ex³ù
;

787 ià(
r
->
ex³ù_‹¡ed


788 || 
r
->
h—d”s_š
.
ex³ù
 =ð
NULL


789 || 
r
->
h‰p_v”siÚ
 < 
NGX_HTTP_VERSION_11
)

791  
NGX_OK
;

794 
r
->
ex³ù_‹¡ed
 = 1;

796 
ex³ù
 = &
r
->
h—d”s_š
.ex³ù->
v®ue
;

798 ià(
ex³ù
->
Ën
 != ("100-continue") - 1

799 || 
	`ngx_¡ºÿ£cmp
(
ex³ù
->
d©a
, (
u_ch¬
 *) "100-continue",

803  
NGX_OK
;

806 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

809 
n
 = 
r
->
cÚÃùiÚ
->
	`£nd
(r->connection,

810 (
u_ch¬
 *è"HTTP/1.1 100 CÚtšue" 
CRLF
 CRLF,

811 ("HTTP/1.1 100 CÚtšue" 
CRLF
 CRLF) - 1);

813 ià(
n
 =ð("HTTP/1.1 100 CÚtšue" 
CRLF
 CRLF) - 1) {

814  
NGX_OK
;

819  
NGX_ERROR
;

820 
	}
}

823 
ngx_št_t


824 
	$ngx_h‰p_»que¡_body_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

826 ià(
r
->
h—d”s_š
.
chunked
) {

827  
	`ngx_h‰p_»que¡_body_chunked_fž‹r
(
r
, 
š
);

830  
	`ngx_h‰p_»que¡_body_Ëngth_fž‹r
(
r
, 
š
);

832 
	}
}

835 
ngx_št_t


836 
	$ngx_h‰p_»que¡_body_Ëngth_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

838 
size_t
 
size
;

839 
ngx_št_t
 
rc
;

840 
ngx_buf_t
 *
b
;

841 
ngx_chaš_t
 *
þ
, *
Ž
, *
out
, **
Î
;

842 
ngx_h‰p_»que¡_body_t
 *
rb
;

844 
rb
 = 
r
->
»que¡_body
;

846 ià(
rb
->
»¡
 == -1) {

847 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

850 
rb
->
»¡
 = 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
;

853 
out
 = 
NULL
;

854 
Î
 = &
out
;

856 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

858 ià(
rb
->
»¡
 == 0) {

862 
Ž
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
rb
->
ä“
);

863 ià(
Ž
 =ð
NULL
) {

864  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

867 
b
 = 
Ž
->
buf
;

869 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

871 
b
->
‹mpÜ¬y
 = 1;

872 
b
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_»ad_þ›Á_»que¡_body
;

873 
b
->
¡¬t
 = 
þ
->
buf
->
pos
;

874 
b
->
pos
 = 
þ
->
buf
->pos;

875 
b
->
Ï¡
 = 
þ
->
buf
->last;

876 
b
->
’d
 = 
þ
->
buf
->end;

878 
size
 = 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

880 ià((
off_t
è
size
 < 
rb
->
»¡
) {

881 
þ
->
buf
->
pos
 = cl->buf->
Ï¡
;

882 
rb
->
»¡
 -ð
size
;

885 
þ
->
buf
->
pos
 +ð(
size_t
è
rb
->
»¡
;

886 
rb
->
»¡
 = 0;

887 
b
->
Ï¡
 = 
þ
->
buf
->
pos
;

888 
b
->
Ï¡_buf
 = 1;

891 *
Î
 = 
Ž
;

892 
Î
 = &
Ž
->
Ãxt
;

895 
rc
 = 
	`ngx_h‰p_»que¡_body_§ve_fž‹r
(
r
, 
out
);

897 
	`ngx_chaš_upd©e_chašs
(
r
->
poÞ
, &
rb
->
ä“
, &rb->
busy
, &
out
,

898 (
ngx_buf_g_t
è&
ngx_h‰p_»ad_þ›Á_»que¡_body
);

900  
rc
;

901 
	}
}

904 
ngx_št_t


905 
	$ngx_h‰p_»que¡_body_chunked_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

907 
size_t
 
size
;

908 
ngx_št_t
 
rc
;

909 
ngx_buf_t
 *
b
;

910 
ngx_chaš_t
 *
þ
, *
out
, *
Ž
, **
Î
;

911 
ngx_h‰p_»que¡_body_t
 *
rb
;

912 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

914 
rb
 = 
r
->
»que¡_body
;

916 ià(
rb
->
»¡
 == -1) {

918 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

921 
rb
->
chunked
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_chunked_t
));

922 ià(
rb
->
chunked
 =ð
NULL
) {

923  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

926 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = 0;

927 
rb
->
»¡
 = 3;

930 
out
 = 
NULL
;

931 
Î
 = &
out
;

933 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

937 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_EVENT
, 
r
->
cÚÃùiÚ
->
log
, 0,

940 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

941 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

942 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

943 
þ
->
buf
->
fže_pos
,

944 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

946 
rc
 = 
	`ngx_h‰p_·r£_chunked
(
r
, 
þ
->
buf
, 
rb
->
chunked
);

948 ià(
rc
 =ð
NGX_OK
) {

952 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

954 ià(
þcf
->
þ›Á_max_body_size


955 && 
þcf
->
þ›Á_max_body_size


956 - 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 < 
rb
->
chunked
->
size
)

958 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

961 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
,

962 
rb
->
chunked
->
size
);

964 
r
->
lšg”šg_þo£
 = 1;

966  
NGX_HTTP_REQUEST_ENTITY_TOO_LARGE
;

969 
Ž
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
rb
->
ä“
);

970 ià(
Ž
 =ð
NULL
) {

971  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

974 
b
 = 
Ž
->
buf
;

976 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

978 
b
->
‹mpÜ¬y
 = 1;

979 
b
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_»ad_þ›Á_»que¡_body
;

980 
b
->
¡¬t
 = 
þ
->
buf
->
pos
;

981 
b
->
pos
 = 
þ
->
buf
->pos;

982 
b
->
Ï¡
 = 
þ
->
buf
->last;

983 
b
->
’d
 = 
þ
->
buf
->end;

985 *
Î
 = 
Ž
;

986 
Î
 = &
Ž
->
Ãxt
;

988 
size
 = 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

990 ià((
off_t
è
size
 > 
rb
->
chunked
->size) {

991 
þ
->
buf
->
pos
 +ð(
size_t
è
rb
->
chunked
->
size
;

992 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 +ð
rb
->
chunked
->
size
;

993 
rb
->
chunked
->
size
 = 0;

996 
rb
->
chunked
->
size
 -= size;

997 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 +ð
size
;

998 
þ
->
buf
->
pos
 = cl->buf->
Ï¡
;

1001 
b
->
Ï¡
 = 
þ
->
buf
->
pos
;

1006 ià(
rc
 =ð
NGX_DONE
) {

1010 
rb
->
»¡
 = 0;

1012 
Ž
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
rb
->
ä“
);

1013 ià(
Ž
 =ð
NULL
) {

1014  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1017 
b
 = 
Ž
->
buf
;

1019 
	`ngx_memz”o
(
b
, (
ngx_buf_t
));

1021 
b
->
Ï¡_buf
 = 1;

1023 *
Î
 = 
Ž
;

1024 
Î
 = &
Ž
->
Ãxt
;

1029 ià(
rc
 =ð
NGX_AGAIN
) {

1033 
rb
->
»¡
 =„b->
chunked
->
Ëngth
;

1040 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1043  
NGX_HTTP_BAD_REQUEST
;

1047 
rc
 = 
	`ngx_h‰p_»que¡_body_§ve_fž‹r
(
r
, 
out
);

1049 
	`ngx_chaš_upd©e_chašs
(
r
->
poÞ
, &
rb
->
ä“
, &rb->
busy
, &
out
,

1050 (
ngx_buf_g_t
è&
ngx_h‰p_»ad_þ›Á_»que¡_body
);

1052  
rc
;

1053 
	}
}

1056 
ngx_št_t


1057 
	$ngx_h‰p_»que¡_body_§ve_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

1059 #ià(
NGX_DEBUG
)

1060 
ngx_chaš_t
 *
þ
;

1062 
ngx_h‰p_»que¡_body_t
 *
rb
;

1064 
rb
 = 
r
->
»que¡_body
;

1066 #ià(
NGX_DEBUG
)

1068 
þ
 = 
rb
->
bufs
; cl; cÈðþ->
Ãxt
) {

1069 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_EVENT
, 
r
->
cÚÃùiÚ
->
log
, 0,

1072 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

1073 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

1074 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

1075 
þ
->
buf
->
fže_pos
,

1076 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

1079 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

1080 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_EVENT
, 
r
->
cÚÃùiÚ
->
log
, 0,

1083 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

1084 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

1085 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

1086 
þ
->
buf
->
fže_pos
,

1087 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

1094 ià(
	`ngx_chaš_add_cÝy
(
r
->
poÞ
, &
rb
->
bufs
, 
š
è!ð
NGX_OK
) {

1095  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1098  
NGX_OK
;

1099 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_script.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_št_t
 
ngx_h‰p_süt_š™_¬¿ys
(
ngx_h‰p_süt_compže_t
 *
sc
);

14 
ngx_št_t
 
ngx_h‰p_süt_dÚe
(
ngx_h‰p_süt_compže_t
 *
sc
);

15 
ngx_št_t
 
ngx_h‰p_süt_add_cÝy_code
(
ngx_h‰p_süt_compže_t
 *
sc
,

16 
ngx_¡r_t
 *
v®ue
, 
ngx_ušt_t
 
Ï¡
);

17 
ngx_št_t
 
ngx_h‰p_süt_add_v¬_code
(
ngx_h‰p_süt_compže_t
 *
sc
,

18 
ngx_¡r_t
 *
Çme
);

19 
ngx_št_t
 
ngx_h‰p_süt_add_¬gs_code
(
ngx_h‰p_süt_compže_t
 *
sc
);

20 #ià(
NGX_PCRE
)

21 
ngx_št_t
 
ngx_h‰p_süt_add_ÿ±u»_code
(
ngx_h‰p_süt_compže_t
 *
sc
,

22 
ngx_ušt_t
 
n
);

24 
ngx_št_t


25 
ngx_h‰p_süt_add_fuÎ_Çme_code
(
ngx_h‰p_süt_compže_t
 *
sc
);

26 
size_t
 
ngx_h‰p_süt_fuÎ_Çme_Ën_code
(
ngx_h‰p_süt_’gše_t
 *
e
);

27 
ngx_h‰p_süt_fuÎ_Çme_code
(
ngx_h‰p_süt_’gše_t
 *
e
);

30 
	#ngx_h‰p_süt_ex™
 (
u_ch¬
 *è&
ngx_h‰p_süt_ex™_code


	)

32 
ušŒ_t
 
	gngx_h‰p_süt_ex™_code
 = (ušŒ_tè
NULL
;

36 
	$ngx_h‰p_süt_æush_com¶ex_v®ue
(
ngx_h‰p_»que¡_t
 *
r
,

37 
ngx_h‰p_com¶ex_v®ue_t
 *
v®
)

39 
ngx_ušt_t
 *
šdex
;

41 
šdex
 = 
v®
->
æushes
;

43 ià(
šdex
) {

44 *
šdex
 !ð(
ngx_ušt_t
) -1) {

46 ià(
r
->
v¬ŸbËs
[*
šdex
].
no_ÿch—bË
) {

47 
r
->
v¬ŸbËs
[*
šdex
].
v®id
 = 0;

48 
r
->
v¬ŸbËs
[*
šdex
].
nÙ_found
 = 0;

51 
šdex
++;

54 
	}
}

57 
ngx_št_t


58 
	$ngx_h‰p_com¶ex_v®ue
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_com¶ex_v®ue_t
 *
v®
,

59 
ngx_¡r_t
 *
v®ue
)

61 
size_t
 
Ën
;

62 
ngx_h‰p_süt_code_±
 
code
;

63 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

64 
ngx_h‰p_süt_’gše_t
 
e
;

66 ià(
v®
->
Ëngths
 =ð
NULL
) {

67 *
v®ue
 = 
v®
->value;

68  
NGX_OK
;

71 
	`ngx_h‰p_süt_æush_com¶ex_v®ue
(
r
, 
v®
);

73 
	`ngx_memz”o
(&
e
, (
ngx_h‰p_süt_’gše_t
));

75 
e
.

 = 
v®
->
Ëngths
;

76 
e
.
»que¡
 = 
r
;

77 
e
.
æushed
 = 1;

79 
Ën
 = 0;

81 *(
ušŒ_t
 *è
e
.

) {

82 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
e
.

;

83 
Ën
 +ð
	`lcode
(&
e
);

86 
v®ue
->
Ën
 =†en;

87 
v®ue
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

88 ià(
v®ue
->
d©a
 =ð
NULL
) {

89  
NGX_ERROR
;

92 
e
.

 = 
v®
->
v®ues
;

93 
e
.
pos
 = 
v®ue
->
d©a
;

94 
e
.
buf
 = *
v®ue
;

96 *(
ušŒ_t
 *è
e
.

) {

97 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

98 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

101 *
v®ue
 = 
e
.
buf
;

103  
NGX_OK
;

104 
	}
}

107 
ngx_št_t


108 
	$ngx_h‰p_compže_com¶ex_v®ue
(
ngx_h‰p_compže_com¶ex_v®ue_t
 *
ccv
)

110 
ngx_¡r_t
 *
v
;

111 
ngx_ušt_t
 
i
, 
n
, 
nv
, 
nc
;

112 
ngx_¬¿y_t
 
æushes
, 
Ëngths
, 
v®ues
, *
pf
, *
¶
, *
pv
;

113 
ngx_h‰p_süt_compže_t
 
sc
;

115 
v
 = 
ccv
->
v®ue
;

117 
nv
 = 0;

118 
nc
 = 0;

120 
i
 = 0; i < 
v
->
Ën
; i++) {

121 ià(
v
->
d©a
[
i
] == '$') {

122 ià(
v
->
d©a
[
i
 + 1] >= '1' && v->data[i + 1] <= '9') {

123 
nc
++;

126 
nv
++;

131 ià((
v
->
Ën
 =ð0 || v->
d©a
[0] != '$')

132 && (
ccv
->
cÚf_´efix
 || ccv->
roÙ_´efix
))

134 ià(
	`ngx_cÚf_fuÎ_Çme
(
ccv
->
cf
->
cyþe
, 
v
, ccv->
cÚf_´efix
è!ð
NGX_OK
) {

135  
NGX_ERROR
;

138 
ccv
->
cÚf_´efix
 = 0;

139 
ccv
->
roÙ_´efix
 = 0;

142 
ccv
->
com¶ex_v®ue
->
v®ue
 = *
v
;

143 
ccv
->
com¶ex_v®ue
->
æushes
 = 
NULL
;

144 
ccv
->
com¶ex_v®ue
->
Ëngths
 = 
NULL
;

145 
ccv
->
com¶ex_v®ue
->
v®ues
 = 
NULL
;

147 ià(
nv
 =ð0 && 
nc
 == 0) {

148  
NGX_OK
;

151 
n
 = 
nv
 + 1;

153 ià(
	`ngx_¬¿y_š™
(&
æushes
, 
ccv
->
cf
->
poÞ
, 
n
, (
ngx_ušt_t
))

154 !ð
NGX_OK
)

156  
NGX_ERROR
;

159 
n
 = 
nv
 * (2 * (
ngx_h‰p_süt_cÝy_code_t
)

160 + (
ngx_h‰p_süt_v¬_code_t
))

161 + (
ušŒ_t
);

163 ià(
	`ngx_¬¿y_š™
(&
Ëngths
, 
ccv
->
cf
->
poÞ
, 
n
, 1è!ð
NGX_OK
) {

164  
NGX_ERROR
;

167 
n
 = (
nv
 * (2 * (
ngx_h‰p_süt_cÝy_code_t
)

168 + (
ngx_h‰p_süt_v¬_code_t
))

169 + (
ušŒ_t
)

170 + 
v
->
Ën


171 + (
ušŒ_t
) - 1)

172 & ~((
ušŒ_t
) - 1);

174 ià(
	`ngx_¬¿y_š™
(&
v®ues
, 
ccv
->
cf
->
poÞ
, 
n
, 1è!ð
NGX_OK
) {

175  
NGX_ERROR
;

178 
pf
 = &
æushes
;

179 
¶
 = &
Ëngths
;

180 
pv
 = &
v®ues
;

182 
	`ngx_memz”o
(&
sc
, (
ngx_h‰p_süt_compže_t
));

184 
sc
.
cf
 = 
ccv
->cf;

185 
sc
.
sourû
 = 
v
;

186 
sc
.
æushes
 = &
pf
;

187 
sc
.
Ëngths
 = &
¶
;

188 
sc
.
v®ues
 = &
pv
;

189 
sc
.
com¶‘e_Ëngths
 = 1;

190 
sc
.
com¶‘e_v®ues
 = 1;

191 
sc
.
z”o
 = 
ccv
->zero;

192 
sc
.
cÚf_´efix
 = 
ccv
->conf_prefix;

193 
sc
.
roÙ_´efix
 = 
ccv
->root_prefix;

195 ià(
	`ngx_h‰p_süt_compže
(&
sc
è!ð
NGX_OK
) {

196  
NGX_ERROR
;

199 ià(
æushes
.
ÃÉs
) {

200 
ccv
->
com¶ex_v®ue
->
æushes
 = flushes.
–ts
;

201 
ccv
->
com¶ex_v®ue
->
æushes
[æushes.
ÃÉs
] = (
ngx_ušt_t
) -1;

204 
ccv
->
com¶ex_v®ue
->
Ëngths
 =†’gths.
–ts
;

205 
ccv
->
com¶ex_v®ue
->
v®ues
 = v®ues.
–ts
;

207  
NGX_OK
;

208 
	}
}

212 
	$ngx_h‰p_£t_com¶ex_v®ue_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

214 *
p
 = 
cÚf
;

216 
ngx_¡r_t
 *
v®ue
;

217 
ngx_h‰p_com¶ex_v®ue_t
 **
cv
;

218 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

220 
cv
 = (
ngx_h‰p_com¶ex_v®ue_t
 **è(
p
 + 
cmd
->
off£t
);

222 ià(*
cv
 !ð
NULL
) {

226 *
cv
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_com¶ex_v®ue_t
));

227 ià(*
cv
 =ð
NULL
) {

228  
NGX_CONF_ERROR
;

231 
v®ue
 = 
cf
->
¬gs
->
–ts
;

233 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

235 
ccv
.
cf
 = cf;

236 
ccv
.
v®ue
 = &value[1];

237 
ccv
.
com¶ex_v®ue
 = *
cv
;

239 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

240  
NGX_CONF_ERROR
;

243  
NGX_CONF_OK
;

244 
	}
}

247 
ngx_št_t


248 
	$ngx_h‰p_‹¡_´ediÿ‹s
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¬¿y_t
 *
´ediÿ‹s
)

250 
ngx_¡r_t
 
v®
;

251 
ngx_ušt_t
 
i
;

252 
ngx_h‰p_com¶ex_v®ue_t
 *
cv
;

254 ià(
´ediÿ‹s
 =ð
NULL
) {

255  
NGX_OK
;

258 
cv
 = 
´ediÿ‹s
->
–ts
;

260 
i
 = 0; i < 
´ediÿ‹s
->
ÃÉs
; i++) {

261 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
cv
[
i
], &
v®
è!ð
NGX_OK
) {

262  
NGX_ERROR
;

265 ià(
v®
.
Ën
 && (v®.ËÀ!ð1 || v®.
d©a
[0] != '0')) {

266  
NGX_DECLINED
;

270  
NGX_OK
;

271 
	}
}

275 
	$ngx_h‰p_£t_´ediÿ‹_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

277 *
p
 = 
cÚf
;

279 
ngx_¡r_t
 *
v®ue
;

280 
ngx_ušt_t
 
i
;

281 
ngx_¬¿y_t
 **
a
;

282 
ngx_h‰p_com¶ex_v®ue_t
 *
cv
;

283 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

285 
a
 = (
ngx_¬¿y_t
 **è(
p
 + 
cmd
->
off£t
);

287 ià(*
a
 =ð
NGX_CONF_UNSET_PTR
) {

288 *
a
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1, (
ngx_h‰p_com¶ex_v®ue_t
));

289 ià(*
a
 =ð
NULL
) {

290  
NGX_CONF_ERROR
;

294 
v®ue
 = 
cf
->
¬gs
->
–ts
;

296 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

297 
cv
 = 
	`ngx_¬¿y_push
(*
a
);

298 ià(
cv
 =ð
NULL
) {

299  
NGX_CONF_ERROR
;

302 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

304 
ccv
.
cf
 = cf;

305 
ccv
.
v®ue
 = &v®ue[
i
];

306 
ccv
.
com¶ex_v®ue
 = 
cv
;

308 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

309  
NGX_CONF_ERROR
;

313  
NGX_CONF_OK
;

314 
	}
}

317 
ngx_ušt_t


318 
	$ngx_h‰p_süt_v¬ŸbËs_couÁ
(
ngx_¡r_t
 *
v®ue
)

320 
ngx_ušt_t
 
i
, 
n
;

322 
n
 = 0, 
i
 = 0; i < 
v®ue
->
Ën
; i++) {

323 ià(
v®ue
->
d©a
[
i
] == '$') {

324 
n
++;

328  
n
;

329 
	}
}

332 
ngx_št_t


333 
	$ngx_h‰p_süt_compže
(
ngx_h‰p_süt_compže_t
 *
sc
)

335 
u_ch¬
 
ch
;

336 
ngx_¡r_t
 
Çme
;

337 
ngx_ušt_t
 
i
, 
b¿ck‘
;

339 ià(
	`ngx_h‰p_süt_š™_¬¿ys
(
sc
è!ð
NGX_OK
) {

340  
NGX_ERROR
;

343 
i
 = 0; i < 
sc
->
sourû
->
Ën
; ) {

345 
Çme
.
Ën
 = 0;

347 ià(
sc
->
sourû
->
d©a
[
i
] == '$') {

349 ià(++
i
 =ð
sc
->
sourû
->
Ën
) {

350 
šv®id_v¬ŸbË
;

353 #ià(
NGX_PCRE
)

355 
ngx_ušt_t
 
n
;

357 ià(
sc
->
sourû
->
d©a
[
i
] >= '1' && sc->source->data[i] <= '9') {

359 
n
 = 
sc
->
sourû
->
d©a
[
i
] - '0';

361 ià(
sc
->
ÿ±u»s_mask
 & (1 << 
n
)) {

362 
sc
->
dup_ÿ±u»
 = 1;

365 
sc
->
ÿ±u»s_mask
 |ð1 << 
n
;

367 ià(
	`ngx_h‰p_süt_add_ÿ±u»_code
(
sc
, 
n
è!ð
NGX_OK
) {

368  
NGX_ERROR
;

371 
i
++;

378 ià(
sc
->
sourû
->
d©a
[
i
] == '{') {

379 
b¿ck‘
 = 1;

381 ià(++
i
 =ð
sc
->
sourû
->
Ën
) {

382 
šv®id_v¬ŸbË
;

385 
Çme
.
d©a
 = &
sc
->
sourû
->d©a[
i
];

388 
b¿ck‘
 = 0;

389 
Çme
.
d©a
 = &
sc
->
sourû
->d©a[
i
];

392  ; 
i
 < 
sc
->
sourû
->
Ën
; i++, 
Çme
.len++) {

393 
ch
 = 
sc
->
sourû
->
d©a
[
i
];

395 ià(
ch
 =ð'}' && 
b¿ck‘
) {

396 
i
++;

397 
b¿ck‘
 = 0;

401 ià((
ch
 >= 'A' && ch <= 'Z')

402 || (
ch
 >= 'a' && ch <= 'z')

403 || (
ch
 >= '0' && ch <= '9')

404 || 
ch
 == '_')

412 ià(
b¿ck‘
) {

413 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
sc
->
cf
, 0,

415 "v¬ŸbË i missšg", &
Çme
);

416  
NGX_ERROR
;

419 ià(
Çme
.
Ën
 == 0) {

420 
šv®id_v¬ŸbË
;

423 
sc
->
v¬ŸbËs
++;

425 ià(
	`ngx_h‰p_süt_add_v¬_code
(
sc
, &
Çme
è!ð
NGX_OK
) {

426  
NGX_ERROR
;

432 ià(
sc
->
sourû
->
d©a
[
i
] =ð'?' && sc->
compže_¬gs
) {

433 
sc
->
¬gs
 = 1;

434 
sc
->
compže_¬gs
 = 0;

436 ià(
	`ngx_h‰p_süt_add_¬gs_code
(
sc
è!ð
NGX_OK
) {

437  
NGX_ERROR
;

440 
i
++;

445 
Çme
.
d©a
 = &
sc
->
sourû
->d©a[
i
];

447 
i
 < 
sc
->
sourû
->
Ën
) {

449 ià(
sc
->
sourû
->
d©a
[
i
] == '$') {

453 ià(
sc
->
sourû
->
d©a
[
i
] == '?') {

455 
sc
->
¬gs
 = 1;

457 ià(
sc
->
compže_¬gs
) {

462 
i
++;

463 
Çme
.
Ën
++;

466 
sc
->
size
 +ð
Çme
.
Ën
;

468 ià(
	`ngx_h‰p_süt_add_cÝy_code
(
sc
, &
Çme
, (
i
 =ðsc->
sourû
->
Ën
))

469 !ð
NGX_OK
)

471  
NGX_ERROR
;

475  
	`ngx_h‰p_süt_dÚe
(
sc
);

477 
šv®id_v¬ŸbË
:

479 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
sc
->
cf
, 0, "invalid variable‚ame");

481  
NGX_ERROR
;

482 
	}
}

485 
u_ch¬
 *

486 
	$ngx_h‰p_süt_run
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
v®ue
,

487 *
code_Ëngths
, 
size_t
 
Ën
, *
code_v®ues
)

489 
ngx_ušt_t
 
i
;

490 
ngx_h‰p_süt_code_±
 
code
;

491 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

492 
ngx_h‰p_süt_’gše_t
 
e
;

493 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

495 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

497 
i
 = 0; i < 
cmcf
->
v¬ŸbËs
.
ÃÉs
; i++) {

498 ià(
r
->
v¬ŸbËs
[
i
].
no_ÿch—bË
) {

499 
r
->
v¬ŸbËs
[
i
].
v®id
 = 0;

500 
r
->
v¬ŸbËs
[
i
].
nÙ_found
 = 0;

504 
	`ngx_memz”o
(&
e
, (
ngx_h‰p_süt_’gše_t
));

506 
e
.

 = 
code_Ëngths
;

507 
e
.
»que¡
 = 
r
;

508 
e
.
æushed
 = 1;

510 *(
ušŒ_t
 *è
e
.

) {

511 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
e
.

;

512 
Ën
 +ð
	`lcode
(&
e
);

516 
v®ue
->
Ën
 =†en;

517 
v®ue
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

518 ià(
v®ue
->
d©a
 =ð
NULL
) {

519  
NULL
;

522 
e
.

 = 
code_v®ues
;

523 
e
.
pos
 = 
v®ue
->
d©a
;

525 *(
ušŒ_t
 *è
e
.

) {

526 
code
 = *(
ngx_h‰p_süt_code_±
 *è
e
.

;

527 
	`code
((
ngx_h‰p_süt_’gše_t
 *è&
e
);

530  
e
.
pos
;

531 
	}
}

535 
	$ngx_h‰p_süt_æush_no_ÿch—bË_v¬ŸbËs
(
ngx_h‰p_»que¡_t
 *
r
,

536 
ngx_¬¿y_t
 *
šdiûs
)

538 
ngx_ušt_t
 
n
, *
šdex
;

540 ià(
šdiûs
) {

541 
šdex
 = 
šdiûs
->
–ts
;

542 
n
 = 0;‚ < 
šdiûs
->
ÃÉs
;‚++) {

543 ià(
r
->
v¬ŸbËs
[
šdex
[
n
]].
no_ÿch—bË
) {

544 
r
->
v¬ŸbËs
[
šdex
[
n
]].
v®id
 = 0;

545 
r
->
v¬ŸbËs
[
šdex
[
n
]].
nÙ_found
 = 0;

549 
	}
}

552 
ngx_št_t


553 
	$ngx_h‰p_süt_š™_¬¿ys
(
ngx_h‰p_süt_compže_t
 *
sc
)

555 
ngx_ušt_t
 
n
;

557 ià(
sc
->
æushes
 && *sc->æushe =ð
NULL
) {

558 
n
 = 
sc
->
v¬ŸbËs
 ? sc->variables : 1;

559 *
sc
->
æushes
 = 
	`ngx_¬¿y_ü—‹
(sc->
cf
->
poÞ
, 
n
, (
ngx_ušt_t
));

560 ià(*
sc
->
æushes
 =ð
NULL
) {

561  
NGX_ERROR
;

565 ià(*
sc
->
Ëngths
 =ð
NULL
) {

566 
n
 = 
sc
->
v¬ŸbËs
 * (2 * (
ngx_h‰p_süt_cÝy_code_t
)

567 + (
ngx_h‰p_süt_v¬_code_t
))

568 + (
ušŒ_t
);

570 *
sc
->
Ëngths
 = 
	`ngx_¬¿y_ü—‹
(sc->
cf
->
poÞ
, 
n
, 1);

571 ià(*
sc
->
Ëngths
 =ð
NULL
) {

572  
NGX_ERROR
;

576 ià(*
sc
->
v®ues
 =ð
NULL
) {

577 
n
 = (
sc
->
v¬ŸbËs
 * (2 * (
ngx_h‰p_süt_cÝy_code_t
)

578 + (
ngx_h‰p_süt_v¬_code_t
))

579 + (
ušŒ_t
)

580 + 
sc
->
sourû
->
Ën


581 + (
ušŒ_t
) - 1)

582 & ~((
ušŒ_t
) - 1);

584 *
sc
->
v®ues
 = 
	`ngx_¬¿y_ü—‹
(sc->
cf
->
poÞ
, 
n
, 1);

585 ià(*
sc
->
v®ues
 =ð
NULL
) {

586  
NGX_ERROR
;

590 
sc
->
v¬ŸbËs
 = 0;

592  
NGX_OK
;

593 
	}
}

596 
ngx_št_t


597 
	$ngx_h‰p_süt_dÚe
(
ngx_h‰p_süt_compže_t
 *
sc
)

599 
ngx_¡r_t
 
z”o
;

600 
ušŒ_t
 *
code
;

602 ià(
sc
->
z”o
) {

604 
z”o
.
Ën
 = 1;

605 
z”o
.
d©a
 = (
u_ch¬
 *) "\0";

607 ià(
	`ngx_h‰p_süt_add_cÝy_code
(
sc
, &
z”o
, 0è!ð
NGX_OK
) {

608  
NGX_ERROR
;

612 ià(
sc
->
cÚf_´efix
 || sc->
roÙ_´efix
) {

613 ià(
	`ngx_h‰p_süt_add_fuÎ_Çme_code
(
sc
è!ð
NGX_OK
) {

614  
NGX_ERROR
;

618 ià(
sc
->
com¶‘e_Ëngths
) {

619 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
Ëngths
, (
ušŒ_t
), 
NULL
);

620 ià(
code
 =ð
NULL
) {

621  
NGX_ERROR
;

624 *
code
 = (
ušŒ_t
è
NULL
;

627 ià(
sc
->
com¶‘e_v®ues
) {

628 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
v®ues
, (
ušŒ_t
),

629 &
sc
->
maš
);

630 ià(
code
 =ð
NULL
) {

631  
NGX_ERROR
;

634 *
code
 = (
ušŒ_t
è
NULL
;

637  
NGX_OK
;

638 
	}
}

642 
	$ngx_h‰p_süt_¡¬t_code
(
ngx_poÞ_t
 *
poÞ
, 
ngx_¬¿y_t
 **
codes
, 
size_t
 
size
)

644 ià(*
codes
 =ð
NULL
) {

645 *
codes
 = 
	`ngx_¬¿y_ü—‹
(
poÞ
, 256, 1);

646 ià(*
codes
 =ð
NULL
) {

647  
NULL
;

651  
	`ngx_¬¿y_push_n
(*
codes
, 
size
);

652 
	}
}

656 
	$ngx_h‰p_süt_add_code
(
ngx_¬¿y_t
 *
codes
, 
size_t
 
size
, *
code
)

658 
u_ch¬
 *
–ts
, **
p
;

659 *
Ãw
;

661 
–ts
 = 
codes
->elts;

663 
Ãw
 = 
	`ngx_¬¿y_push_n
(
codes
, 
size
);

664 ià(
Ãw
 =ð
NULL
) {

665  
NULL
;

668 ià(
code
) {

669 ià(
–ts
 !ð
codes
->elts) {

670 
p
 = 
code
;

671 *
p
 +ð(
u_ch¬
 *è
codes
->
–ts
 -ƒlts;

675  
Ãw
;

676 
	}
}

679 
ngx_št_t


680 
	$ngx_h‰p_süt_add_cÝy_code
(
ngx_h‰p_süt_compže_t
 *
sc
, 
ngx_¡r_t
 *
v®ue
,

681 
ngx_ušt_t
 
Ï¡
)

683 
u_ch¬
 *
p
;

684 
size_t
 
size
, 
Ën
, 
z”o
;

685 
ngx_h‰p_süt_cÝy_code_t
 *
code
;

687 
z”o
 = (
sc
->z”Ø&& 
Ï¡
);

688 
Ën
 = 
v®ue
->ËÀ+ 
z”o
;

690 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
Ëngths
,

691 (
ngx_h‰p_süt_cÝy_code_t
), 
NULL
);

692 ià(
code
 =ð
NULL
) {

693  
NGX_ERROR
;

696 
code
->codð(
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_cÝy_Ën_code
;

697 
code
->
Ën
 =†en;

699 
size
 = ((
ngx_h‰p_süt_cÝy_code_t
è+ 
Ën
 + (
ušŒ_t
) - 1)

700 & ~((
ušŒ_t
) - 1);

702 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
v®ues
, 
size
, &sc->
maš
);

703 ià(
code
 =ð
NULL
) {

704  
NGX_ERROR
;

707 
code
->codð
ngx_h‰p_süt_cÝy_code
;

708 
code
->
Ën
 =†en;

710 
p
 = 
	`ngx_ýymem
((
u_ch¬
 *è
code
 + (
ngx_h‰p_süt_cÝy_code_t
),

711 
v®ue
->
d©a
, v®ue->
Ën
);

713 ià(
z”o
) {

714 *
p
 = '\0';

715 
sc
->
z”o
 = 0;

718  
NGX_OK
;

719 
	}
}

722 
size_t


723 
	$ngx_h‰p_süt_cÝy_Ën_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

725 
ngx_h‰p_süt_cÝy_code_t
 *
code
;

727 
code
 = (
ngx_h‰p_süt_cÝy_code_t
 *è
e
->

;

729 
e
->

 +ð(
ngx_h‰p_süt_cÝy_code_t
);

731  
code
->
Ën
;

732 
	}
}

736 
	$ngx_h‰p_süt_cÝy_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

738 
u_ch¬
 *
p
;

739 
ngx_h‰p_süt_cÝy_code_t
 *
code
;

741 
code
 = (
ngx_h‰p_süt_cÝy_code_t
 *è
e
->

;

743 
p
 = 
e
->
pos
;

745 ià(!
e
->
sk
) {

746 
e
->
pos
 = 
	`ngx_cÝy
(
p
,ƒ->

 + (
ngx_h‰p_süt_cÝy_code_t
),

747 
code
->
Ën
);

750 
e
->

 +ð(
ngx_h‰p_süt_cÝy_code_t
)

751 + ((
code
->
Ën
 + (
ušŒ_t
) - 1) & ~((uintptr_t) - 1));

753 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

754 "h‰°süˆcÝy: \"%*s\"", 
e
->
pos
 - 
p
,…);

755 
	}
}

758 
ngx_št_t


759 
	$ngx_h‰p_süt_add_v¬_code
(
ngx_h‰p_süt_compže_t
 *
sc
, 
ngx_¡r_t
 *
Çme
)

761 
ngx_št_t
 
šdex
, *
p
;

762 
ngx_h‰p_süt_v¬_code_t
 *
code
;

764 
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
sc
->
cf
, 
Çme
);

766 ià(
šdex
 =ð
NGX_ERROR
) {

767  
NGX_ERROR
;

770 ià(
sc
->
æushes
) {

771 
p
 = 
	`ngx_¬¿y_push
(*
sc
->
æushes
);

772 ià(
p
 =ð
NULL
) {

773  
NGX_ERROR
;

776 *
p
 = 
šdex
;

779 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
Ëngths
,

780 (
ngx_h‰p_süt_v¬_code_t
), 
NULL
);

781 ià(
code
 =ð
NULL
) {

782  
NGX_ERROR
;

785 
code
->codð(
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_cÝy_v¬_Ën_code
;

786 
code
->
šdex
 = (
ušŒ_t
) index;

788 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
v®ues
,

789 (
ngx_h‰p_süt_v¬_code_t
),

790 &
sc
->
maš
);

791 ià(
code
 =ð
NULL
) {

792  
NGX_ERROR
;

795 
code
->codð
ngx_h‰p_süt_cÝy_v¬_code
;

796 
code
->
šdex
 = (
ušŒ_t
) index;

798  
NGX_OK
;

799 
	}
}

802 
size_t


803 
	$ngx_h‰p_süt_cÝy_v¬_Ën_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

805 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®ue
;

806 
ngx_h‰p_süt_v¬_code_t
 *
code
;

808 
code
 = (
ngx_h‰p_süt_v¬_code_t
 *è
e
->

;

810 
e
->

 +ð(
ngx_h‰p_süt_v¬_code_t
);

812 ià(
e
->
æushed
) {

813 
v®ue
 = 
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
e
->
»que¡
, 
code
->
šdex
);

816 
v®ue
 = 
	`ngx_h‰p_g‘_æushed_v¬ŸbË
(
e
->
»que¡
, 
code
->
šdex
);

819 ià(
v®ue
 && !v®ue->
nÙ_found
) {

820  
v®ue
->
Ën
;

824 
	}
}

828 
	$ngx_h‰p_süt_cÝy_v¬_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

830 
u_ch¬
 *
p
;

831 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®ue
;

832 
ngx_h‰p_süt_v¬_code_t
 *
code
;

834 
code
 = (
ngx_h‰p_süt_v¬_code_t
 *è
e
->

;

836 
e
->

 +ð(
ngx_h‰p_süt_v¬_code_t
);

838 ià(!
e
->
sk
) {

840 ià(
e
->
æushed
) {

841 
v®ue
 = 
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
e
->
»que¡
, 
code
->
šdex
);

844 
v®ue
 = 
	`ngx_h‰p_g‘_æushed_v¬ŸbË
(
e
->
»que¡
, 
code
->
šdex
);

847 ià(
v®ue
 && !v®ue->
nÙ_found
) {

848 
p
 = 
e
->
pos
;

849 
e
->
pos
 = 
	`ngx_cÝy
(
p
, 
v®ue
->
d©a
, v®ue->
Ën
);

851 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
,

852 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

853 "h‰°süˆv¬: \"%*s\"", 
e
->
pos
 - 
p
,…);

856 
	}
}

859 
ngx_št_t


860 
	$ngx_h‰p_süt_add_¬gs_code
(
ngx_h‰p_süt_compže_t
 *
sc
)

862 
ušŒ_t
 *
code
;

864 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
Ëngths
, (
ušŒ_t
), 
NULL
);

865 ià(
code
 =ð
NULL
) {

866  
NGX_ERROR
;

869 *
code
 = (
ušŒ_t
è
ngx_h‰p_süt_m¬k_¬gs_code
;

871 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
v®ues
, (
ušŒ_t
), &sc->
maš
);

872 ià(
code
 =ð
NULL
) {

873  
NGX_ERROR
;

876 *
code
 = (
ušŒ_t
è
ngx_h‰p_süt_¡¬t_¬gs_code
;

878  
NGX_OK
;

879 
	}
}

882 
size_t


883 
	$ngx_h‰p_süt_m¬k_¬gs_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

885 
e
->
is_¬gs
 = 1;

886 
e
->

 +ð(
ušŒ_t
);

889 
	}
}

893 
	$ngx_h‰p_süt_¡¬t_¬gs_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

895 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

898 
e
->
is_¬gs
 = 1;

899 
e
->
¬gs
 =ƒ->
pos
;

900 
e
->

 +ð(
ušŒ_t
);

901 
	}
}

904 #ià(
NGX_PCRE
)

907 
	$ngx_h‰p_süt_»gex_¡¬t_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

909 
size_t
 
Ën
;

910 
ngx_št_t
 
rc
;

911 
ngx_ušt_t
 
n
;

912 
ngx_h‰p_»que¡_t
 *
r
;

913 
ngx_h‰p_süt_’gše_t
 
Ë
;

914 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

915 
ngx_h‰p_süt_»gex_code_t
 *
code
;

917 
code
 = (
ngx_h‰p_süt_»gex_code_t
 *è
e
->

;

919 
r
 = 
e
->
»que¡
;

921 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

922 "h‰°süˆ»gex: \"%V\"", &
code
->
Çme
);

924 ià(
code
->
uri
) {

925 
e
->
lše
 = 
r
->
uri
;

927 
e
->
¥
--;

928 
e
->
lše
.
Ën
 =ƒ->
¥
->len;

929 
e
->
lše
.
d©a
 =ƒ->
¥
->data;

932 
rc
 = 
	`ngx_h‰p_»gex_exec
(
r
, 
code
->
»gex
, &
e
->
lše
);

934 ià(
rc
 =ð
NGX_DECLINED
) {

935 ià(
e
->
log
 || (
r
->
cÚÃùiÚ
->log->
log_Ëv–
 & 
NGX_LOG_DEBUG_HTTP
)) {

936 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
r
->
cÚÃùiÚ
->
log
, 0,

938 &
code
->
Çme
, &
e
->
lše
);

941 
r
->
nÿ±u»s
 = 0;

943 ià(
code
->
‹¡
) {

944 ià(
code
->
Ãg©ive_‹¡
) {

945 
e
->
¥
->
Ën
 = 1;

946 
e
->
¥
->
d©a
 = (
u_ch¬
 *) "1";

949 
e
->
¥
->
Ën
 = 0;

950 
e
->
¥
->
d©a
 = (
u_ch¬
 *) "";

953 
e
->
¥
++;

955 
e
->

 +ð(
ngx_h‰p_süt_»gex_code_t
);

959 
e
->

 +ð
code
->
Ãxt
;

963 ià(
rc
 =ð
NGX_ERROR
) {

964 
e
->

 = 
ngx_h‰p_süt_ex™
;

965 
e
->
¡©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

969 ià(
e
->
log
 || (
r
->
cÚÃùiÚ
->log->
log_Ëv–
 & 
NGX_LOG_DEBUG_HTTP
)) {

970 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
r
->
cÚÃùiÚ
->
log
, 0,

971 "\"%V\" m©che \"%V\"", &
code
->
Çme
, &
e
->
lše
);

974 ià(
code
->
‹¡
) {

975 ià(
code
->
Ãg©ive_‹¡
) {

976 
e
->
¥
->
Ën
 = 0;

977 
e
->
¥
->
d©a
 = (
u_ch¬
 *) "";

980 
e
->
¥
->
Ën
 = 1;

981 
e
->
¥
->
d©a
 = (
u_ch¬
 *) "1";

984 
e
->
¥
++;

986 
e
->

 +ð(
ngx_h‰p_süt_»gex_code_t
);

990 ià(
code
->
¡©us
) {

991 
e
->
¡©us
 = 
code
->status;

993 ià(!
code
->
»dœeù
) {

994 
e
->

 = 
ngx_h‰p_süt_ex™
;

999 ià(
code
->
uri
) {

1000 
r
->
š‹º®
 = 1;

1001 
r
->
v®id_uÅ¬£d_uri
 = 0;

1003 ià(
code
->
b»ak_cyþe
) {

1004 
r
->
v®id_loÿtiÚ
 = 0;

1005 
r
->
uri_chªged
 = 0;

1008 
r
->
uri_chªged
 = 1;

1012 ià(
code
->
Ëngths
 =ð
NULL
) {

1013 
e
->
buf
.
Ën
 = 
code
->
size
;

1015 ià(
code
->
uri
) {

1016 ià(
r
->
nÿ±u»s
 && (r->
quÙed_uri
 ||„->
¶us_š_uri
)) {

1017 
e
->
buf
.
Ën
 +ð2 * 
	`ngx_esÿ³_uri
(
NULL
, 
r
->
uri
.
d©a
,„->uri.len,

1018 
NGX_ESCAPE_ARGS
);

1022 
n
 = 2;‚ < 
r
->
nÿ±u»s
;‚ += 2) {

1023 
e
->
buf
.
Ën
 +ð
r
->
ÿ±u»s
[
n
 + 1] -„->captures[n];

1027 
	`ngx_memz”o
(&
Ë
, (
ngx_h‰p_süt_’gše_t
));

1029 
Ë
.

 = 
code
->
Ëngths
->
–ts
;

1030 
Ë
.
lše
 = 
e
->line;

1031 
Ë
.
»que¡
 = 
r
;

1032 
Ë
.
quÙe
 = 
code
->
»dœeù
;

1034 
Ën
 = 0;

1036 *(
ušŒ_t
 *è
Ë
.

) {

1037 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

1038 
Ën
 +ð
	`lcode
(&
Ë
);

1041 
e
->
buf
.
Ën
 =†en;

1044 ià(
code
->
add_¬gs
 && 
r
->
¬gs
.
Ën
) {

1045 
e
->
buf
.
Ën
 +ð
r
->
¬gs
.len + 1;

1048 
e
->
buf
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,ƒ->buf.
Ën
);

1049 ià(
e
->
buf
.
d©a
 =ð
NULL
) {

1050 
e
->

 = 
ngx_h‰p_süt_ex™
;

1051 
e
->
¡©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1055 
e
->
quÙe
 = 
code
->
»dœeù
;

1057 
e
->
pos
 =ƒ->
buf
.
d©a
;

1059 
e
->

 +ð(
ngx_h‰p_süt_»gex_code_t
);

1060 
	}
}

1064 
	$ngx_h‰p_süt_»gex_’d_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1066 
u_ch¬
 *
d¡
, *
¤c
;

1067 
ngx_h‰p_»que¡_t
 *
r
;

1068 
ngx_h‰p_süt_»gex_’d_code_t
 *
code
;

1070 
code
 = (
ngx_h‰p_süt_»gex_’d_code_t
 *è
e
->

;

1072 
r
 = 
e
->
»que¡
;

1074 
e
->
quÙe
 = 0;

1076 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1079 ià(
code
->
»dœeù
) {

1081 
d¡
 = 
e
->
buf
.
d©a
;

1082 
¤c
 = 
e
->
buf
.
d©a
;

1084 
	`ngx_uÃsÿ³_uri
(&
d¡
, &
¤c
, 
e
->
pos
 -ƒ->
buf
.
d©a
,

1085 
NGX_UNESCAPE_REDIRECT
);

1087 ià(
¤c
 < 
e
->
pos
) {

1088 
d¡
 = 
	`ngx_movemem
(d¡, 
¤c
, 
e
->
pos
 - src);

1091 
e
->
pos
 = 
d¡
;

1093 ià(
code
->
add_¬gs
 && 
r
->
¬gs
.
Ën
) {

1094 *
e
->
pos
++ = (
u_ch¬
è(
code
->
¬gs
 ? '&' : '?');

1095 
e
->
pos
 = 
	`ngx_cÝy
Ó->pos, 
r
->
¬gs
.
d©a
,„->¬gs.
Ën
);

1098 
e
->
buf
.
Ën
 =ƒ->
pos
 -ƒ->buf.
d©a
;

1100 ià(
e
->
log
 || (
r
->
cÚÃùiÚ
->log->
log_Ëv–
 & 
NGX_LOG_DEBUG_HTTP
)) {

1101 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
r
->
cÚÃùiÚ
->
log
, 0,

1102 "»wr™‹À»dœeù: \"%V\"", &
e
->
buf
);

1105 
	`ngx_h‰p_þ—r_loÿtiÚ
(
r
);

1107 
r
->
h—d”s_out
.
loÿtiÚ
 = 
	`ngx_li¡_push
(&r->h—d”s_out.
h—d”s
);

1108 ià(
r
->
h—d”s_out
.
loÿtiÚ
 =ð
NULL
) {

1109 
e
->

 = 
ngx_h‰p_süt_ex™
;

1110 
e
->
¡©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1114 
r
->
h—d”s_out
.
loÿtiÚ
->
hash
 = 1;

1115 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
loÿtiÚ
->
key
, "Location");

1116 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
 = 
e
->
buf
;

1118 
e
->

 +ð(
ngx_h‰p_süt_»gex_’d_code_t
);

1122 ià(
e
->
¬gs
) {

1123 
e
->
buf
.
Ën
 =ƒ->
¬gs
 -ƒ->buf.
d©a
;

1125 ià(
code
->
add_¬gs
 && 
r
->
¬gs
.
Ën
) {

1126 *
e
->
pos
++ = '&';

1127 
e
->
pos
 = 
	`ngx_cÝy
Ó->pos, 
r
->
¬gs
.
d©a
,„->¬gs.
Ën
);

1130 
r
->
¬gs
.
Ën
 = 
e
->
pos
 -ƒ->args;

1131 
r
->
¬gs
.
d©a
 = 
e
->args;

1133 
e
->
¬gs
 = 
NULL
;

1136 
e
->
buf
.
Ën
 =ƒ->
pos
 -ƒ->buf.
d©a
;

1138 ià(!
code
->
add_¬gs
) {

1139 
r
->
¬gs
.
Ën
 = 0;

1143 ià(
e
->
log
 || (
r
->
cÚÃùiÚ
->log->
log_Ëv–
 & 
NGX_LOG_DEBUG_HTTP
)) {

1144 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
r
->
cÚÃùiÚ
->
log
, 0,

1146 &
e
->
buf
, &
r
->
¬gs
);

1149 ià(
code
->
uri
) {

1150 
r
->
uri
 = 
e
->
buf
;

1152 ià(
r
->
uri
.
Ën
 == 0) {

1153 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1155 
e
->

 = 
ngx_h‰p_süt_ex™
;

1156 
e
->
¡©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1160 
	`ngx_h‰p_£t_ex‹n
(
r
);

1163 
e
->

 +ð(
ngx_h‰p_süt_»gex_’d_code_t
);

1164 
	}
}

1167 
ngx_št_t


1168 
	$ngx_h‰p_süt_add_ÿ±u»_code
(
ngx_h‰p_süt_compže_t
 *
sc
, 
ngx_ušt_t
 
n
)

1170 
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
 *
code
;

1172 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
Ëngths
,

1173 (
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
),

1174 
NULL
);

1175 ià(
code
 =ð
NULL
) {

1176  
NGX_ERROR
;

1179 
code
->codð(
ngx_h‰p_süt_code_±
)

1180 
ngx_h‰p_süt_cÝy_ÿ±u»_Ën_code
;

1181 
code
->
n
 = 2 *‚;

1184 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
v®ues
,

1185 (
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
),

1186 &
sc
->
maš
);

1187 ià(
code
 =ð
NULL
) {

1188  
NGX_ERROR
;

1191 
code
->codð
ngx_h‰p_süt_cÝy_ÿ±u»_code
;

1192 
code
->
n
 = 2 *‚;

1194 ià(
sc
->
nÿ±u»s
 < 
n
) {

1195 
sc
->
nÿ±u»s
 = 
n
;

1198  
NGX_OK
;

1199 
	}
}

1202 
size_t


1203 
	$ngx_h‰p_süt_cÝy_ÿ±u»_Ën_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1205 *
ÿp
;

1206 
u_ch¬
 *
p
;

1207 
ngx_ušt_t
 
n
;

1208 
ngx_h‰p_»que¡_t
 *
r
;

1209 
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
 *
code
;

1211 
r
 = 
e
->
»que¡
;

1213 
code
 = (
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
 *è
e
->

;

1215 
e
->

 +ð(
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
);

1217 
n
 = 
code
->n;

1219 ià(
n
 < 
r
->
nÿ±u»s
) {

1221 
ÿp
 = 
r
->
ÿ±u»s
;

1223 ià((
e
->
is_¬gs
 ||ƒ->
quÙe
)

1224 && (
e
->
»que¡
->
quÙed_uri
 ||ƒ->»que¡->
¶us_š_uri
))

1226 
p
 = 
r
->
ÿ±u»s_d©a
;

1228  
ÿp
[
n
 + 1] - cap[n]

1229 + 2 * 
	`ngx_esÿ³_uri
(
NULL
, &
p
[
ÿp
[
n
]], cap[n + 1] - cap[n],

1230 
NGX_ESCAPE_ARGS
);

1232  
ÿp
[
n
 + 1] - cap[n];

1237 
	}
}

1241 
	$ngx_h‰p_süt_cÝy_ÿ±u»_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1243 *
ÿp
;

1244 
u_ch¬
 *
p
, *
pos
;

1245 
ngx_ušt_t
 
n
;

1246 
ngx_h‰p_»que¡_t
 *
r
;

1247 
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
 *
code
;

1249 
r
 = 
e
->
»que¡
;

1251 
code
 = (
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
 *è
e
->

;

1253 
e
->

 +ð(
ngx_h‰p_süt_cÝy_ÿ±u»_code_t
);

1255 
n
 = 
code
->n;

1257 
pos
 = 
e
->pos;

1259 ià(
n
 < 
r
->
nÿ±u»s
) {

1261 
ÿp
 = 
r
->
ÿ±u»s
;

1262 
p
 = 
r
->
ÿ±u»s_d©a
;

1264 ià((
e
->
is_¬gs
 ||ƒ->
quÙe
)

1265 && (
e
->
»que¡
->
quÙed_uri
 ||ƒ->»que¡->
¶us_š_uri
))

1267 
e
->
pos
 = (
u_ch¬
 *è
	`ngx_esÿ³_uri
Õos, &
p
[
ÿp
[
n
]],

1268 
ÿp
[
n
 + 1] - cap[n],

1269 
NGX_ESCAPE_ARGS
);

1271 
e
->
pos
 = 
	`ngx_cÝy
Õos, &
p
[
ÿp
[
n
]], cap[n + 1] - cap[n]);

1275 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1276 "h‰°süˆÿ±u»: \"%*s\"", 
e
->
pos
 -…os,…os);

1277 
	}
}

1282 
ngx_št_t


1283 
	$ngx_h‰p_süt_add_fuÎ_Çme_code
(
ngx_h‰p_süt_compže_t
 *
sc
)

1285 
ngx_h‰p_süt_fuÎ_Çme_code_t
 *
code
;

1287 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
Ëngths
,

1288 (
ngx_h‰p_süt_fuÎ_Çme_code_t
),

1289 
NULL
);

1290 ià(
code
 =ð
NULL
) {

1291  
NGX_ERROR
;

1294 
code
->codð(
ngx_h‰p_süt_code_±
è
ngx_h‰p_süt_fuÎ_Çme_Ën_code
;

1295 
code
->
cÚf_´efix
 = 
sc
->conf_prefix;

1297 
code
 = 
	`ngx_h‰p_süt_add_code
(*
sc
->
v®ues
,

1298 (
ngx_h‰p_süt_fuÎ_Çme_code_t
),

1299 &
sc
->
maš
);

1300 ià(
code
 =ð
NULL
) {

1301  
NGX_ERROR
;

1304 
code
->codð
ngx_h‰p_süt_fuÎ_Çme_code
;

1305 
code
->
cÚf_´efix
 = 
sc
->conf_prefix;

1307  
NGX_OK
;

1308 
	}
}

1311 
size_t


1312 
	$ngx_h‰p_süt_fuÎ_Çme_Ën_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1314 
ngx_h‰p_süt_fuÎ_Çme_code_t
 *
code
;

1316 
code
 = (
ngx_h‰p_süt_fuÎ_Çme_code_t
 *è
e
->

;

1318 
e
->

 +ð(
ngx_h‰p_süt_fuÎ_Çme_code_t
);

1320  
code
->
cÚf_´efix
 ? 
ngx_cyþe
->cÚf_´efix.
Ën
:

1321 
ngx_cyþe
->
´efix
.
Ën
;

1322 
	}
}

1326 
	$ngx_h‰p_süt_fuÎ_Çme_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1328 
ngx_h‰p_süt_fuÎ_Çme_code_t
 *
code
;

1330 
ngx_¡r_t
 
v®ue
, *
´efix
;

1332 
code
 = (
ngx_h‰p_süt_fuÎ_Çme_code_t
 *è
e
->

;

1334 
v®ue
.
d©a
 = 
e
->
buf
.data;

1335 
v®ue
.
Ën
 = 
e
->
pos
 -ƒ->
buf
.
d©a
;

1337 
´efix
 = 
code
->
cÚf_´efix
 ? (
ngx_¡r_t
 *è&
ngx_cyþe
->conf_prefix:

1338 (
ngx_¡r_t
 *è&
ngx_cyþe
->
´efix
;

1340 ià(
	`ngx_g‘_fuÎ_Çme
(
e
->
»que¡
->
poÞ
, 
´efix
, &
v®ue
è!ð
NGX_OK
) {

1341 
e
->

 = 
ngx_h‰p_süt_ex™
;

1342 
e
->
¡©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1346 
e
->
buf
 = 
v®ue
;

1348 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1349 "h‰°süˆfuÎÇme: \"%V\"", &
v®ue
);

1351 
e
->

 +ð(
ngx_h‰p_süt_fuÎ_Çme_code_t
);

1352 
	}
}

1356 
	$ngx_h‰p_süt_»tuº_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1358 
ngx_h‰p_süt_»tuº_code_t
 *
code
;

1360 
code
 = (
ngx_h‰p_süt_»tuº_code_t
 *è
e
->

;

1362 ià(
code
->
¡©us
 < 
NGX_HTTP_BAD_REQUEST


1363 || 
code
->
‹xt
.
v®ue
.
Ën


1364 || 
code
->
‹xt
.
Ëngths
)

1366 
e
->
¡©us
 = 
	`ngx_h‰p_£nd_»¥Ú£
Ó->
»que¡
, 
code
->¡©us, 
NULL
,

1367 &
code
->
‹xt
);

1369 
e
->
¡©us
 = 
code
->status;

1372 
e
->

 = 
ngx_h‰p_süt_ex™
;

1373 
	}
}

1377 
	$ngx_h‰p_süt_b»ak_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1379 
e
->
»que¡
->
uri_chªged
 = 0;

1381 
e
->

 = 
ngx_h‰p_süt_ex™
;

1382 
	}
}

1386 
	$ngx_h‰p_süt_if_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1388 
ngx_h‰p_süt_if_code_t
 *
code
;

1390 
code
 = (
ngx_h‰p_süt_if_code_t
 *è
e
->

;

1392 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1395 
e
->
¥
--;

1397 ià(
e
->
¥
->
Ën
 && (e->¥->ËÀ!ð1 ||ƒ->¥->
d©a
[0] != '0')) {

1398 ià(
code
->
loc_cÚf
) {

1399 
e
->
»que¡
->
loc_cÚf
 = 
code
->loc_conf;

1400 
	`ngx_h‰p_upd©e_loÿtiÚ_cÚfig
(
e
->
»que¡
);

1403 
e
->

 +ð(
ngx_h‰p_süt_if_code_t
);

1407 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1410 
e
->

 +ð
code
->
Ãxt
;

1411 
	}
}

1415 
	$ngx_h‰p_süt_equ®_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1417 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®
, *
»s
;

1419 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1422 
e
->
¥
--;

1423 
v®
 = 
e
->
¥
;

1424 
»s
 = 
e
->
¥
 - 1;

1426 
e
->

 +ð(
ušŒ_t
);

1428 ià(
v®
->
Ën
 =ð
»s
->len

1429 && 
	`ngx_¡ºcmp
(
v®
->
d©a
, 
»s
->d©a,„es->
Ën
) == 0)

1431 *
»s
 = 
ngx_h‰p_v¬ŸbË_Œue_v®ue
;

1435 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1438 *
»s
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

1439 
	}
}

1443 
	$ngx_h‰p_süt_nÙ_equ®_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1445 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®
, *
»s
;

1447 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1450 
e
->
¥
--;

1451 
v®
 = 
e
->
¥
;

1452 
»s
 = 
e
->
¥
 - 1;

1454 
e
->

 +ð(
ušŒ_t
);

1456 ià(
v®
->
Ën
 =ð
»s
->len

1457 && 
	`ngx_¡ºcmp
(
v®
->
d©a
, 
»s
->d©a,„es->
Ën
) == 0)

1459 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1462 *
»s
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

1466 *
»s
 = 
ngx_h‰p_v¬ŸbË_Œue_v®ue
;

1467 
	}
}

1471 
	$ngx_h‰p_süt_fže_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1473 
ngx_¡r_t
 
·th
;

1474 
ngx_h‰p_»que¡_t
 *
r
;

1475 
ngx_Ý’_fže_šfo_t
 
of
;

1476 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1477 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®ue
;

1478 
ngx_h‰p_süt_fže_code_t
 *
code
;

1480 
v®ue
 = 
e
->
¥
 - 1;

1482 
code
 = (
ngx_h‰p_süt_fže_code_t
 *è
e
->

;

1483 
e
->

 +ð(
ngx_h‰p_süt_fže_code_t
);

1485 
·th
.
Ën
 = 
v®ue
->len - 1;

1486 
·th
.
d©a
 = 
v®ue
->data;

1488 
r
 = 
e
->
»que¡
;

1490 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1491 "h‰°süˆfžÝ %°\"%V\"", 
code
->
Ý
, &
·th
);

1493 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1495 
	`ngx_memz”o
(&
of
, (
ngx_Ý’_fže_šfo_t
));

1497 
of
.
»ad_ah—d
 = 
þcf
->read_ahead;

1498 
of
.
dœeùio
 = 
þcf
->directio;

1499 
of
.
v®id
 = 
þcf
->
Ý’_fže_ÿche_v®id
;

1500 
of
.
mš_u£s
 = 
þcf
->
Ý’_fže_ÿche_mš_u£s
;

1501 
of
.
‹¡_Úly
 = 1;

1502 
of
.
”rÜs
 = 
þcf
->
Ý’_fže_ÿche_”rÜs
;

1503 
of
.
ev’ts
 = 
þcf
->
Ý’_fže_ÿche_ev’ts
;

1505 ià(
	`ngx_h‰p_£t_di§bË_symlšks
(
r
, 
þcf
, &
·th
, &
of
è!ð
NGX_OK
) {

1506 
e
->

 = 
ngx_h‰p_süt_ex™
;

1507 
e
->
¡©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1511 ià(
	`ngx_Ý’_ÿched_fže
(
þcf
->
Ý’_fže_ÿche
, &
·th
, &
of
, 
r
->
poÞ
)

1512 !ð
NGX_OK
)

1514 ià(
of
.
”r
 !ð
NGX_ENOENT


1515 && 
of
.
”r
 !ð
NGX_ENOTDIR


1516 && 
of
.
”r
 !ð
NGX_ENAMETOOLONG
)

1518 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
of
.
”r
,

1519 "% \"%s\" fažed", 
of
.
çžed
, 
v®ue
->
d©a
);

1522 
code
->
Ý
) {

1524 
ngx_h‰p_süt_fže_¶aš
:

1525 
ngx_h‰p_süt_fže_dœ
:

1526 
ngx_h‰p_süt_fže_exi¡s
:

1527 
ngx_h‰p_süt_fže_exec
:

1528 
çl£_v®ue
;

1530 
ngx_h‰p_süt_fže_nÙ_¶aš
:

1531 
ngx_h‰p_süt_fže_nÙ_dœ
:

1532 
ngx_h‰p_süt_fže_nÙ_exi¡s
:

1533 
ngx_h‰p_süt_fže_nÙ_exec
:

1534 
Œue_v®ue
;

1537 
çl£_v®ue
;

1540 
code
->
Ý
) {

1541 
ngx_h‰p_süt_fže_¶aš
:

1542 ià(
of
.
is_fže
) {

1543 
Œue_v®ue
;

1545 
çl£_v®ue
;

1547 
ngx_h‰p_süt_fže_nÙ_¶aš
:

1548 ià(
of
.
is_fže
) {

1549 
çl£_v®ue
;

1551 
Œue_v®ue
;

1553 
ngx_h‰p_süt_fže_dœ
:

1554 ià(
of
.
is_dœ
) {

1555 
Œue_v®ue
;

1557 
çl£_v®ue
;

1559 
ngx_h‰p_süt_fže_nÙ_dœ
:

1560 ià(
of
.
is_dœ
) {

1561 
çl£_v®ue
;

1563 
Œue_v®ue
;

1565 
ngx_h‰p_süt_fže_exi¡s
:

1566 ià(
of
.
is_fže
 || of.
is_dœ
 || of.
is_lšk
) {

1567 
Œue_v®ue
;

1569 
çl£_v®ue
;

1571 
ngx_h‰p_süt_fže_nÙ_exi¡s
:

1572 ià(
of
.
is_fže
 || of.
is_dœ
 || of.
is_lšk
) {

1573 
çl£_v®ue
;

1575 
Œue_v®ue
;

1577 
ngx_h‰p_süt_fže_exec
:

1578 ià(
of
.
is_exec
) {

1579 
Œue_v®ue
;

1581 
çl£_v®ue
;

1583 
ngx_h‰p_süt_fže_nÙ_exec
:

1584 ià(
of
.
is_exec
) {

1585 
çl£_v®ue
;

1587 
Œue_v®ue
;

1590 
çl£_v®ue
:

1592 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1595 *
v®ue
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

1598 
Œue_v®ue
:

1600 *
v®ue
 = 
ngx_h‰p_v¬ŸbË_Œue_v®ue
;

1602 
	}
}

1606 
	$ngx_h‰p_süt_com¶ex_v®ue_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1608 
size_t
 
Ën
;

1609 
ngx_h‰p_süt_’gše_t
 
Ë
;

1610 
ngx_h‰p_süt_Ën_code_±
 
lcode
;

1611 
ngx_h‰p_süt_com¶ex_v®ue_code_t
 *
code
;

1613 
code
 = (
ngx_h‰p_süt_com¶ex_v®ue_code_t
 *è
e
->

;

1615 
e
->

 +ð(
ngx_h‰p_süt_com¶ex_v®ue_code_t
);

1617 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1620 
	`ngx_memz”o
(&
Ë
, (
ngx_h‰p_süt_’gše_t
));

1622 
Ë
.

 = 
code
->
Ëngths
->
–ts
;

1623 
Ë
.
lše
 = 
e
->line;

1624 
Ë
.
»que¡
 = 
e
->request;

1625 
Ë
.
quÙe
 = 
e
->quote;

1627 
Ën
 = 0; *(
ušŒ_t
 *è
Ë
.

;†’ +ð
	`lcode
(&le)) {

1628 
lcode
 = *(
ngx_h‰p_süt_Ën_code_±
 *è
Ë
.

;

1631 
e
->
buf
.
Ën
 =†en;

1632 
e
->
buf
.
d©a
 = 
	`ngx_²®loc
Ó->
»que¡
->
poÞ
, 
Ën
);

1633 ià(
e
->
buf
.
d©a
 =ð
NULL
) {

1634 
e
->

 = 
ngx_h‰p_süt_ex™
;

1635 
e
->
¡©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1639 
e
->
pos
 =ƒ->
buf
.
d©a
;

1641 
e
->
¥
->
Ën
 =ƒ->
buf
.len;

1642 
e
->
¥
->
d©a
 =ƒ->
buf
.data;

1643 
e
->
¥
++;

1644 
	}
}

1648 
	$ngx_h‰p_süt_v®ue_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1650 
ngx_h‰p_süt_v®ue_code_t
 *
code
;

1652 
code
 = (
ngx_h‰p_süt_v®ue_code_t
 *è
e
->

;

1654 
e
->

 +ð(
ngx_h‰p_süt_v®ue_code_t
);

1656 
e
->
¥
->
Ën
 = 
code
->
‹xt_Ën
;

1657 
e
->
¥
->
d©a
 = (
u_ch¬
 *è
code
->
‹xt_d©a
;

1659 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1660 "h‰°süˆv®ue: \"%v\"", 
e
->
¥
);

1662 
e
->
¥
++;

1663 
	}
}

1667 
	$ngx_h‰p_süt_£t_v¬_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1669 
ngx_h‰p_»que¡_t
 *
r
;

1670 
ngx_h‰p_süt_v¬_code_t
 *
code
;

1672 
code
 = (
ngx_h‰p_süt_v¬_code_t
 *è
e
->

;

1674 
e
->

 +ð(
ngx_h‰p_süt_v¬_code_t
);

1676 
r
 = 
e
->
»que¡
;

1678 
e
->
¥
--;

1680 
r
->
v¬ŸbËs
[
code
->
šdex
].
Ën
 = 
e
->
¥
->len;

1681 
r
->
v¬ŸbËs
[
code
->
šdex
].
v®id
 = 1;

1682 
r
->
v¬ŸbËs
[
code
->
šdex
].
no_ÿch—bË
 = 0;

1683 
r
->
v¬ŸbËs
[
code
->
šdex
].
nÙ_found
 = 0;

1684 
r
->
v¬ŸbËs
[
code
->
šdex
].
d©a
 = 
e
->
¥
->data;

1686 #ià(
NGX_DEBUG
)

1688 
ngx_h‰p_v¬ŸbË_t
 *
v
;

1689 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

1691 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1693 
v
 = 
cmcf
->
v¬ŸbËs
.
–ts
;

1695 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1696 "h‰°süˆ£ˆ$%V", &
v
[
code
->
šdex
].
Çme
);

1699 
	}
}

1703 
	$ngx_h‰p_süt_v¬_£t_hªdËr_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1705 
ngx_h‰p_süt_v¬_hªdËr_code_t
 *
code
;

1707 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1710 
code
 = (
ngx_h‰p_süt_v¬_hªdËr_code_t
 *è
e
->

;

1712 
e
->

 +ð(
ngx_h‰p_süt_v¬_hªdËr_code_t
);

1714 
e
->
¥
--;

1716 
code
->
	`hªdËr
(
e
->
»que¡
,ƒ->
¥
, code->
d©a
);

1717 
	}
}

1721 
	$ngx_h‰p_süt_v¬_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1723 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v®ue
;

1724 
ngx_h‰p_süt_v¬_code_t
 *
code
;

1726 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1729 
code
 = (
ngx_h‰p_süt_v¬_code_t
 *è
e
->

;

1731 
e
->

 +ð(
ngx_h‰p_süt_v¬_code_t
);

1733 
v®ue
 = 
	`ngx_h‰p_g‘_æushed_v¬ŸbË
(
e
->
»que¡
, 
code
->
šdex
);

1735 ià(
v®ue
 && !v®ue->
nÙ_found
) {

1736 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
e
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

1737 "h‰°süˆv¬: \"%v\"", 
v®ue
);

1739 *
e
->
¥
 = *
v®ue
;

1740 
e
->
¥
++;

1745 *
e
->
¥
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

1746 
e
->
¥
++;

1747 
	}
}

1751 
	$ngx_h‰p_süt_nÝ_code
(
ngx_h‰p_süt_’gše_t
 *
e
)

1753 
e
->

 +ð(
ušŒ_t
);

1754 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_spdy.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngx_h‰p_¥dy_moduË.h
>

13 
	~<zlib.h
>

16 #ià(
NGX_HAVE_LITTLE_ENDIAN
 && 
NGX_HAVE_NONALIGNED
)

18 
	#ngx_¡r5cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
) \

19 *(
ušt32_t
 *è
m
 =ð(
c3
 << 24 | 
c2
 << 16 | 
c1
 << 8 | 
c0
) \

20 && 
m
[4] =ð
c4


	)

24 
	#ngx_¡r5cmp
(
m
, 
c0
, 
c1
, 
c2
, 
c3
, 
c4
) \

25 
m
[0] =ð
c0
 && m[1] =ð
c1
 && m[2] =ð
c2
 && m[3] =ð
c3
 && m[4] =ð
c4


	)

30 #ià(
NGX_HAVE_NONALIGNED
)

32 
	#ngx_¥dy_äame_·r£_ušt16
(
p
è
	`Áohs
(*(
ušt16_t
 *èÕ))

	)

33 
	#ngx_¥dy_äame_·r£_ušt32
(
p
è
	`Áohl
(*(
ušt32_t
 *èÕ))

	)

37 
	#ngx_¥dy_äame_·r£_ušt16
(
p
è(Õ)[0] << 8 | (p)[1])

	)

38 
	#ngx_¥dy_äame_·r£_ušt32
(
p
) \

39 ((
p
)[0] << 24 | (p)[1] << 16 | (p)[2] << 8 | (p)[3])

	)

43 
	#ngx_¥dy_äame_·r£_sid
(
p
) \

44 (
	`ngx_¥dy_äame_·r£_ušt32
(
p
è& 0x7fffffff)

	)

45 
	#ngx_¥dy_äame_·r£_d–
(
p
) \

46 (
	`ngx_¥dy_äame_·r£_ušt32
(
p
è& 0x7fffffff)

	)

49 
	#ngx_¥dy_ùl_äame_check
(
h
) \

50 (((
h
è& 0xffff0000è=ð
	`ngx_¥dy_ùl_äame_h—d
(0))

	)

51 
	#ngx_¥dy_d©a_äame_check
(
h
) \

52 (!((
h
è& (
ušt32_t
è
NGX_SPDY_CTL_BIT
 << 31))

	)

54 
	#ngx_¥dy_ùl_äame_ty³
(
h
è((hè& 0x0000ffff)

	)

55 
	#ngx_¥dy_äame_æags
(
p
è(Õè>> 24)

	)

56 
	#ngx_¥dy_äame_Ëngth
(
p
è(Õè& 0x00ffffff)

	)

57 
	#ngx_¥dy_äame_id
(
p
è(Õè& 0x00ffffff)

	)

60 
	#NGX_SPDY_SKIP_HEADERS_BUFFER_SIZE
 4096

	)

61 
	#NGX_SPDY_CTL_FRAME_BUFFER_SIZE
 16

	)

63 
	#NGX_SPDY_PROTOCOL_ERROR
 1

	)

64 
	#NGX_SPDY_INVALID_STREAM
 2

	)

65 
	#NGX_SPDY_REFUSED_STREAM
 3

	)

66 
	#NGX_SPDY_UNSUPPORTED_VERSION
 4

	)

67 
	#NGX_SPDY_CANCEL
 5

	)

68 
	#NGX_SPDY_INTERNAL_ERROR
 6

	)

69 
	#NGX_SPDY_FLOW_CONTROL_ERROR
 7

	)

70 
	#NGX_SPDY_STREAM_IN_USE
 8

	)

71 
	#NGX_SPDY_STREAM_ALREADY_CLOSED
 9

	)

73 
	#NGX_SPDY_FRAME_TOO_LARGE
 11

	)

75 
	#NGX_SPDY_SETTINGS_MAX_STREAMS
 4

	)

76 
	#NGX_SPDY_SETTINGS_INIT_WINDOW
 7

	)

78 
	#NGX_SPDY_SETTINGS_FLAG_PERSIST
 0x01

	)

79 
	#NGX_SPDY_SETTINGS_FLAG_PERSISTED
 0x02

	)

81 
	#NGX_SPDY_MAX_WINDOW
 
NGX_MAX_INT32_VALUE


	)

82 
	#NGX_SPDY_CONNECTION_WINDOW
 65536

	)

83 
	#NGX_SPDY_INIT_STREAM_WINDOW
 65536

	)

84 
	#NGX_SPDY_STREAM_WINDOW
 
NGX_SPDY_MAX_WINDOW


	)

87 
ngx_ušt_t
 
	mhash
;

88 
u_ch¬
 
	mËn
;

89 
u_ch¬
 
	mh—d”
[7];

90 
ngx_št_t
 (*
hªdËr
)(
ngx_h‰p_»que¡_t
 *
	mr
);

91 } 
	tngx_h‰p_¥dy_»que¡_h—d”_t
;

94 
ngx_h‰p_¥dy_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
);

95 
ngx_h‰p_¥dy_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
);

96 
ngx_h‰p_¥dy_hªdË_cÚÃùiÚ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
);

98 
u_ch¬
 *
ngx_h‰p_¥dy_´oxy_´ÙocÞ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

99 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

100 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_h—d
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

101 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

102 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_syn_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

103 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

104 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_h—d”s
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

105 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

106 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

107 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

108 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_h—d”s_”rÜ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

109 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

110 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_wšdow_upd©e
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

111 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

112 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_d©a
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

113 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

114 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_»ad_d©a
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

115 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

116 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_r¡_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

117 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

118 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_pšg
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

119 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

120 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_sk
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

121 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

122 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_£‰šgs
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

123 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

124 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_com¶‘e
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

125 
u_ch¬
 *
pos
, u_ch¬ *
’d
);

126 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_§ve
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

127 
u_ch¬
 *
pos
, u_ch¬ *
’d
, 
ngx_h‰p_¥dy_hªdËr_±
 
hªdËr
);

129 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_šæ©e_”rÜ
(

130 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
rc
);

131 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(

132 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
);

133 
u_ch¬
 *
ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(

134 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
);

136 
ngx_št_t
 
ngx_h‰p_¥dy_£nd_wšdow_upd©e
(

137 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_ušt_t
 
sid
,‚gx_ušt_ˆ
d–
);

138 
ngx_št_t
 
ngx_h‰p_¥dy_£nd_r¡_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

139 
ngx_ušt_t
 
sid
,‚gx_ušt_ˆ
¡©us
,‚gx_ušt_ˆ
´iÜ™y
);

140 
ngx_št_t
 
ngx_h‰p_¥dy_£nd_£‰šgs
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
);

141 
ngx_št_t
 
ngx_h‰p_¥dy_£‰šgs_äame_hªdËr
(

142 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_h‰p_¥dy_out_äame_t
 *
äame
);

143 
ngx_h‰p_¥dy_out_äame_t
 *
ngx_h‰p_¥dy_g‘_ùl_äame
(

144 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
size_t
 
size
, 
ngx_ušt_t
 
´iÜ™y
);

145 
ngx_št_t
 
ngx_h‰p_¥dy_ùl_äame_hªdËr
(

146 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_h‰p_¥dy_out_äame_t
 *
äame
);

148 
ngx_h‰p_¥dy_¡»am_t
 *
ngx_h‰p_¥dy_ü—‹_¡»am
(

149 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_ušt_t
 
id
,‚gx_ušt_ˆ
´iÜ™y
);

150 
ngx_h‰p_¥dy_¡»am_t
 *
ngx_h‰p_¥dy_g‘_¡»am_by_id
(

151 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_ušt_t
 
sid
);

152 
	#ngx_h‰p_¥dy_¡»ams_šdex_size
(
sscf
è(sscf->
¡»ams_šdex_mask
 + 1)

	)

153 
	#ngx_h‰p_¥dy_¡»am_šdex
(
sscf
, 
sid
) \

154 ((
sid
 >> 1è& 
sscf
->
¡»ams_šdex_mask
)

	)

156 
ngx_št_t
 
ngx_h‰p_¥dy_·r£_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

157 
ngx_št_t
 
ngx_h‰p_¥dy_®loc_Ïrge_h—d”_bufãr
(
ngx_h‰p_»que¡_t
 *
r
);

159 
ngx_št_t
 
ngx_h‰p_¥dy_hªdË_»que¡_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

160 
ngx_št_t
 
ngx_h‰p_¥dy_·r£_m‘hod
(
ngx_h‰p_»que¡_t
 *
r
);

161 
ngx_št_t
 
ngx_h‰p_¥dy_·r£_scheme
(
ngx_h‰p_»que¡_t
 *
r
);

162 
ngx_št_t
 
ngx_h‰p_¥dy_·r£_ho¡
(
ngx_h‰p_»que¡_t
 *
r
);

163 
ngx_št_t
 
ngx_h‰p_¥dy_·r£_·th
(
ngx_h‰p_»que¡_t
 *
r
);

164 
ngx_št_t
 
ngx_h‰p_¥dy_·r£_v”siÚ
(
ngx_h‰p_»que¡_t
 *
r
);

166 
ngx_št_t
 
ngx_h‰p_¥dy_cÚ¡ruù_»que¡_lše
(
ngx_h‰p_»que¡_t
 *
r
);

167 
ngx_h‰p_¥dy_run_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

168 
ngx_št_t
 
ngx_h‰p_¥dy_š™_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
);

170 
ngx_št_t
 
ngx_h‰p_¥dy_‹rmš©e_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

171 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
, 
ngx_ušt_t
 
¡©us
);

173 
ngx_h‰p_¥dy_þo£_¡»am_hªdËr
(
ngx_ev’t_t
 *
ev
);

175 
ngx_h‰p_¥dy_hªdË_cÚÃùiÚ_hªdËr
(
ngx_ev’t_t
 *
»v
);

176 
ngx_h‰p_¥dy_k“·live_hªdËr
(
ngx_ev’t_t
 *
»v
);

177 
ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

178 
ngx_št_t
 
rc
);

180 
ngx_št_t
 
ngx_h‰p_¥dy_adju¡_wšdows
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

181 
ssize_t
 
d–
);

183 
ngx_h‰p_¥dy_poÞ_þ—nup
(*
d©a
);

185 *
ngx_h‰p_¥dy_z®loc
(*
Ýaque
, 
u_št
 
™ems
, u_šˆ
size
);

186 
ngx_h‰p_¥dy_zä“
(*
Ýaque
, *
add»ss
);

189 cÚ¡ 
u_ch¬
 
	gngx_h‰p_¥dy_diù
[] = {

371 
ngx_h‰p_¥dy_»que¡_h—d”_t
 
	gngx_h‰p_¥dy_»que¡_h—d”s
[] = {

372 { 0, 6, "m‘hod", 
ngx_h‰p_¥dy_·r£_m‘hod
 },

373 { 0, 6, "scheme", 
ngx_h‰p_¥dy_·r£_scheme
 },

374 { 0, 4, "ho¡", 
ngx_h‰p_¥dy_·r£_ho¡
 },

375 { 0, 4, "·th", 
ngx_h‰p_¥dy_·r£_·th
 },

376 { 0, 7, "v”siÚ", 
ngx_h‰p_¥dy_·r£_v”siÚ
 },

379 
	#NGX_SPDY_REQUEST_HEADERS
 \

380 ((
ngx_h‰p_¥dy_»que¡_h—d”s
) \

381 / (
ngx_h‰p_¥dy_»que¡_h—d”_t
))

	)

385 
	$ngx_h‰p_¥dy_š™
(
ngx_ev’t_t
 *
»v
)

387 
rc
;

388 
ngx_cÚÃùiÚ_t
 *
c
;

389 
ngx_poÞ_þ—nup_t
 *
þn
;

390 
ngx_h‰p_cÚÃùiÚ_t
 *
hc
;

391 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

392 
ngx_h‰p_¥dy_maš_cÚf_t
 *
smcf
;

393 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
;

395 
c
 = 
»v
->
d©a
;

396 
hc
 = 
c
->
d©a
;

398 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "init spdy„equest");

400 
c
->
log
->
aùiÚ
 = "processing SPDY";

402 
smcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
hc
->
cÚf_ùx
, 
ngx_h‰p_¥dy_moduË
);

404 ià(
smcf
->
»cv_bufãr
 =ð
NULL
) {

405 
smcf
->
»cv_bufãr
 = 
	`ngx_·Îoc
(
ngx_cyþe
->
poÞ
, smcf->
»cv_bufãr_size
);

406 ià(
smcf
->
»cv_bufãr
 =ð
NULL
) {

407 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

412 
sc
 = 
	`ngx_pÿÎoc
(
c
->
poÞ
, (
ngx_h‰p_¥dy_cÚÃùiÚ_t
));

413 ià(
sc
 =ð
NULL
) {

414 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

418 
sc
->
cÚÃùiÚ
 = 
c
;

419 
sc
->
h‰p_cÚÃùiÚ
 = 
hc
;

421 
sc
->
£nd_wšdow
 = 
NGX_SPDY_CONNECTION_WINDOW
;

422 
sc
->
»cv_wšdow
 = 
NGX_SPDY_CONNECTION_WINDOW
;

424 
sc
->
š™_wšdow
 = 
NGX_SPDY_INIT_STREAM_WINDOW
;

426 
sc
->
hªdËr
 = 
hc
->
´oxy_´ÙocÞ
 ? 
ngx_h‰p_¥dy_´oxy_´ÙocÞ


427 : 
ngx_h‰p_¥dy_¡©e_h—d
;

429 
sc
->
z¡»am_š
.
z®loc
 = 
ngx_h‰p_¥dy_z®loc
;

430 
sc
->
z¡»am_š
.
zä“
 = 
ngx_h‰p_¥dy_zä“
;

431 
sc
->
z¡»am_š
.
Ýaque
 = sc;

433 
rc
 = 
	`šæ©eIn™
(&
sc
->
z¡»am_š
);

434 ià(
rc
 !ð
Z_OK
) {

435 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

436 "šæ©eIn™(èçžed: %d", 
rc
);

437 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

441 
sc
->
z¡»am_out
.
z®loc
 = 
ngx_h‰p_¥dy_z®loc
;

442 
sc
->
z¡»am_out
.
zä“
 = 
ngx_h‰p_¥dy_zä“
;

443 
sc
->
z¡»am_out
.
Ýaque
 = sc;

445 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
hc
->
cÚf_ùx
, 
ngx_h‰p_¥dy_moduË
);

447 
rc
 = 
	`deæ©eIn™2
(&
sc
->
z¡»am_out
, (è
sscf
->
h—d”s_comp
,

448 
Z_DEFLATED
, 11, 4, 
Z_DEFAULT_STRATEGY
);

450 ià(
rc
 !ð
Z_OK
) {

451 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

452 "deæ©eIn™2(èçžed: %d", 
rc
);

453 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

457 
rc
 = 
	`deæ©eS‘DiùiÚ¬y
(&
sc
->
z¡»am_out
, 
ngx_h‰p_¥dy_diù
,

458 (
ngx_h‰p_¥dy_diù
));

459 ià(
rc
 !ð
Z_OK
) {

460 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

461 "deæ©eS‘DiùiÚ¬y(èçžed: %d", 
rc
);

462 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

466 
sc
->
poÞ
 = 
	`ngx_ü—‹_poÞ
(
sscf
->
poÞ_size
, sc->
cÚÃùiÚ
->
log
);

467 ià(
sc
->
poÞ
 =ð
NULL
) {

468 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

472 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
c
->
poÞ
, (
ngx_poÞ_þ—nup_fže_t
));

473 ià(
þn
 =ð
NULL
) {

474 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

478 
þn
->
hªdËr
 = 
ngx_h‰p_¥dy_poÞ_þ—nup
;

479 
þn
->
d©a
 = 
sc
;

481 
sc
->
¡»ams_šdex
 = 
	`ngx_pÿÎoc
(sc->
poÞ
,

482 
	`ngx_h‰p_¥dy_¡»ams_šdex_size
(
sscf
)

483 * (
ngx_h‰p_¥dy_¡»am_t
 *));

484 ià(
sc
->
¡»ams_šdex
 =ð
NULL
) {

485 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

489 ià(
	`ngx_h‰p_¥dy_£nd_£‰šgs
(
sc
è=ð
NGX_ERROR
) {

490 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

494 ià(
	`ngx_h‰p_¥dy_£nd_wšdow_upd©e
(
sc
, 0, 
NGX_SPDY_MAX_WINDOW


495 - 
sc
->
»cv_wšdow
)

496 =ð
NGX_ERROR
)

498 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

502 
sc
->
»cv_wšdow
 = 
NGX_SPDY_MAX_WINDOW
;

504 
	`ngx_queue_š™
(&
sc
->
wa™šg
);

505 
	`ngx_queue_š™
(&
sc
->
po¡ed
);

507 
c
->
d©a
 = 
sc
;

509 
»v
->
hªdËr
 = 
ngx_h‰p_¥dy_»ad_hªdËr
;

510 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_¥dy_wr™e_hªdËr
;

512 
	`ngx_h‰p_¥dy_»ad_hªdËr
(
»v
);

513 
	}
}

517 
	$ngx_h‰p_¥dy_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
)

519 
u_ch¬
 *
p
, *
’d
;

520 
size_t
 
avažabË
;

521 
ssize_t
 
n
;

522 
ngx_cÚÃùiÚ_t
 *
c
;

523 
ngx_h‰p_¥dy_maš_cÚf_t
 *
smcf
;

524 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
;

526 
c
 = 
»v
->
d©a
;

527 
sc
 = 
c
->
d©a
;

529 ià(
»v
->
timedout
) {

530 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

531 
	`ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
sc
, 
NGX_HTTP_REQUEST_TIME_OUT
);

535 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "spdy„ead handler");

537 
sc
->
blocked
 = 1;

539 
smcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

540 
ngx_h‰p_¥dy_moduË
);

542 
avažabË
 = 
smcf
->
»cv_bufãr_size
 - 2 * 
NGX_SPDY_STATE_BUFFER_SIZE
;

545 
p
 = 
smcf
->
»cv_bufãr
;

547 
	`ngx_memýy
(
p
, 
sc
->
bufãr
, 
NGX_SPDY_STATE_BUFFER_SIZE
);

548 
’d
 = 
p
 + 
sc
->
bufãr_u£d
;

550 
n
 = 
c
->
	`»cv
(c, 
’d
, 
avažabË
);

552 ià(
n
 =ð
NGX_AGAIN
) {

556 ià(
n
 =ð0 && (
sc
->
šcom¶‘e
 || sc->
´oûssšg
)) {

557 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

561 ià(
n
 =ð0 ||‚ =ð
NGX_ERROR
) {

562 
	`ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
sc
,

563 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

567 
’d
 +ð
n
;

569 
sc
->
bufãr_u£d
 = 0;

570 
sc
->
šcom¶‘e
 = 0;

573 
p
 = 
sc
->
	`hªdËr
(sc,…, 
’d
);

575 ià(
p
 =ð
NULL
) {

579 } 
p
 !ð
’d
);

581 } 
»v
->
»ady
);

583 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

584 
	`ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
sc
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

588 ià(
sc
->
Ï¡_out
 && 
	`ngx_h‰p_¥dy_£nd_ouut_queue
(scè=ð
NGX_ERROR
) {

589 
	`ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
sc
, 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

593 
sc
->
blocked
 = 0;

595 ià(
sc
->
´oûssšg
) {

596 ià(
»v
->
tim”_£t
) {

597 
	`ngx_d–_tim”
(
»v
);

602 
	`ngx_h‰p_¥dy_hªdË_cÚÃùiÚ
(
sc
);

603 
	}
}

607 
	$ngx_h‰p_¥dy_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
)

609 
ngx_št_t
 
rc
;

610 
ngx_queue_t
 *
q
;

611 
ngx_cÚÃùiÚ_t
 *
c
;

612 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

613 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
;

615 
c
 = 
wev
->
d©a
;

616 
sc
 = 
c
->
d©a
;

618 ià(
wev
->
timedout
) {

619 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

621 
	`ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
sc
, 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

625 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "spdy write handler");

627 
sc
->
blocked
 = 1;

629 
rc
 = 
	`ngx_h‰p_¥dy_£nd_ouut_queue
(
sc
);

631 ià(
rc
 =ð
NGX_ERROR
) {

632 
	`ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
sc
, 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

636 !
	`ngx_queue_em±y
(&
sc
->
po¡ed
)) {

637 
q
 = 
	`ngx_queue_h—d
(&
sc
->
po¡ed
);

639 
	`ngx_queue_»move
(
q
);

641 
¡»am
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_¥dy_¡»am_t
, 
queue
);

643 
¡»am
->
hªdËd
 = 0;

645 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

646 "ruÀ¥dy sŒ—m %ui", 
¡»am
->
id
);

648 
wev
 = 
¡»am
->
»que¡
->
cÚÃùiÚ
->
wr™e
;

649 
wev
->
	`hªdËr
(wev);

652 
sc
->
blocked
 = 0;

654 ià(
rc
 =ð
NGX_AGAIN
) {

658 
	`ngx_h‰p_¥dy_hªdË_cÚÃùiÚ
(
sc
);

659 
	}
}

662 
ngx_št_t


663 
	$ngx_h‰p_¥dy_£nd_ouut_queue
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
)

665 
ngx_chaš_t
 *
þ
;

666 
ngx_ev’t_t
 *
wev
;

667 
ngx_cÚÃùiÚ_t
 *
c
;

668 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

669 
ngx_h‰p_¥dy_out_äame_t
 *
out
, *
äame
, *
â
;

671 
c
 = 
sc
->
cÚÃùiÚ
;

673 ià(
c
->
”rÜ
) {

674  
NGX_ERROR
;

677 
wev
 = 
c
->
wr™e
;

679 ià(!
wev
->
»ady
) {

680  
NGX_OK
;

683 
þ
 = 
NULL
;

684 
out
 = 
NULL
;

686 
äame
 = 
sc
->
Ï¡_out
; f¿me; f¿mð
â
) {

687 
äame
->
Ï¡
->
Ãxt
 = 
þ
;

688 
þ
 = 
äame
->
fœ¡
;

690 
â
 = 
äame
->
Ãxt
;

691 
äame
->
Ãxt
 = 
out
;

692 
out
 = 
äame
;

694 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

696 
out
, out->
¡»am
 ? out->¡»am->
id
 : 0, out->
´iÜ™y
,

697 
out
->
blocked
, out->
Ëngth
);

700 
þ
 = 
c
->
	`£nd_chaš
(c, cl, 0);

702 ià(
þ
 =ð
NGX_CHAIN_ERROR
) {

703 
c
->
”rÜ
 = 1;

705 ià(!
sc
->
blocked
) {

706 
	`ngx_po¡_ev’t
(
wev
, &
ngx_po¡ed_ev’ts
);

709  
NGX_ERROR
;

712 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

713 
ngx_h‰p_cÜe_moduË
);

715 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 
þcf
->
£nd_low©
è!ð
NGX_OK
) {

716  
NGX_ERROR
;

719 ià(
þ
) {

720 
	`ngx_add_tim”
(
wev
, 
þcf
->
£nd_timeout
);

723 ià(
wev
->
tim”_£t
) {

724 
	`ngx_d–_tim”
(
wev
);

728  ; 
out
; ouˆð
â
) {

729 
â
 = 
out
->
Ãxt
;

731 ià(
out
->
	`hªdËr
(
sc
, outè!ð
NGX_OK
) {

732 
out
->
blocked
 = 1;

733 
out
->
´iÜ™y
 = 
NGX_SPDY_HIGHEST_PRIORITY
;

737 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

739 
out
, out->
¡»am
 ? out->¡»am->
id
 : 0,

740 
out
->
blocked
, out->
Ëngth
);

743 
äame
 = 
NULL
;

745  ; 
out
; ouˆð
â
) {

746 
â
 = 
out
->
Ãxt
;

747 
out
->
Ãxt
 = 
äame
;

748 
äame
 = 
out
;

751 
sc
->
Ï¡_out
 = 
äame
;

753  
NGX_OK
;

754 
	}
}

758 
	$ngx_h‰p_¥dy_hªdË_cÚÃùiÚ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
)

760 
ngx_cÚÃùiÚ_t
 *
c
;

761 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

763 ià(
sc
->
Ï¡_out
 || sc->
´oûssšg
) {

767 
c
 = 
sc
->
cÚÃùiÚ
;

769 ià(
c
->
”rÜ
) {

770 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

774 ià(
c
->
bufã»d
) {

778 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

779 
ngx_h‰p_¥dy_moduË
);

780 ià(
sc
->
šcom¶‘e
) {

781 
	`ngx_add_tim”
(
c
->
»ad
, 
sscf
->
»cv_timeout
);

785 ià(
ngx_‹rmš©e
 || 
ngx_ex™šg
) {

786 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

790 
	`ngx_de¡roy_poÞ
(
sc
->
poÞ
);

792 
sc
->
poÞ
 = 
NULL
;

793 
sc
->
ä“_ùl_äames
 = 
NULL
;

794 
sc
->
ä“_çke_cÚÃùiÚs
 = 
NULL
;

796 #ià(
NGX_HTTP_SSL
)

797 ià(
c
->
s¦
) {

798 
	`ngx_s¦_ä“_bufãr
(
c
);

802 
c
->
de¡royed
 = 1;

803 
c
->
idË
 = 1;

804 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 1);

806 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_em±y_hªdËr
;

807 
c
->
»ad
->
hªdËr
 = 
ngx_h‰p_¥dy_k“·live_hªdËr
;

809 ià(
c
->
wr™e
->
tim”_£t
) {

810 
	`ngx_d–_tim”
(
c
->
wr™e
);

813 
	`ngx_add_tim”
(
c
->
»ad
, 
sscf
->
k“·live_timeout
);

814 
	}
}

817 
u_ch¬
 *

818 
	$ngx_h‰p_¥dy_´oxy_´ÙocÞ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

819 
u_ch¬
 *
’d
)

821 
ngx_log_t
 *
log
;

823 
log
 = 
sc
->
cÚÃùiÚ
->log;

824 
log
->
aùiÚ
 = "reading PROXY…rotocol";

826 
pos
 = 
	`ngx_´oxy_´ÙocÞ_·r£
(
sc
->
cÚÃùiÚ
,…os, 
’d
);

828 
log
->
aùiÚ
 = "processing SPDY";

830 ià(
pos
 =ð
NULL
) {

831  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

834  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

835 
	}
}

838 
u_ch¬
 *

839 
	$ngx_h‰p_¥dy_¡©e_h—d
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

840 
u_ch¬
 *
’d
)

842 
ušt32_t
 
h—d
, 
æ’
;

843 
ngx_ušt_t
 
ty³
;

845 ià(
’d
 - 
pos
 < 
NGX_SPDY_FRAME_HEADER_SIZE
) {

846  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

847 
ngx_h‰p_¥dy_¡©e_h—d
);

850 
h—d
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
pos
);

852 
pos
 +ð(
ušt32_t
);

854 
æ’
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
pos
);

856 
sc
->
æags
 = 
	`ngx_¥dy_äame_æags
(
æ’
);

857 
sc
->
Ëngth
 = 
	`ngx_¥dy_äame_Ëngth
(
æ’
);

859 
pos
 +ð(
ušt32_t
);

861 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

863 
h—d
, 
sc
->
æags
, sc->
Ëngth
);

865 ià(
	`ngx_¥dy_ùl_äame_check
(
h—d
)) {

866 
ty³
 = 
	`ngx_¥dy_ùl_äame_ty³
(
h—d
);

868 
ty³
) {

870 
NGX_SPDY_SYN_STREAM
:

871  
	`ngx_h‰p_¥dy_¡©e_syn_¡»am
(
sc
, 
pos
, 
’d
);

873 
NGX_SPDY_SYN_REPLY
:

874 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

876  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

878 
NGX_SPDY_RST_STREAM
:

879  
	`ngx_h‰p_¥dy_¡©e_r¡_¡»am
(
sc
, 
pos
, 
’d
);

881 
NGX_SPDY_SETTINGS
:

882  
	`ngx_h‰p_¥dy_¡©e_£‰šgs
(
sc
, 
pos
, 
’d
);

884 
NGX_SPDY_PING
:

885  
	`ngx_h‰p_¥dy_¡©e_pšg
(
sc
, 
pos
, 
’d
);

887 
NGX_SPDY_GOAWAY
:

888  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

890 
NGX_SPDY_HEADERS
:

891 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

893  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

895 
NGX_SPDY_WINDOW_UPDATE
:

896  
	`ngx_h‰p_¥dy_¡©e_wšdow_upd©e
(
sc
, 
pos
, 
’d
);

899 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

900 "¥dy cÚŒÞ f¿mw™h unknowÀty³ %ui", 
ty³
);

901  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

905 ià(
	`ngx_¥dy_d©a_äame_check
(
h—d
)) {

906 
sc
->
¡»am
 = 
	`ngx_h‰p_¥dy_g‘_¡»am_by_id
(sc, 
h—d
);

907  
	`ngx_h‰p_¥dy_¡©e_d©a
(
sc
, 
pos
, 
’d
);

910 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

913  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

914 
	}
}

917 
u_ch¬
 *

918 
	$ngx_h‰p_¥dy_¡©e_syn_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

919 
u_ch¬
 *
’d
)

921 
ngx_ušt_t
 
sid
, 
´io
;

922 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

923 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

925 ià(
’d
 - 
pos
 < 
NGX_SPDY_SYN_STREAM_SIZE
) {

926  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

927 
ngx_h‰p_¥dy_¡©e_syn_¡»am
);

930 ià(
sc
->
Ëngth
 <ð
NGX_SPDY_SYN_STREAM_SIZE
) {

931 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

933 
sc
->
Ëngth
);

935  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

938 
sc
->
Ëngth
 -ð
NGX_SPDY_SYN_STREAM_SIZE
;

940 
sid
 = 
	`ngx_¥dy_äame_·r£_sid
(
pos
);

941 
´io
 = 
pos
[8] >> 5;

943 
pos
 +ð
NGX_SPDY_SYN_STREAM_SIZE
;

945 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

946 "¥dy SYN_STREAM f¿msid:%u˜´io:%ui", 
sid
, 
´io
);

948 ià(
sid
 % 2 =ð0 || sid <ð
sc
->
Ï¡_sid
) {

949 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

951 "w™h inv®id SŒ—m-ID %ui", 
sid
);

953 
¡»am
 = 
	`ngx_h‰p_¥dy_g‘_¡»am_by_id
(
sc
, 
sid
);

955 ià(
¡»am
) {

956 ià(
	`ngx_h‰p_¥dy_‹rmš©e_¡»am
(
sc
, 
¡»am
,

957 
NGX_SPDY_PROTOCOL_ERROR
)

958 !ð
NGX_OK
)

960  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

964  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

967 
sc
->
Ï¡_sid
 = 
sid
;

969 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

970 
ngx_h‰p_¥dy_moduË
);

972 ià(
sc
->
´oûssšg
 >ð
sscf
->
cÚcu¼’t_¡»ams
) {

974 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

975 "cÚcu¼’ˆ¡»am exûeded %ui", 
sc
->
´oûssšg
);

977 ià(
	`ngx_h‰p_¥dy_£nd_r¡_¡»am
(
sc
, 
sid
, 
NGX_SPDY_REFUSED_STREAM
,

978 
´io
)

979 !ð
NGX_OK
)

981  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

984  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

987 
¡»am
 = 
	`ngx_h‰p_¥dy_ü—‹_¡»am
(
sc
, 
sid
, 
´io
);

988 ià(
¡»am
 =ð
NULL
) {

989  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

992 
¡»am
->
š_þo£d
 = (
sc
->
æags
 & 
NGX_SPDY_FLAG_FIN
) ? 1 : 0;

994 
¡»am
->
»que¡
->
»que¡_Ëngth
 = 
NGX_SPDY_FRAME_HEADER_SIZE


995 + 
NGX_SPDY_SYN_STREAM_SIZE


996 + 
sc
->
Ëngth
;

998 
sc
->
¡»am
 = stream;

1000  
	`ngx_h‰p_¥dy_¡©e_h—d”s
(
sc
, 
pos
, 
’d
);

1001 
	}
}

1004 
u_ch¬
 *

1005 
	$ngx_h‰p_¥dy_¡©e_h—d”s
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1006 
u_ch¬
 *
’d
)

1008 
z
;

1009 
size_t
 
size
;

1010 
ngx_buf_t
 *
buf
;

1011 
ngx_št_t
 
rc
;

1012 
ngx_h‰p_»que¡_t
 *
r
;

1014 
size
 = 
’d
 - 
pos
;

1016 ià(
size
 == 0) {

1017  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1018 
ngx_h‰p_¥dy_¡©e_h—d”s
);

1021 ià(
size
 > 
sc
->
Ëngth
) {

1022 
size
 = 
sc
->
Ëngth
;

1025 
r
 = 
sc
->
¡»am
->
»que¡
;

1027 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1028 "´oûs ¥dy h—d” block %uz oà%uz", 
size
, 
sc
->
Ëngth
);

1030 
buf
 = 
r
->
h—d”_š
;

1032 
sc
->
z¡»am_š
.
Ãxt_š
 = 
pos
;

1033 
sc
->
z¡»am_š
.
avaž_š
 = 
size
;

1034 
sc
->
z¡»am_š
.
Ãxt_out
 = 
buf
->
Ï¡
;

1037 
sc
->
z¡»am_š
.
avaž_out
 = 
buf
->
’d
 - buf->
Ï¡
 - 1;

1039 
z
 = 
	`šæ©e
(&
sc
->
z¡»am_š
, 
Z_NO_FLUSH
);

1041 ià(
z
 =ð
Z_NEED_DICT
) {

1042 
z
 = 
	`šæ©eS‘DiùiÚ¬y
(&
sc
->
z¡»am_š
, 
ngx_h‰p_¥dy_diù
,

1043 (
ngx_h‰p_¥dy_diù
));

1045 ià(
z
 !ð
Z_OK
) {

1046 ià(
z
 =ð
Z_DATA_ERROR
) {

1047 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1050 (
u_lÚg
è
sc
->
z¡»am_š
.
adËr
);

1052  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1055 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1056 "šæ©eS‘DiùiÚ¬y(èçžed: %d", 
z
);

1058  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1061 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1062 "¥dy inæ©eS‘DiùiÚ¬y(): %d", 
z
);

1064 
z
 = 
sc
->
z¡»am_š
.
avaž_š
 ? 
	`šæ©e
(&sc->z¡»am_š, 
Z_NO_FLUSH
)

1065 : 
Z_OK
;

1068 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1070 
sc
->
z¡»am_š
.
Ãxt_š
, sc->z¡»am_š.
Ãxt_out
,

1071 
sc
->
z¡»am_š
.
avaž_š
, sc->z¡»am_š.
avaž_out
,

1072 
z
);

1074 ià(
z
 !ð
Z_OK
) {

1075  
	`ngx_h‰p_¥dy_¡©e_šæ©e_”rÜ
(
sc
, 
z
);

1078 
sc
->
Ëngth
 -ðsc->
z¡»am_š
.
Ãxt_š
 - 
pos
;

1079 
pos
 = 
sc
->
z¡»am_š
.
Ãxt_š
;

1081 
buf
->
Ï¡
 = 
sc
->
z¡»am_š
.
Ãxt_out
;

1083 ià(
r
->
h—d”s_š
.
h—d”s
.
·¹
.
–ts
 =ð
NULL
) {

1085 ià(
buf
->
Ï¡
 - buf->
pos
 < 
NGX_SPDY_NV_NUM_SIZE
) {

1087 ià(
sc
->
Ëngth
 == 0) {

1088 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1091  
	`ngx_h‰p_¥dy_¡©e_h—d”s_”rÜ
(
sc
, 
pos
, 
’d
);

1094  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1095 
ngx_h‰p_¥dy_¡©e_h—d”s
);

1098 
sc
->
’Œ›s
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
buf
->
pos
);

1100 
buf
->
pos
 +ð
NGX_SPDY_NV_NUM_SIZE
;

1102 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1104 
sc
->
’Œ›s
);

1106 ià(
	`ngx_li¡_š™
(&
r
->
h—d”s_š
.
h—d”s
,„->
poÞ
, 20,

1107 (
ngx_bË_–t_t
))

1108 !ð
NGX_OK
)

1110 
	`ngx_h‰p_¥dy_þo£_¡»am
(
sc
->
¡»am
,

1111 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1112  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

1115 ià(
	`ngx_¬¿y_š™
(&
r
->
h—d”s_š
.
cook›s
,„->
poÞ
, 2,

1116 (
ngx_bË_–t_t
 *))

1117 !ð
NGX_OK
)

1119 
	`ngx_h‰p_¥dy_þo£_¡»am
(
sc
->
¡»am
,

1120 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1121  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

1125 
sc
->
’Œ›s
) {

1127 
rc
 = 
	`ngx_h‰p_¥dy_·r£_h—d”
(
r
);

1129 
rc
) {

1131 
NGX_DONE
:

1132 
sc
->
’Œ›s
--;

1134 
NGX_OK
:

1137 
NGX_AGAIN
:

1139 ià(
sc
->
z¡»am_š
.
avaž_š
) {

1141 
rc
 = 
	`ngx_h‰p_¥dy_®loc_Ïrge_h—d”_bufãr
(
r
);

1143 ià(
rc
 =ð
NGX_DECLINED
) {

1144 
	`ngx_h‰p_fš®ize_»que¡
(
r
,

1145 
NGX_HTTP_REQUEST_HEADER_TOO_LARGE
);

1146  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

1149 ià(
rc
 !ð
NGX_OK
) {

1150 
	`ngx_h‰p_¥dy_þo£_¡»am
(
sc
->
¡»am
,

1151 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1152  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

1156 *
buf
->
pos
 = '\0';

1158 
buf
 = 
r
->
h—d”_š
;

1160 
sc
->
z¡»am_š
.
Ãxt_out
 = 
buf
->
Ï¡
;

1163 
sc
->
z¡»am_š
.
avaž_out
 = 
buf
->
’d
 - buf->
Ï¡
 - 1;

1165 
z
 = 
	`šæ©e
(&
sc
->
z¡»am_š
, 
Z_NO_FLUSH
);

1167 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1169 
sc
->
z¡»am_š
.
Ãxt_š
, sc->z¡»am_š.
Ãxt_out
,

1170 
sc
->
z¡»am_š
.
avaž_š
, sc->z¡»am_š.
avaž_out
,

1171 
z
);

1173 ià(
z
 !ð
Z_OK
) {

1174  
	`ngx_h‰p_¥dy_¡©e_šæ©e_”rÜ
(
sc
, 
z
);

1177 
sc
->
Ëngth
 -ðsc->
z¡»am_š
.
Ãxt_š
 - 
pos
;

1178 
pos
 = 
sc
->
z¡»am_š
.
Ãxt_š
;

1180 
buf
->
Ï¡
 = 
sc
->
z¡»am_š
.
Ãxt_out
;

1185 ià(
sc
->
Ëngth
 == 0) {

1186 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1189  
	`ngx_h‰p_¥dy_¡©e_h—d”s_”rÜ
(
sc
, 
pos
, 
’d
);

1192  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1193 
ngx_h‰p_¥dy_¡©e_h—d”s
);

1195 
NGX_HTTP_PARSE_INVALID_HEADER
:

1196 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1197  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

1200  
	`ngx_h‰p_¥dy_¡©e_h—d”s_”rÜ
(
sc
, 
pos
, 
’d
);

1205 
rc
 = 
	`ngx_h‰p_¥dy_hªdË_»que¡_h—d”
(
r
);

1207 ià(
rc
 !ð
NGX_OK
) {

1208 ià(
rc
 =ð
NGX_HTTP_PARSE_INVALID_HEADER
) {

1209 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

1210  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

1213 ià(
rc
 !ð
NGX_ABORT
) {

1214 
	`ngx_h‰p_¥dy_þo£_¡»am
(
sc
->
¡»am
,

1215 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1218  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

1222 ià(
buf
->
pos
 !ðbuf->
Ï¡
 || 
sc
->
z¡»am_š
.
avaž_š
) {

1223 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1226  
	`ngx_h‰p_¥dy_¡©e_h—d”s_”rÜ
(
sc
, 
pos
, 
’d
);

1229 ià(
sc
->
Ëngth
) {

1230  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1231 
ngx_h‰p_¥dy_¡©e_h—d”s
);

1235 *
buf
->
pos
 = '\0';

1237 
	`ngx_h‰p_¥dy_run_»que¡
(
r
);

1239  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1240 
	}
}

1243 
u_ch¬
 *

1244 
	$ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1245 
u_ch¬
 *
’d
)

1247 
n
;

1248 
size_t
 
size
;

1249 
u_ch¬
 
bufãr
[
NGX_SPDY_SKIP_HEADERS_BUFFER_SIZE
];

1251 ià(
sc
->
Ëngth
 == 0) {

1252  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1255 
size
 = 
’d
 - 
pos
;

1257 ià(
size
 == 0) {

1258  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1259 
ngx_h‰p_¥dy_¡©e_h—d”s_sk
);

1262 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1263 "¥dy h—d” block sk %uz oà%uz", 
size
, 
sc
->
Ëngth
);

1265 
sc
->
z¡»am_š
.
Ãxt_š
 = 
pos
;

1266 
sc
->
z¡»am_š
.
avaž_š
 = (
size
 < sc->
Ëngth
) ? size : sc->length;

1268 
sc
->
z¡»am_š
.
avaž_š
) {

1269 
sc
->
z¡»am_š
.
Ãxt_out
 = 
bufãr
;

1270 
sc
->
z¡»am_š
.
avaž_out
 = 
NGX_SPDY_SKIP_HEADERS_BUFFER_SIZE
;

1272 
n
 = 
	`šæ©e
(&
sc
->
z¡»am_š
, 
Z_NO_FLUSH
);

1274 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1276 
sc
->
z¡»am_š
.
Ãxt_š
, sc->z¡»am_š.
Ãxt_out
,

1277 
sc
->
z¡»am_š
.
avaž_š
, sc->z¡»am_š.
avaž_out
,

1278 
n
);

1280 ià(
n
 !ð
Z_OK
) {

1281  
	`ngx_h‰p_¥dy_¡©e_šæ©e_”rÜ
(
sc
, 
n
);

1285 
pos
 = 
sc
->
z¡»am_š
.
Ãxt_š
;

1287 ià(
size
 < 
sc
->
Ëngth
) {

1288 
sc
->
Ëngth
 -ð
size
;

1289  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1290 
ngx_h‰p_¥dy_¡©e_h—d”s_sk
);

1293  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1294 
	}
}

1297 
u_ch¬
 *

1298 
	$ngx_h‰p_¥dy_¡©e_h—d”s_”rÜ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1299 
u_ch¬
 *
’d
)

1301 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

1303 
¡»am
 = 
sc
->stream;

1305 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1307 "w™h inv®id h—d” block", 
¡»am
->
id
);

1309 ià(
	`ngx_h‰p_¥dy_£nd_r¡_¡»am
(
sc
, 
¡»am
->
id
, 
NGX_SPDY_PROTOCOL_ERROR
,

1310 
¡»am
->
´iÜ™y
)

1311 !ð
NGX_OK
)

1313  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1316 
¡»am
->
out_þo£d
 = 1;

1318 
	`ngx_h‰p_¥dy_þo£_¡»am
(
¡»am
, 
NGX_HTTP_BAD_REQUEST
);

1320  
	`ngx_h‰p_¥dy_¡©e_h—d”s_sk
(
sc
, 
pos
, 
’d
);

1321 
	}
}

1324 
u_ch¬
 *

1325 
	$ngx_h‰p_¥dy_¡©e_wšdow_upd©e
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1326 
u_ch¬
 *
’d
)

1328 
size_t
 
d–
;

1329 
ngx_ušt_t
 
sid
;

1330 
ngx_ev’t_t
 *
wev
;

1331 
ngx_queue_t
 *
q
;

1332 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

1334 ià(
’d
 - 
pos
 < 
NGX_SPDY_WINDOW_UPDATE_SIZE
) {

1335  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1336 
ngx_h‰p_¥dy_¡©e_wšdow_upd©e
);

1339 ià(
sc
->
Ëngth
 !ð
NGX_SPDY_WINDOW_UPDATE_SIZE
) {

1340 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1342 "w™h incÜ»ù†’gth %uz", 
sc
->
Ëngth
);

1344  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1347 
sid
 = 
	`ngx_¥dy_äame_·r£_sid
(
pos
);

1349 
pos
 +ð
NGX_SPDY_SID_SIZE
;

1351 
d–
 = 
	`ngx_¥dy_äame_·r£_d–
(
pos
);

1353 
pos
 +ð
NGX_SPDY_DELTA_SIZE
;

1355 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1356 "¥dy WINDOW_UPDATE sid:%u˜d–:%ui", 
sid
, 
d–
);

1358 ià(
sid
) {

1359 
¡»am
 = 
	`ngx_h‰p_¥dy_g‘_¡»am_by_id
(
sc
, 
sid
);

1361 ià(
¡»am
 =ð
NULL
) {

1362 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1365  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1368 ià(
¡»am
->
£nd_wšdow
 > (
ssize_t
è(
NGX_SPDY_MAX_WINDOW
 - 
d–
)) {

1370 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1374 
sid
, 
d–
, 
¡»am
->
£nd_wšdow
);

1376 ià(
	`ngx_h‰p_¥dy_‹rmš©e_¡»am
(
sc
, 
¡»am
,

1377 
NGX_SPDY_FLOW_CONTROL_ERROR
)

1378 =ð
NGX_ERROR
)

1380  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1383  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1386 
¡»am
->
£nd_wšdow
 +ð
d–
;

1388 ià(
¡»am
->
exhau¡ed
) {

1389 
¡»am
->
exhau¡ed
 = 0;

1391 
wev
 = 
¡»am
->
»que¡
->
cÚÃùiÚ
->
wr™e
;

1393 ià(!
wev
->
tim”_£t
) {

1394 
wev
->
d–ayed
 = 0;

1395 
wev
->
	`hªdËr
(wev);

1400 
sc
->
£nd_wšdow
 +ð
d–
;

1402 ià(
sc
->
£nd_wšdow
 > 
NGX_SPDY_MAX_WINDOW
) {

1403 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1407 
d–
, 
sc
->
£nd_wšdow
);

1409  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1412 !
	`ngx_queue_em±y
(&
sc
->
wa™šg
)) {

1413 
q
 = 
	`ngx_queue_h—d
(&
sc
->
wa™šg
);

1415 
	`ngx_queue_»move
(
q
);

1417 
¡»am
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_¥dy_¡»am_t
, 
queue
);

1419 
¡»am
->
hªdËd
 = 0;

1421 
wev
 = 
¡»am
->
»que¡
->
cÚÃùiÚ
->
wr™e
;

1423 ià(!
wev
->
tim”_£t
) {

1424 
wev
->
d–ayed
 = 0;

1425 
wev
->
	`hªdËr
(wev);

1427 ià(
sc
->
£nd_wšdow
 == 0) {

1434  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1435 
	}
}

1438 
u_ch¬
 *

1439 
	$ngx_h‰p_¥dy_¡©e_d©a
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1440 
u_ch¬
 *
’d
)

1442 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

1444 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1447 ià(
sc
->
Ëngth
 > sc->
»cv_wšdow
) {

1448 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1451 
sc
->
Ëngth
, sc->
»cv_wšdow
);

1453  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1456 
sc
->
»cv_wšdow
 -ðsc->
Ëngth
;

1458 ià(
sc
->
»cv_wšdow
 < 
NGX_SPDY_MAX_WINDOW
 / 4) {

1460 ià(
	`ngx_h‰p_¥dy_£nd_wšdow_upd©e
(
sc
, 0,

1461 
NGX_SPDY_MAX_WINDOW


1462 - 
sc
->
»cv_wšdow
)

1463 =ð
NGX_ERROR
)

1465  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1468 
sc
->
»cv_wšdow
 = 
NGX_SPDY_MAX_WINDOW
;

1471 
¡»am
 = 
sc
->stream;

1473 ià(
¡»am
 =ð
NULL
) {

1474 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1477  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

1480 ià(
sc
->
Ëngth
 > 
¡»am
->
»cv_wšdow
) {

1481 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1484 
¡»am
->
id
, 
sc
->
Ëngth
, sŒ—m->
»cv_wšdow
);

1486 ià(
	`ngx_h‰p_¥dy_‹rmš©e_¡»am
(
sc
, 
¡»am
,

1487 
NGX_SPDY_FLOW_CONTROL_ERROR
)

1488 =ð
NGX_ERROR
)

1490  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1493  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

1496 
¡»am
->
»cv_wšdow
 -ð
sc
->
Ëngth
;

1498 ià(
¡»am
->
»cv_wšdow
 < 
NGX_SPDY_STREAM_WINDOW
 / 4) {

1500 ià(
	`ngx_h‰p_¥dy_£nd_wšdow_upd©e
(
sc
, 
¡»am
->
id
,

1501 
NGX_SPDY_STREAM_WINDOW


1502 - 
¡»am
->
»cv_wšdow
)

1503 =ð
NGX_ERROR
)

1505  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1508 
¡»am
->
»cv_wšdow
 = 
NGX_SPDY_STREAM_WINDOW
;

1511 ià(
¡»am
->
š_þo£d
) {

1512 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1514 
¡»am
->
id
);

1516 ià(
	`ngx_h‰p_¥dy_‹rmš©e_¡»am
(
sc
, 
¡»am
,

1517 
NGX_SPDY_STREAM_ALREADY_CLOSED
)

1518 =ð
NGX_ERROR
)

1520  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1523  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

1526  
	`ngx_h‰p_¥dy_¡©e_»ad_d©a
(
sc
, 
pos
, 
’d
);

1527 
	}
}

1530 
u_ch¬
 *

1531 
	$ngx_h‰p_¥dy_¡©e_»ad_d©a
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1532 
u_ch¬
 *
’d
)

1534 
size_t
 
size
;

1535 
ssize_t
 
n
;

1536 
ngx_buf_t
 *
buf
;

1537 
ngx_št_t
 
rc
;

1538 
ngx_‹mp_fže_t
 *
tf
;

1539 
ngx_h‰p_»que¡_t
 *
r
;

1540 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

1541 
ngx_h‰p_»que¡_body_t
 *
rb
;

1542 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1544 
¡»am
 = 
sc
->stream;

1546 ià(
¡»am
 =ð
NULL
) {

1547  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

1550 ià(
¡»am
->
sk_d©a
) {

1552 ià(
sc
->
æags
 & 
NGX_SPDY_FLAG_FIN
) {

1553 
¡»am
->
š_þo£d
 = 1;

1556 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1558 
¡»am
->
sk_d©a
);

1560  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

1563 
size
 = 
’d
 - 
pos
;

1565 ià(
size
 > 
sc
->
Ëngth
) {

1566 
size
 = 
sc
->
Ëngth
;

1569 
r
 = 
¡»am
->
»que¡
;

1571 ià(
r
->
»que¡_body
 =ð
NULL


1572 && 
	`ngx_h‰p_¥dy_š™_»que¡_body
(
r
è!ð
NGX_OK
)

1574 
¡»am
->
sk_d©a
 = 
NGX_SPDY_DATA_INTERNAL_ERROR
;

1575  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

1578 
rb
 = 
r
->
»que¡_body
;

1579 
tf
 = 
rb
->
‹mp_fže
;

1580 
buf
 = 
rb
->buf;

1582 ià(
size
) {

1583 
rb
->
»¡
 +ð
size
;

1585 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 != -1

1586 && 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 < 
rb
->
»¡
)

1588 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1592 
¡»am
->
sk_d©a
 = 
NGX_SPDY_DATA_ERROR
;

1593 
”rÜ
;

1596 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1598 ià(
þcf
->
þ›Á_max_body_size


1599 && 
þcf
->
þ›Á_max_body_size
 < 
rb
->
»¡
)

1601 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1603 "toØÏrgchunked body: %O by‹s", 
rb
->
»¡
);

1605 
¡»am
->
sk_d©a
 = 
NGX_SPDY_DATA_ERROR
;

1606 
”rÜ
;

1610 
sc
->
Ëngth
 -ð
size
;

1612 ià(
tf
) {

1613 
buf
->
¡¬t
 = 
pos
;

1614 
buf
->
pos
 =…os;

1616 
pos
 +ð
size
;

1618 
buf
->
’d
 = 
pos
;

1619 
buf
->
Ï¡
 = 
pos
;

1621 
n
 = 
	`ngx_wr™e_chaš_to_‹mp_fže
(
tf
, 
rb
->
bufs
);

1625 ià(
n
 =ð
NGX_ERROR
) {

1626 
¡»am
->
sk_d©a
 = 
NGX_SPDY_DATA_INTERNAL_ERROR
;

1627 
”rÜ
;

1630 
tf
->
off£t
 +ð
n
;

1633 
buf
->
Ï¡
 = 
	`ngx_ýymem
(buf->Ï¡, 
pos
, 
size
);

1634 
pos
 +ð
size
;

1637 
r
->
»que¡_Ëngth
 +ð
size
;

1640 ià(
sc
->
Ëngth
) {

1641  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1642 
ngx_h‰p_¥dy_¡©e_»ad_d©a
);

1645 ià(
sc
->
æags
 & 
NGX_SPDY_FLAG_FIN
) {

1647 
¡»am
->
š_þo£d
 = 1;

1649 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 < 0) {

1650 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = 
rb
->
»¡
;

1652 } ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 !ð
rb
->
»¡
) {

1653 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

1656 
rb
->
»¡
, 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
);

1658 
¡»am
->
sk_d©a
 = 
NGX_SPDY_DATA_ERROR
;

1659 
”rÜ
;

1662 ià(
tf
) {

1663 
	`ngx_memz”o
(
buf
, (
ngx_buf_t
));

1665 
buf
->
š_fže
 = 1;

1666 
buf
->
fže_Ï¡
 = 
tf
->
fže
.
off£t
;

1667 
buf
->
fže
 = &
tf
->file;

1669 
rb
->
buf
 = 
NULL
;

1672 ià(
rb
->
po¡_hªdËr
) {

1673 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_block_»adšg
;

1674 
rb
->
	`po¡_hªdËr
(
r
);

1678  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1680 
”rÜ
:

1682 ià(
rb
->
po¡_hªdËr
) {

1684 ià(
¡»am
->
sk_d©a
 =ð
NGX_SPDY_DATA_ERROR
) {

1685 
rc
 = (
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 == -1)

1686 ? 
NGX_HTTP_REQUEST_ENTITY_TOO_LARGE


1687 : 
NGX_HTTP_BAD_REQUEST
;

1690 
rc
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

1693 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

1696  
	`ngx_h‰p_¥dy_¡©e_sk
(
sc
, 
pos
, 
’d
);

1697 
	}
}

1700 
u_ch¬
 *

1701 
	$ngx_h‰p_¥dy_¡©e_r¡_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1702 
u_ch¬
 *
’d
)

1704 
ngx_ušt_t
 
sid
, 
¡©us
;

1705 
ngx_ev’t_t
 *
ev
;

1706 
ngx_cÚÃùiÚ_t
 *
fc
;

1707 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

1709 ià(
’d
 - 
pos
 < 
NGX_SPDY_RST_STREAM_SIZE
) {

1710  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1711 
ngx_h‰p_¥dy_¡©e_r¡_¡»am
);

1714 ià(
sc
->
Ëngth
 !ð
NGX_SPDY_RST_STREAM_SIZE
) {

1715 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1717 
sc
->
Ëngth
);

1719  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1722 
sid
 = 
	`ngx_¥dy_äame_·r£_sid
(
pos
);

1724 
pos
 +ð
NGX_SPDY_SID_SIZE
;

1726 
¡©us
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
pos
);

1728 
pos
 +ð(
ušt32_t
);

1730 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1731 "¥dy RST_STREAM sid:%u˜¡:%ui", 
sid
, 
¡©us
);

1733 
¡»am
 = 
	`ngx_h‰p_¥dy_g‘_¡»am_by_id
(
sc
, 
sid
);

1735 ià(
¡»am
 =ð
NULL
) {

1736 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1739  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1742 
¡»am
->
š_þo£d
 = 1;

1743 
¡»am
->
out_þo£d
 = 1;

1745 
fc
 = 
¡»am
->
»que¡
->
cÚÃùiÚ
;

1746 
fc
->
”rÜ
 = 1;

1748 
¡©us
) {

1750 
NGX_SPDY_CANCEL
:

1751 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
fc
->
log
, 0,

1752 "þ›Á cªûËd sŒ—m %ui", 
sid
);

1755 
NGX_SPDY_INTERNAL_ERROR
:

1756 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
fc
->
log
, 0,

1758 
sid
);

1762 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
fc
->
log
, 0,

1764 
sid
, 
¡©us
);

1768 
ev
 = 
fc
->
»ad
;

1769 
ev
->
	`hªdËr
(ev);

1771  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1772 
	}
}

1775 
u_ch¬
 *

1776 
	$ngx_h‰p_¥dy_¡©e_pšg
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1777 
u_ch¬
 *
’d
)

1779 
u_ch¬
 *
p
;

1780 
ngx_buf_t
 *
buf
;

1781 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

1783 ià(
’d
 - 
pos
 < 
NGX_SPDY_PING_SIZE
) {

1784  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1785 
ngx_h‰p_¥dy_¡©e_pšg
);

1788 ià(
sc
->
Ëngth
 !ð
NGX_SPDY_PING_SIZE
) {

1789 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1791 
sc
->
Ëngth
);

1793  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1796 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1799 
äame
 = 
	`ngx_h‰p_¥dy_g‘_ùl_äame
(
sc
, 
NGX_SPDY_PING_SIZE
,

1800 
NGX_SPDY_HIGHEST_PRIORITY
);

1801 ià(
äame
 =ð
NULL
) {

1802  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1805 
buf
 = 
äame
->
fœ¡
->buf;

1807 
p
 = 
buf
->
pos
;

1809 
p
 = 
	`ngx_¥dy_äame_wr™e_h—d
Õ, 
NGX_SPDY_PING
);

1810 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
Õ, 0, 
NGX_SPDY_PING_SIZE
);

1812 
p
 = 
	`ngx_ýymem
Õ, 
pos
, 
NGX_SPDY_PING_SIZE
);

1814 
buf
->
Ï¡
 = 
p
;

1816 
	`ngx_h‰p_¥dy_queue_äame
(
sc
, 
äame
);

1818 
pos
 +ð
NGX_SPDY_PING_SIZE
;

1820  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1821 
	}
}

1824 
u_ch¬
 *

1825 
	$ngx_h‰p_¥dy_¡©e_sk
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1826 
u_ch¬
 *
’d
)

1828 
size_t
 
size
;

1830 
size
 = 
’d
 - 
pos
;

1832 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1833 "¥dy f¿msk %uz oà%uz", 
size
, 
sc
->
Ëngth
);

1835 ià(
size
 < 
sc
->
Ëngth
) {

1836 
sc
->
Ëngth
 -ð
size
;

1837  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
’d
,ƒnd,

1838 
ngx_h‰p_¥dy_¡©e_sk
);

1841  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
 + sc->
Ëngth
, 
’d
);

1842 
	}
}

1845 
u_ch¬
 *

1846 
	$ngx_h‰p_¥dy_¡©e_£‰šgs
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1847 
u_ch¬
 *
’d
)

1849 
ngx_ušt_t
 
fid
, 
v®
;

1851 ià(
sc
->
’Œ›s
 == 0) {

1853 ià(
’d
 - 
pos
 < 
NGX_SPDY_SETTINGS_NUM_SIZE
) {

1854  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1855 
ngx_h‰p_¥dy_¡©e_£‰šgs
);

1858 
sc
->
’Œ›s
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
pos
);

1860 
pos
 +ð
NGX_SPDY_SETTINGS_NUM_SIZE
;

1861 
sc
->
Ëngth
 -ð
NGX_SPDY_SETTINGS_NUM_SIZE
;

1863 ià(
sc
->
Ëngth
 < sc->
’Œ›s
 * 
NGX_SPDY_SETTINGS_PAIR_SIZE
) {

1864 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1867 
sc
->
Ëngth
, sc->
’Œ›s
);

1869  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1872 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1873 "¥dy SETTINGS f¿mha %u˜’Œ›s", 
sc
->
’Œ›s
);

1876 
sc
->
’Œ›s
) {

1877 ià(
’d
 - 
pos
 < 
NGX_SPDY_SETTINGS_PAIR_SIZE
) {

1878  
	`ngx_h‰p_¥dy_¡©e_§ve
(
sc
, 
pos
, 
’d
,

1879 
ngx_h‰p_¥dy_¡©e_£‰šgs
);

1882 
sc
->
’Œ›s
--;

1883 
sc
->
Ëngth
 -ð
NGX_SPDY_SETTINGS_PAIR_SIZE
;

1885 
fid
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
pos
);

1887 
pos
 +ð
NGX_SPDY_SETTINGS_FID_SIZE
;

1889 
v®
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
pos
);

1891 
pos
 +ð
NGX_SPDY_SETTINGS_VAL_SIZE
;

1893 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1895 
	`ngx_¥dy_äame_æags
(
fid
), 
	`ngx_¥dy_äame_id
(fid), 
v®
);

1897 ià(
	`ngx_¥dy_äame_æags
(
fid
è=ð
NGX_SPDY_SETTINGS_FLAG_PERSISTED
) {

1901 
	`ngx_¥dy_äame_id
(
fid
)) {

1903 
NGX_SPDY_SETTINGS_INIT_WINDOW
:

1905 ià(
v®
 > 
NGX_SPDY_MAX_WINDOW
) {

1906 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1908 "šcÜ»ù INIT_WINDOW v®ue: %ui", 
v®
);

1910  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1913 ià(
	`ngx_h‰p_¥dy_adju¡_wšdows
(
sc
, 
v®
 - sc->
š™_wšdow
)

1914 !ð
NGX_OK
)

1916  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1919 
sc
->
š™_wšdow
 = 
v®
;

1925  
	`ngx_h‰p_¥dy_¡©e_com¶‘e
(
sc
, 
pos
, 
’d
);

1926 
	}
}

1929 
u_ch¬
 *

1930 
	$ngx_h‰p_¥dy_¡©e_com¶‘e
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
u_ch¬
 *
pos
,

1931 
u_ch¬
 *
’d
)

1933 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1934 "¥dy f¿mcom¶‘pos:%°’d:%p", 
pos
, 
’d
);

1936 ià(
pos
 > 
’d
) {

1937 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1940 
	`ngx_debug_pošt
();

1941  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1944 
sc
->
hªdËr
 = 
ngx_h‰p_¥dy_¡©e_h—d
;

1945 
sc
->
¡»am
 = 
NULL
;

1947  
pos
;

1948 
	}
}

1951 
u_ch¬
 *

1952 
	$ngx_h‰p_¥dy_¡©e_§ve
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

1953 
u_ch¬
 *
pos
, u_ch¬ *
’d
, 
ngx_h‰p_¥dy_hªdËr_±
 
hªdËr
)

1955 
size_t
 
size
;

1957 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1959 
pos
, 
’d
, 
hªdËr
);

1961 
size
 = 
’d
 - 
pos
;

1963 ià(
size
 > 
NGX_SPDY_STATE_BUFFER_SIZE
) {

1964 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1965 "¡©bufã¸ov”æow: %uz by‹ »quœed", 
size
);

1967 
	`ngx_debug_pošt
();

1968  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1971 
	`ngx_memýy
(
sc
->
bufãr
, 
pos
, 
NGX_SPDY_STATE_BUFFER_SIZE
);

1973 
sc
->
bufãr_u£d
 = 
size
;

1974 
sc
->
hªdËr
 = handler;

1975 
sc
->
šcom¶‘e
 = 1;

1977  
’d
;

1978 
	}
}

1981 
u_ch¬
 *

1982 
	$ngx_h‰p_¥dy_¡©e_šæ©e_”rÜ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
rc
)

1984 ià(
rc
 =ð
Z_DATA_ERROR
 ||„ø=ð
Z_STREAM_END
) {

1985 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1987 "cÜru±ed h—d” block, inæ©e(èçžed: %d", 
rc
);

1989  
	`ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
sc
);

1992 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1993 "šæ©e(èçžed: %d", 
rc
);

1995  
	`ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
sc
);

1996 
	}
}

1999 
u_ch¬
 *

2000 
	$ngx_h‰p_¥dy_¡©e_´ÙocÞ_”rÜ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
)

2002 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

2005 ià(
sc
->
¡»am
) {

2006 
sc
->
¡»am
->
out_þo£d
 = 1;

2007 
	`ngx_h‰p_¥dy_þo£_¡»am
(
sc
->
¡»am
, 
NGX_HTTP_BAD_REQUEST
);

2010 
	`ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
sc
, 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

2012  
NULL
;

2013 
	}
}

2016 
u_ch¬
 *

2017 
	$ngx_h‰p_¥dy_¡©e_š‹º®_”rÜ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
)

2019 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

2022 ià(
sc
->
¡»am
) {

2023 
sc
->
¡»am
->
out_þo£d
 = 1;

2024 
	`ngx_h‰p_¥dy_þo£_¡»am
(
sc
->
¡»am
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2027 
	`ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
sc
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2029  
NULL
;

2030 
	}
}

2033 
ngx_št_t


2034 
	$ngx_h‰p_¥dy_£nd_wšdow_upd©e
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_ušt_t
 
sid
,

2035 
ngx_ušt_t
 
d–
)

2037 
u_ch¬
 *
p
;

2038 
ngx_buf_t
 *
buf
;

2039 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

2041 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

2042 "¥dy s’d WINDOW_UPDATE sid:%u˜d–:%ui", 
sid
, 
d–
);

2044 
äame
 = 
	`ngx_h‰p_¥dy_g‘_ùl_äame
(
sc
, 
NGX_SPDY_WINDOW_UPDATE_SIZE
,

2045 
NGX_SPDY_HIGHEST_PRIORITY
);

2046 ià(
äame
 =ð
NULL
) {

2047  
NGX_ERROR
;

2050 
buf
 = 
äame
->
fœ¡
->buf;

2052 
p
 = 
buf
->
pos
;

2054 
p
 = 
	`ngx_¥dy_äame_wr™e_h—d
Õ, 
NGX_SPDY_WINDOW_UPDATE
);

2055 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
Õ, 0, 
NGX_SPDY_WINDOW_UPDATE_SIZE
);

2057 
p
 = 
	`ngx_¥dy_äame_wr™e_sid
Õ, 
sid
);

2058 
p
 = 
	`ngx_¥dy_äame_®igÃd_wr™e_ušt32
Õ, 
d–
);

2060 
buf
->
Ï¡
 = 
p
;

2062 
	`ngx_h‰p_¥dy_queue_äame
(
sc
, 
äame
);

2064  
NGX_OK
;

2065 
	}
}

2068 
ngx_št_t


2069 
	$ngx_h‰p_¥dy_£nd_r¡_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_ušt_t
 
sid
,

2070 
ngx_ušt_t
 
¡©us
,‚gx_ušt_ˆ
´iÜ™y
)

2072 
u_ch¬
 *
p
;

2073 
ngx_buf_t
 *
buf
;

2074 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

2076 ià(
sc
->
cÚÃùiÚ
->
”rÜ
) {

2077  
NGX_OK
;

2080 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

2081 "¥dy s’d RST_STREAM sid:%u˜¡:%ui", 
sid
, 
¡©us
);

2083 
äame
 = 
	`ngx_h‰p_¥dy_g‘_ùl_äame
(
sc
, 
NGX_SPDY_RST_STREAM_SIZE
,

2084 
´iÜ™y
);

2085 ià(
äame
 =ð
NULL
) {

2086  
NGX_ERROR
;

2089 
buf
 = 
äame
->
fœ¡
->buf;

2091 
p
 = 
buf
->
pos
;

2093 
p
 = 
	`ngx_¥dy_äame_wr™e_h—d
Õ, 
NGX_SPDY_RST_STREAM
);

2094 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
Õ, 0, 
NGX_SPDY_RST_STREAM_SIZE
);

2096 
p
 = 
	`ngx_¥dy_äame_wr™e_sid
Õ, 
sid
);

2097 
p
 = 
	`ngx_¥dy_äame_®igÃd_wr™e_ušt32
Õ, 
¡©us
);

2099 
buf
->
Ï¡
 = 
p
;

2101 
	`ngx_h‰p_¥dy_queue_äame
(
sc
, 
äame
);

2103  
NGX_OK
;

2104 
	}
}

2108 
ngx_št_t


2109 
	$ngx_h‰p_¥dy_£nd_gßway
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
)

2111 
u_ch¬
 *
p
;

2112 
ngx_buf_t
 *
buf
;

2113 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

2115 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

2116 "¥dy s’d GOAWAY sid:%ui", 
sc
->
Ï¡_sid
);

2118 
äame
 = 
	`ngx_h‰p_¥dy_g‘_ùl_äame
(
sc
, 
NGX_SPDY_GOAWAY_SIZE
,

2119 
NGX_SPDY_HIGHEST_PRIORITY
);

2120 ià(
äame
 =ð
NULL
) {

2121  
NGX_ERROR
;

2124 
buf
 = 
äame
->
fœ¡
->buf;

2126 
p
 = 
buf
->
pos
;

2128 
p
 = 
	`ngx_¥dy_äame_wr™e_h—d
Õ, 
NGX_SPDY_GOAWAY
);

2129 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
Õ, 0, 
NGX_SPDY_GOAWAY_SIZE
);

2131 
p
 = 
	`ngx_¥dy_äame_wr™e_sid
Õ, 
sc
->
Ï¡_sid
);

2133 
buf
->
Ï¡
 = 
p
;

2135 
	`ngx_h‰p_¥dy_queue_äame
(
sc
, 
äame
);

2137  
NGX_OK
;

2138 
	}
}

2142 
ngx_št_t


2143 
	$ngx_h‰p_¥dy_£nd_£‰šgs
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
)

2145 
u_ch¬
 *
p
;

2146 
ngx_buf_t
 *
buf
;

2147 
ngx_chaš_t
 *
þ
;

2148 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

2149 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

2151 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

2154 
äame
 = 
	`ngx_·Îoc
(
sc
->
poÞ
, (
ngx_h‰p_¥dy_out_äame_t
));

2155 ià(
äame
 =ð
NULL
) {

2156  
NGX_ERROR
;

2159 
þ
 = 
	`ngx_®loc_chaš_lšk
(
sc
->
poÞ
);

2160 ià(
þ
 =ð
NULL
) {

2161  
NGX_ERROR
;

2164 
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
sc
->
poÞ
, 
NGX_SPDY_FRAME_HEADER_SIZE


2165 + 
NGX_SPDY_SETTINGS_NUM_SIZE


2166 + 2 * 
NGX_SPDY_SETTINGS_PAIR_SIZE
);

2167 ià(
buf
 =ð
NULL
) {

2168  
NGX_ERROR
;

2171 
buf
->
Ï¡_buf
 = 1;

2173 
þ
->
buf
 = buf;

2174 
þ
->
Ãxt
 = 
NULL
;

2176 
äame
->
fœ¡
 = 
þ
;

2177 
äame
->
Ï¡
 = 
þ
;

2178 
äame
->
hªdËr
 = 
ngx_h‰p_¥dy_£‰šgs_äame_hªdËr
;

2179 
äame
->
¡»am
 = 
NULL
;

2180 #ià(
NGX_DEBUG
)

2181 
äame
->
Ëngth
 = 
NGX_SPDY_SETTINGS_NUM_SIZE


2182 + 2 * 
NGX_SPDY_SETTINGS_PAIR_SIZE
;

2184 
äame
->
´iÜ™y
 = 
NGX_SPDY_HIGHEST_PRIORITY
;

2185 
äame
->
blocked
 = 0;

2187 
p
 = 
buf
->
pos
;

2189 
p
 = 
	`ngx_¥dy_äame_wr™e_h—d
Õ, 
NGX_SPDY_SETTINGS
);

2190 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
Õ, 
NGX_SPDY_FLAG_CLEAR_SETTINGS
,

2191 
NGX_SPDY_SETTINGS_NUM_SIZE


2192 + 2 * 
NGX_SPDY_SETTINGS_PAIR_SIZE
);

2194 
p
 = 
	`ngx_¥dy_äame_®igÃd_wr™e_ušt32
(p, 2);

2196 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

2197 
ngx_h‰p_¥dy_moduË
);

2199 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_id
Õ, 0, 
NGX_SPDY_SETTINGS_MAX_STREAMS
);

2200 
p
 = 
	`ngx_¥dy_äame_®igÃd_wr™e_ušt32
Õ, 
sscf
->
cÚcu¼’t_¡»ams
);

2202 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_id
Õ, 0, 
NGX_SPDY_SETTINGS_INIT_WINDOW
);

2203 
p
 = 
	`ngx_¥dy_äame_®igÃd_wr™e_ušt32
Õ, 
NGX_SPDY_STREAM_WINDOW
);

2205 
buf
->
Ï¡
 = 
p
;

2207 
	`ngx_h‰p_¥dy_queue_äame
(
sc
, 
äame
);

2209  
NGX_OK
;

2210 
	}
}

2213 
ngx_št_t


2214 
	$ngx_h‰p_¥dy_£‰šgs_äame_hªdËr
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

2215 
ngx_h‰p_¥dy_out_äame_t
 *
äame
)

2217 
ngx_buf_t
 *
buf
;

2219 
buf
 = 
äame
->
fœ¡
->buf;

2221 ià(
buf
->
pos
 !ðbuf->
Ï¡
) {

2222  
NGX_AGAIN
;

2225 
	`ngx_ä“_chaš
(
sc
->
poÞ
, 
äame
->
fœ¡
);

2227  
NGX_OK
;

2228 
	}
}

2231 
ngx_h‰p_¥dy_out_äame_t
 *

2232 
	$ngx_h‰p_¥dy_g‘_ùl_äame
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
size_t
 
Ëngth
,

2233 
ngx_ušt_t
 
´iÜ™y
)

2235 
ngx_chaš_t
 *
þ
;

2236 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

2238 
äame
 = 
sc
->
ä“_ùl_äames
;

2240 ià(
äame
) {

2241 
sc
->
ä“_ùl_äames
 = 
äame
->
Ãxt
;

2243 
þ
 = 
äame
->
fœ¡
;

2244 
þ
->
buf
->
pos
 = cl->buf->
¡¬t
;

2247 
äame
 = 
	`ngx_·Îoc
(
sc
->
poÞ
, (
ngx_h‰p_¥dy_out_äame_t
));

2248 ià(
äame
 =ð
NULL
) {

2249  
NULL
;

2252 
þ
 = 
	`ngx_®loc_chaš_lšk
(
sc
->
poÞ
);

2253 ià(
þ
 =ð
NULL
) {

2254  
NULL
;

2257 
þ
->
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
sc
->
poÞ
,

2258 
NGX_SPDY_CTL_FRAME_BUFFER_SIZE
);

2259 ià(
þ
->
buf
 =ð
NULL
) {

2260  
NULL
;

2263 
þ
->
buf
->
Ï¡_buf
 = 1;

2265 
äame
->
fœ¡
 = 
þ
;

2266 
äame
->
Ï¡
 = 
þ
;

2267 
äame
->
hªdËr
 = 
ngx_h‰p_¥dy_ùl_äame_hªdËr
;

2268 
äame
->
¡»am
 = 
NULL
;

2271 #ià(
NGX_DEBUG
)

2272 ià(
Ëngth
 > 
NGX_SPDY_CTL_FRAME_BUFFER_SIZE
 - 
NGX_SPDY_FRAME_HEADER_SIZE
) {

2273 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
sc
->
poÞ
->
log
, 0,

2274 "»que¡ed cÚŒÞ f¿mi toØÏrge: %uz", 
Ëngth
);

2275  
NULL
;

2278 
äame
->
Ëngth
 =†ength;

2281 
äame
->
´iÜ™y
 =…riority;

2282 
äame
->
blocked
 = 0;

2284  
äame
;

2285 
	}
}

2288 
ngx_št_t


2289 
	$ngx_h‰p_¥dy_ùl_äame_hªdËr
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

2290 
ngx_h‰p_¥dy_out_äame_t
 *
äame
)

2292 
ngx_buf_t
 *
buf
;

2294 
buf
 = 
äame
->
fœ¡
->buf;

2296 ià(
buf
->
pos
 !ðbuf->
Ï¡
) {

2297  
NGX_AGAIN
;

2300 
äame
->
Ãxt
 = 
sc
->
ä“_ùl_äames
;

2301 
sc
->
ä“_ùl_äames
 = 
äame
;

2303  
NGX_OK
;

2304 
	}
}

2307 
ngx_h‰p_¥dy_¡»am_t
 *

2308 
	$ngx_h‰p_¥dy_ü—‹_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_ušt_t
 
id
,

2309 
ngx_ušt_t
 
´iÜ™y
)

2311 
ngx_log_t
 *
log
;

2312 
ngx_ušt_t
 
šdex
;

2313 
ngx_ev’t_t
 *
»v
, *
wev
;

2314 
ngx_cÚÃùiÚ_t
 *
fc
;

2315 
ngx_h‰p_log_ùx_t
 *
ùx
;

2316 
ngx_h‰p_»que¡_t
 *
r
;

2317 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

2318 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2319 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

2321 
fc
 = 
sc
->
ä“_çke_cÚÃùiÚs
;

2323 ià(
fc
) {

2324 
sc
->
ä“_çke_cÚÃùiÚs
 = 
fc
->
d©a
;

2326 
»v
 = 
fc
->
»ad
;

2327 
wev
 = 
fc
->
wr™e
;

2328 
log
 = 
fc
->log;

2329 
ùx
 = 
log
->
d©a
;

2332 
fc
 = 
	`ngx_·Îoc
(
sc
->
poÞ
, (
ngx_cÚÃùiÚ_t
));

2333 ià(
fc
 =ð
NULL
) {

2334  
NULL
;

2337 
»v
 = 
	`ngx_·Îoc
(
sc
->
poÞ
, (
ngx_ev’t_t
));

2338 ià(
»v
 =ð
NULL
) {

2339  
NULL
;

2342 
wev
 = 
	`ngx_·Îoc
(
sc
->
poÞ
, (
ngx_ev’t_t
));

2343 ià(
wev
 =ð
NULL
) {

2344  
NULL
;

2347 
log
 = 
	`ngx_·Îoc
(
sc
->
poÞ
, (
ngx_log_t
));

2348 ià(
log
 =ð
NULL
) {

2349  
NULL
;

2352 
ùx
 = 
	`ngx_·Îoc
(
sc
->
poÞ
, (
ngx_h‰p_log_ùx_t
));

2353 ià(
ùx
 =ð
NULL
) {

2354  
NULL
;

2357 
ùx
->
cÚÃùiÚ
 = 
fc
;

2358 
ùx
->
»que¡
 = 
NULL
;

2361 
	`ngx_memýy
(
log
, 
sc
->
cÚÃùiÚ
->log, (
ngx_log_t
));

2363 
log
->
d©a
 = 
ùx
;

2365 
	`ngx_memz”o
(
»v
, (
ngx_ev’t_t
));

2367 
»v
->
d©a
 = 
fc
;

2368 
»v
->
»ady
 = 1;

2369 
»v
->
hªdËr
 = 
ngx_h‰p_¥dy_þo£_¡»am_hªdËr
;

2370 
»v
->
log
 =†og;

2372 
	`ngx_memýy
(
wev
, 
»v
, (
ngx_ev’t_t
));

2374 
wev
->
wr™e
 = 1;

2376 
	`ngx_memýy
(
fc
, 
sc
->
cÚÃùiÚ
, (
ngx_cÚÃùiÚ_t
));

2378 
fc
->
d©a
 = 
sc
->
h‰p_cÚÃùiÚ
;

2379 
fc
->
»ad
 = 
»v
;

2380 
fc
->
wr™e
 = 
wev
;

2381 
fc
->
£Á
 = 0;

2382 
fc
->
log
 =†og;

2383 
fc
->
bufã»d
 = 0;

2384 
fc
->
¢dlow©
 = 1;

2385 
fc
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_DISABLED
;

2387 
r
 = 
	`ngx_h‰p_ü—‹_»que¡
(
fc
);

2388 ià(
r
 =ð
NULL
) {

2389  
NULL
;

2392 
r
->
v®id_loÿtiÚ
 = 1;

2394 
fc
->
d©a
 = 
r
;

2395 
sc
->
cÚÃùiÚ
->
»que¡s
++;

2397 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2399 
r
->
h—d”_š
 = 
	`ngx_ü—‹_‹mp_buf
Ô->
poÞ
,

2400 
cscf
->
þ›Á_h—d”_bufãr_size
);

2401 ià(
r
->
h—d”_š
 =ð
NULL
) {

2402 
	`ngx_h‰p_ä“_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2403  
NULL
;

2406 
r
->
h—d”s_š
.
cÚÃùiÚ_ty³
 = 
NGX_HTTP_CONNECTION_CLOSE
;

2408 
¡»am
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_¥dy_¡»am_t
));

2409 ià(
¡»am
 =ð
NULL
) {

2410 
	`ngx_h‰p_ä“_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2411  
NULL
;

2414 
r
->
¥dy_¡»am
 = 
¡»am
;

2416 
¡»am
->
id
 = id;

2417 
¡»am
->
»que¡
 = 
r
;

2418 
¡»am
->
cÚÃùiÚ
 = 
sc
;

2420 
¡»am
->
£nd_wšdow
 = 
sc
->
š™_wšdow
;

2421 
¡»am
->
»cv_wšdow
 = 
NGX_SPDY_STREAM_WINDOW
;

2423 
¡»am
->
´iÜ™y
 =…riority;

2425 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_¥dy_moduË
);

2427 
šdex
 = 
	`ngx_h‰p_¥dy_¡»am_šdex
(
sscf
, 
id
);

2429 
¡»am
->
šdex
 = 
sc
->
¡»ams_šdex
[index];

2430 
sc
->
¡»ams_šdex
[
šdex
] = 
¡»am
;

2432 
sc
->
´oûssšg
++;

2434  
¡»am
;

2435 
	}
}

2438 
ngx_h‰p_¥dy_¡»am_t
 *

2439 
	$ngx_h‰p_¥dy_g‘_¡»am_by_id
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

2440 
ngx_ušt_t
 
sid
)

2442 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

2443 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

2445 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

2446 
ngx_h‰p_¥dy_moduË
);

2448 
¡»am
 = 
sc
->
¡»ams_šdex
[
	`ngx_h‰p_¥dy_¡»am_šdex
(
sscf
, 
sid
)];

2450 
¡»am
) {

2451 ià(
¡»am
->
id
 =ð
sid
) {

2452  
¡»am
;

2455 
¡»am
 = sŒ—m->
šdex
;

2458  
NULL
;

2459 
	}
}

2462 
ngx_št_t


2463 
	$ngx_h‰p_¥dy_·r£_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

2465 
u_ch¬
 *
p
, *
’d
, 
ch
;

2466 
ngx_ušt_t
 
hash
;

2467 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2470 
sw_Çme_Ën
 = 0,

2471 
sw_Çme
,

2472 
sw_v®ue_Ën
,

2473 
sw_v®ue


2474 } 
¡©e
;

2476 
¡©e
 = 
r
->state;

2478 
p
 = 
r
->
h—d”_š
->
pos
;

2479 
’d
 = 
r
->
h—d”_š
->
Ï¡
;

2481 
¡©e
) {

2483 
sw_Çme_Ën
:

2485 ià(
’d
 - 
p
 < 
NGX_SPDY_NV_NLEN_SIZE
) {

2486  
NGX_AGAIN
;

2489 
r
->
lowÿ£_šdex
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
p
);

2491 ià(
r
->
lowÿ£_šdex
 == 0) {

2492  
NGX_ERROR
;

2496 *
p
 = '\0';

2498 
p
 +ð
NGX_SPDY_NV_NLEN_SIZE
;

2500 
r
->
šv®id_h—d”
 = 0;

2502 
¡©e
 = 
sw_Çme
;

2506 
sw_Çme
:

2508 ià((
ngx_ušt_t
è(
’d
 - 
p
è< 
r
->
lowÿ£_šdex
) {

2512 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2514 
r
->
h—d”_Çme_¡¬t
 = 
p
;

2515 
r
->
h—d”_Çme_’d
 = 
p
 +„->
lowÿ£_šdex
;

2517 ià(
p
[0] == ':') {

2518 
p
++;

2521 
hash
 = 0;

2523  ; 
p
 !ð
r
->
h—d”_Çme_’d
;…++) {

2525 
ch
 = *
p
;

2527 
hash
 = 
	`ngx_hash
(hash, 
ch
);

2529 ià((
ch
 >= 'a' && ch <= 'z')

2530 || (
ch
 == '-')

2531 || (
ch
 >= '0' && ch <= '9')

2532 || (
ch
 =ð'_' && 
cscf
->
und”scÜes_š_h—d”s
))

2537 
ch
) {

2539 
LF
:

2540 
CR
:

2542 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2544 
r
->
lowÿ£_šdex
,„->
h—d”_Çme_¡¬t
);

2546  
NGX_HTTP_PARSE_INVALID_HEADER
;

2549 ià(
ch
 >= 'A' && ch <= 'Z') {

2550  
NGX_ERROR
;

2553 
r
->
šv®id_h—d”
 = 1;

2556 
r
->
h—d”_hash
 = 
hash
;

2558 
¡©e
 = 
sw_v®ue_Ën
;

2562 
sw_v®ue_Ën
:

2564 ià(
’d
 - 
p
 < 
NGX_SPDY_NV_VLEN_SIZE
) {

2568 
r
->
lowÿ£_šdex
 = 
	`ngx_¥dy_äame_·r£_ušt32
(
p
);

2571 *
p
 = '\0';

2573 
p
 +ð
NGX_SPDY_NV_VLEN_SIZE
;

2575 
¡©e
 = 
sw_v®ue
;

2579 
sw_v®ue
:

2581 ià((
ngx_ušt_t
è(
’d
 - 
p
è< 
r
->
lowÿ£_šdex
) {

2585 
r
->
h—d”_¡¬t
 = 
p
;

2587 
r
->
lowÿ£_šdex
--) {

2588 
ch
 = *
p
;

2590 ià(
ch
 == '\0') {

2592 ià(
p
 =ð
r
->
h—d”_¡¬t
) {

2593  
NGX_ERROR
;

2596 
r
->
h—d”_’d
 = 
p
;

2597 
r
->
h—d”_š
->
pos
 = 
p
 + 1;

2599 
r
->
¡©e
 = 
sw_v®ue
;

2601  
NGX_OK
;

2604 ià(
ch
 =ð
CR
 || ch =ð
LF
) {

2605 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2608 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
,

2609 
r
->
h—d”_Çme_¡¬t
,

2610 
p
 - 
r
->
h—d”_¡¬t
,

2611 
r
->
h—d”_¡¬t
,

2612 
ch
 =ð
CR
 ? 'r' : 'n');

2614  
NGX_HTTP_PARSE_INVALID_HEADER
;

2617 
p
++;

2620 
r
->
h—d”_’d
 = 
p
;

2621 
r
->
h—d”_š
->
pos
 = 
p
;

2623 
r
->
¡©e
 = 0;

2625  
NGX_DONE
;

2628 
r
->
h—d”_š
->
pos
 = 
p
;

2629 
r
->
¡©e
 = state;

2631  
NGX_AGAIN
;

2632 
	}
}

2635 
ngx_št_t


2636 
	$ngx_h‰p_¥dy_®loc_Ïrge_h—d”_bufãr
(
ngx_h‰p_»que¡_t
 *
r
)

2638 
u_ch¬
 *
Þd
, *
Ãw
, *
p
;

2639 
size_t
 
»¡
;

2640 
ngx_buf_t
 *
buf
;

2641 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

2642 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2644 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2647 
¡»am
 = 
r
->
¥dy_¡»am
;

2649 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2651 ià(
¡»am
->
h—d”_bufãrs


2652 =ð(
ngx_ušt_t
è
cscf
->
Ïrge_þ›Á_h—d”_bufãrs
.
num
)

2654 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2657  
NGX_DECLINED
;

2660 
»¡
 = 
r
->
h—d”_š
->
Ï¡
 -„->h—d”_š->
pos
;

2666 ià(
»¡
 > 
cscf
->
Ïrge_þ›Á_h—d”_bufãrs
.
size
 - 2) {

2667 
p
 = 
r
->
h—d”_š
->
pos
;

2669 ià(
»¡
 > 
NGX_MAX_ERROR_STR
 - 300) {

2670 
»¡
 = 
NGX_MAX_ERROR_STR
 - 300;

2673 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2675 
»¡
, 
p
);

2677  
NGX_DECLINED
;

2680 
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
cscf
->
Ïrge_þ›Á_h—d”_bufãrs
.
size
);

2681 ià(
buf
 =ð
NULL
) {

2682  
NGX_ERROR
;

2685 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2687 
buf
->
pos
, buf->
’d
 - buf->
Ï¡
);

2689 
Þd
 = 
r
->
h—d”_š
->
pos
;

2690 
Ãw
 = 
buf
->
pos
;

2692 ià(
»¡
) {

2693 
buf
->
Ï¡
 = 
	`ngx_ýymem
(
Ãw
, 
Þd
, 
»¡
);

2696 
r
->
h—d”_š
 = 
buf
;

2698 
¡»am
->
h—d”_bufãrs
++;

2700  
NGX_OK
;

2701 
	}
}

2704 
ngx_št_t


2705 
	$ngx_h‰p_¥dy_hªdË_»que¡_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

2707 
ngx_ušt_t
 
i
;

2708 
ngx_bË_–t_t
 *
h
;

2709 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

2710 
ngx_h‰p_¥dy_»que¡_h—d”_t
 *
sh
;

2712 ià(
r
->
šv®id_h—d”
) {

2713 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2715 ià(
cscf
->
ignÜe_šv®id_h—d”s
) {

2716 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2718 
r
->
h—d”_’d
 -„->
h—d”_Çme_¡¬t
,

2719 
r
->
h—d”_Çme_¡¬t
);

2720  
NGX_OK
;

2725 ià(
r
->
h—d”_Çme_¡¬t
[0] == ':') {

2726 
r
->
h—d”_Çme_¡¬t
++;

2728 
i
 = 0; i < 
NGX_SPDY_REQUEST_HEADERS
; i++) {

2729 
sh
 = &
ngx_h‰p_¥dy_»que¡_h—d”s
[
i
];

2731 ià(
sh
->
hash
 !ð
r
->
h—d”_hash


2732 || 
sh
->
Ën
 !ð
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t


2733 || 
	`ngx_¡ºcmp
(
sh
->
h—d”
, 
r
->
h—d”_Çme_¡¬t
, sh->
Ën
) != 0)

2738  
sh
->
	`hªdËr
(
r
);

2741 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2743 
r
->
h—d”_’d
 -„->
h—d”_Çme_¡¬t
,

2744 
r
->
h—d”_Çme_¡¬t
);

2746  
NGX_HTTP_PARSE_INVALID_HEADER
;

2749 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_š
.
h—d”s
);

2750 ià(
h
 =ð
NULL
) {

2751  
NGX_ERROR
;

2754 
h
->
hash
 = 
r
->
h—d”_hash
;

2756 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

2757 
h
->
key
.
d©a
 = 
r
->
h—d”_Çme_¡¬t
;

2759 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

2760 
h
->
v®ue
.
d©a
 = 
r
->
h—d”_¡¬t
;

2762 
h
->
lowÿ£_key
 = h->
key
.
d©a
;

2764  
NGX_OK
;

2765 
	}
}

2769 
	$ngx_h‰p_¥dy_»que¡_h—d”s_š™
()

2771 
ngx_ušt_t
 
i
;

2772 
ngx_h‰p_¥dy_»que¡_h—d”_t
 *
h
;

2774 
i
 = 0; i < 
NGX_SPDY_REQUEST_HEADERS
; i++) {

2775 
h
 = &
ngx_h‰p_¥dy_»que¡_h—d”s
[
i
];

2776 
h
->
hash
 = 
	`ngx_hash_key
(h->
h—d”
, h->
Ën
);

2778 
	}
}

2781 
ngx_št_t


2782 
	$ngx_h‰p_¥dy_·r£_m‘hod
(
ngx_h‰p_»que¡_t
 *
r
)

2784 
size_t
 
k
, 
Ën
;

2785 
ngx_ušt_t
 
n
;

2786 cÚ¡ 
u_ch¬
 *
p
, *
m
;

2794 
u_ch¬
 
Ën
;

2795 cÚ¡ 
u_ch¬
 
m‘hod
[11];

2796 
ušt32_t
 
v®ue
;

2797 } 
‹¡s
[] = {

2798 { 3, "GET", 
NGX_HTTP_GET
 },

2799 { 4, "POST", 
NGX_HTTP_POST
 },

2800 { 4, "HEAD", 
NGX_HTTP_HEAD
 },

2801 { 7, "OPTIONS", 
NGX_HTTP_OPTIONS
 },

2802 { 8, "PROPFIND", 
NGX_HTTP_PROPFIND
 },

2803 { 3, "PUT", 
NGX_HTTP_PUT
 },

2804 { 5, "MKCOL", 
NGX_HTTP_MKCOL
 },

2805 { 6, "DELETE", 
NGX_HTTP_DELETE
 },

2806 { 4, "COPY", 
NGX_HTTP_COPY
 },

2807 { 4, "MOVE", 
NGX_HTTP_MOVE
 },

2808 { 9, "PROPPATCH", 
NGX_HTTP_PROPPATCH
 },

2809 { 4, "LOCK", 
NGX_HTTP_LOCK
 },

2810 { 6, "UNLOCK", 
NGX_HTTP_UNLOCK
 },

2811 { 5, "PATCH", 
NGX_HTTP_PATCH
 },

2812 { 5, "TRACE", 
NGX_HTTP_TRACE
 }

2813 }, *
‹¡
;

2815 ià(
r
->
m‘hod_Çme
.
Ën
) {

2816 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2819  
NGX_HTTP_PARSE_INVALID_HEADER
;

2822 
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

2824 
r
->
m‘hod_Çme
.
Ën
 =†en;

2825 
r
->
m‘hod_Çme
.
d©a
 =„->
h—d”_¡¬t
;

2827 
‹¡
 = 
‹¡s
;

2828 
n
 = (
‹¡s
) / (tests[0]);

2831 ià(
Ën
 =ð
‹¡
->len) {

2832 
p
 = 
r
->
m‘hod_Çme
.
d©a
;

2833 
m
 = 
‹¡
->
m‘hod
;

2834 
k
 = 
Ën
;

2837 ià(*
p
++ !ð*
m
++) {

2838 
Ãxt
;

2840 } --
k
);

2842 
r
->
m‘hod
 = 
‹¡
->
v®ue
;

2843  
NGX_OK
;

2846 
Ãxt
:

2847 
‹¡
++;

2849 } --
n
);

2851 
p
 = 
r
->
m‘hod_Çme
.
d©a
;

2854 ià((*
p
 < 'A' || *p > 'Z') && *p != '_') {

2855 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2857 &
r
->
m‘hod_Çme
);

2859  
NGX_HTTP_PARSE_INVALID_HEADER
;

2862 
p
++;

2864 } --
Ën
);

2866  
NGX_OK
;

2867 
	}
}

2870 
ngx_št_t


2871 
	$ngx_h‰p_¥dy_·r£_scheme
(
ngx_h‰p_»que¡_t
 *
r
)

2873 ià(
r
->
schema_¡¬t
) {

2874 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2877  
NGX_HTTP_PARSE_INVALID_HEADER
;

2880 
r
->
schema_¡¬t
 =„->
h—d”_¡¬t
;

2881 
r
->
schema_’d
 =„->
h—d”_’d
;

2883  
NGX_OK
;

2884 
	}
}

2887 
ngx_št_t


2888 
	$ngx_h‰p_¥dy_·r£_ho¡
(
ngx_h‰p_»que¡_t
 *
r
)

2890 
ngx_bË_–t_t
 *
h
;

2892 ià(
r
->
h—d”s_š
.
ho¡
) {

2893 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2896  
NGX_HTTP_PARSE_INVALID_HEADER
;

2899 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_š
.
h—d”s
);

2900 ià(
h
 =ð
NULL
) {

2901  
NGX_ERROR
;

2904 
r
->
h—d”s_š
.
ho¡
 = 
h
;

2906 
h
->
hash
 = 
r
->
h—d”_hash
;

2908 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

2909 
h
->
key
.
d©a
 = 
r
->
h—d”_Çme_¡¬t
;

2911 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

2912 
h
->
v®ue
.
d©a
 = 
r
->
h—d”_¡¬t
;

2914 
h
->
lowÿ£_key
 = h->
key
.
d©a
;

2916  
NGX_OK
;

2917 
	}
}

2920 
ngx_št_t


2921 
	$ngx_h‰p_¥dy_·r£_·th
(
ngx_h‰p_»que¡_t
 *
r
)

2923 ià(
r
->
uÅ¬£d_uri
.
Ën
) {

2924 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2927  
NGX_HTTP_PARSE_INVALID_HEADER
;

2930 
r
->
uri_¡¬t
 =„->
h—d”_¡¬t
;

2931 
r
->
uri_’d
 =„->
h—d”_’d
;

2933 ià(
	`ngx_h‰p_·r£_uri
(
r
è!ð
NGX_OK
) {

2934 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2936 
r
->
uri_’d
 -„->
uri_¡¬t
,„->uri_start);

2938  
NGX_HTTP_PARSE_INVALID_HEADER
;

2941 ià(
	`ngx_h‰p_´oûss_»que¡_uri
(
r
è!ð
NGX_OK
) {

2946  
NGX_ABORT
;

2949  
NGX_OK
;

2950 
	}
}

2953 
ngx_št_t


2954 
	$ngx_h‰p_¥dy_·r£_v”siÚ
(
ngx_h‰p_»que¡_t
 *
r
)

2956 
u_ch¬
 *
p
, 
ch
;

2958 ià(
r
->
h‰p_´ÙocÞ
.
Ën
) {

2959 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

2962  
NGX_HTTP_PARSE_INVALID_HEADER
;

2965 
p
 = 
r
->
h—d”_¡¬t
;

2967 ià(
r
->
h—d”_’d
 - 
p
 < 8 || !(
	`ngx_¡r5cmp
(p, 'H', 'T', 'T', 'P', '/'))) {

2968 
šv®id
;

2971 
ch
 = *(
p
 + 5);

2973 ià(
ch
 < '1' || ch > '9') {

2974 
šv®id
;

2977 
r
->
h‰p_majÜ
 = 
ch
 - '0';

2979 
p
 +ð6;… !ð
r
->
h—d”_’d
 - 2;…++) {

2981 
ch
 = *
p
;

2983 ià(
ch
 == '.') {

2987 ià(
ch
 < '0' || ch > '9') {

2988 
šv®id
;

2991 
r
->
h‰p_majÜ
 =„->h‰p_majÜ * 10 + 
ch
 - '0';

2994 ià(*
p
 != '.') {

2995 
šv®id
;

2998 
ch
 = *(
p
 + 1);

3000 ià(
ch
 < '0' || ch > '9') {

3001 
šv®id
;

3004 
r
->
h‰p_mšÜ
 = 
ch
 - '0';

3006 
p
 +ð2;… !ð
r
->
h—d”_’d
;…++) {

3008 
ch
 = *
p
;

3010 ià(
ch
 < '0' || ch > '9') {

3011 
šv®id
;

3014 
r
->
h‰p_mšÜ
 =„->h‰p_mšÜ * 10 + 
ch
 - '0';

3017 
r
->
h‰p_´ÙocÞ
.
Ën
 =„->
h—d”_’d
 -„->
h—d”_¡¬t
;

3018 
r
->
h‰p_´ÙocÞ
.
d©a
 =„->
h—d”_¡¬t
;

3019 
r
->
h‰p_v”siÚ
 =„->
h‰p_majÜ
 * 1000 +„->
h‰p_mšÜ
;

3021  
NGX_OK
;

3023 
šv®id
:

3025 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

3027 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
,„->header_start);

3029  
NGX_HTTP_PARSE_INVALID_HEADER
;

3030 
	}
}

3033 
ngx_št_t


3034 
	$ngx_h‰p_¥dy_cÚ¡ruù_»que¡_lše
(
ngx_h‰p_»que¡_t
 *
r
)

3036 
u_ch¬
 *
p
;

3038 ià(
r
->
m‘hod_Çme
.
Ën
 == 0

3039 || 
r
->
uÅ¬£d_uri
.
Ën
 == 0

3040 || 
r
->
h‰p_´ÙocÞ
.
Ën
 == 0)

3042 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

3043  
NGX_ERROR
;

3046 
r
->
»que¡_lše
.
Ën
 =„->
m‘hod_Çme
.len + 1

3047 + 
r
->
uÅ¬£d_uri
.
Ën
 + 1

3048 + 
r
->
h‰p_´ÙocÞ
.
Ën
;

3050 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
,„->
»que¡_lše
.
Ën
 + 1);

3051 ià(
p
 =ð
NULL
) {

3052 
	`ngx_h‰p_¥dy_þo£_¡»am
(
r
->
¥dy_¡»am
,

3053 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

3054  
NGX_ERROR
;

3057 
r
->
»que¡_lše
.
d©a
 = 
p
;

3059 
p
 = 
	`ngx_ýymem
Õ, 
r
->
m‘hod_Çme
.
d©a
,„->m‘hod_Çme.
Ën
);

3061 *
p
++ = ' ';

3063 
p
 = 
	`ngx_ýymem
Õ, 
r
->
uÅ¬£d_uri
.
d©a
,„->uÅ¬£d_uri.
Ën
);

3065 *
p
++ = ' ';

3067 
	`ngx_memýy
(
p
, 
r
->
h‰p_´ÙocÞ
.
d©a
,„->h‰p_´ÙocÞ.
Ën
 + 1);

3070 
r
->
m‘hod_Çme
.
d©a
 =„->
»que¡_lše
.data;

3072  
NGX_OK
;

3073 
	}
}

3077 
	$ngx_h‰p_¥dy_run_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

3079 
ngx_ušt_t
 
i
;

3080 
ngx_li¡_·¹_t
 *
·¹
;

3081 
ngx_bË_–t_t
 *
h
;

3082 
ngx_h‰p_h—d”_t
 *
hh
;

3083 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

3085 ià(
	`ngx_h‰p_¥dy_cÚ¡ruù_»que¡_lše
(
r
è!ð
NGX_OK
) {

3089 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3090 "¥dy h‰°»que¡†še: \"%V\"", &
r
->
»que¡_lše
);

3092 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3094 
·¹
 = &
r
->
h—d”s_š
.
h—d”s
.part;

3095 
h
 = 
·¹
->
–ts
;

3097 
i
 = 0 ;; i++) {

3099 ià(
i
 >ð
·¹
->
ÃÉs
) {

3100 ià(
·¹
->
Ãxt
 =ð
NULL
) {

3104 
·¹
 =…¬t->
Ãxt
;

3105 
h
 = 
·¹
->
–ts
;

3106 
i
 = 0;

3109 
hh
 = 
	`ngx_hash_fšd
(&
cmcf
->
h—d”s_š_hash
, 
h
[
i
].
hash
,

3110 
h
[
i
].
lowÿ£_key
, h[i].
key
.
Ën
);

3112 ià(
hh
 && hh->
	`hªdËr
(
r
, &
h
[
i
], hh->
off£t
è!ð
NGX_OK
) {

3116 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3117 "¥dy h‰°h—d”: \"%V: %V\"", &
h
[
i
].
key
, &h[i].
v®ue
);

3120 
r
->
h‰p_¡©e
 = 
NGX_HTTP_PROCESS_REQUEST_STATE
;

3122 ià(
	`ngx_h‰p_´oûss_»que¡_h—d”
(
r
è!ð
NGX_OK
) {

3126 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 > 0 &&„->
¥dy_¡»am
->
š_þo£d
) {

3127 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
r
->
cÚÃùiÚ
->
log
, 0,

3130 
r
->
¥dy_¡»am
->
sk_d©a
 = 
NGX_SPDY_DATA_ERROR
;

3132 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_BAD_REQUEST
);

3136 
	`ngx_h‰p_´oûss_»que¡
(
r
);

3137 
	}
}

3140 
ngx_št_t


3141 
	$ngx_h‰p_¥dy_š™_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
)

3143 
ngx_buf_t
 *
buf
;

3144 
ngx_‹mp_fže_t
 *
tf
;

3145 
ngx_h‰p_»que¡_body_t
 *
rb
;

3146 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3148 
rb
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_»que¡_body_t
));

3149 ià(
rb
 =ð
NULL
) {

3150  
NGX_ERROR
;

3153 
r
->
»que¡_body
 = 
rb
;

3155 ià(
r
->
¥dy_¡»am
->
š_þo£d
) {

3156  
NGX_OK
;

3159 
rb
->
»¡
 = 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
;

3161 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3163 ià(
r
->
»que¡_body_š_fže_Úly


3164 || 
rb
->
»¡
 > (
off_t
è
þcf
->
þ›Á_body_bufãr_size


3165 || 
rb
->
»¡
 < 0)

3167 
tf
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_‹mp_fže_t
));

3168 ià(
tf
 =ð
NULL
) {

3169  
NGX_ERROR
;

3172 
tf
->
fže
.
fd
 = 
NGX_INVALID_FILE
;

3173 
tf
->
fže
.
log
 = 
r
->
cÚÃùiÚ
->log;

3174 
tf
->
·th
 = 
þcf
->
þ›Á_body_‹mp_·th
;

3175 
tf
->
poÞ
 = 
r
->pool;

3176 
tf
->
w¬n
 = "a client„equest body is bufferedo‡emporary file";

3177 
tf
->
log_Ëv–
 = 
r
->
»que¡_body_fže_log_Ëv–
;

3178 
tf
->
³rsi¡’t
 = 
r
->
»que¡_body_š_³rsi¡’t_fže
;

3179 
tf
->
þ—n
 = 
r
->
»que¡_body_š_þ—n_fže
;

3181 ià(
r
->
»que¡_body_fže_group_acûss
) {

3182 
tf
->
acûss
 = 0660;

3185 
rb
->
‹mp_fže
 = 
tf
;

3187 ià(
r
->
¥dy_¡»am
->
š_þo£d


3188 && 
	`ngx_ü—‹_‹mp_fže
(&
tf
->
fže
,f->
·th
,f->
poÞ
,

3189 
tf
->
³rsi¡’t
,f->
þ—n
,f->
acûss
)

3190 !ð
NGX_OK
)

3192  
NGX_ERROR
;

3195 
buf
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

3196 ià(
buf
 =ð
NULL
) {

3197  
NGX_ERROR
;

3202 ià(
rb
->
»¡
 == 0) {

3203  
NGX_OK
;

3206 
buf
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, (
size_t
è
rb
->
»¡
);

3207 ià(
buf
 =ð
NULL
) {

3208  
NGX_ERROR
;

3212 
rb
->
buf
 = buf;

3214 
rb
->
bufs
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

3215 ià(
rb
->
bufs
 =ð
NULL
) {

3216  
NGX_ERROR
;

3219 
rb
->
bufs
->
buf
 = buf;

3220 
rb
->
bufs
->
Ãxt
 = 
NULL
;

3222 
rb
->
»¡
 = 0;

3224  
NGX_OK
;

3225 
	}
}

3228 
ngx_št_t


3229 
	$ngx_h‰p_¥dy_»ad_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
,

3230 
ngx_h‰p_þ›Á_body_hªdËr_±
 
po¡_hªdËr
)

3232 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

3234 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3237 
¡»am
 = 
r
->
¥dy_¡»am
;

3239 
¡»am
->
sk_d©a
) {

3241 
NGX_SPDY_DATA_DISCARD
:

3242 
	`po¡_hªdËr
(
r
);

3243  
NGX_OK
;

3245 
NGX_SPDY_DATA_ERROR
:

3246 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 == -1) {

3247  
NGX_HTTP_REQUEST_ENTITY_TOO_LARGE
;

3249  
NGX_HTTP_BAD_REQUEST
;

3252 
NGX_SPDY_DATA_INTERNAL_ERROR
:

3253  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

3256 ià(!
r
->
»que¡_body
 && 
	`ngx_h‰p_¥dy_š™_»que¡_body
Ôè!ð
NGX_OK
) {

3257 
¡»am
->
sk_d©a
 = 
NGX_SPDY_DATA_INTERNAL_ERROR
;

3258  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

3261 ià(
¡»am
->
š_þo£d
) {

3262 
	`po¡_hªdËr
(
r
);

3263  
NGX_OK
;

3266 
r
->
»que¡_body
->
po¡_hªdËr
 =…ost_handler;

3268 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_‹¡_»adšg
;

3269 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

3271  
NGX_AGAIN
;

3272 
	}
}

3275 
ngx_št_t


3276 
	$ngx_h‰p_¥dy_‹rmš©e_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

3277 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
, 
ngx_ušt_t
 
¡©us
)

3279 
ngx_ev’t_t
 *
»v
;

3280 
ngx_cÚÃùiÚ_t
 *
fc
;

3282 ià(
	`ngx_h‰p_¥dy_£nd_r¡_¡»am
(
sc
, 
¡»am
->
id
, 
¡©us
,

3283 
NGX_SPDY_HIGHEST_PRIORITY
)

3284 =ð
NGX_ERROR
)

3286  
NGX_ERROR
;

3289 
¡»am
->
out_þo£d
 = 1;

3291 
fc
 = 
¡»am
->
»que¡
->
cÚÃùiÚ
;

3292 
fc
->
”rÜ
 = 1;

3294 
»v
 = 
fc
->
»ad
;

3295 
»v
->
	`hªdËr
(rev);

3297  
NGX_OK
;

3298 
	}
}

3302 
	$ngx_h‰p_¥dy_þo£_¡»am_hªdËr
(
ngx_ev’t_t
 *
ev
)

3304 
ngx_cÚÃùiÚ_t
 *
fc
;

3305 
ngx_h‰p_»que¡_t
 *
r
;

3307 
fc
 = 
ev
->
d©a
;

3308 
r
 = 
fc
->
d©a
;

3310 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3313 
	`ngx_h‰p_¥dy_þo£_¡»am
(
r
->
¥dy_¡»am
, 0);

3314 
	}
}

3318 
	$ngx_h‰p_¥dy_þo£_¡»am
(
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
, 
ngx_št_t
 
rc
)

3320 
tý_nod–ay
;

3321 
ngx_ev’t_t
 *
ev
;

3322 
ngx_cÚÃùiÚ_t
 *
c
, *
fc
;

3323 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3324 
ngx_h‰p_¥dy_¡»am_t
 **
šdex
, *
s
;

3325 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

3326 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
;

3328 
sc
 = 
¡»am
->
cÚÃùiÚ
;

3330 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

3332 
¡»am
->
id
, sŒ—m->
queued
, 
sc
->
´oûssšg
);

3334 
fc
 = 
¡»am
->
»que¡
->
cÚÃùiÚ
;

3336 ià(
¡»am
->
queued
) {

3337 
fc
->
wr™e
->
hªdËr
 = 
ngx_h‰p_¥dy_þo£_¡»am_hªdËr
;

3341 ià(!
¡»am
->
out_þo£d
) {

3342 ià(
	`ngx_h‰p_¥dy_£nd_r¡_¡»am
(
sc
, 
¡»am
->
id
,

3343 
NGX_SPDY_INTERNAL_ERROR
,

3344 
¡»am
->
´iÜ™y
)

3345 !ð
NGX_OK
)

3347 
sc
->
cÚÃùiÚ
->
”rÜ
 = 1;

3351 
c
 = 
sc
->
cÚÃùiÚ
;

3353 ià(
c
->
tý_nÝush
 =ð
NGX_TCP_NOPUSH_SET
) {

3354 ià(
	`ngx_tý_push
(
c
->
fd
) == -1) {

3355 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
,

3356 
ngx_tý_push_n
 " failed");

3357 
c
->
”rÜ
 = 1;

3358 
tý_nod–ay
 = 0;

3361 
c
->
tý_nÝush
 = 
NGX_TCP_NOPUSH_UNSET
;

3362 
tý_nod–ay
 = 
ngx_tý_nod–ay_ªd_tý_nÝush
 ? 1 : 0;

3366 
tý_nod–ay
 = 1;

3369 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
¡»am
->
»que¡
,

3370 
ngx_h‰p_cÜe_moduË
);

3372 ià(
tý_nod–ay


3373 && 
þcf
->
tý_nod–ay


3374 && 
c
->
tý_nod–ay
 =ð
NGX_TCP_NODELAY_UNSET
)

3376 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "tcp_nodelay");

3378 ià(
	`£tsockÝt
(
c
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

3379 (cÚ¡ *è&
tý_nod–ay
, ())

3382 #ià(
NGX_SOLARIS
)

3384 
c
->
log_”rÜ
 = 
NGX_ERROR_IGNORE_EINVAL
;

3387 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
,

3390 
c
->
log_”rÜ
 = 
NGX_ERROR_INFO
;

3391 
c
->
”rÜ
 = 1;

3394 
c
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_SET
;

3399 ià(
sc
->
¡»am
 == stream) {

3400 
sc
->
¡»am
 = 
NULL
;

3403 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

3404 
ngx_h‰p_¥dy_moduË
);

3406 
šdex
 = 
sc
->
¡»ams_šdex
 + 
	`ngx_h‰p_¥dy_¡»am_šdex
(
sscf
, 
¡»am
->
id
);

3409 
s
 = *
šdex
;

3411 ià(
s
 =ð
NULL
) {

3415 ià(
s
 =ð
¡»am
) {

3416 *
šdex
 = 
s
->index;

3420 
šdex
 = &
s
->index;

3423 
	`ngx_h‰p_ä“_»que¡
(
¡»am
->
»que¡
, 
rc
);

3425 
ev
 = 
fc
->
»ad
;

3427 ià(
ev
->
aùive
 ||ƒv->
di§bËd
) {

3428 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
sc
->
cÚÃùiÚ
->
log
, 0,

3432 ià(
ev
->
tim”_£t
) {

3433 
	`ngx_d–_tim”
(
ev
);

3436 ià(
ev
->
po¡ed
) {

3437 
	`ngx_d–‘e_po¡ed_ev’t
(
ev
);

3440 
ev
 = 
fc
->
wr™e
;

3442 ià(
ev
->
aùive
 ||ƒv->
di§bËd
) {

3443 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
sc
->
cÚÃùiÚ
->
log
, 0,

3447 ià(
ev
->
tim”_£t
) {

3448 
	`ngx_d–_tim”
(
ev
);

3451 ià(
ev
->
po¡ed
) {

3452 
	`ngx_d–‘e_po¡ed_ev’t
(
ev
);

3455 
fc
->
d©a
 = 
sc
->
ä“_çke_cÚÃùiÚs
;

3456 
sc
->
ä“_çke_cÚÃùiÚs
 = 
fc
;

3458 
sc
->
´oûssšg
--;

3460 ià(
sc
->
´oûssšg
 || sc->
blocked
) {

3464 
ev
 = 
sc
->
cÚÃùiÚ
->
»ad
;

3466 
ev
->
hªdËr
 = 
ngx_h‰p_¥dy_hªdË_cÚÃùiÚ_hªdËr
;

3467 
	`ngx_po¡_ev’t
(
ev
, &
ngx_po¡ed_ev’ts
);

3468 
	}
}

3472 
	$ngx_h‰p_¥dy_hªdË_cÚÃùiÚ_hªdËr
(
ngx_ev’t_t
 *
»v
)

3474 
ngx_cÚÃùiÚ_t
 *
c
;

3476 
»v
->
hªdËr
 = 
ngx_h‰p_¥dy_»ad_hªdËr
;

3478 ià(
»v
->
»ady
) {

3479 
	`ngx_h‰p_¥dy_»ad_hªdËr
(
»v
);

3483 
c
 = 
»v
->
d©a
;

3485 
	`ngx_h‰p_¥dy_hªdË_cÚÃùiÚ
(
c
->
d©a
);

3486 
	}
}

3490 
	$ngx_h‰p_¥dy_k“·live_hªdËr
(
ngx_ev’t_t
 *
»v
)

3492 
ngx_cÚÃùiÚ_t
 *
c
;

3493 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

3494 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
;

3496 
c
 = 
»v
->
d©a
;

3498 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "spdy keepalive handler");

3500 ià(
»v
->
timedout
 || 
c
->
þo£
) {

3501 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3505 #ià(
NGX_HAVE_KQUEUE
)

3507 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

3508 ià(
»v
->
³ndšg_eof
) {

3509 
c
->
log
->
hªdËr
 = 
NULL
;

3510 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
»v
->
kq_”ºo
,

3512 "k“·livcÚÃùiÚ", &
c
->
addr_‹xt
);

3513 #ià(
NGX_HTTP_SSL
)

3514 ià(
c
->
s¦
) {

3515 
c
->
s¦
->
no_£nd_shutdown
 = 1;

3518 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3525 
c
->
de¡royed
 = 0;

3526 
c
->
idË
 = 0;

3527 
	`ngx_»u§bË_cÚÃùiÚ
(
c
, 0);

3529 
sc
 = 
c
->
d©a
;

3531 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

3532 
ngx_h‰p_¥dy_moduË
);

3534 
sc
->
poÞ
 = 
	`ngx_ü—‹_poÞ
(
sscf
->
poÞ_size
, sc->
cÚÃùiÚ
->
log
);

3535 ià(
sc
->
poÞ
 =ð
NULL
) {

3536 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3540 
sc
->
¡»ams_šdex
 = 
	`ngx_pÿÎoc
(sc->
poÞ
,

3541 
	`ngx_h‰p_¥dy_¡»ams_šdex_size
(
sscf
)

3542 * (
ngx_h‰p_¥dy_¡»am_t
 *));

3543 ià(
sc
->
¡»ams_šdex
 =ð
NULL
) {

3544 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3548 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_¥dy_wr™e_hªdËr
;

3550 
»v
->
hªdËr
 = 
ngx_h‰p_¥dy_»ad_hªdËr
;

3551 
	`ngx_h‰p_¥dy_»ad_hªdËr
(
»v
);

3552 
	}
}

3556 
	$ngx_h‰p_¥dy_fš®ize_cÚÃùiÚ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

3557 
ngx_št_t
 
rc
)

3559 
ngx_ušt_t
 
i
, 
size
;

3560 
ngx_ev’t_t
 *
ev
;

3561 
ngx_cÚÃùiÚ_t
 *
c
, *
fc
;

3562 
ngx_h‰p_»que¡_t
 *
r
;

3563 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

3564 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

3566 
c
 = 
sc
->
cÚÃùiÚ
;

3568 ià(!
sc
->
´oûssšg
) {

3569 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3573 
c
->
”rÜ
 = 1;

3574 
c
->
»ad
->
hªdËr
 = 
ngx_h‰p_em±y_hªdËr
;

3575 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_em±y_hªdËr
;

3577 
sc
->
Ï¡_out
 = 
NULL
;

3579 
sc
->
blocked
 = 1;

3581 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

3582 
ngx_h‰p_¥dy_moduË
);

3584 
size
 = 
	`ngx_h‰p_¥dy_¡»ams_šdex_size
(
sscf
);

3586 
i
 = 0; i < 
size
; i++) {

3587 
¡»am
 = 
sc
->
¡»ams_šdex
[
i
];

3589 
¡»am
) {

3590 
¡»am
->
hªdËd
 = 0;

3592 
r
 = 
¡»am
->
»que¡
;

3593 
fc
 = 
r
->
cÚÃùiÚ
;

3595 
fc
->
”rÜ
 = 1;

3597 ià(
¡»am
->
queued
) {

3598 
¡»am
->
queued
 = 0;

3600 
ev
 = 
fc
->
wr™e
;

3601 
ev
->
d–ayed
 = 0;

3604 
ev
 = 
fc
->
»ad
;

3607 
¡»am
 = sŒ—m->
šdex
;

3609 
ev
->
eof
 = 1;

3610 
ev
->
	`hªdËr
(ev);

3614 
sc
->
blocked
 = 0;

3616 ià(
sc
->
´oûssšg
) {

3620 
	`ngx_h‰p_þo£_cÚÃùiÚ
(
c
);

3621 
	}
}

3624 
ngx_št_t


3625 
	$ngx_h‰p_¥dy_adju¡_wšdows
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ssize_t
 
d–
)

3627 
ngx_ušt_t
 
i
, 
size
;

3628 
ngx_ev’t_t
 *
wev
;

3629 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
, *
¢
;

3630 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

3632 
sscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
sc
->
h‰p_cÚÃùiÚ
->
cÚf_ùx
,

3633 
ngx_h‰p_¥dy_moduË
);

3635 
size
 = 
	`ngx_h‰p_¥dy_¡»ams_šdex_size
(
sscf
);

3637 
i
 = 0; i < 
size
; i++) {

3639 
¡»am
 = 
sc
->
¡»ams_šdex
[
i
]; sŒ—m; sŒ—m = 
¢
) {

3640 
¢
 = 
¡»am
->
šdex
;

3642 ià(
d–
 > 0

3643 && 
¡»am
->
£nd_wšdow


3644 > (
ssize_t
è(
NGX_SPDY_MAX_WINDOW
 - 
d–
))

3646 ià(
	`ngx_h‰p_¥dy_‹rmš©e_¡»am
(
sc
, 
¡»am
,

3647 
NGX_SPDY_FLOW_CONTROL_ERROR
)

3648 =ð
NGX_ERROR
)

3650  
NGX_ERROR
;

3656 
¡»am
->
£nd_wšdow
 +ð
d–
;

3658 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

3660 
¡»am
->
id
, sŒ—m->
£nd_wšdow
);

3662 ià(
¡»am
->
£nd_wšdow
 > 0 && sŒ—m->
exhau¡ed
) {

3663 
¡»am
->
exhau¡ed
 = 0;

3665 
wev
 = 
¡»am
->
»que¡
->
cÚÃùiÚ
->
wr™e
;

3667 ià(!
wev
->
tim”_£t
) {

3668 
wev
->
d–ayed
 = 0;

3669 
wev
->
	`hªdËr
(wev);

3675  
NGX_OK
;

3676 
	}
}

3680 
	$ngx_h‰p_¥dy_poÞ_þ—nup
(*
d©a
)

3682 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
 = 
d©a
;

3684 ià(
sc
->
poÞ
) {

3685 
	`ngx_de¡roy_poÞ
(
sc
->
poÞ
);

3687 
	}
}

3691 
	$ngx_h‰p_¥dy_z®loc
(*
Ýaque
, 
u_št
 
™ems
, u_šˆ
size
)

3693 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
 = 
Ýaque
;

3695  
	`ngx_·Îoc
(
sc
->
cÚÃùiÚ
->
poÞ
, 
™ems
 * 
size
);

3696 
	}
}

3700 
	$ngx_h‰p_¥dy_zä“
(*
Ýaque
, *
add»ss
)

3703 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
 = 
Ýaque
;

3705 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

3706 "¥dy zä“: %p", 
add»ss
);

3708 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_spdy_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngšx.h
>

12 
	~<ngx_h‰p_¥dy_moduË.h
>

14 
	~<zlib.h
>

17 
	#ngx_h‰p_¥dy_nv_nsize
(
h
è(
NGX_SPDY_NV_NLEN_SIZE
 + (hè- 1)

	)

18 
	#ngx_h‰p_¥dy_nv_vsize
(
h
è(
NGX_SPDY_NV_VLEN_SIZE
 + (hè- 1)

	)

20 
	#ngx_h‰p_¥dy_nv_wr™e_num
 
ngx_¥dy_äame_wr™e_ušt32


	)

21 
	#ngx_h‰p_¥dy_nv_wr™e_Æ’
 
ngx_¥dy_äame_wr™e_ušt32


	)

22 
	#ngx_h‰p_¥dy_nv_wr™e_vËn
 
ngx_¥dy_äame_wr™e_ušt32


	)

24 
	#ngx_h‰p_¥dy_nv_wr™e_Çme
(
p
, 
h
) \

25 
	`ngx_ýymem
(
	`ngx_h‰p_¥dy_nv_wr™e_Æ’
(
p
, (
h
è- 1), h, (hè- 1)

	)

27 
	#ngx_h‰p_¥dy_nv_wr™e_v®
(
p
, 
h
) \

28 
	`ngx_ýymem
(
	`ngx_h‰p_¥dy_nv_wr™e_vËn
(
p
, (
h
è- 1), h, (hè- 1)

	)

31 
ngx_chaš_t
 *
ngx_h‰p_¥dy_£nd_chaš
(
ngx_cÚÃùiÚ_t
 *
fc
,

32 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
);

34 
ngx_šlše
 
ngx_št_t
 
ngx_h‰p_¥dy_fž‹r_£nd
(

35 
ngx_cÚÃùiÚ_t
 *
fc
, 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
);

36 
ngx_šlše
 
ngx_št_t
 
ngx_h‰p_¥dy_æow_cÚŒÞ
(

37 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
);

38 
ngx_h‰p_¥dy_wa™šg_queue
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

39 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
);

41 
ngx_chaš_t
 *
ngx_h‰p_¥dy_fž‹r_g‘_shadow
(

42 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
, 
ngx_buf_t
 *
buf
, 
off_t
 
off£t
, off_ˆ
size
);

43 
ngx_h‰p_¥dy_out_äame_t
 *
ngx_h‰p_¥dy_fž‹r_g‘_d©a_äame
(

44 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
, 
size_t
 
Ën
, 
ngx_chaš_t
 *
fœ¡
,

45 
ngx_chaš_t
 *
Ï¡
);

47 
ngx_št_t
 
ngx_h‰p_¥dy_syn_äame_hªdËr
(

48 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_h‰p_¥dy_out_äame_t
 *
äame
);

49 
ngx_št_t
 
ngx_h‰p_¥dy_d©a_äame_hªdËr
(

50 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_h‰p_¥dy_out_äame_t
 *
äame
);

51 
ngx_šlše
 
ngx_h‰p_¥dy_hªdË_äame
(

52 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
, 
ngx_h‰p_¥dy_out_äame_t
 *
äame
);

53 
ngx_šlše
 
ngx_h‰p_¥dy_hªdË_¡»am
(

54 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
, 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
);

56 
ngx_h‰p_¥dy_fž‹r_þ—nup
(*
d©a
);

58 
ngx_št_t
 
ngx_h‰p_¥dy_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

61 
ngx_h‰p_moduË_t
 
	gngx_h‰p_¥dy_fž‹r_moduË_ùx
 = {

62 
NULL
,

63 
ngx_h‰p_¥dy_fž‹r_š™
,

65 
NULL
,

66 
NULL
,

68 
NULL
,

69 
NULL
,

71 
NULL
,

72 
NULL


76 
ngx_moduË_t
 
	gngx_h‰p_¥dy_fž‹r_moduË
 = {

77 
NGX_MODULE_V1
,

78 &
ngx_h‰p_¥dy_fž‹r_moduË_ùx
,

79 
NULL
,

80 
NGX_HTTP_MODULE
,

81 
NULL
,

82 
NULL
,

83 
NULL
,

84 
NULL
,

85 
NULL
,

86 
NULL
,

87 
NULL
,

88 
NGX_MODULE_V1_PADDING


92 
ngx_h‰p_ouut_h—d”_fž‹r_±
 
	gngx_h‰p_Ãxt_h—d”_fž‹r
;

95 
ngx_št_t


96 
	$ngx_h‰p_¥dy_h—d”_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
)

98 
rc
;

99 
size_t
 
Ën
;

100 
u_ch¬
 *
p
, *
buf
, *
Ï¡
;

101 
ngx_buf_t
 *
b
;

102 
ngx_¡r_t
 
ho¡
;

103 
ngx_ušt_t
 
i
, 
j
, 
couÁ
, 
pÜt
;

104 
ngx_chaš_t
 *
þ
;

105 
ngx_li¡_·¹_t
 *
·¹
, *
±
;

106 
ngx_bË_–t_t
 *
h—d”
, *
h
;

107 
ngx_cÚÃùiÚ_t
 *
c
;

108 
ngx_h‰p_þ—nup_t
 *
þn
;

109 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

110 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

111 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

112 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

113 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
;

114 
sockaddr_š
 *
sš
;

115 #ià(
NGX_HAVE_INET6
)

116 
sockaddr_š6
 *
sš6
;

118 
u_ch¬
 
addr
[
NGX_SOCKADDR_STRLEN
];

120 ià(!
r
->
¥dy_¡»am
) {

121  
	`ngx_h‰p_Ãxt_h—d”_fž‹r
(
r
);

124 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

127 ià(
r
->
h—d”_£Á
) {

128  
NGX_OK
;

131 
r
->
h—d”_£Á
 = 1;

133 ià(
r
 !ðr->
maš
) {

134  
NGX_OK
;

137 
c
 = 
r
->
cÚÃùiÚ
;

139 ià(
r
->
m‘hod
 =ð
NGX_HTTP_HEAD
) {

140 
r
->
h—d”_Úly
 = 1;

143 
r
->
h—d”s_out
.
¡©us
) {

145 
NGX_HTTP_OK
:

146 
NGX_HTTP_PARTIAL_CONTENT
:

149 
NGX_HTTP_NOT_MODIFIED
:

150 
r
->
h—d”_Úly
 = 1;

153 
NGX_HTTP_NO_CONTENT
:

154 
r
->
h—d”_Úly
 = 1;

156 
	`ngx_¡r_nuÎ
(&
r
->
h—d”s_out
.
cÚ‹Á_ty³
);

158 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 = 
NULL
;

159 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = -1;

164 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = -1;

165 
r
->
h—d”s_out
.
Ï¡_modif›d
 = 
NULL
;

168 
Ën
 = 
NGX_SPDY_NV_NUM_SIZE


169 + 
	`ngx_h‰p_¥dy_nv_nsize
(":version")

170 + 
	`ngx_h‰p_¥dy_nv_vsize
("HTTP/1.1")

171 + 
	`ngx_h‰p_¥dy_nv_nsize
(":status")

172 + (
r
->
h—d”s_out
.
¡©us_lše
.
Ën


173 ? 
NGX_SPDY_NV_VLEN_SIZE
 + 
r
->
h—d”s_out
.
¡©us_lše
.
Ën


174 : 
	`ngx_h‰p_¥dy_nv_vsize
("418"));

176 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

178 ià(
r
->
h—d”s_out
.
£rv”
 =ð
NULL
) {

179 
Ën
 +ð
	`ngx_h‰p_¥dy_nv_nsize
("server");

180 
Ën
 +ð
þcf
->
£rv”_tok’s
 ? 
	`ngx_h‰p_¥dy_nv_vsize
(
NGINX_VER
)

181 : 
	`ngx_h‰p_¥dy_nv_vsize
("nginx");

184 ià(
r
->
h—d”s_out
.
d©e
 =ð
NULL
) {

185 
Ën
 +ð
	`ngx_h‰p_¥dy_nv_nsize
("date")

186 + 
	`ngx_h‰p_¥dy_nv_vsize
("Wed, 31 Dec 1986 10:00:00 GMT");

189 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
) {

190 
Ën
 +ð
	`ngx_h‰p_¥dy_nv_nsize
("content-type")

191 + 
NGX_SPDY_NV_VLEN_SIZE
 + 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
;

193 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 =ðr->h—d”s_out.
cÚ‹Á_ty³
.
Ën


194 && 
r
->
h—d”s_out
.
ch¬£t
.
Ën
)

196 
Ën
 +ð("; ch¬£t="è- 1 + 
r
->
h—d”s_out
.
ch¬£t
.len;

200 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 =ð
NULL


201 && 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 >= 0)

203 
Ën
 +ð
	`ngx_h‰p_¥dy_nv_nsize
("content-length")

204 + 
NGX_SPDY_NV_VLEN_SIZE
 + 
NGX_OFF_T_LEN
;

207 ià(
r
->
h—d”s_out
.
Ï¡_modif›d
 =ð
NULL


208 && 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 != -1)

210 
Ën
 +ð
	`ngx_h‰p_¥dy_nv_nsize
("last-modified")

211 + 
	`ngx_h‰p_¥dy_nv_vsize
("Wed, 31 Dec 1986 10:00:00 GMT");

214 ià(
r
->
h—d”s_out
.
loÿtiÚ


215 && 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën


216 && 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
[0] == '/')

218 
r
->
h—d”s_out
.
loÿtiÚ
->
hash
 = 0;

220 ià(
þcf
->
£rv”_Çme_š_»dœeù
) {

221 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

222 
ho¡
 = 
cscf
->
£rv”_Çme
;

224 } ià(
r
->
h—d”s_š
.
£rv”
.
Ën
) {

225 
ho¡
 = 
r
->
h—d”s_š
.
£rv”
;

228 
ho¡
.
Ën
 = 
NGX_SOCKADDR_STRLEN
;

229 
ho¡
.
d©a
 = 
addr
;

231 ià(
	`ngx_cÚÃùiÚ_loÿl_sockaddr
(
c
, &
ho¡
, 0è!ð
NGX_OK
) {

232  
NGX_ERROR
;

236 
c
->
loÿl_sockaddr
->
§_çmžy
) {

238 #ià(
NGX_HAVE_INET6
)

239 
AF_INET6
:

240 
sš6
 = (
sockaddr_š6
 *è
c
->
loÿl_sockaddr
;

241 
pÜt
 = 
	`Áohs
(
sš6
->
sš6_pÜt
);

244 #ià(
NGX_HAVE_UNIX_DOMAIN
)

245 
AF_UNIX
:

246 
pÜt
 = 0;

250 
sš
 = (
sockaddr_š
 *è
c
->
loÿl_sockaddr
;

251 
pÜt
 = 
	`Áohs
(
sš
->
sš_pÜt
);

255 
Ën
 +ð
	`ngx_h‰p_¥dy_nv_nsize
("location")

256 + 
	`ngx_h‰p_¥dy_nv_vsize
("https://")

257 + 
ho¡
.
Ën


258 + 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
;

260 ià(
þcf
->
pÜt_š_»dœeù
) {

262 #ià(
NGX_HTTP_SSL
)

263 ià(
c
->
s¦
)

264 
pÜt
 = (port == 443) ? 0 :…ort;

267 
pÜt
 = (port == 80) ? 0 :…ort;

270 
pÜt
 = 0;

273 ià(
pÜt
) {

274 
Ën
 += (":65535") - 1;

278 
	`ngx_¡r_nuÎ
(&
ho¡
);

279 
pÜt
 = 0;

282 
·¹
 = &
r
->
h—d”s_out
.
h—d”s
.part;

283 
h—d”
 = 
·¹
->
–ts
;

285 
i
 = 0; ; i++) {

287 ià(
i
 >ð
·¹
->
ÃÉs
) {

288 ià(
·¹
->
Ãxt
 =ð
NULL
) {

292 
·¹
 =…¬t->
Ãxt
;

293 
h—d”
 = 
·¹
->
–ts
;

294 
i
 = 0;

297 ià(
h—d”
[
i
].
hash
 == 0) {

301 
Ën
 +ð
NGX_SPDY_NV_NLEN_SIZE
 + 
h—d”
[
i
].
key
.len

302 + 
NGX_SPDY_NV_VLEN_SIZE
 + 
h—d”
[
i
].
v®ue
.
Ën
;

305 
buf
 = 
	`ngx_®loc
(
Ën
, 
r
->
poÞ
->
log
);

306 ià(
buf
 =ð
NULL
) {

307  
NGX_ERROR
;

310 
Ï¡
 = 
buf
 + 
NGX_SPDY_NV_NUM_SIZE
;

312 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Çme
(last, ":version");

313 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_v®
(last, "HTTP/1.1");

315 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Çme
(last, ":status");

317 ià(
r
->
h—d”s_out
.
¡©us_lše
.
Ën
) {

318 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_vËn
(last,

319 
r
->
h—d”s_out
.
¡©us_lše
.
Ën
);

320 
Ï¡
 = 
	`ngx_ýymem
Öa¡, 
r
->
h—d”s_out
.
¡©us_lše
.
d©a
,

321 
r
->
h—d”s_out
.
¡©us_lše
.
Ën
);

323 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_vËn
(last, 3);

324 
Ï¡
 = 
	`ngx_¥rštf
Öa¡, "%03ui", 
r
->
h—d”s_out
.
¡©us
);

327 
couÁ
 = 2;

329 ià(
r
->
h—d”s_out
.
£rv”
 =ð
NULL
) {

330 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Çme
(last, "server");

331 
Ï¡
 = 
þcf
->
£rv”_tok’s


332 ? 
	`ngx_h‰p_¥dy_nv_wr™e_v®
(
Ï¡
, 
NGINX_VER
)

333 : 
	`ngx_h‰p_¥dy_nv_wr™e_v®
(
Ï¡
, "nginx");

335 
couÁ
++;

338 ià(
r
->
h—d”s_out
.
d©e
 =ð
NULL
) {

339 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Çme
(last, "date");

341 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_vËn
Öa¡, 
ngx_ÿched_h‰p_time
.
Ën
);

343 
Ï¡
 = 
	`ngx_ýymem
Öa¡, 
ngx_ÿched_h‰p_time
.
d©a
,

344 
ngx_ÿched_h‰p_time
.
Ën
);

346 
couÁ
++;

349 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
) {

351 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Çme
(last, "content-type");

353 
p
 = 
Ï¡
 + 
NGX_SPDY_NV_VLEN_SIZE
;

355 
Ï¡
 = 
	`ngx_ýymem
(
p
, 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
,

356 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
);

358 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 =ðr->h—d”s_out.
cÚ‹Á_ty³
.
Ën


359 && 
r
->
h—d”s_out
.
ch¬£t
.
Ën
)

361 
Ï¡
 = 
	`ngx_ýymem
(last, "; charset=", ("; charset=") - 1);

363 
Ï¡
 = 
	`ngx_ýymem
Öa¡, 
r
->
h—d”s_out
.
ch¬£t
.
d©a
,

364 
r
->
h—d”s_out
.
ch¬£t
.
Ën
);

368 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 = 
Ï¡
 - 
p
;

369 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
d©a
 = 
p
;

372 (è
	`ngx_h‰p_¥dy_nv_wr™e_vËn
(
p
 - 
NGX_SPDY_NV_VLEN_SIZE
,

373 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
);

375 
couÁ
++;

378 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 =ð
NULL


379 && 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 >= 0)

381 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Çme
(last, "content-length");

383 
p
 = 
Ï¡
 + 
NGX_SPDY_NV_VLEN_SIZE
;

385 
Ï¡
 = 
	`ngx_¥rštf
(
p
, "%O", 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
);

387 (è
	`ngx_h‰p_¥dy_nv_wr™e_vËn
(
p
 - 
NGX_SPDY_NV_VLEN_SIZE
,

388 
Ï¡
 - 
p
);

390 
couÁ
++;

393 ià(
r
->
h—d”s_out
.
Ï¡_modif›d
 =ð
NULL


394 && 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 != -1)

396 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Çme
(last, "last-modified");

398 
p
 = 
Ï¡
 + 
NGX_SPDY_NV_VLEN_SIZE
;

400 
Ï¡
 = 
	`ngx_h‰p_time
(
p
, 
r
->
h—d”s_out
.
Ï¡_modif›d_time
);

402 (è
	`ngx_h‰p_¥dy_nv_wr™e_vËn
(
p
 - 
NGX_SPDY_NV_VLEN_SIZE
,

403 
Ï¡
 - 
p
);

405 
couÁ
++;

408 ià(
ho¡
.
d©a
) {

410 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Çme
(last, "location");

412 
p
 = 
Ï¡
 + 
NGX_SPDY_NV_VLEN_SIZE
;

414 
Ï¡
 = 
	`ngx_ýymem
(
p
, "http", ("http") - 1);

416 #ià(
NGX_HTTP_SSL
)

417 ià(
c
->
s¦
) {

418 *
Ï¡
++ ='s';

422 *
Ï¡
++ = ':'; *last++ = '/'; *last++ = '/';

424 
Ï¡
 = 
	`ngx_ýymem
Öa¡, 
ho¡
.
d©a
, ho¡.
Ën
);

426 ià(
pÜt
) {

427 
Ï¡
 = 
	`ngx_¥rštf
Öa¡, ":%ui", 
pÜt
);

430 
Ï¡
 = 
	`ngx_ýymem
Öa¡, 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
,

431 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
);

435 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
 = 
Ï¡
 - 
p
;

436 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
d©a
 = 
p
;

437 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
loÿtiÚ
->
key
, "location");

439 (è
	`ngx_h‰p_¥dy_nv_wr™e_vËn
(
p
 - 
NGX_SPDY_NV_VLEN_SIZE
,

440 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.
Ën
);

442 
couÁ
++;

445 
·¹
 = &
r
->
h—d”s_out
.
h—d”s
.part;

446 
h—d”
 = 
·¹
->
–ts
;

448 
i
 = 0; ; i++) {

450 ià(
i
 >ð
·¹
->
ÃÉs
) {

451 ià(
·¹
->
Ãxt
 =ð
NULL
) {

455 
·¹
 =…¬t->
Ãxt
;

456 
h—d”
 = 
·¹
->
–ts
;

457 
i
 = 0;

460 ià(
h—d”
[
i
].
hash
 == 0 || header[i].hash == 2) {

464 
Ï¡
 = 
	`ngx_h‰p_¥dy_nv_wr™e_Æ’
Öa¡, 
h—d”
[
i
].
key
.
Ën
);

466 
	`ngx_¡¾ow
(
Ï¡
, 
h—d”
[
i
].
key
.
d©a
, h—d”[i].key.
Ën
);

467 
Ï¡
 +ð
h—d”
[
i
].
key
.
Ën
;

469 
p
 = 
Ï¡
 + 
NGX_SPDY_NV_VLEN_SIZE
;

471 
Ï¡
 = 
	`ngx_ýymem
(
p
, 
h—d”
[
i
].
v®ue
.
d©a
, h—d”[i].v®ue.
Ën
);

473 
±
 = 
·¹
;

474 
h
 = 
h—d”
;

476 
j
 = 
i
 + 1; ; j++) {

478 ià(
j
 >ð
±
->
ÃÉs
) {

479 ià(
±
->
Ãxt
 =ð
NULL
) {

483 
±
 =…t->
Ãxt
;

484 
h
 = 
±
->
–ts
;

485 
j
 = 0;

488 ià(
h
[
j
].
hash
 == 0 || h[j].hash == 2

489 || 
h
[
j
].
key
.
Ën
 !ð
h—d”
[
i
].key.len

490 || 
	`ngx_¡ºÿ£cmp
(
h—d”
[
i
].
key
.
d©a
, 
h
[
j
].key.data,

491 
h—d”
[
i
].
key
.
Ën
))

496 ià(
h
[
j
].
v®ue
.
Ën
) {

497 ià(
Ï¡
 !ð
p
) {

498 *
Ï¡
++ = '\0';

501 
Ï¡
 = 
	`ngx_ýymem
Öa¡, 
h
[
j
].
v®ue
.
d©a
, h[j].v®ue.
Ën
);

504 
h
[
j
].
hash
 = 2;

507 (è
	`ngx_h‰p_¥dy_nv_wr™e_vËn
(
p
 - 
NGX_SPDY_NV_VLEN_SIZE
,

508 
Ï¡
 - 
p
);

510 
couÁ
++;

513 (è
	`ngx_h‰p_¥dy_nv_wr™e_num
(
buf
, 
couÁ
);

515 
¡»am
 = 
r
->
¥dy_¡»am
;

516 
sc
 = 
¡»am
->
cÚÃùiÚ
;

518 
Ën
 = 
Ï¡
 - 
buf
;

520 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
NGX_SPDY_FRAME_HEADER_SIZE


521 + 
NGX_SPDY_SYN_REPLY_SIZE


522 + 
	`deæ©eBound
(&
sc
->
z¡»am_out
, 
Ën
));

523 ià(
b
 =ð
NULL
) {

524 
	`ngx_ä“
(
buf
);

525  
NGX_ERROR
;

528 
b
->
Ï¡
 +ð
NGX_SPDY_FRAME_HEADER_SIZE
 + 
NGX_SPDY_SYN_REPLY_SIZE
;

530 
sc
->
z¡»am_out
.
Ãxt_š
 = 
buf
;

531 
sc
->
z¡»am_out
.
avaž_š
 = 
Ën
;

532 
sc
->
z¡»am_out
.
Ãxt_out
 = 
b
->
Ï¡
;

533 
sc
->
z¡»am_out
.
avaž_out
 = 
b
->
’d
 - b->
Ï¡
;

535 
rc
 = 
	`deæ©e
(&
sc
->
z¡»am_out
, 
Z_SYNC_FLUSH
);

537 
	`ngx_ä“
(
buf
);

539 ià(
rc
 !ð
Z_OK
) {

540 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "deæ©e(èçžed: %d", 
rc
);

541  
NGX_ERROR
;

544 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

546 
sc
->
z¡»am_out
.
Ãxt_š
, sc->z¡»am_out.
Ãxt_out
,

547 
sc
->
z¡»am_out
.
avaž_š
, sc->z¡»am_out.
avaž_out
,

548 
rc
);

550 
b
->
Ï¡
 = 
sc
->
z¡»am_out
.
Ãxt_out
;

552 
p
 = 
b
->
pos
;

553 
p
 = 
	`ngx_¥dy_äame_wr™e_h—d
Õ, 
NGX_SPDY_SYN_REPLY
);

555 
Ën
 = 
b
->
Ï¡
 - b->
pos
;

557 
r
->
h—d”_size
 = 
Ën
;

559 
Ën
 -ð
NGX_SPDY_FRAME_HEADER_SIZE
;

561 ià(
r
->
h—d”_Úly
) {

562 
b
->
Ï¡_buf
 = 1;

563 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
Õ, 
NGX_SPDY_FLAG_FIN
, 
Ën
);

566 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
Õ, 0, 
Ën
);

569 (è
	`ngx_¥dy_äame_wr™e_sid
(
p
, 
¡»am
->
id
);

571 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

572 ià(
þ
 =ð
NULL
) {

573  
NGX_ERROR
;

576 
þ
->
buf
 = 
b
;

577 
þ
->
Ãxt
 = 
NULL
;

579 
äame
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_¥dy_out_äame_t
));

580 ià(
äame
 =ð
NULL
) {

581  
NGX_ERROR
;

584 
äame
->
fœ¡
 = 
þ
;

585 
äame
->
Ï¡
 = 
þ
;

586 
äame
->
hªdËr
 = 
ngx_h‰p_¥dy_syn_äame_hªdËr
;

587 
äame
->
¡»am
 = stream;

588 
äame
->
Ëngth
 = 
Ën
;

589 
äame
->
´iÜ™y
 = 
¡»am
->priority;

590 
äame
->
blocked
 = 1;

591 
äame
->
fš
 = 
r
->
h—d”_Úly
;

593 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
¡»am
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

595 
¡»am
->
id
, 
äame
, f¿me->
Ëngth
);

597 
	`ngx_h‰p_¥dy_queue_blocked_äame
(
sc
, 
äame
);

599 
þn
 = 
	`ngx_h‰p_þ—nup_add
(
r
, 0);

600 ià(
þn
 =ð
NULL
) {

601  
NGX_ERROR
;

604 
þn
->
hªdËr
 = 
ngx_h‰p_¥dy_fž‹r_þ—nup
;

605 
þn
->
d©a
 = 
¡»am
;

607 
¡»am
->
queued
 = 1;

609 
c
->
£nd_chaš
 = 
ngx_h‰p_¥dy_£nd_chaš
;

610 
c
->
Ãed_Ï¡_buf
 = 1;

612  
	`ngx_h‰p_¥dy_fž‹r_£nd
(
c
, 
¡»am
);

613 
	}
}

616 
ngx_chaš_t
 *

617 
	$ngx_h‰p_¥dy_£nd_chaš
(
ngx_cÚÃùiÚ_t
 *
fc
, 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
)

619 
off_t
 
size
, 
off£t
;

620 
size_t
 
»¡
, 
äame_size
;

621 
ngx_chaš_t
 *
þ
, *
out
, **
Ê
;

622 
ngx_h‰p_»que¡_t
 *
r
;

623 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

624 
ngx_h‰p_¥dy_loc_cÚf_t
 *
¦cf
;

625 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

626 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
;

628 
r
 = 
fc
->
d©a
;

629 
¡»am
 = 
r
->
¥dy_¡»am
;

631 #ià(
NGX_SUPPRESS_WARN
)

632 
size
 = 0;

635 
š
) {

636 
size
 = 
	`ngx_buf_size
(
š
->
buf
);

638 ià(
size
 || 
š
->
buf
->
Ï¡_buf
) {

642 
š
 = in->
Ãxt
;

645 ià(
š
 =ð
NULL
) {

647 ià(
¡»am
->
queued
) {

648 
fc
->
wr™e
->
d–ayed
 = 1;

650 
fc
->
bufã»d
 &ð~
NGX_SPDY_BUFFERED
;

653  
NULL
;

656 
sc
 = 
¡»am
->
cÚÃùiÚ
;

658 ià(
size
 && 
	`ngx_h‰p_¥dy_æow_cÚŒÞ
(
sc
, 
¡»am
è=ð
NGX_DECLINED
) {

659 
fc
->
wr™e
->
d–ayed
 = 1;

660  
š
;

663 ià(
lim™
 =ð0 ||†im™ > (
off_t
è
sc
->
£nd_wšdow
) {

664 
lim™
 = 
sc
->
£nd_wšdow
;

667 ià(
lim™
 > 
¡»am
->
£nd_wšdow
) {

668 
lim™
 = (
¡»am
->
£nd_wšdow
 > 0) ? stream->send_window : 0;

671 ià(
š
->
buf
->
g
 =ð(
ngx_buf_g_t
è&
ngx_h‰p_¥dy_fž‹r_g‘_shadow
) {

672 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

673 ià(
þ
 =ð
NULL
) {

674  
NGX_CHAIN_ERROR
;

677 
þ
->
buf
 = 
š
->buf;

678 
š
->
buf
 = 
þ
->buf->
shadow
;

680 
off£t
 = 
	`ngx_buf_š_memÜy
(
š
->
buf
)

681 ? (
þ
->
buf
->
pos
 - 
š
->buf->pos)

682 : (
þ
->
buf
->
fže_pos
 - 
š
->buf->file_pos);

684 
þ
->
Ãxt
 = 
¡»am
->
ä“_bufs
;

685 
¡»am
->
ä“_bufs
 = 
þ
;

688 
off£t
 = 0;

691 #ià(
NGX_SUPPRESS_WARN
)

692 
þ
 = 
NULL
;

695 
¦cf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_¥dy_moduË
);

697 
äame_size
 = (
lim™
 <ð(
off_t
è
¦cf
->
chunk_size
è? (
size_t
)†imit

698 : 
¦cf
->
chunk_size
;

701 
Ê
 = &
out
;

702 
»¡
 = 
äame_size
;

704 (
off_t
è
»¡
 >ð
size
) {

706 ià(
off£t
) {

707 
þ
 = 
	`ngx_h‰p_¥dy_fž‹r_g‘_shadow
(
¡»am
, 
š
->
buf
,

708 
off£t
, 
size
);

709 ià(
þ
 =ð
NULL
) {

710  
NGX_CHAIN_ERROR
;

713 
off£t
 = 0;

716 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

717 ià(
þ
 =ð
NULL
) {

718  
NGX_CHAIN_ERROR
;

721 
þ
->
buf
 = 
š
->buf;

724 *
Ê
 = 
þ
;

725 
Ê
 = &
þ
->
Ãxt
;

727 
»¡
 -ð(
size_t
è
size
;

728 
š
 = in->
Ãxt
;

730 ià(
š
 =ð
NULL
) {

731 
äame_size
 -ð
»¡
;

732 
»¡
 = 0;

736 
size
 = 
	`ngx_buf_size
(
š
->
buf
);

739 ià(
»¡
) {

740 
þ
 = 
	`ngx_h‰p_¥dy_fž‹r_g‘_shadow
(
¡»am
, 
š
->
buf
,

741 
off£t
, 
»¡
);

742 ià(
þ
 =ð
NULL
) {

743  
NGX_CHAIN_ERROR
;

746 
þ
->
buf
->
æush
 = 0;

747 
þ
->
buf
->
Ï¡_buf
 = 0;

749 *
Ê
 = 
þ
;

751 
off£t
 +ð
»¡
;

752 
size
 -ð
»¡
;

755 
äame
 = 
	`ngx_h‰p_¥dy_fž‹r_g‘_d©a_äame
(
¡»am
, 
äame_size
,

756 
out
, 
þ
);

757 ià(
äame
 =ð
NULL
) {

758  
NGX_CHAIN_ERROR
;

761 
	`ngx_h‰p_¥dy_queue_äame
(
sc
, 
äame
);

763 
sc
->
£nd_wšdow
 -ð
äame_size
;

765 
¡»am
->
£nd_wšdow
 -ð
äame_size
;

766 
¡»am
->
queued
++;

768 ià(
š
 =ð
NULL
) {

772 
lim™
 -ð
äame_size
;

774 ià(
lim™
 == 0) {

778 ià(
lim™
 < (
off_t
è
¦cf
->
chunk_size
) {

779 
äame_size
 = (
size_t
è
lim™
;

783 ià(
off£t
) {

784 
þ
 = 
	`ngx_h‰p_¥dy_fž‹r_g‘_shadow
(
¡»am
, 
š
->
buf
, 
off£t
, 
size
);

785 ià(
þ
 =ð
NULL
) {

786  
NGX_CHAIN_ERROR
;

789 
š
->
buf
 = 
þ
->buf;

790 
	`ngx_ä“_chaš
(
r
->
poÞ
, 
þ
);

793 ià(
	`ngx_h‰p_¥dy_fž‹r_£nd
(
fc
, 
¡»am
è=ð
NGX_ERROR
) {

794  
NGX_CHAIN_ERROR
;

797 ià(
š
 && 
	`ngx_h‰p_¥dy_æow_cÚŒÞ
(
sc
, 
¡»am
è=ð
NGX_DECLINED
) {

798 
fc
->
wr™e
->
d–ayed
 = 1;

801  
š
;

802 
	}
}

805 
ngx_chaš_t
 *

806 
	$ngx_h‰p_¥dy_fž‹r_g‘_shadow
(
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
, 
ngx_buf_t
 *
buf
,

807 
off_t
 
off£t
, off_ˆ
size
)

809 
ngx_buf_t
 *
chunk
;

810 
ngx_chaš_t
 *
þ
;

812 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
¡»am
->
»que¡
->
poÞ
, &¡»am->
ä“_bufs
);

813 ià(
þ
 =ð
NULL
) {

814  
NULL
;

817 
chunk
 = 
þ
->
buf
;

819 
	`ngx_memýy
(
chunk
, 
buf
, (
ngx_buf_t
));

821 
chunk
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_¥dy_fž‹r_g‘_shadow
;

822 
chunk
->
shadow
 = 
buf
;

824 ià(
	`ngx_buf_š_memÜy
(
chunk
)) {

825 
chunk
->
pos
 +ð
off£t
;

826 
chunk
->
Ï¡
 = chunk->
pos
 + 
size
;

829 ià(
chunk
->
š_fže
) {

830 
chunk
->
fže_pos
 +ð
off£t
;

831 
chunk
->
fže_Ï¡
 = chunk->
fže_pos
 + 
size
;

834  
þ
;

835 
	}
}

838 
ngx_h‰p_¥dy_out_äame_t
 *

839 
	$ngx_h‰p_¥dy_fž‹r_g‘_d©a_äame
(
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
,

840 
size_t
 
Ën
, 
ngx_chaš_t
 *
fœ¡
,‚gx_chaš_ˆ*
Ï¡
)

842 
u_ch¬
 *
p
;

843 
ngx_buf_t
 *
buf
;

844 
ngx_ušt_t
 
æags
;

845 
ngx_chaš_t
 *
þ
;

846 
ngx_h‰p_¥dy_out_äame_t
 *
äame
;

849 
äame
 = 
¡»am
->
ä“_äames
;

851 ià(
äame
) {

852 
¡»am
->
ä“_äames
 = 
äame
->
Ãxt
;

855 
äame
 = 
	`ngx_·Îoc
(
¡»am
->
»que¡
->
poÞ
,

856 (
ngx_h‰p_¥dy_out_äame_t
));

857 ià(
äame
 =ð
NULL
) {

858  
NULL
;

862 
æags
 = 
Ï¡
->
buf
->
Ï¡_buf
 ? 
NGX_SPDY_FLAG_FIN
 : 0;

864 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_HTTP
, 
¡»am
->
»que¡
->
cÚÃùiÚ
->
log
, 0,

866 
¡»am
->
id
, 
äame
, 
Ën
, 
æags
);

868 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
¡»am
->
»que¡
->
poÞ
,

869 &
¡»am
->
ä“_d©a_h—d”s
);

870 ià(
þ
 =ð
NULL
) {

871  
NULL
;

874 
buf
 = 
þ
->buf;

876 ià(
buf
->
¡¬t
) {

877 
p
 = 
buf
->
¡¬t
;

878 
buf
->
pos
 = 
p
;

880 
p
 +ð
NGX_SPDY_SID_SIZE
;

882 (è
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
(
p
, 
æags
, 
Ën
);

885 
p
 = 
	`ngx_·Îoc
(
¡»am
->
»que¡
->
poÞ
, 
NGX_SPDY_FRAME_HEADER_SIZE
);

886 ià(
p
 =ð
NULL
) {

887  
NULL
;

890 
buf
->
pos
 = 
p
;

891 
buf
->
¡¬t
 = 
p
;

893 
p
 = 
	`ngx_¥dy_äame_wr™e_sid
Õ, 
¡»am
->
id
);

894 
p
 = 
	`ngx_¥dy_äame_wr™e_æags_ªd_Ën
Õ, 
æags
, 
Ën
);

896 
buf
->
Ï¡
 = 
p
;

897 
buf
->
’d
 = 
p
;

899 
buf
->
g
 = (
ngx_buf_g_t
è&
ngx_h‰p_¥dy_fž‹r_g‘_d©a_äame
;

900 
buf
->
memÜy
 = 1;

903 
þ
->
Ãxt
 = 
fœ¡
;

904 
fœ¡
 = 
þ
;

906 
Ï¡
->
buf
->
æush
 = 1;

908 
äame
->
fœ¡
 = first;

909 
äame
->
Ï¡
 =†ast;

910 
äame
->
hªdËr
 = 
ngx_h‰p_¥dy_d©a_äame_hªdËr
;

911 
äame
->
¡»am
 = stream;

912 
äame
->
Ëngth
 = 
Ën
;

913 
äame
->
´iÜ™y
 = 
¡»am
->priority;

914 
äame
->
blocked
 = 0;

915 
äame
->
fš
 = 
Ï¡
->
buf
->
Ï¡_buf
;

917  
äame
;

918 
	}
}

921 
ngx_šlše
 
ngx_št_t


922 
	$ngx_h‰p_¥dy_fž‹r_£nd
(
ngx_cÚÃùiÚ_t
 *
fc
, 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
)

924 
¡»am
->
blocked
 = 1;

926 ià(
	`ngx_h‰p_¥dy_£nd_ouut_queue
(
¡»am
->
cÚÃùiÚ
è=ð
NGX_ERROR
) {

927 
fc
->
”rÜ
 = 1;

928  
NGX_ERROR
;

931 
¡»am
->
blocked
 = 0;

933 ià(
¡»am
->
queued
) {

934 
fc
->
bufã»d
 |ð
NGX_SPDY_BUFFERED
;

935 
fc
->
wr™e
->
d–ayed
 = 1;

936  
NGX_AGAIN
;

939 
fc
->
bufã»d
 &ð~
NGX_SPDY_BUFFERED
;

941  
NGX_OK
;

942 
	}
}

945 
ngx_šlše
 
ngx_št_t


946 
	$ngx_h‰p_¥dy_æow_cÚŒÞ
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

947 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
)

949 ià(
¡»am
->
£nd_wšdow
 <= 0) {

950 
¡»am
->
exhau¡ed
 = 1;

951  
NGX_DECLINED
;

954 ià(
sc
->
£nd_wšdow
 == 0) {

955 
	`ngx_h‰p_¥dy_wa™šg_queue
(
sc
, 
¡»am
);

956  
NGX_DECLINED
;

959  
NGX_OK
;

960 
	}
}

964 
	$ngx_h‰p_¥dy_wa™šg_queue
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

965 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
)

967 
ngx_queue_t
 *
q
;

968 
ngx_h‰p_¥dy_¡»am_t
 *
s
;

970 ià(
¡»am
->
hªdËd
) {

974 
¡»am
->
hªdËd
 = 1;

976 
q
 = 
	`ngx_queue_Ï¡
(&
sc
->
wa™šg
);

977 
q
 !ð
	`ngx_queue_£Áš–
(&
sc
->
wa™šg
);

978 
q
 = 
	`ngx_queue_´ev
(q))

980 
s
 = 
	`ngx_queue_d©a
(
q
, 
ngx_h‰p_¥dy_¡»am_t
, 
queue
);

985 ià(
¡»am
->
´iÜ™y
 >ð
s
->priority) {

990 
	`ngx_queue_š£¹_aá”
(
q
, &
¡»am
->
queue
);

991 
	}
}

994 
ngx_št_t


995 
	$ngx_h‰p_¥dy_syn_äame_hªdËr
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

996 
ngx_h‰p_¥dy_out_äame_t
 *
äame
)

998 
ngx_buf_t
 *
buf
;

999 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

1001 
buf
 = 
äame
->
fœ¡
->buf;

1003 ià(
buf
->
pos
 !ðbuf->
Ï¡
) {

1004  
NGX_AGAIN
;

1007 
¡»am
 = 
äame
->stream;

1009 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1010 "¥dy:%u˜SYN_REPLY f¿m%°wa £Á", 
¡»am
->
id
, 
äame
);

1012 
	`ngx_ä“_chaš
(
¡»am
->
»que¡
->
poÞ
, 
äame
->
fœ¡
);

1014 
	`ngx_h‰p_¥dy_hªdË_äame
(
¡»am
, 
äame
);

1016 
	`ngx_h‰p_¥dy_hªdË_¡»am
(
sc
, 
¡»am
);

1018  
NGX_OK
;

1019 
	}
}

1022 
ngx_št_t


1023 
	$ngx_h‰p_¥dy_d©a_äame_hªdËr
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

1024 
ngx_h‰p_¥dy_out_äame_t
 *
äame
)

1026 
ngx_buf_t
 *
buf
;

1027 
ngx_chaš_t
 *
þ
, *
Ê
;

1028 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
;

1030 
¡»am
 = 
äame
->stream;

1032 
þ
 = 
äame
->
fœ¡
;

1034 ià(
þ
->
buf
->
g
 =ð(
ngx_buf_g_t
è&
ngx_h‰p_¥dy_fž‹r_g‘_d©a_äame
) {

1036 ià(
þ
->
buf
->
pos
 !ðþ->buf->
Ï¡
) {

1037 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1039 
¡»am
->
id
, 
äame
);

1041  
NGX_AGAIN
;

1044 
Ê
 = 
þ
->
Ãxt
;

1046 
þ
->
Ãxt
 = 
¡»am
->
ä“_d©a_h—d”s
;

1047 
¡»am
->
ä“_d©a_h—d”s
 = 
þ
;

1049 ià(
þ
 =ð
äame
->
Ï¡
) {

1050 
dÚe
;

1053 
þ
 = 
Ê
;

1057 ià(
þ
->
buf
->
g
 =ð(
ngx_buf_g_t
è&
ngx_h‰p_¥dy_fž‹r_g‘_shadow
) {

1058 
buf
 = 
þ
->buf->
shadow
;

1060 ià(
	`ngx_buf_š_memÜy
(
buf
)) {

1061 
buf
->
pos
 = 
þ
->buf->pos;

1064 ià(
buf
->
š_fže
) {

1065 
buf
->
fže_pos
 = 
þ
->buf->file_pos;

1069 ià(
	`ngx_buf_size
(
þ
->
buf
) != 0) {

1071 ià(
þ
 !ð
äame
->
fœ¡
) {

1072 
äame
->
fœ¡
 = 
þ
;

1073 
	`ngx_h‰p_¥dy_hªdË_¡»am
(
sc
, 
¡»am
);

1076 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1078 
¡»am
->
id
, 
äame
);

1080  
NGX_AGAIN
;

1083 
Ê
 = 
þ
->
Ãxt
;

1085 ià(
þ
->
buf
->
g
 =ð(
ngx_buf_g_t
è&
ngx_h‰p_¥dy_fž‹r_g‘_shadow
) {

1086 
þ
->
Ãxt
 = 
¡»am
->
ä“_bufs
;

1087 
¡»am
->
ä“_bufs
 = 
þ
;

1090 
	`ngx_ä“_chaš
(
¡»am
->
»que¡
->
poÞ
, 
þ
);

1093 ià(
þ
 =ð
äame
->
Ï¡
) {

1094 
dÚe
;

1097 
þ
 = 
Ê
;

1100 
dÚe
:

1102 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
sc
->
cÚÃùiÚ
->
log
, 0,

1103 "¥dy:%u˜DATA f¿m%°wa £Á", 
¡»am
->
id
, 
äame
);

1105 
¡»am
->
»que¡
->
h—d”_size
 +ð
NGX_SPDY_FRAME_HEADER_SIZE
;

1107 
	`ngx_h‰p_¥dy_hªdË_äame
(
¡»am
, 
äame
);

1109 
	`ngx_h‰p_¥dy_hªdË_¡»am
(
sc
, 
¡»am
);

1111  
NGX_OK
;

1112 
	}
}

1115 
ngx_šlše
 

1116 
	$ngx_h‰p_¥dy_hªdË_äame
(
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
,

1117 
ngx_h‰p_¥dy_out_äame_t
 *
äame
)

1119 
ngx_h‰p_»que¡_t
 *
r
;

1121 
r
 = 
¡»am
->
»que¡
;

1123 
r
->
cÚÃùiÚ
->
£Á
 +ð
NGX_SPDY_FRAME_HEADER_SIZE
 + 
äame
->
Ëngth
;

1125 ià(
äame
->
fš
) {

1126 
¡»am
->
out_þo£d
 = 1;

1129 
äame
->
Ãxt
 = 
¡»am
->
ä“_äames
;

1130 
¡»am
->
ä“_äames
 = 
äame
;

1132 
¡»am
->
queued
--;

1133 
	}
}

1136 
ngx_šlše
 

1137 
	$ngx_h‰p_¥dy_hªdË_¡»am
(
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
,

1138 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
)

1140 
ngx_ev’t_t
 *
wev
;

1142 ià(
¡»am
->
hªdËd
 || sŒ—m->
blocked
 || sŒ—m->
exhau¡ed
) {

1146 
wev
 = 
¡»am
->
»que¡
->
cÚÃùiÚ
->
wr™e
;

1153 ià(!
wev
->
tim”_£t
) {

1154 
wev
->
d–ayed
 = 0;

1156 
¡»am
->
hªdËd
 = 1;

1157 
	`ngx_queue_š£¹_ž
(&
sc
->
po¡ed
, &
¡»am
->
queue
);

1159 
	}
}

1163 
	$ngx_h‰p_¥dy_fž‹r_þ—nup
(*
d©a
)

1165 
ngx_h‰p_¥dy_¡»am_t
 *
¡»am
 = 
d©a
;

1167 
size_t
 
d–
;

1168 
ngx_h‰p_¥dy_out_äame_t
 *
äame
, **
â
;

1169 
ngx_h‰p_¥dy_cÚÃùiÚ_t
 *
sc
;

1171 ià(
¡»am
->
hªdËd
) {

1172 
¡»am
->
hªdËd
 = 0;

1173 
	`ngx_queue_»move
(&
¡»am
->
queue
);

1176 ià(
¡»am
->
queued
 == 0) {

1180 
d–
 = 0;

1181 
sc
 = 
¡»am
->
cÚÃùiÚ
;

1182 
â
 = &
sc
->
Ï¡_out
;

1185 
äame
 = *
â
;

1187 ià(
äame
 =ð
NULL
) {

1191 ià(
äame
->
¡»am
 =ð¡»am && !äame->
blocked
) {

1192 *
â
 = 
äame
->
Ãxt
;

1194 
d–
 +ð
äame
->
Ëngth
;

1196 ià(--
¡»am
->
queued
 == 0) {

1203 
â
 = &
äame
->
Ãxt
;

1206 ià(
sc
->
£nd_wšdow
 =ð0 && 
d–
 && !
	`ngx_queue_em±y
(&sc->
wa™šg
)) {

1207 
	`ngx_queue_add
(&
sc
->
po¡ed
, &sc->
wa™šg
);

1208 
	`ngx_queue_š™
(&
sc
->
wa™šg
);

1211 
sc
->
£nd_wšdow
 +ð
d–
;

1212 
	}
}

1215 
ngx_št_t


1216 
	$ngx_h‰p_¥dy_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

1218 
ngx_h‰p_Ãxt_h—d”_fž‹r
 = 
ngx_h‰p_tÝ_h—d”_fž‹r
;

1219 
ngx_h‰p_tÝ_h—d”_fž‹r
 = 
ngx_h‰p_¥dy_h—d”_fž‹r
;

1221  
NGX_OK
;

1222 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_spdy_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngx_h‰p_¥dy_moduË.h
>

14 
ngx_št_t
 
ngx_h‰p_¥dy_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

16 
ngx_št_t
 
ngx_h‰p_¥dy_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

17 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

18 
ngx_št_t
 
ngx_h‰p_¥dy_»que¡_´iÜ™y_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

19 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

21 
ngx_št_t
 
ngx_h‰p_¥dy_moduË_š™
(
ngx_cyþe_t
 *
cyþe
);

23 *
ngx_h‰p_¥dy_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

24 *
ngx_h‰p_¥dy_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
);

25 *
ngx_h‰p_¥dy_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

26 *
ngx_h‰p_¥dy_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

27 *
chžd
);

28 *
ngx_h‰p_¥dy_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

29 *
ngx_h‰p_¥dy_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

30 *
chžd
);

32 *
ngx_h‰p_¥dy_»cv_bufãr_size
(
ngx_cÚf_t
 *
cf
, *
po¡
,

33 *
d©a
);

34 *
ngx_h‰p_¥dy_poÞ_size
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

35 *
ngx_h‰p_¥dy_¡»ams_šdex_mask
(
ngx_cÚf_t
 *
cf
, *
po¡
,

36 *
d©a
);

37 *
ngx_h‰p_¥dy_chunk_size
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
);

40 
ngx_cÚf_num_bounds_t
 
	gngx_h‰p_¥dy_h—d”s_comp_bounds
 = {

41 
ngx_cÚf_check_num_bounds
, 0, 9

44 
ngx_cÚf_po¡_t
 
	gngx_h‰p_¥dy_»cv_bufãr_size_po¡
 =

45 { 
ngx_h‰p_¥dy_»cv_bufãr_size
 };

46 
ngx_cÚf_po¡_t
 
	gngx_h‰p_¥dy_poÞ_size_po¡
 =

47 { 
ngx_h‰p_¥dy_poÞ_size
 };

48 
ngx_cÚf_po¡_t
 
	gngx_h‰p_¥dy_¡»ams_šdex_mask_po¡
 =

49 { 
ngx_h‰p_¥dy_¡»ams_šdex_mask
 };

50 
ngx_cÚf_po¡_t
 
	gngx_h‰p_¥dy_chunk_size_po¡
 =

51 { 
ngx_h‰p_¥dy_chunk_size
 };

54 
ngx_commªd_t
 
	gngx_h‰p_¥dy_commªds
[] = {

56 { 
ngx_¡ršg
("spdy_recv_buffer_size"),

57 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

58 
ngx_cÚf_£t_size_¦Ù
,

59 
NGX_HTTP_MAIN_CONF_OFFSET
,

60 
off£tof
(
ngx_h‰p_¥dy_maš_cÚf_t
, 
»cv_bufãr_size
),

61 &
ngx_h‰p_¥dy_»cv_bufãr_size_po¡
 },

63 { 
ngx_¡ršg
("spdy_pool_size"),

64 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

65 
ngx_cÚf_£t_size_¦Ù
,

66 
NGX_HTTP_SRV_CONF_OFFSET
,

67 
off£tof
(
ngx_h‰p_¥dy_¤v_cÚf_t
, 
poÞ_size
),

68 &
ngx_h‰p_¥dy_poÞ_size_po¡
 },

70 { 
ngx_¡ršg
("spdy_max_concurrent_streams"),

71 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

72 
ngx_cÚf_£t_num_¦Ù
,

73 
NGX_HTTP_SRV_CONF_OFFSET
,

74 
off£tof
(
ngx_h‰p_¥dy_¤v_cÚf_t
, 
cÚcu¼’t_¡»ams
),

75 
NULL
 },

77 { 
ngx_¡ršg
("spdy_streams_index_size"),

78 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

79 
ngx_cÚf_£t_num_¦Ù
,

80 
NGX_HTTP_SRV_CONF_OFFSET
,

81 
off£tof
(
ngx_h‰p_¥dy_¤v_cÚf_t
, 
¡»ams_šdex_mask
),

82 &
ngx_h‰p_¥dy_¡»ams_šdex_mask_po¡
 },

84 { 
ngx_¡ršg
("spdy_recv_timeout"),

85 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

86 
ngx_cÚf_£t_m£c_¦Ù
,

87 
NGX_HTTP_SRV_CONF_OFFSET
,

88 
off£tof
(
ngx_h‰p_¥dy_¤v_cÚf_t
, 
»cv_timeout
),

89 
NULL
 },

91 { 
ngx_¡ršg
("spdy_keepalive_timeout"),

92 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

93 
ngx_cÚf_£t_m£c_¦Ù
,

94 
NGX_HTTP_SRV_CONF_OFFSET
,

95 
off£tof
(
ngx_h‰p_¥dy_¤v_cÚf_t
, 
k“·live_timeout
),

96 
NULL
 },

98 { 
ngx_¡ršg
("spdy_headers_comp"),

99 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_CONF_TAKE1
,

100 
ngx_cÚf_£t_num_¦Ù
,

101 
NGX_HTTP_SRV_CONF_OFFSET
,

102 
off£tof
(
ngx_h‰p_¥dy_¤v_cÚf_t
, 
h—d”s_comp
),

103 &
ngx_h‰p_¥dy_h—d”s_comp_bounds
 },

105 { 
ngx_¡ršg
("spdy_chunk_size"),

106 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

107 
ngx_cÚf_£t_size_¦Ù
,

108 
NGX_HTTP_LOC_CONF_OFFSET
,

109 
off£tof
(
ngx_h‰p_¥dy_loc_cÚf_t
, 
chunk_size
),

110 &
ngx_h‰p_¥dy_chunk_size_po¡
 },

112 
ngx_nuÎ_commªd


116 
ngx_h‰p_moduË_t
 
	gngx_h‰p_¥dy_moduË_ùx
 = {

117 
ngx_h‰p_¥dy_add_v¬ŸbËs
,

118 
NULL
,

120 
ngx_h‰p_¥dy_ü—‹_maš_cÚf
,

121 
ngx_h‰p_¥dy_š™_maš_cÚf
,

123 
ngx_h‰p_¥dy_ü—‹_¤v_cÚf
,

124 
ngx_h‰p_¥dy_m”ge_¤v_cÚf
,

126 
ngx_h‰p_¥dy_ü—‹_loc_cÚf
,

127 
ngx_h‰p_¥dy_m”ge_loc_cÚf


131 
ngx_moduË_t
 
	gngx_h‰p_¥dy_moduË
 = {

132 
NGX_MODULE_V1
,

133 &
ngx_h‰p_¥dy_moduË_ùx
,

134 
ngx_h‰p_¥dy_commªds
,

135 
NGX_HTTP_MODULE
,

136 
NULL
,

137 
ngx_h‰p_¥dy_moduË_š™
,

138 
NULL
,

139 
NULL
,

140 
NULL
,

141 
NULL
,

142 
NULL
,

143 
NGX_MODULE_V1_PADDING


147 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_¥dy_v¬s
[] = {

149 { 
ngx_¡ršg
("¥dy"), 
NULL
,

150 
ngx_h‰p_¥dy_v¬ŸbË
, 0, 0, 0 },

152 { 
ngx_¡ršg
("¥dy_»que¡_´iÜ™y"), 
NULL
,

153 
ngx_h‰p_¥dy_»que¡_´iÜ™y_v¬ŸbË
, 0, 0, 0 },

155 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

159 
ngx_št_t


160 
	$ngx_h‰p_¥dy_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

162 
ngx_h‰p_v¬ŸbË_t
 *
v¬
, *
v
;

164 
v
 = 
ngx_h‰p_¥dy_v¬s
; v->
Çme
.
Ën
; v++) {

165 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

166 ià(
v¬
 =ð
NULL
) {

167  
NGX_ERROR
;

170 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

171 
v¬
->
d©a
 = 
v
->data;

174  
NGX_OK
;

175 
	}
}

178 
ngx_št_t


179 
	$ngx_h‰p_¥dy_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

180 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

182 ià(
r
->
¥dy_¡»am
) {

183 
v
->
Ën
 = ("3.1") - 1;

184 
v
->
v®id
 = 1;

185 
v
->
no_ÿch—bË
 = 0;

186 
v
->
nÙ_found
 = 0;

187 
v
->
d©a
 = (
u_ch¬
 *) "3.1";

189  
NGX_OK
;

192 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

194  
NGX_OK
;

195 
	}
}

198 
ngx_št_t


199 
	$ngx_h‰p_¥dy_»que¡_´iÜ™y_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

200 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

202 ià(
r
->
¥dy_¡»am
) {

203 
v
->
Ën
 = 1;

204 
v
->
v®id
 = 1;

205 
v
->
no_ÿch—bË
 = 0;

206 
v
->
nÙ_found
 = 0;

208 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 1);

209 ià(
v
->
d©a
 =ð
NULL
) {

210  
NGX_ERROR
;

213 
v
->
d©a
[0] = '0' + (
u_ch¬
è
r
->
¥dy_¡»am
->
´iÜ™y
;

215  
NGX_OK
;

218 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

220  
NGX_OK
;

221 
	}
}

224 
ngx_št_t


225 
	$ngx_h‰p_¥dy_moduË_š™
(
ngx_cyþe_t
 *
cyþe
)

227 
	`ngx_h‰p_¥dy_»que¡_h—d”s_š™
();

229  
NGX_OK
;

230 
	}
}

234 
	$ngx_h‰p_¥dy_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

236 
ngx_h‰p_¥dy_maš_cÚf_t
 *
smcf
;

238 
smcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_¥dy_maš_cÚf_t
));

239 ià(
smcf
 =ð
NULL
) {

240  
NULL
;

243 
smcf
->
»cv_bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

245  
smcf
;

246 
	}
}

250 
	$ngx_h‰p_¥dy_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
)

252 
ngx_h‰p_¥dy_maš_cÚf_t
 *
smcf
 = 
cÚf
;

254 
	`ngx_cÚf_š™_size_v®ue
(
smcf
->
»cv_bufãr_size
, 256 * 1024);

256  
NGX_CONF_OK
;

257 
	}
}

261 
	$ngx_h‰p_¥dy_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

263 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
sscf
;

265 
sscf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_¥dy_¤v_cÚf_t
));

266 ià(
sscf
 =ð
NULL
) {

267  
NULL
;

270 
sscf
->
poÞ_size
 = 
NGX_CONF_UNSET_SIZE
;

272 
sscf
->
cÚcu¼’t_¡»ams
 = 
NGX_CONF_UNSET_UINT
;

273 
sscf
->
¡»ams_šdex_mask
 = 
NGX_CONF_UNSET_UINT
;

275 
sscf
->
»cv_timeout
 = 
NGX_CONF_UNSET_MSEC
;

276 
sscf
->
k“·live_timeout
 = 
NGX_CONF_UNSET_MSEC
;

278 
sscf
->
h—d”s_comp
 = 
NGX_CONF_UNSET
;

280  
sscf
;

281 
	}
}

285 
	$ngx_h‰p_¥dy_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

287 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

288 
ngx_h‰p_¥dy_¤v_cÚf_t
 *
cÚf
 = 
chžd
;

290 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
poÞ_size
, 
´ev
->pool_size, 4096);

292 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
cÚcu¼’t_¡»ams
,

293 
´ev
->
cÚcu¼’t_¡»ams
, 100);

295 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
¡»ams_šdex_mask
,

296 
´ev
->
¡»ams_šdex_mask
, 32 - 1);

298 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
»cv_timeout
,

299 
´ev
->
»cv_timeout
, 30000);

300 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
k“·live_timeout
,

301 
´ev
->
k“·live_timeout
, 180000);

303 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
h—d”s_comp
, 
´ev
->headers_comp, 0);

305  
NGX_CONF_OK
;

306 
	}
}

310 
	$ngx_h‰p_¥dy_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

312 
ngx_h‰p_¥dy_loc_cÚf_t
 *
¦cf
;

314 
¦cf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_¥dy_loc_cÚf_t
));

315 ià(
¦cf
 =ð
NULL
) {

316  
NULL
;

319 
¦cf
->
chunk_size
 = 
NGX_CONF_UNSET_SIZE
;

321  
¦cf
;

322 
	}
}

326 
	$ngx_h‰p_¥dy_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

328 
ngx_h‰p_¥dy_loc_cÚf_t
 *
´ev
 = 
·»Á
;

329 
ngx_h‰p_¥dy_loc_cÚf_t
 *
cÚf
 = 
chžd
;

331 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
chunk_size
, 
´ev
->chunk_size, 8 * 1024);

333  
NGX_CONF_OK
;

334 
	}
}

338 
	$ngx_h‰p_¥dy_»cv_bufãr_size
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

340 
size_t
 *
¥
 = 
d©a
;

342 ià(*
¥
 <ð2 * 
NGX_SPDY_STATE_BUFFER_SIZE
) {

346  
NGX_CONF_OK
;

347 
	}
}

351 
	$ngx_h‰p_¥dy_poÞ_size
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

353 
size_t
 *
¥
 = 
d©a
;

355 ià(*
¥
 < 
NGX_MIN_POOL_SIZE
) {

356 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

358 
NGX_MIN_POOL_SIZE
);

359  
NGX_CONF_ERROR
;

362 ià(*
¥
 % 
NGX_POOL_ALIGNMENT
) {

363 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

365 
NGX_POOL_ALIGNMENT
);

366  
NGX_CONF_ERROR
;

369  
NGX_CONF_OK
;

370 
	}
}

374 
	$ngx_h‰p_¥dy_¡»ams_šdex_mask
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

376 
ngx_ušt_t
 *
Å
 = 
d©a
;

378 
ngx_ušt_t
 
mask
;

380 
mask
 = *
Å
 - 1;

382 ià(*
Å
 =ð0 || (*Å & 
mask
)) {

386 *
Å
 = 
mask
;

388  
NGX_CONF_OK
;

389 
	}
}

393 
	$ngx_h‰p_¥dy_chunk_size
(
ngx_cÚf_t
 *
cf
, *
po¡
, *
d©a
)

395 
size_t
 *
¥
 = 
d©a
;

397 ià(*
¥
 == 0) {

398 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

400  
NGX_CONF_ERROR
;

403 ià(*
¥
 > 
NGX_SPDY_MAX_FRAME_SIZE
) {

404 *
¥
 = 
NGX_SPDY_MAX_FRAME_SIZE
;

407  
NGX_CONF_OK
;

408 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_special_response.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngšx.h
>

14 
ngx_št_t
 
ngx_h‰p_£nd_”rÜ_·ge
(
ngx_h‰p_»que¡_t
 *
r
,

15 
ngx_h‰p_”r_·ge_t
 *
”r_·ge
);

16 
ngx_št_t
 
ngx_h‰p_£nd_¥ecŸl_»¥Ú£
(
ngx_h‰p_»que¡_t
 *
r
,

17 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, 
ngx_ušt_t
 
”r
);

18 
ngx_št_t
 
ngx_h‰p_£nd_»äesh
(
ngx_h‰p_»que¡_t
 *
r
);

21 
u_ch¬
 
	gngx_h‰p_”rÜ_fuÎ_ž
[] =

22 "<hr><ûÁ”>" 
NGINX_VER
 "</ûÁ”>" 
CRLF


23 "</body>" 
CRLF


24 "</html>" 
CRLF


28 
u_ch¬
 
	gngx_h‰p_”rÜ_ž
[] =

29 "<hr><ûÁ”>ngšx</ûÁ”>" 
CRLF


30 "</body>" 
CRLF


31 "</html>" 
CRLF


35 
u_ch¬
 
	gngx_h‰p_ms›_·ddšg
[] =

36 "<!--‡…addšgØdi§bË MSIE‡nd Chromä›ndlyƒ¼Ü…ag-->" 
CRLF


37 "<!--‡…addšgØdi§bË MSIE‡nd Chromä›ndlyƒ¼Ü…ag-->" 
CRLF


38 "<!--‡…addšgØdi§bË MSIE‡nd Chromä›ndlyƒ¼Ü…ag-->" 
CRLF


39 "<!--‡…addšgØdi§bË MSIE‡nd Chromä›ndlyƒ¼Ü…ag-->" 
CRLF


40 "<!--‡…addšgØdi§bË MSIE‡nd Chromä›ndlyƒ¼Ü…ag-->" 
CRLF


41 "<!--‡…addšgØdi§bË MSIE‡nd Chromä›ndlyƒ¼Ü…ag-->" 
CRLF


45 
u_ch¬
 
	gngx_h‰p_ms›_»äesh_h—d
[] =

49 
u_ch¬
 
	gngx_h‰p_ms›_»äesh_ž
[] =

50 "\"></h—d><body></body></html>" 
CRLF
;

53 
	gngx_h‰p_”rÜ_301_·ge
[] =

54 "<html>" 
CRLF


55 "<h—d><t™Ë>301 Moved P”mª’Žy</t™Ë></h—d>" 
CRLF


56 "<body bgcÞÜ=\"wh™e\">" 
CRLF


57 "<ûÁ”><h1>301 Moved P”mª’Žy</h1></ûÁ”>" 
CRLF


61 
	gngx_h‰p_”rÜ_302_·ge
[] =

62 "<html>" 
CRLF


63 "<h—d><t™Ë>302 Found</t™Ë></h—d>" 
CRLF


64 "<body bgcÞÜ=\"wh™e\">" 
CRLF


65 "<ûÁ”><h1>302 Found</h1></ûÁ”>" 
CRLF


69 
	gngx_h‰p_”rÜ_303_·ge
[] =

70 "<html>" 
CRLF


71 "<h—d><t™Ë>303 S“ Oth”</t™Ë></h—d>" 
CRLF


72 "<body bgcÞÜ=\"wh™e\">" 
CRLF


73 "<ûÁ”><h1>303 S“ Oth”</h1></ûÁ”>" 
CRLF


77 
	gngx_h‰p_”rÜ_307_·ge
[] =

78 "<html>" 
CRLF


79 "<h—d><t™Ë>307 TempÜ¬y Redœeù</t™Ë></h—d>" 
CRLF


80 "<body bgcÞÜ=\"wh™e\">" 
CRLF


81 "<ûÁ”><h1>307 TempÜ¬y Redœeù</h1></ûÁ”>" 
CRLF


85 
	gngx_h‰p_”rÜ_400_·ge
[] =

86 "<html>" 
CRLF


87 "<h—d><t™Ë>400 Bad Reque¡</t™Ë></h—d>" 
CRLF


88 "<body bgcÞÜ=\"wh™e\">" 
CRLF


89 "<ûÁ”><h1>400 Bad Reque¡</h1></ûÁ”>" 
CRLF


93 
	gngx_h‰p_”rÜ_401_·ge
[] =

94 "<html>" 
CRLF


95 "<h—d><t™Ë>401 AuthÜiz©iÚ Requœed</t™Ë></h—d>" 
CRLF


96 "<body bgcÞÜ=\"wh™e\">" 
CRLF


97 "<ûÁ”><h1>401 AuthÜiz©iÚ Requœed</h1></ûÁ”>" 
CRLF


101 
	gngx_h‰p_”rÜ_402_·ge
[] =

102 "<html>" 
CRLF


103 "<h—d><t™Ë>402 Paym’ˆRequœed</t™Ë></h—d>" 
CRLF


104 "<body bgcÞÜ=\"wh™e\">" 
CRLF


105 "<ûÁ”><h1>402 Paym’ˆRequœed</h1></ûÁ”>" 
CRLF


109 
	gngx_h‰p_”rÜ_403_·ge
[] =

110 "<html>" 
CRLF


111 "<h—d><t™Ë>403 FÜbidd’</t™Ë></h—d>" 
CRLF


112 "<body bgcÞÜ=\"wh™e\">" 
CRLF


113 "<ûÁ”><h1>403 FÜbidd’</h1></ûÁ”>" 
CRLF


117 
	gngx_h‰p_”rÜ_404_·ge
[] =

118 "<html>" 
CRLF


119 "<h—d><t™Ë>404 NÙ Found</t™Ë></h—d>" 
CRLF


120 "<body bgcÞÜ=\"wh™e\">" 
CRLF


121 "<ûÁ”><h1>404 NÙ Found</h1></ûÁ”>" 
CRLF


125 
	gngx_h‰p_”rÜ_405_·ge
[] =

126 "<html>" 
CRLF


127 "<h—d><t™Ë>405 NÙ AÎowed</t™Ë></h—d>" 
CRLF


128 "<body bgcÞÜ=\"wh™e\">" 
CRLF


129 "<ûÁ”><h1>405 NÙ AÎowed</h1></ûÁ”>" 
CRLF


133 
	gngx_h‰p_”rÜ_406_·ge
[] =

134 "<html>" 
CRLF


135 "<h—d><t™Ë>406 NÙ Acû±abË</t™Ë></h—d>" 
CRLF


136 "<body bgcÞÜ=\"wh™e\">" 
CRLF


137 "<ûÁ”><h1>406 NÙ Acû±abË</h1></ûÁ”>" 
CRLF


141 
	gngx_h‰p_”rÜ_408_·ge
[] =

142 "<html>" 
CRLF


143 "<h—d><t™Ë>408 Reque¡ Time-out</t™Ë></h—d>" 
CRLF


144 "<body bgcÞÜ=\"wh™e\">" 
CRLF


145 "<ûÁ”><h1>408 Reque¡ Time-out</h1></ûÁ”>" 
CRLF


149 
	gngx_h‰p_”rÜ_409_·ge
[] =

150 "<html>" 
CRLF


151 "<h—d><t™Ë>409 CÚæiù</t™Ë></h—d>" 
CRLF


152 "<body bgcÞÜ=\"wh™e\">" 
CRLF


153 "<ûÁ”><h1>409 CÚæiù</h1></ûÁ”>" 
CRLF


157 
	gngx_h‰p_”rÜ_410_·ge
[] =

158 "<html>" 
CRLF


159 "<h—d><t™Ë>410 GÚe</t™Ë></h—d>" 
CRLF


160 "<body bgcÞÜ=\"wh™e\">" 
CRLF


161 "<ûÁ”><h1>410 GÚe</h1></ûÁ”>" 
CRLF


165 
	gngx_h‰p_”rÜ_411_·ge
[] =

166 "<html>" 
CRLF


167 "<h—d><t™Ë>411 L’gth Requœed</t™Ë></h—d>" 
CRLF


168 "<body bgcÞÜ=\"wh™e\">" 
CRLF


169 "<ûÁ”><h1>411 L’gth Requœed</h1></ûÁ”>" 
CRLF


173 
	gngx_h‰p_”rÜ_412_·ge
[] =

174 "<html>" 
CRLF


175 "<h—d><t™Ë>412 P»cÚd™iÚ Fažed</t™Ë></h—d>" 
CRLF


176 "<body bgcÞÜ=\"wh™e\">" 
CRLF


177 "<ûÁ”><h1>412 P»cÚd™iÚ Fažed</h1></ûÁ”>" 
CRLF


181 
	gngx_h‰p_”rÜ_413_·ge
[] =

182 "<html>" 
CRLF


183 "<h—d><t™Ë>413 Reque¡ EÁ™y ToØL¬ge</t™Ë></h—d>" 
CRLF


184 "<body bgcÞÜ=\"wh™e\">" 
CRLF


185 "<ûÁ”><h1>413 Reque¡ EÁ™y ToØL¬ge</h1></ûÁ”>" 
CRLF


189 
	gngx_h‰p_”rÜ_414_·ge
[] =

190 "<html>" 
CRLF


191 "<h—d><t™Ë>414 Reque¡-URI ToØL¬ge</t™Ë></h—d>" 
CRLF


192 "<body bgcÞÜ=\"wh™e\">" 
CRLF


193 "<ûÁ”><h1>414 Reque¡-URI ToØL¬ge</h1></ûÁ”>" 
CRLF


197 
	gngx_h‰p_”rÜ_415_·ge
[] =

198 "<html>" 
CRLF


199 "<h—d><t™Ë>415 UnsuµÜ‹d MedŸ Ty³</t™Ë></h—d>" 
CRLF


200 "<body bgcÞÜ=\"wh™e\">" 
CRLF


201 "<ûÁ”><h1>415 UnsuµÜ‹d MedŸ Ty³</h1></ûÁ”>" 
CRLF


205 
	gngx_h‰p_”rÜ_416_·ge
[] =

206 "<html>" 
CRLF


207 "<h—d><t™Ë>416 Reque¡ed RªgNÙ S©isfŸbË</t™Ë></h—d>" 
CRLF


208 "<body bgcÞÜ=\"wh™e\">" 
CRLF


209 "<ûÁ”><h1>416 Reque¡ed RªgNÙ S©isfŸbË</h1></ûÁ”>" 
CRLF


213 
	gngx_h‰p_”rÜ_494_·ge
[] =

214 "<html>" 
CRLF


216 
CRLF


217 "<body bgcÞÜ=\"wh™e\">" 
CRLF


218 "<ûÁ”><h1>400 Bad Reque¡</h1></ûÁ”>" 
CRLF


219 "<ûÁ”>Reque¡ H—d” O¸Cook› ToØL¬ge</ûÁ”>" 
CRLF


223 
	gngx_h‰p_”rÜ_495_·ge
[] =

224 "<html>" 
CRLF


226 
CRLF


227 "<body bgcÞÜ=\"wh™e\">" 
CRLF


228 "<ûÁ”><h1>400 Bad Reque¡</h1></ûÁ”>" 
CRLF


229 "<ûÁ”>ThSSL c”tifiÿ‹ƒ¼Ü</ûÁ”>" 
CRLF


233 
	gngx_h‰p_”rÜ_496_·ge
[] =

234 "<html>" 
CRLF


236 
CRLF


237 "<body bgcÞÜ=\"wh™e\">" 
CRLF


238 "<ûÁ”><h1>400 Bad Reque¡</h1></ûÁ”>" 
CRLF


239 "<ûÁ”>NØ»quœed SSL c”tifiÿ‹ wa £Á</ûÁ”>" 
CRLF


243 
	gngx_h‰p_”rÜ_497_·ge
[] =

244 "<html>" 
CRLF


246 
CRLF


247 "<body bgcÞÜ=\"wh™e\">" 
CRLF


248 "<ûÁ”><h1>400 Bad Reque¡</h1></ûÁ”>" 
CRLF


249 "<ûÁ”>Th¶aš HTTP„eque¡ wa £ÁØHTTPS…Üt</ûÁ”>" 
CRLF


253 
	gngx_h‰p_”rÜ_500_·ge
[] =

254 "<html>" 
CRLF


255 "<h—d><t™Ë>500 IÁ”ÇÈS”v” E¼Ü</t™Ë></h—d>" 
CRLF


256 "<body bgcÞÜ=\"wh™e\">" 
CRLF


257 "<ûÁ”><h1>500 IÁ”ÇÈS”v” E¼Ü</h1></ûÁ”>" 
CRLF


261 
	gngx_h‰p_”rÜ_501_·ge
[] =

262 "<html>" 
CRLF


263 "<h—d><t™Ë>501 NÙ Im¶em’‹d</t™Ë></h—d>" 
CRLF


264 "<body bgcÞÜ=\"wh™e\">" 
CRLF


265 "<ûÁ”><h1>501 NÙ Im¶em’‹d</h1></ûÁ”>" 
CRLF


269 
	gngx_h‰p_”rÜ_502_·ge
[] =

270 "<html>" 
CRLF


271 "<h—d><t™Ë>502 Bad G©eway</t™Ë></h—d>" 
CRLF


272 "<body bgcÞÜ=\"wh™e\">" 
CRLF


273 "<ûÁ”><h1>502 Bad G©eway</h1></ûÁ”>" 
CRLF


277 
	gngx_h‰p_”rÜ_503_·ge
[] =

278 "<html>" 
CRLF


279 "<h—d><t™Ë>503 S”viû TempÜ¬žy UÇvažabË</t™Ë></h—d>" 
CRLF


280 "<body bgcÞÜ=\"wh™e\">" 
CRLF


281 "<ûÁ”><h1>503 S”viû TempÜ¬žy UÇvažabË</h1></ûÁ”>" 
CRLF


285 
	gngx_h‰p_”rÜ_504_·ge
[] =

286 "<html>" 
CRLF


287 "<h—d><t™Ë>504 G©eway Time-out</t™Ë></h—d>" 
CRLF


288 "<body bgcÞÜ=\"wh™e\">" 
CRLF


289 "<ûÁ”><h1>504 G©eway Time-out</h1></ûÁ”>" 
CRLF


293 
	gngx_h‰p_”rÜ_507_·ge
[] =

294 "<html>" 
CRLF


295 "<h—d><t™Ë>507 Insuffic›Á StÜage</t™Ë></h—d>" 
CRLF


296 "<body bgcÞÜ=\"wh™e\">" 
CRLF


297 "<ûÁ”><h1>507 Insuffic›Á StÜage</h1></ûÁ”>" 
CRLF


301 
ngx_¡r_t
 
	gngx_h‰p_”rÜ_·ges
[] = {

303 
ngx_nuÎ_¡ršg
,

305 
	#NGX_HTTP_LAST_2XX
 202

	)

306 
	#NGX_HTTP_OFF_3XX
 (
NGX_HTTP_LAST_2XX
 - 201)

	)

309 
ngx_¡ršg
(
ngx_h‰p_”rÜ_301_·ge
),

310 
ngx_¡ršg
(
ngx_h‰p_”rÜ_302_·ge
),

311 
ngx_¡ršg
(
ngx_h‰p_”rÜ_303_·ge
),

312 
ngx_nuÎ_¡ršg
,

313 
ngx_nuÎ_¡ršg
,

314 
ngx_nuÎ_¡ršg
,

315 
ngx_¡ršg
(
ngx_h‰p_”rÜ_307_·ge
),

317 
	#NGX_HTTP_LAST_3XX
 308

	)

318 
	#NGX_HTTP_OFF_4XX
 (
NGX_HTTP_LAST_3XX
 - 301 + 
NGX_HTTP_OFF_3XX
)

	)

320 
ngx_¡ršg
(
ngx_h‰p_”rÜ_400_·ge
),

321 
ngx_¡ršg
(
ngx_h‰p_”rÜ_401_·ge
),

322 
ngx_¡ršg
(
ngx_h‰p_”rÜ_402_·ge
),

323 
ngx_¡ršg
(
ngx_h‰p_”rÜ_403_·ge
),

324 
ngx_¡ršg
(
ngx_h‰p_”rÜ_404_·ge
),

325 
ngx_¡ršg
(
ngx_h‰p_”rÜ_405_·ge
),

326 
ngx_¡ršg
(
ngx_h‰p_”rÜ_406_·ge
),

327 
ngx_nuÎ_¡ršg
,

328 
ngx_¡ršg
(
ngx_h‰p_”rÜ_408_·ge
),

329 
ngx_¡ršg
(
ngx_h‰p_”rÜ_409_·ge
),

330 
ngx_¡ršg
(
ngx_h‰p_”rÜ_410_·ge
),

331 
ngx_¡ršg
(
ngx_h‰p_”rÜ_411_·ge
),

332 
ngx_¡ršg
(
ngx_h‰p_”rÜ_412_·ge
),

333 
ngx_¡ršg
(
ngx_h‰p_”rÜ_413_·ge
),

334 
ngx_¡ršg
(
ngx_h‰p_”rÜ_414_·ge
),

335 
ngx_¡ršg
(
ngx_h‰p_”rÜ_415_·ge
),

336 
ngx_¡ršg
(
ngx_h‰p_”rÜ_416_·ge
),

338 
	#NGX_HTTP_LAST_4XX
 417

	)

339 
	#NGX_HTTP_OFF_5XX
 (
NGX_HTTP_LAST_4XX
 - 400 + 
NGX_HTTP_OFF_4XX
)

	)

341 
ngx_¡ršg
(
ngx_h‰p_”rÜ_494_·ge
),

342 
ngx_¡ršg
(
ngx_h‰p_”rÜ_495_·ge
),

343 
ngx_¡ršg
(
ngx_h‰p_”rÜ_496_·ge
),

344 
ngx_¡ršg
(
ngx_h‰p_”rÜ_497_·ge
),

345 
ngx_¡ršg
(
ngx_h‰p_”rÜ_404_·ge
),

346 
ngx_nuÎ_¡ršg
,

348 
ngx_¡ršg
(
ngx_h‰p_”rÜ_500_·ge
),

349 
ngx_¡ršg
(
ngx_h‰p_”rÜ_501_·ge
),

350 
ngx_¡ršg
(
ngx_h‰p_”rÜ_502_·ge
),

351 
ngx_¡ršg
(
ngx_h‰p_”rÜ_503_·ge
),

352 
ngx_¡ršg
(
ngx_h‰p_”rÜ_504_·ge
),

353 
ngx_nuÎ_¡ršg
,

354 
ngx_nuÎ_¡ršg
,

355 
ngx_¡ršg
(
ngx_h‰p_”rÜ_507_·ge
)

357 
	#NGX_HTTP_LAST_5XX
 508

	)

362 
ngx_¡r_t
 
	gngx_h‰p_g‘_Çme
 = { 3, (
u_ch¬
 *) "GET " };

365 
ngx_št_t


366 
	$ngx_h‰p_¥ecŸl_»¥Ú£_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
”rÜ
)

368 
ngx_ušt_t
 
i
, 
”r
;

369 
ngx_h‰p_”r_·ge_t
 *
”r_·ge
;

370 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

372 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

374 
”rÜ
, &
r
->
uri
, &r->
¬gs
);

376 
r
->
”r_¡©us
 = 
”rÜ
;

378 ià(
r
->
k“·live
) {

379 
”rÜ
) {

380 
NGX_HTTP_BAD_REQUEST
:

381 
NGX_HTTP_REQUEST_ENTITY_TOO_LARGE
:

382 
NGX_HTTP_REQUEST_URI_TOO_LARGE
:

383 
NGX_HTTP_TO_HTTPS
:

384 
NGX_HTTPS_CERT_ERROR
:

385 
NGX_HTTPS_NO_CERT
:

386 
NGX_HTTP_INTERNAL_SERVER_ERROR
:

387 
NGX_HTTP_NOT_IMPLEMENTED
:

388 
r
->
k“·live
 = 0;

392 ià(
r
->
lšg”šg_þo£
) {

393 
”rÜ
) {

394 
NGX_HTTP_BAD_REQUEST
:

395 
NGX_HTTP_TO_HTTPS
:

396 
NGX_HTTPS_CERT_ERROR
:

397 
NGX_HTTPS_NO_CERT
:

398 
r
->
lšg”šg_þo£
 = 0;

402 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
 = 0;

404 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

406 ià(!
r
->
”rÜ_·ge
 && 
þcf
->
”rÜ_·ges
 &&„->
uri_chªges
 != 0) {

408 ià(
þcf
->
»cursive_”rÜ_·ges
 == 0) {

409 
r
->
”rÜ_·ge
 = 1;

412 
”r_·ge
 = 
þcf
->
”rÜ_·ges
->
–ts
;

414 
i
 = 0; i < 
þcf
->
”rÜ_·ges
->
ÃÉs
; i++) {

415 ià(
”r_·ge
[
i
].
¡©us
 =ð
”rÜ
) {

416  
	`ngx_h‰p_£nd_”rÜ_·ge
(
r
, &
”r_·ge
[
i
]);

421 
r
->
ex³ù_‹¡ed
 = 1;

423 ià(
	`ngx_h‰p_disÿrd_»que¡_body
(
r
è!ð
NGX_OK
) {

424 
r
->
k“·live
 = 0;

427 ià(
þcf
->
ms›_»äesh


428 && 
r
->
h—d”s_š
.
ms›


429 && (
”rÜ
 =ð
NGX_HTTP_MOVED_PERMANENTLY


430 || 
”rÜ
 =ð
NGX_HTTP_MOVED_TEMPORARILY
))

432  
	`ngx_h‰p_£nd_»äesh
(
r
);

435 ià(
”rÜ
 =ð
NGX_HTTP_CREATED
) {

437 
”r
 = 0;

439 } ià(
”rÜ
 =ð
NGX_HTTP_NO_CONTENT
) {

441 
”r
 = 0;

443 } ià(
”rÜ
 >ð
NGX_HTTP_MOVED_PERMANENTLY


444 && 
”rÜ
 < 
NGX_HTTP_LAST_3XX
)

447 
”r
 = 
”rÜ
 - 
NGX_HTTP_MOVED_PERMANENTLY
 + 
NGX_HTTP_OFF_3XX
;

449 } ià(
”rÜ
 >ð
NGX_HTTP_BAD_REQUEST


450 && 
”rÜ
 < 
NGX_HTTP_LAST_4XX
)

453 
”r
 = 
”rÜ
 - 
NGX_HTTP_BAD_REQUEST
 + 
NGX_HTTP_OFF_4XX
;

455 } ià(
”rÜ
 >ð
NGX_HTTP_NGINX_CODES


456 && 
”rÜ
 < 
NGX_HTTP_LAST_5XX
)

459 
”r
 = 
”rÜ
 - 
NGX_HTTP_NGINX_CODES
 + 
NGX_HTTP_OFF_5XX
;

460 
”rÜ
) {

461 
NGX_HTTP_TO_HTTPS
:

462 
NGX_HTTPS_CERT_ERROR
:

463 
NGX_HTTPS_NO_CERT
:

464 
NGX_HTTP_REQUEST_HEADER_TOO_LARGE
:

465 
r
->
”r_¡©us
 = 
NGX_HTTP_BAD_REQUEST
;

471 
”r
 = 0;

474  
	`ngx_h‰p_£nd_¥ecŸl_»¥Ú£
(
r
, 
þcf
, 
”r
);

475 
	}
}

478 
ngx_št_t


479 
	$ngx_h‰p_fž‹r_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_moduË_t
 *
m
,

480 
ngx_št_t
 
”rÜ
)

482 *
ùx
;

483 
ngx_št_t
 
rc
;

485 
	`ngx_h‰p_þ—n_h—d”
(
r
);

487 
ùx
 = 
NULL
;

489 ià(
m
) {

490 
ùx
 = 
r
->ùx[
m
->
ùx_šdex
];

494 
	`ngx_memz”o
(
r
->
ùx
, (*è* 
ngx_h‰p_max_moduË
);

496 ià(
m
) {

497 
r
->
ùx
[
m
->
ùx_šdex
] = ctx;

500 
r
->
fž‹r_fš®ize
 = 1;

502 
rc
 = 
	`ngx_h‰p_¥ecŸl_»¥Ú£_hªdËr
(
r
, 
”rÜ
);

506 
rc
) {

508 
NGX_OK
:

509 
NGX_DONE
:

510  
NGX_ERROR
;

513  
rc
;

515 
	}
}

519 
	$ngx_h‰p_þ—n_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

521 
	`ngx_memz”o
(&
r
->
h—d”s_out
.
¡©us
,

522 (
ngx_h‰p_h—d”s_out_t
)

523 - 
	`off£tof
(
ngx_h‰p_h—d”s_out_t
, 
¡©us
));

525 
r
->
h—d”s_out
.
h—d”s
.
·¹
.
ÃÉs
 = 0;

526 
r
->
h—d”s_out
.
h—d”s
.
·¹
.
Ãxt
 = 
NULL
;

527 
r
->
h—d”s_out
.
h—d”s
.
Ï¡
 = &r->h—d”s_out.h—d”s.
·¹
;

529 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = -1;

530 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 = -1;

531 
	}
}

534 
ngx_št_t


535 
	$ngx_h‰p_£nd_”rÜ_·ge
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_”r_·ge_t
 *
”r_·ge
)

537 
ngx_št_t
 
ov”wr™e
;

538 
ngx_¡r_t
 
uri
, 
¬gs
;

539 
ngx_bË_–t_t
 *
loÿtiÚ
;

540 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

542 
ov”wr™e
 = 
”r_·ge
->overwrite;

544 ià(
ov”wr™e
 && ov”wr™!ð
NGX_HTTP_OK
) {

545 
r
->
ex³ù_‹¡ed
 = 1;

548 ià(
ov”wr™e
 >= 0) {

549 
r
->
”r_¡©us
 = 
ov”wr™e
;

552 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, &
”r_·ge
->
v®ue
, &
uri
è!ð
NGX_OK
) {

553  
NGX_ERROR
;

556 ià(
uri
.
d©a
[0] == '/') {

558 ià(
”r_·ge
->
v®ue
.
Ëngths
) {

559 
	`ngx_h‰p_¥l™_¬gs
(
r
, &
uri
, &
¬gs
);

562 
¬gs
 = 
”r_·ge
->args;

565 ià(
r
->
m‘hod
 !ð
NGX_HTTP_HEAD
) {

566 
r
->
m‘hod
 = 
NGX_HTTP_GET
;

567 
r
->
m‘hod_Çme
 = 
ngx_h‰p_g‘_Çme
;

570  
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
uri
, &
¬gs
);

573 ià(
uri
.
d©a
[0] == '@') {

574  
	`ngx_h‰p_Çmed_loÿtiÚ
(
r
, &
uri
);

577 
loÿtiÚ
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

579 ià(
loÿtiÚ
 =ð
NULL
) {

580  
NGX_ERROR
;

583 ià(
ov”wr™e
 !ð
NGX_HTTP_MOVED_PERMANENTLY


584 && 
ov”wr™e
 !ð
NGX_HTTP_MOVED_TEMPORARILY


585 && 
ov”wr™e
 !ð
NGX_HTTP_SEE_OTHER


586 && 
ov”wr™e
 !ð
NGX_HTTP_TEMPORARY_REDIRECT
)

588 
r
->
”r_¡©us
 = 
NGX_HTTP_MOVED_TEMPORARILY
;

591 
loÿtiÚ
->
hash
 = 1;

592 
	`ngx_¡r_£t
(&
loÿtiÚ
->
key
, "Location");

593 
loÿtiÚ
->
v®ue
 = 
uri
;

595 
	`ngx_h‰p_þ—r_loÿtiÚ
(
r
);

597 
r
->
h—d”s_out
.
loÿtiÚ
 =†ocation;

599 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

601 ià(
þcf
->
ms›_»äesh
 && 
r
->
h—d”s_š
.
ms›
) {

602  
	`ngx_h‰p_£nd_»äesh
(
r
);

605  
	`ngx_h‰p_£nd_¥ecŸl_»¥Ú£
(
r
, 
þcf
,„->
”r_¡©us


606 - 
NGX_HTTP_MOVED_PERMANENTLY


607 + 
NGX_HTTP_OFF_3XX
);

608 
	}
}

611 
ngx_št_t


612 
	$ngx_h‰p_£nd_¥ecŸl_»¥Ú£
(
ngx_h‰p_»que¡_t
 *
r
,

613 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
, 
ngx_ušt_t
 
”r
)

615 
u_ch¬
 *
ž
;

616 
size_t
 
Ën
;

617 
ngx_št_t
 
rc
;

618 
ngx_buf_t
 *
b
;

619 
ngx_ušt_t
 
ms›_·ddšg
;

620 
ngx_chaš_t
 
out
[3];

622 ià(
þcf
->
£rv”_tok’s
) {

623 
Ën
 = (
ngx_h‰p_”rÜ_fuÎ_ž
) - 1;

624 
ž
 = 
ngx_h‰p_”rÜ_fuÎ_ž
;

627 
Ën
 = (
ngx_h‰p_”rÜ_ž
) - 1;

628 
ž
 = 
ngx_h‰p_”rÜ_ž
;

631 
ms›_·ddšg
 = 0;

633 ià(
ngx_h‰p_”rÜ_·ges
[
”r
].
Ën
) {

634 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
ngx_h‰p_”rÜ_·ges
[
”r
].
Ën
 +†en;

635 ià(
þcf
->
ms›_·ddšg


636 && (
r
->
h—d”s_š
.
ms›
 ||„->h—d”s_š.
chrome
)

637 && 
r
->
h‰p_v”siÚ
 >ð
NGX_HTTP_VERSION_10


638 && 
”r
 >ð
NGX_HTTP_OFF_4XX
)

640 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 +=

641 (
ngx_h‰p_ms›_·ddšg
) - 1;

642 
ms›_·ddšg
 = 1;

645 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = ("text/html") - 1;

646 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
cÚ‹Á_ty³
, "text/html");

647 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

650 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 0;

653 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
) {

654 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
->
hash
 = 0;

655 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 = 
NULL
;

658 
	`ngx_h‰p_þ—r_acû±_¿nges
(
r
);

659 
	`ngx_h‰p_þ—r_Ï¡_modif›d
(
r
);

660 
	`ngx_h‰p_þ—r_‘ag
(
r
);

662 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

664 ià(
rc
 =ð
NGX_ERROR
 || 
r
->
h—d”_Úly
) {

665  
rc
;

668 ià(
ngx_h‰p_”rÜ_·ges
[
”r
].
Ën
 == 0) {

669  
	`ngx_h‰p_£nd_¥ecŸl
(
r
, 
NGX_HTTP_LAST
);

672 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

673 ià(
b
 =ð
NULL
) {

674  
NGX_ERROR
;

677 
b
->
memÜy
 = 1;

678 
b
->
pos
 = 
ngx_h‰p_”rÜ_·ges
[
”r
].
d©a
;

679 
b
->
Ï¡
 = 
ngx_h‰p_”rÜ_·ges
[
”r
].
d©a
 +‚gx_h‰p_”rÜ_·ges[”r].
Ën
;

681 
out
[0].
buf
 = 
b
;

682 
out
[0].
Ãxt
 = &out[1];

684 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

685 ià(
b
 =ð
NULL
) {

686  
NGX_ERROR
;

689 
b
->
memÜy
 = 1;

691 
b
->
pos
 = 
ž
;

692 
b
->
Ï¡
 = 
ž
 + 
Ën
;

694 
out
[1].
buf
 = 
b
;

695 
out
[1].
Ãxt
 = 
NULL
;

697 ià(
ms›_·ddšg
) {

698 
b
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

699 ià(
b
 =ð
NULL
) {

700  
NGX_ERROR
;

703 
b
->
memÜy
 = 1;

704 
b
->
pos
 = 
ngx_h‰p_ms›_·ddšg
;

705 
b
->
Ï¡
 = 
ngx_h‰p_ms›_·ddšg
 + (ngx_http_msie_padding) - 1;

707 
out
[1].
Ãxt
 = &out[2];

708 
out
[2].
buf
 = 
b
;

709 
out
[2].
Ãxt
 = 
NULL
;

712 ià(
r
 =ðr->
maš
) {

713 
b
->
Ï¡_buf
 = 1;

716 
b
->
Ï¡_š_chaš
 = 1;

718  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
[0]);

719 
	}
}

722 
ngx_št_t


723 
	$ngx_h‰p_£nd_»äesh
(
ngx_h‰p_»que¡_t
 *
r
)

725 
u_ch¬
 *
p
, *
loÿtiÚ
;

726 
size_t
 
Ën
, 
size
;

727 
ušŒ_t
 
esÿ³
;

728 
ngx_št_t
 
rc
;

729 
ngx_buf_t
 *
b
;

730 
ngx_chaš_t
 
out
;

732 
Ën
 = 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.len;

733 
loÿtiÚ
 = 
r
->
h—d”s_out
.loÿtiÚ->
v®ue
.
d©a
;

735 
esÿ³
 = 2 * 
	`ngx_esÿ³_uri
(
NULL
, 
loÿtiÚ
, 
Ën
, 
NGX_ESCAPE_REFRESH
);

737 
size
 = (
ngx_h‰p_ms›_»äesh_h—d
) - 1

738 + 
esÿ³
 + 
Ën


739 + (
ngx_h‰p_ms›_»äesh_ž
) - 1;

741 
r
->
”r_¡©us
 = 
NGX_HTTP_OK
;

743 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = ("text/html") - 1;

744 
	`ngx_¡r_£t
(&
r
->
h—d”s_out
.
cÚ‹Á_ty³
, "text/html");

745 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

747 
r
->
h—d”s_out
.
loÿtiÚ
->
hash
 = 0;

748 
r
->
h—d”s_out
.
loÿtiÚ
 = 
NULL
;

750 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
size
;

752 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
) {

753 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
->
hash
 = 0;

754 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
 = 
NULL
;

757 
	`ngx_h‰p_þ—r_acû±_¿nges
(
r
);

758 
	`ngx_h‰p_þ—r_Ï¡_modif›d
(
r
);

759 
	`ngx_h‰p_þ—r_‘ag
(
r
);

761 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

763 ià(
rc
 =ð
NGX_ERROR
 || 
r
->
h—d”_Úly
) {

764  
rc
;

767 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
size
);

768 ià(
b
 =ð
NULL
) {

769  
NGX_ERROR
;

772 
p
 = 
	`ngx_ýymem
(
b
->
pos
, 
ngx_h‰p_ms›_»äesh_h—d
,

773 (
ngx_h‰p_ms›_»äesh_h—d
) - 1);

775 ià(
esÿ³
 == 0) {

776 
p
 = 
	`ngx_ýymem
Õ, 
loÿtiÚ
, 
Ën
);

779 
p
 = (
u_ch¬
 *è
	`ngx_esÿ³_uri
Õ, 
loÿtiÚ
, 
Ën
, 
NGX_ESCAPE_REFRESH
);

782 
b
->
Ï¡
 = 
	`ngx_ýymem
(
p
, 
ngx_h‰p_ms›_»äesh_ž
,

783 (
ngx_h‰p_ms›_»äesh_ž
) - 1);

785 
b
->
Ï¡_buf
 = 1;

786 
b
->
Ï¡_š_chaš
 = 1;

788 
out
.
buf
 = 
b
;

789 
out
.
Ãxt
 = 
NULL
;

791  
	`ngx_h‰p_ouut_fž‹r
(
r
, &
out
);

792 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_upstream.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 #ià(
NGX_HTTP_CACHE
)

14 
ngx_št_t
 
ngx_h‰p_up¡»am_ÿche
(
ngx_h‰p_»que¡_t
 *
r
,

15 
ngx_h‰p_up¡»am_t
 *
u
);

16 
ngx_št_t
 
ngx_h‰p_up¡»am_ÿche_£nd
(
ngx_h‰p_»que¡_t
 *
r
,

17 
ngx_h‰p_up¡»am_t
 *
u
);

18 
ngx_št_t
 
ngx_h‰p_up¡»am_ÿche_¡©us
(
ngx_h‰p_»que¡_t
 *
r
,

19 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

20 
ngx_št_t
 
ngx_h‰p_up¡»am_ÿche_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
,

21 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

22 
ngx_št_t
 
ngx_h‰p_up¡»am_ÿche_‘ag
(
ngx_h‰p_»que¡_t
 *
r
,

23 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

26 
ngx_h‰p_up¡»am_š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

27 
ngx_h‰p_up¡»am_»sÞve_hªdËr
(
ngx_»sÞv”_ùx_t
 *
ùx
);

28 
ngx_h‰p_up¡»am_rd_check_brok’_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
);

29 
ngx_h‰p_up¡»am_wr_check_brok’_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
);

30 
ngx_h‰p_up¡»am_check_brok’_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

31 
ngx_ev’t_t
 *
ev
);

32 
ngx_h‰p_up¡»am_cÚÃù
(
ngx_h‰p_»que¡_t
 *
r
,

33 
ngx_h‰p_up¡»am_t
 *
u
);

34 
ngx_št_t
 
ngx_h‰p_up¡»am_»š™
(
ngx_h‰p_»que¡_t
 *
r
,

35 
ngx_h‰p_up¡»am_t
 *
u
);

36 
ngx_h‰p_up¡»am_£nd_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

37 
ngx_h‰p_up¡»am_t
 *
u
);

38 
ngx_h‰p_up¡»am_£nd_»que¡_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

39 
ngx_h‰p_up¡»am_t
 *
u
);

40 
ngx_h‰p_up¡»am_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

41 
ngx_h‰p_up¡»am_t
 *
u
);

42 
ngx_št_t
 
ngx_h‰p_up¡»am_‹¡_Ãxt
(
ngx_h‰p_»que¡_t
 *
r
,

43 
ngx_h‰p_up¡»am_t
 *
u
);

44 
ngx_št_t
 
ngx_h‰p_up¡»am_š‹rû±_”rÜs
(
ngx_h‰p_»que¡_t
 *
r
,

45 
ngx_h‰p_up¡»am_t
 *
u
);

46 
ngx_št_t
 
ngx_h‰p_up¡»am_‹¡_cÚÃù
(
ngx_cÚÃùiÚ_t
 *
c
);

47 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_h—d”s
(
ngx_h‰p_»que¡_t
 *
r
,

48 
ngx_h‰p_up¡»am_t
 *
u
);

49 
ngx_h‰p_up¡»am_´oûss_body_š_memÜy
(
ngx_h‰p_»que¡_t
 *
r
,

50 
ngx_h‰p_up¡»am_t
 *
u
);

51 
ngx_h‰p_up¡»am_£nd_»¥Ú£
(
ngx_h‰p_»que¡_t
 *
r
,

52 
ngx_h‰p_up¡»am_t
 *
u
);

53 
ngx_h‰p_up¡»am_upg¿de
(
ngx_h‰p_»que¡_t
 *
r
,

54 
ngx_h‰p_up¡»am_t
 *
u
);

55 
ngx_h‰p_up¡»am_upg¿ded_»ad_down¡»am
(
ngx_h‰p_»que¡_t
 *
r
);

56 
ngx_h‰p_up¡»am_upg¿ded_wr™e_down¡»am
(
ngx_h‰p_»que¡_t
 *
r
);

57 
ngx_h‰p_up¡»am_upg¿ded_»ad_up¡»am
(
ngx_h‰p_»que¡_t
 *
r
,

58 
ngx_h‰p_up¡»am_t
 *
u
);

59 
ngx_h‰p_up¡»am_upg¿ded_wr™e_up¡»am
(
ngx_h‰p_»que¡_t
 *
r
,

60 
ngx_h‰p_up¡»am_t
 *
u
);

61 
ngx_h‰p_up¡»am_´oûss_upg¿ded
(
ngx_h‰p_»que¡_t
 *
r
,

62 
ngx_ušt_t
 
äom_up¡»am
,‚gx_ušt_ˆ
do_wr™e
);

64 
ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_down¡»am
(
ngx_h‰p_»que¡_t
 *
r
);

66 
ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_up¡»am
(
ngx_h‰p_»que¡_t
 *
r
,

67 
ngx_h‰p_up¡»am_t
 *
u
);

69 
ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

70 
ngx_ušt_t
 
do_wr™e
);

71 
ngx_št_t
 
ngx_h‰p_up¡»am_nÚ_bufã»d_fž‹r_š™
(*
d©a
);

72 
ngx_št_t
 
ngx_h‰p_up¡»am_nÚ_bufã»d_fž‹r
(*
d©a
,

73 
ssize_t
 
by‹s
);

74 
ngx_h‰p_up¡»am_´oûss_down¡»am
(
ngx_h‰p_»que¡_t
 *
r
);

75 
ngx_h‰p_up¡»am_´oûss_up¡»am
(
ngx_h‰p_»que¡_t
 *
r
,

76 
ngx_h‰p_up¡»am_t
 *
u
);

77 
ngx_h‰p_up¡»am_´oûss_»que¡
(
ngx_h‰p_»que¡_t
 *
r
);

78 
ngx_h‰p_up¡»am_¡Üe
(
ngx_h‰p_»que¡_t
 *
r
,

79 
ngx_h‰p_up¡»am_t
 *
u
);

80 
ngx_h‰p_up¡»am_dummy_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

81 
ngx_h‰p_up¡»am_t
 *
u
);

82 
ngx_h‰p_up¡»am_Ãxt
(
ngx_h‰p_»que¡_t
 *
r
,

83 
ngx_h‰p_up¡»am_t
 *
u
, 
ngx_ušt_t
 
á_ty³
);

84 
ngx_h‰p_up¡»am_þ—nup
(*
d©a
);

85 
ngx_h‰p_up¡»am_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

86 
ngx_h‰p_up¡»am_t
 *
u
, 
ngx_št_t
 
rc
);

88 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
,

89 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

90 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_cÚ‹Á_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
,

91 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

92 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
,

93 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

94 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_£t_cook›
(
ngx_h‰p_»que¡_t
 *
r
,

95 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

96 
ngx_št_t


97 
ngx_h‰p_up¡»am_´oûss_ÿche_cÚŒÞ
(
ngx_h‰p_»que¡_t
 *
r
,

98 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

99 
ngx_št_t
 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
,

100 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

101 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_expœes
(
ngx_h‰p_»que¡_t
 *
r
,

102 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

103 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_acûl_expœes
(
ngx_h‰p_»que¡_t
 *
r
,

104 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

105 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_lim™_¿‹
(
ngx_h‰p_»que¡_t
 *
r
,

106 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

107 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_bufãršg
(
ngx_h‰p_»que¡_t
 *
r
,

108 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

109 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
,

110 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

111 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

112 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

113 
ngx_št_t


114 
ngx_h‰p_up¡»am_´oûss_Œªsãr_’codšg
(
ngx_h‰p_»que¡_t
 *
r
,

115 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

116 
ngx_št_t
 
ngx_h‰p_up¡»am_´oûss_v¬y
(
ngx_h‰p_»que¡_t
 *
r
,

117 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

118 
ngx_št_t
 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
,

119 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

120 
ngx_št_t


121 
ngx_h‰p_up¡»am_cÝy_muÉi_h—d”_lšes
(
ngx_h‰p_»que¡_t
 *
r
,

122 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

123 
ngx_št_t
 
ngx_h‰p_up¡»am_cÝy_cÚ‹Á_ty³
(
ngx_h‰p_»que¡_t
 *
r
,

124 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

125 
ngx_št_t
 
ngx_h‰p_up¡»am_cÝy_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
,

126 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

127 
ngx_št_t
 
ngx_h‰p_up¡»am_»wr™e_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

128 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

129 
ngx_št_t
 
ngx_h‰p_up¡»am_»wr™e_»äesh
(
ngx_h‰p_»que¡_t
 *
r
,

130 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

131 
ngx_št_t
 
ngx_h‰p_up¡»am_»wr™e_£t_cook›
(
ngx_h‰p_»que¡_t
 *
r
,

132 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

133 
ngx_št_t
 
ngx_h‰p_up¡»am_cÝy_®low_¿nges
(
ngx_h‰p_»que¡_t
 *
r
,

134 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

136 #ià(
NGX_HTTP_GZIP
)

137 
ngx_št_t
 
ngx_h‰p_up¡»am_cÝy_cÚ‹Á_’codšg
(
ngx_h‰p_»que¡_t
 *
r
,

138 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
);

141 
ngx_št_t
 
ngx_h‰p_up¡»am_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
);

142 
ngx_št_t
 
ngx_h‰p_up¡»am_addr_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

143 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

144 
ngx_št_t
 
ngx_h‰p_up¡»am_¡©us_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

145 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

146 
ngx_št_t
 
ngx_h‰p_up¡»am_»¥Ú£_time_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

147 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

148 
ngx_št_t
 
ngx_h‰p_up¡»am_»¥Ú£_Ëngth_v¬ŸbË
(

149 
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

151 *
ngx_h‰p_up¡»am
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
dummy
);

152 *
ngx_h‰p_up¡»am_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

153 *
cÚf
);

155 
ngx_addr_t
 *
ngx_h‰p_up¡»am_g‘_loÿl
(
ngx_h‰p_»que¡_t
 *
r
,

156 
ngx_h‰p_up¡»am_loÿl_t
 *
loÿl
);

158 *
ngx_h‰p_up¡»am_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

159 *
ngx_h‰p_up¡»am_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
);

161 #ià(
NGX_HTTP_SSL
)

162 
ngx_h‰p_up¡»am_s¦_š™_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *,

163 
ngx_h‰p_up¡»am_t
 *
u
, 
ngx_cÚÃùiÚ_t
 *
c
);

164 
ngx_h‰p_up¡»am_s¦_hªdshake
(
ngx_cÚÃùiÚ_t
 *
c
);

165 
ngx_št_t
 
ngx_h‰p_up¡»am_s¦_Çme
(
ngx_h‰p_»que¡_t
 *
r
,

166 
ngx_h‰p_up¡»am_t
 *
u
, 
ngx_cÚÃùiÚ_t
 *
c
);

170 
ngx_h‰p_up¡»am_h—d”_t
 
	gngx_h‰p_up¡»am_h—d”s_š
[] = {

172 { 
ngx_¡ršg
("Status"),

173 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

174 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
¡©us
),

175 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

177 { 
ngx_¡ršg
("Content-Type"),

178 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

179 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
cÚ‹Á_ty³
),

180 
ngx_h‰p_up¡»am_cÝy_cÚ‹Á_ty³
, 0, 1 },

182 { 
ngx_¡ršg
("Content-Length"),

183 
ngx_h‰p_up¡»am_´oûss_cÚ‹Á_Ëngth
, 0,

184 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
, 0, 0 },

186 { 
ngx_¡ršg
("Date"),

187 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

188 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
d©e
),

189 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
,

190 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
d©e
), 0 },

192 { 
ngx_¡ršg
("Last-Modified"),

193 
ngx_h‰p_up¡»am_´oûss_Ï¡_modif›d
, 0,

194 
ngx_h‰p_up¡»am_cÝy_Ï¡_modif›d
, 0, 0 },

196 { 
ngx_¡ršg
("ETag"),

197 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

198 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
‘ag
),

199 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
,

200 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
‘ag
), 0 },

202 { 
ngx_¡ršg
("Server"),

203 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

204 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
£rv”
),

205 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
,

206 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
£rv”
), 0 },

208 { 
ngx_¡ršg
("WWW-Authenticate"),

209 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

210 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
www_auth’tiÿ‹
),

211 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

213 { 
ngx_¡ršg
("Location"),

214 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

215 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
loÿtiÚ
),

216 
ngx_h‰p_up¡»am_»wr™e_loÿtiÚ
, 0, 0 },

218 { 
ngx_¡ršg
("Refresh"),

219 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
, 0,

220 
ngx_h‰p_up¡»am_»wr™e_»äesh
, 0, 0 },

222 { 
ngx_¡ršg
("Set-Cookie"),

223 
ngx_h‰p_up¡»am_´oûss_£t_cook›
,

224 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
cook›s
),

225 
ngx_h‰p_up¡»am_»wr™e_£t_cook›
, 0, 1 },

227 { 
ngx_¡ršg
("Content-Disposition"),

228 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
, 0,

229 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 1 },

231 { 
ngx_¡ršg
("Cache-Control"),

232 
ngx_h‰p_up¡»am_´oûss_ÿche_cÚŒÞ
, 0,

233 
ngx_h‰p_up¡»am_cÝy_muÉi_h—d”_lšes
,

234 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
ÿche_cÚŒÞ
), 1 },

236 { 
ngx_¡ršg
("Expires"),

237 
ngx_h‰p_up¡»am_´oûss_expœes
, 0,

238 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
,

239 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
expœes
), 1 },

241 { 
ngx_¡ršg
("Accept-Ranges"),

242 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

243 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
acû±_¿nges
),

244 
ngx_h‰p_up¡»am_cÝy_®low_¿nges
,

245 
off£tof
(
ngx_h‰p_h—d”s_out_t
, 
acû±_¿nges
), 1 },

247 { 
ngx_¡ršg
("Connection"),

248 
ngx_h‰p_up¡»am_´oûss_cÚÃùiÚ
, 0,

249 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
, 0, 0 },

251 { 
ngx_¡ršg
("Keep-Alive"),

252 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
, 0,

253 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
, 0, 0 },

255 { 
ngx_¡ršg
("Vary"),

256 
ngx_h‰p_up¡»am_´oûss_v¬y
, 0,

257 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

259 { 
ngx_¡ršg
("X-Powered-By"),

260 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
, 0,

261 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

263 { 
ngx_¡ršg
("X-Accel-Expires"),

264 
ngx_h‰p_up¡»am_´oûss_acûl_expœes
, 0,

265 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

267 { 
ngx_¡ršg
("X-Accel-Redirect"),

268 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

269 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
x_acûl_»dœeù
),

270 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

272 { 
ngx_¡ršg
("X-Accel-Limit-Rate"),

273 
ngx_h‰p_up¡»am_´oûss_lim™_¿‹
, 0,

274 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

276 { 
ngx_¡ršg
("X-Accel-Buffering"),

277 
ngx_h‰p_up¡»am_´oûss_bufãršg
, 0,

278 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

280 { 
ngx_¡ršg
("X-Accel-Charset"),

281 
ngx_h‰p_up¡»am_´oûss_ch¬£t
, 0,

282 
ngx_h‰p_up¡»am_cÝy_h—d”_lše
, 0, 0 },

284 { 
ngx_¡ršg
("Transfer-Encoding"),

285 
ngx_h‰p_up¡»am_´oûss_Œªsãr_’codšg
, 0,

286 
ngx_h‰p_up¡»am_ignÜe_h—d”_lše
, 0, 0 },

288 #ià(
NGX_HTTP_GZIP
)

289 { 
ngx_¡ršg
("Content-Encoding"),

290 
ngx_h‰p_up¡»am_´oûss_h—d”_lše
,

291 
off£tof
(
ngx_h‰p_up¡»am_h—d”s_š_t
, 
cÚ‹Á_’codšg
),

292 
ngx_h‰p_up¡»am_cÝy_cÚ‹Á_’codšg
, 0, 0 },

295 { 
ngx_nuÎ_¡ršg
, 
NULL
, 0, NULL, 0, 0 }

299 
ngx_commªd_t
 
	gngx_h‰p_up¡»am_commªds
[] = {

301 { 
ngx_¡ršg
("upstream"),

302 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_TAKE1
,

303 
ngx_h‰p_up¡»am
,

306 
NULL
 },

308 { 
ngx_¡ršg
("server"),

309 
NGX_HTTP_UPS_CONF
|
NGX_CONF_1MORE
,

310 
ngx_h‰p_up¡»am_£rv”
,

311 
NGX_HTTP_SRV_CONF_OFFSET
,

313 
NULL
 },

315 
ngx_nuÎ_commªd


319 
ngx_h‰p_moduË_t
 
	gngx_h‰p_up¡»am_moduË_ùx
 = {

320 
ngx_h‰p_up¡»am_add_v¬ŸbËs
,

321 
NULL
,

323 
ngx_h‰p_up¡»am_ü—‹_maš_cÚf
,

324 
ngx_h‰p_up¡»am_š™_maš_cÚf
,

326 
NULL
,

327 
NULL
,

329 
NULL
,

330 
NULL


334 
ngx_moduË_t
 
	gngx_h‰p_up¡»am_moduË
 = {

335 
NGX_MODULE_V1
,

336 &
ngx_h‰p_up¡»am_moduË_ùx
,

337 
ngx_h‰p_up¡»am_commªds
,

338 
NGX_HTTP_MODULE
,

339 
NULL
,

340 
NULL
,

341 
NULL
,

342 
NULL
,

343 
NULL
,

344 
NULL
,

345 
NULL
,

346 
NGX_MODULE_V1_PADDING


350 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_up¡»am_v¬s
[] = {

352 { 
ngx_¡ršg
("up¡»am_addr"), 
NULL
,

353 
ngx_h‰p_up¡»am_addr_v¬ŸbË
, 0,

354 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

356 { 
ngx_¡ršg
("up¡»am_¡©us"), 
NULL
,

357 
ngx_h‰p_up¡»am_¡©us_v¬ŸbË
, 0,

358 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

360 { 
ngx_¡ršg
("up¡»am_»¥Ú£_time"), 
NULL
,

361 
ngx_h‰p_up¡»am_»¥Ú£_time_v¬ŸbË
, 0,

362 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

364 { 
ngx_¡ršg
("up¡»am_»¥Ú£_Ëngth"), 
NULL
,

365 
ngx_h‰p_up¡»am_»¥Ú£_Ëngth_v¬ŸbË
, 0,

366 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

368 #ià(
NGX_HTTP_CACHE
)

370 { 
ngx_¡ršg
("up¡»am_ÿche_¡©us"), 
NULL
,

371 
ngx_h‰p_up¡»am_ÿche_¡©us
, 0,

372 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

374 { 
ngx_¡ršg
("up¡»am_ÿche_Ï¡_modif›d"), 
NULL
,

375 
ngx_h‰p_up¡»am_ÿche_Ï¡_modif›d
, 0,

376 
NGX_HTTP_VAR_NOCACHEABLE
|
NGX_HTTP_VAR_NOHASH
, 0 },

378 { 
ngx_¡ršg
("up¡»am_ÿche_‘ag"), 
NULL
,

379 
ngx_h‰p_up¡»am_ÿche_‘ag
, 0,

380 
NGX_HTTP_VAR_NOCACHEABLE
|
NGX_HTTP_VAR_NOHASH
, 0 },

384 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

388 
ngx_h‰p_up¡»am_Ãxt_t
 
	gngx_h‰p_up¡»am_Ãxt_”rÜs
[] = {

389 { 500, 
NGX_HTTP_UPSTREAM_FT_HTTP_500
 },

390 { 502, 
NGX_HTTP_UPSTREAM_FT_HTTP_502
 },

391 { 503, 
NGX_HTTP_UPSTREAM_FT_HTTP_503
 },

392 { 504, 
NGX_HTTP_UPSTREAM_FT_HTTP_504
 },

393 { 403, 
NGX_HTTP_UPSTREAM_FT_HTTP_403
 },

394 { 404, 
NGX_HTTP_UPSTREAM_FT_HTTP_404
 },

399 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_up¡»am_ÿche_m‘hod_mask
[] = {

400 { 
ngx_¡ršg
("GET"), 
NGX_HTTP_GET
},

401 { 
ngx_¡ršg
("HEAD"), 
NGX_HTTP_HEAD
 },

402 { 
ngx_¡ršg
("POST"), 
NGX_HTTP_POST
 },

403 { 
ngx_nuÎ_¡ršg
, 0 }

407 
ngx_cÚf_b™mask_t
 
	gngx_h‰p_up¡»am_ignÜe_h—d”s_masks
[] = {

408 { 
ngx_¡ršg
("X-Acûl-Redœeù"), 
NGX_HTTP_UPSTREAM_IGN_XA_REDIRECT
 },

409 { 
ngx_¡ršg
("X-Acûl-Expœes"), 
NGX_HTTP_UPSTREAM_IGN_XA_EXPIRES
 },

410 { 
ngx_¡ršg
("X-Acûl-Lim™-R©e"), 
NGX_HTTP_UPSTREAM_IGN_XA_LIMIT_RATE
 },

411 { 
ngx_¡ršg
("X-Acûl-Bufãršg"), 
NGX_HTTP_UPSTREAM_IGN_XA_BUFFERING
 },

412 { 
ngx_¡ršg
("X-Acûl-Ch¬£t"), 
NGX_HTTP_UPSTREAM_IGN_XA_CHARSET
 },

413 { 
ngx_¡ršg
("Expœes"), 
NGX_HTTP_UPSTREAM_IGN_EXPIRES
 },

414 { 
ngx_¡ršg
("Cache-CÚŒÞ"), 
NGX_HTTP_UPSTREAM_IGN_CACHE_CONTROL
 },

415 { 
ngx_¡ršg
("S‘-Cook›"), 
NGX_HTTP_UPSTREAM_IGN_SET_COOKIE
 },

416 { 
ngx_¡ršg
("V¬y"), 
NGX_HTTP_UPSTREAM_IGN_VARY
 },

417 { 
ngx_nuÎ_¡ršg
, 0 }

421 
ngx_št_t


422 
	$ngx_h‰p_up¡»am_ü—‹
(
ngx_h‰p_»que¡_t
 *
r
)

424 
ngx_h‰p_up¡»am_t
 *
u
;

426 
u
 = 
r
->
up¡»am
;

428 ià(
u
 && u->
þ—nup
) {

429 
r
->
maš
->
couÁ
++;

430 
	`ngx_h‰p_up¡»am_þ—nup
(
r
);

433 
u
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_t
));

434 ià(
u
 =ð
NULL
) {

435  
NGX_ERROR
;

438 
r
->
up¡»am
 = 
u
;

440 
u
->
³”
.
log
 = 
r
->
cÚÃùiÚ
->log;

441 
u
->
³”
.
log_”rÜ
 = 
NGX_ERROR_ERR
;

442 #ià(
NGX_THREADS
)

443 
u
->
³”
.
lock
 = &
r
->
cÚÃùiÚ
->lock;

446 #ià(
NGX_HTTP_CACHE
)

447 
r
->
ÿche
 = 
NULL
;

450 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = -1;

451 
u
->
h—d”s_š
.
Ï¡_modif›d_time
 = -1;

453  
NGX_OK
;

454 
	}
}

458 
	$ngx_h‰p_up¡»am_š™
(
ngx_h‰p_»que¡_t
 *
r
)

460 
ngx_cÚÃùiÚ_t
 *
c
;

462 
c
 = 
r
->
cÚÃùiÚ
;

464 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

465 "h‰°š™ up¡»am, cl›Áim”: %d", 
c
->
»ad
->
tim”_£t
);

467 #ià(
NGX_HTTP_SPDY
)

468 ià(
r
->
¥dy_¡»am
) {

469 
	`ngx_h‰p_up¡»am_š™_»que¡
(
r
);

474 ià(
c
->
»ad
->
tim”_£t
) {

475 
	`ngx_d–_tim”
(
c
->
»ad
);

478 ià(
ngx_ev’t_æags
 & 
NGX_USE_CLEAR_EVENT
) {

480 ià(!
c
->
wr™e
->
aùive
) {

481 ià(
	`ngx_add_ev’t
(
c
->
wr™e
, 
NGX_WRITE_EVENT
, 
NGX_CLEAR_EVENT
)

482 =ð
NGX_ERROR
)

484 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

490 
	`ngx_h‰p_up¡»am_š™_»que¡
(
r
);

491 
	}
}

495 
	$ngx_h‰p_up¡»am_š™_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

497 
ngx_¡r_t
 *
ho¡
;

498 
ngx_ušt_t
 
i
;

499 
ngx_»sÞv”_ùx_t
 *
ùx
, 
‹mp
;

500 
ngx_h‰p_þ—nup_t
 *
þn
;

501 
ngx_h‰p_up¡»am_t
 *
u
;

502 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

503 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
uscf
, **
uscå
;

504 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

506 ià(
r
->
aio
) {

510 
u
 = 
r
->
up¡»am
;

512 #ià(
NGX_HTTP_CACHE
)

514 ià(
u
->
cÚf
->
ÿche
) {

515 
ngx_št_t
 
rc
;

517 
rc
 = 
	`ngx_h‰p_up¡»am_ÿche
(
r
, 
u
);

519 ià(
rc
 =ð
NGX_BUSY
) {

520 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_š™_»que¡
;

524 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_»que¡_em±y_hªdËr
;

526 ià(
rc
 =ð
NGX_DONE
) {

530 ià(
rc
 =ð
NGX_ERROR
) {

531 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

535 ià(
rc
 !ð
NGX_DECLINED
) {

536 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

543 
u
->
¡Üe
 = (u->
cÚf
->¡Ü|| u->cÚf->
¡Üe_Ëngths
);

545 ià(!
u
->
¡Üe
 && !
r
->
po¡_aùiÚ
 && !u->
cÚf
->
ignÜe_þ›Á_abÜt
) {

546 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_rd_check_brok’_cÚÃùiÚ
;

547 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_wr_check_brok’_cÚÃùiÚ
;

550 ià(
r
->
»que¡_body
) {

551 
u
->
»que¡_bufs
 = 
r
->
»que¡_body
->
bufs
;

554 ià(
u
->
	`ü—‹_»que¡
(
r
è!ð
NGX_OK
) {

555 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

559 
u
->
³”
.
loÿl
 = 
	`ngx_h‰p_up¡»am_g‘_loÿl
(
r
, u->
cÚf
->local);

561 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

563 
u
->
ouut
.
®ignm’t
 = 
þcf
->
dœeùio_®ignm’t
;

564 
u
->
ouut
.
poÞ
 = 
r
->pool;

565 
u
->
ouut
.
bufs
.
num
 = 1;

566 
u
->
ouut
.
bufs
.
size
 = 
þcf
->
þ›Á_body_bufãr_size
;

567 
u
->
ouut
.
ouut_fž‹r
 = 
ngx_chaš_wr™”
;

568 
u
->
ouut
.
fž‹r_ùx
 = &u->
wr™”
;

570 
u
->
wr™”
.
poÞ
 = 
r
->pool;

572 ià(
r
->
up¡»am_¡©es
 =ð
NULL
) {

574 
r
->
up¡»am_¡©es
 = 
	`ngx_¬¿y_ü—‹
Ô->
poÞ
, 1,

575 (
ngx_h‰p_up¡»am_¡©e_t
));

576 ià(
r
->
up¡»am_¡©es
 =ð
NULL
) {

577 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

583 
u
->
¡©e
 = 
	`ngx_¬¿y_push
(
r
->
up¡»am_¡©es
);

584 ià(
u
->
¡©e
 =ð
NULL
) {

585 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

586 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

590 
	`ngx_memz”o
(
u
->
¡©e
, (
ngx_h‰p_up¡»am_¡©e_t
));

593 
þn
 = 
	`ngx_h‰p_þ—nup_add
(
r
, 0);

594 ià(
þn
 =ð
NULL
) {

595 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

599 
þn
->
hªdËr
 = 
ngx_h‰p_up¡»am_þ—nup
;

600 
þn
->
d©a
 = 
r
;

601 
u
->
þ—nup
 = &
þn
->
hªdËr
;

603 ià(
u
->
»sÞved
 =ð
NULL
) {

605 
uscf
 = 
u
->
cÚf
->
up¡»am
;

609 #ià(
NGX_HTTP_SSL
)

610 
u
->
s¦_Çme
 = u->
»sÞved
->
ho¡
;

613 ià(
u
->
»sÞved
->
sockaddr
) {

615 ià(
	`ngx_h‰p_up¡»am_ü—‹_round_robš_³”
(
r
, 
u
->
»sÞved
)

616 !ð
NGX_OK
)

618 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

619 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

623 
	`ngx_h‰p_up¡»am_cÚÃù
(
r
, 
u
);

628 
ho¡
 = &
u
->
»sÞved
->host;

630 
umcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_up¡»am_moduË
);

632 
uscå
 = 
umcf
->
up¡»ams
.
–ts
;

634 
i
 = 0; i < 
umcf
->
up¡»ams
.
ÃÉs
; i++) {

636 
uscf
 = 
uscå
[
i
];

638 ià(
uscf
->
ho¡
.
Ën
 == host->len

639 && ((
uscf
->
pÜt
 =ð0 && 
u
->
»sÞved
->
no_pÜt
)

640 || 
uscf
->
pÜt
 =ð
u
->
»sÞved
->port)

641 && 
	`ngx_¡ºÿ£cmp
(
uscf
->
ho¡
.
d©a
, ho¡->d©a, ho¡->
Ën
) == 0)

643 
found
;

647 ià(
u
->
»sÞved
->
pÜt
 == 0) {

648 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

649 "nØpÜˆš up¡»am \"%V\"", 
ho¡
);

650 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

651 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

655 
‹mp
.
Çme
 = *
ho¡
;

657 
ùx
 = 
	`ngx_»sÞve_¡¬t
(
þcf
->
»sÞv”
, &
‹mp
);

658 ià(
ùx
 =ð
NULL
) {

659 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

660 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

664 ià(
ùx
 =ð
NGX_NO_RESOLVER
) {

665 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

666 "nØ»sÞv” defšedØ»sÞv%V", 
ho¡
);

668 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_BAD_GATEWAY
);

672 
ùx
->
Çme
 = *
ho¡
;

673 
ùx
->
hªdËr
 = 
ngx_h‰p_up¡»am_»sÞve_hªdËr
;

674 
ùx
->
d©a
 = 
r
;

675 
ùx
->
timeout
 = 
þcf
->
»sÞv”_timeout
;

677 
u
->
»sÞved
->
ùx
 = ctx;

679 ià(
	`ngx_»sÞve_Çme
(
ùx
è!ð
NGX_OK
) {

680 
u
->
»sÞved
->
ùx
 = 
NULL
;

681 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

682 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

689 
found
:

691 ià(
uscf
 =ð
NULL
) {

692 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

694 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

695 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

699 #ià(
NGX_HTTP_SSL
)

700 
u
->
s¦_Çme
 = 
uscf
->
ho¡
;

703 ià(
uscf
->
³”
.
	`š™
(
r
, uscfè!ð
NGX_OK
) {

704 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

705 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

709 
u
->
³”
.
¡¬t_time
 = 
ngx_cu¼’t_m£c
;

711 ià(
u
->
cÚf
->
Ãxt_up¡»am_Œ›s


712 && 
u
->
³”
.
Œ›s
 > u->
cÚf
->
Ãxt_up¡»am_Œ›s
)

714 
u
->
³”
.
Œ›s
 = u->
cÚf
->
Ãxt_up¡»am_Œ›s
;

717 
	`ngx_h‰p_up¡»am_cÚÃù
(
r
, 
u
);

718 
	}
}

721 #ià(
NGX_HTTP_CACHE
)

723 
ngx_št_t


724 
	$ngx_h‰p_up¡»am_ÿche
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

726 
ngx_št_t
 
rc
;

727 
ngx_h‰p_ÿche_t
 *
c
;

729 
c
 = 
r
->
ÿche
;

731 ià(
c
 =ð
NULL
) {

733 ià(!(
r
->
m‘hod
 & 
u
->
cÚf
->
ÿche_m‘hods
)) {

734  
NGX_DECLINED
;

737 ià(
r
->
m‘hod
 & 
NGX_HTTP_HEAD
) {

738 
u
->
m‘hod
 = 
ngx_h‰p_cÜe_g‘_m‘hod
;

741 ià(
	`ngx_h‰p_fže_ÿche_Ãw
(
r
è!ð
NGX_OK
) {

742  
NGX_ERROR
;

745 ià(
u
->
	`ü—‹_key
(
r
è!ð
NGX_OK
) {

746  
NGX_ERROR
;

751 
	`ngx_h‰p_fže_ÿche_ü—‹_key
(
r
);

753 ià(
r
->
ÿche
->
h—d”_¡¬t
 + 256 >ð
u
->
cÚf
->
bufãr_size
) {

754 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

757 &
u
->
cÚf
->
moduË
, u->cÚf->
bufãr_size
,

758 
	`ngx_®ign
(
r
->
ÿche
->
h—d”_¡¬t
 + 256, 1024));

760 
r
->
ÿche
 = 
NULL
;

761  
NGX_DECLINED
;

764 
u
->
ÿch—bË
 = 1;

766 
	`ngx_h‰p_‹¡_´ediÿ‹s
(
r
, 
u
->
cÚf
->
ÿche_by·ss
)) {

768 
NGX_ERROR
:

769  
NGX_ERROR
;

771 
NGX_DECLINED
:

772 
u
->
ÿche_¡©us
 = 
NGX_HTTP_CACHE_BYPASS
;

773  
NGX_DECLINED
;

779 
c
 = 
r
->
ÿche
;

781 
c
->
mš_u£s
 = 
u
->
cÚf
->
ÿche_mš_u£s
;

782 
c
->
body_¡¬t
 = 
u
->
cÚf
->
bufãr_size
;

783 
c
->
fže_ÿche
 = 
u
->
cÚf
->
ÿche
->
d©a
;

785 
c
->
lock
 = 
u
->
cÚf
->
ÿche_lock
;

786 
c
->
lock_timeout
 = 
u
->
cÚf
->
ÿche_lock_timeout
;

787 
c
->
lock_age
 = 
u
->
cÚf
->
ÿche_lock_age
;

789 
u
->
ÿche_¡©us
 = 
NGX_HTTP_CACHE_MISS
;

792 
rc
 = 
	`ngx_h‰p_fže_ÿche_Ý’
(
r
);

794 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

795 "h‰°up¡»am cache: %i", 
rc
);

797 
rc
) {

799 
NGX_HTTP_CACHE_UPDATING
:

801 ià(
u
->
cÚf
->
ÿche_u£_¡®e
 & 
NGX_HTTP_UPSTREAM_FT_UPDATING
) {

802 
u
->
ÿche_¡©us
 = 
rc
;

803 
rc
 = 
NGX_OK
;

806 
rc
 = 
NGX_HTTP_CACHE_STALE
;

811 
NGX_OK
:

812 
u
->
ÿche_¡©us
 = 
NGX_HTTP_CACHE_HIT
;

815 
rc
) {

817 
NGX_OK
:

819 
rc
 = 
	`ngx_h‰p_up¡»am_ÿche_£nd
(
r
, 
u
);

821 ià(
rc
 !ð
NGX_HTTP_UPSTREAM_INVALID_HEADER
) {

822  
rc
;

827 
NGX_HTTP_CACHE_STALE
:

829 
c
->
v®id_£c
 = 0;

830 
u
->
bufãr
.
¡¬t
 = 
NULL
;

831 
u
->
ÿche_¡©us
 = 
NGX_HTTP_CACHE_EXPIRED
;

835 
NGX_DECLINED
:

837 ià((
size_t
è(
u
->
bufãr
.
’d
 - u->bufãr.
¡¬t
è< u->
cÚf
->
bufãr_size
) {

838 
u
->
bufãr
.
¡¬t
 = 
NULL
;

841 
u
->
bufãr
.
pos
 = u->bufãr.
¡¬t
 + 
c
->
h—d”_¡¬t
;

842 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
;

847 
NGX_HTTP_CACHE_SCARCE
:

849 
u
->
ÿch—bË
 = 0;

853 
NGX_AGAIN
:

855  
NGX_BUSY
;

857 
NGX_ERROR
:

859  
NGX_ERROR
;

865 
u
->
ÿche_¡©us
 = 
NGX_HTTP_CACHE_HIT
;

867  
rc
;

870 
r
->
ÿched
 = 0;

872  
NGX_DECLINED
;

873 
	}
}

876 
ngx_št_t


877 
	$ngx_h‰p_up¡»am_ÿche_£nd
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

879 
ngx_št_t
 
rc
;

880 
ngx_h‰p_ÿche_t
 *
c
;

882 
r
->
ÿched
 = 1;

883 
c
 = 
r
->
ÿche
;

885 ià(
c
->
h—d”_¡¬t
 =ðc->
body_¡¬t
) {

886 
r
->
h‰p_v”siÚ
 = 
NGX_HTTP_VERSION_9
;

887  
	`ngx_h‰p_ÿche_£nd
(
r
);

892 
u
->
bufãr
 = *
c
->
buf
;

893 
u
->
bufãr
.
pos
 +ð
c
->
h—d”_¡¬t
;

895 
	`ngx_memz”o
(&
u
->
h—d”s_š
, (
ngx_h‰p_up¡»am_h—d”s_š_t
));

896 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = -1;

897 
u
->
h—d”s_š
.
Ï¡_modif›d_time
 = -1;

899 ià(
	`ngx_li¡_š™
(&
u
->
h—d”s_š
.
h—d”s
, 
r
->
poÞ
, 8,

900 (
ngx_bË_–t_t
))

901 !ð
NGX_OK
)

903  
NGX_ERROR
;

906 
rc
 = 
u
->
	`´oûss_h—d”
(
r
);

908 ià(
rc
 =ð
NGX_OK
) {

910 ià(
	`ngx_h‰p_up¡»am_´oûss_h—d”s
(
r
, 
u
è!ð
NGX_OK
) {

911  
NGX_DONE
;

914  
	`ngx_h‰p_ÿche_£nd
(
r
);

917 ià(
rc
 =ð
NGX_ERROR
) {

918  
NGX_ERROR
;

925  
rc
;

926 
	}
}

932 
	$ngx_h‰p_up¡»am_»sÞve_hªdËr
(
ngx_»sÞv”_ùx_t
 *
ùx
)

934 
ngx_cÚÃùiÚ_t
 *
c
;

935 
ngx_h‰p_»que¡_t
 *
r
;

936 
ngx_h‰p_up¡»am_t
 *
u
;

937 
ngx_h‰p_up¡»am_»sÞved_t
 *
ur
;

939 
r
 = 
ùx
->
d©a
;

940 
c
 = 
r
->
cÚÃùiÚ
;

942 
u
 = 
r
->
up¡»am
;

943 
ur
 = 
u
->
»sÞved
;

945 
	`ngx_h‰p_£t_log_»que¡
(
c
->
log
, 
r
);

947 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

948 "h‰°up¡»am„esÞve: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

950 ià(
ùx
->
¡©e
) {

951 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

953 &
ùx
->
Çme
, ctx->
¡©e
,

954 
	`ngx_»sÞv”_¡»¼Ü
(
ùx
->
¡©e
));

956 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_BAD_GATEWAY
);

957 
çžed
;

960 
ur
->
Çddrs
 = 
ùx
->naddrs;

961 
ur
->
addrs
 = 
ùx
->addrs;

963 #ià(
NGX_DEBUG
)

965 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

966 
ngx_¡r_t
 
addr
;

967 
ngx_ušt_t
 
i
;

969 
addr
.
d©a
 = 
‹xt
;

971 
i
 = 0; i < 
ùx
->
Çddrs
; i++) {

972 
addr
.
Ën
 = 
	`ngx_sock_ÁÝ
(
ur
->
addrs
[
i
].
sockaddr
, ur->addrs[i].
sockËn
,

973 
‹xt
, 
NGX_SOCKADDR_STRLEN
, 0);

975 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

976 "Çmwa »sÞvedØ%V", &
addr
);

981 ià(
	`ngx_h‰p_up¡»am_ü—‹_round_robš_³”
(
r
, 
ur
è!ð
NGX_OK
) {

982 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

983 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

984 
çžed
;

987 
	`ngx_»sÞve_Çme_dÚe
(
ùx
);

988 
ur
->
ùx
 = 
NULL
;

990 
u
->
³”
.
¡¬t_time
 = 
ngx_cu¼’t_m£c
;

992 ià(
u
->
cÚf
->
Ãxt_up¡»am_Œ›s


993 && 
u
->
³”
.
Œ›s
 > u->
cÚf
->
Ãxt_up¡»am_Œ›s
)

995 
u
->
³”
.
Œ›s
 = u->
cÚf
->
Ãxt_up¡»am_Œ›s
;

998 
	`ngx_h‰p_up¡»am_cÚÃù
(
r
, 
u
);

1000 
çžed
:

1002 
	`ngx_h‰p_run_po¡ed_»que¡s
(
c
);

1003 
	}
}

1007 
	$ngx_h‰p_up¡»am_hªdËr
(
ngx_ev’t_t
 *
ev
)

1009 
ngx_cÚÃùiÚ_t
 *
c
;

1010 
ngx_h‰p_»que¡_t
 *
r
;

1011 
ngx_h‰p_up¡»am_t
 *
u
;

1013 
c
 = 
ev
->
d©a
;

1014 
r
 = 
c
->
d©a
;

1016 
u
 = 
r
->
up¡»am
;

1017 
c
 = 
r
->
cÚÃùiÚ
;

1019 
	`ngx_h‰p_£t_log_»que¡
(
c
->
log
, 
r
);

1021 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

1022 "h‰°up¡»am„eque¡: \"%V?%V\"", &
r
->
uri
, &r->
¬gs
);

1024 ià(
ev
->
wr™e
) {

1025 
u
->
	`wr™e_ev’t_hªdËr
(
r
, u);

1028 
u
->
	`»ad_ev’t_hªdËr
(
r
, u);

1031 
	`ngx_h‰p_run_po¡ed_»que¡s
(
c
);

1032 
	}
}

1036 
	$ngx_h‰p_up¡»am_rd_check_brok’_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
)

1038 
	`ngx_h‰p_up¡»am_check_brok’_cÚÃùiÚ
(
r
,„->
cÚÃùiÚ
->
»ad
);

1039 
	}
}

1043 
	$ngx_h‰p_up¡»am_wr_check_brok’_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
)

1045 
	`ngx_h‰p_up¡»am_check_brok’_cÚÃùiÚ
(
r
,„->
cÚÃùiÚ
->
wr™e
);

1046 
	}
}

1050 
	$ngx_h‰p_up¡»am_check_brok’_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

1051 
ngx_ev’t_t
 *
ev
)

1053 
n
;

1054 
buf
[1];

1055 
ngx_”r_t
 
”r
;

1056 
ngx_št_t
 
ev’t
;

1057 
ngx_cÚÃùiÚ_t
 *
c
;

1058 
ngx_h‰p_up¡»am_t
 *
u
;

1060 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
ev
->
log
, 0,

1062 
ev
->
wr™e
, &
r
->
uri
);

1064 
c
 = 
r
->
cÚÃùiÚ
;

1065 
u
 = 
r
->
up¡»am
;

1067 ià(
c
->
”rÜ
) {

1068 ià((
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT
è&& 
ev
->
aùive
) {

1070 
ev’t
 = 
ev
->
wr™e
 ? 
NGX_WRITE_EVENT
 : 
NGX_READ_EVENT
;

1072 ià(
	`ngx_d–_ev’t
(
ev
, 
ev’t
, 0è!ð
NGX_OK
) {

1073 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1074 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1079 ià(!
u
->
ÿch—bË
) {

1080 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1081 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

1087 #ià(
NGX_HTTP_SPDY
)

1088 ià(
r
->
¥dy_¡»am
) {

1093 #ià(
NGX_HAVE_KQUEUE
)

1095 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

1097 ià(!
ev
->
³ndšg_eof
) {

1101 
ev
->
eof
 = 1;

1102 
c
->
”rÜ
 = 1;

1104 ià(
ev
->
kq_”ºo
) {

1105 
ev
->
”rÜ
 = 1;

1108 ià(!
u
->
ÿch—bË
 && u->
³”
.
cÚÃùiÚ
) {

1109 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
ev
->
log
,ƒv->
kq_”ºo
,

1112 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1113 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

1117 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
ev
->
log
,ƒv->
kq_”ºo
,

1121 ià(
u
->
³”
.
cÚÃùiÚ
 =ð
NULL
) {

1122 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1123 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

1131 #ià(
NGX_HAVE_EPOLLRDHUP
)

1133 ià((
ngx_ev’t_æags
 & 
NGX_USE_EPOLL_EVENT
è&& 
ev
->
³ndšg_eof
) {

1134 
sockËn_t
 
Ën
;

1136 
ev
->
eof
 = 1;

1137 
c
->
”rÜ
 = 1;

1139 
”r
 = 0;

1140 
Ën
 = (
ngx_”r_t
);

1147 ià(
	`g‘sockÝt
(
c
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, (*è&
”r
, &
Ën
)

1150 
”r
 = 
ngx_sock‘_”ºo
;

1153 ià(
”r
) {

1154 
ev
->
”rÜ
 = 1;

1157 ià(!
u
->
ÿch—bË
 && u->
³”
.
cÚÃùiÚ
) {

1158 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
ev
->
log
, 
”r
,

1161 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1162 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

1166 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
ev
->
log
, 
”r
,

1170 ià(
u
->
³”
.
cÚÃùiÚ
 =ð
NULL
) {

1171 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1172 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

1180 
n
 = 
	`»cv
(
c
->
fd
, 
buf
, 1, 
MSG_PEEK
);

1182 
”r
 = 
ngx_sock‘_”ºo
;

1184 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
ev
->
log
, 
”r
,

1185 "h‰°up¡»am„ecv(): %d", 
n
);

1187 ià(
ev
->
wr™e
 && (
n
 >ð0 || 
”r
 =ð
NGX_EAGAIN
)) {

1191 ià((
ngx_ev’t_æags
 & 
NGX_USE_LEVEL_EVENT
è&& 
ev
->
aùive
) {

1193 
ev’t
 = 
ev
->
wr™e
 ? 
NGX_WRITE_EVENT
 : 
NGX_READ_EVENT
;

1195 ià(
	`ngx_d–_ev’t
(
ev
, 
ev’t
, 0è!ð
NGX_OK
) {

1196 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1197 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1202 ià(
n
 > 0) {

1206 ià(
n
 == -1) {

1207 ià(
”r
 =ð
NGX_EAGAIN
) {

1211 
ev
->
”rÜ
 = 1;

1214 
”r
 = 0;

1217 
ev
->
eof
 = 1;

1218 
c
->
”rÜ
 = 1;

1220 ià(!
u
->
ÿch—bË
 && u->
³”
.
cÚÃùiÚ
) {

1221 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
ev
->
log
, 
”r
,

1224 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1225 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

1229 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
ev
->
log
, 
”r
,

1232 ià(
u
->
³”
.
cÚÃùiÚ
 =ð
NULL
) {

1233 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1234 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

1236 
	}
}

1240 
	$ngx_h‰p_up¡»am_cÚÃù
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

1242 
ngx_št_t
 
rc
;

1243 
ngx_time_t
 *

;

1244 
ngx_cÚÃùiÚ_t
 *
c
;

1246 
r
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "connectingo upstream";

1248 ià(
u
->
¡©e
 && u->¡©e->
»¥Ú£_£c
) {

1249 

 = 
	`ngx_timeofday
();

1250 
u
->
¡©e
->
»¥Ú£_£c
 = 

->
£c
 - u->state->response_sec;

1251 
u
->
¡©e
->
»¥Ú£_m£c
 = 

->
m£c
 - u->state->response_msec;

1254 
u
->
¡©e
 = 
	`ngx_¬¿y_push
(
r
->
up¡»am_¡©es
);

1255 ià(
u
->
¡©e
 =ð
NULL
) {

1256 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1257 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1261 
	`ngx_memz”o
(
u
->
¡©e
, (
ngx_h‰p_up¡»am_¡©e_t
));

1263 

 = 
	`ngx_timeofday
();

1264 
u
->
¡©e
->
»¥Ú£_£c
 = 

->
£c
;

1265 
u
->
¡©e
->
»¥Ú£_m£c
 = 

->
m£c
;

1267 
rc
 = 
	`ngx_ev’t_cÚÃù_³”
(&
u
->
³”
);

1269 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1270 "h‰°up¡»am cÚÃù: %i", 
rc
);

1272 ià(
rc
 =ð
NGX_ERROR
) {

1273 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1274 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1278 
u
->
¡©e
->
³”
 = u->³”.
Çme
;

1280 ià(
rc
 =ð
NGX_BUSY
) {

1281 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0, "no†ive upstreams");

1282 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_NOLIVE
);

1286 ià(
rc
 =ð
NGX_DECLINED
) {

1287 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_ERROR
);

1293 
c
 = 
u
->
³”
.
cÚÃùiÚ
;

1295 
c
->
d©a
 = 
r
;

1297 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_up¡»am_hªdËr
;

1298 
c
->
»ad
->
hªdËr
 = 
ngx_h‰p_up¡»am_hªdËr
;

1300 
u
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_£nd_»que¡_hªdËr
;

1301 
u
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_´oûss_h—d”
;

1303 
c
->
£ndfže
 &ð
r
->
cÚÃùiÚ
->sendfile;

1304 
u
->
ouut
.
£ndfže
 = 
c
->sendfile;

1306 ià(
c
->
poÞ
 =ð
NULL
) {

1310 
c
->
poÞ
 = 
	`ngx_ü—‹_poÞ
(128, 
r
->
cÚÃùiÚ
->
log
);

1311 ià(
c
->
poÞ
 =ð
NULL
) {

1312 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1313 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1318 
c
->
log
 = 
r
->
cÚÃùiÚ
->log;

1319 
c
->
poÞ
->
log
 = c->log;

1320 
c
->
»ad
->
log
 = c->log;

1321 
c
->
wr™e
->
log
 = c->log;

1325 
u
->
wr™”
.
out
 = 
NULL
;

1326 
u
->
wr™”
.
Ï¡
 = &u->wr™”.
out
;

1327 
u
->
wr™”
.
cÚÃùiÚ
 = 
c
;

1328 
u
->
wr™”
.
lim™
 = 0;

1330 ià(
u
->
»que¡_£Á
) {

1331 ià(
	`ngx_h‰p_up¡»am_»š™
(
r
, 
u
è!ð
NGX_OK
) {

1332 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1333 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1338 ià(
r
->
»que¡_body


1339 && 
r
->
»que¡_body
->
buf


1340 && 
r
->
»que¡_body
->
‹mp_fže


1341 && 
r
 =ðr->
maš
)

1348 
u
->
ouut
.
ä“
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

1349 ià(
u
->
ouut
.
ä“
 =ð
NULL
) {

1350 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1351 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1355 
u
->
ouut
.
ä“
->
buf
 = 
r
->
»que¡_body
->buf;

1356 
u
->
ouut
.
ä“
->
Ãxt
 = 
NULL
;

1357 
u
->
ouut
.
®loÿ‹d
 = 1;

1359 
r
->
»que¡_body
->
buf
->
pos
 =„->»que¡_body->buf->
¡¬t
;

1360 
r
->
»que¡_body
->
buf
->
Ï¡
 =„->»que¡_body->buf->
¡¬t
;

1361 
r
->
»que¡_body
->
buf
->
g
 = 
u
->
ouut
.tag;

1364 
u
->
»que¡_£Á
 = 0;

1366 ià(
rc
 =ð
NGX_AGAIN
) {

1367 
	`ngx_add_tim”
(
c
->
wr™e
, 
u
->
cÚf
->
cÚÃù_timeout
);

1371 #ià(
NGX_HTTP_SSL
)

1373 ià(
u
->
s¦
 && 
c
->s¦ =ð
NULL
) {

1374 
	`ngx_h‰p_up¡»am_s¦_š™_cÚÃùiÚ
(
r
, 
u
, 
c
);

1380 
	`ngx_h‰p_up¡»am_£nd_»que¡
(
r
, 
u
);

1381 
	}
}

1384 #ià(
NGX_HTTP_SSL
)

1387 
	$ngx_h‰p_up¡»am_s¦_š™_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

1388 
ngx_h‰p_up¡»am_t
 *
u
, 
ngx_cÚÃùiÚ_t
 *
c
)

1390 
ngx_št_t
 
rc
;

1392 ià(
	`ngx_h‰p_up¡»am_‹¡_cÚÃù
(
c
è!ð
NGX_OK
) {

1393 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_ERROR
);

1397 ià(
	`ngx_s¦_ü—‹_cÚÃùiÚ
(
u
->
cÚf
->
s¦
, 
c
,

1398 
NGX_SSL_BUFFER
|
NGX_SSL_CLIENT
)

1399 !ð
NGX_OK
)

1401 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1402 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1406 
c
->
£ndfže
 = 0;

1407 
u
->
ouut
.
£ndfže
 = 0;

1409 ià(
u
->
cÚf
->
s¦_£rv”_Çme
 || u->cÚf->
s¦_v”ify
) {

1410 ià(
	`ngx_h‰p_up¡»am_s¦_Çme
(
r
, 
u
, 
c
è!ð
NGX_OK
) {

1411 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1412 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1417 ià(
u
->
cÚf
->
s¦_£ssiÚ_»u£
) {

1418 ià(
u
->
³”
.
	`£t_£ssiÚ
(&u->³”, u->³”.
d©a
è!ð
NGX_OK
) {

1419 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1420 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1425 
r
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "SSL handshakingo upstream";

1427 
rc
 = 
	`ngx_s¦_hªdshake
(
c
);

1429 ià(
rc
 =ð
NGX_AGAIN
) {

1431 ià(!
c
->
wr™e
->
tim”_£t
) {

1432 
	`ngx_add_tim”
(
c
->
wr™e
, 
u
->
cÚf
->
cÚÃù_timeout
);

1435 
c
->
s¦
->
hªdËr
 = 
ngx_h‰p_up¡»am_s¦_hªdshake
;

1439 
	`ngx_h‰p_up¡»am_s¦_hªdshake
(
c
);

1440 
	}
}

1444 
	$ngx_h‰p_up¡»am_s¦_hªdshake
(
ngx_cÚÃùiÚ_t
 *
c
)

1446 
rc
;

1447 
ngx_h‰p_»que¡_t
 *
r
;

1448 
ngx_h‰p_up¡»am_t
 *
u
;

1450 
r
 = 
c
->
d©a
;

1451 
u
 = 
r
->
up¡»am
;

1453 
	`ngx_h‰p_£t_log_»que¡
(
c
->
log
, 
r
);

1455 ià(
c
->
s¦
->
hªdshaked
) {

1457 ià(
u
->
cÚf
->
s¦_v”ify
) {

1458 
rc
 = 
	`SSL_g‘_v”ify_»suÉ
(
c
->
s¦
->
cÚÃùiÚ
);

1460 ià(
rc
 !ð
X509_V_OK
) {

1461 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

1463 
rc
, 
	`X509_v”ify_û¹_”rÜ_¡ršg
(rc));

1464 
çžed
;

1467 ià(
	`ngx_s¦_check_ho¡
(
c
, &
u
->
s¦_Çme
è!ð
NGX_OK
) {

1468 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

1470 &
u
->
s¦_Çme
);

1471 
çžed
;

1475 ià(
u
->
cÚf
->
s¦_£ssiÚ_»u£
) {

1476 
u
->
³”
.
	`§ve_£ssiÚ
(&u->³”, u->³”.
d©a
);

1479 
c
->
wr™e
->
hªdËr
 = 
ngx_h‰p_up¡»am_hªdËr
;

1480 
c
->
»ad
->
hªdËr
 = 
ngx_h‰p_up¡»am_hªdËr
;

1482 
c
 = 
r
->
cÚÃùiÚ
;

1484 
	`ngx_h‰p_up¡»am_£nd_»que¡
(
r
, 
u
);

1486 
	`ngx_h‰p_run_po¡ed_»que¡s
(
c
);

1490 
çžed
:

1492 
c
 = 
r
->
cÚÃùiÚ
;

1494 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_ERROR
);

1496 
	`ngx_h‰p_run_po¡ed_»que¡s
(
c
);

1497 
	}
}

1500 
ngx_št_t


1501 
	$ngx_h‰p_up¡»am_s¦_Çme
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
,

1502 
ngx_cÚÃùiÚ_t
 *
c
)

1504 
u_ch¬
 *
p
, *
Ï¡
;

1505 
ngx_¡r_t
 
Çme
;

1507 ià(
u
->
cÚf
->
s¦_Çme
) {

1508 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
u
->
cÚf
->
s¦_Çme
, &
Çme
è!ð
NGX_OK
) {

1509  
NGX_ERROR
;

1513 
Çme
 = 
u
->
s¦_Çme
;

1516 ià(
Çme
.
Ën
 == 0) {

1517 
dÚe
;

1525 
p
 = 
Çme
.
d©a
;

1526 
Ï¡
 = 
Çme
.
d©a
 +‚ame.
Ën
;

1528 ià(*
p
 == '[') {

1529 
p
 = 
	`ngx_¡¾chr
Õ, 
Ï¡
, ']');

1531 ià(
p
 =ð
NULL
) {

1532 
p
 = 
Çme
.
d©a
;

1536 
p
 = 
	`ngx_¡¾chr
Õ, 
Ï¡
, ':');

1538 ià(
p
 !ð
NULL
) {

1539 
Çme
.
Ën
 = 
p
 -‚ame.
d©a
;

1542 ià(!
u
->
cÚf
->
s¦_£rv”_Çme
) {

1543 
dÚe
;

1546 #ifdeà
SSL_CTRL_SET_TLSEXT_HOSTNAME


1550 ià(
Çme
.
Ën
 =ð0 || *Çme.
d©a
 == '[') {

1551 
dÚe
;

1554 ià(
	`ngx_š‘_addr
(
Çme
.
d©a
,‚ame.
Ën
è!ð
INADDR_NONE
) {

1555 
dÚe
;

1563 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Çme
.
Ën
 + 1);

1564 ià(
p
 =ð
NULL
) {

1565  
NGX_ERROR
;

1568 (è
	`ngx_ýy¡º
(
p
, 
Çme
.
d©a
,‚ame.
Ën
 + 1);

1570 
Çme
.
d©a
 = 
p
;

1572 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1573 "up¡»am SSL s”v”‚ame: \"%s\"", 
Çme
.
d©a
);

1575 ià(
	`SSL_£t_Ž£xt_ho¡_Çme
(
c
->
s¦
->
cÚÃùiÚ
, 
Çme
.
d©a
) == 0) {

1576 
	`ngx_s¦_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

1577 "SSL_£t_Ž£xt_ho¡_Çme(\"%s\"èçžed", 
Çme
.
d©a
);

1578  
NGX_ERROR
;

1583 
dÚe
:

1585 
u
->
s¦_Çme
 = 
Çme
;

1587  
NGX_OK
;

1588 
	}
}

1593 
ngx_št_t


1594 
	$ngx_h‰p_up¡»am_»š™
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

1596 
off_t
 
fže_pos
;

1597 
ngx_chaš_t
 *
þ
;

1599 ià(
u
->
	`»š™_»que¡
(
r
è!ð
NGX_OK
) {

1600  
NGX_ERROR
;

1603 
u
->
k“·live
 = 0;

1604 
u
->
upg¿de
 = 0;

1606 
	`ngx_memz”o
(&
u
->
h—d”s_š
, (
ngx_h‰p_up¡»am_h—d”s_š_t
));

1607 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = -1;

1608 
u
->
h—d”s_š
.
Ï¡_modif›d_time
 = -1;

1610 ià(
	`ngx_li¡_š™
(&
u
->
h—d”s_š
.
h—d”s
, 
r
->
poÞ
, 8,

1611 (
ngx_bË_–t_t
))

1612 !ð
NGX_OK
)

1614  
NGX_ERROR
;

1619 
fže_pos
 = 0;

1621 
þ
 = 
u
->
»que¡_bufs
; cl; cÈðþ->
Ãxt
) {

1622 
þ
->
buf
->
pos
 = cl->buf->
¡¬t
;

1626 ià(
þ
->
buf
->
š_fže
) {

1627 
þ
->
buf
->
fže_pos
 = file_pos;

1628 
fže_pos
 = 
þ
->
buf
->
fže_Ï¡
;

1634 ià(
r
->
»que¡_body
 &&„->»que¡_body->
‹mp_fže


1635 && 
r
 !ðr->
maš
 && 
u
->
ouut
.
buf
)

1637 
u
->
ouut
.
ä“
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

1638 ià(
u
->
ouut
.
ä“
 =ð
NULL
) {

1639  
NGX_ERROR
;

1642 
u
->
ouut
.
ä“
->
buf
 = u->output.buf;

1643 
u
->
ouut
.
ä“
->
Ãxt
 = 
NULL
;

1645 
u
->
ouut
.
buf
->
pos
 = u->ouut.buf->
¡¬t
;

1646 
u
->
ouut
.
buf
->
Ï¡
 = u->ouut.buf->
¡¬t
;

1649 
u
->
ouut
.
buf
 = 
NULL
;

1650 
u
->
ouut
.
š
 = 
NULL
;

1651 
u
->
ouut
.
busy
 = 
NULL
;

1655 
u
->
bufãr
.
pos
 = u->bufãr.
¡¬t
;

1657 #ià(
NGX_HTTP_CACHE
)

1659 ià(
r
->
ÿche
) {

1660 
u
->
bufãr
.
pos
 +ð
r
->
ÿche
->
h—d”_¡¬t
;

1665 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
;

1667  
NGX_OK
;

1668 
	}
}

1672 
	$ngx_h‰p_up¡»am_£nd_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

1674 
ngx_št_t
 
rc
;

1675 
ngx_cÚÃùiÚ_t
 *
c
;

1677 
c
 = 
u
->
³”
.
cÚÃùiÚ
;

1679 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

1682 ià(!
u
->
»que¡_£Á
 && 
	`ngx_h‰p_up¡»am_‹¡_cÚÃù
(
c
è!ð
NGX_OK
) {

1683 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_ERROR
);

1687 
c
->
log
->
aùiÚ
 = "sending„equesto upstream";

1689 
rc
 = 
	`ngx_ouut_chaš
(&
u
->
ouut
, u->
»que¡_£Á
 ? 
NULL
 : u->
»que¡_bufs
);

1691 
u
->
»que¡_£Á
 = 1;

1693 ià(
rc
 =ð
NGX_ERROR
) {

1694 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_ERROR
);

1698 ià(
c
->
wr™e
->
tim”_£t
) {

1699 
	`ngx_d–_tim”
(
c
->
wr™e
);

1702 ià(
rc
 =ð
NGX_AGAIN
) {

1703 
	`ngx_add_tim”
(
c
->
wr™e
, 
u
->
cÚf
->
£nd_timeout
);

1705 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 
u
->
cÚf
->
£nd_low©
è!ð
NGX_OK
) {

1706 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1707 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1716 ià(
c
->
tý_nÝush
 =ð
NGX_TCP_NOPUSH_SET
) {

1717 ià(
	`ngx_tý_push
(
c
->
fd
è=ð
NGX_ERROR
) {

1718 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
c
->
log
, 
ngx_sock‘_”ºo
,

1719 
ngx_tý_push_n
 " failed");

1720 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1721 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1725 
c
->
tý_nÝush
 = 
NGX_TCP_NOPUSH_UNSET
;

1728 
u
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_dummy_hªdËr
;

1730 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

1731 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1732 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1736 
	`ngx_add_tim”
(
c
->
»ad
, 
u
->
cÚf
->
»ad_timeout
);

1738 ià(
c
->
»ad
->
»ady
) {

1739 
	`ngx_h‰p_up¡»am_´oûss_h—d”
(
r
, 
u
);

1742 
	}
}

1746 
	$ngx_h‰p_up¡»am_£nd_»que¡_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
,

1747 
ngx_h‰p_up¡»am_t
 *
u
)

1749 
ngx_cÚÃùiÚ_t
 *
c
;

1751 
c
 = 
u
->
³”
.
cÚÃùiÚ
;

1753 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

1756 ià(
c
->
wr™e
->
timedout
) {

1757 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_TIMEOUT
);

1761 #ià(
NGX_HTTP_SSL
)

1763 ià(
u
->
s¦
 && 
c
->s¦ =ð
NULL
) {

1764 
	`ngx_h‰p_up¡»am_s¦_š™_cÚÃùiÚ
(
r
, 
u
, 
c
);

1770 ià(
u
->
h—d”_£Á
) {

1771 
u
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_dummy_hªdËr
;

1773 (è
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0);

1778 
	`ngx_h‰p_up¡»am_£nd_»que¡
(
r
, 
u
);

1779 
	}
}

1783 
	$ngx_h‰p_up¡»am_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

1785 
ssize_t
 
n
;

1786 
ngx_št_t
 
rc
;

1787 
ngx_cÚÃùiÚ_t
 *
c
;

1789 
c
 = 
u
->
³”
.
cÚÃùiÚ
;

1791 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

1794 
c
->
log
->
aùiÚ
 = "reading„esponse header from upstream";

1796 ià(
c
->
»ad
->
timedout
) {

1797 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_TIMEOUT
);

1801 ià(!
u
->
»que¡_£Á
 && 
	`ngx_h‰p_up¡»am_‹¡_cÚÃù
(
c
è!ð
NGX_OK
) {

1802 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_ERROR
);

1806 ià(
u
->
bufãr
.
¡¬t
 =ð
NULL
) {

1807 
u
->
bufãr
.
¡¬t
 = 
	`ngx_·Îoc
(
r
->
poÞ
, u->
cÚf
->
bufãr_size
);

1808 ià(
u
->
bufãr
.
¡¬t
 =ð
NULL
) {

1809 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1810 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1814 
u
->
bufãr
.
pos
 = u->bufãr.
¡¬t
;

1815 
u
->
bufãr
.
Ï¡
 = u->bufãr.
¡¬t
;

1816 
u
->
bufãr
.
’d
 = u->bufãr.
¡¬t
 + u->
cÚf
->
bufãr_size
;

1817 
u
->
bufãr
.
‹mpÜ¬y
 = 1;

1819 
u
->
bufãr
.
g
 = u->
ouut
.tag;

1821 ià(
	`ngx_li¡_š™
(&
u
->
h—d”s_š
.
h—d”s
, 
r
->
poÞ
, 8,

1822 (
ngx_bË_–t_t
))

1823 !ð
NGX_OK
)

1825 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1826 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1830 #ià(
NGX_HTTP_CACHE
)

1832 ià(
r
->
ÿche
) {

1833 
u
->
bufãr
.
pos
 +ð
r
->
ÿche
->
h—d”_¡¬t
;

1834 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
;

1841 
n
 = 
c
->
	`»cv
(c, 
u
->
bufãr
.
Ï¡
, u->bufãr.
’d
 - u->buffer.last);

1843 ià(
n
 =ð
NGX_AGAIN
) {

1845 
	`ngx_add_tim”
(
»v
, 
u
->
»ad_timeout
);

1848 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

1849 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1850 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1857 ià(
n
 == 0) {

1858 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

1862 ià(
n
 =ð
NGX_ERROR
 ||‚ == 0) {

1863 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_ERROR
);

1867 
u
->
bufãr
.
Ï¡
 +ð
n
;

1870 
u
->
v®id_h—d”_š
 = 0;

1872 
u
->
³”
.
ÿched
 = 0;

1875 
rc
 = 
u
->
	`´oûss_h—d”
(
r
);

1877 ià(
rc
 =ð
NGX_AGAIN
) {

1879 ià(
u
->
bufãr
.
Ï¡
 =ðu->bufãr.
’d
) {

1880 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

1883 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
,

1884 
NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
);

1894 ià(
rc
 =ð
NGX_HTTP_UPSTREAM_INVALID_HEADER
) {

1895 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
);

1899 ià(
rc
 =ð
NGX_ERROR
) {

1900 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

1901 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

1907 ià(
u
->
h—d”s_š
.
¡©us_n
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

1909 ià(
	`ngx_h‰p_up¡»am_‹¡_Ãxt
(
r
, 
u
è=ð
NGX_OK
) {

1913 ià(
	`ngx_h‰p_up¡»am_š‹rû±_”rÜs
(
r
, 
u
è=ð
NGX_OK
) {

1918 ià(
	`ngx_h‰p_up¡»am_´oûss_h—d”s
(
r
, 
u
è!ð
NGX_OK
) {

1922 ià(!
r
->
sub»que¡_š_memÜy
) {

1923 
	`ngx_h‰p_up¡»am_£nd_»¥Ú£
(
r
, 
u
);

1929 ià(
u
->
šput_fž‹r
 =ð
NULL
) {

1930 
u
->
šput_fž‹r_š™
 = 
ngx_h‰p_up¡»am_nÚ_bufã»d_fž‹r_š™
;

1931 
u
->
šput_fž‹r
 = 
ngx_h‰p_up¡»am_nÚ_bufã»d_fž‹r
;

1932 
u
->
šput_fž‹r_ùx
 = 
r
;

1935 ià(
u
->
	`šput_fž‹r_š™
(u->
šput_fž‹r_ùx
è=ð
NGX_ERROR
) {

1936 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

1940 
n
 = 
u
->
bufãr
.
Ï¡
 - u->bufãr.
pos
;

1942 ià(
n
) {

1943 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
;

1945 
u
->
¡©e
->
»¥Ú£_Ëngth
 +ð
n
;

1947 ià(
u
->
	`šput_fž‹r
(u->
šput_fž‹r_ùx
, 
n
è=ð
NGX_ERROR
) {

1948 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

1953 ià(
u
->
Ëngth
 == 0) {

1954 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 0);

1958 
u
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_´oûss_body_š_memÜy
;

1960 
	`ngx_h‰p_up¡»am_´oûss_body_š_memÜy
(
r
, 
u
);

1961 
	}
}

1964 
ngx_št_t


1965 
	$ngx_h‰p_up¡»am_‹¡_Ãxt
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

1967 
ngx_ušt_t
 
¡©us
;

1968 
ngx_h‰p_up¡»am_Ãxt_t
 *
un
;

1970 
¡©us
 = 
u
->
h—d”s_š
.
¡©us_n
;

1972 
un
 = 
ngx_h‰p_up¡»am_Ãxt_”rÜs
; un->
¡©us
; un++) {

1974 ià(
¡©us
 !ð
un
->status) {

1978 ià(
u
->
³”
.
Œ›s
 > 1 && (u->
cÚf
->
Ãxt_up¡»am
 & 
un
->
mask
)) {

1979 
	`ngx_h‰p_up¡»am_Ãxt
(
r
, 
u
, 
un
->
mask
);

1980  
NGX_OK
;

1983 #ià(
NGX_HTTP_CACHE
)

1985 ià(
u
->
ÿche_¡©us
 =ð
NGX_HTTP_CACHE_EXPIRED


1986 && (
u
->
cÚf
->
ÿche_u£_¡®e
 & 
un
->
mask
))

1988 
ngx_št_t
 
rc
;

1990 
rc
 = 
u
->
	`»š™_»que¡
(
r
);

1992 ià(
rc
 =ð
NGX_OK
) {

1993 
u
->
ÿche_¡©us
 = 
NGX_HTTP_CACHE_STALE
;

1994 
rc
 = 
	`ngx_h‰p_up¡»am_ÿche_£nd
(
r
, 
u
);

1997 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
rc
);

1998  
NGX_OK
;

2004 #ià(
NGX_HTTP_CACHE
)

2006 ià(
¡©us
 =ð
NGX_HTTP_NOT_MODIFIED


2007 && 
u
->
ÿche_¡©us
 =ð
NGX_HTTP_CACHE_EXPIRED


2008 && 
u
->
cÚf
->
ÿche_»v®id©e
)

2010 
time_t
 
now
, 
v®id
;

2011 
ngx_št_t
 
rc
;

2013 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2016 
now
 = 
	`ngx_time
();

2017 
v®id
 = 
r
->
ÿche
->
v®id_£c
;

2019 
rc
 = 
u
->
	`»š™_»que¡
(
r
);

2021 ià(
rc
 !ð
NGX_OK
) {

2022 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
rc
);

2023  
NGX_OK
;

2026 
u
->
ÿche_¡©us
 = 
NGX_HTTP_CACHE_REVALIDATED
;

2027 
rc
 = 
	`ngx_h‰p_up¡»am_ÿche_£nd
(
r
, 
u
);

2029 ià(
v®id
 == 0) {

2030 
v®id
 = 
r
->
ÿche
->
v®id_£c
;

2033 ià(
v®id
 == 0) {

2034 
v®id
 = 
	`ngx_h‰p_fže_ÿche_v®id
(
u
->
cÚf
->
ÿche_v®id
,

2035 
u
->
h—d”s_š
.
¡©us_n
);

2036 ià(
v®id
) {

2037 
v®id
 = 
now
 + valid;

2041 ià(
v®id
) {

2042 
r
->
ÿche
->
v®id_£c
 = 
v®id
;

2043 
r
->
ÿche
->
d©e
 = 
now
;

2045 
	`ngx_h‰p_fže_ÿche_upd©e_h—d”
(
r
);

2048 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
rc
);

2049  
NGX_OK
;

2054  
NGX_DECLINED
;

2055 
	}
}

2058 
ngx_št_t


2059 
	$ngx_h‰p_up¡»am_š‹rû±_”rÜs
(
ngx_h‰p_»que¡_t
 *
r
,

2060 
ngx_h‰p_up¡»am_t
 *
u
)

2062 
ngx_št_t
 
¡©us
;

2063 
ngx_ušt_t
 
i
;

2064 
ngx_bË_–t_t
 *
h
;

2065 
ngx_h‰p_”r_·ge_t
 *
”r_·ge
;

2066 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2068 
¡©us
 = 
u
->
h—d”s_š
.
¡©us_n
;

2070 ià(
¡©us
 =ð
NGX_HTTP_NOT_FOUND
 && 
u
->
cÚf
->
š‹rû±_404
) {

2071 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_NOT_FOUND
);

2072  
NGX_OK
;

2075 ià(!
u
->
cÚf
->
š‹rû±_”rÜs
) {

2076  
NGX_DECLINED
;

2079 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2081 ià(
þcf
->
”rÜ_·ges
 =ð
NULL
) {

2082  
NGX_DECLINED
;

2085 
”r_·ge
 = 
þcf
->
”rÜ_·ges
->
–ts
;

2086 
i
 = 0; i < 
þcf
->
”rÜ_·ges
->
ÃÉs
; i++) {

2088 ià(
”r_·ge
[
i
].
¡©us
 == status) {

2090 ià(
¡©us
 =ð
NGX_HTTP_UNAUTHORIZED


2091 && 
u
->
h—d”s_š
.
www_auth’tiÿ‹
)

2093 
h
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

2095 ià(
h
 =ð
NULL
) {

2096 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

2097 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2098  
NGX_OK
;

2101 *
h
 = *
u
->
h—d”s_š
.
www_auth’tiÿ‹
;

2103 
r
->
h—d”s_out
.
www_auth’tiÿ‹
 = 
h
;

2106 #ià(
NGX_HTTP_CACHE
)

2108 ià(
r
->
ÿche
) {

2109 
time_t
 
v®id
;

2111 
v®id
 = 
	`ngx_h‰p_fže_ÿche_v®id
(
u
->
cÚf
->
ÿche_v®id
, 
¡©us
);

2113 ià(
v®id
) {

2114 
r
->
ÿche
->
v®id_£c
 = 
	`ngx_time
(è+ 
v®id
;

2115 
r
->
ÿche
->
”rÜ
 = 
¡©us
;

2118 
	`ngx_h‰p_fže_ÿche_ä“
(
r
->
ÿche
, 
u
->
pe
->
‹mp_fže
);

2121 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
¡©us
);

2123  
NGX_OK
;

2127  
NGX_DECLINED
;

2128 
	}
}

2131 
ngx_št_t


2132 
	$ngx_h‰p_up¡»am_‹¡_cÚÃù
(
ngx_cÚÃùiÚ_t
 *
c
)

2134 
”r
;

2135 
sockËn_t
 
Ën
;

2137 #ià(
NGX_HAVE_KQUEUE
)

2139 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

2140 ià(
c
->
wr™e
->
³ndšg_eof
 || c->
»ad
->pending_eof) {

2141 ià(
c
->
wr™e
->
³ndšg_eof
) {

2142 
”r
 = 
c
->
wr™e
->
kq_”ºo
;

2145 
”r
 = 
c
->
»ad
->
kq_”ºo
;

2148 
c
->
log
->
aùiÚ
 = "connectingo upstream";

2149 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
,

2151  
NGX_ERROR
;

2157 
”r
 = 0;

2158 
Ën
 = ();

2165 ià(
	`g‘sockÝt
(
c
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, (*è&
”r
, &
Ën
)

2168 
”r
 = 
ngx_sock‘_”ºo
;

2171 ià(
”r
) {

2172 
c
->
log
->
aùiÚ
 = "connectingo upstream";

2173 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "connect() failed");

2174  
NGX_ERROR
;

2178  
NGX_OK
;

2179 
	}
}

2182 
ngx_št_t


2183 
	$ngx_h‰p_up¡»am_´oûss_h—d”s
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

2185 
ngx_¡r_t
 
uri
, 
¬gs
;

2186 
ngx_ušt_t
 
i
, 
æags
;

2187 
ngx_li¡_·¹_t
 *
·¹
;

2188 
ngx_bË_–t_t
 *
h
;

2189 
ngx_h‰p_up¡»am_h—d”_t
 *
hh
;

2190 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

2192 
umcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_up¡»am_moduË
);

2194 ià(
u
->
h—d”s_š
.
x_acûl_»dœeù


2195 && !(
u
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_XA_REDIRECT
))

2197 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_DECLINED
);

2199 
·¹
 = &
u
->
h—d”s_š
.
h—d”s
.part;

2200 
h
 = 
·¹
->
–ts
;

2202 
i
 = 0; ; i++) {

2204 ià(
i
 >ð
·¹
->
ÃÉs
) {

2205 ià(
·¹
->
Ãxt
 =ð
NULL
) {

2209 
·¹
 =…¬t->
Ãxt
;

2210 
h
 = 
·¹
->
–ts
;

2211 
i
 = 0;

2214 
hh
 = 
	`ngx_hash_fšd
(&
umcf
->
h—d”s_š_hash
, 
h
[
i
].
hash
,

2215 
h
[
i
].
lowÿ£_key
, h[i].
key
.
Ën
);

2217 ià(
hh
 && hh->
»dœeù
) {

2218 ià(
hh
->
	`cÝy_hªdËr
(
r
, &
h
[
i
], hh->
cÚf
è!ð
NGX_OK
) {

2219 
	`ngx_h‰p_fš®ize_»que¡
(
r
,

2220 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2221  
NGX_DONE
;

2226 
uri
 = 
u
->
h—d”s_š
.
x_acûl_»dœeù
->
v®ue
;

2228 ià(
uri
.
d©a
[0] == '@') {

2229 
	`ngx_h‰p_Çmed_loÿtiÚ
(
r
, &
uri
);

2232 
	`ngx_¡r_nuÎ
(&
¬gs
);

2233 
æags
 = 
NGX_HTTP_LOG_UNSAFE
;

2235 ià(
	`ngx_h‰p_·r£_un§ã_uri
(
r
, &
uri
, &
¬gs
, &
æags
è!ð
NGX_OK
) {

2236 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_HTTP_NOT_FOUND
);

2237  
NGX_DONE
;

2240 ià(
r
->
m‘hod
 !ð
NGX_HTTP_HEAD
) {

2241 
r
->
m‘hod
 = 
NGX_HTTP_GET
;

2244 
	`ngx_h‰p_š‹º®_»dœeù
(
r
, &
uri
, &
¬gs
);

2247 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
NGX_DONE
);

2248  
NGX_DONE
;

2251 
·¹
 = &
u
->
h—d”s_š
.
h—d”s
.part;

2252 
h
 = 
·¹
->
–ts
;

2254 
i
 = 0; ; i++) {

2256 ià(
i
 >ð
·¹
->
ÃÉs
) {

2257 ià(
·¹
->
Ãxt
 =ð
NULL
) {

2261 
·¹
 =…¬t->
Ãxt
;

2262 
h
 = 
·¹
->
–ts
;

2263 
i
 = 0;

2266 ià(
	`ngx_hash_fšd
(&
u
->
cÚf
->
hide_h—d”s_hash
, 
h
[
i
].
hash
,

2267 
h
[
i
].
lowÿ£_key
, h[i].
key
.
Ën
))

2272 
hh
 = 
	`ngx_hash_fšd
(&
umcf
->
h—d”s_š_hash
, 
h
[
i
].
hash
,

2273 
h
[
i
].
lowÿ£_key
, h[i].
key
.
Ën
);

2275 ià(
hh
) {

2276 ià(
hh
->
	`cÝy_hªdËr
(
r
, &
h
[
i
], hh->
cÚf
è!ð
NGX_OK
) {

2277 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

2278 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2279  
NGX_DONE
;

2285 ià(
	`ngx_h‰p_up¡»am_cÝy_h—d”_lše
(
r
, &
h
[
i
], 0è!ð
NGX_OK
) {

2286 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

2287 
NGX_HTTP_INTERNAL_SERVER_ERROR
);

2288  
NGX_DONE
;

2292 ià(
r
->
h—d”s_out
.
£rv”
 &&„->h—d”s_out.£rv”->
v®ue
.
d©a
 =ð
NULL
) {

2293 
r
->
h—d”s_out
.
£rv”
->
hash
 = 0;

2296 ià(
r
->
h—d”s_out
.
d©e
 &&„->h—d”s_out.d©e->
v®ue
.
d©a
 =ð
NULL
) {

2297 
r
->
h—d”s_out
.
d©e
->
hash
 = 0;

2300 
r
->
h—d”s_out
.
¡©us
 = 
u
->
h—d”s_š
.
¡©us_n
;

2301 
r
->
h—d”s_out
.
¡©us_lše
 = 
u
->
h—d”s_š
.status_line;

2303 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 = 
u
->
h—d”s_š
.content_length_n;

2305 
r
->
di§bË_nÙ_modif›d
 = !
u
->
ÿch—bË
;

2307 ià(
u
->
cÚf
->
fÜû_¿nges
) {

2308 
r
->
®low_¿nges
 = 1;

2309 
r
->
sšgË_¿nge
 = 1;

2311 #ià(
NGX_HTTP_CACHE
)

2312 ià(
r
->
ÿched
) {

2313 
r
->
sšgË_¿nge
 = 0;

2318 
u
->
Ëngth
 = -1;

2320  
NGX_OK
;

2321 
	}
}

2325 
	$ngx_h‰p_up¡»am_´oûss_body_š_memÜy
(
ngx_h‰p_»que¡_t
 *
r
,

2326 
ngx_h‰p_up¡»am_t
 *
u
)

2328 
size_t
 
size
;

2329 
ssize_t
 
n
;

2330 
ngx_buf_t
 *
b
;

2331 
ngx_ev’t_t
 *
»v
;

2332 
ngx_cÚÃùiÚ_t
 *
c
;

2334 
c
 = 
u
->
³”
.
cÚÃùiÚ
;

2335 
»v
 = 
c
->
»ad
;

2337 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2340 ià(
»v
->
timedout
) {

2341 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
NGX_ETIMEDOUT
, "upstreamimed out");

2342 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_GATEWAY_TIME_OUT
);

2346 
b
 = &
u
->
bufãr
;

2350 
size
 = 
b
->
’d
 - b->
Ï¡
;

2352 ià(
size
 == 0) {

2353 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

2355 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2359 
n
 = 
c
->
	`»cv
(c, 
b
->
Ï¡
, 
size
);

2361 ià(
n
 =ð
NGX_AGAIN
) {

2365 ià(
n
 =ð0 ||‚ =ð
NGX_ERROR
) {

2366 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
n
);

2370 
u
->
¡©e
->
»¥Ú£_Ëngth
 +ð
n
;

2372 ià(
u
->
	`šput_fž‹r
(u->
šput_fž‹r_ùx
, 
n
è=ð
NGX_ERROR
) {

2373 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2377 ià(!
»v
->
»ady
) {

2382 ià(
u
->
Ëngth
 == 0) {

2383 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 0);

2387 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

2388 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2392 ià(
»v
->
aùive
) {

2393 
	`ngx_add_tim”
(
»v
, 
u
->
cÚf
->
»ad_timeout
);

2395 } ià(
»v
->
tim”_£t
) {

2396 
	`ngx_d–_tim”
(
»v
);

2398 
	}
}

2402 
	$ngx_h‰p_up¡»am_£nd_»¥Ú£
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

2404 
tý_nod–ay
;

2405 
ssize_t
 
n
;

2406 
ngx_št_t
 
rc
;

2407 
ngx_ev’t_pe_t
 *
p
;

2408 
ngx_cÚÃùiÚ_t
 *
c
;

2409 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2411 
rc
 = 
	`ngx_h‰p_£nd_h—d”
(
r
);

2413 ià(
rc
 =ð
NGX_ERROR
 ||„ø> 
NGX_OK
 || 
r
->
po¡_aùiÚ
) {

2414 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
rc
);

2418 
u
->
h—d”_£Á
 = 1;

2420 ià(
u
->
upg¿de
) {

2421 
	`ngx_h‰p_up¡»am_upg¿de
(
r
, 
u
);

2425 
c
 = 
r
->
cÚÃùiÚ
;

2427 ià(
r
->
h—d”_Úly
) {

2429 ià(!
u
->
bufãršg
) {

2430 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
rc
);

2434 ià(!
u
->
ÿch—bË
 && !u->
¡Üe
) {

2435 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
rc
);

2439 
u
->
pe
->
down¡»am_”rÜ
 = 1;

2442 ià(
r
->
»que¡_body
 &&„->»que¡_body->
‹mp_fže
) {

2443 
	`ngx_poÞ_run_þ—nup_fže
(
r
->
poÞ
,„->
»que¡_body
->
‹mp_fže
->
fže
.
fd
);

2444 
r
->
»que¡_body
->
‹mp_fže
->
fže
.
fd
 = 
NGX_INVALID_FILE
;

2447 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2449 ià(!
u
->
bufãršg
) {

2451 ià(
u
->
šput_fž‹r
 =ð
NULL
) {

2452 
u
->
šput_fž‹r_š™
 = 
ngx_h‰p_up¡»am_nÚ_bufã»d_fž‹r_š™
;

2453 
u
->
šput_fž‹r
 = 
ngx_h‰p_up¡»am_nÚ_bufã»d_fž‹r
;

2454 
u
->
šput_fž‹r_ùx
 = 
r
;

2457 
u
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_up¡»am
;

2458 
r
->
wr™e_ev’t_hªdËr
 =

2459 
ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_down¡»am
;

2461 
r
->
lim™_¿‹
 = 0;

2463 ià(
u
->
	`šput_fž‹r_š™
(u->
šput_fž‹r_ùx
è=ð
NGX_ERROR
) {

2464 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2468 ià(
þcf
->
tý_nod–ay
 && 
c
->tý_nod–ay =ð
NGX_TCP_NODELAY_UNSET
) {

2469 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "tcp_nodelay");

2471 
tý_nod–ay
 = 1;

2473 ià(
	`£tsockÝt
(
c
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

2474 (cÚ¡ *è&
tý_nod–ay
, ()) == -1)

2476 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
,

2478 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2482 
c
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_SET
;

2485 
n
 = 
u
->
bufãr
.
Ï¡
 - u->bufãr.
pos
;

2487 ià(
n
) {

2488 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
;

2490 
u
->
¡©e
->
»¥Ú£_Ëngth
 +ð
n
;

2492 ià(
u
->
	`šput_fž‹r
(u->
šput_fž‹r_ùx
, 
n
è=ð
NGX_ERROR
) {

2493 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2497 
	`ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_down¡»am
(
r
);

2500 
u
->
bufãr
.
pos
 = u->bufãr.
¡¬t
;

2501 
u
->
bufãr
.
Ï¡
 = u->bufãr.
¡¬t
;

2503 ià(
	`ngx_h‰p_£nd_¥ecŸl
(
r
, 
NGX_HTTP_FLUSH
è=ð
NGX_ERROR
) {

2504 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2508 ià(
u
->
³”
.
cÚÃùiÚ
->
»ad
->
»ady
 || u->
Ëngth
 == 0) {

2509 
	`ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_up¡»am
(
r
, 
u
);

2518 #ià(
NGX_HTTP_CACHE
)

2520 ià(
r
->
ÿche
 &&„->ÿche->
fže
.
fd
 !ð
NGX_INVALID_FILE
) {

2521 
	`ngx_poÞ_run_þ—nup_fže
(
r
->
poÞ
,„->
ÿche
->
fže
.
fd
);

2522 
r
->
ÿche
->
fže
.
fd
 = 
NGX_INVALID_FILE
;

2525 
	`ngx_h‰p_‹¡_´ediÿ‹s
(
r
, 
u
->
cÚf
->
no_ÿche
)) {

2527 
NGX_ERROR
:

2528 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2531 
NGX_DECLINED
:

2532 
u
->
ÿch—bË
 = 0;

2537 ià(
u
->
ÿche_¡©us
 =ð
NGX_HTTP_CACHE_BYPASS
) {

2539 
r
->
ÿche
->
mš_u£s
 = 
u
->
cÚf
->
ÿche_mš_u£s
;

2540 
r
->
ÿche
->
body_¡¬t
 = 
u
->
cÚf
->
bufãr_size
;

2541 
r
->
ÿche
->
fže_ÿche
 = 
u
->
cÚf
->ÿche->
d©a
;

2543 ià(
	`ngx_h‰p_fže_ÿche_ü—‹
(
r
è!ð
NGX_OK
) {

2544 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2552 ià(
u
->
ÿch—bË
) {

2553 
time_t
 
now
, 
v®id
;

2555 
now
 = 
	`ngx_time
();

2557 
v®id
 = 
r
->
ÿche
->
v®id_£c
;

2559 ià(
v®id
 == 0) {

2560 
v®id
 = 
	`ngx_h‰p_fže_ÿche_v®id
(
u
->
cÚf
->
ÿche_v®id
,

2561 
u
->
h—d”s_š
.
¡©us_n
);

2562 ià(
v®id
) {

2563 
r
->
ÿche
->
v®id_£c
 = 
now
 + 
v®id
;

2567 ià(
v®id
) {

2568 
r
->
ÿche
->
Ï¡_modif›d
 = 
u
->
h—d”s_š
.
Ï¡_modif›d_time
;

2569 
r
->
ÿche
->
d©e
 = 
now
;

2570 
r
->
ÿche
->
body_¡¬t
 = (
u_shÜt
è(
u
->
bufãr
.
pos
 - u->bufãr.
¡¬t
);

2572 ià(
u
->
h—d”s_š
.
‘ag
) {

2573 
r
->
ÿche
->
‘ag
 = 
u
->
h—d”s_š
.‘ag->
v®ue
;

2576 
	`ngx_h‰p_fže_ÿche_£t_h—d”
(
r
, 
u
->
bufãr
.
¡¬t
);

2579 
u
->
ÿch—bË
 = 0;

2583 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2584 "h‰°ÿch—bË: %d", 
u
->
ÿch—bË
);

2586 ià(
u
->
ÿch—bË
 =ð0 && 
r
->
ÿche
) {

2587 
	`ngx_h‰p_fže_ÿche_ä“
(
r
->
ÿche
, 
u
->
pe
->
‹mp_fže
);

2592 
p
 = 
u
->
pe
;

2594 
p
->
ouut_fž‹r
 = (
ngx_ev’t_pe_ouut_fž‹r_±
è
ngx_h‰p_ouut_fž‹r
;

2595 
p
->
ouut_ùx
 = 
r
;

2596 
p
->
g
 = 
u
->
ouut
.tag;

2597 
p
->
bufs
 = 
u
->
cÚf
->bufs;

2598 
p
->
busy_size
 = 
u
->
cÚf
->
busy_bufãrs_size
;

2599 
p
->
up¡»am
 = 
u
->
³”
.
cÚÃùiÚ
;

2600 
p
->
down¡»am
 = 
c
;

2601 
p
->
poÞ
 = 
r
->pool;

2602 
p
->
log
 = 
c
->log;

2603 
p
->
lim™_¿‹
 = 
u
->
cÚf
->limit_rate;

2604 
p
->
¡¬t_£c
 = 
	`ngx_time
();

2606 
p
->
ÿch—bË
 = 
u
->ÿch—bË || u->
¡Üe
;

2608 
p
->
‹mp_fže
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_‹mp_fže_t
));

2609 ià(
p
->
‹mp_fže
 =ð
NULL
) {

2610 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2614 
p
->
‹mp_fže
->
fže
.
fd
 = 
NGX_INVALID_FILE
;

2615 
p
->
‹mp_fže
->
fže
.
log
 = 
c
->log;

2616 
p
->
‹mp_fže
->
·th
 = 
u
->
cÚf
->
‹mp_·th
;

2617 
p
->
‹mp_fže
->
poÞ
 = 
r
->pool;

2619 ià(
p
->
ÿch—bË
) {

2620 
p
->
‹mp_fže
->
³rsi¡’t
 = 1;

2623 
p
->
‹mp_fže
->
log_Ëv–
 = 
NGX_LOG_WARN
;

2624 
p
->
‹mp_fže
->
w¬n
 = "an upstream„esponse is buffered "

2628 
p
->
max_‹mp_fže_size
 = 
u
->
cÚf
->max_temp_file_size;

2629 
p
->
‹mp_fže_wr™e_size
 = 
u
->
cÚf
->temp_file_write_size;

2631 
p
->
´”—d_bufs
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

2632 ià(
p
->
´”—d_bufs
 =ð
NULL
) {

2633 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2637 
p
->
´”—d_bufs
->
buf
 = &
u
->
bufãr
;

2638 
p
->
´”—d_bufs
->
Ãxt
 = 
NULL
;

2639 
u
->
bufãr
.
»cyþed
 = 1;

2641 
p
->
´”—d_size
 = 
u
->
bufãr
.
Ï¡
 - u->bufãr.
pos
;

2643 ià(
u
->
ÿch—bË
) {

2645 
p
->
buf_to_fže
 = 
	`ngx_ÿÎoc_buf
(
r
->
poÞ
);

2646 ià(
p
->
buf_to_fže
 =ð
NULL
) {

2647 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2651 
p
->
buf_to_fže
->
¡¬t
 = 
u
->
bufãr
.start;

2652 
p
->
buf_to_fže
->
pos
 = 
u
->
bufãr
.
¡¬t
;

2653 
p
->
buf_to_fže
->
Ï¡
 = 
u
->
bufãr
.
pos
;

2654 
p
->
buf_to_fže
->
‹mpÜ¬y
 = 1;

2657 ià(
ngx_ev’t_æags
 & 
NGX_USE_AIO_EVENT
) {

2659 
p
->
sšgË_buf
 = 1;

2663 
p
->
ä“_bufs
 = 1;

2669 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
;

2671 ià(
u
->
cÚf
->
cyþic_‹mp_fže
) {

2679 
p
->
cyþic_‹mp_fže
 = 1;

2680 
c
->
£ndfže
 = 0;

2683 
p
->
cyþic_‹mp_fže
 = 0;

2686 
p
->
»ad_timeout
 = 
u
->
cÚf
->read_timeout;

2687 
p
->
£nd_timeout
 = 
þcf
->send_timeout;

2688 
p
->
£nd_low©
 = 
þcf
->send_lowat;

2690 
p
->
Ëngth
 = -1;

2692 ià(
u
->
šput_fž‹r_š™


2693 && 
u
->
	`šput_fž‹r_š™
(
p
->
šput_ùx
è!ð
NGX_OK
)

2695 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2699 
u
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_´oûss_up¡»am
;

2700 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_´oûss_down¡»am
;

2702 
	`ngx_h‰p_up¡»am_´oûss_up¡»am
(
r
, 
u
);

2703 
	}
}

2707 
	$ngx_h‰p_up¡»am_upg¿de
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

2709 
tý_nod–ay
;

2710 
ngx_cÚÃùiÚ_t
 *
c
;

2711 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2713 
c
 = 
r
->
cÚÃùiÚ
;

2714 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2718 
r
->
k“·live
 = 0;

2719 
c
->
log
->
aùiÚ
 = "proxying upgraded connection";

2721 
u
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_upg¿ded_»ad_up¡»am
;

2722 
u
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_upg¿ded_wr™e_up¡»am
;

2723 
r
->
»ad_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_upg¿ded_»ad_down¡»am
;

2724 
r
->
wr™e_ev’t_hªdËr
 = 
ngx_h‰p_up¡»am_upg¿ded_wr™e_down¡»am
;

2726 ià(
þcf
->
tý_nod–ay
) {

2727 
tý_nod–ay
 = 1;

2729 ià(
c
->
tý_nod–ay
 =ð
NGX_TCP_NODELAY_UNSET
) {

2730 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0, "tcp_nodelay");

2732 ià(
	`£tsockÝt
(
c
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

2733 (cÚ¡ *è&
tý_nod–ay
, ()) == -1)

2735 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
ngx_sock‘_”ºo
,

2737 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2741 
c
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_SET
;

2744 ià(
u
->
³”
.
cÚÃùiÚ
->
tý_nod–ay
 =ð
NGX_TCP_NODELAY_UNSET
) {

2745 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
u
->
³”
.
cÚÃùiÚ
->
log
, 0,

2748 ià(
	`£tsockÝt
(
u
->
³”
.
cÚÃùiÚ
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

2749 (cÚ¡ *è&
tý_nod–ay
, ()) == -1)

2751 
	`ngx_cÚÃùiÚ_”rÜ
(
u
->
³”
.
cÚÃùiÚ
, 
ngx_sock‘_”ºo
,

2753 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2757 
u
->
³”
.
cÚÃùiÚ
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_SET
;

2761 ià(
	`ngx_h‰p_£nd_¥ecŸl
(
r
, 
NGX_HTTP_FLUSH
è=ð
NGX_ERROR
) {

2762 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2766 ià(
u
->
³”
.
cÚÃùiÚ
->
»ad
->
»ady


2767 || 
u
->
bufãr
.
pos
 !ðu->bufãr.
Ï¡
)

2769 
	`ngx_po¡_ev’t
(
c
->
»ad
, &
ngx_po¡ed_ev’ts
);

2770 
	`ngx_h‰p_up¡»am_´oûss_upg¿ded
(
r
, 1, 1);

2774 
	`ngx_h‰p_up¡»am_´oûss_upg¿ded
(
r
, 0, 1);

2775 
	}
}

2779 
	$ngx_h‰p_up¡»am_upg¿ded_»ad_down¡»am
(
ngx_h‰p_»que¡_t
 *
r
)

2781 
	`ngx_h‰p_up¡»am_´oûss_upg¿ded
(
r
, 0, 0);

2782 
	}
}

2786 
	$ngx_h‰p_up¡»am_upg¿ded_wr™e_down¡»am
(
ngx_h‰p_»que¡_t
 *
r
)

2788 
	`ngx_h‰p_up¡»am_´oûss_upg¿ded
(
r
, 1, 1);

2789 
	}
}

2793 
	$ngx_h‰p_up¡»am_upg¿ded_»ad_up¡»am
(
ngx_h‰p_»que¡_t
 *
r
,

2794 
ngx_h‰p_up¡»am_t
 *
u
)

2796 
	`ngx_h‰p_up¡»am_´oûss_upg¿ded
(
r
, 1, 0);

2797 
	}
}

2801 
	$ngx_h‰p_up¡»am_upg¿ded_wr™e_up¡»am
(
ngx_h‰p_»que¡_t
 *
r
,

2802 
ngx_h‰p_up¡»am_t
 *
u
)

2804 
	`ngx_h‰p_up¡»am_´oûss_upg¿ded
(
r
, 0, 1);

2805 
	}
}

2809 
	$ngx_h‰p_up¡»am_´oûss_upg¿ded
(
ngx_h‰p_»que¡_t
 *
r
,

2810 
ngx_ušt_t
 
äom_up¡»am
,‚gx_ušt_ˆ
do_wr™e
)

2812 
size_t
 
size
;

2813 
ssize_t
 
n
;

2814 
ngx_buf_t
 *
b
;

2815 
ngx_cÚÃùiÚ_t
 *
c
, *
down¡»am
, *
up¡»am
, *
d¡
, *
¤c
;

2816 
ngx_h‰p_up¡»am_t
 *
u
;

2817 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

2819 
c
 = 
r
->
cÚÃùiÚ
;

2820 
u
 = 
r
->
up¡»am
;

2822 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2823 "h‰°up¡»am…roûs upg¿ded, fu:%ui", 
äom_up¡»am
);

2825 
down¡»am
 = 
c
;

2826 
up¡»am
 = 
u
->
³”
.
cÚÃùiÚ
;

2828 ià(
down¡»am
->
wr™e
->
timedout
) {

2829 
c
->
timedout
 = 1;

2830 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
NGX_ETIMEDOUT
, "clientimed out");

2831 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_REQUEST_TIME_OUT
);

2835 ià(
up¡»am
->
»ad
->
timedout
 || up¡»am->
wr™e
->timedout) {

2836 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
NGX_ETIMEDOUT
, "upstreamimed out");

2837 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_GATEWAY_TIME_OUT
);

2841 ià(
äom_up¡»am
) {

2842 
¤c
 = 
up¡»am
;

2843 
d¡
 = 
down¡»am
;

2844 
b
 = &
u
->
bufãr
;

2847 
¤c
 = 
down¡»am
;

2848 
d¡
 = 
up¡»am
;

2849 
b
 = &
u
->
äom_þ›Á
;

2851 ià(
r
->
h—d”_š
->
Ï¡
 >„->h—d”_š->
pos
) {

2852 
b
 = 
r
->
h—d”_š
;

2853 
b
->
’d
 = b->
Ï¡
;

2854 
do_wr™e
 = 1;

2857 ià(
b
->
¡¬t
 =ð
NULL
) {

2858 
b
->
¡¬t
 = 
	`ngx_·Îoc
(
r
->
poÞ
, 
u
->
cÚf
->
bufãr_size
);

2859 ià(
b
->
¡¬t
 =ð
NULL
) {

2860 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2864 
b
->
pos
 = b->
¡¬t
;

2865 
b
->
Ï¡
 = b->
¡¬t
;

2866 
b
->
’d
 = b->
¡¬t
 + 
u
->
cÚf
->
bufãr_size
;

2867 
b
->
‹mpÜ¬y
 = 1;

2868 
b
->
g
 = 
u
->
ouut
.tag;

2874 ià(
do_wr™e
) {

2876 
size
 = 
b
->
Ï¡
 - b->
pos
;

2878 ià(
size
 && 
d¡
->
wr™e
->
»ady
) {

2880 
n
 = 
d¡
->
	`£nd
(d¡, 
b
->
pos
, 
size
);

2882 ià(
n
 =ð
NGX_ERROR
) {

2883 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2887 ià(
n
 > 0) {

2888 
b
->
pos
 +ð
n
;

2890 ià(
b
->
pos
 =ðb->
Ï¡
) {

2891 
b
->
pos
 = b->
¡¬t
;

2892 
b
->
Ï¡
 = b->
¡¬t
;

2898 
size
 = 
b
->
’d
 - b->
Ï¡
;

2900 ià(
size
 && 
¤c
->
»ad
->
»ady
) {

2902 
n
 = 
¤c
->
	`»cv
(¤c, 
b
->
Ï¡
, 
size
);

2904 ià(
n
 =ð
NGX_AGAIN
 ||‚ == 0) {

2908 ià(
n
 > 0) {

2909 
do_wr™e
 = 1;

2910 
b
->
Ï¡
 +ð
n
;

2915 ià(
n
 =ð
NGX_ERROR
) {

2916 
¤c
->
»ad
->
eof
 = 1;

2923 ià((
up¡»am
->
»ad
->
eof
 && 
u
->
bufãr
.
pos
 =ðu->bufãr.
Ï¡
)

2924 || (
down¡»am
->
»ad
->
eof
 && 
u
->
äom_þ›Á
.
pos
 =ðu->äom_þ›Á.
Ï¡
)

2925 || (
down¡»am
->
»ad
->
eof
 && 
up¡»am
->read->eof))

2927 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2929 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 0);

2933 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2935 ià(
	`ngx_hªdË_wr™e_ev’t
(
up¡»am
->
wr™e
, 
u
->
cÚf
->
£nd_low©
)

2936 !ð
NGX_OK
)

2938 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2942 ià(
up¡»am
->
wr™e
->
aùive
 && !up¡»am->wr™e->
»ady
) {

2943 
	`ngx_add_tim”
(
up¡»am
->
wr™e
, 
u
->
cÚf
->
£nd_timeout
);

2945 } ià(
up¡»am
->
wr™e
->
tim”_£t
) {

2946 
	`ngx_d–_tim”
(
up¡»am
->
wr™e
);

2949 ià(
	`ngx_hªdË_»ad_ev’t
(
up¡»am
->
»ad
, 0è!ð
NGX_OK
) {

2950 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2954 ià(
up¡»am
->
»ad
->
aùive
 && !up¡»am->»ad->
»ady
) {

2955 
	`ngx_add_tim”
(
up¡»am
->
»ad
, 
u
->
cÚf
->
»ad_timeout
);

2957 } ià(
up¡»am
->
»ad
->
tim”_£t
) {

2958 
	`ngx_d–_tim”
(
up¡»am
->
»ad
);

2961 ià(
	`ngx_hªdË_wr™e_ev’t
(
down¡»am
->
wr™e
, 
þcf
->
£nd_low©
)

2962 !ð
NGX_OK
)

2964 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2968 ià(
	`ngx_hªdË_»ad_ev’t
(
down¡»am
->
»ad
, 0è!ð
NGX_OK
) {

2969 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

2973 ià(
down¡»am
->
wr™e
->
aùive
 && !down¡»am->wr™e->
»ady
) {

2974 
	`ngx_add_tim”
(
down¡»am
->
wr™e
, 
þcf
->
£nd_timeout
);

2976 } ià(
down¡»am
->
wr™e
->
tim”_£t
) {

2977 
	`ngx_d–_tim”
(
down¡»am
->
wr™e
);

2979 
	}
}

2983 
	$ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_down¡»am
(
ngx_h‰p_»que¡_t
 *
r
)

2985 
ngx_ev’t_t
 *
wev
;

2986 
ngx_cÚÃùiÚ_t
 *
c
;

2987 
ngx_h‰p_up¡»am_t
 *
u
;

2989 
c
 = 
r
->
cÚÃùiÚ
;

2990 
u
 = 
r
->
up¡»am
;

2991 
wev
 = 
c
->
wr™e
;

2993 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

2996 
c
->
log
->
aùiÚ
 = "sendingo client";

2998 ià(
wev
->
timedout
) {

2999 
c
->
timedout
 = 1;

3000 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
NGX_ETIMEDOUT
, "clientimed out");

3001 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_REQUEST_TIME_OUT
);

3005 
	`ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_»que¡
(
r
, 1);

3006 
	}
}

3010 
	$ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_up¡»am
(
ngx_h‰p_»que¡_t
 *
r
,

3011 
ngx_h‰p_up¡»am_t
 *
u
)

3013 
ngx_cÚÃùiÚ_t
 *
c
;

3015 
c
 = 
u
->
³”
.
cÚÃùiÚ
;

3017 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

3020 
c
->
log
->
aùiÚ
 = "reading upstream";

3022 ià(
c
->
»ad
->
timedout
) {

3023 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
NGX_ETIMEDOUT
, "upstreamimed out");

3024 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_GATEWAY_TIME_OUT
);

3028 
	`ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_»que¡
(
r
, 0);

3029 
	}
}

3033 
	$ngx_h‰p_up¡»am_´oûss_nÚ_bufã»d_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

3034 
ngx_ušt_t
 
do_wr™e
)

3036 
size_t
 
size
;

3037 
ssize_t
 
n
;

3038 
ngx_buf_t
 *
b
;

3039 
ngx_št_t
 
rc
;

3040 
ngx_cÚÃùiÚ_t
 *
down¡»am
, *
up¡»am
;

3041 
ngx_h‰p_up¡»am_t
 *
u
;

3042 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

3044 
u
 = 
r
->
up¡»am
;

3045 
down¡»am
 = 
r
->
cÚÃùiÚ
;

3046 
up¡»am
 = 
u
->
³”
.
cÚÃùiÚ
;

3048 
b
 = &
u
->
bufãr
;

3050 
do_wr™e
 = do_wr™|| 
u
->
Ëngth
 == 0;

3054 ià(
do_wr™e
) {

3056 ià(
u
->
out_bufs
 || u->
busy_bufs
) {

3057 
rc
 = 
	`ngx_h‰p_ouut_fž‹r
(
r
, 
u
->
out_bufs
);

3059 ià(
rc
 =ð
NGX_ERROR
) {

3060 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3064 
	`ngx_chaš_upd©e_chašs
(
r
->
poÞ
, &
u
->
ä“_bufs
, &u->
busy_bufs
,

3065 &
u
->
out_bufs
, u->
ouut
.
g
);

3068 ià(
u
->
busy_bufs
 =ð
NULL
) {

3070 ià(
u
->
Ëngth
 == 0

3071 || (
up¡»am
->
»ad
->
eof
 && 
u
->
Ëngth
 == -1))

3073 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 0);

3077 ià(
up¡»am
->
»ad
->
eof
) {

3078 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
up¡»am
->
log
, 0,

3081 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

3082 
NGX_HTTP_BAD_GATEWAY
);

3086 ià(
up¡»am
->
»ad
->
”rÜ
) {

3087 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

3088 
NGX_HTTP_BAD_GATEWAY
);

3092 
b
->
pos
 = b->
¡¬t
;

3093 
b
->
Ï¡
 = b->
¡¬t
;

3097 
size
 = 
b
->
’d
 - b->
Ï¡
;

3099 ià(
size
 && 
up¡»am
->
»ad
->
»ady
) {

3101 
n
 = 
up¡»am
->
	`»cv
(up¡»am, 
b
->
Ï¡
, 
size
);

3103 ià(
n
 =ð
NGX_AGAIN
) {

3107 ià(
n
 > 0) {

3108 
u
->
¡©e
->
»¥Ú£_Ëngth
 +ð
n
;

3110 ià(
u
->
	`šput_fž‹r
(u->
šput_fž‹r_ùx
, 
n
è=ð
NGX_ERROR
) {

3111 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3116 
do_wr™e
 = 1;

3124 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

3126 ià(
down¡»am
->
d©a
 =ð
r
) {

3127 ià(
	`ngx_hªdË_wr™e_ev’t
(
down¡»am
->
wr™e
, 
þcf
->
£nd_low©
)

3128 !ð
NGX_OK
)

3130 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3135 ià(
down¡»am
->
wr™e
->
aùive
 && !down¡»am->wr™e->
»ady
) {

3136 
	`ngx_add_tim”
(
down¡»am
->
wr™e
, 
þcf
->
£nd_timeout
);

3138 } ià(
down¡»am
->
wr™e
->
tim”_£t
) {

3139 
	`ngx_d–_tim”
(
down¡»am
->
wr™e
);

3142 ià(
	`ngx_hªdË_»ad_ev’t
(
up¡»am
->
»ad
, 0è!ð
NGX_OK
) {

3143 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3147 ià(
up¡»am
->
»ad
->
aùive
 && !up¡»am->»ad->
»ady
) {

3148 
	`ngx_add_tim”
(
up¡»am
->
»ad
, 
u
->
cÚf
->
»ad_timeout
);

3150 } ià(
up¡»am
->
»ad
->
tim”_£t
) {

3151 
	`ngx_d–_tim”
(
up¡»am
->
»ad
);

3153 
	}
}

3156 
ngx_št_t


3157 
	$ngx_h‰p_up¡»am_nÚ_bufã»d_fž‹r_š™
(*
d©a
)

3159  
NGX_OK
;

3160 
	}
}

3163 
ngx_št_t


3164 
	$ngx_h‰p_up¡»am_nÚ_bufã»d_fž‹r
(*
d©a
, 
ssize_t
 
by‹s
)

3166 
ngx_h‰p_»que¡_t
 *
r
 = 
d©a
;

3168 
ngx_buf_t
 *
b
;

3169 
ngx_chaš_t
 *
þ
, **
Î
;

3170 
ngx_h‰p_up¡»am_t
 *
u
;

3172 
u
 = 
r
->
up¡»am
;

3174 
þ
 = 
u
->
out_bufs
, 
Î
 = &u->out_bufs; cl; cÈðþ->
Ãxt
) {

3175 
Î
 = &
þ
->
Ãxt
;

3178 
þ
 = 
	`ngx_chaš_g‘_ä“_buf
(
r
->
poÞ
, &
u
->
ä“_bufs
);

3179 ià(
þ
 =ð
NULL
) {

3180  
NGX_ERROR
;

3183 *
Î
 = 
þ
;

3185 
þ
->
buf
->
æush
 = 1;

3186 
þ
->
buf
->
memÜy
 = 1;

3188 
b
 = &
u
->
bufãr
;

3190 
þ
->
buf
->
pos
 = 
b
->
Ï¡
;

3191 
b
->
Ï¡
 +ð
by‹s
;

3192 
þ
->
buf
->
Ï¡
 = 
b
->last;

3193 
þ
->
buf
->
g
 = 
u
->
ouut
.tag;

3195 ià(
u
->
Ëngth
 == -1) {

3196  
NGX_OK
;

3199 
u
->
Ëngth
 -ð
by‹s
;

3201  
NGX_OK
;

3202 
	}
}

3206 
	$ngx_h‰p_up¡»am_´oûss_down¡»am
(
ngx_h‰p_»que¡_t
 *
r
)

3208 
ngx_ev’t_t
 *
wev
;

3209 
ngx_cÚÃùiÚ_t
 *
c
;

3210 
ngx_ev’t_pe_t
 *
p
;

3211 
ngx_h‰p_up¡»am_t
 *
u
;

3213 
c
 = 
r
->
cÚÃùiÚ
;

3214 
u
 = 
r
->
up¡»am
;

3215 
p
 = 
u
->
pe
;

3216 
wev
 = 
c
->
wr™e
;

3218 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

3221 
c
->
log
->
aùiÚ
 = "sendingo client";

3223 ià(
wev
->
timedout
) {

3225 ià(
wev
->
d–ayed
) {

3227 
wev
->
timedout
 = 0;

3228 
wev
->
d–ayed
 = 0;

3230 ià(!
wev
->
»ady
) {

3231 
	`ngx_add_tim”
(
wev
, 
p
->
£nd_timeout
);

3233 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 
p
->
£nd_low©
è!ð
NGX_OK
) {

3234 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3240 ià(
	`ngx_ev’t_pe
(
p
, 
wev
->
wr™e
è=ð
NGX_ABORT
) {

3241 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3246 
p
->
down¡»am_”rÜ
 = 1;

3247 
c
->
timedout
 = 1;

3248 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
NGX_ETIMEDOUT
, "clientimed out");

3253 ià(
wev
->
d–ayed
) {

3255 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

3258 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 
p
->
£nd_low©
è!ð
NGX_OK
) {

3259 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3265 ià(
	`ngx_ev’t_pe
(
p
, 1è=ð
NGX_ABORT
) {

3266 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3271 
	`ngx_h‰p_up¡»am_´oûss_»que¡
(
r
);

3272 
	}
}

3276 
	$ngx_h‰p_up¡»am_´oûss_up¡»am
(
ngx_h‰p_»que¡_t
 *
r
,

3277 
ngx_h‰p_up¡»am_t
 *
u
)

3279 
ngx_ev’t_t
 *
»v
;

3280 
ngx_ev’t_pe_t
 *
p
;

3281 
ngx_cÚÃùiÚ_t
 *
c
;

3283 
c
 = 
u
->
³”
.
cÚÃùiÚ
;

3284 
p
 = 
u
->
pe
;

3285 
»v
 = 
c
->
»ad
;

3287 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

3290 
c
->
log
->
aùiÚ
 = "reading upstream";

3292 ià(
»v
->
timedout
) {

3294 ià(
»v
->
d–ayed
) {

3296 
»v
->
timedout
 = 0;

3297 
»v
->
d–ayed
 = 0;

3299 ià(!
»v
->
»ady
) {

3300 
	`ngx_add_tim”
(
»v
, 
p
->
»ad_timeout
);

3302 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

3303 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3309 ià(
	`ngx_ev’t_pe
(
p
, 0è=ð
NGX_ABORT
) {

3310 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3315 
p
->
up¡»am_”rÜ
 = 1;

3316 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
NGX_ETIMEDOUT
, "upstreamimed out");

3321 ià(
»v
->
d–ayed
) {

3323 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

3326 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

3327 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3333 ià(
	`ngx_ev’t_pe
(
p
, 0è=ð
NGX_ABORT
) {

3334 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3339 
	`ngx_h‰p_up¡»am_´oûss_»que¡
(
r
);

3340 
	}
}

3344 
	$ngx_h‰p_up¡»am_´oûss_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

3346 
ngx_‹mp_fže_t
 *
tf
;

3347 
ngx_ev’t_pe_t
 *
p
;

3348 
ngx_h‰p_up¡»am_t
 *
u
;

3350 
u
 = 
r
->
up¡»am
;

3351 
p
 = 
u
->
pe
;

3353 ià(
u
->
³”
.
cÚÃùiÚ
) {

3355 ià(
u
->
¡Üe
) {

3357 ià(
p
->
up¡»am_eof
 ||…->
up¡»am_dÚe
) {

3359 
tf
 = 
p
->
‹mp_fže
;

3361 ià(
u
->
h—d”s_š
.
¡©us_n
 =ð
NGX_HTTP_OK


3362 && (
p
->
up¡»am_dÚe
 ||…->
Ëngth
 == -1)

3363 && (
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 == -1

3364 || 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 =ð
tf
->
off£t
))

3366 
	`ngx_h‰p_up¡»am_¡Üe
(
r
, 
u
);

3371 #ià(
NGX_HTTP_CACHE
)

3373 ià(
u
->
ÿch—bË
) {

3375 ià(
p
->
up¡»am_dÚe
) {

3376 
	`ngx_h‰p_fže_ÿche_upd©e
(
r
, 
p
->
‹mp_fže
);

3378 } ià(
p
->
up¡»am_eof
) {

3380 
tf
 = 
p
->
‹mp_fže
;

3382 ià(
p
->
Ëngth
 == -1

3383 && (
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 == -1

3384 || 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n


3385 =ð
tf
->
off£t
 - (
off_t
è
r
->
ÿche
->
body_¡¬t
))

3387 
	`ngx_h‰p_fže_ÿche_upd©e
(
r
, 
tf
);

3390 
	`ngx_h‰p_fže_ÿche_ä“
(
r
->
ÿche
, 
tf
);

3393 } ià(
p
->
up¡»am_”rÜ
) {

3394 
	`ngx_h‰p_fže_ÿche_ä“
(
r
->
ÿche
, 
p
->
‹mp_fže
);

3400 ià(
p
->
up¡»am_dÚe
 ||…->
up¡»am_eof
 ||…->
up¡»am_”rÜ
) {

3401 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3402 "h‰°up¡»amƒx™: %p", 
p
->
out
);

3404 ià(
p
->
up¡»am_dÚe


3405 || (
p
->
up¡»am_eof
 &&…->
Ëngth
 == -1))

3407 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 0);

3411 ià(
p
->
up¡»am_eof
) {

3412 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

3416 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_HTTP_BAD_GATEWAY
);

3421 ià(
p
->
down¡»am_”rÜ
) {

3422 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3425 ià(!
u
->
ÿch—bË
 && !u->
¡Üe
 && u->
³”
.
cÚÃùiÚ
) {

3426 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
NGX_ERROR
);

3429 
	}
}

3433 
	$ngx_h‰p_up¡»am_¡Üe
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

3435 
size_t
 
roÙ
;

3436 
time_t
 
lm
;

3437 
ngx_¡r_t
 
·th
;

3438 
ngx_‹mp_fže_t
 *
tf
;

3439 
ngx_ext_»Çme_fže_t
 
ext
;

3441 
tf
 = 
u
->
pe
->
‹mp_fže
;

3443 ià(
tf
->
fže
.
fd
 =ð
NGX_INVALID_FILE
) {

3447 
tf
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_‹mp_fže_t
));

3448 ià(
tf
 =ð
NULL
) {

3452 
tf
->
fže
.
fd
 = 
NGX_INVALID_FILE
;

3453 
tf
->
fže
.
log
 = 
r
->
cÚÃùiÚ
->log;

3454 
tf
->
·th
 = 
u
->
cÚf
->
‹mp_·th
;

3455 
tf
->
poÞ
 = 
r
->pool;

3456 
tf
->
³rsi¡’t
 = 1;

3458 ià(
	`ngx_ü—‹_‹mp_fže
(&
tf
->
fže
,f->
·th
,f->
poÞ
,

3459 
tf
->
³rsi¡’t
,f->
þ—n
,f->
acûss
)

3460 !ð
NGX_OK
)

3465 
u
->
pe
->
‹mp_fže
 = 
tf
;

3468 
ext
.
acûss
 = 
u
->
cÚf
->
¡Üe_acûss
;

3469 
ext
.
·th_acûss
 = 
u
->
cÚf
->
¡Üe_acûss
;

3470 
ext
.
time
 = -1;

3471 
ext
.
ü—‹_·th
 = 1;

3472 
ext
.
d–‘e_fže
 = 1;

3473 
ext
.
log
 = 
r
->
cÚÃùiÚ
->log;

3475 ià(
u
->
h—d”s_š
.
Ï¡_modif›d
) {

3477 
lm
 = 
	`ngx_h‰p_·r£_time
(
u
->
h—d”s_š
.
Ï¡_modif›d
->
v®ue
.
d©a
,

3478 
u
->
h—d”s_š
.
Ï¡_modif›d
->
v®ue
.
Ën
);

3480 ià(
lm
 !ð
NGX_ERROR
) {

3481 
ext
.
time
 = 
lm
;

3482 
ext
.
fd
 = 
tf
->
fže
.fd;

3486 ià(
u
->
cÚf
->
¡Üe_Ëngths
 =ð
NULL
) {

3488 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0è=ð
NULL
) {

3493 ià(
	`ngx_h‰p_süt_run
(
r
, &
·th
, 
u
->
cÚf
->
¡Üe_Ëngths
->
–ts
, 0,

3494 
u
->
cÚf
->
¡Üe_v®ues
->
–ts
)

3495 =ð
NULL
)

3501 
·th
.
Ën
--;

3503 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3505 
tf
->
fže
.
Çme
.
d©a
, 
·th
.data);

3507 (è
	`ngx_ext_»Çme_fže
(&
tf
->
fže
.
Çme
, &
·th
, &
ext
);

3509 
u
->
¡Üe
 = 0;

3510 
	}
}

3514 
	$ngx_h‰p_up¡»am_dummy_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
)

3516 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3518 
	}
}

3522 
	$ngx_h‰p_up¡»am_Ãxt
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_up¡»am_t
 *
u
,

3523 
ngx_ušt_t
 
á_ty³
)

3525 
ngx_m£c_t
 
timeout
;

3526 
ngx_ušt_t
 
¡©us
, 
¡©e
;

3528 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3529 "h‰°Ãxˆup¡»am, %xi", 
á_ty³
);

3531 ià(
u
->
³”
.
sockaddr
) {

3533 ià(
á_ty³
 =ð
NGX_HTTP_UPSTREAM_FT_HTTP_403


3534 || 
á_ty³
 =ð
NGX_HTTP_UPSTREAM_FT_HTTP_404
)

3536 
¡©e
 = 
NGX_PEER_NEXT
;

3539 
¡©e
 = 
NGX_PEER_FAILED
;

3542 
u
->
³”
.
	`ä“
(&u->³”, u->³”.
d©a
, 
¡©e
);

3543 
u
->
³”
.
sockaddr
 = 
NULL
;

3546 ià(
á_ty³
 =ð
NGX_HTTP_UPSTREAM_FT_TIMEOUT
) {

3547 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 
NGX_ETIMEDOUT
,

3551 ià(
u
->
³”
.
ÿched
 && 
á_ty³
 =ð
NGX_HTTP_UPSTREAM_FT_ERROR
) {

3552 
¡©us
 = 0;

3556 
u
->
³”
.
Œ›s
++;

3559 
á_ty³
) {

3561 
NGX_HTTP_UPSTREAM_FT_TIMEOUT
:

3562 
¡©us
 = 
NGX_HTTP_GATEWAY_TIME_OUT
;

3565 
NGX_HTTP_UPSTREAM_FT_HTTP_500
:

3566 
¡©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

3569 
NGX_HTTP_UPSTREAM_FT_HTTP_403
:

3570 
¡©us
 = 
NGX_HTTP_FORBIDDEN
;

3573 
NGX_HTTP_UPSTREAM_FT_HTTP_404
:

3574 
¡©us
 = 
NGX_HTTP_NOT_FOUND
;

3583 
¡©us
 = 
NGX_HTTP_BAD_GATEWAY
;

3587 ià(
r
->
cÚÃùiÚ
->
”rÜ
) {

3588 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
,

3589 
NGX_HTTP_CLIENT_CLOSED_REQUEST
);

3593 ià(
¡©us
) {

3594 
u
->
¡©e
->
¡©us
 = status;

3595 
timeout
 = 
u
->
cÚf
->
Ãxt_up¡»am_timeout
;

3597 ià(
u
->
³”
.
Œ›s
 == 0

3598 || !(
u
->
cÚf
->
Ãxt_up¡»am
 & 
á_ty³
)

3599 || (
timeout
 && 
ngx_cu¼’t_m£c
 - 
u
->
³”
.
¡¬t_time
 >=imeout))

3601 #ià(
NGX_HTTP_CACHE
)

3603 ià(
u
->
ÿche_¡©us
 =ð
NGX_HTTP_CACHE_EXPIRED


3604 && (
u
->
cÚf
->
ÿche_u£_¡®e
 & 
á_ty³
))

3606 
ngx_št_t
 
rc
;

3608 
rc
 = 
u
->
	`»š™_»que¡
(
r
);

3610 ià(
rc
 =ð
NGX_OK
) {

3611 
u
->
ÿche_¡©us
 = 
NGX_HTTP_CACHE_STALE
;

3612 
rc
 = 
	`ngx_h‰p_up¡»am_ÿche_£nd
(
r
, 
u
);

3615 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
rc
);

3620 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
, 
u
, 
¡©us
);

3625 ià(
u
->
³”
.
cÚÃùiÚ
) {

3626 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3628 
u
->
³”
.
cÚÃùiÚ
->
fd
);

3629 #ià(
NGX_HTTP_SSL
)

3631 ià(
u
->
³”
.
cÚÃùiÚ
->
s¦
) {

3632 
u
->
³”
.
cÚÃùiÚ
->
s¦
->
no_wa™_shutdown
 = 1;

3633 
u
->
³”
.
cÚÃùiÚ
->
s¦
->
no_£nd_shutdown
 = 1;

3635 (è
	`ngx_s¦_shutdown
(
u
->
³”
.
cÚÃùiÚ
);

3639 ià(
u
->
³”
.
cÚÃùiÚ
->
poÞ
) {

3640 
	`ngx_de¡roy_poÞ
(
u
->
³”
.
cÚÃùiÚ
->
poÞ
);

3643 
	`ngx_þo£_cÚÃùiÚ
(
u
->
³”
.
cÚÃùiÚ
);

3644 
u
->
³”
.
cÚÃùiÚ
 = 
NULL
;

3647 
	`ngx_h‰p_up¡»am_cÚÃù
(
r
, 
u
);

3648 
	}
}

3652 
	$ngx_h‰p_up¡»am_þ—nup
(*
d©a
)

3654 
ngx_h‰p_»que¡_t
 *
r
 = 
d©a
;

3656 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3657 "þ—nu°h‰°up¡»am„eque¡: \"%V\"", &
r
->
uri
);

3659 
	`ngx_h‰p_up¡»am_fš®ize_»que¡
(
r
,„->
up¡»am
, 
NGX_DONE
);

3660 
	}
}

3664 
	$ngx_h‰p_up¡»am_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

3665 
ngx_h‰p_up¡»am_t
 *
u
, 
ngx_št_t
 
rc
)

3667 
ngx_ušt_t
 
æush
;

3668 
ngx_time_t
 *

;

3670 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3671 "fš®izh‰°up¡»am„eque¡: %i", 
rc
);

3673 ià(
u
->
þ—nup
) {

3674 *
u
->
þ—nup
 = 
NULL
;

3675 
u
->
þ—nup
 = 
NULL
;

3678 ià(
u
->
»sÞved
 && u->»sÞved->
ùx
) {

3679 
	`ngx_»sÞve_Çme_dÚe
(
u
->
»sÞved
->
ùx
);

3680 
u
->
»sÞved
->
ùx
 = 
NULL
;

3683 ià(
u
->
¡©e
 && u->¡©e->
»¥Ú£_£c
) {

3684 

 = 
	`ngx_timeofday
();

3685 
u
->
¡©e
->
»¥Ú£_£c
 = 

->
£c
 - u->state->response_sec;

3686 
u
->
¡©e
->
»¥Ú£_m£c
 = 

->
m£c
 - u->state->response_msec;

3688 ià(
u
->
pe
 && u->pe->
»ad_Ëngth
) {

3689 
u
->
¡©e
->
»¥Ú£_Ëngth
 = u->
pe
->
»ad_Ëngth
;

3693 
u
->
	`fš®ize_»que¡
(
r
, 
rc
);

3695 ià(
u
->
³”
.
ä“
 && u->³”.
sockaddr
) {

3696 
u
->
³”
.
	`ä“
(&u->³”, u->³”.
d©a
, 0);

3697 
u
->
³”
.
sockaddr
 = 
NULL
;

3700 ià(
u
->
³”
.
cÚÃùiÚ
) {

3702 #ià(
NGX_HTTP_SSL
)

3706 ià(
u
->
³”
.
cÚÃùiÚ
->
s¦
) {

3714 
u
->
³”
.
cÚÃùiÚ
->
s¦
->
no_wa™_shutdown
 = 1;

3716 (è
	`ngx_s¦_shutdown
(
u
->
³”
.
cÚÃùiÚ
);

3720 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3722 
u
->
³”
.
cÚÃùiÚ
->
fd
);

3724 ià(
u
->
³”
.
cÚÃùiÚ
->
poÞ
) {

3725 
	`ngx_de¡roy_poÞ
(
u
->
³”
.
cÚÃùiÚ
->
poÞ
);

3728 
	`ngx_þo£_cÚÃùiÚ
(
u
->
³”
.
cÚÃùiÚ
);

3731 
u
->
³”
.
cÚÃùiÚ
 = 
NULL
;

3733 ià(
u
->
pe
 && u->pe->
‹mp_fže
) {

3734 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

3736 
u
->
pe
->
‹mp_fže
->
fže
.
fd
);

3739 ià(
u
->
¡Üe
 && u->
pe
 && u->pe->
‹mp_fže


3740 && 
u
->
pe
->
‹mp_fže
->
fže
.
fd
 !ð
NGX_INVALID_FILE
)

3742 ià(
	`ngx_d–‘e_fže
(
u
->
pe
->
‹mp_fže
->
fže
.
Çme
.
d©a
)

3743 =ð
NGX_FILE_ERROR
)

3745 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

3746 
ngx_d–‘e_fže_n
 " \"%s\" failed",

3747 
u
->
pe
->
‹mp_fže
->
fže
.
Çme
.
d©a
);

3751 #ià(
NGX_HTTP_CACHE
)

3753 ià(
r
->
ÿche
) {

3755 ià(
u
->
ÿch—bË
) {

3757 ià(
rc
 =ð
NGX_HTTP_BAD_GATEWAY
 ||„ø=ð
NGX_HTTP_GATEWAY_TIME_OUT
) {

3758 
time_t
 
v®id
;

3760 
v®id
 = 
	`ngx_h‰p_fže_ÿche_v®id
(
u
->
cÚf
->
ÿche_v®id
, 
rc
);

3762 ià(
v®id
) {

3763 
r
->
ÿche
->
v®id_£c
 = 
	`ngx_time
(è+ 
v®id
;

3764 
r
->
ÿche
->
”rÜ
 = 
rc
;

3769 
	`ngx_h‰p_fže_ÿche_ä“
(
r
->
ÿche
, 
u
->
pe
->
‹mp_fže
);

3774 ià(
r
->
sub»que¡_š_memÜy


3775 && 
u
->
h—d”s_š
.
¡©us_n
 >ð
NGX_HTTP_SPECIAL_RESPONSE
)

3777 
u
->
bufãr
.
Ï¡
 = u->bufãr.
pos
;

3780 ià(
rc
 =ð
NGX_DECLINED
) {

3784 
r
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sendingo client";

3786 ià(!
u
->
h—d”_£Á


3787 || 
rc
 =ð
NGX_HTTP_REQUEST_TIME_OUT


3788 || 
rc
 =ð
NGX_HTTP_CLIENT_CLOSED_REQUEST
)

3790 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

3794 
æush
 = 0;

3796 ià(
rc
 >ð
NGX_HTTP_SPECIAL_RESPONSE
) {

3797 
rc
 = 
NGX_ERROR
;

3798 
æush
 = 1;

3801 ià(
r
->
h—d”_Úly
) {

3802 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

3806 ià(
rc
 == 0) {

3807 
rc
 = 
	`ngx_h‰p_£nd_¥ecŸl
(
r
, 
NGX_HTTP_LAST
);

3809 } ià(
æush
) {

3810 
r
->
k“·live
 = 0;

3811 
rc
 = 
	`ngx_h‰p_£nd_¥ecŸl
(
r
, 
NGX_HTTP_FLUSH
);

3814 
	`ngx_h‰p_fš®ize_»que¡
(
r
, 
rc
);

3815 
	}
}

3818 
ngx_št_t


3819 
	$ngx_h‰p_up¡»am_´oûss_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

3820 
ngx_ušt_t
 
off£t
)

3822 
ngx_bË_–t_t
 **
ph
;

3824 
ph
 = (
ngx_bË_–t_t
 **è((*è&
r
->
up¡»am
->
h—d”s_š
 + 
off£t
);

3826 ià(*
ph
 =ð
NULL
) {

3827 *
ph
 = 
h
;

3830  
NGX_OK
;

3831 
	}
}

3834 
ngx_št_t


3835 
	$ngx_h‰p_up¡»am_ignÜe_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

3836 
ngx_ušt_t
 
off£t
)

3838  
NGX_OK
;

3839 
	}
}

3842 
ngx_št_t


3843 
	$ngx_h‰p_up¡»am_´oûss_cÚ‹Á_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
,

3844 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

3846 
ngx_h‰p_up¡»am_t
 *
u
;

3848 
u
 = 
r
->
up¡»am
;

3850 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth
 = 
h
;

3851 
u
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 = 
	`ngx_©oof
(
h
->
v®ue
.
d©a
, h->v®ue.
Ën
);

3853  
NGX_OK
;

3854 
	}
}

3857 
ngx_št_t


3858 
	$ngx_h‰p_up¡»am_´oûss_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
,

3859 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

3861 
ngx_h‰p_up¡»am_t
 *
u
;

3863 
u
 = 
r
->
up¡»am
;

3865 
u
->
h—d”s_š
.
Ï¡_modif›d
 = 
h
;

3867 #ià(
NGX_HTTP_CACHE
)

3869 ià(
u
->
ÿch—bË
) {

3870 
u
->
h—d”s_š
.
Ï¡_modif›d_time
 = 
	`ngx_h‰p_·r£_time
(
h
->
v®ue
.
d©a
,

3871 
h
->
v®ue
.
Ën
);

3876  
NGX_OK
;

3877 
	}
}

3880 
ngx_št_t


3881 
	$ngx_h‰p_up¡»am_´oûss_£t_cook›
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

3882 
ngx_ušt_t
 
off£t
)

3884 
ngx_¬¿y_t
 *
·
;

3885 
ngx_bË_–t_t
 **
ph
;

3886 
ngx_h‰p_up¡»am_t
 *
u
;

3888 
u
 = 
r
->
up¡»am
;

3889 
·
 = &
u
->
h—d”s_š
.
cook›s
;

3891 ià(
·
->
–ts
 =ð
NULL
) {

3892 ià(
	`ngx_¬¿y_š™
(
·
, 
r
->
poÞ
, 1, (
ngx_bË_–t_t
 *)è!ð
NGX_OK
)

3894  
NGX_ERROR
;

3898 
ph
 = 
	`ngx_¬¿y_push
(
·
);

3899 ià(
ph
 =ð
NULL
) {

3900  
NGX_ERROR
;

3903 *
ph
 = 
h
;

3905 #ià(
NGX_HTTP_CACHE
)

3906 ià(!(
u
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_SET_COOKIE
)) {

3907 
u
->
ÿch—bË
 = 0;

3911  
NGX_OK
;

3912 
	}
}

3915 
ngx_št_t


3916 
	$ngx_h‰p_up¡»am_´oûss_ÿche_cÚŒÞ
(
ngx_h‰p_»que¡_t
 *
r
,

3917 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

3919 
ngx_¬¿y_t
 *
·
;

3920 
ngx_bË_–t_t
 **
ph
;

3921 
ngx_h‰p_up¡»am_t
 *
u
;

3923 
u
 = 
r
->
up¡»am
;

3924 
·
 = &
u
->
h—d”s_š
.
ÿche_cÚŒÞ
;

3926 ià(
·
->
–ts
 =ð
NULL
) {

3927 ià(
	`ngx_¬¿y_š™
(
·
, 
r
->
poÞ
, 2, (
ngx_bË_–t_t
 *)è!ð
NGX_OK
)

3929  
NGX_ERROR
;

3933 
ph
 = 
	`ngx_¬¿y_push
(
·
);

3934 ià(
ph
 =ð
NULL
) {

3935  
NGX_ERROR
;

3938 *
ph
 = 
h
;

3940 #ià(
NGX_HTTP_CACHE
)

3942 
u_ch¬
 *
p
, *
¡¬t
, *
Ï¡
;

3943 
ngx_št_t
 
n
;

3945 ià(
u
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_CACHE_CONTROL
) {

3946  
NGX_OK
;

3949 ià(
r
->
ÿche
 =ð
NULL
) {

3950  
NGX_OK
;

3953 ià(
r
->
ÿche
->
v®id_£c
 !ð0 && 
u
->
h—d”s_š
.
x_acûl_expœes
 !ð
NULL
) {

3954  
NGX_OK
;

3957 
¡¬t
 = 
h
->
v®ue
.
d©a
;

3958 
Ï¡
 = 
¡¬t
 + 
h
->
v®ue
.
Ën
;

3960 ià(
	`ngx_¡¾ÿ£¡º
(
¡¬t
, 
Ï¡
, (
u_ch¬
 *è"no-ÿche", 8 - 1è!ð
NULL


3961 || 
	`ngx_¡¾ÿ£¡º
(
¡¬t
, 
Ï¡
, (
u_ch¬
 *è"no-¡Üe", 8 - 1è!ð
NULL


3962 || 
	`ngx_¡¾ÿ£¡º
(
¡¬t
, 
Ï¡
, (
u_ch¬
 *è"´iv©e", 7 - 1è!ð
NULL
)

3964 
u
->
ÿch—bË
 = 0;

3965  
NGX_OK
;

3968 
p
 = 
	`ngx_¡¾ÿ£¡º
(
¡¬t
, 
Ï¡
, (
u_ch¬
 *) "s-maxage=", 9 - 1);

3969 
off£t
 = 9;

3971 ià(
p
 =ð
NULL
) {

3972 
p
 = 
	`ngx_¡¾ÿ£¡º
(
¡¬t
, 
Ï¡
, (
u_ch¬
 *) "max-age=", 8 - 1);

3973 
off£t
 = 8;

3976 ià(
p
 =ð
NULL
) {

3977  
NGX_OK
;

3980 
n
 = 0;

3982 
p
 +ð
off£t
;… < 
Ï¡
;…++) {

3983 ià(*
p
 == ',' || *p == ';' || *p == ' ') {

3987 ià(*
p
 >= '0' && *p <= '9') {

3988 
n
 =‚ * 10 + *
p
 - '0';

3992 
u
->
ÿch—bË
 = 0;

3993  
NGX_OK
;

3996 ià(
n
 == 0) {

3997 
u
->
ÿch—bË
 = 0;

3998  
NGX_OK
;

4001 
r
->
ÿche
->
v®id_£c
 = 
	`ngx_time
(è+ 
n
;

4005  
NGX_OK
;

4006 
	}
}

4009 
ngx_št_t


4010 
	$ngx_h‰p_up¡»am_´oûss_expœes
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4011 
ngx_ušt_t
 
off£t
)

4013 
ngx_h‰p_up¡»am_t
 *
u
;

4015 
u
 = 
r
->
up¡»am
;

4016 
u
->
h—d”s_š
.
expœes
 = 
h
;

4018 #ià(
NGX_HTTP_CACHE
)

4020 
time_t
 
expœes
;

4022 ià(
u
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_EXPIRES
) {

4023  
NGX_OK
;

4026 ià(
r
->
ÿche
 =ð
NULL
) {

4027  
NGX_OK
;

4030 ià(
r
->
ÿche
->
v®id_£c
 != 0) {

4031  
NGX_OK
;

4034 
expœes
 = 
	`ngx_h‰p_·r£_time
(
h
->
v®ue
.
d©a
, h->v®ue.
Ën
);

4036 ià(
expœes
 =ð
NGX_ERROR
 ||ƒxpœe < 
	`ngx_time
()) {

4037 
u
->
ÿch—bË
 = 0;

4038  
NGX_OK
;

4041 
r
->
ÿche
->
v®id_£c
 = 
expœes
;

4045  
NGX_OK
;

4046 
	}
}

4049 
ngx_št_t


4050 
	$ngx_h‰p_up¡»am_´oûss_acûl_expœes
(
ngx_h‰p_»que¡_t
 *
r
,

4051 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

4053 
ngx_h‰p_up¡»am_t
 *
u
;

4055 
u
 = 
r
->
up¡»am
;

4056 
u
->
h—d”s_š
.
x_acûl_expœes
 = 
h
;

4058 #ià(
NGX_HTTP_CACHE
)

4060 
u_ch¬
 *
p
;

4061 
size_t
 
Ën
;

4062 
ngx_št_t
 
n
;

4064 ià(
u
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_XA_EXPIRES
) {

4065  
NGX_OK
;

4068 ià(
r
->
ÿche
 =ð
NULL
) {

4069  
NGX_OK
;

4072 
Ën
 = 
h
->
v®ue
.len;

4073 
p
 = 
h
->
v®ue
.
d©a
;

4075 ià(
p
[0] != '@') {

4076 
n
 = 
	`ngx_©oi
(
p
, 
Ën
);

4078 
n
) {

4080 
u
->
ÿch—bË
 = 0;

4083 
NGX_ERROR
:

4084  
NGX_OK
;

4087 
r
->
ÿche
->
v®id_£c
 = 
	`ngx_time
(è+ 
n
;

4088  
NGX_OK
;

4092 
p
++;

4093 
Ën
--;

4095 
n
 = 
	`ngx_©oi
(
p
, 
Ën
);

4097 ià(
n
 !ð
NGX_ERROR
) {

4098 
r
->
ÿche
->
v®id_£c
 = 
n
;

4103  
NGX_OK
;

4104 
	}
}

4107 
ngx_št_t


4108 
	$ngx_h‰p_up¡»am_´oûss_lim™_¿‹
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4109 
ngx_ušt_t
 
off£t
)

4111 
ngx_št_t
 
n
;

4112 
ngx_h‰p_up¡»am_t
 *
u
;

4114 
u
 = 
r
->
up¡»am
;

4115 
u
->
h—d”s_š
.
x_acûl_lim™_¿‹
 = 
h
;

4117 ià(
u
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_XA_LIMIT_RATE
) {

4118  
NGX_OK
;

4121 
n
 = 
	`ngx_©oi
(
h
->
v®ue
.
d©a
, h->v®ue.
Ën
);

4123 ià(
n
 !ð
NGX_ERROR
) {

4124 
r
->
lim™_¿‹
 = (
size_t
è
n
;

4127  
NGX_OK
;

4128 
	}
}

4131 
ngx_št_t


4132 
	$ngx_h‰p_up¡»am_´oûss_bufãršg
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4133 
ngx_ušt_t
 
off£t
)

4135 
u_ch¬
 
c0
, 
c1
, 
c2
;

4136 
ngx_h‰p_up¡»am_t
 *
u
;

4138 
u
 = 
r
->
up¡»am
;

4140 ià(
u
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_XA_BUFFERING
) {

4141  
NGX_OK
;

4144 ià(
u
->
cÚf
->
chªge_bufãršg
) {

4146 ià(
h
->
v®ue
.
Ën
 == 2) {

4147 
c0
 = 
	`ngx_tÞow”
(
h
->
v®ue
.
d©a
[0]);

4148 
c1
 = 
	`ngx_tÞow”
(
h
->
v®ue
.
d©a
[1]);

4150 ià(
c0
 =ð'n' && 
c1
 == 'o') {

4151 
u
->
bufãršg
 = 0;

4154 } ià(
h
->
v®ue
.
Ën
 == 3) {

4155 
c0
 = 
	`ngx_tÞow”
(
h
->
v®ue
.
d©a
[0]);

4156 
c1
 = 
	`ngx_tÞow”
(
h
->
v®ue
.
d©a
[1]);

4157 
c2
 = 
	`ngx_tÞow”
(
h
->
v®ue
.
d©a
[2]);

4159 ià(
c0
 =ð'y' && 
c1
 =ð'e' && 
c2
 == 's') {

4160 
u
->
bufãršg
 = 1;

4165  
NGX_OK
;

4166 
	}
}

4169 
ngx_št_t


4170 
	$ngx_h‰p_up¡»am_´oûss_ch¬£t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4171 
ngx_ušt_t
 
off£t
)

4173 ià(
r
->
up¡»am
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_XA_CHARSET
) {

4174  
NGX_OK
;

4177 
r
->
h—d”s_out
.
ov”ride_ch¬£t
 = &
h
->
v®ue
;

4179  
NGX_OK
;

4180 
	}
}

4183 
ngx_št_t


4184 
	$ngx_h‰p_up¡»am_´oûss_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4185 
ngx_ušt_t
 
off£t
)

4187 
r
->
up¡»am
->
h—d”s_š
.
cÚÃùiÚ
 = 
h
;

4189 ià(
	`ngx_¡¾ÿ£¡º
(
h
->
v®ue
.
d©a
, h->v®ue.d©¨+ h->v®ue.
Ën
,

4190 (
u_ch¬
 *) "close", 5 - 1)

4191 !ð
NULL
)

4193 
r
->
up¡»am
->
h—d”s_š
.
cÚÃùiÚ_þo£
 = 1;

4196  
NGX_OK
;

4197 
	}
}

4200 
ngx_št_t


4201 
	$ngx_h‰p_up¡»am_´oûss_Œªsãr_’codšg
(
ngx_h‰p_»que¡_t
 *
r
,

4202 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

4204 
r
->
up¡»am
->
h—d”s_š
.
Œªsãr_’codšg
 = 
h
;

4206 ià(
	`ngx_¡¾ÿ£¡º
(
h
->
v®ue
.
d©a
, h->v®ue.d©¨+ h->v®ue.
Ën
,

4207 (
u_ch¬
 *) "chunked", 7 - 1)

4208 !ð
NULL
)

4210 
r
->
up¡»am
->
h—d”s_š
.
chunked
 = 1;

4213  
NGX_OK
;

4214 
	}
}

4217 
ngx_št_t


4218 
	$ngx_h‰p_up¡»am_´oûss_v¬y
(
ngx_h‰p_»que¡_t
 *
r
,

4219 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

4221 
ngx_h‰p_up¡»am_t
 *
u
;

4223 
u
 = 
r
->
up¡»am
;

4224 
u
->
h—d”s_š
.
v¬y
 = 
h
;

4226 #ià(
NGX_HTTP_CACHE
)

4228 ià(
u
->
cÚf
->
ignÜe_h—d”s
 & 
NGX_HTTP_UPSTREAM_IGN_VARY
) {

4229  
NGX_OK
;

4232 ià(
r
->
ÿche
 =ð
NULL
) {

4233  
NGX_OK
;

4236 ià(
h
->
v®ue
.
Ën
 > 
NGX_HTTP_CACHE_VARY_LEN


4237 || (
h
->
v®ue
.
Ën
 =ð1 && h->v®ue.
d©a
[0] == '*'))

4239 
u
->
ÿch—bË
 = 0;

4242 
r
->
ÿche
->
v¬y
 = 
h
->
v®ue
;

4246  
NGX_OK
;

4247 
	}
}

4250 
ngx_št_t


4251 
	$ngx_h‰p_up¡»am_cÝy_h—d”_lše
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4252 
ngx_ušt_t
 
off£t
)

4254 
ngx_bË_–t_t
 *
ho
, **
ph
;

4256 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

4257 ià(
ho
 =ð
NULL
) {

4258  
NGX_ERROR
;

4261 *
ho
 = *
h
;

4263 ià(
off£t
) {

4264 
ph
 = (
ngx_bË_–t_t
 **è((*è&
r
->
h—d”s_out
 + 
off£t
);

4265 *
ph
 = 
ho
;

4268  
NGX_OK
;

4269 
	}
}

4272 
ngx_št_t


4273 
	$ngx_h‰p_up¡»am_cÝy_muÉi_h—d”_lšes
(
ngx_h‰p_»que¡_t
 *
r
,

4274 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

4276 
ngx_¬¿y_t
 *
·
;

4277 
ngx_bË_–t_t
 *
ho
, **
ph
;

4279 
·
 = (
ngx_¬¿y_t
 *è((*è&
r
->
h—d”s_out
 + 
off£t
);

4281 ià(
·
->
–ts
 =ð
NULL
) {

4282 ià(
	`ngx_¬¿y_š™
(
·
, 
r
->
poÞ
, 2, (
ngx_bË_–t_t
 *)è!ð
NGX_OK
)

4284  
NGX_ERROR
;

4288 
ph
 = 
	`ngx_¬¿y_push
(
·
);

4289 ià(
ph
 =ð
NULL
) {

4290  
NGX_ERROR
;

4293 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

4294 ià(
ho
 =ð
NULL
) {

4295  
NGX_ERROR
;

4298 *
ho
 = *
h
;

4299 *
ph
 = 
ho
;

4301  
NGX_OK
;

4302 
	}
}

4305 
ngx_št_t


4306 
	$ngx_h‰p_up¡»am_cÝy_cÚ‹Á_ty³
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4307 
ngx_ušt_t
 
off£t
)

4309 
u_ch¬
 *
p
, *
Ï¡
;

4311 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = 
h
->
v®ue
.
Ën
;

4312 
r
->
h—d”s_out
.
cÚ‹Á_ty³
 = 
h
->
v®ue
;

4313 
r
->
h—d”s_out
.
cÚ‹Á_ty³_lowÿ£
 = 
NULL
;

4315 
p
 = 
h
->
v®ue
.
d©a
; *p;…++) {

4317 ià(*
p
 != ';') {

4321 
Ï¡
 = 
p
;

4323 *++
p
 == ' ') { }

4325 ià(*
p
 == '\0') {

4326  
NGX_OK
;

4329 ià(
	`ngx_¡ºÿ£cmp
(
p
, (
u_ch¬
 *) "charset=", 8) != 0) {

4333 
p
 += 8;

4335 
r
->
h—d”s_out
.
cÚ‹Á_ty³_Ën
 = 
Ï¡
 - 
h
->
v®ue
.
d©a
;

4337 ià(*
p
 == '"') {

4338 
p
++;

4341 
Ï¡
 = 
h
->
v®ue
.
d©a
 + h->v®ue.
Ën
;

4343 ià(*(
Ï¡
 - 1) == '"') {

4344 
Ï¡
--;

4347 
r
->
h—d”s_out
.
ch¬£t
.
Ën
 = 
Ï¡
 - 
p
;

4348 
r
->
h—d”s_out
.
ch¬£t
.
d©a
 = 
p
;

4350  
NGX_OK
;

4353  
NGX_OK
;

4354 
	}
}

4357 
ngx_št_t


4358 
	$ngx_h‰p_up¡»am_cÝy_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4359 
ngx_ušt_t
 
off£t
)

4361 
ngx_bË_–t_t
 *
ho
;

4363 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

4364 ià(
ho
 =ð
NULL
) {

4365  
NGX_ERROR
;

4368 *
ho
 = *
h
;

4370 
r
->
h—d”s_out
.
Ï¡_modif›d
 = 
ho
;

4372 #ià(
NGX_HTTP_CACHE
)

4374 ià(
r
->
up¡»am
->
ÿch—bË
) {

4375 
r
->
h—d”s_out
.
Ï¡_modif›d_time
 =

4376 
r
->
up¡»am
->
h—d”s_š
.
Ï¡_modif›d_time
;

4381  
NGX_OK
;

4382 
	}
}

4385 
ngx_št_t


4386 
	$ngx_h‰p_up¡»am_»wr™e_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4387 
ngx_ušt_t
 
off£t
)

4389 
ngx_št_t
 
rc
;

4390 
ngx_bË_–t_t
 *
ho
;

4392 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

4393 ià(
ho
 =ð
NULL
) {

4394  
NGX_ERROR
;

4397 *
ho
 = *
h
;

4399 ià(
r
->
up¡»am
->
»wr™e_»dœeù
) {

4400 
rc
 = 
r
->
up¡»am
->
	`»wr™e_»dœeù
Ô, 
ho
, 0);

4402 ià(
rc
 =ð
NGX_DECLINED
) {

4403  
NGX_OK
;

4406 ià(
rc
 =ð
NGX_OK
) {

4407 
r
->
h—d”s_out
.
loÿtiÚ
 = 
ho
;

4409 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

4410 "»wr™‹ÀloÿtiÚ: \"%V\"", &
ho
->
v®ue
);

4413  
rc
;

4416 ià(
ho
->
v®ue
.
d©a
[0] != '/') {

4417 
r
->
h—d”s_out
.
loÿtiÚ
 = 
ho
;

4425  
NGX_OK
;

4426 
	}
}

4429 
ngx_št_t


4430 
	$ngx_h‰p_up¡»am_»wr™e_»äesh
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4431 
ngx_ušt_t
 
off£t
)

4433 
u_ch¬
 *
p
;

4434 
ngx_št_t
 
rc
;

4435 
ngx_bË_–t_t
 *
ho
;

4437 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

4438 ià(
ho
 =ð
NULL
) {

4439  
NGX_ERROR
;

4442 *
ho
 = *
h
;

4444 ià(
r
->
up¡»am
->
»wr™e_»dœeù
) {

4446 
p
 = 
	`ngx_¡rÿ£¡º
(
ho
->
v®ue
.
d©a
, "url=", 4 - 1);

4448 ià(
p
) {

4449 
rc
 = 
r
->
up¡»am
->
	`»wr™e_»dœeù
Ô, 
ho
, 
p
 + 4 - ho->
v®ue
.
d©a
);

4452  
NGX_OK
;

4455 ià(
rc
 =ð
NGX_DECLINED
) {

4456  
NGX_OK
;

4459 ià(
rc
 =ð
NGX_OK
) {

4460 
r
->
h—d”s_out
.
»äesh
 = 
ho
;

4462 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

4463 "»wr™‹À»äesh: \"%V\"", &
ho
->
v®ue
);

4466  
rc
;

4469 
r
->
h—d”s_out
.
»äesh
 = 
ho
;

4471  
NGX_OK
;

4472 
	}
}

4475 
ngx_št_t


4476 
	$ngx_h‰p_up¡»am_»wr™e_£t_cook›
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_bË_–t_t
 *
h
,

4477 
ngx_ušt_t
 
off£t
)

4479 
ngx_št_t
 
rc
;

4480 
ngx_bË_–t_t
 *
ho
;

4482 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

4483 ià(
ho
 =ð
NULL
) {

4484  
NGX_ERROR
;

4487 *
ho
 = *
h
;

4489 ià(
r
->
up¡»am
->
»wr™e_cook›
) {

4490 
rc
 = 
r
->
up¡»am
->
	`»wr™e_cook›
Ô, 
ho
);

4492 ià(
rc
 =ð
NGX_DECLINED
) {

4493  
NGX_OK
;

4496 #ià(
NGX_DEBUG
)

4497 ià(
rc
 =ð
NGX_OK
) {

4498 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

4499 "»wr™‹Àcook›: \"%V\"", &
ho
->
v®ue
);

4503  
rc
;

4506  
NGX_OK
;

4507 
	}
}

4510 
ngx_št_t


4511 
	$ngx_h‰p_up¡»am_cÝy_®low_¿nges
(
ngx_h‰p_»que¡_t
 *
r
,

4512 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

4514 
ngx_bË_–t_t
 *
ho
;

4516 ià(
r
->
up¡»am
->
cÚf
->
fÜû_¿nges
) {

4517  
NGX_OK
;

4520 #ià(
NGX_HTTP_CACHE
)

4522 ià(
r
->
ÿched
) {

4523 
r
->
®low_¿nges
 = 1;

4524  
NGX_OK
;

4527 ià(
r
->
up¡»am
->
ÿch—bË
) {

4528 
r
->
®low_¿nges
 = 1;

4529 
r
->
sšgË_¿nge
 = 1;

4530  
NGX_OK
;

4535 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

4536 ià(
ho
 =ð
NULL
) {

4537  
NGX_ERROR
;

4540 *
ho
 = *
h
;

4542 
r
->
h—d”s_out
.
acû±_¿nges
 = 
ho
;

4544  
NGX_OK
;

4545 
	}
}

4548 #ià(
NGX_HTTP_GZIP
)

4550 
ngx_št_t


4551 
	$ngx_h‰p_up¡»am_cÝy_cÚ‹Á_’codšg
(
ngx_h‰p_»que¡_t
 *
r
,

4552 
ngx_bË_–t_t
 *
h
, 
ngx_ušt_t
 
off£t
)

4554 
ngx_bË_–t_t
 *
ho
;

4556 
ho
 = 
	`ngx_li¡_push
(&
r
->
h—d”s_out
.
h—d”s
);

4557 ià(
ho
 =ð
NULL
) {

4558  
NGX_ERROR
;

4561 *
ho
 = *
h
;

4563 
r
->
h—d”s_out
.
cÚ‹Á_’codšg
 = 
ho
;

4565  
NGX_OK
;

4566 
	}
}

4571 
ngx_št_t


4572 
	$ngx_h‰p_up¡»am_add_v¬ŸbËs
(
ngx_cÚf_t
 *
cf
)

4574 
ngx_h‰p_v¬ŸbË_t
 *
v¬
, *
v
;

4576 
v
 = 
ngx_h‰p_up¡»am_v¬s
; v->
Çme
.
Ën
; v++) {

4577 
v¬
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
v
->
Çme
, v->
æags
);

4578 ià(
v¬
 =ð
NULL
) {

4579  
NGX_ERROR
;

4582 
v¬
->
g‘_hªdËr
 = 
v
->get_handler;

4583 
v¬
->
d©a
 = 
v
->data;

4586  
NGX_OK
;

4587 
	}
}

4590 
ngx_št_t


4591 
	$ngx_h‰p_up¡»am_addr_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

4592 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4594 
u_ch¬
 *
p
;

4595 
size_t
 
Ën
;

4596 
ngx_ušt_t
 
i
;

4597 
ngx_h‰p_up¡»am_¡©e_t
 *
¡©e
;

4599 
v
->
v®id
 = 1;

4600 
v
->
no_ÿch—bË
 = 0;

4601 
v
->
nÙ_found
 = 0;

4603 ià(
r
->
up¡»am_¡©es
 =ð
NULL
 ||„->up¡»am_¡©es->
ÃÉs
 == 0) {

4604 
v
->
nÙ_found
 = 1;

4605  
NGX_OK
;

4608 
Ën
 = 0;

4609 
¡©e
 = 
r
->
up¡»am_¡©es
->
–ts
;

4611 
i
 = 0; i < 
r
->
up¡»am_¡©es
->
ÃÉs
; i++) {

4612 ià(
¡©e
[
i
].
³”
) {

4613 
Ën
 +ð
¡©e
[
i
].
³”
->len + 2;

4616 
Ën
 += 3;

4620 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

4621 ià(
p
 =ð
NULL
) {

4622  
NGX_ERROR
;

4625 
v
->
d©a
 = 
p
;

4627 
i
 = 0;

4630 ià(
¡©e
[
i
].
³”
) {

4631 
p
 = 
	`ngx_ýymem
Õ, 
¡©e
[
i
].
³”
->
d©a
, s‹[i].³”->
Ën
);

4634 ià(++
i
 =ð
r
->
up¡»am_¡©es
->
ÃÉs
) {

4638 ià(
¡©e
[
i
].
³”
) {

4639 *
p
++ = ',';

4640 *
p
++ = ' ';

4643 *
p
++ = ' ';

4644 *
p
++ = ':';

4645 *
p
++ = ' ';

4647 ià(++
i
 =ð
r
->
up¡»am_¡©es
->
ÃÉs
) {

4655 
v
->
Ën
 = 
p
 - v->
d©a
;

4657  
NGX_OK
;

4658 
	}
}

4661 
ngx_št_t


4662 
	$ngx_h‰p_up¡»am_¡©us_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

4663 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4665 
u_ch¬
 *
p
;

4666 
size_t
 
Ën
;

4667 
ngx_ušt_t
 
i
;

4668 
ngx_h‰p_up¡»am_¡©e_t
 *
¡©e
;

4670 
v
->
v®id
 = 1;

4671 
v
->
no_ÿch—bË
 = 0;

4672 
v
->
nÙ_found
 = 0;

4674 ià(
r
->
up¡»am_¡©es
 =ð
NULL
 ||„->up¡»am_¡©es->
ÃÉs
 == 0) {

4675 
v
->
nÙ_found
 = 1;

4676  
NGX_OK
;

4679 
Ën
 = 
r
->
up¡»am_¡©es
->
ÃÉs
 * (3 + 2);

4681 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

4682 ià(
p
 =ð
NULL
) {

4683  
NGX_ERROR
;

4686 
v
->
d©a
 = 
p
;

4688 
i
 = 0;

4689 
¡©e
 = 
r
->
up¡»am_¡©es
->
–ts
;

4692 ià(
¡©e
[
i
].
¡©us
) {

4693 
p
 = 
	`ngx_¥rštf
Õ, "%ui", 
¡©e
[
i
].
¡©us
);

4696 *
p
++ = '-';

4699 ià(++
i
 =ð
r
->
up¡»am_¡©es
->
ÃÉs
) {

4703 ià(
¡©e
[
i
].
³”
) {

4704 *
p
++ = ',';

4705 *
p
++ = ' ';

4708 *
p
++ = ' ';

4709 *
p
++ = ':';

4710 *
p
++ = ' ';

4712 ià(++
i
 =ð
r
->
up¡»am_¡©es
->
ÃÉs
) {

4720 
v
->
Ën
 = 
p
 - v->
d©a
;

4722  
NGX_OK
;

4723 
	}
}

4726 
ngx_št_t


4727 
	$ngx_h‰p_up¡»am_»¥Ú£_time_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

4728 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4730 
u_ch¬
 *
p
;

4731 
size_t
 
Ën
;

4732 
ngx_ušt_t
 
i
;

4733 
ngx_m£c_št_t
 
ms
;

4734 
ngx_h‰p_up¡»am_¡©e_t
 *
¡©e
;

4736 
v
->
v®id
 = 1;

4737 
v
->
no_ÿch—bË
 = 0;

4738 
v
->
nÙ_found
 = 0;

4740 ià(
r
->
up¡»am_¡©es
 =ð
NULL
 ||„->up¡»am_¡©es->
ÃÉs
 == 0) {

4741 
v
->
nÙ_found
 = 1;

4742  
NGX_OK
;

4745 
Ën
 = 
r
->
up¡»am_¡©es
->
ÃÉs
 * (
NGX_TIME_T_LEN
 + 4 + 2);

4747 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

4748 ià(
p
 =ð
NULL
) {

4749  
NGX_ERROR
;

4752 
v
->
d©a
 = 
p
;

4754 
i
 = 0;

4755 
¡©e
 = 
r
->
up¡»am_¡©es
->
–ts
;

4758 ià(
¡©e
[
i
].
¡©us
) {

4759 
ms
 = (
ngx_m£c_št_t
)

4760 (
¡©e
[
i
].
»¥Ú£_£c
 * 1000 + s‹[i].
»¥Ú£_m£c
);

4761 
ms
 = 
	`ngx_max
(ms, 0);

4762 
p
 = 
	`ngx_¥rštf
Õ, "%T.%03M", (
time_t
è
ms
 / 1000, ms % 1000);

4765 *
p
++ = '-';

4768 ià(++
i
 =ð
r
->
up¡»am_¡©es
->
ÃÉs
) {

4772 ià(
¡©e
[
i
].
³”
) {

4773 *
p
++ = ',';

4774 *
p
++ = ' ';

4777 *
p
++ = ' ';

4778 *
p
++ = ':';

4779 *
p
++ = ' ';

4781 ià(++
i
 =ð
r
->
up¡»am_¡©es
->
ÃÉs
) {

4789 
v
->
Ën
 = 
p
 - v->
d©a
;

4791  
NGX_OK
;

4792 
	}
}

4795 
ngx_št_t


4796 
	$ngx_h‰p_up¡»am_»¥Ú£_Ëngth_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

4797 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4799 
u_ch¬
 *
p
;

4800 
size_t
 
Ën
;

4801 
ngx_ušt_t
 
i
;

4802 
ngx_h‰p_up¡»am_¡©e_t
 *
¡©e
;

4804 
v
->
v®id
 = 1;

4805 
v
->
no_ÿch—bË
 = 0;

4806 
v
->
nÙ_found
 = 0;

4808 ià(
r
->
up¡»am_¡©es
 =ð
NULL
 ||„->up¡»am_¡©es->
ÃÉs
 == 0) {

4809 
v
->
nÙ_found
 = 1;

4810  
NGX_OK
;

4813 
Ën
 = 
r
->
up¡»am_¡©es
->
ÃÉs
 * (
NGX_OFF_T_LEN
 + 2);

4815 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

4816 ià(
p
 =ð
NULL
) {

4817  
NGX_ERROR
;

4820 
v
->
d©a
 = 
p
;

4822 
i
 = 0;

4823 
¡©e
 = 
r
->
up¡»am_¡©es
->
–ts
;

4826 
p
 = 
	`ngx_¥rštf
Õ, "%O", 
¡©e
[
i
].
»¥Ú£_Ëngth
);

4828 ià(++
i
 =ð
r
->
up¡»am_¡©es
->
ÃÉs
) {

4832 ià(
¡©e
[
i
].
³”
) {

4833 *
p
++ = ',';

4834 *
p
++ = ' ';

4837 *
p
++ = ' ';

4838 *
p
++ = ':';

4839 *
p
++ = ' ';

4841 ià(++
i
 =ð
r
->
up¡»am_¡©es
->
ÃÉs
) {

4849 
v
->
Ën
 = 
p
 - v->
d©a
;

4851  
NGX_OK
;

4852 
	}
}

4855 
ngx_št_t


4856 
	$ngx_h‰p_up¡»am_h—d”_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

4857 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4859 ià(
r
->
up¡»am
 =ð
NULL
) {

4860 
v
->
nÙ_found
 = 1;

4861  
NGX_OK
;

4864  
	`ngx_h‰p_v¬ŸbË_unknown_h—d”
(
v
, (
ngx_¡r_t
 *è
d©a
,

4865 &
r
->
up¡»am
->
h—d”s_š
.
h—d”s
.
·¹
,

4867 
	}
}

4870 
ngx_št_t


4871 
	$ngx_h‰p_up¡»am_cook›_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
,

4872 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4874 
ngx_¡r_t
 *
Çme
 = (ngx_¡r_ˆ*è
d©a
;

4876 
ngx_¡r_t
 
cook›
, 
s
;

4878 ià(
r
->
up¡»am
 =ð
NULL
) {

4879 
v
->
nÙ_found
 = 1;

4880  
NGX_OK
;

4883 
s
.
Ën
 = 
Çme
->len - (("upstream_cookie_") - 1);

4884 
s
.
d©a
 = 
Çme
->data + ("upstream_cookie_") - 1;

4886 ià(
	`ngx_h‰p_·r£_£t_cook›_lšes
(&
r
->
up¡»am
->
h—d”s_š
.
cook›s
,

4887 &
s
, &
cook›
)

4888 =ð
NGX_DECLINED
)

4890 
v
->
nÙ_found
 = 1;

4891  
NGX_OK
;

4894 
v
->
Ën
 = 
cook›
.len;

4895 
v
->
v®id
 = 1;

4896 
v
->
no_ÿch—bË
 = 0;

4897 
v
->
nÙ_found
 = 0;

4898 
v
->
d©a
 = 
cook›
.data;

4900  
NGX_OK
;

4901 
	}
}

4904 #ià(
NGX_HTTP_CACHE
)

4906 
ngx_št_t


4907 
	$ngx_h‰p_up¡»am_ÿche_¡©us
(
ngx_h‰p_»que¡_t
 *
r
,

4908 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4910 
ngx_ušt_t
 
n
;

4912 ià(
r
->
up¡»am
 =ð
NULL
 ||„->up¡»am->
ÿche_¡©us
 == 0) {

4913 
v
->
nÙ_found
 = 1;

4914  
NGX_OK
;

4917 
n
 = 
r
->
up¡»am
->
ÿche_¡©us
 - 1;

4919 
v
->
v®id
 = 1;

4920 
v
->
no_ÿch—bË
 = 0;

4921 
v
->
nÙ_found
 = 0;

4922 
v
->
Ën
 = 
ngx_h‰p_ÿche_¡©us
[
n
].len;

4923 
v
->
d©a
 = 
ngx_h‰p_ÿche_¡©us
[
n
].data;

4925  
NGX_OK
;

4926 
	}
}

4929 
ngx_št_t


4930 
	$ngx_h‰p_up¡»am_ÿche_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
,

4931 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4933 
u_ch¬
 *
p
;

4935 ià(
r
->
up¡»am
 =ð
NULL


4936 || !
r
->
up¡»am
->
cÚf
->
ÿche_»v®id©e


4937 || 
r
->
up¡»am
->
ÿche_¡©us
 !ð
NGX_HTTP_CACHE_EXPIRED


4938 || 
r
->
ÿche
->
Ï¡_modif›d
 == -1)

4940 
v
->
nÙ_found
 = 1;

4941  
NGX_OK
;

4944 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, ("Mon, 28 Sep 1970 06:00:00 GMT") - 1);

4945 ià(
p
 =ð
NULL
) {

4946  
NGX_ERROR
;

4949 
v
->
Ën
 = 
	`ngx_h‰p_time
(
p
, 
r
->
ÿche
->
Ï¡_modif›d
) -…;

4950 
v
->
v®id
 = 1;

4951 
v
->
no_ÿch—bË
 = 0;

4952 
v
->
nÙ_found
 = 0;

4953 
v
->
d©a
 = 
p
;

4955  
NGX_OK
;

4956 
	}
}

4959 
ngx_št_t


4960 
	$ngx_h‰p_up¡»am_ÿche_‘ag
(
ngx_h‰p_»que¡_t
 *
r
,

4961 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

4963 ià(
r
->
up¡»am
 =ð
NULL


4964 || !
r
->
up¡»am
->
cÚf
->
ÿche_»v®id©e


4965 || 
r
->
up¡»am
->
ÿche_¡©us
 !ð
NGX_HTTP_CACHE_EXPIRED


4966 || 
r
->
ÿche
->
‘ag
.
Ën
 == 0)

4968 
v
->
nÙ_found
 = 1;

4969  
NGX_OK
;

4972 
v
->
v®id
 = 1;

4973 
v
->
no_ÿch—bË
 = 0;

4974 
v
->
nÙ_found
 = 0;

4975 
v
->
Ën
 = 
r
->
ÿche
->
‘ag
.len;

4976 
v
->
d©a
 = 
r
->
ÿche
->
‘ag
.data;

4978  
NGX_OK
;

4979 
	}
}

4985 
	$ngx_h‰p_up¡»am
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
dummy
)

4987 *
rv
;

4988 *
mcÚf
;

4989 
ngx_¡r_t
 *
v®ue
;

4990 
ngx_u¾_t
 
u
;

4991 
ngx_ušt_t
 
m
;

4992 
ngx_cÚf_t
 
pcf
;

4993 
ngx_h‰p_moduË_t
 *
moduË
;

4994 
ngx_h‰p_cÚf_ùx_t
 *
ùx
, *
h‰p_ùx
;

4995 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
uscf
;

4997 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

4999 
v®ue
 = 
cf
->
¬gs
->
–ts
;

5000 
u
.
ho¡
 = 
v®ue
[1];

5001 
u
.
no_»sÞve
 = 1;

5002 
u
.
no_pÜt
 = 1;

5004 
uscf
 = 
	`ngx_h‰p_up¡»am_add
(
cf
, &
u
, 
NGX_HTTP_UPSTREAM_CREATE


5005 |
NGX_HTTP_UPSTREAM_WEIGHT


5006 |
NGX_HTTP_UPSTREAM_MAX_FAILS


5007 |
NGX_HTTP_UPSTREAM_FAIL_TIMEOUT


5008 |
NGX_HTTP_UPSTREAM_DOWN


5009 |
NGX_HTTP_UPSTREAM_BACKUP
);

5010 ià(
uscf
 =ð
NULL
) {

5011  
NGX_CONF_ERROR
;

5015 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_cÚf_ùx_t
));

5016 ià(
ùx
 =ð
NULL
) {

5017  
NGX_CONF_ERROR
;

5020 
h‰p_ùx
 = 
cf
->
ùx
;

5021 
ùx
->
maš_cÚf
 = 
h‰p_ùx
->main_conf;

5025 
ùx
->
¤v_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

5026 ià(
ùx
->
¤v_cÚf
 =ð
NULL
) {

5027  
NGX_CONF_ERROR
;

5030 
ùx
->
¤v_cÚf
[
ngx_h‰p_up¡»am_moduË
.
ùx_šdex
] = 
uscf
;

5032 
uscf
->
¤v_cÚf
 = 
ùx
->srv_conf;

5037 
ùx
->
loc_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_h‰p_max_moduË
);

5038 ià(
ùx
->
loc_cÚf
 =ð
NULL
) {

5039  
NGX_CONF_ERROR
;

5042 
m
 = 0; 
ngx_moduËs
[m]; m++) {

5043 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_HTTP_MODULE
) {

5047 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

5049 ià(
moduË
->
ü—‹_¤v_cÚf
) {

5050 
mcÚf
 = 
moduË
->
	`ü—‹_¤v_cÚf
(
cf
);

5051 ià(
mcÚf
 =ð
NULL
) {

5052  
NGX_CONF_ERROR
;

5055 
ùx
->
¤v_cÚf
[
ngx_moduËs
[
m
]->
ùx_šdex
] = 
mcÚf
;

5058 ià(
moduË
->
ü—‹_loc_cÚf
) {

5059 
mcÚf
 = 
moduË
->
	`ü—‹_loc_cÚf
(
cf
);

5060 ià(
mcÚf
 =ð
NULL
) {

5061  
NGX_CONF_ERROR
;

5064 
ùx
->
loc_cÚf
[
ngx_moduËs
[
m
]->
ùx_šdex
] = 
mcÚf
;

5068 
uscf
->
£rv”s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4,

5069 (
ngx_h‰p_up¡»am_£rv”_t
));

5070 ià(
uscf
->
£rv”s
 =ð
NULL
) {

5071  
NGX_CONF_ERROR
;

5077 
pcf
 = *
cf
;

5078 
cf
->
ùx
 = ctx;

5079 
cf
->
cmd_ty³
 = 
NGX_HTTP_UPS_CONF
;

5081 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

5083 *
cf
 = 
pcf
;

5085 ià(
rv
 !ð
NGX_CONF_OK
) {

5086  
rv
;

5089 ià(
uscf
->
£rv”s
->
ÃÉs
 == 0) {

5090 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5092  
NGX_CONF_ERROR
;

5095  
rv
;

5096 
	}
}

5100 
	$ngx_h‰p_up¡»am_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

5102 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
uscf
 = 
cÚf
;

5104 
time_t
 
çž_timeout
;

5105 
ngx_¡r_t
 *
v®ue
, 
s
;

5106 
ngx_u¾_t
 
u
;

5107 
ngx_št_t
 
weight
, 
max_çžs
;

5108 
ngx_ušt_t
 
i
;

5109 
ngx_h‰p_up¡»am_£rv”_t
 *
us
;

5111 
us
 = 
	`ngx_¬¿y_push
(
uscf
->
£rv”s
);

5112 ià(
us
 =ð
NULL
) {

5113  
NGX_CONF_ERROR
;

5116 
	`ngx_memz”o
(
us
, (
ngx_h‰p_up¡»am_£rv”_t
));

5118 
v®ue
 = 
cf
->
¬gs
->
–ts
;

5120 
weight
 = 1;

5121 
max_çžs
 = 1;

5122 
çž_timeout
 = 10;

5124 
i
 = 2; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

5126 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "weight=", 7) == 0) {

5128 ià(!(
uscf
->
æags
 & 
NGX_HTTP_UPSTREAM_WEIGHT
)) {

5129 
nÙ_suµÜ‹d
;

5132 
weight
 = 
	`ngx_©oi
(&
v®ue
[
i
].
d©a
[7], v®ue[i].
Ën
 - 7);

5134 ià(
weight
 =ð
NGX_ERROR
 || weight == 0) {

5135 
šv®id
;

5141 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "max_fails=", 10) == 0) {

5143 ià(!(
uscf
->
æags
 & 
NGX_HTTP_UPSTREAM_MAX_FAILS
)) {

5144 
nÙ_suµÜ‹d
;

5147 
max_çžs
 = 
	`ngx_©oi
(&
v®ue
[
i
].
d©a
[10], v®ue[i].
Ën
 - 10);

5149 ià(
max_çžs
 =ð
NGX_ERROR
) {

5150 
šv®id
;

5156 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "fail_timeout=", 13) == 0) {

5158 ià(!(
uscf
->
æags
 & 
NGX_HTTP_UPSTREAM_FAIL_TIMEOUT
)) {

5159 
nÙ_suµÜ‹d
;

5162 
s
.
Ën
 = 
v®ue
[
i
].len - 13;

5163 
s
.
d©a
 = &
v®ue
[
i
].data[13];

5165 
çž_timeout
 = 
	`ngx_·r£_time
(&
s
, 1);

5167 ià(
çž_timeout
 =ð(
time_t
è
NGX_ERROR
) {

5168 
šv®id
;

5174 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "backup") == 0) {

5176 ià(!(
uscf
->
æags
 & 
NGX_HTTP_UPSTREAM_BACKUP
)) {

5177 
nÙ_suµÜ‹d
;

5180 
us
->
backup
 = 1;

5185 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "down") == 0) {

5187 ià(!(
uscf
->
æags
 & 
NGX_HTTP_UPSTREAM_DOWN
)) {

5188 
nÙ_suµÜ‹d
;

5191 
us
->
down
 = 1;

5196 
šv®id
;

5199 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

5201 
u
.
u¾
 = 
v®ue
[1];

5202 
u
.
deçuÉ_pÜt
 = 80;

5204 ià(
	`ngx_·r£_u¾
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

5205 ià(
u
.
”r
) {

5206 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5207 "% š up¡»am \"%V\"", 
u
.
”r
, &u.
u¾
);

5210  
NGX_CONF_ERROR
;

5213 
us
->
Çme
 = 
u
.
u¾
;

5214 
us
->
addrs
 = 
u
.addrs;

5215 
us
->
Çddrs
 = 
u
.naddrs;

5216 
us
->
weight
 = weight;

5217 
us
->
max_çžs
 = max_fails;

5218 
us
->
çž_timeout
 = fail_timeout;

5220  
NGX_CONF_OK
;

5222 
šv®id
:

5224 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5225 "šv®id…¬am‘” \"%V\"", &
v®ue
[
i
]);

5227  
NGX_CONF_ERROR
;

5229 
nÙ_suµÜ‹d
:

5231 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5233 &
v®ue
[
i
]);

5235  
NGX_CONF_ERROR
;

5236 
	}
}

5239 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *

5240 
	$ngx_h‰p_up¡»am_add
(
ngx_cÚf_t
 *
cf
, 
ngx_u¾_t
 *
u
, 
ngx_ušt_t
 
æags
)

5242 
ngx_ušt_t
 
i
;

5243 
ngx_h‰p_up¡»am_£rv”_t
 *
us
;

5244 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
uscf
, **
uscå
;

5245 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

5247 ià(!(
æags
 & 
NGX_HTTP_UPSTREAM_CREATE
)) {

5249 ià(
	`ngx_·r£_u¾
(
cf
->
poÞ
, 
u
è!ð
NGX_OK
) {

5250 ià(
u
->
”r
) {

5251 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5252 "% š up¡»am \"%V\"", 
u
->
”r
, &u->
u¾
);

5255  
NULL
;

5259 
umcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_up¡»am_moduË
);

5261 
uscå
 = 
umcf
->
up¡»ams
.
–ts
;

5263 
i
 = 0; i < 
umcf
->
up¡»ams
.
ÃÉs
; i++) {

5265 ià(
uscå
[
i
]->
ho¡
.
Ën
 !ð
u
->host.len

5266 || 
	`ngx_¡ºÿ£cmp
(
uscå
[
i
]->
ho¡
.
d©a
, 
u
->ho¡.d©a, u->ho¡.
Ën
)

5272 ià((
æags
 & 
NGX_HTTP_UPSTREAM_CREATE
)

5273 && (
uscå
[
i
]->
æags
 & 
NGX_HTTP_UPSTREAM_CREATE
))

5275 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5276 "du¶iÿ‹ up¡»am \"%V\"", &
u
->
ho¡
);

5277  
NULL
;

5280 ià((
uscå
[
i
]->
æags
 & 
NGX_HTTP_UPSTREAM_CREATE
è&& !
u
->
no_pÜt
) {

5281 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

5283 &
u
->
ho¡
, u->
pÜt
);

5284  
NULL
;

5287 ià((
æags
 & 
NGX_HTTP_UPSTREAM_CREATE
è&& !
uscå
[
i
]->
no_pÜt
) {

5288 
	`ngx_log_”rÜ
(
NGX_LOG_WARN
, 
cf
->
log
, 0,

5290 &
u
->
ho¡
, 
uscå
[
i
]->
pÜt
,

5291 
uscå
[
i
]->
fže_Çme
, uscå[i]->
lše
);

5292  
NULL
;

5295 ià(
uscå
[
i
]->
pÜt
 && 
u
->port

5296 && 
uscå
[
i
]->
pÜt
 !ð
u
->port)

5301 ià(
uscå
[
i
]->
deçuÉ_pÜt
 && 
u
->default_port

5302 && 
uscå
[
i
]->
deçuÉ_pÜt
 !ð
u
->default_port)

5307 ià(
æags
 & 
NGX_HTTP_UPSTREAM_CREATE
) {

5308 
uscå
[
i
]->
æags
 = flags;

5311  
uscå
[
i
];

5314 
uscf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_up¡»am_¤v_cÚf_t
));

5315 ià(
uscf
 =ð
NULL
) {

5316  
NULL
;

5319 
uscf
->
æags
 = flags;

5320 
uscf
->
ho¡
 = 
u
->host;

5321 
uscf
->
fže_Çme
 = 
cf
->
cÚf_fže
->
fže
.
Çme
.
d©a
;

5322 
uscf
->
lše
 = 
cf
->
cÚf_fže
->line;

5323 
uscf
->
pÜt
 = 
u
->port;

5324 
uscf
->
deçuÉ_pÜt
 = 
u
->default_port;

5325 
uscf
->
no_pÜt
 = 
u
->no_port;

5327 ià(
u
->
Çddrs
 == 1) {

5328 
uscf
->
£rv”s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1,

5329 (
ngx_h‰p_up¡»am_£rv”_t
));

5330 ià(
uscf
->
£rv”s
 =ð
NULL
) {

5331  
NULL
;

5334 
us
 = 
	`ngx_¬¿y_push
(
uscf
->
£rv”s
);

5335 ià(
us
 =ð
NULL
) {

5336  
NULL
;

5339 
	`ngx_memz”o
(
us
, (
ngx_h‰p_up¡»am_£rv”_t
));

5341 
us
->
addrs
 = 
u
->addrs;

5342 
us
->
Çddrs
 = 1;

5345 
uscå
 = 
	`ngx_¬¿y_push
(&
umcf
->
up¡»ams
);

5346 ià(
uscå
 =ð
NULL
) {

5347  
NULL
;

5350 *
uscå
 = 
uscf
;

5352  
uscf
;

5353 
	}
}

5357 
	$ngx_h‰p_up¡»am_bšd_£t_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

5358 *
cÚf
)

5360 *
p
 = 
cÚf
;

5362 
ngx_št_t
 
rc
;

5363 
ngx_¡r_t
 *
v®ue
;

5364 
ngx_h‰p_com¶ex_v®ue_t
 
cv
;

5365 
ngx_h‰p_up¡»am_loÿl_t
 **
¶oÿl
, *
loÿl
;

5366 
ngx_h‰p_compže_com¶ex_v®ue_t
 
ccv
;

5368 
¶oÿl
 = (
ngx_h‰p_up¡»am_loÿl_t
 **è(
p
 + 
cmd
->
off£t
);

5370 ià(*
¶oÿl
 !ð
NGX_CONF_UNSET_PTR
) {

5374 
v®ue
 = 
cf
->
¬gs
->
–ts
;

5376 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

5377 *
¶oÿl
 = 
NULL
;

5378  
NGX_CONF_OK
;

5381 
	`ngx_memz”o
(&
ccv
, (
ngx_h‰p_compže_com¶ex_v®ue_t
));

5383 
ccv
.
cf
 = cf;

5384 
ccv
.
v®ue
 = &value[1];

5385 
ccv
.
com¶ex_v®ue
 = &
cv
;

5387 ià(
	`ngx_h‰p_compže_com¶ex_v®ue
(&
ccv
è!ð
NGX_OK
) {

5388  
NGX_CONF_ERROR
;

5391 
loÿl
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_up¡»am_loÿl_t
));

5392 ià(
loÿl
 =ð
NULL
) {

5393  
NGX_CONF_ERROR
;

5396 *
¶oÿl
 = 
loÿl
;

5398 ià(
cv
.
Ëngths
) {

5399 
loÿl
->
v®ue
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_com¶ex_v®ue_t
));

5400 ià(
loÿl
->
v®ue
 =ð
NULL
) {

5401  
NGX_CONF_ERROR
;

5404 *
loÿl
->
v®ue
 = 
cv
;

5406  
NGX_CONF_OK
;

5409 
loÿl
->
addr
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_addr_t
));

5410 ià(
loÿl
->
addr
 =ð
NULL
) {

5411  
NGX_CONF_ERROR
;

5414 
rc
 = 
	`ngx_·r£_addr
(
cf
->
poÞ
, 
loÿl
->
addr
, 
v®ue
[1].
d©a
, v®ue[1].
Ën
);

5416 
rc
) {

5417 
NGX_OK
:

5418 
loÿl
->
addr
->
Çme
 = 
v®ue
[1];

5419  
NGX_CONF_OK
;

5421 
NGX_DECLINED
:

5422 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5423 "šv®id‡dd»s \"%V\"", &
v®ue
[1]);

5427  
NGX_CONF_ERROR
;

5429 
	}
}

5432 
ngx_addr_t
 *

5433 
	$ngx_h‰p_up¡»am_g‘_loÿl
(
ngx_h‰p_»que¡_t
 *
r
,

5434 
ngx_h‰p_up¡»am_loÿl_t
 *
loÿl
)

5436 
ngx_št_t
 
rc
;

5437 
ngx_¡r_t
 
v®
;

5438 
ngx_addr_t
 *
addr
;

5440 ià(
loÿl
 =ð
NULL
) {

5441  
NULL
;

5444 ià(
loÿl
->
v®ue
 =ð
NULL
) {

5445  
loÿl
->
addr
;

5448 ià(
	`ngx_h‰p_com¶ex_v®ue
(
r
, 
loÿl
->
v®ue
, &
v®
è!ð
NGX_OK
) {

5449  
NULL
;

5452 ià(
v®
.
Ën
 == 0) {

5453  
NULL
;

5456 
addr
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_addr_t
));

5457 ià(
addr
 =ð
NULL
) {

5458  
NULL
;

5461 
rc
 = 
	`ngx_·r£_addr
(
r
->
poÞ
, 
addr
, 
v®
.
d©a
, v®.
Ën
);

5463 
rc
) {

5464 
NGX_OK
:

5465 
addr
->
Çme
 = 
v®
;

5466  
addr
;

5468 
NGX_DECLINED
:

5469 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

5470 "šv®id†oÿÈadd»s \"%V\"", &
v®
);

5474  
NULL
;

5476 
	}
}

5480 
	$ngx_h‰p_up¡»am_·¿m_£t_¦Ù
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

5481 *
cÚf
)

5483 *
p
 = 
cÚf
;

5485 
ngx_¡r_t
 *
v®ue
;

5486 
ngx_¬¿y_t
 **
a
;

5487 
ngx_h‰p_up¡»am_·¿m_t
 *
·¿m
;

5489 
a
 = (
ngx_¬¿y_t
 **è(
p
 + 
cmd
->
off£t
);

5491 ià(*
a
 =ð
NULL
) {

5492 *
a
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 4, (
ngx_h‰p_up¡»am_·¿m_t
));

5493 ià(*
a
 =ð
NULL
) {

5494  
NGX_CONF_ERROR
;

5498 
·¿m
 = 
	`ngx_¬¿y_push
(*
a
);

5499 ià(
·¿m
 =ð
NULL
) {

5500  
NGX_CONF_ERROR
;

5503 
v®ue
 = 
cf
->
¬gs
->
–ts
;

5505 
·¿m
->
key
 = 
v®ue
[1];

5506 
·¿m
->
v®ue
 = value[2];

5507 
·¿m
->
sk_em±y
 = 0;

5509 ià(
cf
->
¬gs
->
ÃÉs
 == 4) {

5510 ià(
	`ngx_¡rcmp
(
v®ue
[3].
d©a
, "if_not_empty") != 0) {

5511 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

5512 "šv®id…¬am‘” \"%V\"", &
v®ue
[3]);

5513  
NGX_CONF_ERROR
;

5516 
·¿m
->
sk_em±y
 = 1;

5519  
NGX_CONF_OK
;

5520 
	}
}

5523 
ngx_št_t


5524 
	$ngx_h‰p_up¡»am_hide_h—d”s_hash
(
ngx_cÚf_t
 *
cf
,

5525 
ngx_h‰p_up¡»am_cÚf_t
 *
cÚf
,‚gx_h‰p_up¡»am_cÚf_ˆ*
´ev
,

5526 
ngx_¡r_t
 *
deçuÉ_hide_h—d”s
, 
ngx_hash_š™_t
 *
hash
)

5528 
ngx_¡r_t
 *
h
;

5529 
ngx_ušt_t
 
i
, 
j
;

5530 
ngx_¬¿y_t
 
hide_h—d”s
;

5531 
ngx_hash_key_t
 *
hk
;

5533 ià(
cÚf
->
hide_h—d”s
 =ð
NGX_CONF_UNSET_PTR


5534 && 
cÚf
->
·ss_h—d”s
 =ð
NGX_CONF_UNSET_PTR
)

5536 
cÚf
->
hide_h—d”s
 = 
´ev
->hide_headers;

5537 
cÚf
->
·ss_h—d”s
 = 
´ev
->pass_headers;

5539 
cÚf
->
hide_h—d”s_hash
 = 
´ev
->hide_headers_hash;

5541 ià(
cÚf
->
hide_h—d”s_hash
.
buck‘s


5542 #ià(
NGX_HTTP_CACHE
)

5543 && ((
cÚf
->
ÿche
 =ð
NULL
è=ð(
´ev
->cache == NULL))

5547  
NGX_OK
;

5551 ià(
cÚf
->
hide_h—d”s
 =ð
NGX_CONF_UNSET_PTR
) {

5552 
cÚf
->
hide_h—d”s
 = 
´ev
->hide_headers;

5555 ià(
cÚf
->
·ss_h—d”s
 =ð
NGX_CONF_UNSET_PTR
) {

5556 
cÚf
->
·ss_h—d”s
 = 
´ev
->pass_headers;

5560 ià(
	`ngx_¬¿y_š™
(&
hide_h—d”s
, 
cf
->
‹mp_poÞ
, 4, (
ngx_hash_key_t
))

5561 !ð
NGX_OK
)

5563  
NGX_ERROR
;

5566 
h
 = 
deçuÉ_hide_h—d”s
; h->
Ën
; h++) {

5567 
hk
 = 
	`ngx_¬¿y_push
(&
hide_h—d”s
);

5568 ià(
hk
 =ð
NULL
) {

5569  
NGX_ERROR
;

5572 
hk
->
key
 = *
h
;

5573 
hk
->
key_hash
 = 
	`ngx_hash_key_lc
(
h
->
d©a
, h->
Ën
);

5574 
hk
->
v®ue
 = (*) 1;

5577 ià(
cÚf
->
hide_h—d”s
 !ð
NGX_CONF_UNSET_PTR
) {

5579 
h
 = 
cÚf
->
hide_h—d”s
->
–ts
;

5581 
i
 = 0; i < 
cÚf
->
hide_h—d”s
->
ÃÉs
; i++) {

5583 
hk
 = 
hide_h—d”s
.
–ts
;

5585 
j
 = 0; j < 
hide_h—d”s
.
ÃÉs
; j++) {

5586 ià(
	`ngx_¡rÿ£cmp
(
h
[
i
].
d©a
, 
hk
[
j
].
key
.data) == 0) {

5587 
exi¡
;

5591 
hk
 = 
	`ngx_¬¿y_push
(&
hide_h—d”s
);

5592 ià(
hk
 =ð
NULL
) {

5593  
NGX_ERROR
;

5596 
hk
->
key
 = 
h
[
i
];

5597 
hk
->
key_hash
 = 
	`ngx_hash_key_lc
(
h
[
i
].
d©a
, h[i].
Ën
);

5598 
hk
->
v®ue
 = (*) 1;

5600 
exi¡
:

5606 ià(
cÚf
->
·ss_h—d”s
 !ð
NGX_CONF_UNSET_PTR
) {

5608 
h
 = 
cÚf
->
·ss_h—d”s
->
–ts
;

5609 
hk
 = 
hide_h—d”s
.
–ts
;

5611 
i
 = 0; i < 
cÚf
->
·ss_h—d”s
->
ÃÉs
; i++) {

5612 
j
 = 0; j < 
hide_h—d”s
.
ÃÉs
; j++) {

5614 ià(
hk
[
j
].
key
.
d©a
 =ð
NULL
) {

5618 ià(
	`ngx_¡rÿ£cmp
(
h
[
i
].
d©a
, 
hk
[
j
].
key
.data) == 0) {

5619 
hk
[
j
].
key
.
d©a
 = 
NULL
;

5626 
hash
->hash = &
cÚf
->
hide_h—d”s_hash
;

5627 
hash
->
key
 = 
ngx_hash_key_lc
;

5628 
hash
->
poÞ
 = 
cf
->pool;

5629 
hash
->
‹mp_poÞ
 = 
NULL
;

5631  
	`ngx_hash_š™
(
hash
, 
hide_h—d”s
.
–ts
, hide_h—d”s.
ÃÉs
);

5632 
	}
}

5636 
	$ngx_h‰p_up¡»am_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

5638 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

5640 
umcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_up¡»am_maš_cÚf_t
));

5641 ià(
umcf
 =ð
NULL
) {

5642  
NULL
;

5645 ià(
	`ngx_¬¿y_š™
(&
umcf
->
up¡»ams
, 
cf
->
poÞ
, 4,

5646 (
ngx_h‰p_up¡»am_¤v_cÚf_t
 *))

5647 !ð
NGX_OK
)

5649  
NULL
;

5652  
umcf
;

5653 
	}
}

5657 
	$ngx_h‰p_up¡»am_š™_maš_cÚf
(
ngx_cÚf_t
 *
cf
, *
cÚf
)

5659 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
 = 
cÚf
;

5661 
ngx_ušt_t
 
i
;

5662 
ngx_¬¿y_t
 
h—d”s_š
;

5663 
ngx_hash_key_t
 *
hk
;

5664 
ngx_hash_š™_t
 
hash
;

5665 
ngx_h‰p_up¡»am_š™_±
 
š™
;

5666 
ngx_h‰p_up¡»am_h—d”_t
 *
h—d”
;

5667 
ngx_h‰p_up¡»am_¤v_cÚf_t
 **
uscå
;

5669 
uscå
 = 
umcf
->
up¡»ams
.
–ts
;

5671 
i
 = 0; i < 
umcf
->
up¡»ams
.
ÃÉs
; i++) {

5673 
š™
 = 
uscå
[
i
]->
³”
.
š™_up¡»am
 ? uscfp[i]->peer.init_upstream:

5674 
ngx_h‰p_up¡»am_š™_round_robš
;

5676 ià(
	`š™
(
cf
, 
uscå
[
i
]è!ð
NGX_OK
) {

5677  
NGX_CONF_ERROR
;

5684 ià(
	`ngx_¬¿y_š™
(&
h—d”s_š
, 
cf
->
‹mp_poÞ
, 32, (
ngx_hash_key_t
))

5685 !ð
NGX_OK
)

5687  
NGX_CONF_ERROR
;

5690 
h—d”
 = 
ngx_h‰p_up¡»am_h—d”s_š
; h—d”->
Çme
.
Ën
; header++) {

5691 
hk
 = 
	`ngx_¬¿y_push
(&
h—d”s_š
);

5692 ià(
hk
 =ð
NULL
) {

5693  
NGX_CONF_ERROR
;

5696 
hk
->
key
 = 
h—d”
->
Çme
;

5697 
hk
->
key_hash
 = 
	`ngx_hash_key_lc
(
h—d”
->
Çme
.
d©a
, h—d”->Çme.
Ën
);

5698 
hk
->
v®ue
 = 
h—d”
;

5701 
hash
.hash = &
umcf
->
h—d”s_š_hash
;

5702 
hash
.
key
 = 
ngx_hash_key_lc
;

5703 
hash
.
max_size
 = 512;

5704 
hash
.
buck‘_size
 = 
	`ngx_®ign
(64, 
ngx_ÿch–še_size
);

5705 
hash
.
Çme
 = "upstream_headers_in_hash";

5706 
hash
.
poÞ
 = 
cf
->pool;

5707 
hash
.
‹mp_poÞ
 = 
NULL
;

5709 ià(
	`ngx_hash_š™
(&
hash
, 
h—d”s_š
.
–ts
, h—d”s_š.
ÃÉs
è!ð
NGX_OK
) {

5710  
NGX_CONF_ERROR
;

5713  
NGX_CONF_OK
;

5714 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_upstream_round_robin.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
	#ngx_h‰p_up¡»am_Œ›s
(
p
è(Õ)->
numb”
 \

14 + ((
p
)->
Ãxt
 ? (p)->Ãxt->
numb”
 : 0))

	)

17 
ngx_h‰p_up¡»am_¼_³”_t
 *
ngx_h‰p_up¡»am_g‘_³”
(

18 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 *
¼p
);

20 #ià(
NGX_HTTP_SSL
)

22 
ngx_št_t
 
ngx_h‰p_up¡»am_em±y_£t_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

23 *
d©a
);

24 
ngx_h‰p_up¡»am_em±y_§ve_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

25 *
d©a
);

30 
ngx_št_t


31 
	$ngx_h‰p_up¡»am_š™_round_robš
(
ngx_cÚf_t
 *
cf
,

32 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

34 
ngx_u¾_t
 
u
;

35 
ngx_ušt_t
 
i
, 
j
, 
n
, 
w
;

36 
ngx_h‰p_up¡»am_£rv”_t
 *
£rv”
;

37 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

38 
ngx_h‰p_up¡»am_¼_³”s_t
 *
³”s
, *
backup
;

40 
us
->
³”
.
š™
 = 
ngx_h‰p_up¡»am_š™_round_robš_³”
;

42 ià(
us
->
£rv”s
) {

43 
£rv”
 = 
us
->
£rv”s
->
–ts
;

45 
n
 = 0;

46 
w
 = 0;

48 
i
 = 0; i < 
us
->
£rv”s
->
ÃÉs
; i++) {

49 ià(
£rv”
[
i
].
backup
) {

53 
n
 +ð
£rv”
[
i
].
Çddrs
;

54 
w
 +ð
£rv”
[
i
].
Çddrs
 * s”v”[i].
weight
;

57 ià(
n
 == 0) {

58 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

60 &
us
->
ho¡
, us->
fže_Çme
, us->
lše
);

61  
NGX_ERROR
;

64 
³”s
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_up¡»am_¼_³”s_t
)

65 + (
ngx_h‰p_up¡»am_¼_³”_t
è* (
n
 - 1));

66 ià(
³”s
 =ð
NULL
) {

67  
NGX_ERROR
;

70 
³”s
->
sšgË
 = (
n
 == 1);

71 
³”s
->
numb”
 = 
n
;

72 
³”s
->
weigh‹d
 = (
w
 !ð
n
);

73 
³”s
->
tÙ®_weight
 = 
w
;

74 
³”s
->
Çme
 = &
us
->
ho¡
;

76 
n
 = 0;

77 
³”
 = 
³”s
->peer;

79 
i
 = 0; i < 
us
->
£rv”s
->
ÃÉs
; i++) {

80 ià(
£rv”
[
i
].
backup
) {

84 
j
 = 0; j < 
£rv”
[
i
].
Çddrs
; j++) {

85 
³”
[
n
].
sockaddr
 = 
£rv”
[
i
].
addrs
[
j
].sockaddr;

86 
³”
[
n
].
sockËn
 = 
£rv”
[
i
].
addrs
[
j
].socklen;

87 
³”
[
n
].
Çme
 = 
£rv”
[
i
].
addrs
[
j
].name;

88 
³”
[
n
].
weight
 = 
£rv”
[
i
].weight;

89 
³”
[
n
].
efãùive_weight
 = 
£rv”
[
i
].
weight
;

90 
³”
[
n
].
cu¼’t_weight
 = 0;

91 
³”
[
n
].
max_çžs
 = 
£rv”
[
i
].max_fails;

92 
³”
[
n
].
çž_timeout
 = 
£rv”
[
i
].fail_timeout;

93 
³”
[
n
].
down
 = 
£rv”
[
i
].down;

94 
³”
[
n
].
£rv”
 = s”v”[
i
].
Çme
;

95 
n
++;

99 
us
->
³”
.
d©a
 = 
³”s
;

103 
n
 = 0;

104 
w
 = 0;

106 
i
 = 0; i < 
us
->
£rv”s
->
ÃÉs
; i++) {

107 ià(!
£rv”
[
i
].
backup
) {

111 
n
 +ð
£rv”
[
i
].
Çddrs
;

112 
w
 +ð
£rv”
[
i
].
Çddrs
 * s”v”[i].
weight
;

115 ià(
n
 == 0) {

116  
NGX_OK
;

119 
backup
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_up¡»am_¼_³”s_t
)

120 + (
ngx_h‰p_up¡»am_¼_³”_t
è* (
n
 - 1));

121 ià(
backup
 =ð
NULL
) {

122  
NGX_ERROR
;

125 
³”s
->
sšgË
 = 0;

126 
backup
->
sšgË
 = 0;

127 
backup
->
numb”
 = 
n
;

128 
backup
->
weigh‹d
 = (
w
 !ð
n
);

129 
backup
->
tÙ®_weight
 = 
w
;

130 
backup
->
Çme
 = &
us
->
ho¡
;

132 
n
 = 0;

133 
³”
 = 
backup
->peer;

135 
i
 = 0; i < 
us
->
£rv”s
->
ÃÉs
; i++) {

136 ià(!
£rv”
[
i
].
backup
) {

140 
j
 = 0; j < 
£rv”
[
i
].
Çddrs
; j++) {

141 
³”
[
n
].
sockaddr
 = 
£rv”
[
i
].
addrs
[
j
].sockaddr;

142 
³”
[
n
].
sockËn
 = 
£rv”
[
i
].
addrs
[
j
].socklen;

143 
³”
[
n
].
Çme
 = 
£rv”
[
i
].
addrs
[
j
].name;

144 
³”
[
n
].
weight
 = 
£rv”
[
i
].weight;

145 
³”
[
n
].
efãùive_weight
 = 
£rv”
[
i
].
weight
;

146 
³”
[
n
].
cu¼’t_weight
 = 0;

147 
³”
[
n
].
max_çžs
 = 
£rv”
[
i
].max_fails;

148 
³”
[
n
].
çž_timeout
 = 
£rv”
[
i
].fail_timeout;

149 
³”
[
n
].
down
 = 
£rv”
[
i
].down;

150 
³”
[
n
].
£rv”
 = s”v”[
i
].
Çme
;

151 
n
++;

155 
³”s
->
Ãxt
 = 
backup
;

157  
NGX_OK
;

163 ià(
us
->
pÜt
 == 0) {

164 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

166 &
us
->
ho¡
, us->
fže_Çme
, us->
lše
);

167  
NGX_ERROR
;

170 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

172 
u
.
ho¡
 = 
us
->host;

173 
u
.
pÜt
 = 
us
->port;

175 ià(
	`ngx_š‘_»sÞve_ho¡
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

176 ià(
u
.
”r
) {

177 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

179 
u
.
”r
, &
us
->
ho¡
, us->
fže_Çme
, us->
lše
);

182  
NGX_ERROR
;

185 
n
 = 
u
.
Çddrs
;

187 
³”s
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_up¡»am_¼_³”s_t
)

188 + (
ngx_h‰p_up¡»am_¼_³”_t
è* (
n
 - 1));

189 ià(
³”s
 =ð
NULL
) {

190  
NGX_ERROR
;

193 
³”s
->
sšgË
 = (
n
 == 1);

194 
³”s
->
numb”
 = 
n
;

195 
³”s
->
weigh‹d
 = 0;

196 
³”s
->
tÙ®_weight
 = 
n
;

197 
³”s
->
Çme
 = &
us
->
ho¡
;

199 
³”
 = 
³”s
->peer;

201 
i
 = 0; i < 
u
.
Çddrs
; i++) {

202 
³”
[
i
].
sockaddr
 = 
u
.
addrs
[i].sockaddr;

203 
³”
[
i
].
sockËn
 = 
u
.
addrs
[i].socklen;

204 
³”
[
i
].
Çme
 = 
u
.
addrs
[i].name;

205 
³”
[
i
].
weight
 = 1;

206 
³”
[
i
].
efãùive_weight
 = 1;

207 
³”
[
i
].
cu¼’t_weight
 = 0;

208 
³”
[
i
].
max_çžs
 = 1;

209 
³”
[
i
].
çž_timeout
 = 10;

212 
us
->
³”
.
d©a
 = 
³”s
;

216  
NGX_OK
;

217 
	}
}

220 
ngx_št_t


221 
	$ngx_h‰p_up¡»am_š™_round_robš_³”
(
ngx_h‰p_»que¡_t
 *
r
,

222 
ngx_h‰p_up¡»am_¤v_cÚf_t
 *
us
)

224 
ngx_ušt_t
 
n
;

225 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 *
¼p
;

227 
¼p
 = 
r
->
up¡»am
->
³”
.
d©a
;

229 ià(
¼p
 =ð
NULL
) {

230 
¼p
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_¼_³”_d©a_t
));

231 ià(
¼p
 =ð
NULL
) {

232  
NGX_ERROR
;

235 
r
->
up¡»am
->
³”
.
d©a
 = 
¼p
;

238 
¼p
->
³”s
 = 
us
->
³”
.
d©a
;

239 
¼p
->
cu¼’t
 = 0;

241 
n
 = 
¼p
->
³”s
->
numb”
;

243 ià(
¼p
->
³”s
->
Ãxt
 &&„½->³”s->Ãxt->
numb”
 > 
n
) {

244 
n
 = 
¼p
->
³”s
->
Ãxt
->
numb”
;

247 ià(
n
 <ð8 * (
ušŒ_t
)) {

248 
¼p
->
Œ›d
 = &¼p->
d©a
;

249 
¼p
->
d©a
 = 0;

252 
n
 = (À+ (8 * (
ušŒ_t
) - 1)) / (8 * (uintptr_t));

254 
¼p
->
Œ›d
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, 
n
 * (
ušŒ_t
));

255 ià(
¼p
->
Œ›d
 =ð
NULL
) {

256  
NGX_ERROR
;

260 
r
->
up¡»am
->
³”
.
g‘
 = 
ngx_h‰p_up¡»am_g‘_round_robš_³”
;

261 
r
->
up¡»am
->
³”
.
ä“
 = 
ngx_h‰p_up¡»am_ä“_round_robš_³”
;

262 
r
->
up¡»am
->
³”
.
Œ›s
 = 
	`ngx_h‰p_up¡»am_Œ›s
(
¼p
->
³”s
);

263 #ià(
NGX_HTTP_SSL
)

264 
r
->
up¡»am
->
³”
.
£t_£ssiÚ
 =

265 
ngx_h‰p_up¡»am_£t_round_robš_³”_£ssiÚ
;

266 
r
->
up¡»am
->
³”
.
§ve_£ssiÚ
 =

267 
ngx_h‰p_up¡»am_§ve_round_robš_³”_£ssiÚ
;

270  
NGX_OK
;

271 
	}
}

274 
ngx_št_t


275 
	$ngx_h‰p_up¡»am_ü—‹_round_robš_³”
(
ngx_h‰p_»que¡_t
 *
r
,

276 
ngx_h‰p_up¡»am_»sÞved_t
 *
ur
)

278 
u_ch¬
 *
p
;

279 
size_t
 
Ën
;

280 
sockËn_t
 
sockËn
;

281 
ngx_ušt_t
 
i
, 
n
;

282 
sockaddr
 *sockaddr;

283 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

284 
ngx_h‰p_up¡»am_¼_³”s_t
 *
³”s
;

285 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 *
¼p
;

287 
¼p
 = 
r
->
up¡»am
->
³”
.
d©a
;

289 ià(
¼p
 =ð
NULL
) {

290 
¼p
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_¼_³”_d©a_t
));

291 ià(
¼p
 =ð
NULL
) {

292  
NGX_ERROR
;

295 
r
->
up¡»am
->
³”
.
d©a
 = 
¼p
;

298 
³”s
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, (
ngx_h‰p_up¡»am_¼_³”s_t
)

299 + (
ngx_h‰p_up¡»am_¼_³”_t
è* (
ur
->
Çddrs
 - 1));

300 ià(
³”s
 =ð
NULL
) {

301  
NGX_ERROR
;

304 
³”s
->
sšgË
 = (
ur
->
Çddrs
 == 1);

305 
³”s
->
numb”
 = 
ur
->
Çddrs
;

306 
³”s
->
Çme
 = &
ur
->
ho¡
;

308 
³”
 = 
³”s
->peer;

310 ià(
ur
->
sockaddr
) {

311 
³”
[0].
sockaddr
 = 
ur
->sockaddr;

312 
³”
[0].
sockËn
 = 
ur
->socklen;

313 
³”
[0].
Çme
 = 
ur
->
ho¡
;

314 
³”
[0].
weight
 = 1;

315 
³”
[0].
efãùive_weight
 = 1;

316 
³”
[0].
cu¼’t_weight
 = 0;

317 
³”
[0].
max_çžs
 = 1;

318 
³”
[0].
çž_timeout
 = 10;

322 
i
 = 0; i < 
ur
->
Çddrs
; i++) {

324 
sockËn
 = 
ur
->
addrs
[
i
].socklen;

326 
sockaddr
 = 
	`ngx_·Îoc
(
r
->
poÞ
, 
sockËn
);

327 ià(
sockaddr
 =ð
NULL
) {

328  
NGX_ERROR
;

331 
	`ngx_memýy
(
sockaddr
, 
ur
->
addrs
[
i
].sockaddr, 
sockËn
);

333 
sockaddr
->
§_çmžy
) {

334 #ià(
NGX_HAVE_INET6
)

335 
AF_INET6
:

336 ((
sockaddr_š6
 *è
sockaddr
)->
sš6_pÜt
 = 
	`htÚs
(
ur
->
pÜt
);

340 ((
sockaddr_š
 *è
sockaddr
)->
sš_pÜt
 = 
	`htÚs
(
ur
->
pÜt
);

343 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_SOCKADDR_STRLEN
);

344 ià(
p
 =ð
NULL
) {

345  
NGX_ERROR
;

348 
Ën
 = 
	`ngx_sock_ÁÝ
(
sockaddr
, 
sockËn
, 
p
, 
NGX_SOCKADDR_STRLEN
, 1);

350 
³”
[
i
].
sockaddr
 = sockaddr;

351 
³”
[
i
].
sockËn
 = socklen;

352 
³”
[
i
].
Çme
.
Ën
 =†en;

353 
³”
[
i
].
Çme
.
d©a
 = 
p
;

354 
³”
[
i
].
weight
 = 1;

355 
³”
[
i
].
efãùive_weight
 = 1;

356 
³”
[
i
].
cu¼’t_weight
 = 0;

357 
³”
[
i
].
max_çžs
 = 1;

358 
³”
[
i
].
çž_timeout
 = 10;

362 
¼p
->
³”s
 =…eers;

363 
¼p
->
cu¼’t
 = 0;

365 ià(
¼p
->
³”s
->
numb”
 <ð8 * (
ušŒ_t
)) {

366 
¼p
->
Œ›d
 = &¼p->
d©a
;

367 
¼p
->
d©a
 = 0;

370 
n
 = (
¼p
->
³”s
->
numb”
 + (8 * (
ušŒ_t
) - 1))

371 / (8 * (
ušŒ_t
));

373 
¼p
->
Œ›d
 = 
	`ngx_pÿÎoc
(
r
->
poÞ
, 
n
 * (
ušŒ_t
));

374 ià(
¼p
->
Œ›d
 =ð
NULL
) {

375  
NGX_ERROR
;

379 
r
->
up¡»am
->
³”
.
g‘
 = 
ngx_h‰p_up¡»am_g‘_round_robš_³”
;

380 
r
->
up¡»am
->
³”
.
ä“
 = 
ngx_h‰p_up¡»am_ä“_round_robš_³”
;

381 
r
->
up¡»am
->
³”
.
Œ›s
 = 
	`ngx_h‰p_up¡»am_Œ›s
(
¼p
->
³”s
);

382 #ià(
NGX_HTTP_SSL
)

383 
r
->
up¡»am
->
³”
.
£t_£ssiÚ
 = 
ngx_h‰p_up¡»am_em±y_£t_£ssiÚ
;

384 
r
->
up¡»am
->
³”
.
§ve_£ssiÚ
 = 
ngx_h‰p_up¡»am_em±y_§ve_£ssiÚ
;

387  
NGX_OK
;

388 
	}
}

391 
ngx_št_t


392 
	$ngx_h‰p_up¡»am_g‘_round_robš_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

394 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 *
¼p
 = 
d©a
;

396 
ngx_št_t
 
rc
;

397 
ngx_ušt_t
 
i
, 
n
;

398 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

399 
ngx_h‰p_up¡»am_¼_³”s_t
 *
³”s
;

401 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

402 "g‘„¸³”,ry: %ui", 
pc
->
Œ›s
);

404 
pc
->
ÿched
 = 0;

405 
pc
->
cÚÃùiÚ
 = 
NULL
;

407 
³”s
 = 
¼p
->peers;

411 ià(
³”s
->
sšgË
) {

412 
³”
 = &
³”s
->peer[0];

414 ià(
³”
->
down
) {

415 
çžed
;

422 
³”
 = 
	`ngx_h‰p_up¡»am_g‘_³”
(
¼p
);

424 ià(
³”
 =ð
NULL
) {

425 
çžed
;

428 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

430 
¼p
->
cu¼’t
, 
³”
->
cu¼’t_weight
);

433 
pc
->
sockaddr
 = 
³”
->sockaddr;

434 
pc
->
sockËn
 = 
³”
->socklen;

435 
pc
->
Çme
 = &
³”
->name;

439  
NGX_OK
;

441 
çžed
:

443 ià(
³”s
->
Ãxt
) {

447 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0, "backup servers");

449 
¼p
->
³”s
 =…“rs->
Ãxt
;

451 
n
 = (
¼p
->
³”s
->
numb”
 + (8 * (
ušŒ_t
) - 1))

452 / (8 * (
ušŒ_t
));

454 
i
 = 0; i < 
n
; i++) {

455 
¼p
->
Œ›d
[
i
] = 0;

458 
rc
 = 
	`ngx_h‰p_up¡»am_g‘_round_robš_³”
(
pc
, 
¼p
);

460 ià(
rc
 !ð
NGX_BUSY
) {

461  
rc
;

469 
i
 = 0; i < 
³”s
->
numb”
; i++) {

470 
³”s
->
³”
[
i
].
çžs
 = 0;

475 
pc
->
Çme
 = 
³”s
->name;

477  
NGX_BUSY
;

478 
	}
}

481 
ngx_h‰p_up¡»am_¼_³”_t
 *

482 
	$ngx_h‰p_up¡»am_g‘_³”
(
ngx_h‰p_up¡»am_¼_³”_d©a_t
 *
¼p
)

484 
time_t
 
now
;

485 
ušŒ_t
 
m
;

486 
ngx_št_t
 
tÙ®
;

487 
ngx_ušt_t
 
i
, 
n
;

488 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
, *
be¡
;

490 
now
 = 
	`ngx_time
();

492 
be¡
 = 
NULL
;

493 
tÙ®
 = 0;

495 
i
 = 0; i < 
¼p
->
³”s
->
numb”
; i++) {

497 
n
 = 
i
 / (8 * (
ušŒ_t
));

498 
m
 = (
ušŒ_t
è1 << 
i
 % (8 * (uintptr_t));

500 ià(
¼p
->
Œ›d
[
n
] & 
m
) {

504 
³”
 = &
¼p
->
³”s
->³”[
i
];

506 ià(
³”
->
down
) {

510 ià(
³”
->
max_çžs


511 && 
³”
->
çžs
 >ð³”->
max_çžs


512 && 
now
 - 
³”
->
checked
 <ð³”->
çž_timeout
)

517 
³”
->
cu¼’t_weight
 +ð³”->
efãùive_weight
;

518 
tÙ®
 +ð
³”
->
efãùive_weight
;

520 ià(
³”
->
efãùive_weight
 <…“r->
weight
) {

521 
³”
->
efãùive_weight
++;

524 ià(
be¡
 =ð
NULL
 || 
³”
->
cu¼’t_weight
 > best->current_weight) {

525 
be¡
 = 
³”
;

529 ià(
be¡
 =ð
NULL
) {

530  
NULL
;

533 
i
 = 
be¡
 - &
¼p
->
³”s
->
³”
[0];

535 
¼p
->
cu¼’t
 = 
i
;

537 
n
 = 
i
 / (8 * (
ušŒ_t
));

538 
m
 = (
ušŒ_t
è1 << 
i
 % (8 * (uintptr_t));

540 
¼p
->
Œ›d
[
n
] |ð
m
;

542 
be¡
->
cu¼’t_weight
 -ð
tÙ®
;

544 ià(
now
 - 
be¡
->
checked
 > be¡->
çž_timeout
) {

545 
be¡
->
checked
 = 
now
;

548  
be¡
;

549 
	}
}

553 
	$ngx_h‰p_up¡»am_ä“_round_robš_³”
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
,

554 
ngx_ušt_t
 
¡©e
)

556 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 *
¼p
 = 
d©a
;

558 
time_t
 
now
;

559 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

561 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

562 "ä“„¸³” %u˜%ui", 
pc
->
Œ›s
, 
¡©e
);

566 ià(
¼p
->
³”s
->
sšgË
) {

567 
pc
->
Œ›s
 = 0;

571 
³”
 = &
¼p
->
³”s
->³”[¼p->
cu¼’t
];

573 ià(
¡©e
 & 
NGX_PEER_FAILED
) {

574 
now
 = 
	`ngx_time
();

578 
³”
->
çžs
++;

579 
³”
->
acûs£d
 = 
now
;

580 
³”
->
checked
 = 
now
;

582 ià(
³”
->
max_çžs
) {

583 
³”
->
efãùive_weight
 -ð³”->
weight
 /…“r->
max_çžs
;

586 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

588 
¼p
->
cu¼’t
, 
³”
->
efãùive_weight
);

590 ià(
³”
->
efãùive_weight
 < 0) {

591 
³”
->
efãùive_weight
 = 0;

600 ià(
³”
->
acûs£d
 <…“r->
checked
) {

601 
³”
->
çžs
 = 0;

605 ià(
pc
->
Œ›s
) {

606 
pc
->
Œ›s
--;

610 
	}
}

613 #ià(
NGX_HTTP_SSL
)

615 
ngx_št_t


616 
	$ngx_h‰p_up¡»am_£t_round_robš_³”_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

617 *
d©a
)

619 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 *
¼p
 = 
d©a
;

621 
ngx_št_t
 
rc
;

622 
ngx_s¦_£ssiÚ_t
 *
s¦_£ssiÚ
;

623 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

625 
³”
 = &
¼p
->
³”s
->³”[¼p->
cu¼’t
];

630 
s¦_£ssiÚ
 = 
³”
->ssl_session;

632 
rc
 = 
	`ngx_s¦_£t_£ssiÚ
(
pc
->
cÚÃùiÚ
, 
s¦_£ssiÚ
);

634 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

635 "£ˆ£ssiÚ: %p", 
s¦_£ssiÚ
);

639  
rc
;

640 
	}
}

644 
	$ngx_h‰p_up¡»am_§ve_round_robš_³”_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
,

645 *
d©a
)

647 
ngx_h‰p_up¡»am_¼_³”_d©a_t
 *
¼p
 = 
d©a
;

649 
ngx_s¦_£ssiÚ_t
 *
Þd_s¦_£ssiÚ
, *
s¦_£ssiÚ
;

650 
ngx_h‰p_up¡»am_¼_³”_t
 *
³”
;

652 
s¦_£ssiÚ
 = 
	`ngx_s¦_g‘_£ssiÚ
(
pc
->
cÚÃùiÚ
);

654 ià(
s¦_£ssiÚ
 =ð
NULL
) {

658 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

659 "§v£ssiÚ: %p", 
s¦_£ssiÚ
);

661 
³”
 = &
¼p
->
³”s
->³”[¼p->
cu¼’t
];

666 
Þd_s¦_£ssiÚ
 = 
³”
->
s¦_£ssiÚ
;

667 
³”
->
s¦_£ssiÚ
 = ssl_session;

671 ià(
Þd_s¦_£ssiÚ
) {

673 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
pc
->
log
, 0,

674 "Þd sessiÚ: %p", 
Þd_s¦_£ssiÚ
);

678 
	`ngx_s¦_ä“_£ssiÚ
(
Þd_s¦_£ssiÚ
);

680 
	}
}

683 
ngx_št_t


684 
	$ngx_h‰p_up¡»am_em±y_£t_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

686  
NGX_OK
;

687 
	}
}

691 
	$ngx_h‰p_up¡»am_em±y_§ve_£ssiÚ
(
ngx_³”_cÚÃùiÚ_t
 *
pc
, *
d©a
)

694 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_variables.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

11 
	~<ngšx.h
>

14 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡
(
ngx_h‰p_»que¡_t
 *
r
,

15 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

17 
ngx_h‰p_v¬ŸbË_»que¡_£t
(
ngx_h‰p_»que¡_t
 *
r
,

18 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

20 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_g‘_size
(
ngx_h‰p_»que¡_t
 *
r
,

21 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

22 
ngx_h‰p_v¬ŸbË_»que¡_£t_size
(
ngx_h‰p_»que¡_t
 *
r
,

23 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

24 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_h—d”
(
ngx_h‰p_»que¡_t
 *
r
,

25 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

27 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_cook›s
(
ngx_h‰p_»que¡_t
 *
r
,

28 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

29 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_h—d”s
(
ngx_h‰p_»que¡_t
 *
r
,

30 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

31 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_h—d”s_š‹º®
(
ngx_h‰p_»que¡_t
 *
r
,

32 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
, 
u_ch¬
 
£p
);

34 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_unknown_h—d”_š
(
ngx_h‰p_»que¡_t
 *
r
,

35 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

36 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_unknown_h—d”_out
(
ngx_h‰p_»que¡_t
 *
r
,

37 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

38 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_lše
(
ngx_h‰p_»que¡_t
 *
r
,

39 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

40 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_cook›
(
ngx_h‰p_»que¡_t
 *
r
,

41 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

42 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_¬gum’t
(
ngx_h‰p_»que¡_t
 *
r
,

43 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

44 #ià(
NGX_HAVE_TCP_INFO
)

45 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_týšfo
(
ngx_h‰p_»que¡_t
 *
r
,

46 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

49 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_cÚ‹Á_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
,

50 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

51 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_ho¡
(
ngx_h‰p_»que¡_t
 *
r
,

52 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

53 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_bš¬y_»mÙe_addr
(
ngx_h‰p_»que¡_t
 *
r
,

54 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

55 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»mÙe_addr
(
ngx_h‰p_»que¡_t
 *
r
,

56 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

57 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»mÙe_pÜt
(
ngx_h‰p_»que¡_t
 *
r
,

58 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

59 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_´oxy_´ÙocÞ_addr
(
ngx_h‰p_»que¡_t
 *
r
,

60 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

61 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£rv”_addr
(
ngx_h‰p_»que¡_t
 *
r
,

62 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

63 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£rv”_pÜt
(
ngx_h‰p_»que¡_t
 *
r
,

64 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

65 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_scheme
(
ngx_h‰p_»que¡_t
 *
r
,

66 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

67 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_h‰ps
(
ngx_h‰p_»que¡_t
 *
r
,

68 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

69 
ngx_h‰p_v¬ŸbË_£t_¬gs
(
ngx_h‰p_»que¡_t
 *
r
,

70 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

71 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_is_¬gs
(
ngx_h‰p_»que¡_t
 *
r
,

72 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

73 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_docum’t_roÙ
(
ngx_h‰p_»que¡_t
 *
r
,

74 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

75 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»®·th_roÙ
(
ngx_h‰p_»que¡_t
 *
r
,

76 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

77 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_fž’ame
(
ngx_h‰p_»que¡_t
 *
r
,

78 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

79 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£rv”_Çme
(
ngx_h‰p_»que¡_t
 *
r
,

80 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

81 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_m‘hod
(
ngx_h‰p_»que¡_t
 *
r
,

82 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

83 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»mÙe_u£r
(
ngx_h‰p_»que¡_t
 *
r
,

84 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

85 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_by‹s_£Á
(
ngx_h‰p_»que¡_t
 *
r
,

86 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

87 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_body_by‹s_£Á
(
ngx_h‰p_»que¡_t
 *
r
,

88 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

89 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_pe
(
ngx_h‰p_»que¡_t
 *
r
,

90 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

91 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_com¶‘iÚ
(
ngx_h‰p_»que¡_t
 *
r
,

92 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

93 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
,

94 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

95 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_body_fže
(
ngx_h‰p_»que¡_t
 *
r
,

96 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

97 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
,

98 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

99 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_»que¡_time
(
ngx_h‰p_»que¡_t
 *
r
,

100 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

101 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_¡©us
(
ngx_h‰p_»que¡_t
 *
r
,

102 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

104 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£Á_cÚ‹Á_ty³
(
ngx_h‰p_»que¡_t
 *
r
,

105 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

106 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£Á_cÚ‹Á_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
,

107 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

108 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£Á_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

109 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

110 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£Á_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
,

111 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

112 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£Á_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

113 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

114 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£Á_k“p_®ive
(
ngx_h‰p_»que¡_t
 *
r
,

115 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

116 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_£Á_Œªsãr_’codšg
(
ngx_h‰p_»que¡_t
 *
r
,

117 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

119 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

120 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

121 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_cÚÃùiÚ_»que¡s
(
ngx_h‰p_»que¡_t
 *
r
,

122 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

124 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_ngšx_v”siÚ
(
ngx_h‰p_»que¡_t
 *
r
,

125 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

126 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_ho¡Çme
(
ngx_h‰p_»que¡_t
 *
r
,

127 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

128 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_pid
(
ngx_h‰p_»que¡_t
 *
r
,

129 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

130 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_m£c
(
ngx_h‰p_»que¡_t
 *
r
,

131 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

132 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_time_iso8601
(
ngx_h‰p_»que¡_t
 *
r
,

133 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

134 
ngx_št_t
 
ngx_h‰p_v¬ŸbË_time_loÿl
(
ngx_h‰p_»que¡_t
 *
r
,

135 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
);

153 
ngx_h‰p_v¬ŸbË_t
 
	gngx_h‰p_cÜe_v¬ŸbËs
[] = {

155 { 
ngx_¡ršg
("h‰p_ho¡"), 
NULL
, 
ngx_h‰p_v¬ŸbË_h—d”
,

156 
off£tof
(
ngx_h‰p_»que¡_t
, 
h—d”s_š
.
ho¡
), 0, 0 },

158 { 
ngx_¡ršg
("h‰p_u£r_ag’t"), 
NULL
, 
ngx_h‰p_v¬ŸbË_h—d”
,

159 
off£tof
(
ngx_h‰p_»que¡_t
, 
h—d”s_š
.
u£r_ag’t
), 0, 0 },

161 { 
ngx_¡ršg
("h‰p_»ã»r"), 
NULL
, 
ngx_h‰p_v¬ŸbË_h—d”
,

162 
off£tof
(
ngx_h‰p_»que¡_t
, 
h—d”s_š
.
»ã»r
), 0, 0 },

164 #ià(
NGX_HTTP_GZIP
)

165 { 
ngx_¡ršg
("h‰p_vŸ"), 
NULL
, 
ngx_h‰p_v¬ŸbË_h—d”
,

166 
off£tof
(
ngx_h‰p_»que¡_t
, 
h—d”s_š
.
vŸ
), 0, 0 },

169 #ià(
NGX_HTTP_X_FORWARDED_FOR
)

170 { 
ngx_¡ršg
("h‰p_x_fÜw¬ded_fÜ"), 
NULL
, 
ngx_h‰p_v¬ŸbË_h—d”s
,

171 
off£tof
(
ngx_h‰p_»que¡_t
, 
h—d”s_š
.
x_fÜw¬ded_fÜ
), 0, 0 },

174 { 
ngx_¡ršg
("h‰p_cook›"), 
NULL
, 
ngx_h‰p_v¬ŸbË_cook›s
,

175 
off£tof
(
ngx_h‰p_»que¡_t
, 
h—d”s_š
.
cook›s
), 0, 0 },

177 { 
ngx_¡ršg
("cÚ‹Á_Ëngth"), 
NULL
, 
ngx_h‰p_v¬ŸbË_cÚ‹Á_Ëngth
,

180 { 
ngx_¡ršg
("cÚ‹Á_ty³"), 
NULL
, 
ngx_h‰p_v¬ŸbË_h—d”
,

181 
off£tof
(
ngx_h‰p_»que¡_t
, 
h—d”s_š
.
cÚ‹Á_ty³
), 0, 0 },

183 { 
ngx_¡ršg
("ho¡"), 
NULL
, 
ngx_h‰p_v¬ŸbË_ho¡
, 0, 0, 0 },

185 { 
ngx_¡ršg
("bš¬y_»mÙe_addr"), 
NULL
,

186 
ngx_h‰p_v¬ŸbË_bš¬y_»mÙe_addr
, 0, 0, 0 },

188 { 
ngx_¡ršg
("»mÙe_addr"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»mÙe_addr
, 0, 0, 0 },

190 { 
ngx_¡ršg
("»mÙe_pÜt"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»mÙe_pÜt
, 0, 0, 0 },

192 { 
ngx_¡ršg
("´oxy_´ÙocÞ_addr"), 
NULL
,

193 
ngx_h‰p_v¬ŸbË_´oxy_´ÙocÞ_addr
, 0, 0, 0 },

195 { 
ngx_¡ršg
("£rv”_addr"), 
NULL
, 
ngx_h‰p_v¬ŸbË_£rv”_addr
, 0, 0, 0 },

197 { 
ngx_¡ršg
("£rv”_pÜt"), 
NULL
, 
ngx_h‰p_v¬ŸbË_£rv”_pÜt
, 0, 0, 0 },

199 { 
ngx_¡ršg
("£rv”_´ÙocÞ"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»que¡
,

200 
off£tof
(
ngx_h‰p_»que¡_t
, 
h‰p_´ÙocÞ
), 0, 0 },

202 { 
ngx_¡ršg
("scheme"), 
NULL
, 
ngx_h‰p_v¬ŸbË_scheme
, 0, 0, 0 },

204 { 
ngx_¡ršg
("h‰ps"), 
NULL
, 
ngx_h‰p_v¬ŸbË_h‰ps
, 0, 0, 0 },

206 { 
ngx_¡ršg
("»que¡_uri"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»que¡
,

207 
off£tof
(
ngx_h‰p_»que¡_t
, 
uÅ¬£d_uri
), 0, 0 },

209 { 
ngx_¡ršg
("uri"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»que¡
,

210 
off£tof
(
ngx_h‰p_»que¡_t
, 
uri
),

211 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

213 { 
ngx_¡ršg
("docum’t_uri"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»que¡
,

214 
off£tof
(
ngx_h‰p_»que¡_t
, 
uri
),

215 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

217 { 
ngx_¡ršg
("»que¡"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»que¡_lše
, 0, 0, 0 },

219 { 
ngx_¡ršg
("docum’t_roÙ"), 
NULL
,

220 
ngx_h‰p_v¬ŸbË_docum’t_roÙ
, 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

222 { 
ngx_¡ršg
("»®·th_roÙ"), 
NULL
,

223 
ngx_h‰p_v¬ŸbË_»®·th_roÙ
, 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

225 { 
ngx_¡ršg
("qu”y_¡ršg"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»que¡
,

226 
off£tof
(
ngx_h‰p_»que¡_t
, 
¬gs
),

227 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

229 { 
ngx_¡ršg
("args"),

230 
ngx_h‰p_v¬ŸbË_£t_¬gs
,

231 
ngx_h‰p_v¬ŸbË_»que¡
,

232 
off£tof
(
ngx_h‰p_»que¡_t
, 
¬gs
),

233 
NGX_HTTP_VAR_CHANGEABLE
|
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

235 { 
ngx_¡ršg
("is_¬gs"), 
NULL
, 
ngx_h‰p_v¬ŸbË_is_¬gs
,

236 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

238 { 
ngx_¡ršg
("»que¡_fž’ame"), 
NULL
,

239 
ngx_h‰p_v¬ŸbË_»que¡_fž’ame
, 0,

240 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

242 { 
ngx_¡ršg
("£rv”_Çme"), 
NULL
, 
ngx_h‰p_v¬ŸbË_£rv”_Çme
, 0, 0, 0 },

244 { 
ngx_¡ršg
("»que¡_m‘hod"), 
NULL
,

245 
ngx_h‰p_v¬ŸbË_»que¡_m‘hod
, 0,

246 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

248 { 
ngx_¡ršg
("»mÙe_u£r"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»mÙe_u£r
, 0, 0, 0 },

250 { 
ngx_¡ršg
("by‹s_£Á"), 
NULL
, 
ngx_h‰p_v¬ŸbË_by‹s_£Á
,

253 { 
ngx_¡ršg
("body_by‹s_£Á"), 
NULL
, 
ngx_h‰p_v¬ŸbË_body_by‹s_£Á
,

256 { 
ngx_¡ršg
("pe"), 
NULL
, 
ngx_h‰p_v¬ŸbË_pe
,

259 { 
ngx_¡ršg
("»que¡_com¶‘iÚ"), 
NULL
,

260 
ngx_h‰p_v¬ŸbË_»que¡_com¶‘iÚ
,

263 { 
ngx_¡ršg
("»que¡_body"), 
NULL
,

264 
ngx_h‰p_v¬ŸbË_»que¡_body
,

267 { 
ngx_¡ršg
("»que¡_body_fže"), 
NULL
,

268 
ngx_h‰p_v¬ŸbË_»que¡_body_fže
,

271 { 
ngx_¡ršg
("»que¡_Ëngth"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»que¡_Ëngth
,

272 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

274 { 
ngx_¡ršg
("»que¡_time"), 
NULL
, 
ngx_h‰p_v¬ŸbË_»que¡_time
,

275 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

277 { 
ngx_¡ršg
("¡©us"), 
NULL
,

278 
ngx_h‰p_v¬ŸbË_¡©us
, 0,

279 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

281 { 
ngx_¡ršg
("£Á_h‰p_cÚ‹Á_ty³"), 
NULL
,

282 
ngx_h‰p_v¬ŸbË_£Á_cÚ‹Á_ty³
, 0, 0, 0 },

284 { 
ngx_¡ršg
("£Á_h‰p_cÚ‹Á_Ëngth"), 
NULL
,

285 
ngx_h‰p_v¬ŸbË_£Á_cÚ‹Á_Ëngth
, 0, 0, 0 },

287 { 
ngx_¡ršg
("£Á_h‰p_loÿtiÚ"), 
NULL
,

288 
ngx_h‰p_v¬ŸbË_£Á_loÿtiÚ
, 0, 0, 0 },

290 { 
ngx_¡ršg
("£Á_h‰p_Ï¡_modif›d"), 
NULL
,

291 
ngx_h‰p_v¬ŸbË_£Á_Ï¡_modif›d
, 0, 0, 0 },

293 { 
ngx_¡ršg
("£Á_h‰p_cÚÃùiÚ"), 
NULL
,

294 
ngx_h‰p_v¬ŸbË_£Á_cÚÃùiÚ
, 0, 0, 0 },

296 { 
ngx_¡ršg
("£Á_h‰p_k“p_®ive"), 
NULL
,

297 
ngx_h‰p_v¬ŸbË_£Á_k“p_®ive
, 0, 0, 0 },

299 { 
ngx_¡ršg
("£Á_h‰p_Œªsãr_’codšg"), 
NULL
,

300 
ngx_h‰p_v¬ŸbË_£Á_Œªsãr_’codšg
, 0, 0, 0 },

302 { 
ngx_¡ršg
("£Á_h‰p_ÿche_cÚŒÞ"), 
NULL
, 
ngx_h‰p_v¬ŸbË_h—d”s
,

303 
off£tof
(
ngx_h‰p_»que¡_t
, 
h—d”s_out
.
ÿche_cÚŒÞ
), 0, 0 },

305 { 
ngx_¡ršg
("lim™_¿‹"), 
ngx_h‰p_v¬ŸbË_»que¡_£t_size
,

306 
ngx_h‰p_v¬ŸbË_»que¡_g‘_size
,

307 
off£tof
(
ngx_h‰p_»que¡_t
, 
lim™_¿‹
),

308 
NGX_HTTP_VAR_CHANGEABLE
|
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

310 { 
ngx_¡ršg
("cÚÃùiÚ"), 
NULL
,

311 
ngx_h‰p_v¬ŸbË_cÚÃùiÚ
, 0, 0, 0 },

313 { 
ngx_¡ršg
("cÚÃùiÚ_»que¡s"), 
NULL
,

314 
ngx_h‰p_v¬ŸbË_cÚÃùiÚ_»que¡s
, 0, 0, 0 },

316 { 
ngx_¡ršg
("ngšx_v”siÚ"), 
NULL
, 
ngx_h‰p_v¬ŸbË_ngšx_v”siÚ
,

319 { 
ngx_¡ršg
("ho¡Çme"), 
NULL
, 
ngx_h‰p_v¬ŸbË_ho¡Çme
,

322 { 
ngx_¡ršg
("pid"), 
NULL
, 
ngx_h‰p_v¬ŸbË_pid
,

325 { 
ngx_¡ršg
("m£c"), 
NULL
, 
ngx_h‰p_v¬ŸbË_m£c
,

326 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

328 { 
ngx_¡ršg
("time_iso8601"), 
NULL
, 
ngx_h‰p_v¬ŸbË_time_iso8601
,

329 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

331 { 
ngx_¡ršg
("time_loÿl"), 
NULL
, 
ngx_h‰p_v¬ŸbË_time_loÿl
,

332 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

334 #ià(
NGX_HAVE_TCP_INFO
)

335 { 
ngx_¡ršg
("týšfo_¹t"), 
NULL
, 
ngx_h‰p_v¬ŸbË_týšfo
,

336 0, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

338 { 
ngx_¡ršg
("týšfo_¹tv¬"), 
NULL
, 
ngx_h‰p_v¬ŸbË_týšfo
,

339 1, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

341 { 
ngx_¡ršg
("týšfo_¢d_cwnd"), 
NULL
, 
ngx_h‰p_v¬ŸbË_týšfo
,

342 2, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

344 { 
ngx_¡ršg
("týšfo_rcv_¥aû"), 
NULL
, 
ngx_h‰p_v¬ŸbË_týšfo
,

345 3, 
NGX_HTTP_VAR_NOCACHEABLE
, 0 },

348 { 
ngx_nuÎ_¡ršg
, 
NULL
, NULL, 0, 0, 0 }

352 
ngx_h‰p_v¬ŸbË_v®ue_t
 
	gngx_h‰p_v¬ŸbË_nuÎ_v®ue
 =

353 
ngx_h‰p_v¬ŸbË
("");

354 
ngx_h‰p_v¬ŸbË_v®ue_t
 
	gngx_h‰p_v¬ŸbË_Œue_v®ue
 =

355 
ngx_h‰p_v¬ŸbË
("1");

358 
ngx_h‰p_v¬ŸbË_t
 *

359 
	$ngx_h‰p_add_v¬ŸbË
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
Çme
, 
ngx_ušt_t
 
æags
)

361 
ngx_št_t
 
rc
;

362 
ngx_ušt_t
 
i
;

363 
ngx_hash_key_t
 *
key
;

364 
ngx_h‰p_v¬ŸbË_t
 *
v
;

365 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

367 ià(
Çme
->
Ën
 == 0) {

368 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

370  
NULL
;

373 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

375 
key
 = 
cmcf
->
v¬ŸbËs_keys
->
keys
.
–ts
;

376 
i
 = 0; i < 
cmcf
->
v¬ŸbËs_keys
->
keys
.
ÃÉs
; i++) {

377 ià(
Çme
->
Ën
 !ð
key
[
i
].key.len

378 || 
	`ngx_¡ºÿ£cmp
(
Çme
->
d©a
, 
key
[
i
].key.d©a,‚ame->
Ën
) != 0)

383 
v
 = 
key
[
i
].
v®ue
;

385 ià(!(
v
->
æags
 & 
NGX_HTTP_VAR_CHANGEABLE
)) {

386 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

387 "thdu¶iÿ‹ \"%V\" v¬ŸbË", 
Çme
);

388  
NULL
;

391  
v
;

394 
v
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_v¬ŸbË_t
));

395 ià(
v
 =ð
NULL
) {

396  
NULL
;

399 
v
->
Çme
.
Ën
 =‚ame->len;

400 
v
->
Çme
.
d©a
 = 
	`ngx_²®loc
(
cf
->
poÞ
,‚ame->
Ën
);

401 ià(
v
->
Çme
.
d©a
 =ð
NULL
) {

402  
NULL
;

405 
	`ngx_¡¾ow
(
v
->
Çme
.
d©a
,‚ame->d©a,‚ame->
Ën
);

407 
v
->
£t_hªdËr
 = 
NULL
;

408 
v
->
g‘_hªdËr
 = 
NULL
;

409 
v
->
d©a
 = 0;

410 
v
->
æags
 = flags;

411 
v
->
šdex
 = 0;

413 
rc
 = 
	`ngx_hash_add_key
(
cmcf
->
v¬ŸbËs_keys
, &
v
->
Çme
, v, 0);

415 ià(
rc
 =ð
NGX_ERROR
) {

416  
NULL
;

419 ià(
rc
 =ð
NGX_BUSY
) {

420 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

421 "cÚæiùšg v¬ŸbË‚am\"%V\"", 
Çme
);

422  
NULL
;

425  
v
;

426 
	}
}

429 
ngx_št_t


430 
	$ngx_h‰p_g‘_v¬ŸbË_šdex
(
ngx_cÚf_t
 *
cf
, 
ngx_¡r_t
 *
Çme
)

432 
ngx_ušt_t
 
i
;

433 
ngx_h‰p_v¬ŸbË_t
 *
v
;

434 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

436 ià(
Çme
->
Ën
 == 0) {

437 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

439  
NGX_ERROR
;

442 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

444 
v
 = 
cmcf
->
v¬ŸbËs
.
–ts
;

446 ià(
v
 =ð
NULL
) {

447 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
v¬ŸbËs
, 
cf
->
poÞ
, 4,

448 (
ngx_h‰p_v¬ŸbË_t
))

449 !ð
NGX_OK
)

451  
NGX_ERROR
;

455 
i
 = 0; i < 
cmcf
->
v¬ŸbËs
.
ÃÉs
; i++) {

456 ià(
Çme
->
Ën
 !ð
v
[
i
].name.len

457 || 
	`ngx_¡ºÿ£cmp
(
Çme
->
d©a
, 
v
[
i
].Çme.d©a,‚ame->
Ën
) != 0)

462  
i
;

466 
v
 = 
	`ngx_¬¿y_push
(&
cmcf
->
v¬ŸbËs
);

467 ià(
v
 =ð
NULL
) {

468  
NGX_ERROR
;

471 
v
->
Çme
.
Ën
 =‚ame->len;

472 
v
->
Çme
.
d©a
 = 
	`ngx_²®loc
(
cf
->
poÞ
,‚ame->
Ën
);

473 ià(
v
->
Çme
.
d©a
 =ð
NULL
) {

474  
NGX_ERROR
;

477 
	`ngx_¡¾ow
(
v
->
Çme
.
d©a
,‚ame->d©a,‚ame->
Ën
);

479 
v
->
£t_hªdËr
 = 
NULL
;

480 
v
->
g‘_hªdËr
 = 
NULL
;

481 
v
->
d©a
 = 0;

482 
v
->
æags
 = 0;

483 
v
->
šdex
 = 
cmcf
->
v¬ŸbËs
.
ÃÉs
 - 1;

485  
v
->
šdex
;

486 
	}
}

489 
ngx_h‰p_v¬ŸbË_v®ue_t
 *

490 
	$ngx_h‰p_g‘_šdexed_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
šdex
)

492 
ngx_h‰p_v¬ŸbË_t
 *
v
;

493 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

495 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

497 ià(
cmcf
->
v¬ŸbËs
.
ÃÉs
 <ð
šdex
) {

498 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

499 "unknowÀv¬ŸbË index: %ui", 
šdex
);

500  
NULL
;

503 ià(
r
->
v¬ŸbËs
[
šdex
].
nÙ_found
 ||„->v¬ŸbËs[šdex].
v®id
) {

504  &
r
->
v¬ŸbËs
[
šdex
];

507 
v
 = 
cmcf
->
v¬ŸbËs
.
–ts
;

509 ià(
v
[
šdex
].
	`g‘_hªdËr
(
r
, &r->
v¬ŸbËs
[šdex], v[šdex].
d©a
)

510 =ð
NGX_OK
)

512 ià(
v
[
šdex
].
æags
 & 
NGX_HTTP_VAR_NOCACHEABLE
) {

513 
r
->
v¬ŸbËs
[
šdex
].
no_ÿch—bË
 = 1;

516  &
r
->
v¬ŸbËs
[
šdex
];

519 
r
->
v¬ŸbËs
[
šdex
].
v®id
 = 0;

520 
r
->
v¬ŸbËs
[
šdex
].
nÙ_found
 = 1;

522  
NULL
;

523 
	}
}

526 
ngx_h‰p_v¬ŸbË_v®ue_t
 *

527 
	$ngx_h‰p_g‘_æushed_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_ušt_t
 
šdex
)

529 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
;

531 
v
 = &
r
->
v¬ŸbËs
[
šdex
];

533 ià(
v
->
v®id
 || v->
nÙ_found
) {

534 ià(!
v
->
no_ÿch—bË
) {

535  
v
;

538 
v
->
v®id
 = 0;

539 
v
->
nÙ_found
 = 0;

542  
	`ngx_h‰p_g‘_šdexed_v¬ŸbË
(
r
, 
šdex
);

543 
	}
}

546 
ngx_h‰p_v¬ŸbË_v®ue_t
 *

547 
	$ngx_h‰p_g‘_v¬ŸbË
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_¡r_t
 *
Çme
, 
ngx_ušt_t
 
key
)

549 
ngx_h‰p_v¬ŸbË_t
 *
v
;

550 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

551 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

553 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

555 
v
 = 
	`ngx_hash_fšd
(&
cmcf
->
v¬ŸbËs_hash
, 
key
, 
Çme
->
d©a
,‚ame->
Ën
);

557 ià(
v
) {

558 ià(
v
->
æags
 & 
NGX_HTTP_VAR_INDEXED
) {

559  
	`ngx_h‰p_g‘_æushed_v¬ŸbË
(
r
, 
v
->
šdex
);

563 
vv
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_v¬ŸbË_v®ue_t
));

565 ià(
vv
 && 
v
->
	`g‘_hªdËr
(
r
, vv, v->
d©a
è=ð
NGX_OK
) {

566  
vv
;

569  
NULL
;

573 
vv
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_v¬ŸbË_v®ue_t
));

574 ià(
vv
 =ð
NULL
) {

575  
NULL
;

578 ià(
	`ngx_¡ºcmp
(
Çme
->
d©a
, "http_", 5) == 0) {

580 ià(
	`ngx_h‰p_v¬ŸbË_unknown_h—d”_š
(
r
, 
vv
, (
ušŒ_t
è
Çme
)

581 =ð
NGX_OK
)

583  
vv
;

586  
NULL
;

589 ià(
	`ngx_¡ºcmp
(
Çme
->
d©a
, "sent_http_", 10) == 0) {

591 ià(
	`ngx_h‰p_v¬ŸbË_unknown_h—d”_out
(
r
, 
vv
, (
ušŒ_t
è
Çme
)

592 =ð
NGX_OK
)

594  
vv
;

597  
NULL
;

600 ià(
	`ngx_¡ºcmp
(
Çme
->
d©a
, "upstream_http_", 14) == 0) {

602 ià(
	`ngx_h‰p_up¡»am_h—d”_v¬ŸbË
(
r
, 
vv
, (
ušŒ_t
è
Çme
)

603 =ð
NGX_OK
)

605  
vv
;

608  
NULL
;

611 ià(
	`ngx_¡ºcmp
(
Çme
->
d©a
, "cookie_", 7) == 0) {

613 ià(
	`ngx_h‰p_v¬ŸbË_cook›
(
r
, 
vv
, (
ušŒ_t
è
Çme
è=ð
NGX_OK
) {

614  
vv
;

617  
NULL
;

620 ià(
	`ngx_¡ºcmp
(
Çme
->
d©a
, "upstream_cookie_", 16) == 0) {

622 ià(
	`ngx_h‰p_up¡»am_cook›_v¬ŸbË
(
r
, 
vv
, (
ušŒ_t
è
Çme
)

623 =ð
NGX_OK
)

625  
vv
;

628  
NULL
;

631 ià(
	`ngx_¡ºcmp
(
Çme
->
d©a
, "arg_", 4) == 0) {

633 ià(
	`ngx_h‰p_v¬ŸbË_¬gum’t
(
r
, 
vv
, (
ušŒ_t
è
Çme
è=ð
NGX_OK
) {

634  
vv
;

637  
NULL
;

640 
vv
->
nÙ_found
 = 1;

642  
vv
;

643 
	}
}

646 
ngx_št_t


647 
	$ngx_h‰p_v¬ŸbË_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

648 
ušŒ_t
 
d©a
)

650 
ngx_¡r_t
 *
s
;

652 
s
 = (
ngx_¡r_t
 *è((*è
r
 + 
d©a
);

654 ià(
s
->
d©a
) {

655 
v
->
Ën
 = 
s
->len;

656 
v
->
v®id
 = 1;

657 
v
->
no_ÿch—bË
 = 0;

658 
v
->
nÙ_found
 = 0;

659 
v
->
d©a
 = 
s
->data;

662 
v
->
nÙ_found
 = 1;

665  
NGX_OK
;

666 
	}
}

672 
	$ngx_h‰p_v¬ŸbË_»que¡_£t
(
ngx_h‰p_»que¡_t
 *
r
,

673 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

675 
ngx_¡r_t
 *
s
;

677 
s
 = (
ngx_¡r_t
 *è((*è
r
 + 
d©a
);

679 
s
->
Ën
 = 
v
->len;

680 
s
->
d©a
 = 
v
->data;

681 
	}
}

686 
ngx_št_t


687 
	$ngx_h‰p_v¬ŸbË_»que¡_g‘_size
(
ngx_h‰p_»que¡_t
 *
r
,

688 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

690 
size_t
 *
¥
;

692 
¥
 = (
size_t
 *è((*è
r
 + 
d©a
);

694 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_SIZE_T_LEN
);

695 ià(
v
->
d©a
 =ð
NULL
) {

696  
NGX_ERROR
;

699 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%uz", *
¥
) - v->data;

700 
v
->
v®id
 = 1;

701 
v
->
no_ÿch—bË
 = 0;

702 
v
->
nÙ_found
 = 0;

704  
NGX_OK
;

705 
	}
}

709 
	$ngx_h‰p_v¬ŸbË_»que¡_£t_size
(
ngx_h‰p_»que¡_t
 *
r
,

710 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

712 
ssize_t
 
s
, *
¥
;

713 
ngx_¡r_t
 
v®
;

715 
v®
.
Ën
 = 
v
->len;

716 
v®
.
d©a
 = 
v
->data;

718 
s
 = 
	`ngx_·r£_size
(&
v®
);

720 ià(
s
 =ð
NGX_ERROR
) {

721 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

722 "šv®id siz\"%V\"", &
v®
);

726 
¥
 = (
ssize_t
 *è((*è
r
 + 
d©a
);

728 *
¥
 = 
s
;

731 
	}
}

734 
ngx_št_t


735 
	$ngx_h‰p_v¬ŸbË_h—d”
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

736 
ušŒ_t
 
d©a
)

738 
ngx_bË_–t_t
 *
h
;

740 
h
 = *(
ngx_bË_–t_t
 **è((*è
r
 + 
d©a
);

742 ià(
h
) {

743 
v
->
Ën
 = 
h
->
v®ue
.len;

744 
v
->
v®id
 = 1;

745 
v
->
no_ÿch—bË
 = 0;

746 
v
->
nÙ_found
 = 0;

747 
v
->
d©a
 = 
h
->
v®ue
.data;

750 
v
->
nÙ_found
 = 1;

753  
NGX_OK
;

754 
	}
}

757 
ngx_št_t


758 
	$ngx_h‰p_v¬ŸbË_cook›s
(
ngx_h‰p_»que¡_t
 *
r
,

759 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

761  
	`ngx_h‰p_v¬ŸbË_h—d”s_š‹º®
(
r
, 
v
, 
d©a
, ';');

762 
	}
}

765 
ngx_št_t


766 
	$ngx_h‰p_v¬ŸbË_h—d”s
(
ngx_h‰p_»que¡_t
 *
r
,

767 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

769  
	`ngx_h‰p_v¬ŸbË_h—d”s_š‹º®
(
r
, 
v
, 
d©a
, ',');

770 
	}
}

773 
ngx_št_t


774 
	$ngx_h‰p_v¬ŸbË_h—d”s_š‹º®
(
ngx_h‰p_»que¡_t
 *
r
,

775 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
, 
u_ch¬
 
£p
)

777 
size_t
 
Ën
;

778 
u_ch¬
 *
p
, *
’d
;

779 
ngx_ušt_t
 
i
, 
n
;

780 
ngx_¬¿y_t
 *
a
;

781 
ngx_bË_–t_t
 **
h
;

783 
a
 = (
ngx_¬¿y_t
 *è((*è
r
 + 
d©a
);

785 
n
 = 
a
->
ÃÉs
;

786 
h
 = 
a
->
–ts
;

788 
Ën
 = 0;

790 
i
 = 0; i < 
n
; i++) {

792 ià(
h
[
i
]->
hash
 == 0) {

796 
Ën
 +ð
h
[
i
]->
v®ue
.len + 2;

799 ià(
Ën
 == 0) {

800 
v
->
nÙ_found
 = 1;

801  
NGX_OK
;

804 
Ën
 -= 2;

806 
v
->
v®id
 = 1;

807 
v
->
no_ÿch—bË
 = 0;

808 
v
->
nÙ_found
 = 0;

810 ià(
n
 == 1) {

811 
v
->
Ën
 = (*
h
)->
v®ue
.len;

812 
v
->
d©a
 = (*
h
)->
v®ue
.data;

814  
NGX_OK
;

817 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

818 ià(
p
 =ð
NULL
) {

819  
NGX_ERROR
;

822 
v
->
Ën
 =†en;

823 
v
->
d©a
 = 
p
;

825 
’d
 = 
p
 + 
Ën
;

827 
i
 = 0; ; i++) {

829 ià(
h
[
i
]->
hash
 == 0) {

833 
p
 = 
	`ngx_cÝy
Õ, 
h
[
i
]->
v®ue
.
d©a
, h[i]->v®ue.
Ën
);

835 ià(
p
 =ð
’d
) {

839 *
p
++ = 
£p
; *p++ = ' ';

842  
NGX_OK
;

843 
	}
}

846 
ngx_št_t


847 
	$ngx_h‰p_v¬ŸbË_unknown_h—d”_š
(
ngx_h‰p_»que¡_t
 *
r
,

848 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

850  
	`ngx_h‰p_v¬ŸbË_unknown_h—d”
(
v
, (
ngx_¡r_t
 *è
d©a
,

851 &
r
->
h—d”s_š
.
h—d”s
.
·¹
,

853 
	}
}

856 
ngx_št_t


857 
	$ngx_h‰p_v¬ŸbË_unknown_h—d”_out
(
ngx_h‰p_»que¡_t
 *
r
,

858 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

860  
	`ngx_h‰p_v¬ŸbË_unknown_h—d”
(
v
, (
ngx_¡r_t
 *è
d©a
,

861 &
r
->
h—d”s_out
.
h—d”s
.
·¹
,

863 
	}
}

866 
ngx_št_t


867 
	$ngx_h‰p_v¬ŸbË_unknown_h—d”
(
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ngx_¡r_t
 *
v¬
,

868 
ngx_li¡_·¹_t
 *
·¹
, 
size_t
 
´efix
)

870 
u_ch¬
 
ch
;

871 
ngx_ušt_t
 
i
, 
n
;

872 
ngx_bË_–t_t
 *
h—d”
;

874 
h—d”
 = 
·¹
->
–ts
;

876 
i
 = 0; ; i++) {

878 ià(
i
 >ð
·¹
->
ÃÉs
) {

879 ià(
·¹
->
Ãxt
 =ð
NULL
) {

883 
·¹
 =…¬t->
Ãxt
;

884 
h—d”
 = 
·¹
->
–ts
;

885 
i
 = 0;

888 ià(
h—d”
[
i
].
hash
 == 0) {

892 
n
 = 0;‚ + 
´efix
 < 
v¬
->
Ën
 &&‚ < 
h—d”
[
i
].
key
.len;‚++) {

893 
ch
 = 
h—d”
[
i
].
key
.
d©a
[
n
];

895 ià(
ch
 >= 'A' && ch <= 'Z') {

896 
ch
 |= 0x20;

898 } ià(
ch
 == '-') {

899 
ch
 = '_';

902 ià(
v¬
->
d©a
[
n
 + 
´efix
] !ð
ch
) {

907 ià(
n
 + 
´efix
 =ð
v¬
->
Ën
 &&‚ =ð
h—d”
[
i
].
key
.len) {

908 
v
->
Ën
 = 
h—d”
[
i
].
v®ue
.len;

909 
v
->
v®id
 = 1;

910 
v
->
no_ÿch—bË
 = 0;

911 
v
->
nÙ_found
 = 0;

912 
v
->
d©a
 = 
h—d”
[
i
].
v®ue
.data;

914  
NGX_OK
;

918 
v
->
nÙ_found
 = 1;

920  
NGX_OK
;

921 
	}
}

924 
ngx_št_t


925 
	$ngx_h‰p_v¬ŸbË_»que¡_lše
(
ngx_h‰p_»que¡_t
 *
r
,

926 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

928 
u_ch¬
 *
p
, *
s
;

930 
s
 = 
r
->
»que¡_lše
.
d©a
;

932 ià(
s
 =ð
NULL
) {

933 
s
 = 
r
->
»que¡_¡¬t
;

935 ià(
s
 =ð
NULL
) {

936 
v
->
nÙ_found
 = 1;

937  
NGX_OK
;

940 
p
 = 
s
;… < 
r
->
h—d”_š
->
Ï¡
;…++) {

941 ià(*
p
 =ð
CR
 || *°=ð
LF
) {

946 
r
->
»que¡_lše
.
Ën
 = 
p
 - 
s
;

947 
r
->
»que¡_lše
.
d©a
 = 
s
;

950 
v
->
Ën
 = 
r
->
»que¡_lše
.len;

951 
v
->
v®id
 = 1;

952 
v
->
no_ÿch—bË
 = 0;

953 
v
->
nÙ_found
 = 0;

954 
v
->
d©a
 = 
s
;

956  
NGX_OK
;

957 
	}
}

960 
ngx_št_t


961 
	$ngx_h‰p_v¬ŸbË_cook›
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

962 
ušŒ_t
 
d©a
)

964 
ngx_¡r_t
 *
Çme
 = (ngx_¡r_ˆ*è
d©a
;

966 
ngx_¡r_t
 
cook›
, 
s
;

968 
s
.
Ën
 = 
Çme
->len - (("cookie_") - 1);

969 
s
.
d©a
 = 
Çme
->data + ("cookie_") - 1;

971 ià(
	`ngx_h‰p_·r£_muÉi_h—d”_lšes
(&
r
->
h—d”s_š
.
cook›s
, &
s
, &
cook›
)

972 =ð
NGX_DECLINED
)

974 
v
->
nÙ_found
 = 1;

975  
NGX_OK
;

978 
v
->
Ën
 = 
cook›
.len;

979 
v
->
v®id
 = 1;

980 
v
->
no_ÿch—bË
 = 0;

981 
v
->
nÙ_found
 = 0;

982 
v
->
d©a
 = 
cook›
.data;

984  
NGX_OK
;

985 
	}
}

988 
ngx_št_t


989 
	$ngx_h‰p_v¬ŸbË_¬gum’t
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

990 
ušŒ_t
 
d©a
)

992 
ngx_¡r_t
 *
Çme
 = (ngx_¡r_ˆ*è
d©a
;

994 
u_ch¬
 *
¬g
;

995 
size_t
 
Ën
;

996 
ngx_¡r_t
 
v®ue
;

998 
Ën
 = 
Çme
->len - (("arg_") - 1);

999 
¬g
 = 
Çme
->
d©a
 + ("arg_") - 1;

1001 ià(
	`ngx_h‰p_¬g
(
r
, 
¬g
, 
Ën
, &
v®ue
è!ð
NGX_OK
) {

1002 
v
->
nÙ_found
 = 1;

1003  
NGX_OK
;

1006 
v
->
d©a
 = 
v®ue
.data;

1007 
v
->
Ën
 = 
v®ue
.len;

1008 
v
->
v®id
 = 1;

1009 
v
->
no_ÿch—bË
 = 0;

1010 
v
->
nÙ_found
 = 0;

1012  
NGX_OK
;

1013 
	}
}

1016 #ià(
NGX_HAVE_TCP_INFO
)

1018 
ngx_št_t


1019 
	$ngx_h‰p_v¬ŸbË_týšfo
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

1020 
ušŒ_t
 
d©a
)

1022 
tý_šfo
 
ti
;

1023 
sockËn_t
 
Ën
;

1024 
ušt32_t
 
v®ue
;

1026 
Ën
 = (
tý_šfo
);

1027 ià(
	`g‘sockÝt
(
r
->
cÚÃùiÚ
->
fd
, 
IPPROTO_TCP
, 
TCP_INFO
, &
ti
, &
Ën
) == -1) {

1028 
v
->
nÙ_found
 = 1;

1029  
NGX_OK
;

1032 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_INT32_LEN
);

1033 ià(
v
->
d©a
 =ð
NULL
) {

1034  
NGX_ERROR
;

1037 
d©a
) {

1039 
v®ue
 = 
ti
.
týi_¹t
;

1043 
v®ue
 = 
ti
.
týi_¹tv¬
;

1047 
v®ue
 = 
ti
.
týi_¢d_cwnd
;

1051 
v®ue
 = 
ti
.
týi_rcv_¥aû
;

1056 
v®ue
 = 0;

1060 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%uD", 
v®ue
) - v->data;

1061 
v
->
v®id
 = 1;

1062 
v
->
no_ÿch—bË
 = 0;

1063 
v
->
nÙ_found
 = 0;

1065  
NGX_OK
;

1066 
	}
}

1071 
ngx_št_t


1072 
	$ngx_h‰p_v¬ŸbË_cÚ‹Á_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
,

1073 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1075 
u_ch¬
 *
p
;

1077 ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth
) {

1078 
v
->
Ën
 = 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth
->
v®ue
.len;

1079 
v
->
d©a
 = 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth
->
v®ue
.data;

1080 
v
->
v®id
 = 1;

1081 
v
->
no_ÿch—bË
 = 0;

1082 
v
->
nÙ_found
 = 0;

1084 } ià(
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
 >= 0) {

1085 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_OFF_T_LEN
);

1086 ià(
p
 =ð
NULL
) {

1087  
NGX_ERROR
;

1090 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%O", 
r
->
h—d”s_š
.
cÚ‹Á_Ëngth_n
) -…;

1091 
v
->
d©a
 = 
p
;

1092 
v
->
v®id
 = 1;

1093 
v
->
no_ÿch—bË
 = 0;

1094 
v
->
nÙ_found
 = 0;

1097 
v
->
nÙ_found
 = 1;

1100  
NGX_OK
;

1101 
	}
}

1104 
ngx_št_t


1105 
	$ngx_h‰p_v¬ŸbË_ho¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

1106 
ušŒ_t
 
d©a
)

1108 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

1110 ià(
r
->
h—d”s_š
.
£rv”
.
Ën
) {

1111 
v
->
Ën
 = 
r
->
h—d”s_š
.
£rv”
.len;

1112 
v
->
d©a
 = 
r
->
h—d”s_š
.
£rv”
.data;

1115 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1117 
v
->
Ën
 = 
cscf
->
£rv”_Çme
.len;

1118 
v
->
d©a
 = 
cscf
->
£rv”_Çme
.data;

1121 
v
->
v®id
 = 1;

1122 
v
->
no_ÿch—bË
 = 0;

1123 
v
->
nÙ_found
 = 0;

1125  
NGX_OK
;

1126 
	}
}

1129 
ngx_št_t


1130 
	$ngx_h‰p_v¬ŸbË_bš¬y_»mÙe_addr
(
ngx_h‰p_»que¡_t
 *
r
,

1131 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1133 
sockaddr_š
 *
sš
;

1134 #ià(
NGX_HAVE_INET6
)

1135 
sockaddr_š6
 *
sš6
;

1138 
r
->
cÚÃùiÚ
->
sockaddr
->
§_çmžy
) {

1140 #ià(
NGX_HAVE_INET6
)

1141 
AF_INET6
:

1142 
sš6
 = (
sockaddr_š6
 *è
r
->
cÚÃùiÚ
->
sockaddr
;

1144 
v
->
Ën
 = (
š6_addr
);

1145 
v
->
v®id
 = 1;

1146 
v
->
no_ÿch—bË
 = 0;

1147 
v
->
nÙ_found
 = 0;

1148 
v
->
d©a
 = 
sš6
->
sš6_addr
.
s6_addr
;

1154 
sš
 = (
sockaddr_š
 *è
r
->
cÚÃùiÚ
->
sockaddr
;

1156 
v
->
Ën
 = (
š_addr_t
);

1157 
v
->
v®id
 = 1;

1158 
v
->
no_ÿch—bË
 = 0;

1159 
v
->
nÙ_found
 = 0;

1160 
v
->
d©a
 = (
u_ch¬
 *è&
sš
->
sš_addr
;

1165  
NGX_OK
;

1166 
	}
}

1169 
ngx_št_t


1170 
	$ngx_h‰p_v¬ŸbË_»mÙe_addr
(
ngx_h‰p_»que¡_t
 *
r
,

1171 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1173 
v
->
Ën
 = 
r
->
cÚÃùiÚ
->
addr_‹xt
.len;

1174 
v
->
v®id
 = 1;

1175 
v
->
no_ÿch—bË
 = 0;

1176 
v
->
nÙ_found
 = 0;

1177 
v
->
d©a
 = 
r
->
cÚÃùiÚ
->
addr_‹xt
.data;

1179  
NGX_OK
;

1180 
	}
}

1183 
ngx_št_t


1184 
	$ngx_h‰p_v¬ŸbË_»mÙe_pÜt
(
ngx_h‰p_»que¡_t
 *
r
,

1185 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1187 
ngx_ušt_t
 
pÜt
;

1188 
sockaddr_š
 *
sš
;

1189 #ià(
NGX_HAVE_INET6
)

1190 
sockaddr_š6
 *
sš6
;

1193 
v
->
Ën
 = 0;

1194 
v
->
v®id
 = 1;

1195 
v
->
no_ÿch—bË
 = 0;

1196 
v
->
nÙ_found
 = 0;

1198 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, ("65535") - 1);

1199 ià(
v
->
d©a
 =ð
NULL
) {

1200  
NGX_ERROR
;

1203 
r
->
cÚÃùiÚ
->
sockaddr
->
§_çmžy
) {

1205 #ià(
NGX_HAVE_INET6
)

1206 
AF_INET6
:

1207 
sš6
 = (
sockaddr_š6
 *è
r
->
cÚÃùiÚ
->
sockaddr
;

1208 
pÜt
 = 
	`Áohs
(
sš6
->
sš6_pÜt
);

1212 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1213 
AF_UNIX
:

1214 
pÜt
 = 0;

1219 
sš
 = (
sockaddr_š
 *è
r
->
cÚÃùiÚ
->
sockaddr
;

1220 
pÜt
 = 
	`Áohs
(
sš
->
sš_pÜt
);

1224 ià(
pÜt
 > 0 &&…ort < 65536) {

1225 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%ui", 
pÜt
) - v->data;

1228  
NGX_OK
;

1229 
	}
}

1232 
ngx_št_t


1233 
	$ngx_h‰p_v¬ŸbË_´oxy_´ÙocÞ_addr
(
ngx_h‰p_»que¡_t
 *
r
,

1234 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1236 
v
->
Ën
 = 
r
->
cÚÃùiÚ
->
´oxy_´ÙocÞ_addr
.len;

1237 
v
->
v®id
 = 1;

1238 
v
->
no_ÿch—bË
 = 0;

1239 
v
->
nÙ_found
 = 0;

1240 
v
->
d©a
 = 
r
->
cÚÃùiÚ
->
´oxy_´ÙocÞ_addr
.data;

1242  
NGX_OK
;

1243 
	}
}

1246 
ngx_št_t


1247 
	$ngx_h‰p_v¬ŸbË_£rv”_addr
(
ngx_h‰p_»que¡_t
 *
r
,

1248 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1250 
ngx_¡r_t
 
s
;

1251 
u_ch¬
 
addr
[
NGX_SOCKADDR_STRLEN
];

1253 
s
.
Ën
 = 
NGX_SOCKADDR_STRLEN
;

1254 
s
.
d©a
 = 
addr
;

1256 ià(
	`ngx_cÚÃùiÚ_loÿl_sockaddr
(
r
->
cÚÃùiÚ
, &
s
, 0è!ð
NGX_OK
) {

1257  
NGX_ERROR
;

1260 
s
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, s.
Ën
);

1261 ià(
s
.
d©a
 =ð
NULL
) {

1262  
NGX_ERROR
;

1265 
	`ngx_memýy
(
s
.
d©a
, 
addr
, s.
Ën
);

1267 
v
->
Ën
 = 
s
.len;

1268 
v
->
v®id
 = 1;

1269 
v
->
no_ÿch—bË
 = 0;

1270 
v
->
nÙ_found
 = 0;

1271 
v
->
d©a
 = 
s
.data;

1273  
NGX_OK
;

1274 
	}
}

1277 
ngx_št_t


1278 
	$ngx_h‰p_v¬ŸbË_£rv”_pÜt
(
ngx_h‰p_»que¡_t
 *
r
,

1279 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1281 
ngx_ušt_t
 
pÜt
;

1282 
sockaddr_š
 *
sš
;

1283 #ià(
NGX_HAVE_INET6
)

1284 
sockaddr_š6
 *
sš6
;

1287 
v
->
Ën
 = 0;

1288 
v
->
v®id
 = 1;

1289 
v
->
no_ÿch—bË
 = 0;

1290 
v
->
nÙ_found
 = 0;

1292 ià(
	`ngx_cÚÃùiÚ_loÿl_sockaddr
(
r
->
cÚÃùiÚ
, 
NULL
, 0è!ð
NGX_OK
) {

1293  
NGX_ERROR
;

1296 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, ("65535") - 1);

1297 ià(
v
->
d©a
 =ð
NULL
) {

1298  
NGX_ERROR
;

1301 
r
->
cÚÃùiÚ
->
loÿl_sockaddr
->
§_çmžy
) {

1303 #ià(
NGX_HAVE_INET6
)

1304 
AF_INET6
:

1305 
sš6
 = (
sockaddr_š6
 *è
r
->
cÚÃùiÚ
->
loÿl_sockaddr
;

1306 
pÜt
 = 
	`Áohs
(
sš6
->
sš6_pÜt
);

1310 #ià(
NGX_HAVE_UNIX_DOMAIN
)

1311 
AF_UNIX
:

1312 
pÜt
 = 0;

1317 
sš
 = (
sockaddr_š
 *è
r
->
cÚÃùiÚ
->
loÿl_sockaddr
;

1318 
pÜt
 = 
	`Áohs
(
sš
->
sš_pÜt
);

1322 ià(
pÜt
 > 0 &&…ort < 65536) {

1323 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%ui", 
pÜt
) - v->data;

1326  
NGX_OK
;

1327 
	}
}

1330 
ngx_št_t


1331 
	$ngx_h‰p_v¬ŸbË_scheme
(
ngx_h‰p_»que¡_t
 *
r
,

1332 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1334 #ià(
NGX_HTTP_SSL
)

1336 ià(
r
->
cÚÃùiÚ
->
s¦
) {

1337 
v
->
Ën
 = ("https") - 1;

1338 
v
->
v®id
 = 1;

1339 
v
->
no_ÿch—bË
 = 0;

1340 
v
->
nÙ_found
 = 0;

1341 
v
->
d©a
 = (
u_ch¬
 *) "https";

1343  
NGX_OK
;

1348 
v
->
Ën
 = ("http") - 1;

1349 
v
->
v®id
 = 1;

1350 
v
->
no_ÿch—bË
 = 0;

1351 
v
->
nÙ_found
 = 0;

1352 
v
->
d©a
 = (
u_ch¬
 *) "http";

1354  
NGX_OK
;

1355 
	}
}

1358 
ngx_št_t


1359 
	$ngx_h‰p_v¬ŸbË_h‰ps
(
ngx_h‰p_»que¡_t
 *
r
,

1360 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1362 #ià(
NGX_HTTP_SSL
)

1364 ià(
r
->
cÚÃùiÚ
->
s¦
) {

1365 
v
->
Ën
 = ("on") - 1;

1366 
v
->
v®id
 = 1;

1367 
v
->
no_ÿch—bË
 = 0;

1368 
v
->
nÙ_found
 = 0;

1369 
v
->
d©a
 = (
u_ch¬
 *) "on";

1371  
NGX_OK
;

1376 *
v
 = 
ngx_h‰p_v¬ŸbË_nuÎ_v®ue
;

1378  
NGX_OK
;

1379 
	}
}

1383 
	$ngx_h‰p_v¬ŸbË_£t_¬gs
(
ngx_h‰p_»que¡_t
 *
r
,

1384 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1386 
r
->
¬gs
.
Ën
 = 
v
->len;

1387 
r
->
¬gs
.
d©a
 = 
v
->data;

1388 
r
->
v®id_uÅ¬£d_uri
 = 0;

1389 
	}
}

1392 
ngx_št_t


1393 
	$ngx_h‰p_v¬ŸbË_is_¬gs
(
ngx_h‰p_»que¡_t
 *
r
,

1394 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1396 
v
->
v®id
 = 1;

1397 
v
->
no_ÿch—bË
 = 0;

1398 
v
->
nÙ_found
 = 0;

1400 ià(
r
->
¬gs
.
Ën
 == 0) {

1401 
v
->
Ën
 = 0;

1402 
v
->
d©a
 = 
NULL
;

1403  
NGX_OK
;

1406 
v
->
Ën
 = 1;

1407 
v
->
d©a
 = (
u_ch¬
 *) "?";

1409  
NGX_OK
;

1410 
	}
}

1413 
ngx_št_t


1414 
	$ngx_h‰p_v¬ŸbË_docum’t_roÙ
(
ngx_h‰p_»que¡_t
 *
r
,

1415 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1417 
ngx_¡r_t
 
·th
;

1418 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1420 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1422 ià(
þcf
->
roÙ_Ëngths
 =ð
NULL
) {

1423 
v
->
Ën
 = 
þcf
->
roÙ
.len;

1424 
v
->
v®id
 = 1;

1425 
v
->
no_ÿch—bË
 = 0;

1426 
v
->
nÙ_found
 = 0;

1427 
v
->
d©a
 = 
þcf
->
roÙ
.data;

1430 ià(
	`ngx_h‰p_süt_run
(
r
, &
·th
, 
þcf
->
roÙ_Ëngths
->
–ts
, 0,

1431 
þcf
->
roÙ_v®ues
->
–ts
)

1432 =ð
NULL
)

1434  
NGX_ERROR
;

1437 ià(
	`ngx_g‘_fuÎ_Çme
(
r
->
poÞ
, (
ngx_¡r_t
 *è&
ngx_cyþe
->
´efix
, &
·th
)

1438 !ð
NGX_OK
)

1440  
NGX_ERROR
;

1443 
v
->
Ën
 = 
·th
.len;

1444 
v
->
v®id
 = 1;

1445 
v
->
no_ÿch—bË
 = 0;

1446 
v
->
nÙ_found
 = 0;

1447 
v
->
d©a
 = 
·th
.data;

1450  
NGX_OK
;

1451 
	}
}

1454 
ngx_št_t


1455 
	$ngx_h‰p_v¬ŸbË_»®·th_roÙ
(
ngx_h‰p_»que¡_t
 *
r
,

1456 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1458 
u_ch¬
 *
»®
;

1459 
size_t
 
Ën
;

1460 
ngx_¡r_t
 
·th
;

1461 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1462 #ià(
NGX_HAVE_MAX_PATH
)

1463 
u_ch¬
 
bufãr
[
NGX_MAX_PATH
];

1466 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1468 ià(
þcf
->
roÙ_Ëngths
 =ð
NULL
) {

1469 
·th
 = 
þcf
->
roÙ
;

1472 ià(
	`ngx_h‰p_süt_run
(
r
, &
·th
, 
þcf
->
roÙ_Ëngths
->
–ts
, 1,

1473 
þcf
->
roÙ_v®ues
->
–ts
)

1474 =ð
NULL
)

1476  
NGX_ERROR
;

1479 
·th
.
d©a
[·th.
Ën
 - 1] = '\0';

1481 ià(
	`ngx_g‘_fuÎ_Çme
(
r
->
poÞ
, (
ngx_¡r_t
 *è&
ngx_cyþe
->
´efix
, &
·th
)

1482 !ð
NGX_OK
)

1484  
NGX_ERROR
;

1488 #ià(
NGX_HAVE_MAX_PATH
)

1489 
»®
 = 
bufãr
;

1491 
»®
 = 
NULL
;

1494 
»®
 = 
	`ngx_»®·th
(
·th
.
d©a
,„eal);

1496 ià(
»®
 =ð
NULL
) {

1497 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
r
->
cÚÃùiÚ
->
log
, 
ngx_”ºo
,

1498 
ngx_»®·th_n
 " \"%s\" fažed", 
·th
.
d©a
);

1499  
NGX_ERROR
;

1502 
Ën
 = 
	`ngx_¡¾’
(
»®
);

1504 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

1505 ià(
v
->
d©a
 =ð
NULL
) {

1506 #ià!(
NGX_HAVE_MAX_PATH
)

1507 
	`ngx_ä“
(
»®
);

1509  
NGX_ERROR
;

1512 
v
->
Ën
 =†en;

1513 
v
->
v®id
 = 1;

1514 
v
->
no_ÿch—bË
 = 0;

1515 
v
->
nÙ_found
 = 0;

1517 
	`ngx_memýy
(
v
->
d©a
, 
»®
, 
Ën
);

1519 #ià!(
NGX_HAVE_MAX_PATH
)

1520 
	`ngx_ä“
(
»®
);

1523  
NGX_OK
;

1524 
	}
}

1527 
ngx_št_t


1528 
	$ngx_h‰p_v¬ŸbË_»que¡_fž’ame
(
ngx_h‰p_»que¡_t
 *
r
,

1529 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1531 
size_t
 
roÙ
;

1532 
ngx_¡r_t
 
·th
;

1534 ià(
	`ngx_h‰p_m­_uri_to_·th
(
r
, &
·th
, &
roÙ
, 0è=ð
NULL
) {

1535  
NGX_ERROR
;

1540 
v
->
Ën
 = 
·th
.len - 1;

1541 
v
->
v®id
 = 1;

1542 
v
->
no_ÿch—bË
 = 0;

1543 
v
->
nÙ_found
 = 0;

1544 
v
->
d©a
 = 
·th
.data;

1546  
NGX_OK
;

1547 
	}
}

1550 
ngx_št_t


1551 
	$ngx_h‰p_v¬ŸbË_£rv”_Çme
(
ngx_h‰p_»que¡_t
 *
r
,

1552 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1554 
ngx_h‰p_cÜe_¤v_cÚf_t
 *
cscf
;

1556 
cscf
 = 
	`ngx_h‰p_g‘_moduË_¤v_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1558 
v
->
Ën
 = 
cscf
->
£rv”_Çme
.len;

1559 
v
->
v®id
 = 1;

1560 
v
->
no_ÿch—bË
 = 0;

1561 
v
->
nÙ_found
 = 0;

1562 
v
->
d©a
 = 
cscf
->
£rv”_Çme
.data;

1564  
NGX_OK
;

1565 
	}
}

1568 
ngx_št_t


1569 
	$ngx_h‰p_v¬ŸbË_»que¡_m‘hod
(
ngx_h‰p_»que¡_t
 *
r
,

1570 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1572 ià(
r
->
maš
->
m‘hod_Çme
.
d©a
) {

1573 
v
->
Ën
 = 
r
->
maš
->
m‘hod_Çme
.len;

1574 
v
->
v®id
 = 1;

1575 
v
->
no_ÿch—bË
 = 0;

1576 
v
->
nÙ_found
 = 0;

1577 
v
->
d©a
 = 
r
->
maš
->
m‘hod_Çme
.data;

1580 
v
->
nÙ_found
 = 1;

1583  
NGX_OK
;

1584 
	}
}

1587 
ngx_št_t


1588 
	$ngx_h‰p_v¬ŸbË_»mÙe_u£r
(
ngx_h‰p_»que¡_t
 *
r
,

1589 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1591 
ngx_št_t
 
rc
;

1593 
rc
 = 
	`ngx_h‰p_auth_basic_u£r
(
r
);

1595 ià(
rc
 =ð
NGX_DECLINED
) {

1596 
v
->
nÙ_found
 = 1;

1597  
NGX_OK
;

1600 ià(
rc
 =ð
NGX_ERROR
) {

1601  
NGX_ERROR
;

1604 
v
->
Ën
 = 
r
->
h—d”s_š
.
u£r
.len;

1605 
v
->
v®id
 = 1;

1606 
v
->
no_ÿch—bË
 = 0;

1607 
v
->
nÙ_found
 = 0;

1608 
v
->
d©a
 = 
r
->
h—d”s_š
.
u£r
.data;

1610  
NGX_OK
;

1611 
	}
}

1614 
ngx_št_t


1615 
	$ngx_h‰p_v¬ŸbË_by‹s_£Á
(
ngx_h‰p_»que¡_t
 *
r
,

1616 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1618 
u_ch¬
 *
p
;

1620 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_OFF_T_LEN
);

1621 ià(
p
 =ð
NULL
) {

1622  
NGX_ERROR
;

1625 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%O", 
r
->
cÚÃùiÚ
->
£Á
) -…;

1626 
v
->
v®id
 = 1;

1627 
v
->
no_ÿch—bË
 = 0;

1628 
v
->
nÙ_found
 = 0;

1629 
v
->
d©a
 = 
p
;

1631  
NGX_OK
;

1632 
	}
}

1635 
ngx_št_t


1636 
	$ngx_h‰p_v¬ŸbË_body_by‹s_£Á
(
ngx_h‰p_»que¡_t
 *
r
,

1637 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1639 
off_t
 
£Á
;

1640 
u_ch¬
 *
p
;

1642 
£Á
 = 
r
->
cÚÃùiÚ
->£Á -„->
h—d”_size
;

1644 ià(
£Á
 < 0) {

1645 
£Á
 = 0;

1648 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_OFF_T_LEN
);

1649 ià(
p
 =ð
NULL
) {

1650  
NGX_ERROR
;

1653 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%O", 
£Á
) -…;

1654 
v
->
v®id
 = 1;

1655 
v
->
no_ÿch—bË
 = 0;

1656 
v
->
nÙ_found
 = 0;

1657 
v
->
d©a
 = 
p
;

1659  
NGX_OK
;

1660 
	}
}

1663 
ngx_št_t


1664 
	$ngx_h‰p_v¬ŸbË_pe
(
ngx_h‰p_»que¡_t
 *
r
,

1665 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1667 
v
->
d©a
 = (
u_ch¬
 *è(
r
->
p–še
 ? "p" : ".");

1668 
v
->
Ën
 = 1;

1669 
v
->
v®id
 = 1;

1670 
v
->
no_ÿch—bË
 = 0;

1671 
v
->
nÙ_found
 = 0;

1673  
NGX_OK
;

1674 
	}
}

1677 
ngx_št_t


1678 
	$ngx_h‰p_v¬ŸbË_¡©us
(
ngx_h‰p_»que¡_t
 *
r
,

1679 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1681 
ngx_ušt_t
 
¡©us
;

1683 
v
->
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_INT_T_LEN
);

1684 ià(
v
->
d©a
 =ð
NULL
) {

1685  
NGX_ERROR
;

1688 ià(
r
->
”r_¡©us
) {

1689 
¡©us
 = 
r
->
”r_¡©us
;

1691 } ià(
r
->
h—d”s_out
.
¡©us
) {

1692 
¡©us
 = 
r
->
h—d”s_out
.status;

1694 } ià(
r
->
h‰p_v”siÚ
 =ð
NGX_HTTP_VERSION_9
) {

1695 
¡©us
 = 9;

1698 
¡©us
 = 0;

1701 
v
->
Ën
 = 
	`ngx_¥rštf
(v->
d©a
, "%03ui", 
¡©us
) - v->data;

1702 
v
->
v®id
 = 1;

1703 
v
->
no_ÿch—bË
 = 0;

1704 
v
->
nÙ_found
 = 0;

1706  
NGX_OK
;

1707 
	}
}

1710 
ngx_št_t


1711 
	$ngx_h‰p_v¬ŸbË_£Á_cÚ‹Á_ty³
(
ngx_h‰p_»que¡_t
 *
r
,

1712 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1714 ià(
r
->
h—d”s_out
.
cÚ‹Á_ty³
.
Ën
) {

1715 
v
->
Ën
 = 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.len;

1716 
v
->
v®id
 = 1;

1717 
v
->
no_ÿch—bË
 = 0;

1718 
v
->
nÙ_found
 = 0;

1719 
v
->
d©a
 = 
r
->
h—d”s_out
.
cÚ‹Á_ty³
.data;

1722 
v
->
nÙ_found
 = 1;

1725  
NGX_OK
;

1726 
	}
}

1729 
ngx_št_t


1730 
	$ngx_h‰p_v¬ŸbË_£Á_cÚ‹Á_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
,

1731 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1733 
u_ch¬
 *
p
;

1735 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
) {

1736 
v
->
Ën
 = 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
->
v®ue
.len;

1737 
v
->
v®id
 = 1;

1738 
v
->
no_ÿch—bË
 = 0;

1739 
v
->
nÙ_found
 = 0;

1740 
v
->
d©a
 = 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth
->
v®ue
.data;

1742  
NGX_OK
;

1745 ià(
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
 >= 0) {

1746 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_OFF_T_LEN
);

1747 ià(
p
 =ð
NULL
) {

1748  
NGX_ERROR
;

1751 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%O", 
r
->
h—d”s_out
.
cÚ‹Á_Ëngth_n
) -…;

1752 
v
->
v®id
 = 1;

1753 
v
->
no_ÿch—bË
 = 0;

1754 
v
->
nÙ_found
 = 0;

1755 
v
->
d©a
 = 
p
;

1757  
NGX_OK
;

1760 
v
->
nÙ_found
 = 1;

1762  
NGX_OK
;

1763 
	}
}

1766 
ngx_št_t


1767 
	$ngx_h‰p_v¬ŸbË_£Á_loÿtiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

1768 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1770 
ngx_¡r_t
 
Çme
;

1772 ià(
r
->
h—d”s_out
.
loÿtiÚ
) {

1773 
v
->
Ën
 = 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.len;

1774 
v
->
v®id
 = 1;

1775 
v
->
no_ÿch—bË
 = 0;

1776 
v
->
nÙ_found
 = 0;

1777 
v
->
d©a
 = 
r
->
h—d”s_out
.
loÿtiÚ
->
v®ue
.data;

1779  
NGX_OK
;

1782 
	`ngx_¡r_£t
(&
Çme
, "sent_http_location");

1784  
	`ngx_h‰p_v¬ŸbË_unknown_h—d”
(
v
, &
Çme
,

1785 &
r
->
h—d”s_out
.
h—d”s
.
·¹
,

1787 
	}
}

1790 
ngx_št_t


1791 
	$ngx_h‰p_v¬ŸbË_£Á_Ï¡_modif›d
(
ngx_h‰p_»que¡_t
 *
r
,

1792 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1794 
u_ch¬
 *
p
;

1796 ià(
r
->
h—d”s_out
.
Ï¡_modif›d
) {

1797 
v
->
Ën
 = 
r
->
h—d”s_out
.
Ï¡_modif›d
->
v®ue
.len;

1798 
v
->
v®id
 = 1;

1799 
v
->
no_ÿch—bË
 = 0;

1800 
v
->
nÙ_found
 = 0;

1801 
v
->
d©a
 = 
r
->
h—d”s_out
.
Ï¡_modif›d
->
v®ue
.data;

1803  
NGX_OK
;

1806 ià(
r
->
h—d”s_out
.
Ï¡_modif›d_time
 >= 0) {

1807 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, ("Mon, 28 Sep 1970 06:00:00 GMT") - 1);

1808 ià(
p
 =ð
NULL
) {

1809  
NGX_ERROR
;

1812 
v
->
Ën
 = 
	`ngx_h‰p_time
(
p
, 
r
->
h—d”s_out
.
Ï¡_modif›d_time
) -…;

1813 
v
->
v®id
 = 1;

1814 
v
->
no_ÿch—bË
 = 0;

1815 
v
->
nÙ_found
 = 0;

1816 
v
->
d©a
 = 
p
;

1818  
NGX_OK
;

1821 
v
->
nÙ_found
 = 1;

1823  
NGX_OK
;

1824 
	}
}

1827 
ngx_št_t


1828 
	$ngx_h‰p_v¬ŸbË_£Á_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

1829 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1831 
size_t
 
Ën
;

1832 *
p
;

1834 ià(
r
->
h—d”s_out
.
¡©us
 =ð
NGX_HTTP_SWITCHING_PROTOCOLS
) {

1835 
Ën
 = ("upgrade") - 1;

1836 
p
 = "upgrade";

1838 } ià(
r
->
k“·live
) {

1839 
Ën
 = ("keep-alive") - 1;

1840 
p
 = "keep-alive";

1843 
Ën
 = ("close") - 1;

1844 
p
 = "close";

1847 
v
->
Ën
 =†en;

1848 
v
->
v®id
 = 1;

1849 
v
->
no_ÿch—bË
 = 0;

1850 
v
->
nÙ_found
 = 0;

1851 
v
->
d©a
 = (
u_ch¬
 *è
p
;

1853  
NGX_OK
;

1854 
	}
}

1857 
ngx_št_t


1858 
	$ngx_h‰p_v¬ŸbË_£Á_k“p_®ive
(
ngx_h‰p_»que¡_t
 *
r
,

1859 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1861 
u_ch¬
 *
p
;

1862 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

1864 ià(
r
->
k“·live
) {

1865 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

1867 ià(
þcf
->
k“·live_h—d”
) {

1869 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, ("timeout="è- 1 + 
NGX_TIME_T_LEN
);

1870 ià(
p
 =ð
NULL
) {

1871  
NGX_ERROR
;

1874 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "timeout=%T", 
þcf
->
k“·live_h—d”
) -…;

1875 
v
->
v®id
 = 1;

1876 
v
->
no_ÿch—bË
 = 0;

1877 
v
->
nÙ_found
 = 0;

1878 
v
->
d©a
 = 
p
;

1880  
NGX_OK
;

1884 
v
->
nÙ_found
 = 1;

1886  
NGX_OK
;

1887 
	}
}

1890 
ngx_št_t


1891 
	$ngx_h‰p_v¬ŸbË_£Á_Œªsãr_’codšg
(
ngx_h‰p_»que¡_t
 *
r
,

1892 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1894 ià(
r
->
chunked
) {

1895 
v
->
Ën
 = ("chunked") - 1;

1896 
v
->
v®id
 = 1;

1897 
v
->
no_ÿch—bË
 = 0;

1898 
v
->
nÙ_found
 = 0;

1899 
v
->
d©a
 = (
u_ch¬
 *) "chunked";

1902 
v
->
nÙ_found
 = 1;

1905  
NGX_OK
;

1906 
	}
}

1909 
ngx_št_t


1910 
	$ngx_h‰p_v¬ŸbË_»que¡_com¶‘iÚ
(
ngx_h‰p_»que¡_t
 *
r
,

1911 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1913 ià(
r
->
»que¡_com¶‘e
) {

1914 
v
->
Ën
 = 2;

1915 
v
->
v®id
 = 1;

1916 
v
->
no_ÿch—bË
 = 0;

1917 
v
->
nÙ_found
 = 0;

1918 
v
->
d©a
 = (
u_ch¬
 *) "OK";

1920  
NGX_OK
;

1923 
v
->
Ën
 = 0;

1924 
v
->
v®id
 = 1;

1925 
v
->
no_ÿch—bË
 = 0;

1926 
v
->
nÙ_found
 = 0;

1927 
v
->
d©a
 = (
u_ch¬
 *) "";

1929  
NGX_OK
;

1930 
	}
}

1933 
ngx_št_t


1934 
	$ngx_h‰p_v¬ŸbË_»que¡_body
(
ngx_h‰p_»que¡_t
 *
r
,

1935 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1937 
u_ch¬
 *
p
;

1938 
size_t
 
Ën
;

1939 
ngx_buf_t
 *
buf
;

1940 
ngx_chaš_t
 *
þ
;

1942 ià(
r
->
»que¡_body
 =ð
NULL


1943 || 
r
->
»que¡_body
->
bufs
 =ð
NULL


1944 || 
r
->
»que¡_body
->
‹mp_fže
)

1946 
v
->
nÙ_found
 = 1;

1948  
NGX_OK
;

1951 
þ
 = 
r
->
»que¡_body
->
bufs
;

1952 
buf
 = 
þ
->buf;

1954 ià(
þ
->
Ãxt
 =ð
NULL
) {

1955 
v
->
Ën
 = 
buf
->
Ï¡
 - buf->
pos
;

1956 
v
->
v®id
 = 1;

1957 
v
->
no_ÿch—bË
 = 0;

1958 
v
->
nÙ_found
 = 0;

1959 
v
->
d©a
 = 
buf
->
pos
;

1961  
NGX_OK
;

1964 
Ën
 = 
buf
->
Ï¡
 - buf->
pos
;

1965 
þ
 = cl->
Ãxt
;

1967  ; 
þ
; cÈðþ->
Ãxt
) {

1968 
buf
 = 
þ
->buf;

1969 
Ën
 +ð
buf
->
Ï¡
 - buf->
pos
;

1972 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

1973 ià(
p
 =ð
NULL
) {

1974  
NGX_ERROR
;

1977 
v
->
d©a
 = 
p
;

1978 
þ
 = 
r
->
»que¡_body
->
bufs
;

1980  ; 
þ
; cÈðþ->
Ãxt
) {

1981 
buf
 = 
þ
->buf;

1982 
p
 = 
	`ngx_ýymem
Õ, 
buf
->
pos
, buf->
Ï¡
 - buf->pos);

1985 
v
->
Ën
 =†en;

1986 
v
->
v®id
 = 1;

1987 
v
->
no_ÿch—bË
 = 0;

1988 
v
->
nÙ_found
 = 0;

1990  
NGX_OK
;

1991 
	}
}

1994 
ngx_št_t


1995 
	$ngx_h‰p_v¬ŸbË_»que¡_body_fže
(
ngx_h‰p_»que¡_t
 *
r
,

1996 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

1998 ià(
r
->
»que¡_body
 =ð
NULL
 ||„->»que¡_body->
‹mp_fže
 == NULL) {

1999 
v
->
nÙ_found
 = 1;

2001  
NGX_OK
;

2004 
v
->
Ën
 = 
r
->
»que¡_body
->
‹mp_fže
->
fže
.
Çme
.len;

2005 
v
->
v®id
 = 1;

2006 
v
->
no_ÿch—bË
 = 0;

2007 
v
->
nÙ_found
 = 0;

2008 
v
->
d©a
 = 
r
->
»que¡_body
->
‹mp_fže
->
fže
.
Çme
.data;

2010  
NGX_OK
;

2011 
	}
}

2014 
ngx_št_t


2015 
	$ngx_h‰p_v¬ŸbË_»que¡_Ëngth
(
ngx_h‰p_»que¡_t
 *
r
,

2016 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2018 
u_ch¬
 *
p
;

2020 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_OFF_T_LEN
);

2021 ià(
p
 =ð
NULL
) {

2022  
NGX_ERROR
;

2025 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%O", 
r
->
»que¡_Ëngth
) -…;

2026 
v
->
v®id
 = 1;

2027 
v
->
no_ÿch—bË
 = 0;

2028 
v
->
nÙ_found
 = 0;

2029 
v
->
d©a
 = 
p
;

2031  
NGX_OK
;

2032 
	}
}

2035 
ngx_št_t


2036 
	$ngx_h‰p_v¬ŸbË_»que¡_time
(
ngx_h‰p_»que¡_t
 *
r
,

2037 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2039 
u_ch¬
 *
p
;

2040 
ngx_time_t
 *

;

2041 
ngx_m£c_št_t
 
ms
;

2043 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_TIME_T_LEN
 + 4);

2044 ià(
p
 =ð
NULL
) {

2045  
NGX_ERROR
;

2048 

 = 
	`ngx_timeofday
();

2050 
ms
 = (
ngx_m£c_št_t
)

2051 ((

->
£c
 - 
r
->
¡¬t_£c
è* 1000 + (->
m£c
 -„->
¡¬t_m£c
));

2052 
ms
 = 
	`ngx_max
(ms, 0);

2054 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%T.%03M", (
time_t
è
ms
 / 1000, ms % 1000) -…;

2055 
v
->
v®id
 = 1;

2056 
v
->
no_ÿch—bË
 = 0;

2057 
v
->
nÙ_found
 = 0;

2058 
v
->
d©a
 = 
p
;

2060  
NGX_OK
;

2061 
	}
}

2064 
ngx_št_t


2065 
	$ngx_h‰p_v¬ŸbË_cÚÃùiÚ
(
ngx_h‰p_»que¡_t
 *
r
,

2066 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2068 
u_ch¬
 *
p
;

2070 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_ATOMIC_T_LEN
);

2071 ià(
p
 =ð
NULL
) {

2072  
NGX_ERROR
;

2075 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%uA", 
r
->
cÚÃùiÚ
->
numb”
) -…;

2076 
v
->
v®id
 = 1;

2077 
v
->
no_ÿch—bË
 = 0;

2078 
v
->
nÙ_found
 = 0;

2079 
v
->
d©a
 = 
p
;

2081  
NGX_OK
;

2082 
	}
}

2085 
ngx_št_t


2086 
	$ngx_h‰p_v¬ŸbË_cÚÃùiÚ_»que¡s
(
ngx_h‰p_»que¡_t
 *
r
,

2087 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2089 
u_ch¬
 *
p
;

2091 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_INT_T_LEN
);

2092 ià(
p
 =ð
NULL
) {

2093  
NGX_ERROR
;

2096 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%ui", 
r
->
cÚÃùiÚ
->
»que¡s
) -…;

2097 
v
->
v®id
 = 1;

2098 
v
->
no_ÿch—bË
 = 0;

2099 
v
->
nÙ_found
 = 0;

2100 
v
->
d©a
 = 
p
;

2102  
NGX_OK
;

2103 
	}
}

2106 
ngx_št_t


2107 
	$ngx_h‰p_v¬ŸbË_ngšx_v”siÚ
(
ngx_h‰p_»que¡_t
 *
r
,

2108 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2110 
v
->
Ën
 = (
NGINX_VERSION
) - 1;

2111 
v
->
v®id
 = 1;

2112 
v
->
no_ÿch—bË
 = 0;

2113 
v
->
nÙ_found
 = 0;

2114 
v
->
d©a
 = (
u_ch¬
 *è
NGINX_VERSION
;

2116  
NGX_OK
;

2117 
	}
}

2120 
ngx_št_t


2121 
	$ngx_h‰p_v¬ŸbË_ho¡Çme
(
ngx_h‰p_»que¡_t
 *
r
,

2122 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2124 
v
->
Ën
 = 
ngx_cyþe
->
ho¡Çme
.len;

2125 
v
->
v®id
 = 1;

2126 
v
->
no_ÿch—bË
 = 0;

2127 
v
->
nÙ_found
 = 0;

2128 
v
->
d©a
 = 
ngx_cyþe
->
ho¡Çme
.data;

2130  
NGX_OK
;

2131 
	}
}

2134 
ngx_št_t


2135 
	$ngx_h‰p_v¬ŸbË_pid
(
ngx_h‰p_»que¡_t
 *
r
,

2136 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2138 
u_ch¬
 *
p
;

2140 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_INT64_LEN
);

2141 ià(
p
 =ð
NULL
) {

2142  
NGX_ERROR
;

2145 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%P", 
ngx_pid
) -…;

2146 
v
->
v®id
 = 1;

2147 
v
->
no_ÿch—bË
 = 0;

2148 
v
->
nÙ_found
 = 0;

2149 
v
->
d©a
 = 
p
;

2151  
NGX_OK
;

2152 
	}
}

2155 
ngx_št_t


2156 
	$ngx_h‰p_v¬ŸbË_m£c
(
ngx_h‰p_»que¡_t
 *
r
,

2157 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2159 
u_ch¬
 *
p
;

2160 
ngx_time_t
 *

;

2162 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
NGX_TIME_T_LEN
 + 4);

2163 ià(
p
 =ð
NULL
) {

2164  
NGX_ERROR
;

2167 

 = 
	`ngx_timeofday
();

2169 
v
->
Ën
 = 
	`ngx_¥rštf
(
p
, "%T.%03M", 

->
£c
,p->
m£c
) -…;

2170 
v
->
v®id
 = 1;

2171 
v
->
no_ÿch—bË
 = 0;

2172 
v
->
nÙ_found
 = 0;

2173 
v
->
d©a
 = 
p
;

2175  
NGX_OK
;

2176 
	}
}

2179 
ngx_št_t


2180 
	$ngx_h‰p_v¬ŸbË_time_iso8601
(
ngx_h‰p_»que¡_t
 *
r
,

2181 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2183 
u_ch¬
 *
p
;

2185 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
ngx_ÿched_h‰p_log_iso8601
.
Ën
);

2186 ià(
p
 =ð
NULL
) {

2187  
NGX_ERROR
;

2190 
	`ngx_memýy
(
p
, 
ngx_ÿched_h‰p_log_iso8601
.
d©a
,

2191 
ngx_ÿched_h‰p_log_iso8601
.
Ën
);

2193 
v
->
Ën
 = 
ngx_ÿched_h‰p_log_iso8601
.len;

2194 
v
->
v®id
 = 1;

2195 
v
->
no_ÿch—bË
 = 0;

2196 
v
->
nÙ_found
 = 0;

2197 
v
->
d©a
 = 
p
;

2199  
NGX_OK
;

2200 
	}
}

2203 
ngx_št_t


2204 
	$ngx_h‰p_v¬ŸbË_time_loÿl
(
ngx_h‰p_»que¡_t
 *
r
,

2205 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
, 
ušŒ_t
 
d©a
)

2207 
u_ch¬
 *
p
;

2209 
p
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
ngx_ÿched_h‰p_log_time
.
Ën
);

2210 ià(
p
 =ð
NULL
) {

2211  
NGX_ERROR
;

2214 
	`ngx_memýy
(
p
, 
ngx_ÿched_h‰p_log_time
.
d©a
,‚gx_ÿched_h‰p_log_time.
Ën
);

2216 
v
->
Ën
 = 
ngx_ÿched_h‰p_log_time
.len;

2217 
v
->
v®id
 = 1;

2218 
v
->
no_ÿch—bË
 = 0;

2219 
v
->
nÙ_found
 = 0;

2220 
v
->
d©a
 = 
p
;

2222  
NGX_OK
;

2223 
	}
}

2227 
	$ngx_h‰p_m­_fšd
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_m­_t
 *
m­
, 
ngx_¡r_t
 *
m©ch
)

2229 *
v®ue
;

2230 
u_ch¬
 *
low
;

2231 
size_t
 
Ën
;

2232 
ngx_ušt_t
 
key
;

2234 
Ën
 = 
m©ch
->len;

2236 ià(
Ën
) {

2237 
low
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

2238 ià(
low
 =ð
NULL
) {

2239  
NULL
;

2243 
low
 = 
NULL
;

2246 
key
 = 
	`ngx_hash_¡¾ow
(
low
, 
m©ch
->
d©a
, 
Ën
);

2248 
v®ue
 = 
	`ngx_hash_fšd_combšed
(&
m­
->
hash
, 
key
, 
low
, 
Ën
);

2249 ià(
v®ue
) {

2250  
v®ue
;

2253 #ià(
NGX_PCRE
)

2255 ià(
Ën
 && 
m­
->
Äegex
) {

2256 
ngx_št_t
 
n
;

2257 
ngx_ušt_t
 
i
;

2258 
ngx_h‰p_m­_»gex_t
 *
»g
;

2260 
»g
 = 
m­
->
»gex
;

2262 
i
 = 0; i < 
m­
->
Äegex
; i++) {

2264 
n
 = 
	`ngx_h‰p_»gex_exec
(
r
, 
»g
[
i
].
»gex
, 
m©ch
);

2266 ià(
n
 =ð
NGX_OK
) {

2267  
»g
[
i
].
v®ue
;

2270 ià(
n
 =ð
NGX_DECLINED
) {

2276  
NULL
;

2282  
NULL
;

2283 
	}
}

2286 #ià(
NGX_PCRE
)

2288 
ngx_št_t


2289 
	$ngx_h‰p_v¬ŸbË_nÙ_found
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
v
,

2290 
ušŒ_t
 
d©a
)

2292 
v
->
nÙ_found
 = 1;

2293  
NGX_OK
;

2294 
	}
}

2297 
ngx_h‰p_»gex_t
 *

2298 
	$ngx_h‰p_»gex_compže
(
ngx_cÚf_t
 *
cf
, 
ngx_»gex_compže_t
 *
rc
)

2300 
u_ch¬
 *
p
;

2301 
size_t
 
size
;

2302 
ngx_¡r_t
 
Çme
;

2303 
ngx_ušt_t
 
i
, 
n
;

2304 
ngx_h‰p_v¬ŸbË_t
 *
v
;

2305 
ngx_h‰p_»gex_t
 *
»
;

2306 
ngx_h‰p_»gex_v¬ŸbË_t
 *
rv
;

2307 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

2309 
rc
->
poÞ
 = 
cf
->pool;

2311 ià(
	`ngx_»gex_compže
(
rc
è!ð
NGX_OK
) {

2312 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "%V", &
rc
->
”r
);

2313  
NULL
;

2316 
»
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_h‰p_»gex_t
));

2317 ià(
»
 =ð
NULL
) {

2318  
NULL
;

2321 
»
->
»gex
 = 
rc
->regex;

2322 
»
->
nÿ±u»s
 = 
rc
->
ÿ±u»s
;

2323 
»
->
Çme
 = 
rc
->
·‰”n
;

2325 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

2326 
cmcf
->
nÿ±u»s
 = 
	`ngx_max
(cmcf->nÿ±u»s, 
»
->ncaptures);

2328 
n
 = (
ngx_ušt_t
è
rc
->
Çmed_ÿ±u»s
;

2330 ià(
n
 == 0) {

2331  
»
;

2334 
rv
 = 
	`ngx_·Îoc
(
rc
->
poÞ
, 
n
 * (
ngx_h‰p_»gex_v¬ŸbË_t
));

2335 ià(
rv
 =ð
NULL
) {

2336  
NULL
;

2339 
»
->
v¬ŸbËs
 = 
rv
;

2340 
»
->
nv¬ŸbËs
 = 
n
;

2342 
size
 = 
rc
->
Çme_size
;

2343 
p
 = 
rc
->
Çmes
;

2345 
i
 = 0; i < 
n
; i++) {

2346 
rv
[
i
].
ÿ±u»
 = 2 * ((
p
[0] << 8) +…[1]);

2348 
Çme
.
d©a
 = &
p
[2];

2349 
Çme
.
Ën
 = 
	`ngx_¡¾’
Òame.
d©a
);

2351 
v
 = 
	`ngx_h‰p_add_v¬ŸbË
(
cf
, &
Çme
, 
NGX_HTTP_VAR_CHANGEABLE
);

2352 ià(
v
 =ð
NULL
) {

2353  
NULL
;

2356 
rv
[
i
].
šdex
 = 
	`ngx_h‰p_g‘_v¬ŸbË_šdex
(
cf
, &
Çme
);

2357 ià(
rv
[
i
].
šdex
 =ð
NGX_ERROR
) {

2358  
NULL
;

2361 
v
->
g‘_hªdËr
 = 
ngx_h‰p_v¬ŸbË_nÙ_found
;

2363 
p
 +ð
size
;

2366  
»
;

2367 
	}
}

2370 
ngx_št_t


2371 
	$ngx_h‰p_»gex_exec
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_h‰p_»gex_t
 *
»
, 
ngx_¡r_t
 *
s
)

2373 
ngx_št_t
 
rc
, 
šdex
;

2374 
ngx_ušt_t
 
i
, 
n
, 
Ën
;

2375 
ngx_h‰p_v¬ŸbË_v®ue_t
 *
vv
;

2376 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

2378 
cmcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

2380 ià(
»
->
nÿ±u»s
) {

2381 
Ën
 = 
cmcf
->
nÿ±u»s
;

2383 ià(
r
->
ÿ±u»s
 =ð
NULL
) {

2384 
r
->
ÿ±u»s
 = 
	`ngx_·Îoc
Ô->
poÞ
, 
Ën
 * ());

2385 ià(
r
->
ÿ±u»s
 =ð
NULL
) {

2386  
NGX_ERROR
;

2391 
Ën
 = 0;

2394 
rc
 = 
	`ngx_»gex_exec
(
»
->
»gex
, 
s
, 
r
->
ÿ±u»s
, 
Ën
);

2396 ià(
rc
 =ð
NGX_REGEX_NO_MATCHED
) {

2397  
NGX_DECLINED
;

2400 ià(
rc
 < 0) {

2401 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
r
->
cÚÃùiÚ
->
log
, 0,

2402 
ngx_»gex_exec_n
 " failed: %i on \"%V\" using \"%V\"",

2403 
rc
, 
s
, &
»
->
Çme
);

2404  
NGX_ERROR
;

2407 
i
 = 0; i < 
»
->
nv¬ŸbËs
; i++) {

2409 
n
 = 
»
->
v¬ŸbËs
[
i
].
ÿ±u»
;

2410 
šdex
 = 
»
->
v¬ŸbËs
[
i
].index;

2411 
vv
 = &
r
->
v¬ŸbËs
[
šdex
];

2413 
vv
->
Ën
 = 
r
->
ÿ±u»s
[
n
 + 1] -„->captures[n];

2414 
vv
->
v®id
 = 1;

2415 
vv
->
no_ÿch—bË
 = 0;

2416 
vv
->
nÙ_found
 = 0;

2417 
vv
->
d©a
 = &
s
->d©a[
r
->
ÿ±u»s
[
n
]];

2419 #ià(
NGX_DEBUG
)

2421 
ngx_h‰p_v¬ŸbË_t
 *
v
;

2423 
v
 = 
cmcf
->
v¬ŸbËs
.
–ts
;

2425 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
r
->
cÚÃùiÚ
->
log
, 0,

2427 &
v
[
šdex
].
Çme
, 
vv
->
Ën
, vv->
d©a
);

2432 
r
->
nÿ±u»s
 = 
rc
 * 2;

2433 
r
->
ÿ±u»s_d©a
 = 
s
->
d©a
;

2435  
NGX_OK
;

2436 
	}
}

2441 
ngx_št_t


2442 
	$ngx_h‰p_v¬ŸbËs_add_cÜe_v¬s
(
ngx_cÚf_t
 *
cf
)

2444 
ngx_št_t
 
rc
;

2445 
ngx_h‰p_v¬ŸbË_t
 *
cv
, *
v
;

2446 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

2448 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

2450 
cmcf
->
v¬ŸbËs_keys
 = 
	`ngx_pÿÎoc
(
cf
->
‹mp_poÞ
,

2451 (
ngx_hash_keys_¬¿ys_t
));

2452 ià(
cmcf
->
v¬ŸbËs_keys
 =ð
NULL
) {

2453  
NGX_ERROR
;

2456 
cmcf
->
v¬ŸbËs_keys
->
poÞ
 = 
cf
->pool;

2457 
cmcf
->
v¬ŸbËs_keys
->
‹mp_poÞ
 = 
cf
->
poÞ
;

2459 ià(
	`ngx_hash_keys_¬¿y_š™
(
cmcf
->
v¬ŸbËs_keys
, 
NGX_HASH_SMALL
)

2460 !ð
NGX_OK
)

2462  
NGX_ERROR
;

2465 
cv
 = 
ngx_h‰p_cÜe_v¬ŸbËs
; cv->
Çme
.
Ën
; cv++) {

2466 
v
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_h‰p_v¬ŸbË_t
));

2467 ià(
v
 =ð
NULL
) {

2468  
NGX_ERROR
;

2471 *
v
 = *
cv
;

2473 
rc
 = 
	`ngx_hash_add_key
(
cmcf
->
v¬ŸbËs_keys
, &
v
->
Çme
, v,

2474 
NGX_HASH_READONLY_KEY
);

2476 ià(
rc
 =ð
NGX_OK
) {

2480 ià(
rc
 =ð
NGX_BUSY
) {

2481 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

2482 "cÚæiùšg v¬ŸbË‚am\"%V\"", &
v
->
Çme
);

2485  
NGX_ERROR
;

2488  
NGX_OK
;

2489 
	}
}

2492 
ngx_št_t


2493 
	$ngx_h‰p_v¬ŸbËs_š™_v¬s
(
ngx_cÚf_t
 *
cf
)

2495 
ngx_ušt_t
 
i
, 
n
;

2496 
ngx_hash_key_t
 *
key
;

2497 
ngx_hash_š™_t
 
hash
;

2498 
ngx_h‰p_v¬ŸbË_t
 *
v
, *
av
;

2499 
ngx_h‰p_cÜe_maš_cÚf_t
 *
cmcf
;

2503 
cmcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

2505 
v
 = 
cmcf
->
v¬ŸbËs
.
–ts
;

2506 
key
 = 
cmcf
->
v¬ŸbËs_keys
->
keys
.
–ts
;

2508 
i
 = 0; i < 
cmcf
->
v¬ŸbËs
.
ÃÉs
; i++) {

2510 
n
 = 0;‚ < 
cmcf
->
v¬ŸbËs_keys
->
keys
.
ÃÉs
;‚++) {

2512 
av
 = 
key
[
n
].
v®ue
;

2514 ià(
v
[
i
].
Çme
.
Ën
 =ð
key
[
n
].key.len

2515 && 
	`ngx_¡ºcmp
(
v
[
i
].
Çme
.
d©a
, 
key
[
n
].key.d©a, v[i].Çme.
Ën
)

2518 
v
[
i
].
g‘_hªdËr
 = 
av
->get_handler;

2519 
v
[
i
].
d©a
 = 
av
->data;

2521 
av
->
æags
 |ð
NGX_HTTP_VAR_INDEXED
;

2522 
v
[
i
].
æags
 = 
av
->flags;

2524 
av
->
šdex
 = 
i
;

2526 ià(
av
->
g‘_hªdËr
 =ð
NULL
) {

2530 
Ãxt
;

2534 ià(
	`ngx_¡ºcmp
(
v
[
i
].
Çme
.
d©a
, "http_", 5) == 0) {

2535 
v
[
i
].
g‘_hªdËr
 = 
ngx_h‰p_v¬ŸbË_unknown_h—d”_š
;

2536 
v
[
i
].
d©a
 = (
ušŒ_t
è&v[i].
Çme
;

2541 ià(
	`ngx_¡ºcmp
(
v
[
i
].
Çme
.
d©a
, "sent_http_", 10) == 0) {

2542 
v
[
i
].
g‘_hªdËr
 = 
ngx_h‰p_v¬ŸbË_unknown_h—d”_out
;

2543 
v
[
i
].
d©a
 = (
ušŒ_t
è&v[i].
Çme
;

2548 ià(
	`ngx_¡ºcmp
(
v
[
i
].
Çme
.
d©a
, "upstream_http_", 14) == 0) {

2549 
v
[
i
].
g‘_hªdËr
 = 
ngx_h‰p_up¡»am_h—d”_v¬ŸbË
;

2550 
v
[
i
].
d©a
 = (
ušŒ_t
è&v[i].
Çme
;

2551 
v
[
i
].
æags
 = 
NGX_HTTP_VAR_NOCACHEABLE
;

2556 ià(
	`ngx_¡ºcmp
(
v
[
i
].
Çme
.
d©a
, "cookie_", 7) == 0) {

2557 
v
[
i
].
g‘_hªdËr
 = 
ngx_h‰p_v¬ŸbË_cook›
;

2558 
v
[
i
].
d©a
 = (
ušŒ_t
è&v[i].
Çme
;

2563 ià(
	`ngx_¡ºcmp
(
v
[
i
].
Çme
.
d©a
, "upstream_cookie_", 16) == 0) {

2564 
v
[
i
].
g‘_hªdËr
 = 
ngx_h‰p_up¡»am_cook›_v¬ŸbË
;

2565 
v
[
i
].
d©a
 = (
ušŒ_t
è&v[i].
Çme
;

2566 
v
[
i
].
æags
 = 
NGX_HTTP_VAR_NOCACHEABLE
;

2571 ià(
	`ngx_¡ºcmp
(
v
[
i
].
Çme
.
d©a
, "arg_", 4) == 0) {

2572 
v
[
i
].
g‘_hªdËr
 = 
ngx_h‰p_v¬ŸbË_¬gum’t
;

2573 
v
[
i
].
d©a
 = (
ušŒ_t
è&v[i].
Çme
;

2574 
v
[
i
].
æags
 = 
NGX_HTTP_VAR_NOCACHEABLE
;

2579 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

2580 "unknowÀ\"%V\" v¬ŸbË", &
v
[
i
].
Çme
);

2582  
NGX_ERROR
;

2584 
Ãxt
:

2589 
n
 = 0;‚ < 
cmcf
->
v¬ŸbËs_keys
->
keys
.
ÃÉs
;‚++) {

2590 
av
 = 
key
[
n
].
v®ue
;

2592 ià(
av
->
æags
 & 
NGX_HTTP_VAR_NOHASH
) {

2593 
key
[
n
].key.
d©a
 = 
NULL
;

2598 
hash
.hash = &
cmcf
->
v¬ŸbËs_hash
;

2599 
hash
.
key
 = 
ngx_hash_key
;

2600 
hash
.
max_size
 = 
cmcf
->
v¬ŸbËs_hash_max_size
;

2601 
hash
.
buck‘_size
 = 
cmcf
->
v¬ŸbËs_hash_buck‘_size
;

2602 
hash
.
Çme
 = "variables_hash";

2603 
hash
.
poÞ
 = 
cf
->pool;

2604 
hash
.
‹mp_poÞ
 = 
NULL
;

2606 ià(
	`ngx_hash_š™
(&
hash
, 
cmcf
->
v¬ŸbËs_keys
->
keys
.
–ts
,

2607 
cmcf
->
v¬ŸbËs_keys
->
keys
.
ÃÉs
)

2608 !ð
NGX_OK
)

2610  
NGX_ERROR
;

2613 
cmcf
->
v¬ŸbËs_keys
 = 
NULL
;

2615  
NGX_OK
;

2616 
	}
}

	@/home/wuhong/github/google/ngx_google/src/http/ngx_http_write_filter_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_h‰p.h
>

13 
ngx_št_t
 
ngx_h‰p_wr™e_fž‹r_š™
(
ngx_cÚf_t
 *
cf
);

16 
ngx_h‰p_moduË_t
 
	gngx_h‰p_wr™e_fž‹r_moduË_ùx
 = {

17 
NULL
,

18 
ngx_h‰p_wr™e_fž‹r_š™
,

20 
NULL
,

21 
NULL
,

23 
NULL
,

24 
NULL
,

26 
NULL
,

27 
NULL
,

31 
ngx_moduË_t
 
	gngx_h‰p_wr™e_fž‹r_moduË
 = {

32 
NGX_MODULE_V1
,

33 &
ngx_h‰p_wr™e_fž‹r_moduË_ùx
,

34 
NULL
,

35 
NGX_HTTP_MODULE
,

36 
NULL
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NGX_MODULE_V1_PADDING


47 
ngx_št_t


48 
	$ngx_h‰p_wr™e_fž‹r
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_chaš_t
 *
š
)

50 
off_t
 
size
, 
£Á
, 
n£Á
, 
lim™
;

51 
ngx_ušt_t
 
Ï¡
, 
æush
, 
sync
;

52 
ngx_m£c_t
 
d–ay
;

53 
ngx_chaš_t
 *
þ
, *
Ê
, **
Î
, *
chaš
;

54 
ngx_cÚÃùiÚ_t
 *
c
;

55 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

57 
c
 = 
r
->
cÚÃùiÚ
;

59 ià(
c
->
”rÜ
) {

60  
NGX_ERROR
;

63 
size
 = 0;

64 
æush
 = 0;

65 
sync
 = 0;

66 
Ï¡
 = 0;

67 
Î
 = &
r
->
out
;

71 
þ
 = 
r
->
out
; cl; cÈðþ->
Ãxt
) {

72 
Î
 = &
þ
->
Ãxt
;

74 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

77 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

78 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

79 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

80 
þ
->
buf
->
fže_pos
,

81 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

84 ià(
	`ngx_buf_size
(
þ
->
buf
è=ð0 && !
	`ngx_buf_¥ecŸl
(cl->buf)) {

85 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

88 
þ
->
buf
->
‹mpÜ¬y
,

89 
þ
->
buf
->
»cyþed
,

90 
þ
->
buf
->
š_fže
,

91 
þ
->
buf
->
¡¬t
,

92 
þ
->
buf
->
pos
,

93 
þ
->
buf
->
Ï¡
,

94 
þ
->
buf
->
fže
,

95 
þ
->
buf
->
fže_pos
,

96 
þ
->
buf
->
fže_Ï¡
);

98 
	`ngx_debug_pošt
();

99  
NGX_ERROR
;

103 
size
 +ð
	`ngx_buf_size
(
þ
->
buf
);

105 ià(
þ
->
buf
->
æush
 || cl->buf->
»cyþed
) {

106 
æush
 = 1;

109 ià(
þ
->
buf
->
sync
) {

110 
sync
 = 1;

113 ià(
þ
->
buf
->
Ï¡_buf
) {

114 
Ï¡
 = 1;

120 
Ê
 = 
š
;†n;†ÀðÊ->
Ãxt
) {

121 
þ
 = 
	`ngx_®loc_chaš_lšk
(
r
->
poÞ
);

122 ià(
þ
 =ð
NULL
) {

123  
NGX_ERROR
;

126 
þ
->
buf
 = 
Ê
->buf;

127 *
Î
 = 
þ
;

128 
Î
 = &
þ
->
Ãxt
;

130 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

133 
þ
->
buf
->
‹mpÜ¬y
, cl->buf->
š_fže
,

134 
þ
->
buf
->
¡¬t
, cl->buf->
pos
,

135 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
,

136 
þ
->
buf
->
fže_pos
,

137 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
);

140 ià(
	`ngx_buf_size
(
þ
->
buf
è=ð0 && !
	`ngx_buf_¥ecŸl
(cl->buf)) {

141 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

144 
þ
->
buf
->
‹mpÜ¬y
,

145 
þ
->
buf
->
»cyþed
,

146 
þ
->
buf
->
š_fže
,

147 
þ
->
buf
->
¡¬t
,

148 
þ
->
buf
->
pos
,

149 
þ
->
buf
->
Ï¡
,

150 
þ
->
buf
->
fže
,

151 
þ
->
buf
->
fže_pos
,

152 
þ
->
buf
->
fže_Ï¡
);

154 
	`ngx_debug_pošt
();

155  
NGX_ERROR
;

159 
size
 +ð
	`ngx_buf_size
(
þ
->
buf
);

161 ià(
þ
->
buf
->
æush
 || cl->buf->
»cyþed
) {

162 
æush
 = 1;

165 ià(
þ
->
buf
->
sync
) {

166 
sync
 = 1;

169 ià(
þ
->
buf
->
Ï¡_buf
) {

170 
Ï¡
 = 1;

174 *
Î
 = 
NULL
;

176 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

177 "h‰°wr™fž‹r:†:%d f:%d s:%O", 
Ï¡
, 
æush
, 
size
);

179 
þcf
 = 
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_cÜe_moduË
);

187 ià(!
Ï¡
 && !
æush
 && 
š
 && 
size
 < (
off_t
è
þcf
->
po¡pÚe_ouut
) {

188  
NGX_OK
;

191 ià(
c
->
wr™e
->
d–ayed
) {

192 
c
->
bufã»d
 |ð
NGX_HTTP_WRITE_BUFFERED
;

193  
NGX_AGAIN
;

196 ià(
size
 == 0

197 && !(
c
->
bufã»d
 & 
NGX_LOWLEVEL_BUFFERED
)

198 && !(
Ï¡
 && 
c
->
Ãed_Ï¡_buf
))

200 ià(
Ï¡
 || 
æush
 || 
sync
) {

201 
þ
 = 
r
->
out
; cl; ) {

202 
Ê
 = 
þ
;

203 
þ
 = cl->
Ãxt
;

204 
	`ngx_ä“_chaš
(
r
->
poÞ
, 
Ê
);

207 
r
->
out
 = 
NULL
;

208 
c
->
bufã»d
 &ð~
NGX_HTTP_WRITE_BUFFERED
;

210  
NGX_OK
;

213 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

216 
	`ngx_debug_pošt
();

218  
NGX_ERROR
;

221 ià(
r
->
lim™_¿‹
) {

222 ià(
r
->
lim™_¿‹_aá”
 == 0) {

223 
r
->
lim™_¿‹_aá”
 = 
þcf
->limit_rate_after;

226 
lim™
 = (
off_t
è
r
->
lim™_¿‹
 * (
	`ngx_time
(è-„->
¡¬t_£c
 + 1)

227 - (
c
->
£Á
 - 
r
->
lim™_¿‹_aá”
);

229 ià(
lim™
 <= 0) {

230 
c
->
wr™e
->
d–ayed
 = 1;

231 
d–ay
 = (
ngx_m£c_t
è(- 
lim™
 * 1000 / 
r
->
lim™_¿‹
 + 1);

232 
	`ngx_add_tim”
(
c
->
wr™e
, 
d–ay
);

234 
c
->
bufã»d
 |ð
NGX_HTTP_WRITE_BUFFERED
;

236  
NGX_AGAIN
;

239 ià(
þcf
->
£ndfže_max_chunk


240 && (
off_t
è
þcf
->
£ndfže_max_chunk
 < 
lim™
)

242 
lim™
 = 
þcf
->
£ndfže_max_chunk
;

246 
lim™
 = 
þcf
->
£ndfže_max_chunk
;

249 
£Á
 = 
c
->sent;

251 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

252 "h‰°wr™fž‹¸lim™ %O", 
lim™
);

254 
chaš
 = 
c
->
	`£nd_chaš
(c, 
r
->
out
, 
lim™
);

256 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
c
->
log
, 0,

257 "h‰°wr™fž‹¸%p", 
chaš
);

259 ià(
chaš
 =ð
NGX_CHAIN_ERROR
) {

260 
c
->
”rÜ
 = 1;

261  
NGX_ERROR
;

264 ià(
r
->
lim™_¿‹
) {

266 
n£Á
 = 
c
->
£Á
;

268 ià(
r
->
lim™_¿‹_aá”
) {

270 
£Á
 -ð
r
->
lim™_¿‹_aá”
;

271 ià(
£Á
 < 0) {

272 
£Á
 = 0;

275 
n£Á
 -ð
r
->
lim™_¿‹_aá”
;

276 ià(
n£Á
 < 0) {

277 
n£Á
 = 0;

281 
d–ay
 = (
ngx_m£c_t
è((
n£Á
 - 
£Á
è* 1000 / 
r
->
lim™_¿‹
);

283 ià(
d–ay
 > 0) {

284 
lim™
 = 0;

285 
c
->
wr™e
->
d–ayed
 = 1;

286 
	`ngx_add_tim”
(
c
->
wr™e
, 
d–ay
);

290 ià(
lim™


291 && 
c
->
wr™e
->
»ady


292 && 
c
->
£Á
 - s’ˆ>ð
lim™
 - (
off_t
è(2 * 
ngx_·gesize
))

294 
c
->
wr™e
->
d–ayed
 = 1;

295 
	`ngx_add_tim”
(
c
->
wr™e
, 1);

298 
þ
 = 
r
->
out
; cÈ&& cÈ!ð
chaš
; ) {

299 
Ê
 = 
þ
;

300 
þ
 = cl->
Ãxt
;

301 
	`ngx_ä“_chaš
(
r
->
poÞ
, 
Ê
);

304 
r
->
out
 = 
chaš
;

306 ià(
chaš
) {

307 
c
->
bufã»d
 |ð
NGX_HTTP_WRITE_BUFFERED
;

308  
NGX_AGAIN
;

311 
c
->
bufã»d
 &ð~
NGX_HTTP_WRITE_BUFFERED
;

313 ià((
c
->
bufã»d
 & 
NGX_LOWLEVEL_BUFFERED
è&& 
r
->
po¡pÚed
 =ð
NULL
) {

314  
NGX_AGAIN
;

317  
NGX_OK
;

318 
	}
}

321 
ngx_št_t


322 
	$ngx_h‰p_wr™e_fž‹r_š™
(
ngx_cÚf_t
 *
cf
)

324 
ngx_h‰p_tÝ_body_fž‹r
 = 
ngx_h‰p_wr™e_fž‹r
;

326  
NGX_OK
;

327 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

14 *
ngx_maž_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

15 
ngx_št_t
 
ngx_maž_add_pÜts
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
pÜts
,

16 
ngx_maž_li¡’_t
 *
li¡’
);

17 *
ngx_maž_Ýtimize_£rv”s
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
pÜts
);

18 
ngx_št_t
 
ngx_maž_add_addrs
(
ngx_cÚf_t
 *
cf
, 
ngx_maž_pÜt_t
 *
mpÜt
,

19 
ngx_maž_cÚf_addr_t
 *
addr
);

20 #ià(
NGX_HAVE_INET6
)

21 
ngx_št_t
 
ngx_maž_add_addrs6
(
ngx_cÚf_t
 *
cf
, 
ngx_maž_pÜt_t
 *
mpÜt
,

22 
ngx_maž_cÚf_addr_t
 *
addr
);

24 
ngx_št_t
 
ngx_maž_cmp_cÚf_addrs
(cÚ¡ *
Úe
, cÚ¡ *
two
);

27 
ngx_ušt_t
 
	gngx_maž_max_moduË
;

30 
ngx_commªd_t
 
	gngx_maž_commªds
[] = {

32 { 
ngx_¡ršg
("mail"),

33 
NGX_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

34 
ngx_maž_block
,

37 
NULL
 },

39 { 
ngx_¡ršg
("imap"),

40 
NGX_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

41 
ngx_maž_block
,

44 
NULL
 },

46 
ngx_nuÎ_commªd


50 
ngx_cÜe_moduË_t
 
	gngx_maž_moduË_ùx
 = {

51 
ngx_¡ršg
("mail"),

52 
NULL
,

53 
NULL


57 
ngx_moduË_t
 
	gngx_maž_moduË
 = {

58 
NGX_MODULE_V1
,

59 &
ngx_maž_moduË_ùx
,

60 
ngx_maž_commªds
,

61 
NGX_CORE_MODULE
,

62 
NULL
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NGX_MODULE_V1_PADDING


74 
	$ngx_maž_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

76 *
rv
;

77 
ngx_ušt_t
 
i
, 
m
, 
mi
, 
s
;

78 
ngx_cÚf_t
 
pcf
;

79 
ngx_¬¿y_t
 
pÜts
;

80 
ngx_maž_li¡’_t
 *
li¡’
;

81 
ngx_maž_moduË_t
 *
moduË
;

82 
ngx_maž_cÚf_ùx_t
 *
ùx
;

83 
ngx_maž_cÜe_¤v_cÚf_t
 **
cscå
;

84 
ngx_maž_cÜe_maš_cÚf_t
 *
cmcf
;

86 ià(
cmd
->
Çme
.
d©a
[0] == 'i') {

87 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

94 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_cÚf_ùx_t
));

95 ià(
ùx
 =ð
NULL
) {

96  
NGX_CONF_ERROR
;

99 *(
ngx_maž_cÚf_ùx_t
 **è
cÚf
 = 
ùx
;

103 
ngx_maž_max_moduË
 = 0;

104 
m
 = 0; 
ngx_moduËs
[m]; m++) {

105 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_MAIL_MODULE
) {

109 
ngx_moduËs
[
m
]->
ùx_šdex
 = 
ngx_maž_max_moduË
++;

115 
ùx
->
maš_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

116 (*è* 
ngx_maž_max_moduË
);

117 ià(
ùx
->
maš_cÚf
 =ð
NULL
) {

118  
NGX_CONF_ERROR
;

127 
ùx
->
¤v_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_maž_max_moduË
);

128 ià(
ùx
->
¤v_cÚf
 =ð
NULL
) {

129  
NGX_CONF_ERROR
;

137 
m
 = 0; 
ngx_moduËs
[m]; m++) {

138 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_MAIL_MODULE
) {

142 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

143 
mi
 = 
ngx_moduËs
[
m
]->
ùx_šdex
;

145 ià(
moduË
->
ü—‹_maš_cÚf
) {

146 
ùx
->
maš_cÚf
[
mi
] = 
moduË
->
	`ü—‹_maš_cÚf
(
cf
);

147 ià(
ùx
->
maš_cÚf
[
mi
] =ð
NULL
) {

148  
NGX_CONF_ERROR
;

152 ià(
moduË
->
ü—‹_¤v_cÚf
) {

153 
ùx
->
¤v_cÚf
[
mi
] = 
moduË
->
	`ü—‹_¤v_cÚf
(
cf
);

154 ià(
ùx
->
¤v_cÚf
[
mi
] =ð
NULL
) {

155  
NGX_CONF_ERROR
;

163 
pcf
 = *
cf
;

164 
cf
->
ùx
 = ctx;

166 
cf
->
moduË_ty³
 = 
NGX_MAIL_MODULE
;

167 
cf
->
cmd_ty³
 = 
NGX_MAIL_MAIN_CONF
;

168 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

170 ià(
rv
 !ð
NGX_CONF_OK
) {

171 *
cf
 = 
pcf
;

172  
rv
;

178 
cmcf
 = 
ùx
->
maš_cÚf
[
ngx_maž_cÜe_moduË
.
ùx_šdex
];

179 
cscå
 = 
cmcf
->
£rv”s
.
–ts
;

181 
m
 = 0; 
ngx_moduËs
[m]; m++) {

182 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_MAIL_MODULE
) {

186 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

187 
mi
 = 
ngx_moduËs
[
m
]->
ùx_šdex
;

191 
cf
->
ùx
 = ctx;

193 ià(
moduË
->
š™_maš_cÚf
) {

194 
rv
 = 
moduË
->
	`š™_maš_cÚf
(
cf
, 
ùx
->
maš_cÚf
[
mi
]);

195 ià(
rv
 !ð
NGX_CONF_OK
) {

196 *
cf
 = 
pcf
;

197  
rv
;

201 
s
 = 0; s < 
cmcf
->
£rv”s
.
ÃÉs
; s++) {

205 
cf
->
ùx
 = 
cscå
[
s
]->ctx;

207 ià(
moduË
->
m”ge_¤v_cÚf
) {

208 
rv
 = 
moduË
->
	`m”ge_¤v_cÚf
(
cf
,

209 
ùx
->
¤v_cÚf
[
mi
],

210 
cscå
[
s
]->
ùx
->
¤v_cÚf
[
mi
]);

211 ià(
rv
 !ð
NGX_CONF_OK
) {

212 *
cf
 = 
pcf
;

213  
rv
;

219 *
cf
 = 
pcf
;

222 ià(
	`ngx_¬¿y_š™
(&
pÜts
, 
cf
->
‹mp_poÞ
, 4, (
ngx_maž_cÚf_pÜt_t
))

223 !ð
NGX_OK
)

225  
NGX_CONF_ERROR
;

228 
li¡’
 = 
cmcf
->li¡’.
–ts
;

230 
i
 = 0; i < 
cmcf
->
li¡’
.
ÃÉs
; i++) {

231 ià(
	`ngx_maž_add_pÜts
(
cf
, &
pÜts
, &
li¡’
[
i
]è!ð
NGX_OK
) {

232  
NGX_CONF_ERROR
;

236  
	`ngx_maž_Ýtimize_£rv”s
(
cf
, &
pÜts
);

237 
	}
}

240 
ngx_št_t


241 
	$ngx_maž_add_pÜts
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
pÜts
,

242 
ngx_maž_li¡’_t
 *
li¡’
)

244 
š_pÜt_t
 
p
;

245 
ngx_ušt_t
 
i
;

246 
sockaddr
 *
§
;

247 
sockaddr_š
 *
sš
;

248 
ngx_maž_cÚf_pÜt_t
 *
pÜt
;

249 
ngx_maž_cÚf_addr_t
 *
addr
;

250 #ià(
NGX_HAVE_INET6
)

251 
sockaddr_š6
 *
sš6
;

254 
§
 = (
sockaddr
 *è&
li¡’
->sockaddr;

256 
§
->
§_çmžy
) {

258 #ià(
NGX_HAVE_INET6
)

259 
AF_INET6
:

260 
sš6
 = (
sockaddr_š6
 *è
§
;

261 
p
 = 
sš6
->
sš6_pÜt
;

265 #ià(
NGX_HAVE_UNIX_DOMAIN
)

266 
AF_UNIX
:

267 
p
 = 0;

272 
sš
 = (
sockaddr_š
 *è
§
;

273 
p
 = 
sš
->
sš_pÜt
;

277 
pÜt
 = 
pÜts
->
–ts
;

278 
i
 = 0; i < 
pÜts
->
ÃÉs
; i++) {

279 ià(
p
 =ð
pÜt
[
i
].pÜˆ&& 
§
->
§_çmžy
 =ðpÜt[i].
çmžy
) {

283 
pÜt
 = &pÜt[
i
];

284 
found
;

290 
pÜt
 = 
	`ngx_¬¿y_push
(
pÜts
);

291 ià(
pÜt
 =ð
NULL
) {

292  
NGX_ERROR
;

295 
pÜt
->
çmžy
 = 
§
->
§_çmžy
;

296 
pÜt
->pÜˆð
p
;

298 ià(
	`ngx_¬¿y_š™
(&
pÜt
->
addrs
, 
cf
->
‹mp_poÞ
, 2,

299 (
ngx_maž_cÚf_addr_t
))

300 !ð
NGX_OK
)

302  
NGX_ERROR
;

305 
found
:

307 
addr
 = 
	`ngx_¬¿y_push
(&
pÜt
->
addrs
);

308 ià(
addr
 =ð
NULL
) {

309  
NGX_ERROR
;

312 
addr
->
sockaddr
 = (sockadd¸*è&
li¡’
->sockaddr;

313 
addr
->
sockËn
 = 
li¡’
->socklen;

314 
addr
->
ùx
 = 
li¡’
->ctx;

315 
addr
->
bšd
 = 
li¡’
->bind;

316 
addr
->
wždÿrd
 = 
li¡’
->wildcard;

317 
addr
->
so_k“·live
 = 
li¡’
->so_keepalive;

318 #ià(
NGX_HAVE_KEEPALIVE_TUNABLE
)

319 
addr
->
tý_k“pidË
 = 
li¡’
->tcp_keepidle;

320 
addr
->
tý_k“pštvl
 = 
li¡’
->tcp_keepintvl;

321 
addr
->
tý_k“pút
 = 
li¡’
->tcp_keepcnt;

323 #ià(
NGX_MAIL_SSL
)

324 
addr
->
s¦
 = 
li¡’
->ssl;

326 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

327 
addr
->
v6Úly
 = 
li¡’
->ipv6only;

330  
NGX_OK
;

331 
	}
}

335 
	$ngx_maž_Ýtimize_£rv”s
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
pÜts
)

337 
ngx_ušt_t
 
i
, 
p
, 
Ï¡
, 
bšd_wždÿrd
;

338 
ngx_li¡’šg_t
 *
ls
;

339 
ngx_maž_pÜt_t
 *
mpÜt
;

340 
ngx_maž_cÚf_pÜt_t
 *
pÜt
;

341 
ngx_maž_cÚf_addr_t
 *
addr
;

343 
pÜt
 = 
pÜts
->
–ts
;

344 
p
 = 0;… < 
pÜts
->
ÃÉs
;…++) {

346 
	`ngx_sÜt
(
pÜt
[
p
].
addrs
.
–ts
, (
size_t
èpÜt[p].addrs.
ÃÉs
,

347 (
ngx_maž_cÚf_addr_t
), 
ngx_maž_cmp_cÚf_addrs
);

349 
addr
 = 
pÜt
[
p
].
addrs
.
–ts
;

350 
Ï¡
 = 
pÜt
[
p
].
addrs
.
ÃÉs
;

357 ià(
addr
[
Ï¡
 - 1].
wždÿrd
) {

358 
addr
[
Ï¡
 - 1].
bšd
 = 1;

359 
bšd_wždÿrd
 = 1;

362 
bšd_wždÿrd
 = 0;

365 
i
 = 0;

367 
i
 < 
Ï¡
) {

369 ià(
bšd_wždÿrd
 && !
addr
[
i
].
bšd
) {

370 
i
++;

374 
ls
 = 
	`ngx_ü—‹_li¡’šg
(
cf
, 
addr
[
i
].
sockaddr
,‡ddr[i].
sockËn
);

375 ià(
ls
 =ð
NULL
) {

376  
NGX_CONF_ERROR
;

379 
ls
->
addr_ÁÝ
 = 1;

380 
ls
->
hªdËr
 = 
ngx_maž_š™_cÚÃùiÚ
;

381 
ls
->
poÞ_size
 = 256;

384 
ls
->
logp
 = &
cf
->
cyþe
->
Ãw_log
;

385 
ls
->
log
.
d©a
 = &ls->
addr_‹xt
;

386 
ls
->
log
.
hªdËr
 = 
ngx_acû±_log_”rÜ
;

388 
ls
->
k“·live
 = 
addr
[
i
].
so_k“·live
;

389 #ià(
NGX_HAVE_KEEPALIVE_TUNABLE
)

390 
ls
->
k“pidË
 = 
addr
[
i
].
tý_k“pidË
;

391 
ls
->
k“pštvl
 = 
addr
[
i
].
tý_k“pštvl
;

392 
ls
->
k“pút
 = 
addr
[
i
].
tý_k“pút
;

395 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

396 
ls
->
v6Úly
 = 
addr
[
i
].ipv6only;

399 
mpÜt
 = 
	`ngx_·Îoc
(
cf
->
poÞ
, (
ngx_maž_pÜt_t
));

400 ià(
mpÜt
 =ð
NULL
) {

401  
NGX_CONF_ERROR
;

404 
ls
->
£rv”s
 = 
mpÜt
;

406 ià(
i
 =ð
Ï¡
 - 1) {

407 
mpÜt
->
Çddrs
 = 
Ï¡
;

410 
mpÜt
->
Çddrs
 = 1;

411 
i
 = 0;

414 
ls
->
sockaddr
->
§_çmžy
) {

415 #ià(
NGX_HAVE_INET6
)

416 
AF_INET6
:

417 ià(
	`ngx_maž_add_addrs6
(
cf
, 
mpÜt
, 
addr
è!ð
NGX_OK
) {

418  
NGX_CONF_ERROR
;

423 ià(
	`ngx_maž_add_addrs
(
cf
, 
mpÜt
, 
addr
è!ð
NGX_OK
) {

424  
NGX_CONF_ERROR
;

429 
addr
++;

430 
Ï¡
--;

434  
NGX_CONF_OK
;

435 
	}
}

438 
ngx_št_t


439 
	$ngx_maž_add_addrs
(
ngx_cÚf_t
 *
cf
, 
ngx_maž_pÜt_t
 *
mpÜt
,

440 
ngx_maž_cÚf_addr_t
 *
addr
)

442 
u_ch¬
 *
p
;

443 
size_t
 
Ën
;

444 
ngx_ušt_t
 
i
;

445 
ngx_maž_š_addr_t
 *
addrs
;

446 
sockaddr_š
 *
sš
;

447 
u_ch¬
 
buf
[
NGX_SOCKADDR_STRLEN
];

449 
mpÜt
->
addrs
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

450 
mpÜt
->
Çddrs
 * (
ngx_maž_š_addr_t
));

451 ià(
mpÜt
->
addrs
 =ð
NULL
) {

452  
NGX_ERROR
;

455 
addrs
 = 
mpÜt
->addrs;

457 
i
 = 0; i < 
mpÜt
->
Çddrs
; i++) {

459 
sš
 = (
sockaddr_š
 *è
addr
[
i
].
sockaddr
;

460 
addrs
[
i
].
addr
 = 
sš
->
sš_addr
.
s_addr
;

462 
addrs
[
i
].
cÚf
.
ùx
 = 
addr
[i].ctx;

463 #ià(
NGX_MAIL_SSL
)

464 
addrs
[
i
].
cÚf
.
s¦
 = 
addr
[i].ssl;

467 
Ën
 = 
	`ngx_sock_ÁÝ
(
addr
[
i
].
sockaddr
,‡ddr[i].
sockËn
, 
buf
,

468 
NGX_SOCKADDR_STRLEN
, 1);

470 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
Ën
);

471 ià(
p
 =ð
NULL
) {

472  
NGX_ERROR
;

475 
	`ngx_memýy
(
p
, 
buf
, 
Ën
);

477 
addrs
[
i
].
cÚf
.
addr_‹xt
.
Ën
 =†en;

478 
addrs
[
i
].
cÚf
.
addr_‹xt
.
d©a
 = 
p
;

481  
NGX_OK
;

482 
	}
}

485 #ià(
NGX_HAVE_INET6
)

487 
ngx_št_t


488 
	$ngx_maž_add_addrs6
(
ngx_cÚf_t
 *
cf
, 
ngx_maž_pÜt_t
 *
mpÜt
,

489 
ngx_maž_cÚf_addr_t
 *
addr
)

491 
u_ch¬
 *
p
;

492 
size_t
 
Ën
;

493 
ngx_ušt_t
 
i
;

494 
ngx_maž_š6_addr_t
 *
addrs6
;

495 
sockaddr_š6
 *
sš6
;

496 
u_ch¬
 
buf
[
NGX_SOCKADDR_STRLEN
];

498 
mpÜt
->
addrs
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
,

499 
mpÜt
->
Çddrs
 * (
ngx_maž_š6_addr_t
));

500 ià(
mpÜt
->
addrs
 =ð
NULL
) {

501  
NGX_ERROR
;

504 
addrs6
 = 
mpÜt
->
addrs
;

506 
i
 = 0; i < 
mpÜt
->
Çddrs
; i++) {

508 
sš6
 = (
sockaddr_š6
 *è
addr
[
i
].
sockaddr
;

509 
addrs6
[
i
].
addr6
 = 
sš6
->
sš6_addr
;

511 
addrs6
[
i
].
cÚf
.
ùx
 = 
addr
[i].ctx;

512 #ià(
NGX_MAIL_SSL
)

513 
addrs6
[
i
].
cÚf
.
s¦
 = 
addr
[i].ssl;

516 
Ën
 = 
	`ngx_sock_ÁÝ
(
addr
[
i
].
sockaddr
,‡ddr[i].
sockËn
, 
buf
,

517 
NGX_SOCKADDR_STRLEN
, 1);

519 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
Ën
);

520 ià(
p
 =ð
NULL
) {

521  
NGX_ERROR
;

524 
	`ngx_memýy
(
p
, 
buf
, 
Ën
);

526 
addrs6
[
i
].
cÚf
.
addr_‹xt
.
Ën
 =†en;

527 
addrs6
[
i
].
cÚf
.
addr_‹xt
.
d©a
 = 
p
;

530  
NGX_OK
;

531 
	}
}

536 
ngx_št_t


537 
	$ngx_maž_cmp_cÚf_addrs
(cÚ¡ *
Úe
, cÚ¡ *
two
)

539 
ngx_maž_cÚf_addr_t
 *
fœ¡
, *
£cÚd
;

541 
fœ¡
 = (
ngx_maž_cÚf_addr_t
 *è
Úe
;

542 
£cÚd
 = (
ngx_maž_cÚf_addr_t
 *è
two
;

544 ià(
fœ¡
->
wždÿrd
) {

549 ià(
£cÚd
->
wždÿrd
) {

554 ià(
fœ¡
->
bšd
 && !
£cÚd
->bind) {

559 ià(!
fœ¡
->
bšd
 && 
£cÚd
->bind) {

567 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_auth_http_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ev’t_cÚÃù.h
>

12 
	~<ngx_maž.h
>

16 
ngx_addr_t
 *
	m³”
;

18 
ngx_m£c_t
 
	mtimeout
;

20 
ngx_¡r_t
 
	mho¡_h—d”
;

21 
ngx_¡r_t
 
	muri
;

22 
ngx_¡r_t
 
	mh—d”
;

24 
ngx_¬¿y_t
 *
	mh—d”s
;

26 
u_ch¬
 *
	mfže
;

27 
ngx_ušt_t
 
	mlše
;

28 } 
	tngx_maž_auth_h‰p_cÚf_t
;

31 
ngx_maž_auth_h‰p_ùx_s
 
	tngx_maž_auth_h‰p_ùx_t
;

33 (*
	tngx_maž_auth_h‰p_hªdËr_±
)(
	tngx_maž_£ssiÚ_t
 *
	ts
,

34 
	tngx_maž_auth_h‰p_ùx_t
 *
	tùx
);

36 
	sngx_maž_auth_h‰p_ùx_s
 {

37 
ngx_buf_t
 *
»que¡
;

38 
ngx_buf_t
 *
»¥Ú£
;

39 
ngx_³”_cÚÃùiÚ_t
 
³”
;

41 
ngx_maž_auth_h‰p_hªdËr_±
 
hªdËr
;

43 
ngx_ušt_t
 
¡©e
;

45 
u_ch¬
 *
h—d”_Çme_¡¬t
;

46 
u_ch¬
 *
h—d”_Çme_’d
;

47 
u_ch¬
 *
h—d”_¡¬t
;

48 
u_ch¬
 *
h—d”_’d
;

50 
ngx_¡r_t
 
addr
;

51 
ngx_¡r_t
 
pÜt
;

52 
ngx_¡r_t
 
”r
;

53 
ngx_¡r_t
 
”rmsg
;

54 
ngx_¡r_t
 
”rcode
;

56 
time_t
 
¦“p
;

58 
ngx_poÞ_t
 *
poÞ
;

62 
	`ngx_maž_auth_h‰p_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
);

63 
	`ngx_maž_auth_h‰p_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
);

64 
	`ngx_maž_auth_h‰p_ignÜe_¡©us_lše
(
ngx_maž_£ssiÚ_t
 *
s
,

65 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
);

66 
	`ngx_maž_auth_h‰p_´oûss_h—d”s
(
ngx_maž_£ssiÚ_t
 *
s
,

67 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
);

68 
	`ngx_maž_auth_¦“p_hªdËr
(
ngx_ev’t_t
 *
»v
);

69 
ngx_št_t
 
	`ngx_maž_auth_h‰p_·r£_h—d”_lše
(
ngx_maž_£ssiÚ_t
 *
s
,

70 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
);

71 
	`ngx_maž_auth_h‰p_block_»ad
(
ngx_ev’t_t
 *
»v
);

72 
	`ngx_maž_auth_h‰p_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
);

73 
ngx_buf_t
 *
	`ngx_maž_auth_h‰p_ü—‹_»que¡
(
ngx_maž_£ssiÚ_t
 *
s
,

74 
ngx_poÞ_t
 *
poÞ
, 
ngx_maž_auth_h‰p_cÚf_t
 *
ahcf
);

75 
ngx_št_t
 
	`ngx_maž_auth_h‰p_esÿ³
(
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
‹xt
,

76 
ngx_¡r_t
 *
esÿ³d
);

78 *
	`ngx_maž_auth_h‰p_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

79 *
	`ngx_maž_auth_h‰p_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

80 *
chžd
);

81 *
	`ngx_maž_auth_h‰p
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

82 *
	`ngx_maž_auth_h‰p_h—d”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

83 *
cÚf
);

86 
ngx_commªd_t
 
ngx_maž_auth_h‰p_commªds
[] = {

88 { 
	`ngx_¡ršg
("auth_http"),

89 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

90 
ngx_maž_auth_h‰p
,

91 
NGX_MAIL_SRV_CONF_OFFSET
,

93 
NULL
 },

95 { 
	`ngx_¡ršg
("auth_http_timeout"),

96 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

97 
ngx_cÚf_£t_m£c_¦Ù
,

98 
NGX_MAIL_SRV_CONF_OFFSET
,

99 
	`off£tof
(
ngx_maž_auth_h‰p_cÚf_t
, 
timeout
),

100 
NULL
 },

102 { 
	`ngx_¡ršg
("auth_http_header"),

103 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE2
,

104 
ngx_maž_auth_h‰p_h—d”
,

105 
NGX_MAIL_SRV_CONF_OFFSET
,

107 
NULL
 },

109 
ngx_nuÎ_commªd


110 
	}
};

113 
ngx_maž_moduË_t
 
	gngx_maž_auth_h‰p_moduË_ùx
 = {

114 
NULL
,

116 
NULL
,

117 
NULL
,

119 
ngx_maž_auth_h‰p_ü—‹_cÚf
,

120 
ngx_maž_auth_h‰p_m”ge_cÚf


124 
ngx_moduË_t
 
	gngx_maž_auth_h‰p_moduË
 = {

125 
NGX_MODULE_V1
,

126 &
ngx_maž_auth_h‰p_moduË_ùx
,

127 
ngx_maž_auth_h‰p_commªds
,

128 
NGX_MAIL_MODULE
,

129 
NULL
,

130 
NULL
,

131 
NULL
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NGX_MODULE_V1_PADDING


140 
ngx_¡r_t
 
	gngx_maž_auth_h‰p_m‘hod
[] = {

141 
ngx_¡ršg
("plain"),

142 
ngx_¡ršg
("plain"),

143 
ngx_¡ršg
("plain"),

144 
ngx_¡ršg
("apop"),

145 
ngx_¡ršg
("cram-md5"),

146 
ngx_¡ršg
("none")

149 
ngx_¡r_t
 
	gngx_maž_sm_”rcode
 = 
ngx_¡ršg
("535 5.7.0");

153 
	$ngx_maž_auth_h‰p_š™
(
ngx_maž_£ssiÚ_t
 *
s
)

155 
ngx_št_t
 
rc
;

156 
ngx_poÞ_t
 *
poÞ
;

157 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
;

158 
ngx_maž_auth_h‰p_cÚf_t
 *
ahcf
;

160 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "in http‡uth state";

162 
poÞ
 = 
	`ngx_ü—‹_poÞ
(2048, 
s
->
cÚÃùiÚ
->
log
);

163 ià(
poÞ
 =ð
NULL
) {

164 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

168 
ùx
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_maž_auth_h‰p_ùx_t
));

169 ià(
ùx
 =ð
NULL
) {

170 
	`ngx_de¡roy_poÞ
(
poÞ
);

171 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

175 
ùx
->
poÞ
 =…ool;

177 
ahcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_auth_h‰p_moduË
);

179 
ùx
->
»que¡
 = 
	`ngx_maž_auth_h‰p_ü—‹_»que¡
(
s
, 
poÞ
, 
ahcf
);

180 ià(
ùx
->
»que¡
 =ð
NULL
) {

181 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

182 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

186 
	`ngx_maž_£t_ùx
(
s
, 
ùx
, 
ngx_maž_auth_h‰p_moduË
);

188 
ùx
->
³”
.
sockaddr
 = 
ahcf
->peer->sockaddr;

189 
ùx
->
³”
.
sockËn
 = 
ahcf
->peer->socklen;

190 
ùx
->
³”
.
Çme
 = &
ahcf
->peer->name;

191 
ùx
->
³”
.
g‘
 = 
ngx_ev’t_g‘_³”
;

192 
ùx
->
³”
.
log
 = 
s
->
cÚÃùiÚ
->log;

193 
ùx
->
³”
.
log_”rÜ
 = 
NGX_ERROR_ERR
;

195 
rc
 = 
	`ngx_ev’t_cÚÃù_³”
(&
ùx
->
³”
);

197 ià(
rc
 =ð
NGX_ERROR
 ||„ø=ð
NGX_BUSY
 ||„ø=ð
NGX_DECLINED
) {

198 ià(
ùx
->
³”
.
cÚÃùiÚ
) {

199 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

202 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

203 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

207 
ùx
->
³”
.
cÚÃùiÚ
->
d©a
 = 
s
;

208 
ùx
->
³”
.
cÚÃùiÚ
->
poÞ
 = 
s
->connection->pool;

210 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_auth_h‰p_block_»ad
;

211 
ùx
->
³”
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_auth_h‰p_»ad_hªdËr
;

212 
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_maž_auth_h‰p_wr™e_hªdËr
;

214 
ùx
->
hªdËr
 = 
ngx_maž_auth_h‰p_ignÜe_¡©us_lše
;

216 
	`ngx_add_tim”
(
ùx
->
³”
.
cÚÃùiÚ
->
»ad
, 
ahcf
->
timeout
);

217 
	`ngx_add_tim”
(
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
, 
ahcf
->
timeout
);

219 ià(
rc
 =ð
NGX_OK
) {

220 
	`ngx_maž_auth_h‰p_wr™e_hªdËr
(
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
);

223 
	}
}

227 
	$ngx_maž_auth_h‰p_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
)

229 
ssize_t
 
n
, 
size
;

230 
ngx_cÚÃùiÚ_t
 *
c
;

231 
ngx_maž_£ssiÚ_t
 *
s
;

232 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
;

233 
ngx_maž_auth_h‰p_cÚf_t
 *
ahcf
;

235 
c
 = 
wev
->
d©a
;

236 
s
 = 
c
->
d©a
;

238 
ùx
 = 
	`ngx_maž_g‘_moduË_ùx
(
s
, 
ngx_maž_auth_h‰p_moduË
);

240 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
wev
->
log
, 0,

243 ià(
wev
->
timedout
) {

244 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
wev
->
log
, 
NGX_ETIMEDOUT
,

245 "auth h‰°£rv” %Vimed out", 
ùx
->
³”
.
Çme
);

246 
	`ngx_þo£_cÚÃùiÚ
(
c
);

247 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

248 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

252 
size
 = 
ùx
->
»que¡
->
Ï¡
 - ctx->»que¡->
pos
;

254 
n
 = 
	`ngx_£nd
(
c
, 
ùx
->
»que¡
->
pos
, 
size
);

256 ià(
n
 =ð
NGX_ERROR
) {

257 
	`ngx_þo£_cÚÃùiÚ
(
c
);

258 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

259 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

263 ià(
n
 > 0) {

264 
ùx
->
»que¡
->
pos
 +ð
n
;

266 ià(
n
 =ð
size
) {

267 
wev
->
hªdËr
 = 
ngx_maž_auth_h‰p_dummy_hªdËr
;

269 ià(
wev
->
tim”_£t
) {

270 
	`ngx_d–_tim”
(
wev
);

273 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 0è!ð
NGX_OK
) {

274 
	`ngx_þo£_cÚÃùiÚ
(
c
);

275 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

276 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

283 ià(!
wev
->
tim”_£t
) {

284 
ahcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_auth_h‰p_moduË
);

285 
	`ngx_add_tim”
(
wev
, 
ahcf
->
timeout
);

287 
	}
}

291 
	$ngx_maž_auth_h‰p_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
)

293 
ssize_t
 
n
, 
size
;

294 
ngx_cÚÃùiÚ_t
 *
c
;

295 
ngx_maž_£ssiÚ_t
 *
s
;

296 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
;

298 
c
 = 
»v
->
d©a
;

299 
s
 = 
c
->
d©a
;

301 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

304 
ùx
 = 
	`ngx_maž_g‘_moduË_ùx
(
s
, 
ngx_maž_auth_h‰p_moduË
);

306 ià(
»v
->
timedout
) {

307 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
»v
->
log
, 
NGX_ETIMEDOUT
,

308 "auth h‰°£rv” %Vimed out", 
ùx
->
³”
.
Çme
);

309 
	`ngx_þo£_cÚÃùiÚ
(
c
);

310 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

311 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

315 ià(
ùx
->
»¥Ú£
 =ð
NULL
) {

316 
ùx
->
»¥Ú£
 = 
	`ngx_ü—‹_‹mp_buf
(ùx->
poÞ
, 1024);

317 ià(
ùx
->
»¥Ú£
 =ð
NULL
) {

318 
	`ngx_þo£_cÚÃùiÚ
(
c
);

319 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

320 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

325 
size
 = 
ùx
->
»¥Ú£
->
’d
 - ctx->»¥Ú£->
Ï¡
;

327 
n
 = 
	`ngx_»cv
(
c
, 
ùx
->
»¥Ú£
->
pos
, 
size
);

329 ià(
n
 > 0) {

330 
ùx
->
»¥Ú£
->
Ï¡
 +ð
n
;

332 
ùx
->
	`hªdËr
(
s
, ctx);

336 ià(
n
 =ð
NGX_AGAIN
) {

340 
	`ngx_þo£_cÚÃùiÚ
(
c
);

341 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

342 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

343 
	}
}

347 
	$ngx_maž_auth_h‰p_ignÜe_¡©us_lše
(
ngx_maž_£ssiÚ_t
 *
s
,

348 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
)

350 
u_ch¬
 *
p
, 
ch
;

352 
sw_¡¬t
 = 0,

353 
sw_H
,

354 
sw_HT
,

355 
sw_HTT
,

356 
sw_HTTP
,

357 
sw_sk
,

358 
sw_®mo¡_dÚe


359 } 
¡©e
;

361 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

364 
¡©e
 = 
ùx
->state;

366 
p
 = 
ùx
->
»¥Ú£
->
pos
;… < ctx->»¥Ú£->
Ï¡
;…++) {

367 
ch
 = *
p
;

369 
¡©e
) {

372 
sw_¡¬t
:

373 ià(
ch
 == 'H') {

374 
¡©e
 = 
sw_H
;

377 
Ãxt
;

379 
sw_H
:

380 ià(
ch
 == 'T') {

381 
¡©e
 = 
sw_HT
;

384 
Ãxt
;

386 
sw_HT
:

387 ià(
ch
 == 'T') {

388 
¡©e
 = 
sw_HTT
;

391 
Ãxt
;

393 
sw_HTT
:

394 ià(
ch
 == 'P') {

395 
¡©e
 = 
sw_HTTP
;

398 
Ãxt
;

400 
sw_HTTP
:

401 ià(
ch
 == '/') {

402 
¡©e
 = 
sw_sk
;

405 
Ãxt
;

408 
sw_sk
:

409 
ch
) {

410 
CR
:

411 
¡©e
 = 
sw_®mo¡_dÚe
;

414 
LF
:

415 
dÚe
;

420 
sw_®mo¡_dÚe
:

421 ià(
ch
 =ð
LF
) {

422 
dÚe
;

425 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

427 
ùx
->
³”
.
Çme
);

428 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

429 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

430 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

435 
ùx
->
»¥Ú£
->
pos
 = 
p
;

436 
ùx
->
¡©e
 = state;

440 
Ãxt
:

442 
p
 = 
ùx
->
»¥Ú£
->
¡¬t
 - 1;

444 
dÚe
:

446 
ùx
->
»¥Ú£
->
pos
 = 
p
 + 1;

447 
ùx
->
¡©e
 = 0;

448 
ùx
->
hªdËr
 = 
ngx_maž_auth_h‰p_´oûss_h—d”s
;

449 
ùx
->
	`hªdËr
(
s
, ctx);

450 
	}
}

454 
	$ngx_maž_auth_h‰p_´oûss_h—d”s
(
ngx_maž_£ssiÚ_t
 *
s
,

455 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
)

457 
u_ch¬
 *
p
;

458 
time_t
 
tim”
;

459 
size_t
 
Ën
, 
size
;

460 
ngx_št_t
 
rc
, 
pÜt
, 
n
;

461 
ngx_addr_t
 *
³”
;

462 
sockaddr_š
 *
sš
;

463 #ià(
NGX_HAVE_INET6
)

464 
sockaddr_š6
 *
sš6
;

467 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

471 
rc
 = 
	`ngx_maž_auth_h‰p_·r£_h—d”_lše
(
s
, 
ùx
);

473 ià(
rc
 =ð
NGX_OK
) {

475 #ià(
NGX_DEBUG
)

477 
ngx_¡r_t
 
key
, 
v®ue
;

479 
key
.
Ën
 = 
ùx
->
h—d”_Çme_’d
 - ctx->
h—d”_Çme_¡¬t
;

480 
key
.
d©a
 = 
ùx
->
h—d”_Çme_¡¬t
;

481 
v®ue
.
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

482 
v®ue
.
d©a
 = 
ùx
->
h—d”_¡¬t
;

484 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

486 &
key
, &
v®ue
);

490 
Ën
 = 
ùx
->
h—d”_Çme_’d
 - ctx->
h—d”_Çme_¡¬t
;

492 ià(
Ën
 == ("Auth-Status") - 1

493 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

494 (
u_ch¬
 *) "Auth-Status",

498 
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

500 ià(
Ën
 == 2

501 && 
ùx
->
h—d”_¡¬t
[0] == 'O'

502 && 
ùx
->
h—d”_¡¬t
[1] == 'K')

507 ià(
Ën
 == 4

508 && 
ùx
->
h—d”_¡¬t
[0] == 'W'

509 && 
ùx
->
h—d”_¡¬t
[1] == 'A'

510 && 
ùx
->
h—d”_¡¬t
[2] == 'I'

511 && 
ùx
->
h—d”_¡¬t
[3] == 'T')

513 
s
->
auth_wa™
 = 1;

517 
ùx
->
”rmsg
.
Ën
 =†en;

518 
ùx
->
”rmsg
.
d©a
 = ctx->
h—d”_¡¬t
;

520 
s
->
´ÙocÞ
) {

522 
NGX_MAIL_POP3_PROTOCOL
:

523 
size
 = ("-ERR "è- 1 + 
Ën
 + (
CRLF
) - 1;

526 
NGX_MAIL_IMAP_PROTOCOL
:

527 
size
 = 
s
->
g
.
Ën
 + ("NO ") - 1 +†en

528 + (
CRLF
) - 1;

532 
ùx
->
”r
 = ctx->
”rmsg
;

536 
p
 = 
	`ngx_²®loc
(
s
->
cÚÃùiÚ
->
poÞ
, 
size
);

537 ià(
p
 =ð
NULL
) {

538 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

539 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

540 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

544 
ùx
->
”r
.
d©a
 = 
p
;

546 
s
->
´ÙocÞ
) {

548 
NGX_MAIL_POP3_PROTOCOL
:

549 *
p
++ = '-'; *p++ = 'E'; *p++ = 'R'; *p++ = 'R'; *p++ = ' ';

552 
NGX_MAIL_IMAP_PROTOCOL
:

553 
p
 = 
	`ngx_ýymem
Õ, 
s
->
g
.
d©a
, s->g.
Ën
);

554 *
p
++ = 'N'; *p++ = 'O'; *p++ = ' ';

561 
p
 = 
	`ngx_ýymem
Õ, 
ùx
->
h—d”_¡¬t
, 
Ën
);

562 *
p
++ = 
CR
; *p++ = 
LF
;

564 
ùx
->
”r
.
Ën
 = 
p
 - ctx->”r.
d©a
;

569 ià(
Ën
 == ("Auth-Server") - 1

570 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

571 (
u_ch¬
 *) "Auth-Server",

575 
ùx
->
addr
.
Ën
 = ctx->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

576 
ùx
->
addr
.
d©a
 = ctx->
h—d”_¡¬t
;

581 ià(
Ën
 == ("Auth-Port") - 1

582 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

583 (
u_ch¬
 *) "Auth-Port",

587 
ùx
->
pÜt
.
Ën
 = ctx->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

588 
ùx
->
pÜt
.
d©a
 = ctx->
h—d”_¡¬t
;

593 ià(
Ën
 == ("Auth-User") - 1

594 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

595 (
u_ch¬
 *) "Auth-User",

599 
s
->
logš
.
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

601 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(s->
cÚÃùiÚ
->
poÞ
, s->logš.
Ën
);

602 ià(
s
->
logš
.
d©a
 =ð
NULL
) {

603 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

604 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

605 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

609 
	`ngx_memýy
(
s
->
logš
.
d©a
, 
ùx
->
h—d”_¡¬t
, s->logš.
Ën
);

614 ià(
Ën
 == ("Auth-Pass") - 1

615 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

616 (
u_ch¬
 *) "Auth-Pass",

620 
s
->
·sswd
.
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

622 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(s->
cÚÃùiÚ
->
poÞ
,

623 
s
->
·sswd
.
Ën
);

624 ià(
s
->
·sswd
.
d©a
 =ð
NULL
) {

625 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

626 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

627 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

631 
	`ngx_memýy
(
s
->
·sswd
.
d©a
, 
ùx
->
h—d”_¡¬t
, s->·sswd.
Ën
);

636 ià(
Ën
 == ("Auth-Wait") - 1

637 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

638 (
u_ch¬
 *) "Auth-Wait",

642 
n
 = 
	`ngx_©oi
(
ùx
->
h—d”_¡¬t
,

643 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
);

645 ià(
n
 !ð
NGX_ERROR
) {

646 
ùx
->
¦“p
 = 
n
;

652 ià(
Ën
 == ("Auth-Error-Code") - 1

653 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

654 (
u_ch¬
 *) "Auth-Error-Code",

658 
ùx
->
”rcode
.
Ën
 = ctx->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

660 
ùx
->
”rcode
.
d©a
 = 
	`ngx_²®loc
(
s
->
cÚÃùiÚ
->
poÞ
,

661 
ùx
->
”rcode
.
Ën
);

662 ià(
ùx
->
”rcode
.
d©a
 =ð
NULL
) {

663 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

664 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

665 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

669 
	`ngx_memýy
(
ùx
->
”rcode
.
d©a
, ctx->
h—d”_¡¬t
,

670 
ùx
->
”rcode
.
Ën
);

680 ià(
rc
 =ð
NGX_DONE
) {

681 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

684 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

686 ià(
ùx
->
”r
.
Ën
) {

688 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
s
->
cÚÃùiÚ
->
log
, 0,

689 "þ›Á†ogš fažed: \"%V\"", &
ùx
->
”rmsg
);

691 ià(
s
->
´ÙocÞ
 =ð
NGX_MAIL_SMTP_PROTOCOL
) {

693 ià(
ùx
->
”rcode
.
Ën
 == 0) {

694 
ùx
->
”rcode
 = 
ngx_maž_sm_”rcode
;

697 
ùx
->
”r
.
Ën
 = ctx->
”rcode
.ËÀ+ ctx->
”rmsg
.len

698 + (" " 
CRLF
) - 1;

700 
p
 = 
	`ngx_²®loc
(
s
->
cÚÃùiÚ
->
poÞ
, 
ùx
->
”r
.
Ën
);

701 ià(
p
 =ð
NULL
) {

702 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

703 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

707 
ùx
->
”r
.
d©a
 = 
p
;

709 
p
 = 
	`ngx_ýymem
Õ, 
ùx
->
”rcode
.
d©a
, ctx->”rcode.
Ën
);

710 *
p
++ = ' ';

711 
p
 = 
	`ngx_ýymem
Õ, 
ùx
->
”rmsg
.
d©a
, ctx->”rmsg.
Ën
);

712 *
p
++ = 
CR
; *°ð
LF
;

715 
s
->
out
 = 
ùx
->
”r
;

716 
tim”
 = 
ùx
->
¦“p
;

718 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

720 ià(
tim”
 == 0) {

721 
s
->
qu™
 = 1;

722 
	`ngx_maž_£nd
(
s
->
cÚÃùiÚ
->
wr™e
);

726 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, (
ngx_m£c_t
è(
tim”
 * 1000));

728 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_auth_¦“p_hªdËr
;

733 ià(
s
->
auth_wa™
) {

734 
tim”
 = 
ùx
->
¦“p
;

736 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

738 ià(
tim”
 == 0) {

739 
	`ngx_maž_auth_h‰p_š™
(
s
);

743 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, (
ngx_m£c_t
è(
tim”
 * 1000));

745 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_auth_¦“p_hªdËr
;

750 ià(
ùx
->
addr
.
Ën
 =ð0 || ctx->
pÜt
.len == 0) {

751 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

753 
ùx
->
³”
.
Çme
);

754 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

755 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

759 ià(
s
->
·sswd
.
d©a
 =ð
NULL


760 && 
s
->
´ÙocÞ
 !ð
NGX_MAIL_SMTP_PROTOCOL
)

762 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

764 
ùx
->
³”
.
Çme
);

765 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

766 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

770 
³”
 = 
	`ngx_pÿÎoc
(
s
->
cÚÃùiÚ
->
poÞ
, (
ngx_addr_t
));

771 ià(
³”
 =ð
NULL
) {

772 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

773 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

777 
rc
 = 
	`ngx_·r£_addr
(
s
->
cÚÃùiÚ
->
poÞ
, 
³”
,

778 
ùx
->
addr
.
d©a
, ctx->addr.
Ën
);

780 
rc
) {

781 
NGX_OK
:

784 
NGX_DECLINED
:

785 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

788 
ùx
->
³”
.
Çme
, &ùx->
addr
);

792 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

793 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

797 
pÜt
 = 
	`ngx_©oi
(
ùx
->pÜt.
d©a
, ctx->pÜt.
Ën
);

798 ià(
pÜt
 =ð
NGX_ERROR
 ||…ort < 1 ||…ort > 65535) {

799 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

802 
ùx
->
³”
.
Çme
, &ùx->
pÜt
);

803 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

804 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

808 
³”
->
sockaddr
->
§_çmžy
) {

810 #ià(
NGX_HAVE_INET6
)

811 
AF_INET6
:

812 
sš6
 = (
sockaddr_š6
 *è
³”
->
sockaddr
;

813 
sš6
->
sš6_pÜt
 = 
	`htÚs
((
š_pÜt_t
è
pÜt
);

818 
sš
 = (
sockaddr_š
 *è
³”
->
sockaddr
;

819 
sš
->
sš_pÜt
 = 
	`htÚs
((
š_pÜt_t
è
pÜt
);

823 
Ën
 = 
ùx
->
addr
.ËÀ+ 1 + ctx->
pÜt
.len;

825 
³”
->
Çme
.
Ën
 =†en;

827 
³”
->
Çme
.
d©a
 = 
	`ngx_²®loc
(
s
->
cÚÃùiÚ
->
poÞ
, 
Ën
);

828 ià(
³”
->
Çme
.
d©a
 =ð
NULL
) {

829 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

830 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

834 
Ën
 = 
ùx
->
addr
.len;

836 
	`ngx_memýy
(
³”
->
Çme
.
d©a
, 
ùx
->
addr
.d©a, 
Ën
);

838 
³”
->
Çme
.
d©a
[
Ën
++] = ':';

840 
	`ngx_memýy
(
³”
->
Çme
.
d©a
 + 
Ën
, 
ùx
->
pÜt
.data, ctx->port.len);

842 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

843 
	`ngx_maž_´oxy_š™
(
s
, 
³”
);

848 ià(
rc
 =ð
NGX_AGAIN
 ) {

854 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

856 
ùx
->
³”
.
Çme
);

857 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

858 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

859 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

863 
	}
}

867 
	$ngx_maž_auth_¦“p_hªdËr
(
ngx_ev’t_t
 *
»v
)

869 
ngx_cÚÃùiÚ_t
 *
c
;

870 
ngx_maž_£ssiÚ_t
 *
s
;

871 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

873 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail‡uth sleep handler");

875 
c
 = 
»v
->
d©a
;

876 
s
 = 
c
->
d©a
;

878 ià(
»v
->
timedout
) {

880 
»v
->
timedout
 = 0;

882 ià(
s
->
auth_wa™
) {

883 
s
->
auth_wa™
 = 0;

884 
	`ngx_maž_auth_h‰p_š™
(
s
);

888 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

890 
»v
->
hªdËr
 = 
cscf
->
´ÙocÞ
->
auth_¡©e
;

892 
s
->
maž_¡©e
 = 0;

893 
s
->
auth_m‘hod
 = 
NGX_MAIL_AUTH_PLAIN
;

895 
c
->
log
->
aùiÚ
 = "in‡uth state";

897 
	`ngx_maž_£nd
(
c
->
wr™e
);

899 ià(
c
->
de¡royed
) {

903 
	`ngx_add_tim”
(
»v
, 
cscf
->
timeout
);

905 ià(
»v
->
»ady
) {

906 
»v
->
	`hªdËr
(rev);

910 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

911 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

917 ià(
»v
->
aùive
) {

918 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

919 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

922 
	}
}

925 
ngx_št_t


926 
	$ngx_maž_auth_h‰p_·r£_h—d”_lše
(
ngx_maž_£ssiÚ_t
 *
s
,

927 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
)

929 
u_ch¬
 
c
, 
ch
, *
p
;

931 
sw_¡¬t
 = 0,

932 
sw_Çme
,

933 
sw_¥aû_befÜe_v®ue
,

934 
sw_v®ue
,

935 
sw_¥aû_aá”_v®ue
,

936 
sw_®mo¡_dÚe
,

937 
sw_h—d”_®mo¡_dÚe


938 } 
¡©e
;

940 
¡©e
 = 
ùx
->state;

942 
p
 = 
ùx
->
»¥Ú£
->
pos
;… < ctx->»¥Ú£->
Ï¡
;…++) {

943 
ch
 = *
p
;

945 
¡©e
) {

948 
sw_¡¬t
:

950 
ch
) {

951 
CR
:

952 
ùx
->
h—d”_’d
 = 
p
;

953 
¡©e
 = 
sw_h—d”_®mo¡_dÚe
;

955 
LF
:

956 
ùx
->
h—d”_’d
 = 
p
;

957 
h—d”_dÚe
;

959 
¡©e
 = 
sw_Çme
;

960 
ùx
->
h—d”_Çme_¡¬t
 = 
p
;

962 
c
 = (
u_ch¬
è(
ch
 | 0x20);

963 ià(
c
 >= 'a' && c <= 'z') {

967 ià(
ch
 >= '0' && ch <= '9') {

971  
NGX_ERROR
;

976 
sw_Çme
:

977 
c
 = (
u_ch¬
è(
ch
 | 0x20);

978 ià(
c
 >= 'a' && c <= 'z') {

982 ià(
ch
 == ':') {

983 
ùx
->
h—d”_Çme_’d
 = 
p
;

984 
¡©e
 = 
sw_¥aû_befÜe_v®ue
;

988 ià(
ch
 == '-') {

992 ià(
ch
 >= '0' && ch <= '9') {

996 ià(
ch
 =ð
CR
) {

997 
ùx
->
h—d”_Çme_’d
 = 
p
;

998 
ùx
->
h—d”_¡¬t
 = 
p
;

999 
ùx
->
h—d”_’d
 = 
p
;

1000 
¡©e
 = 
sw_®mo¡_dÚe
;

1004 ià(
ch
 =ð
LF
) {

1005 
ùx
->
h—d”_Çme_’d
 = 
p
;

1006 
ùx
->
h—d”_¡¬t
 = 
p
;

1007 
ùx
->
h—d”_’d
 = 
p
;

1008 
dÚe
;

1011  
NGX_ERROR
;

1014 
sw_¥aû_befÜe_v®ue
:

1015 
ch
) {

1018 
CR
:

1019 
ùx
->
h—d”_¡¬t
 = 
p
;

1020 
ùx
->
h—d”_’d
 = 
p
;

1021 
¡©e
 = 
sw_®mo¡_dÚe
;

1023 
LF
:

1024 
ùx
->
h—d”_¡¬t
 = 
p
;

1025 
ùx
->
h—d”_’d
 = 
p
;

1026 
dÚe
;

1028 
ùx
->
h—d”_¡¬t
 = 
p
;

1029 
¡©e
 = 
sw_v®ue
;

1035 
sw_v®ue
:

1036 
ch
) {

1038 
ùx
->
h—d”_’d
 = 
p
;

1039 
¡©e
 = 
sw_¥aû_aá”_v®ue
;

1041 
CR
:

1042 
ùx
->
h—d”_’d
 = 
p
;

1043 
¡©e
 = 
sw_®mo¡_dÚe
;

1045 
LF
:

1046 
ùx
->
h—d”_’d
 = 
p
;

1047 
dÚe
;

1052 
sw_¥aû_aá”_v®ue
:

1053 
ch
) {

1056 
CR
:

1057 
¡©e
 = 
sw_®mo¡_dÚe
;

1059 
LF
:

1060 
dÚe
;

1062 
¡©e
 = 
sw_v®ue
;

1068 
sw_®mo¡_dÚe
:

1069 
ch
) {

1070 
LF
:

1071 
dÚe
;

1073  
NGX_ERROR
;

1077 
sw_h—d”_®mo¡_dÚe
:

1078 
ch
) {

1079 
LF
:

1080 
h—d”_dÚe
;

1082  
NGX_ERROR
;

1087 
ùx
->
»¥Ú£
->
pos
 = 
p
;

1088 
ùx
->
¡©e
 = state;

1090  
NGX_AGAIN
;

1092 
dÚe
:

1094 
ùx
->
»¥Ú£
->
pos
 = 
p
 + 1;

1095 
ùx
->
¡©e
 = 
sw_¡¬t
;

1097  
NGX_OK
;

1099 
h—d”_dÚe
:

1101 
ùx
->
»¥Ú£
->
pos
 = 
p
 + 1;

1102 
ùx
->
¡©e
 = 
sw_¡¬t
;

1104  
NGX_DONE
;

1105 
	}
}

1109 
	$ngx_maž_auth_h‰p_block_»ad
(
ngx_ev’t_t
 *
»v
)

1111 
ngx_cÚÃùiÚ_t
 *
c
;

1112 
ngx_maž_£ssiÚ_t
 *
s
;

1113 
ngx_maž_auth_h‰p_ùx_t
 *
ùx
;

1115 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

1118 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

1119 
c
 = 
»v
->
d©a
;

1120 
s
 = 
c
->
d©a
;

1122 
ùx
 = 
	`ngx_maž_g‘_moduË_ùx
(
s
, 
ngx_maž_auth_h‰p_moduË
);

1124 
	`ngx_þo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

1125 
	`ngx_de¡roy_poÞ
(
ùx
->
poÞ
);

1126 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

1128 
	}
}

1132 
	$ngx_maž_auth_h‰p_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
)

1134 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
ev
->
log
, 0,

1136 
	}
}

1139 
ngx_buf_t
 *

1140 
	$ngx_maž_auth_h‰p_ü—‹_»que¡
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_poÞ_t
 *
poÞ
,

1141 
ngx_maž_auth_h‰p_cÚf_t
 *
ahcf
)

1143 
size_t
 
Ën
;

1144 
ngx_buf_t
 *
b
;

1145 
ngx_¡r_t
 
logš
, 
·sswd
;

1146 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

1148 ià(
	`ngx_maž_auth_h‰p_esÿ³
(
poÞ
, &
s
->
logš
, &logšè!ð
NGX_OK
) {

1149  
NULL
;

1152 ià(
	`ngx_maž_auth_h‰p_esÿ³
(
poÞ
, &
s
->
·sswd
, &·sswdè!ð
NGX_OK
) {

1153  
NULL
;

1156 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

1158 
Ën
 = ("GET "è- 1 + 
ahcf
->
uri
.ËÀ+ (" HTTP/1.0" 
CRLF
) - 1

1159 + ("Ho¡: "è- 1 + 
ahcf
->
ho¡_h—d”
.
Ën
 + (
CRLF
) - 1

1161 + 
ngx_maž_auth_h‰p_m‘hod
[
s
->
auth_m‘hod
].
Ën


1162 + (
CRLF
) - 1

1163 + ("Auth-U£r: "è- 1 + 
logš
.
Ën
 + (
CRLF
) - 1

1164 + ("Auth-Pass: "è- 1 + 
·sswd
.
Ën
 + (
CRLF
) - 1

1165 + ("Auth-S®t: "è- 1 + 
s
->
§É
.
Ën


1166 + ("Auth-PrÙocÞ: "è- 1 + 
cscf
->
´ÙocÞ
->
Çme
.
Ën


1167 + (
CRLF
) - 1

1168 + ("Auth-Logš-A‰em±: "è- 1 + 
NGX_INT_T_LEN


1169 + (
CRLF
) - 1

1170 + ("Cl›Á-IP: "è- 1 + 
s
->
cÚÃùiÚ
->
addr_‹xt
.
Ën


1171 + (
CRLF
) - 1

1172 + ("Cl›Á-Ho¡: "è- 1 + 
s
->
ho¡
.
Ën
 + (
CRLF
) - 1

1173 + ("Auth-SMTP-H–o: "è- 1 + 
s
->
sm_h–o
.
Ën


1174 + ("Auth-SMTP-From: "è- 1 + 
s
->
sm_äom
.
Ën


1175 + ("Auth-SMTP-To: "è- 1 + 
s
->
sm_to
.
Ën


1176 + 
ahcf
->
h—d”
.
Ën


1177 + (
CRLF
) - 1;

1179 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
poÞ
, 
Ën
);

1180 ià(
b
 =ð
NULL
) {

1181  
NULL
;

1184 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "GET ", ("GET ") - 1);

1185 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
ahcf
->
uri
.
d©a
,‡hcf->uri.
Ën
);

1186 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, " HTTP/1.0" 
CRLF
,

1187 (" HTTP/1.0" 
CRLF
) - 1);

1189 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Host: ", ("Host: ") - 1);

1190 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
ahcf
->
ho¡_h—d”
.
d©a
,

1191 
ahcf
->
ho¡_h—d”
.
Ën
);

1192 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1194 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Auth-Method: ",

1196 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last,

1197 
ngx_maž_auth_h‰p_m‘hod
[
s
->
auth_m‘hod
].
d©a
,

1198 
ngx_maž_auth_h‰p_m‘hod
[
s
->
auth_m‘hod
].
Ën
);

1199 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1201 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Auth-User: ", ("Auth-User: ") - 1);

1202 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
logš
.
d©a
,†ogš.
Ën
);

1203 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1205 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Auth-Pass: ", ("Auth-Pass: ") - 1);

1206 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
·sswd
.
d©a
,…asswd.
Ën
);

1207 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1209 ià(
s
->
auth_m‘hod
 !ð
NGX_MAIL_AUTH_PLAIN
 && s->
§É
.
Ën
) {

1210 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Auth-Salt: ", ("Auth-Salt: ") - 1);

1211 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
s
->
§É
.
d©a
, s->§É.
Ën
);

1213 
s
->
·sswd
.
d©a
 = 
NULL
;

1216 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Auth-Protocol: ",

1218 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->Ï¡, 
cscf
->
´ÙocÞ
->
Çme
.
d©a
,

1219 
cscf
->
´ÙocÞ
->
Çme
.
Ën
);

1220 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1222 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, "Auth-Logš-A‰em±: %ui" 
CRLF
,

1223 
s
->
logš_©‹m±
);

1225 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Client-IP: ", ("Client-IP: ") - 1);

1226 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
s
->
cÚÃùiÚ
->
addr_‹xt
.
d©a
,

1227 
s
->
cÚÃùiÚ
->
addr_‹xt
.
Ën
);

1228 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1230 ià(
s
->
ho¡
.
Ën
) {

1231 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Client-Host: ",

1233 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
s
->
ho¡
.
d©a
, s->ho¡.
Ën
);

1234 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1237 ià(
s
->
auth_m‘hod
 =ð
NGX_MAIL_AUTH_NONE
) {

1241 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Auth-SMTP-Helo: ",

1243 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
s
->
sm_h–o
.
d©a
, s->sm_h–o.
Ën
);

1244 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1246 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Auth-SMTP-From: ",

1248 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
s
->
sm_äom
.
d©a
, s->sm_äom.
Ën
);

1249 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1251 
b
->
Ï¡
 = 
	`ngx_ýymem
(b->last, "Auth-SMTP-To: ",

1253 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
s
->
sm_to
.
d©a
, s->sm_to.
Ën
);

1254 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1258 ià(
ahcf
->
h—d”
.
Ën
) {

1259 
b
->
Ï¡
 = 
	`ngx_cÝy
(b->Ï¡, 
ahcf
->
h—d”
.
d©a
,‡hcf->h—d”.
Ën
);

1263 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1265 #ià(
NGX_DEBUG_MAIL_PASSWD
)

1267 
ngx_¡r_t
 
l
;

1269 
l
.
Ën
 = 
b
->
Ï¡
 - b->
pos
;

1270 
l
.
d©a
 = 
b
->
pos
;

1271 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

1272 "maž‡uth h‰°h—d”:%N\"%V\"", &
l
);

1276  
b
;

1277 
	}
}

1280 
ngx_št_t


1281 
	$ngx_maž_auth_h‰p_esÿ³
(
ngx_poÞ_t
 *
poÞ
, 
ngx_¡r_t
 *
‹xt
,‚gx_¡r_ˆ*
esÿ³d
)

1283 
u_ch¬
 *
p
;

1284 
ušŒ_t
 
n
;

1286 
n
 = 
	`ngx_esÿ³_uri
(
NULL
, 
‹xt
->
d©a
,ext->
Ën
, 
NGX_ESCAPE_MAIL_AUTH
);

1288 ià(
n
 == 0) {

1289 *
esÿ³d
 = *
‹xt
;

1290  
NGX_OK
;

1293 
esÿ³d
->
Ën
 = 
‹xt
->ËÀ+ 
n
 * 2;

1295 
p
 = 
	`ngx_²®loc
(
poÞ
, 
esÿ³d
->
Ën
);

1296 ià(
p
 =ð
NULL
) {

1297  
NGX_ERROR
;

1300 (è
	`ngx_esÿ³_uri
(
p
, 
‹xt
->
d©a
,ext->
Ën
, 
NGX_ESCAPE_MAIL_AUTH
);

1302 
esÿ³d
->
d©a
 = 
p
;

1304  
NGX_OK
;

1305 
	}
}

1309 
	$ngx_maž_auth_h‰p_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

1311 
ngx_maž_auth_h‰p_cÚf_t
 *
ahcf
;

1313 
ahcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_auth_h‰p_cÚf_t
));

1314 ià(
ahcf
 =ð
NULL
) {

1315  
NULL
;

1318 
ahcf
->
timeout
 = 
NGX_CONF_UNSET_MSEC
;

1320 
ahcf
->
fže
 = 
cf
->
cÚf_fže
->fže.
Çme
.
d©a
;

1321 
ahcf
->
lše
 = 
cf
->
cÚf_fže
->line;

1323  
ahcf
;

1324 
	}
}

1328 
	$ngx_maž_auth_h‰p_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1330 
ngx_maž_auth_h‰p_cÚf_t
 *
´ev
 = 
·»Á
;

1331 
ngx_maž_auth_h‰p_cÚf_t
 *
cÚf
 = 
chžd
;

1333 
u_ch¬
 *
p
;

1334 
size_t
 
Ën
;

1335 
ngx_ušt_t
 
i
;

1336 
ngx_bË_–t_t
 *
h—d”
;

1338 ià(
cÚf
->
³”
 =ð
NULL
) {

1339 
cÚf
->
³”
 = 
´ev
->peer;

1340 
cÚf
->
ho¡_h—d”
 = 
´ev
->host_header;

1341 
cÚf
->
uri
 = 
´ev
->uri;

1343 ià(
cÚf
->
³”
 =ð
NULL
) {

1344 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

1346 
cÚf
->
fže
, cÚf->
lše
);

1348  
NGX_CONF_ERROR
;

1352 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
timeout
, 
´ev
->timeout, 60000);

1354 ià(
cÚf
->
h—d”s
 =ð
NULL
) {

1355 
cÚf
->
h—d”s
 = 
´ev
->headers;

1356 
cÚf
->
h—d”
 = 
´ev
->header;

1359 ià(
cÚf
->
h—d”s
 && cÚf->
h—d”
.
Ën
 == 0) {

1360 
Ën
 = 0;

1361 
h—d”
 = 
cÚf
->
h—d”s
->
–ts
;

1362 
i
 = 0; i < 
cÚf
->
h—d”s
->
ÃÉs
; i++) {

1363 
Ën
 +ð
h—d”
[
i
].
key
.ËÀ+ 2 + h—d”[i].
v®ue
.len + 2;

1366 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
Ën
);

1367 ià(
p
 =ð
NULL
) {

1368  
NGX_CONF_ERROR
;

1371 
cÚf
->
h—d”
.
Ën
 =†en;

1372 
cÚf
->
h—d”
.
d©a
 = 
p
;

1374 
i
 = 0; i < 
cÚf
->
h—d”s
->
ÃÉs
; i++) {

1375 
p
 = 
	`ngx_ýymem
Õ, 
h—d”
[
i
].
key
.
d©a
, h—d”[i].key.
Ën
);

1376 *
p
++ = ':'; *p++ = ' ';

1377 
p
 = 
	`ngx_ýymem
Õ, 
h—d”
[
i
].
v®ue
.
d©a
, h—d”[i].v®ue.
Ën
);

1378 *
p
++ = 
CR
; *p++ = 
LF
;

1382  
NGX_CONF_OK
;

1383 
	}
}

1387 
	$ngx_maž_auth_h‰p
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1389 
ngx_maž_auth_h‰p_cÚf_t
 *
ahcf
 = 
cÚf
;

1391 
ngx_¡r_t
 *
v®ue
;

1392 
ngx_u¾_t
 
u
;

1394 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1396 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

1398 
u
.
u¾
 = 
v®ue
[1];

1399 
u
.
deçuÉ_pÜt
 = 80;

1400 
u
.
uri_·¹
 = 1;

1402 ià(
	`ngx_¡ºcmp
(
u
.
u¾
.
d©a
, "http://", 7) == 0) {

1403 
u
.
u¾
.
Ën
 -= 7;

1404 
u
.
u¾
.
d©a
 += 7;

1407 ià(
	`ngx_·r£_u¾
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

1408 ià(
u
.
”r
) {

1409 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1410 "% š‡uth_h‰°\"%V\"", 
u
.
”r
, &u.
u¾
);

1413  
NGX_CONF_ERROR
;

1416 
ahcf
->
³”
 = 
u
.
addrs
;

1418 ià(
u
.
çmžy
 !ð
AF_UNIX
) {

1419 
ahcf
->
ho¡_h—d”
 = 
u
.
ho¡
;

1422 
	`ngx_¡r_£t
(&
ahcf
->
ho¡_h—d”
, "localhost");

1425 
ahcf
->
uri
 = 
u
.uri;

1427 ià(
ahcf
->
uri
.
Ën
 == 0) {

1428 
	`ngx_¡r_£t
(&
ahcf
->
uri
, "/");

1431  
NGX_CONF_OK
;

1432 
	}
}

1436 
	$ngx_maž_auth_h‰p_h—d”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1438 
ngx_maž_auth_h‰p_cÚf_t
 *
ahcf
 = 
cÚf
;

1440 
ngx_¡r_t
 *
v®ue
;

1441 
ngx_bË_–t_t
 *
h—d”
;

1443 ià(
ahcf
->
h—d”s
 =ð
NULL
) {

1444 
ahcf
->
h—d”s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poÞ
, 1, (
ngx_bË_–t_t
));

1445 ià(
ahcf
->
h—d”s
 =ð
NULL
) {

1446  
NGX_CONF_ERROR
;

1450 
h—d”
 = 
	`ngx_¬¿y_push
(
ahcf
->
h—d”s
);

1451 ià(
h—d”
 =ð
NULL
) {

1452  
NGX_CONF_ERROR
;

1455 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1457 
h—d”
->
key
 = 
v®ue
[1];

1458 
h—d”
->
v®ue
 = value[2];

1460  
NGX_CONF_OK
;

1461 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_core_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

14 *
ngx_maž_cÜe_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

15 *
ngx_maž_cÜe_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

16 *
ngx_maž_cÜe_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

17 *
chžd
);

18 *
ngx_maž_cÜe_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

19 *
cÚf
);

20 *
ngx_maž_cÜe_li¡’
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

21 *
cÚf
);

22 *
ngx_maž_cÜe_´ÙocÞ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

23 *
cÚf
);

24 *
ngx_maž_cÜe_»sÞv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

25 *
cÚf
);

28 
ngx_cÚf_d•»ÿ‹d_t
 
	gngx_cÚf_d•»ÿ‹d_so_k“·live
 = {

29 
ngx_cÚf_d•»ÿ‹d
, "so_keepalive",

34 
ngx_commªd_t
 
	gngx_maž_cÜe_commªds
[] = {

36 { 
ngx_¡ršg
("server"),

37 
NGX_MAIL_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

38 
ngx_maž_cÜe_£rv”
,

41 
NULL
 },

43 { 
ngx_¡ršg
("listen"),

44 
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

45 
ngx_maž_cÜe_li¡’
,

46 
NGX_MAIL_SRV_CONF_OFFSET
,

48 
NULL
 },

50 { 
ngx_¡ršg
("protocol"),

51 
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

52 
ngx_maž_cÜe_´ÙocÞ
,

53 
NGX_MAIL_SRV_CONF_OFFSET
,

55 
NULL
 },

57 { 
ngx_¡ršg
("so_keepalive"),

58 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

59 
ngx_cÚf_£t_æag_¦Ù
,

60 
NGX_MAIL_SRV_CONF_OFFSET
,

61 
off£tof
(
ngx_maž_cÜe_¤v_cÚf_t
, 
so_k“·live
),

62 &
ngx_cÚf_d•»ÿ‹d_so_k“·live
 },

64 { 
ngx_¡ršg
("timeout"),

65 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

66 
ngx_cÚf_£t_m£c_¦Ù
,

67 
NGX_MAIL_SRV_CONF_OFFSET
,

68 
off£tof
(
ngx_maž_cÜe_¤v_cÚf_t
, 
timeout
),

69 
NULL
 },

71 { 
ngx_¡ršg
("server_name"),

72 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

73 
ngx_cÚf_£t_¡r_¦Ù
,

74 
NGX_MAIL_SRV_CONF_OFFSET
,

75 
off£tof
(
ngx_maž_cÜe_¤v_cÚf_t
, 
£rv”_Çme
),

76 
NULL
 },

78 { 
ngx_¡ršg
("resolver"),

79 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

80 
ngx_maž_cÜe_»sÞv”
,

81 
NGX_MAIL_SRV_CONF_OFFSET
,

83 
NULL
 },

85 { 
ngx_¡ršg
("resolver_timeout"),

86 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

87 
ngx_cÚf_£t_m£c_¦Ù
,

88 
NGX_MAIL_SRV_CONF_OFFSET
,

89 
off£tof
(
ngx_maž_cÜe_¤v_cÚf_t
, 
»sÞv”_timeout
),

90 
NULL
 },

92 
ngx_nuÎ_commªd


96 
ngx_maž_moduË_t
 
	gngx_maž_cÜe_moduË_ùx
 = {

97 
NULL
,

99 
ngx_maž_cÜe_ü—‹_maš_cÚf
,

100 
NULL
,

102 
ngx_maž_cÜe_ü—‹_¤v_cÚf
,

103 
ngx_maž_cÜe_m”ge_¤v_cÚf


107 
ngx_moduË_t
 
	gngx_maž_cÜe_moduË
 = {

108 
NGX_MODULE_V1
,

109 &
ngx_maž_cÜe_moduË_ùx
,

110 
ngx_maž_cÜe_commªds
,

111 
NGX_MAIL_MODULE
,

112 
NULL
,

113 
NULL
,

114 
NULL
,

115 
NULL
,

116 
NULL
,

117 
NULL
,

118 
NULL
,

119 
NGX_MODULE_V1_PADDING


124 
	$ngx_maž_cÜe_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

126 
ngx_maž_cÜe_maš_cÚf_t
 *
cmcf
;

128 
cmcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_cÜe_maš_cÚf_t
));

129 ià(
cmcf
 =ð
NULL
) {

130  
NULL
;

133 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
£rv”s
, 
cf
->
poÞ
, 4,

134 (
ngx_maž_cÜe_¤v_cÚf_t
 *))

135 !ð
NGX_OK
)

137  
NULL
;

140 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
li¡’
, 
cf
->
poÞ
, 4, (
ngx_maž_li¡’_t
))

141 !ð
NGX_OK
)

143  
NULL
;

146  
cmcf
;

147 
	}
}

151 
	$ngx_maž_cÜe_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

153 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

155 
cscf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_cÜe_¤v_cÚf_t
));

156 ià(
cscf
 =ð
NULL
) {

157  
NULL
;

166 
cscf
->
timeout
 = 
NGX_CONF_UNSET_MSEC
;

167 
cscf
->
»sÞv”_timeout
 = 
NGX_CONF_UNSET_MSEC
;

168 
cscf
->
so_k“·live
 = 
NGX_CONF_UNSET
;

170 
cscf
->
»sÞv”
 = 
NGX_CONF_UNSET_PTR
;

172 
cscf
->
fže_Çme
 = 
cf
->
cÚf_fže
->
fže
.
Çme
.
d©a
;

173 
cscf
->
lše
 = 
cf
->
cÚf_fže
->line;

175  
cscf
;

176 
	}
}

180 
	$ngx_maž_cÜe_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

182 
ngx_maž_cÜe_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

183 
ngx_maž_cÜe_¤v_cÚf_t
 *
cÚf
 = 
chžd
;

185 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
timeout
, 
´ev
->timeout, 60000);

186 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
»sÞv”_timeout
, 
´ev
->resolver_timeout,

189 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
so_k“·live
, 
´ev
->so_keepalive, 0);

192 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
£rv”_Çme
, 
´ev
->server_name, "");

194 ià(
cÚf
->
£rv”_Çme
.
Ën
 == 0) {

195 
cÚf
->
£rv”_Çme
 = 
cf
->
cyþe
->
ho¡Çme
;

198 ià(
cÚf
->
´ÙocÞ
 =ð
NULL
) {

199 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

201 
cÚf
->
fže_Çme
, cÚf->
lše
);

202  
NGX_CONF_ERROR
;

205 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
»sÞv”
, 
´ev
->»sÞv”, 
NULL
);

207  
NGX_CONF_OK
;

208 
	}
}

212 
	$ngx_maž_cÜe_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

214 *
rv
;

215 *
mcÚf
;

216 
ngx_ušt_t
 
m
;

217 
ngx_cÚf_t
 
pcf
;

218 
ngx_maž_moduË_t
 *
moduË
;

219 
ngx_maž_cÚf_ùx_t
 *
ùx
, *
maž_ùx
;

220 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
, **
cscå
;

221 
ngx_maž_cÜe_maš_cÚf_t
 *
cmcf
;

223 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_cÚf_ùx_t
));

224 ià(
ùx
 =ð
NULL
) {

225  
NGX_CONF_ERROR
;

228 
maž_ùx
 = 
cf
->
ùx
;

229 
ùx
->
maš_cÚf
 = 
maž_ùx
->main_conf;

233 
ùx
->
¤v_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (*è* 
ngx_maž_max_moduË
);

234 ià(
ùx
->
¤v_cÚf
 =ð
NULL
) {

235  
NGX_CONF_ERROR
;

238 
m
 = 0; 
ngx_moduËs
[m]; m++) {

239 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_MAIL_MODULE
) {

243 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

245 ià(
moduË
->
ü—‹_¤v_cÚf
) {

246 
mcÚf
 = 
moduË
->
	`ü—‹_¤v_cÚf
(
cf
);

247 ià(
mcÚf
 =ð
NULL
) {

248  
NGX_CONF_ERROR
;

251 
ùx
->
¤v_cÚf
[
ngx_moduËs
[
m
]->
ùx_šdex
] = 
mcÚf
;

257 
cscf
 = 
ùx
->
¤v_cÚf
[
ngx_maž_cÜe_moduË
.
ùx_šdex
];

258 
cscf
->
ùx
 = ctx;

260 
cmcf
 = 
ùx
->
maš_cÚf
[
ngx_maž_cÜe_moduË
.
ùx_šdex
];

262 
cscå
 = 
	`ngx_¬¿y_push
(&
cmcf
->
£rv”s
);

263 ià(
cscå
 =ð
NULL
) {

264  
NGX_CONF_ERROR
;

267 *
cscå
 = 
cscf
;

272 
pcf
 = *
cf
;

273 
cf
->
ùx
 = ctx;

274 
cf
->
cmd_ty³
 = 
NGX_MAIL_SRV_CONF
;

276 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

278 *
cf
 = 
pcf
;

280  
rv
;

281 
	}
}

285 
	$ngx_maž_cÜe_li¡’
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

287 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
 = 
cÚf
;

289 
size_t
 
Ën
, 
off
;

290 
š_pÜt_t
 
pÜt
;

291 
ngx_¡r_t
 *
v®ue
;

292 
ngx_u¾_t
 
u
;

293 
ngx_ušt_t
 
i
, 
m
;

294 
sockaddr
 *
§
;

295 
ngx_maž_li¡’_t
 *
ls
;

296 
ngx_maž_moduË_t
 *
moduË
;

297 
sockaddr_š
 *
sš
;

298 
ngx_maž_cÜe_maš_cÚf_t
 *
cmcf
;

299 #ià(
NGX_HAVE_INET6
)

300 
sockaddr_š6
 *
sš6
;

303 
v®ue
 = 
cf
->
¬gs
->
–ts
;

305 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

307 
u
.
u¾
 = 
v®ue
[1];

308 
u
.
li¡’
 = 1;

310 ià(
	`ngx_·r£_u¾
(
cf
->
poÞ
, &
u
è!ð
NGX_OK
) {

311 ià(
u
.
”r
) {

312 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

314 
u
.
”r
, &u.
u¾
);

317  
NGX_CONF_ERROR
;

320 
cmcf
 = 
	`ngx_maž_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_maž_cÜe_moduË
);

322 
ls
 = 
cmcf
->
li¡’
.
–ts
;

324 
i
 = 0; i < 
cmcf
->
li¡’
.
ÃÉs
; i++) {

326 
§
 = (
sockaddr
 *è
ls
[
i
].sockaddr;

328 ià(
§
->
§_çmžy
 !ð
u
.
çmžy
) {

332 
§
->
§_çmžy
) {

334 #ià(
NGX_HAVE_INET6
)

335 
AF_INET6
:

336 
off
 = 
	`off£tof
(
sockaddr_š6
, 
sš6_addr
);

337 
Ën
 = 16;

338 
sš6
 = (
sockaddr_š6
 *è
§
;

339 
pÜt
 = 
sš6
->
sš6_pÜt
;

343 #ià(
NGX_HAVE_UNIX_DOMAIN
)

344 
AF_UNIX
:

345 
off
 = 
	`off£tof
(
sockaddr_un
, 
sun_·th
);

346 
Ën
 = (((
sockaddr_un
 *è
§
)->
sun_·th
);

347 
pÜt
 = 0;

352 
off
 = 
	`off£tof
(
sockaddr_š
, 
sš_addr
);

353 
Ën
 = 4;

354 
sš
 = (
sockaddr_š
 *è
§
;

355 
pÜt
 = 
sš
->
sš_pÜt
;

359 ià(
	`ngx_memcmp
(
ls
[
i
].
sockaddr
 + 
off
, 
u
.sockadd¸+ off, 
Ën
) != 0) {

363 ià(
pÜt
 !ð
u
.port) {

367 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

368 "du¶iÿ‹ \"%V\"‡dd»s ªd…Üˆ·œ", &
u
.
u¾
);

369  
NGX_CONF_ERROR
;

372 
ls
 = 
	`ngx_¬¿y_push
(&
cmcf
->
li¡’
);

373 ià(
ls
 =ð
NULL
) {

374  
NGX_CONF_ERROR
;

377 
	`ngx_memz”o
(
ls
, (
ngx_maž_li¡’_t
));

379 
	`ngx_memýy
(
ls
->
sockaddr
, 
u
.sockaddr, u.
sockËn
);

381 
ls
->
sockËn
 = 
u
.socklen;

382 
ls
->
wždÿrd
 = 
u
.wildcard;

383 
ls
->
ùx
 = 
cf
->ctx;

385 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

386 
ls
->
v6Úly
 = 1;

389 ià(
cscf
->
´ÙocÞ
 =ð
NULL
) {

390 
m
 = 0; 
ngx_moduËs
[m]; m++) {

391 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_MAIL_MODULE
) {

395 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

397 ià(
moduË
->
´ÙocÞ
 =ð
NULL
) {

401 
i
 = 0; 
moduË
->
´ÙocÞ
->
pÜt
[i]; i++) {

402 ià(
moduË
->
´ÙocÞ
->
pÜt
[
i
] =ð
u
.port) {

403 
cscf
->
´ÙocÞ
 = 
moduË
->protocol;

410 
i
 = 2; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

412 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "bind") == 0) {

413 
ls
->
bšd
 = 1;

417 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "ipv6only=o", 10) == 0) {

418 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

419 
sockaddr
 *
§
;

420 
u_ch¬
 
buf
[
NGX_SOCKADDR_STRLEN
];

422 
§
 = (
sockaddr
 *è
ls
->sockaddr;

424 ià(
§
->
§_çmžy
 =ð
AF_INET6
) {

426 ià(
	`ngx_¡rcmp
(&
v®ue
[
i
].
d©a
[10], "n") == 0) {

427 
ls
->
v6Úly
 = 1;

429 } ià(
	`ngx_¡rcmp
(&
v®ue
[
i
].
d©a
[10], "ff") == 0) {

430 
ls
->
v6Úly
 = 0;

433 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

435 &
v®ue
[
i
].
d©a
[9]);

436  
NGX_CONF_ERROR
;

439 
ls
->
bšd
 = 1;

442 
Ën
 = 
	`ngx_sock_ÁÝ
(
§
, 
ls
->
sockËn
, 
buf
,

443 
NGX_SOCKADDR_STRLEN
, 1);

445 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

447 "Ú‡dd¸\"%*s\", ignÜed", 
Ën
, 
buf
);

452 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

455  
NGX_CONF_ERROR
;

459 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "ssl") == 0) {

460 #ià(
NGX_MAIL_SSL
)

461 
ls
->
s¦
 = 1;

464 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

467  
NGX_CONF_ERROR
;

471 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "so_keepalive=", 13) == 0) {

473 ià(
	`ngx_¡rcmp
(&
v®ue
[
i
].
d©a
[13], "on") == 0) {

474 
ls
->
so_k“·live
 = 1;

476 } ià(
	`ngx_¡rcmp
(&
v®ue
[
i
].
d©a
[13], "off") == 0) {

477 
ls
->
so_k“·live
 = 2;

481 #ià(
NGX_HAVE_KEEPALIVE_TUNABLE
)

482 
u_ch¬
 *
p
, *
’d
;

483 
ngx_¡r_t
 
s
;

485 
’d
 = 
v®ue
[
i
].
d©a
 + v®ue[i].
Ën
;

486 
s
.
d©a
 = 
v®ue
[
i
].data + 13;

488 
p
 = 
	`ngx_¡¾chr
(
s
.
d©a
, 
’d
, ':');

489 ià(
p
 =ð
NULL
) {

490 
p
 = 
’d
;

493 ià(
p
 > 
s
.
d©a
) {

494 
s
.
Ën
 = 
p
 - s.
d©a
;

496 
ls
->
tý_k“pidË
 = 
	`ngx_·r£_time
(&
s
, 1);

497 ià(
ls
->
tý_k“pidË
 =ð(
time_t
è
NGX_ERROR
) {

498 
šv®id_so_k“·live
;

502 
s
.
d©a
 = (
p
 < 
’d
) ? (p + 1) :ƒnd;

504 
p
 = 
	`ngx_¡¾chr
(
s
.
d©a
, 
’d
, ':');

505 ià(
p
 =ð
NULL
) {

506 
p
 = 
’d
;

509 ià(
p
 > 
s
.
d©a
) {

510 
s
.
Ën
 = 
p
 - s.
d©a
;

512 
ls
->
tý_k“pštvl
 = 
	`ngx_·r£_time
(&
s
, 1);

513 ià(
ls
->
tý_k“pštvl
 =ð(
time_t
è
NGX_ERROR
) {

514 
šv®id_so_k“·live
;

518 
s
.
d©a
 = (
p
 < 
’d
) ? (p + 1) :ƒnd;

520 ià(
s
.
d©a
 < 
’d
) {

521 
s
.
Ën
 = 
’d
 - s.
d©a
;

523 
ls
->
tý_k“pút
 = 
	`ngx_©oi
(
s
.
d©a
, s.
Ën
);

524 ià(
ls
->
tý_k“pút
 =ð
NGX_ERROR
) {

525 
šv®id_so_k“·live
;

529 ià(
ls
->
tý_k“pidË
 =ð0 &&†s->
tý_k“pštvl
 == 0

530 && 
ls
->
tý_k“pút
 == 0)

532 
šv®id_so_k“·live
;

535 
ls
->
so_k“·live
 = 1;

539 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

542  
NGX_CONF_ERROR
;

547 
ls
->
bšd
 = 1;

551 #ià(
NGX_HAVE_KEEPALIVE_TUNABLE
)

552 
šv®id_so_k“·live
:

554 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

556 &
v®ue
[
i
].
d©a
[13]);

557  
NGX_CONF_ERROR
;

561 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

562 "thšv®id \"%V\"…¬am‘”", &
v®ue
[
i
]);

563  
NGX_CONF_ERROR
;

566  
NGX_CONF_OK
;

567 
	}
}

571 
	$ngx_maž_cÜe_´ÙocÞ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

573 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
 = 
cÚf
;

575 
ngx_¡r_t
 *
v®ue
;

576 
ngx_ušt_t
 
m
;

577 
ngx_maž_moduË_t
 *
moduË
;

579 
v®ue
 = 
cf
->
¬gs
->
–ts
;

581 
m
 = 0; 
ngx_moduËs
[m]; m++) {

582 ià(
ngx_moduËs
[
m
]->
ty³
 !ð
NGX_MAIL_MODULE
) {

586 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

588 ià(
moduË
->
´ÙocÞ


589 && 
	`ngx_¡rcmp
(
moduË
->
´ÙocÞ
->
Çme
.
d©a
, 
v®ue
[1].data) == 0)

591 
cscf
->
´ÙocÞ
 = 
moduË
->protocol;

593  
NGX_CONF_OK
;

597 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

598 "unknowÀ´ÙocÞ \"%V\"", &
v®ue
[1]);

599  
NGX_CONF_ERROR
;

600 
	}
}

604 
	$ngx_maž_cÜe_»sÞv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

606 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
 = 
cÚf
;

608 
ngx_¡r_t
 *
v®ue
;

610 
v®ue
 = 
cf
->
¬gs
->
–ts
;

612 ià(
cscf
->
»sÞv”
 !ð
NGX_CONF_UNSET_PTR
) {

616 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

617 
cscf
->
»sÞv”
 = 
NULL
;

618  
NGX_CONF_OK
;

621 
cscf
->
»sÞv”
 = 
	`ngx_»sÞv”_ü—‹
(
cf
, &
v®ue
[1], cf->
¬gs
->
ÃÉs
 - 1);

622 ià(
cscf
->
»sÞv”
 =ð
NULL
) {

623  
NGX_CONF_ERROR
;

626  
NGX_CONF_OK
;

627 
	}
}

631 
	$ngx_maž_ÿ·bž™›s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

633 *
p
 = 
cÚf
;

635 
ngx_¡r_t
 *
c
, *
v®ue
;

636 
ngx_ušt_t
 
i
;

637 
ngx_¬¿y_t
 *
a
;

639 
a
 = (
ngx_¬¿y_t
 *è(
p
 + 
cmd
->
off£t
);

641 
v®ue
 = 
cf
->
¬gs
->
–ts
;

643 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

644 
c
 = 
	`ngx_¬¿y_push
(
a
);

645 ià(
c
 =ð
NULL
) {

646  
NGX_CONF_ERROR
;

649 *
c
 = 
v®ue
[
i
];

652  
NGX_CONF_OK
;

653 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_handler.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

14 
ngx_maž_š™_£ssiÚ
(
ngx_cÚÃùiÚ_t
 *
c
);

16 #ià(
NGX_MAIL_SSL
)

17 
ngx_maž_s¦_š™_cÚÃùiÚ
(
ngx_s¦_t
 *
s¦
, 
ngx_cÚÃùiÚ_t
 *
c
);

18 
ngx_maž_s¦_hªdshake_hªdËr
(
ngx_cÚÃùiÚ_t
 *
c
);

23 
	$ngx_maž_š™_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

25 
size_t
 
Ën
;

26 
ngx_ušt_t
 
i
;

27 
ngx_maž_pÜt_t
 *
pÜt
;

28 
sockaddr
 *
§
;

29 
sockaddr_š
 *
sš
;

30 
ngx_maž_log_ùx_t
 *
ùx
;

31 
ngx_maž_š_addr_t
 *
addr
;

32 
ngx_maž_£ssiÚ_t
 *
s
;

33 
ngx_maž_addr_cÚf_t
 *
addr_cÚf
;

34 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

35 #ià(
NGX_HAVE_INET6
)

36 
sockaddr_š6
 *
sš6
;

37 
ngx_maž_š6_addr_t
 *
addr6
;

43 
pÜt
 = 
c
->
li¡’šg
->
£rv”s
;

45 ià(
pÜt
->
Çddrs
 > 1) {

55 ià(
	`ngx_cÚÃùiÚ_loÿl_sockaddr
(
c
, 
NULL
, 0è!ð
NGX_OK
) {

56 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

60 
§
 = 
c
->
loÿl_sockaddr
;

62 
§
->
§_çmžy
) {

64 #ià(
NGX_HAVE_INET6
)

65 
AF_INET6
:

66 
sš6
 = (
sockaddr_š6
 *è
§
;

68 
addr6
 = 
pÜt
->
addrs
;

72 
i
 = 0; i < 
pÜt
->
Çddrs
 - 1; i++) {

73 ià(
	`ngx_memcmp
(&
addr6
[
i
].addr6, &
sš6
->
sš6_addr
, 16) == 0) {

78 
addr_cÚf
 = &
addr6
[
i
].
cÚf
;

84 
sš
 = (
sockaddr_š
 *è
§
;

86 
addr
 = 
pÜt
->
addrs
;

90 
i
 = 0; i < 
pÜt
->
Çddrs
 - 1; i++) {

91 ià(
addr
[
i
].add¸=ð
sš
->
sš_addr
.
s_addr
) {

96 
addr_cÚf
 = &
addr
[
i
].
cÚf
;

102 
c
->
loÿl_sockaddr
->
§_çmžy
) {

104 #ià(
NGX_HAVE_INET6
)

105 
AF_INET6
:

106 
addr6
 = 
pÜt
->
addrs
;

107 
addr_cÚf
 = &
addr6
[0].
cÚf
;

112 
addr
 = 
pÜt
->
addrs
;

113 
addr_cÚf
 = &
addr
[0].
cÚf
;

118 
s
 = 
	`ngx_pÿÎoc
(
c
->
poÞ
, (
ngx_maž_£ssiÚ_t
));

119 ià(
s
 =ð
NULL
) {

120 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

124 
s
->
sigÇtu»
 = 
NGX_MAIL_MODULE
;

126 
s
->
maš_cÚf
 = 
addr_cÚf
->
ùx
->main_conf;

127 
s
->
¤v_cÚf
 = 
addr_cÚf
->
ùx
->srv_conf;

129 
s
->
addr_‹xt
 = &
addr_cÚf
->addr_text;

131 
c
->
d©a
 = 
s
;

132 
s
->
cÚÃùiÚ
 = 
c
;

134 
Ën
 = 
	`ngx_sock_ÁÝ
(
c
->
sockaddr
, c->
sockËn
, 
‹xt
, 
NGX_SOCKADDR_STRLEN
, 1);

136 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "*%uA client %*s connectedo %V",

137 
c
->
numb”
, 
Ën
, 
‹xt
, 
s
->
addr_‹xt
);

139 
ùx
 = 
	`ngx_·Îoc
(
c
->
poÞ
, (
ngx_maž_log_ùx_t
));

140 ià(
ùx
 =ð
NULL
) {

141 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

145 
ùx
->
þ›Á
 = &
c
->
addr_‹xt
;

146 
ùx
->
£ssiÚ
 = 
s
;

148 
c
->
log
->
cÚÃùiÚ
 = c->
numb”
;

149 
c
->
log
->
hªdËr
 = 
ngx_maž_log_”rÜ
;

150 
c
->
log
->
d©a
 = 
ùx
;

151 
c
->
log
->
aùiÚ
 = "sending client greeting†ine";

153 
c
->
log_”rÜ
 = 
NGX_ERROR_INFO
;

155 #ià(
NGX_MAIL_SSL
)

157 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

159 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

161 ià(
s¦cf
->
’abË
) {

162 
c
->
log
->
aùiÚ
 = "SSL handshaking";

164 
	`ngx_maž_s¦_š™_cÚÃùiÚ
(&
s¦cf
->
s¦
, 
c
);

168 ià(
addr_cÚf
->
s¦
) {

170 
c
->
log
->
aùiÚ
 = "SSL handshaking";

172 ià(
s¦cf
->
s¦
.
ùx
 =ð
NULL
) {

173 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

176 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

180 
	`ngx_maž_s¦_š™_cÚÃùiÚ
(&
s¦cf
->
s¦
, 
c
);

187 
	`ngx_maž_š™_£ssiÚ
(
c
);

188 
	}
}

191 #ià(
NGX_MAIL_SSL
)

194 
	$ngx_maž_¡¬‰ls_hªdËr
(
ngx_ev’t_t
 *
»v
)

196 
ngx_cÚÃùiÚ_t
 *
c
;

197 
ngx_maž_£ssiÚ_t
 *
s
;

198 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

200 
c
 = 
»v
->
d©a
;

201 
s
 = 
c
->
d©a
;

202 
s
->
¡¬‰ls
 = 1;

204 
c
->
log
->
aùiÚ
 = "in starttls state";

206 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

208 
	`ngx_maž_s¦_š™_cÚÃùiÚ
(&
s¦cf
->
s¦
, 
c
);

209 
	}
}

213 
	$ngx_maž_s¦_š™_cÚÃùiÚ
(
ngx_s¦_t
 *
s¦
, 
ngx_cÚÃùiÚ_t
 *
c
)

215 
ngx_maž_£ssiÚ_t
 *
s
;

216 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

218 ià(
	`ngx_s¦_ü—‹_cÚÃùiÚ
(
s¦
, 
c
, 0è=ð
NGX_ERROR
) {

219 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

223 ià(
	`ngx_s¦_hªdshake
(
c
è=ð
NGX_AGAIN
) {

225 
s
 = 
c
->
d©a
;

227 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

229 
	`ngx_add_tim”
(
c
->
»ad
, 
cscf
->
timeout
);

231 
c
->
s¦
->
hªdËr
 = 
ngx_maž_s¦_hªdshake_hªdËr
;

236 
	`ngx_maž_s¦_hªdshake_hªdËr
(
c
);

237 
	}
}

241 
	$ngx_maž_s¦_hªdshake_hªdËr
(
ngx_cÚÃùiÚ_t
 *
c
)

243 
ngx_maž_£ssiÚ_t
 *
s
;

244 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

246 ià(
c
->
s¦
->
hªdshaked
) {

248 
s
 = 
c
->
d©a
;

250 ià(
s
->
¡¬‰ls
) {

251 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

253 
c
->
»ad
->
hªdËr
 = 
cscf
->
´ÙocÞ
->
š™_´ÙocÞ
;

254 
c
->
wr™e
->
hªdËr
 = 
ngx_maž_£nd
;

256 
cscf
->
´ÙocÞ
->
	`š™_´ÙocÞ
(
c
->
»ad
);

261 
c
->
»ad
->
»ady
 = 0;

263 
	`ngx_maž_š™_£ssiÚ
(
c
);

267 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

268 
	}
}

274 
	$ngx_maž_š™_£ssiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

276 
ngx_maž_£ssiÚ_t
 *
s
;

277 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

279 
s
 = 
c
->
d©a
;

281 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

283 
s
->
´ÙocÞ
 = 
cscf
->´ÙocÞ->
ty³
;

285 
s
->
ùx
 = 
	`ngx_pÿÎoc
(
c
->
poÞ
, (*è* 
ngx_maž_max_moduË
);

286 ià(
s
->
ùx
 =ð
NULL
) {

287 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

291 
c
->
wr™e
->
hªdËr
 = 
ngx_maž_£nd
;

293 
cscf
->
´ÙocÞ
->
	`š™_£ssiÚ
(
s
, 
c
);

294 
	}
}

297 
ngx_št_t


298 
	$ngx_maž_§É
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

299 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
)

301 
s
->
§É
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,

302 (" <18446744073709551616.@>" 
CRLF
) - 1

303 + 
NGX_TIME_T_LEN


304 + 
cscf
->
£rv”_Çme
.
Ën
);

305 ià(
s
->
§É
.
d©a
 =ð
NULL
) {

306  
NGX_ERROR
;

309 
s
->
§É
.
Ën
 = 
	`ngx_¥rštf
(s->§É.
d©a
, "<%ul.%T@%V>" 
CRLF
,

310 
	`ngx_¿ndom
(), 
	`ngx_time
(), &
cscf
->
£rv”_Çme
)

311 - 
s
->
§É
.
d©a
;

313  
NGX_OK
;

314 
	}
}

317 #ià(
NGX_MAIL_SSL
)

319 
ngx_št_t


320 
	$ngx_maž_¡¬‰ls_Úly
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

322 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

324 ià(
c
->
s¦
) {

328 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

330 ià(
s¦cf
->
¡¬‰ls
 =ð
NGX_MAIL_STARTTLS_ONLY
) {

335 
	}
}

340 
ngx_št_t


341 
	$ngx_maž_auth_¶aš
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
n
)

343 
u_ch¬
 *
p
, *
Ï¡
;

344 
ngx_¡r_t
 *
¬g
, 
¶aš
;

346 
¬g
 = 
s
->
¬gs
.
–ts
;

348 #ià(
NGX_DEBUG_MAIL_PASSWD
)

349 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

350 "maž‡uth…Ïš: \"%V\"", &
¬g
[
n
]);

353 
¶aš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, 
	`ngx_ba£64_decoded_Ëngth
(
¬g
[
n
].
Ën
));

354 ià(
¶aš
.
d©a
 =ð
NULL
) {

355  
NGX_ERROR
;

358 ià(
	`ngx_decode_ba£64
(&
¶aš
, &
¬g
[
n
]è!ð
NGX_OK
) {

359 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

361  
NGX_MAIL_PARSE_INVALID_COMMAND
;

364 
p
 = 
¶aš
.
d©a
;

365 
Ï¡
 = 
p
 + 
¶aš
.
Ën
;

367 
p
 < 
Ï¡
 && *p++) { }

369 ià(
p
 =ð
Ï¡
) {

370 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

372  
NGX_MAIL_PARSE_INVALID_COMMAND
;

375 
s
->
logš
.
d©a
 = 
p
;

377 
p
 < 
Ï¡
 && *p) {…++; }

379 ià(
p
 =ð
Ï¡
) {

380 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

382  
NGX_MAIL_PARSE_INVALID_COMMAND
;

385 
s
->
logš
.
Ën
 = 
p
++ - s->logš.
d©a
;

387 
s
->
·sswd
.
Ën
 = 
Ï¡
 - 
p
;

388 
s
->
·sswd
.
d©a
 = 
p
;

390 #ià(
NGX_DEBUG_MAIL_PASSWD
)

391 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

392 "maž‡uth…Ïš: \"%V\" \"%V\"", &
s
->
logš
, &s->
·sswd
);

395  
NGX_DONE
;

396 
	}
}

399 
ngx_št_t


400 
	$ngx_maž_auth_logš_u£ºame
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

401 
ngx_ušt_t
 
n
)

403 
ngx_¡r_t
 *
¬g
;

405 
¬g
 = 
s
->
¬gs
.
–ts
;

407 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

408 "maž‡uth†ogš u£ºame: \"%V\"", &
¬g
[
n
]);

410 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, 
	`ngx_ba£64_decoded_Ëngth
(
¬g
[
n
].
Ën
));

411 ià(
s
->
logš
.
d©a
 =ð
NULL
) {

412  
NGX_ERROR
;

415 ià(
	`ngx_decode_ba£64
(&
s
->
logš
, &
¬g
[
n
]è!ð
NGX_OK
) {

416 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

418  
NGX_MAIL_PARSE_INVALID_COMMAND
;

421 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

422 "maž‡uth†ogš u£ºame: \"%V\"", &
s
->
logš
);

424  
NGX_OK
;

425 
	}
}

428 
ngx_št_t


429 
	$ngx_maž_auth_logš_·sswÜd
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

431 
ngx_¡r_t
 *
¬g
;

433 
¬g
 = 
s
->
¬gs
.
–ts
;

435 #ià(
NGX_DEBUG_MAIL_PASSWD
)

436 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

437 "maž‡uth†ogš…asswÜd: \"%V\"", &
¬g
[0]);

440 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,

441 
	`ngx_ba£64_decoded_Ëngth
(
¬g
[0].
Ën
));

442 ià(
s
->
·sswd
.
d©a
 =ð
NULL
) {

443  
NGX_ERROR
;

446 ià(
	`ngx_decode_ba£64
(&
s
->
·sswd
, &
¬g
[0]è!ð
NGX_OK
) {

447 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

449  
NGX_MAIL_PARSE_INVALID_COMMAND
;

452 #ià(
NGX_DEBUG_MAIL_PASSWD
)

453 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

454 "maž‡uth†ogš…asswÜd: \"%V\"", &
s
->
·sswd
);

457  
NGX_DONE
;

458 
	}
}

461 
ngx_št_t


462 
	$ngx_maž_auth_üam_md5_§É
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

463 *
´efix
, 
size_t
 
Ën
)

465 
u_ch¬
 *
p
;

466 
ngx_¡r_t
 
§É
;

467 
ngx_ušt_t
 
n
;

469 
p
 = 
	`ngx_²®loc
(
c
->
poÞ
, 
Ën
 + 
	`ngx_ba£64_’coded_Ëngth
(
s
->
§É
.len) + 2);

470 ià(
p
 =ð
NULL
) {

471  
NGX_ERROR
;

474 
§É
.
d©a
 = 
	`ngx_ýymem
(
p
, 
´efix
, 
Ën
);

475 
s
->
§É
.
Ën
 -= 2;

477 
	`ngx_’code_ba£64
(&
§É
, &
s
->salt);

479 
s
->
§É
.
Ën
 += 2;

480 
n
 = 
Ën
 + 
§É
.len;

481 
p
[
n
++] = 
CR
;…[n++] = 
LF
;

483 
s
->
out
.
Ën
 = 
n
;

484 
s
->
out
.
d©a
 = 
p
;

486  
NGX_OK
;

487 
	}
}

490 
ngx_št_t


491 
	$ngx_maž_auth_üam_md5
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

493 
u_ch¬
 *
p
, *
Ï¡
;

494 
ngx_¡r_t
 *
¬g
;

496 
¬g
 = 
s
->
¬gs
.
–ts
;

498 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

499 "maž‡uth c¿m-md5: \"%V\"", &
¬g
[0]);

501 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, 
	`ngx_ba£64_decoded_Ëngth
(
¬g
[0].
Ën
));

502 ià(
s
->
logš
.
d©a
 =ð
NULL
) {

503  
NGX_ERROR
;

506 ià(
	`ngx_decode_ba£64
(&
s
->
logš
, &
¬g
[0]è!ð
NGX_OK
) {

507 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

509  
NGX_MAIL_PARSE_INVALID_COMMAND
;

512 
p
 = 
s
->
logš
.
d©a
;

513 
Ï¡
 = 
p
 + 
s
->
logš
.
Ën
;

515 
p
 < 
Ï¡
) {

516 ià(*
p
++ == ' ') {

517 
s
->
logš
.
Ën
 = 
p
 - s->logš.
d©a
 - 1;

518 
s
->
·sswd
.
Ën
 = 
Ï¡
 - 
p
;

519 
s
->
·sswd
.
d©a
 = 
p
;

524 ià(
s
->
·sswd
.
Ën
 != 32) {

525 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

527  
NGX_MAIL_PARSE_INVALID_COMMAND
;

530 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

531 "maž‡uth c¿m-md5: \"%V\" \"%V\"", &
s
->
logš
, &s->
·sswd
);

533 
s
->
auth_m‘hod
 = 
NGX_MAIL_AUTH_CRAM_MD5
;

535  
NGX_DONE
;

536 
	}
}

540 
	$ngx_maž_£nd
(
ngx_ev’t_t
 *
wev
)

542 
ngx_št_t
 
n
;

543 
ngx_cÚÃùiÚ_t
 *
c
;

544 
ngx_maž_£ssiÚ_t
 *
s
;

545 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

547 
c
 = 
wev
->
d©a
;

548 
s
 = 
c
->
d©a
;

550 ià(
wev
->
timedout
) {

551 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

552 
c
->
timedout
 = 1;

553 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

557 ià(
s
->
out
.
Ën
 == 0) {

558 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

559 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

565 
n
 = 
c
->
	`£nd
(c, 
s
->
out
.
d©a
, s->out.
Ën
);

567 ià(
n
 > 0) {

568 
s
->
out
.
d©a
 +ð
n
;

569 
s
->
out
.
Ën
 -ð
n
;

571 ià(
s
->
out
.
Ën
 != 0) {

572 
agaš
;

575 ià(
wev
->
tim”_£t
) {

576 
	`ngx_d–_tim”
(
wev
);

579 ià(
s
->
qu™
) {

580 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

584 ià(
s
->
blocked
) {

585 
c
->
»ad
->
	`hªdËr
(c->read);

591 ià(
n
 =ð
NGX_ERROR
) {

592 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

598 
agaš
:

600 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

602 
	`ngx_add_tim”
(
c
->
wr™e
, 
cscf
->
timeout
);

604 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ð
NGX_OK
) {

605 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

608 
	}
}

611 
ngx_št_t


612 
	$ngx_maž_»ad_commªd
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

614 
ssize_t
 
n
;

615 
ngx_št_t
 
rc
;

616 
ngx_¡r_t
 
l
;

617 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

619 
n
 = 
c
->
	`»cv
(c, 
s
->
bufãr
->
Ï¡
, s->bufãr->
’d
 - s->buffer->last);

621 ià(
n
 =ð
NGX_ERROR
 ||‚ == 0) {

622 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

623  
NGX_ERROR
;

626 ià(
n
 > 0) {

627 
s
->
bufãr
->
Ï¡
 +ð
n
;

630 ià(
n
 =ð
NGX_AGAIN
) {

631 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

632 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

633  
NGX_ERROR
;

636 ià(
s
->
bufãr
->
pos
 =ðs->bufãr->
Ï¡
) {

637  
NGX_AGAIN
;

641 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

643 
rc
 = 
cscf
->
´ÙocÞ
->
	`·r£_commªd
(
s
);

645 ià(
rc
 =ð
NGX_AGAIN
) {

647 ià(
s
->
bufãr
->
Ï¡
 < s->bufãr->
’d
) {

648  
rc
;

651 
l
.
Ën
 = 
s
->
bufãr
->
Ï¡
 - s->bufãr->
¡¬t
;

652 
l
.
d©a
 = 
s
->
bufãr
->
¡¬t
;

654 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

655 "þ›Á s’ˆtoØlÚg commªd \"%V\"", &
l
);

657 
s
->
qu™
 = 1;

659  
NGX_MAIL_PARSE_INVALID_COMMAND
;

662 ià(
rc
 =ð
NGX_IMAP_NEXT
 ||„ø=ð
NGX_MAIL_PARSE_INVALID_COMMAND
) {

663  
rc
;

666 ià(
rc
 =ð
NGX_ERROR
) {

667 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

668  
NGX_ERROR
;

671  
NGX_OK
;

672 
	}
}

676 
	$ngx_maž_auth
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

678 
s
->
¬gs
.
ÃÉs
 = 0;

680 ià(
s
->
bufãr
->
pos
 =ðs->bufãr->
Ï¡
) {

681 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

682 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

685 
s
->
¡©e
 = 0;

687 ià(
c
->
»ad
->
tim”_£t
) {

688 
	`ngx_d–_tim”
(
c
->
»ad
);

691 
s
->
logš_©‹m±
++;

693 
	`ngx_maž_auth_h‰p_š™
(
s
);

694 
	}
}

698 
	$ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
ngx_maž_£ssiÚ_t
 *
s
)

700 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

702 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

704 
s
->
out
 = 
cscf
->
´ÙocÞ
->
š‹º®_£rv”_”rÜ
;

705 
s
->
qu™
 = 1;

707 
	`ngx_maž_£nd
(
s
->
cÚÃùiÚ
->
wr™e
);

708 
	}
}

712 
	$ngx_maž_þo£_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

714 
ngx_poÞ_t
 *
poÞ
;

716 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

717 "þo£ maž cÚÃùiÚ: %d", 
c
->
fd
);

719 #ià(
NGX_MAIL_SSL
)

721 ià(
c
->
s¦
) {

722 ià(
	`ngx_s¦_shutdown
(
c
è=ð
NGX_AGAIN
) {

723 
c
->
s¦
->
hªdËr
 = 
ngx_maž_þo£_cÚÃùiÚ
;

730 #ià(
NGX_STAT_STUB
)

731 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_aùive
, -1);

734 
c
->
de¡royed
 = 1;

736 
poÞ
 = 
c
->pool;

738 
	`ngx_þo£_cÚÃùiÚ
(
c
);

740 
	`ngx_de¡roy_poÞ
(
poÞ
);

741 
	}
}

744 
u_ch¬
 *

745 
	$ngx_maž_log_”rÜ
(
ngx_log_t
 *
log
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
)

747 
u_ch¬
 *
p
;

748 
ngx_maž_£ssiÚ_t
 *
s
;

749 
ngx_maž_log_ùx_t
 *
ùx
;

751 ià(
log
->
aùiÚ
) {

752 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, " whž%s", 
log
->
aùiÚ
);

753 
Ën
 -ð
p
 - 
buf
;

754 
buf
 = 
p
;

757 
ùx
 = 
log
->
d©a
;

759 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", cl›Á: %V", 
ùx
->
þ›Á
);

760 
Ën
 -ð
p
 - 
buf
;

761 
buf
 = 
p
;

763 
s
 = 
ùx
->
£ssiÚ
;

765 ià(
s
 =ð
NULL
) {

766  
p
;

769 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, "%s, server: %V",

770 
s
->
¡¬‰ls
 ? " using starttls" : "",

771 
s
->
addr_‹xt
);

772 
Ën
 -ð
p
 - 
buf
;

773 
buf
 = 
p
;

775 ià(
s
->
logš
.
Ën
 == 0) {

776  
p
;

779 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ",†ogš: \"%V\"", &
s
->
logš
);

780 
Ën
 -ð
p
 - 
buf
;

781 
buf
 = 
p
;

783 ià(
s
->
´oxy
 =ð
NULL
) {

784  
p
;

787 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", up¡»am: %V", 
s
->
´oxy
->
up¡»am
.
Çme
);

789  
p
;

790 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_imap_handler.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

12 
	~<ngx_maž_im­_moduË.h
>

15 
ngx_št_t
 
ngx_maž_im­_logš
(
ngx_maž_£ssiÚ_t
 *
s
,

16 
ngx_cÚÃùiÚ_t
 *
c
);

17 
ngx_št_t
 
ngx_maž_im­_auth’tiÿ‹
(
ngx_maž_£ssiÚ_t
 *
s
,

18 
ngx_cÚÃùiÚ_t
 *
c
);

19 
ngx_št_t
 
ngx_maž_im­_ÿ·bž™y
(
ngx_maž_£ssiÚ_t
 *
s
,

20 
ngx_cÚÃùiÚ_t
 *
c
);

21 
ngx_št_t
 
ngx_maž_im­_¡¬‰ls
(
ngx_maž_£ssiÚ_t
 *
s
,

22 
ngx_cÚÃùiÚ_t
 *
c
);

25 
u_ch¬
 
	gim­_g»‘šg
[] = "* OK IMAP4„—dy" 
CRLF
;

26 
u_ch¬
 
	gim­_¡¬
[] = "* ";

27 
u_ch¬
 
	gim­_ok
[] = "OK com¶‘ed" 
CRLF
;

28 
u_ch¬
 
	gim­_Ãxt
[] = "+ OK" 
CRLF
;

29 
u_ch¬
 
	gim­_¶aš_Ãxt
[] = "+ " 
CRLF
;

30 
u_ch¬
 
	gim­_u£ºame
[] = "+ VXNlcm5hbWU6" 
CRLF
;

31 
u_ch¬
 
	gim­_·sswÜd
[] = "+ UGFzc3dvcmQ6" 
CRLF
;

32 
u_ch¬
 
	gim­_bye
[] = "* BYE" 
CRLF
;

33 
u_ch¬
 
	gim­_šv®id_commªd
[] = "BAD inv®id commªd" 
CRLF
;

37 
	$ngx_maž_im­_š™_£ssiÚ
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

39 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

41 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

43 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_g»‘šg
);

45 
c
->
»ad
->
hªdËr
 = 
ngx_maž_im­_š™_´ÙocÞ
;

47 
	`ngx_add_tim”
(
c
->
»ad
, 
cscf
->
timeout
);

49 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

50 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

53 
	`ngx_maž_£nd
(
c
->
wr™e
);

54 
	}
}

58 
	$ngx_maž_im­_š™_´ÙocÞ
(
ngx_ev’t_t
 *
»v
)

60 
ngx_cÚÃùiÚ_t
 *
c
;

61 
ngx_maž_£ssiÚ_t
 *
s
;

62 
ngx_maž_im­_¤v_cÚf_t
 *
iscf
;

64 
c
 = 
»v
->
d©a
;

66 
c
->
log
->
aùiÚ
 = "in‡uth state";

68 ià(
»v
->
timedout
) {

69 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

70 
c
->
timedout
 = 1;

71 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

75 
s
 = 
c
->
d©a
;

77 ià(
s
->
bufãr
 =ð
NULL
) {

78 ià(
	`ngx_¬¿y_š™
(&
s
->
¬gs
, 
c
->
poÞ
, 2, (
ngx_¡r_t
))

79 =ð
NGX_ERROR
)

81 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

85 
iscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_im­_moduË
);

87 
s
->
bufãr
 = 
	`ngx_ü—‹_‹mp_buf
(
c
->
poÞ
, 
iscf
->
þ›Á_bufãr_size
);

88 ià(
s
->
bufãr
 =ð
NULL
) {

89 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

94 
s
->
maž_¡©e
 = 
ngx_im­_¡¬t
;

95 
c
->
»ad
->
hªdËr
 = 
ngx_maž_im­_auth_¡©e
;

97 
	`ngx_maž_im­_auth_¡©e
(
»v
);

98 
	}
}

102 
	$ngx_maž_im­_auth_¡©e
(
ngx_ev’t_t
 *
»v
)

104 
u_ch¬
 *
p
, *
d¡
, *
¤c
, *
’d
;

105 
ngx_¡r_t
 *
¬g
;

106 
ngx_št_t
 
rc
;

107 
ngx_ušt_t
 
g
, 
i
;

108 
ngx_cÚÃùiÚ_t
 *
c
;

109 
ngx_maž_£ssiÚ_t
 *
s
;

111 
c
 = 
»v
->
d©a
;

112 
s
 = 
c
->
d©a
;

114 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "imap‡uth state");

116 ià(
»v
->
timedout
) {

117 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

118 
c
->
timedout
 = 1;

119 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

123 ià(
s
->
out
.
Ën
) {

124 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "imap send handler busy");

125 
s
->
blocked
 = 1;

129 
s
->
blocked
 = 0;

131 
rc
 = 
	`ngx_maž_»ad_commªd
(
s
, 
c
);

133 ià(
rc
 =ð
NGX_AGAIN
 ||„ø=ð
NGX_ERROR
) {

137 
g
 = 1;

138 
s
->
‹xt
.
Ën
 = 0;

139 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_ok
);

141 ià(
rc
 =ð
NGX_OK
) {

143 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "imap‡uth command: %i",

144 
s
->
commªd
);

146 ià(
s
->
back¦ash
) {

148 
¬g
 = 
s
->
¬gs
.
–ts
;

150 
i
 = 0; i < 
s
->
¬gs
.
ÃÉs
; i++) {

151 
d¡
 = 
¬g
[
i
].
d©a
;

152 
’d
 = 
d¡
 + 
¬g
[
i
].
Ën
;

154 
¤c
 = 
d¡
; srø< 
’d
; dst++) {

155 *
d¡
 = *
¤c
;

156 ià(*
¤c
++ == '\\') {

157 *
d¡
 = *
¤c
++;

161 
¬g
[
i
].
Ën
 = 
d¡
 -‡rg[i].
d©a
;

164 
s
->
back¦ash
 = 0;

167 
s
->
maž_¡©e
) {

169 
ngx_im­_¡¬t
:

171 
s
->
commªd
) {

173 
NGX_IMAP_LOGIN
:

174 
rc
 = 
	`ngx_maž_im­_logš
(
s
, 
c
);

177 
NGX_IMAP_AUTHENTICATE
:

178 
rc
 = 
	`ngx_maž_im­_auth’tiÿ‹
(
s
, 
c
);

179 
g
 = (
rc
 !ð
NGX_OK
);

182 
NGX_IMAP_CAPABILITY
:

183 
rc
 = 
	`ngx_maž_im­_ÿ·bž™y
(
s
, 
c
);

186 
NGX_IMAP_LOGOUT
:

187 
s
->
qu™
 = 1;

188 
	`ngx_¡r_£t
(&
s
->
‹xt
, 
im­_bye
);

191 
NGX_IMAP_NOOP
:

194 
NGX_IMAP_STARTTLS
:

195 
rc
 = 
	`ngx_maž_im­_¡¬‰ls
(
s
, 
c
);

199 
rc
 = 
NGX_MAIL_PARSE_INVALID_COMMAND
;

205 
ngx_im­_auth_logš_u£ºame
:

206 
rc
 = 
	`ngx_maž_auth_logš_u£ºame
(
s
, 
c
, 0);

208 
g
 = 0;

209 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_·sswÜd
);

210 
s
->
maž_¡©e
 = 
ngx_im­_auth_logš_·sswÜd
;

214 
ngx_im­_auth_logš_·sswÜd
:

215 
rc
 = 
	`ngx_maž_auth_logš_·sswÜd
(
s
, 
c
);

218 
ngx_im­_auth_¶aš
:

219 
rc
 = 
	`ngx_maž_auth_¶aš
(
s
, 
c
, 0);

222 
ngx_im­_auth_üam_md5
:

223 
rc
 = 
	`ngx_maž_auth_üam_md5
(
s
, 
c
);

227 } ià(
rc
 =ð
NGX_IMAP_NEXT
) {

228 
g
 = 0;

229 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_Ãxt
);

232 
rc
) {

234 
NGX_DONE
:

235 
	`ngx_maž_auth
(
s
, 
c
);

238 
NGX_ERROR
:

239 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

242 
NGX_MAIL_PARSE_INVALID_COMMAND
:

243 
s
->
¡©e
 = 0;

244 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_šv®id_commªd
);

245 
s
->
maž_¡©e
 = 
ngx_im­_¡¬t
;

249 ià(
g
) {

250 ià(
s
->
g
.
Ën
 == 0) {

251 
	`ngx_¡r_£t
(&
s
->
g
, 
im­_¡¬
);

254 ià(
s
->
gged_lše
.
Ën
 < s->
g
.ËÀ+ s->
‹xt
.ËÀ+ s->
out
.len) {

255 
s
->
gged_lše
.
Ën
 = s->
g
.ËÀ+ s->
‹xt
.ËÀ+ s->
out
.len;

256 
s
->
gged_lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, s->gged_lše.
Ën
);

257 ià(
s
->
gged_lše
.
d©a
 =ð
NULL
) {

258 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

263 
p
 = 
s
->
gged_lše
.
d©a
;

265 ià(
s
->
‹xt
.
Ën
) {

266 
p
 = 
	`ngx_ýymem
Õ, 
s
->
‹xt
.
d©a
, s->‹xt.
Ën
);

269 
p
 = 
	`ngx_ýymem
Õ, 
s
->
g
.
d©a
, s->g.
Ën
);

270 
	`ngx_memýy
(
p
, 
s
->
out
.
d©a
, s->out.
Ën
);

272 
s
->
out
.
Ën
 = s->
‹xt
.ËÀ+ s->
g
.len + s->out.len;

273 
s
->
out
.
d©a
 = s->
gged_lše
.data;

276 ià(
rc
 !ð
NGX_IMAP_NEXT
) {

277 
s
->
¬gs
.
ÃÉs
 = 0;

279 ià(
s
->
¡©e
) {

281 
s
->
¬g_¡¬t
 = s->
bufãr
->
¡¬t
 + s->
g
.
Ën
;

282 
s
->
bufãr
->
pos
 = s->
¬g_¡¬t
;

283 
s
->
bufãr
->
Ï¡
 = s->
¬g_¡¬t
;

286 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

287 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

288 
s
->
g
.
Ën
 = 0;

292 
	`ngx_maž_£nd
(
c
->
wr™e
);

293 
	}
}

296 
ngx_št_t


297 
	$ngx_maž_im­_logš
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

299 
ngx_¡r_t
 *
¬g
;

301 #ià(
NGX_MAIL_SSL
)

302 ià(
	`ngx_maž_¡¬‰ls_Úly
(
s
, 
c
)) {

303  
NGX_MAIL_PARSE_INVALID_COMMAND
;

307 
¬g
 = 
s
->
¬gs
.
–ts
;

309 ià(
s
->
¬gs
.
ÃÉs
 !ð2 || 
¬g
[0].
Ën
 == 0) {

310  
NGX_MAIL_PARSE_INVALID_COMMAND
;

313 
s
->
logš
.
Ën
 = 
¬g
[0].len;

314 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, s->logš.
Ën
);

315 ià(
s
->
logš
.
d©a
 =ð
NULL
) {

316  
NGX_ERROR
;

319 
	`ngx_memýy
(
s
->
logš
.
d©a
, 
¬g
[0].d©a, s->logš.
Ën
);

321 
s
->
·sswd
.
Ën
 = 
¬g
[1].len;

322 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, s->·sswd.
Ën
);

323 ià(
s
->
·sswd
.
d©a
 =ð
NULL
) {

324  
NGX_ERROR
;

327 
	`ngx_memýy
(
s
->
·sswd
.
d©a
, 
¬g
[1].d©a, s->·sswd.
Ën
);

329 #ià(
NGX_DEBUG_MAIL_PASSWD
)

330 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

332 &
s
->
logš
, &s->
·sswd
);

334 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

335 "im­†ogš:\"%V\"", &
s
->
logš
);

338  
NGX_DONE
;

339 
	}
}

342 
ngx_št_t


343 
	$ngx_maž_im­_auth’tiÿ‹
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

345 
ngx_št_t
 
rc
;

346 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

347 
ngx_maž_im­_¤v_cÚf_t
 *
iscf
;

349 #ià(
NGX_MAIL_SSL
)

350 ià(
	`ngx_maž_¡¬‰ls_Úly
(
s
, 
c
)) {

351  
NGX_MAIL_PARSE_INVALID_COMMAND
;

355 
rc
 = 
	`ngx_maž_auth_·r£
(
s
, 
c
);

357 
rc
) {

359 
NGX_MAIL_AUTH_LOGIN
:

361 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_u£ºame
);

362 
s
->
maž_¡©e
 = 
ngx_im­_auth_logš_u£ºame
;

364  
NGX_OK
;

366 
NGX_MAIL_AUTH_LOGIN_USERNAME
:

368 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_·sswÜd
);

369 
s
->
maž_¡©e
 = 
ngx_im­_auth_logš_·sswÜd
;

371  
	`ngx_maž_auth_logš_u£ºame
(
s
, 
c
, 1);

373 
NGX_MAIL_AUTH_PLAIN
:

375 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_¶aš_Ãxt
);

376 
s
->
maž_¡©e
 = 
ngx_im­_auth_¶aš
;

378  
NGX_OK
;

380 
NGX_MAIL_AUTH_CRAM_MD5
:

382 
iscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_im­_moduË
);

384 ià(!(
iscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
)) {

385  
NGX_MAIL_PARSE_INVALID_COMMAND
;

388 ià(
s
->
§É
.
d©a
 =ð
NULL
) {

389 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

391 ià(
	`ngx_maž_§É
(
s
, 
c
, 
cscf
è!ð
NGX_OK
) {

392  
NGX_ERROR
;

396 ià(
	`ngx_maž_auth_üam_md5_§É
(
s
, 
c
, "+ ", 2è=ð
NGX_OK
) {

397 
s
->
maž_¡©e
 = 
ngx_im­_auth_üam_md5
;

398  
NGX_OK
;

401  
NGX_ERROR
;

404  
rc
;

405 
	}
}

408 
ngx_št_t


409 
	$ngx_maž_im­_ÿ·bž™y
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

411 
ngx_maž_im­_¤v_cÚf_t
 *
iscf
;

413 
iscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_im­_moduË
);

415 #ià(
NGX_MAIL_SSL
)

417 ià(
c
->
s¦
 =ð
NULL
) {

418 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

420 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

422 ià(
s¦cf
->
¡¬‰ls
 =ð
NGX_MAIL_STARTTLS_ON
) {

423 
s
->
‹xt
 = 
iscf
->
¡¬‰ls_ÿ·bž™y
;

424  
NGX_OK
;

427 ià(
s¦cf
->
¡¬‰ls
 =ð
NGX_MAIL_STARTTLS_ONLY
) {

428 
s
->
‹xt
 = 
iscf
->
¡¬‰ls_Úly_ÿ·bž™y
;

429  
NGX_OK
;

434 
s
->
‹xt
 = 
iscf
->
ÿ·bž™y
;

436  
NGX_OK
;

437 
	}
}

440 
ngx_št_t


441 
	$ngx_maž_im­_¡¬‰ls
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

443 #ià(
NGX_MAIL_SSL
)

444 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

446 ià(
c
->
s¦
 =ð
NULL
) {

447 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

448 ià(
s¦cf
->
¡¬‰ls
) {

449 
c
->
»ad
->
hªdËr
 = 
ngx_maž_¡¬‰ls_hªdËr
;

450  
NGX_OK
;

456  
NGX_MAIL_PARSE_INVALID_COMMAND
;

457 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_imap_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

12 
	~<ngx_maž_im­_moduË.h
>

15 *
ngx_maž_im­_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

16 *
ngx_maž_im­_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

17 *
chžd
);

20 
ngx_¡r_t
 
	gngx_maž_im­_deçuÉ_ÿ·bž™›s
[] = {

21 
ngx_¡ršg
("IMAP4"),

22 
ngx_¡ršg
("IMAP4rev1"),

23 
ngx_¡ršg
("UIDPLUS"),

24 
ngx_nuÎ_¡ršg


28 
ngx_cÚf_b™mask_t
 
	gngx_maž_im­_auth_m‘hods
[] = {

29 { 
ngx_¡ršg
("¶aš"), 
NGX_MAIL_AUTH_PLAIN_ENABLED
 },

30 { 
ngx_¡ršg
("logš"), 
NGX_MAIL_AUTH_LOGIN_ENABLED
 },

31 { 
ngx_¡ršg
("üam-md5"), 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
 },

32 { 
ngx_nuÎ_¡ršg
, 0 }

36 
ngx_¡r_t
 
	gngx_maž_im­_auth_m‘hods_Çmes
[] = {

37 
ngx_¡ršg
("AUTH=PLAIN"),

38 
ngx_¡ršg
("AUTH=LOGIN"),

39 
ngx_nuÎ_¡ršg
,

40 
ngx_¡ršg
("AUTH=CRAM-MD5"),

41 
ngx_nuÎ_¡ršg


45 
ngx_maž_´ÙocÞ_t
 
	gngx_maž_im­_´ÙocÞ
 = {

46 
ngx_¡ršg
("imap"),

48 
NGX_MAIL_IMAP_PROTOCOL
,

50 
ngx_maž_im­_š™_£ssiÚ
,

51 
ngx_maž_im­_š™_´ÙocÞ
,

52 
ngx_maž_im­_·r£_commªd
,

53 
ngx_maž_im­_auth_¡©e
,

55 
ngx_¡ršg
("* BAD iÁ”ÇÈ£rv”ƒ¼Ü" 
CRLF
)

59 
ngx_commªd_t
 
	gngx_maž_im­_commªds
[] = {

61 { 
ngx_¡ršg
("imap_client_buffer"),

62 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

63 
ngx_cÚf_£t_size_¦Ù
,

64 
NGX_MAIL_SRV_CONF_OFFSET
,

65 
off£tof
(
ngx_maž_im­_¤v_cÚf_t
, 
þ›Á_bufãr_size
),

66 
NULL
 },

68 { 
ngx_¡ršg
("imap_capabilities"),

69 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

70 
ngx_maž_ÿ·bž™›s
,

71 
NGX_MAIL_SRV_CONF_OFFSET
,

72 
off£tof
(
ngx_maž_im­_¤v_cÚf_t
, 
ÿ·bž™›s
),

73 
NULL
 },

75 { 
ngx_¡ršg
("imap_auth"),

76 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

77 
ngx_cÚf_£t_b™mask_¦Ù
,

78 
NGX_MAIL_SRV_CONF_OFFSET
,

79 
off£tof
(
ngx_maž_im­_¤v_cÚf_t
, 
auth_m‘hods
),

80 &
ngx_maž_im­_auth_m‘hods
 },

82 
ngx_nuÎ_commªd


86 
ngx_maž_moduË_t
 
	gngx_maž_im­_moduË_ùx
 = {

87 &
ngx_maž_im­_´ÙocÞ
,

89 
NULL
,

90 
NULL
,

92 
ngx_maž_im­_ü—‹_¤v_cÚf
,

93 
ngx_maž_im­_m”ge_¤v_cÚf


97 
ngx_moduË_t
 
	gngx_maž_im­_moduË
 = {

98 
NGX_MODULE_V1
,

99 &
ngx_maž_im­_moduË_ùx
,

100 
ngx_maž_im­_commªds
,

101 
NGX_MAIL_MODULE
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NGX_MODULE_V1_PADDING


114 
	$ngx_maž_im­_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

116 
ngx_maž_im­_¤v_cÚf_t
 *
iscf
;

118 
iscf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_im­_¤v_cÚf_t
));

119 ià(
iscf
 =ð
NULL
) {

120  
NULL
;

123 
iscf
->
þ›Á_bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

125 ià(
	`ngx_¬¿y_š™
(&
iscf
->
ÿ·bž™›s
, 
cf
->
poÞ
, 4, (
ngx_¡r_t
))

126 !ð
NGX_OK
)

128  
NULL
;

131  
iscf
;

132 
	}
}

136 
	$ngx_maž_im­_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

138 
ngx_maž_im­_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

139 
ngx_maž_im­_¤v_cÚf_t
 *
cÚf
 = 
chžd
;

141 
u_ch¬
 *
p
, *
auth
;

142 
size_t
 
size
;

143 
ngx_¡r_t
 *
c
, *
d
;

144 
ngx_ušt_t
 
i
, 
m
;

146 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
þ›Á_bufãr_size
,

147 
´ev
->
þ›Á_bufãr_size
,

148 (
size_t
è
ngx_·gesize
);

150 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
auth_m‘hods
,

151 
´ev
->
auth_m‘hods
,

152 (
NGX_CONF_BITMASK_SET


153 |
NGX_MAIL_AUTH_PLAIN_ENABLED
));

156 ià(
cÚf
->
ÿ·bž™›s
.
ÃÉs
 == 0) {

157 
cÚf
->
ÿ·bž™›s
 = 
´ev
->capabilities;

160 ià(
cÚf
->
ÿ·bž™›s
.
ÃÉs
 == 0) {

162 
d
 = 
ngx_maž_im­_deçuÉ_ÿ·bž™›s
; d->
Ën
; d++) {

163 
c
 = 
	`ngx_¬¿y_push
(&
cÚf
->
ÿ·bž™›s
);

164 ià(
c
 =ð
NULL
) {

165  
NGX_CONF_ERROR
;

168 *
c
 = *
d
;

172 
size
 = ("* CAPABILITY" 
CRLF
) - 1;

174 
c
 = 
cÚf
->
ÿ·bž™›s
.
–ts
;

175 
i
 = 0; i < 
cÚf
->
ÿ·bž™›s
.
ÃÉs
; i++) {

176 
size
 +ð1 + 
c
[
i
].
Ën
;

179 
m
 = 
NGX_MAIL_AUTH_PLAIN_ENABLED
, 
i
 = 0;

180 
m
 <ð
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
;

181 
m
 <<ð1, 
i
++)

183 ià(
m
 & 
cÚf
->
auth_m‘hods
) {

184 
size
 +ð1 + 
ngx_maž_im­_auth_m‘hods_Çmes
[
i
].
Ën
;

188 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

189 ià(
p
 =ð
NULL
) {

190  
NGX_CONF_ERROR
;

193 
cÚf
->
ÿ·bž™y
.
Ën
 = 
size
;

194 
cÚf
->
ÿ·bž™y
.
d©a
 = 
p
;

196 
p
 = 
	`ngx_ýymem
(p, "* CAPABILITY", ("* CAPABILITY") - 1);

198 
i
 = 0; i < 
cÚf
->
ÿ·bž™›s
.
ÃÉs
; i++) {

199 *
p
++ = ' ';

200 
p
 = 
	`ngx_ýymem
Õ, 
c
[
i
].
d©a
, c[i].
Ën
);

203 
auth
 = 
p
;

205 
m
 = 
NGX_MAIL_AUTH_PLAIN_ENABLED
, 
i
 = 0;

206 
m
 <ð
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
;

207 
m
 <<ð1, 
i
++)

209 ià(
m
 & 
cÚf
->
auth_m‘hods
) {

210 *
p
++ = ' ';

211 
p
 = 
	`ngx_ýymem
Õ, 
ngx_maž_im­_auth_m‘hods_Çmes
[
i
].
d©a
,

212 
ngx_maž_im­_auth_m‘hods_Çmes
[
i
].
Ën
);

216 *
p
++ = 
CR
; *°ð
LF
;

219 
size
 += (" STARTTLS") - 1;

221 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

222 ià(
p
 =ð
NULL
) {

223  
NGX_CONF_ERROR
;

226 
cÚf
->
¡¬‰ls_ÿ·bž™y
.
Ën
 = 
size
;

227 
cÚf
->
¡¬‰ls_ÿ·bž™y
.
d©a
 = 
p
;

229 
p
 = 
	`ngx_ýymem
Õ, 
cÚf
->
ÿ·bž™y
.
d©a
,

230 
cÚf
->
ÿ·bž™y
.
Ën
 - ((
CRLF
) - 1));

231 
p
 = 
	`ngx_ýymem
(p, " STARTTLS", (" STARTTLS") - 1);

232 *
p
++ = 
CR
; *°ð
LF
;

235 
size
 = (
auth
 - 
cÚf
->
ÿ·bž™y
.
d©a
è+ (
CRLF
) - 1

238 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

239 ià(
p
 =ð
NULL
) {

240  
NGX_CONF_ERROR
;

243 
cÚf
->
¡¬‰ls_Úly_ÿ·bž™y
.
Ën
 = 
size
;

244 
cÚf
->
¡¬‰ls_Úly_ÿ·bž™y
.
d©a
 = 
p
;

246 
p
 = 
	`ngx_ýymem
Õ, 
cÚf
->
ÿ·bž™y
.
d©a
,

247 
auth
 - 
cÚf
->
ÿ·bž™y
.
d©a
);

248 
p
 = 
	`ngx_ýymem
(p, " STARTTLS LOGINDISABLED",

250 *
p
++ = 
CR
; *°ð
LF
;

252  
NGX_CONF_OK
;

253 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_parse.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

12 
	~<ngx_maž_pÝ3_moduË.h
>

13 
	~<ngx_maž_im­_moduË.h
>

14 
	~<ngx_maž_sm_moduË.h
>

17 
ngx_št_t


18 
	$ngx_maž_pÝ3_·r£_commªd
(
ngx_maž_£ssiÚ_t
 *
s
)

20 
u_ch¬
 
ch
, *
p
, *
c
, 
c0
, 
c1
, 
c2
, 
c3
;

21 
ngx_¡r_t
 *
¬g
;

23 
sw_¡¬t
 = 0,

24 
sw_¥aûs_befÜe_¬gum’t
,

25 
sw_¬gum’t
,

26 
sw_®mo¡_dÚe


27 } 
¡©e
;

29 
¡©e
 = 
s
->state;

31 
p
 = 
s
->
bufãr
->
pos
;… < s->bufãr->
Ï¡
;…++) {

32 
ch
 = *
p
;

34 
¡©e
) {

37 
sw_¡¬t
:

38 ià(
ch
 =ð' ' || ch =ð
CR
 || ch =ð
LF
) {

39 
c
 = 
s
->
bufãr
->
¡¬t
;

41 ià(
p
 - 
c
 == 4) {

43 
c0
 = 
	`ngx_touµ”
(
c
[0]);

44 
c1
 = 
	`ngx_touµ”
(
c
[1]);

45 
c2
 = 
	`ngx_touµ”
(
c
[2]);

46 
c3
 = 
	`ngx_touµ”
(
c
[3]);

48 ià(
c0
 =ð'U' && 
c1
 =ð'S' && 
c2
 =ð'E' && 
c3
 == 'R')

50 
s
->
commªd
 = 
NGX_POP3_USER
;

52 } ià(
c0
 =ð'P' && 
c1
 =ð'A' && 
c2
 =ð'S' && 
c3
 == 'S')

54 
s
->
commªd
 = 
NGX_POP3_PASS
;

56 } ià(
c0
 =ð'A' && 
c1
 =ð'P' && 
c2
 =ð'O' && 
c3
 == 'P')

58 
s
->
commªd
 = 
NGX_POP3_APOP
;

60 } ià(
c0
 =ð'Q' && 
c1
 =ð'U' && 
c2
 =ð'I' && 
c3
 == 'T')

62 
s
->
commªd
 = 
NGX_POP3_QUIT
;

64 } ià(
c0
 =ð'C' && 
c1
 =ð'A' && 
c2
 =ð'P' && 
c3
 == 'A')

66 
s
->
commªd
 = 
NGX_POP3_CAPA
;

68 } ià(
c0
 =ð'A' && 
c1
 =ð'U' && 
c2
 =ð'T' && 
c3
 == 'H')

70 
s
->
commªd
 = 
NGX_POP3_AUTH
;

72 } ià(
c0
 =ð'N' && 
c1
 =ð'O' && 
c2
 =ð'O' && 
c3
 == 'P')

74 
s
->
commªd
 = 
NGX_POP3_NOOP
;

75 #ià(
NGX_MAIL_SSL
)

76 } ià(
c0
 =ð'S' && 
c1
 =ð'T' && 
c2
 =ð'L' && 
c3
 == 'S')

78 
s
->
commªd
 = 
NGX_POP3_STLS
;

81 
šv®id
;

85 
šv®id
;

88 
ch
) {

90 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

92 
CR
:

93 
¡©e
 = 
sw_®mo¡_dÚe
;

95 
LF
:

96 
dÚe
;

101 ià((
ch
 < 'A' || ch > 'Z') && (ch < 'a' || ch > 'z')) {

102 
šv®id
;

107 
sw_¥aûs_befÜe_¬gum’t
:

108 
ch
) {

111 
CR
:

112 
¡©e
 = 
sw_®mo¡_dÚe
;

113 
s
->
¬g_’d
 = 
p
;

115 
LF
:

116 
s
->
¬g_’d
 = 
p
;

117 
dÚe
;

119 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

120 
¡©e
 = 
sw_¬gum’t
;

121 
s
->
¬g_¡¬t
 = 
p
;

124 
šv®id
;

128 
sw_¬gum’t
:

129 
ch
) {

138 ià(
s
->
commªd
 =ð
NGX_POP3_USER


139 || 
s
->
commªd
 =ð
NGX_POP3_PASS
)

146 
CR
:

147 
LF
:

148 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

149 ià(
¬g
 =ð
NULL
) {

150  
NGX_ERROR
;

152 
¬g
->
Ën
 = 
p
 - 
s
->
¬g_¡¬t
;

153 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

154 
s
->
¬g_¡¬t
 = 
NULL
;

156 
ch
) {

158 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

160 
CR
:

161 
¡©e
 = 
sw_®mo¡_dÚe
;

163 
LF
:

164 
dÚe
;

173 
sw_®mo¡_dÚe
:

174 
ch
) {

175 
LF
:

176 
dÚe
;

178 
šv®id
;

183 
s
->
bufãr
->
pos
 = 
p
;

184 
s
->
¡©e
 = state;

186  
NGX_AGAIN
;

188 
dÚe
:

190 
s
->
bufãr
->
pos
 = 
p
 + 1;

192 ià(
s
->
¬g_¡¬t
) {

193 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

194 ià(
¬g
 =ð
NULL
) {

195  
NGX_ERROR
;

197 
¬g
->
Ën
 = 
s
->
¬g_’d
 - s->
¬g_¡¬t
;

198 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

199 
s
->
¬g_¡¬t
 = 
NULL
;

202 
s
->
¡©e
 = (s->
commªd
 !ð
NGX_POP3_AUTH
è? 
sw_¡¬t
 : 
sw_¬gum’t
;

204  
NGX_OK
;

206 
šv®id
:

208 
s
->
¡©e
 = 
sw_¡¬t
;

209 
s
->
¬g_¡¬t
 = 
NULL
;

211  
NGX_MAIL_PARSE_INVALID_COMMAND
;

212 
	}
}

215 
ngx_št_t


216 
	$ngx_maž_im­_·r£_commªd
(
ngx_maž_£ssiÚ_t
 *
s
)

218 
u_ch¬
 
ch
, *
p
, *
c
;

219 
ngx_¡r_t
 *
¬g
;

221 
sw_¡¬t
 = 0,

222 
sw_¥aûs_befÜe_commªd
,

223 
sw_commªd
,

224 
sw_¥aûs_befÜe_¬gum’t
,

225 
sw_¬gum’t
,

226 
sw_back¦ash
,

227 
sw_l™”®
,

228 
sw_no_sync_l™”®_¬gum’t
,

229 
sw_¡¬t_l™”®_¬gum’t
,

230 
sw_l™”®_¬gum’t
,

231 
sw_’d_l™”®_¬gum’t
,

232 
sw_®mo¡_dÚe


233 } 
¡©e
;

235 
¡©e
 = 
s
->state;

237 
p
 = 
s
->
bufãr
->
pos
;… < s->bufãr->
Ï¡
;…++) {

238 
ch
 = *
p
;

240 
¡©e
) {

243 
sw_¡¬t
:

244 
ch
) {

246 
s
->
g
.
Ën
 = 
p
 - s->
bufãr
->
¡¬t
 + 1;

247 
s
->
g
.
d©a
 = s->
bufãr
->
¡¬t
;

248 
¡©e
 = 
sw_¥aûs_befÜe_commªd
;

250 
CR
:

251 
s
->
¡©e
 = 
sw_¡¬t
;

252  
NGX_MAIL_PARSE_INVALID_COMMAND
;

253 
LF
:

254 
s
->
¡©e
 = 
sw_¡¬t
;

255  
NGX_MAIL_PARSE_INVALID_COMMAND
;

259 
sw_¥aûs_befÜe_commªd
:

260 
ch
) {

263 
CR
:

264 
s
->
¡©e
 = 
sw_¡¬t
;

265  
NGX_MAIL_PARSE_INVALID_COMMAND
;

266 
LF
:

267 
s
->
¡©e
 = 
sw_¡¬t
;

268  
NGX_MAIL_PARSE_INVALID_COMMAND
;

270 
s
->
cmd_¡¬t
 = 
p
;

271 
¡©e
 = 
sw_commªd
;

276 
sw_commªd
:

277 ià(
ch
 =ð' ' || ch =ð
CR
 || ch =ð
LF
) {

279 
c
 = 
s
->
cmd_¡¬t
;

281 
p
 - 
c
) {

284 ià((
c
[0] == 'N' || c[0] == 'n')

285 && (
c
[1] == 'O'|| c[1] == 'o')

286 && (
c
[2] == 'O'|| c[2] == 'o')

287 && (
c
[3] == 'P'|| c[3] == 'p'))

289 
s
->
commªd
 = 
NGX_IMAP_NOOP
;

292 
šv®id
;

297 ià((
c
[0] == 'L'|| c[0] == 'l')

298 && (
c
[1] == 'O'|| c[1] == 'o')

299 && (
c
[2] == 'G'|| c[2] == 'g')

300 && (
c
[3] == 'I'|| c[3] == 'i')

301 && (
c
[4] == 'N'|| c[4] == 'n'))

303 
s
->
commªd
 = 
NGX_IMAP_LOGIN
;

306 
šv®id
;

311 ià((
c
[0] == 'L'|| c[0] == 'l')

312 && (
c
[1] == 'O'|| c[1] == 'o')

313 && (
c
[2] == 'G'|| c[2] == 'g')

314 && (
c
[3] == 'O'|| c[3] == 'o')

315 && (
c
[4] == 'U'|| c[4] == 'u')

316 && (
c
[5] == 'T'|| c[5] == 't'))

318 
s
->
commªd
 = 
NGX_IMAP_LOGOUT
;

321 
šv®id
;

325 #ià(
NGX_MAIL_SSL
)

327 ià((
c
[0] == 'S'|| c[0] == 's')

328 && (
c
[1] == 'T'|| c[1] == 't')

329 && (
c
[2] == 'A'|| c[2] == 'a')

330 && (
c
[3] == 'R'|| c[3] == 'r')

331 && (
c
[4] == 'T'|| c[4] == 't')

332 && (
c
[5] == 'T'|| c[5] == 't')

333 && (
c
[6] == 'L'|| c[6] == 'l')

334 && (
c
[7] == 'S'|| c[7] == 's'))

336 
s
->
commªd
 = 
NGX_IMAP_STARTTLS
;

339 
šv®id
;

345 ià((
c
[0] == 'C'|| c[0] == 'c')

346 && (
c
[1] == 'A'|| c[1] == 'a')

347 && (
c
[2] == 'P'|| c[2] == 'p')

348 && (
c
[3] == 'A'|| c[3] == 'a')

349 && (
c
[4] == 'B'|| c[4] == 'b')

350 && (
c
[5] == 'I'|| c[5] == 'i')

351 && (
c
[6] == 'L'|| c[6] == 'l')

352 && (
c
[7] == 'I'|| c[7] == 'i')

353 && (
c
[8] == 'T'|| c[8] == 't')

354 && (
c
[9] == 'Y'|| c[9] == 'y'))

356 
s
->
commªd
 = 
NGX_IMAP_CAPABILITY
;

359 
šv®id
;

364 ià((
c
[0] == 'A'|| c[0] == 'a')

365 && (
c
[1] == 'U'|| c[1] == 'u')

366 && (
c
[2] == 'T'|| c[2] == 't')

367 && (
c
[3] == 'H'|| c[3] == 'h')

368 && (
c
[4] == 'E'|| c[4] == 'e')

369 && (
c
[5] == 'N'|| c[5] == 'n')

370 && (
c
[6] == 'T'|| c[6] == 't')

371 && (
c
[7] == 'I'|| c[7] == 'i')

372 && (
c
[8] == 'C'|| c[8] == 'c')

373 && (
c
[9] == 'A'|| c[9] == 'a')

374 && (
c
[10] == 'T'|| c[10] == 't')

375 && (
c
[11] == 'E'|| c[11] == 'e'))

377 
s
->
commªd
 = 
NGX_IMAP_AUTHENTICATE
;

380 
šv®id
;

385 
šv®id
;

388 
ch
) {

390 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

392 
CR
:

393 
¡©e
 = 
sw_®mo¡_dÚe
;

395 
LF
:

396 
dÚe
;

401 ià((
ch
 < 'A' || ch > 'Z') && (ch < 'a' || ch > 'z')) {

402 
šv®id
;

407 
sw_¥aûs_befÜe_¬gum’t
:

408 
ch
) {

411 
CR
:

412 
¡©e
 = 
sw_®mo¡_dÚe
;

413 
s
->
¬g_’d
 = 
p
;

415 
LF
:

416 
s
->
¬g_’d
 = 
p
;

417 
dÚe
;

419 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

420 
s
->
quÙed
 = 1;

421 
s
->
¬g_¡¬t
 = 
p
 + 1;

422 
¡©e
 = 
sw_¬gum’t
;

425 
šv®id
;

427 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

428 
¡©e
 = 
sw_l™”®
;

431 
šv®id
;

433 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

434 
s
->
¬g_¡¬t
 = 
p
;

435 
¡©e
 = 
sw_¬gum’t
;

438 
šv®id
;

442 
sw_¬gum’t
:

443 ià(
ch
 =ð' ' && 
s
->
quÙed
) {

447 
ch
) {

449 ià(!
s
->
quÙed
) {

452 
s
->
quÙed
 = 0;

455 
CR
:

456 
LF
:

457 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

458 ià(
¬g
 =ð
NULL
) {

459  
NGX_ERROR
;

461 
¬g
->
Ën
 = 
p
 - 
s
->
¬g_¡¬t
;

462 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

463 
s
->
¬g_¡¬t
 = 
NULL
;

465 
ch
) {

468 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

470 
CR
:

471 
¡©e
 = 
sw_®mo¡_dÚe
;

473 
LF
:

474 
dÚe
;

478 ià(
s
->
quÙed
) {

479 
s
->
back¦ash
 = 1;

480 
¡©e
 = 
sw_back¦ash
;

486 
sw_back¦ash
:

487 
ch
) {

488 
CR
:

489 
LF
:

490 
šv®id
;

492 
¡©e
 = 
sw_¬gum’t
;

496 
sw_l™”®
:

497 ià(
ch
 >= '0' && ch <= '9') {

498 
s
->
l™”®_Ën
 = s->l™”®_ËÀ* 10 + (
ch
 - '0');

501 ià(
ch
 == '}') {

502 
¡©e
 = 
sw_¡¬t_l™”®_¬gum’t
;

505 ià(
ch
 == '+') {

506 
¡©e
 = 
sw_no_sync_l™”®_¬gum’t
;

509 
šv®id
;

511 
sw_no_sync_l™”®_¬gum’t
:

512 ià(
ch
 == '}') {

513 
s
->
no_sync_l™”®
 = 1;

514 
¡©e
 = 
sw_¡¬t_l™”®_¬gum’t
;

517 
šv®id
;

519 
sw_¡¬t_l™”®_¬gum’t
:

520 
ch
) {

521 
CR
:

523 
LF
:

524 
s
->
bufãr
->
pos
 = 
p
 + 1;

525 
s
->
¬g_¡¬t
 = 
p
 + 1;

526 ià(
s
->
no_sync_l™”®
 == 0) {

527 
s
->
¡©e
 = 
sw_l™”®_¬gum’t
;

528  
NGX_IMAP_NEXT
;

530 
¡©e
 = 
sw_l™”®_¬gum’t
;

531 
s
->
no_sync_l™”®
 = 0;

534 
šv®id
;

538 
sw_l™”®_¬gum’t
:

539 ià(
s
->
l™”®_Ën
 && --s->literal_len) {

543 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

544 ià(
¬g
 =ð
NULL
) {

545  
NGX_ERROR
;

547 
¬g
->
Ën
 = 
p
 + 1 - 
s
->
¬g_¡¬t
;

548 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

549 
s
->
¬g_¡¬t
 = 
NULL
;

550 
¡©e
 = 
sw_’d_l™”®_¬gum’t
;

554 
sw_’d_l™”®_¬gum’t
:

555 
ch
) {

557 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

558 
¡©e
 = 
sw_l™”®
;

561 
šv®id
;

562 
CR
:

563 
¡©e
 = 
sw_®mo¡_dÚe
;

565 
LF
:

566 
dÚe
;

568 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

573 
sw_®mo¡_dÚe
:

574 
ch
) {

575 
LF
:

576 
dÚe
;

578 
šv®id
;

583 
s
->
bufãr
->
pos
 = 
p
;

584 
s
->
¡©e
 = state;

586  
NGX_AGAIN
;

588 
dÚe
:

590 
s
->
bufãr
->
pos
 = 
p
 + 1;

592 ià(
s
->
¬g_¡¬t
) {

593 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

594 ià(
¬g
 =ð
NULL
) {

595  
NGX_ERROR
;

597 
¬g
->
Ën
 = 
s
->
¬g_’d
 - s->
¬g_¡¬t
;

598 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

600 
s
->
¬g_¡¬t
 = 
NULL
;

601 
s
->
cmd_¡¬t
 = 
NULL
;

602 
s
->
quÙed
 = 0;

603 
s
->
no_sync_l™”®
 = 0;

604 
s
->
l™”®_Ën
 = 0;

607 
s
->
¡©e
 = (s->
commªd
 !ð
NGX_IMAP_AUTHENTICATE
è? 
sw_¡¬t
 : 
sw_¬gum’t
;

609  
NGX_OK
;

611 
šv®id
:

613 
s
->
¡©e
 = 
sw_¡¬t
;

614 
s
->
quÙed
 = 0;

615 
s
->
no_sync_l™”®
 = 0;

616 
s
->
l™”®_Ën
 = 0;

618  
NGX_MAIL_PARSE_INVALID_COMMAND
;

619 
	}
}

622 
ngx_št_t


623 
	$ngx_maž_sm_·r£_commªd
(
ngx_maž_£ssiÚ_t
 *
s
)

625 
u_ch¬
 
ch
, *
p
, *
c
, 
c0
, 
c1
, 
c2
, 
c3
;

626 
ngx_¡r_t
 *
¬g
;

628 
sw_¡¬t
 = 0,

629 
sw_commªd
,

630 
sw_šv®id
,

631 
sw_¥aûs_befÜe_¬gum’t
,

632 
sw_¬gum’t
,

633 
sw_®mo¡_dÚe


634 } 
¡©e
;

636 
¡©e
 = 
s
->state;

638 
p
 = 
s
->
bufãr
->
pos
;… < s->bufãr->
Ï¡
;…++) {

639 
ch
 = *
p
;

641 
¡©e
) {

644 
sw_¡¬t
:

645 
s
->
cmd_¡¬t
 = 
p
;

646 
¡©e
 = 
sw_commªd
;

650 
sw_commªd
:

651 ià(
ch
 =ð' ' || ch =ð
CR
 || ch =ð
LF
) {

652 
c
 = 
s
->
cmd_¡¬t
;

654 ià(
p
 - 
c
 == 4) {

656 
c0
 = 
	`ngx_touµ”
(
c
[0]);

657 
c1
 = 
	`ngx_touµ”
(
c
[1]);

658 
c2
 = 
	`ngx_touµ”
(
c
[2]);

659 
c3
 = 
	`ngx_touµ”
(
c
[3]);

661 ià(
c0
 =ð'H' && 
c1
 =ð'E' && 
c2
 =ð'L' && 
c3
 == 'O')

663 
s
->
commªd
 = 
NGX_SMTP_HELO
;

665 } ià(
c0
 =ð'E' && 
c1
 =ð'H' && 
c2
 =ð'L' && 
c3
 == 'O')

667 
s
->
commªd
 = 
NGX_SMTP_EHLO
;

669 } ià(
c0
 =ð'Q' && 
c1
 =ð'U' && 
c2
 =ð'I' && 
c3
 == 'T')

671 
s
->
commªd
 = 
NGX_SMTP_QUIT
;

673 } ià(
c0
 =ð'A' && 
c1
 =ð'U' && 
c2
 =ð'T' && 
c3
 == 'H')

675 
s
->
commªd
 = 
NGX_SMTP_AUTH
;

677 } ià(
c0
 =ð'N' && 
c1
 =ð'O' && 
c2
 =ð'O' && 
c3
 == 'P')

679 
s
->
commªd
 = 
NGX_SMTP_NOOP
;

681 } ià(
c0
 =ð'M' && 
c1
 =ð'A' && 
c2
 =ð'I' && 
c3
 == 'L')

683 
s
->
commªd
 = 
NGX_SMTP_MAIL
;

685 } ià(
c0
 =ð'R' && 
c1
 =ð'S' && 
c2
 =ð'E' && 
c3
 == 'T')

687 
s
->
commªd
 = 
NGX_SMTP_RSET
;

689 } ià(
c0
 =ð'R' && 
c1
 =ð'C' && 
c2
 =ð'P' && 
c3
 == 'T')

691 
s
->
commªd
 = 
NGX_SMTP_RCPT
;

693 } ià(
c0
 =ð'V' && 
c1
 =ð'R' && 
c2
 =ð'F' && 
c3
 == 'Y')

695 
s
->
commªd
 = 
NGX_SMTP_VRFY
;

697 } ià(
c0
 =ð'E' && 
c1
 =ð'X' && 
c2
 =ð'P' && 
c3
 == 'N')

699 
s
->
commªd
 = 
NGX_SMTP_EXPN
;

701 } ià(
c0
 =ð'H' && 
c1
 =ð'E' && 
c2
 =ð'L' && 
c3
 == 'P')

703 
s
->
commªd
 = 
NGX_SMTP_HELP
;

706 
šv®id
;

708 #ià(
NGX_MAIL_SSL
)

709 } ià(
p
 - 
c
 == 8) {

711 ià((
c
[0] == 'S'|| c[0] == 's')

712 && (
c
[1] == 'T'|| c[1] == 't')

713 && (
c
[2] == 'A'|| c[2] == 'a')

714 && (
c
[3] == 'R'|| c[3] == 'r')

715 && (
c
[4] == 'T'|| c[4] == 't')

716 && (
c
[5] == 'T'|| c[5] == 't')

717 && (
c
[6] == 'L'|| c[6] == 'l')

718 && (
c
[7] == 'S'|| c[7] == 's'))

720 
s
->
commªd
 = 
NGX_SMTP_STARTTLS
;

723 
šv®id
;

727 
šv®id
;

730 
s
->
cmd
.
d©a
 = s->
cmd_¡¬t
;

731 
s
->
cmd
.
Ën
 = 
p
 - s->
cmd_¡¬t
;

733 
ch
) {

735 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

737 
CR
:

738 
¡©e
 = 
sw_®mo¡_dÚe
;

740 
LF
:

741 
dÚe
;

746 ià((
ch
 < 'A' || ch > 'Z') && (ch < 'a' || ch > 'z')) {

747 
šv®id
;

752 
sw_šv®id
:

753 
šv®id
;

755 
sw_¥aûs_befÜe_¬gum’t
:

756 
ch
) {

759 
CR
:

760 
¡©e
 = 
sw_®mo¡_dÚe
;

761 
s
->
¬g_’d
 = 
p
;

763 
LF
:

764 
s
->
¬g_’d
 = 
p
;

765 
dÚe
;

767 ià(
s
->
¬gs
.
ÃÉs
 <= 10) {

768 
¡©e
 = 
sw_¬gum’t
;

769 
s
->
¬g_¡¬t
 = 
p
;

772 
šv®id
;

776 
sw_¬gum’t
:

777 
ch
) {

779 
CR
:

780 
LF
:

781 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

782 ià(
¬g
 =ð
NULL
) {

783  
NGX_ERROR
;

785 
¬g
->
Ën
 = 
p
 - 
s
->
¬g_¡¬t
;

786 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

787 
s
->
¬g_¡¬t
 = 
NULL
;

789 
ch
) {

791 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

793 
CR
:

794 
¡©e
 = 
sw_®mo¡_dÚe
;

796 
LF
:

797 
dÚe
;

806 
sw_®mo¡_dÚe
:

807 
ch
) {

808 
LF
:

809 
dÚe
;

811 
šv®id
;

816 
s
->
bufãr
->
pos
 = 
p
;

817 
s
->
¡©e
 = state;

819  
NGX_AGAIN
;

821 
dÚe
:

823 
s
->
bufãr
->
pos
 = 
p
 + 1;

825 ià(
s
->
¬g_¡¬t
) {

826 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

827 ià(
¬g
 =ð
NULL
) {

828  
NGX_ERROR
;

830 
¬g
->
Ën
 = 
s
->
¬g_’d
 - s->
¬g_¡¬t
;

831 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

832 
s
->
¬g_¡¬t
 = 
NULL
;

835 
s
->
¡©e
 = (s->
commªd
 !ð
NGX_SMTP_AUTH
è? 
sw_¡¬t
 : 
sw_¬gum’t
;

837  
NGX_OK
;

839 
šv®id
:

841 
s
->
¡©e
 = 
sw_šv®id
;

842 
s
->
¬g_¡¬t
 = 
NULL
;

846 
p
 = 
s
->
bufãr
->
pos
;… < s->bufãr->
Ï¡
;…++) {

847 ià(*
p
 =ð
LF
) {

848 
s
->
¡©e
 = 
sw_¡¬t
;

849 
p
++;

854 
s
->
bufãr
->
pos
 = 
p
;

856  
NGX_MAIL_PARSE_INVALID_COMMAND
;

857 
	}
}

860 
ngx_št_t


861 
	$ngx_maž_auth_·r£
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

863 
ngx_¡r_t
 *
¬g
;

865 #ià(
NGX_MAIL_SSL
)

866 ià(
	`ngx_maž_¡¬‰ls_Úly
(
s
, 
c
)) {

867  
NGX_MAIL_PARSE_INVALID_COMMAND
;

871 ià(
s
->
¬gs
.
ÃÉs
 == 0) {

872  
NGX_MAIL_PARSE_INVALID_COMMAND
;

875 
¬g
 = 
s
->
¬gs
.
–ts
;

877 ià(
¬g
[0].
Ën
 == 5) {

879 ià(
	`ngx_¡ºÿ£cmp
(
¬g
[0].
d©a
, (
u_ch¬
 *) "LOGIN", 5) == 0) {

881 ià(
s
->
¬gs
.
ÃÉs
 == 1) {

882  
NGX_MAIL_AUTH_LOGIN
;

885 ià(
s
->
¬gs
.
ÃÉs
 == 2) {

886  
NGX_MAIL_AUTH_LOGIN_USERNAME
;

889  
NGX_MAIL_PARSE_INVALID_COMMAND
;

892 ià(
	`ngx_¡ºÿ£cmp
(
¬g
[0].
d©a
, (
u_ch¬
 *) "PLAIN", 5) == 0) {

894 ià(
s
->
¬gs
.
ÃÉs
 == 1) {

895  
NGX_MAIL_AUTH_PLAIN
;

898 ià(
s
->
¬gs
.
ÃÉs
 == 2) {

899  
	`ngx_maž_auth_¶aš
(
s
, 
c
, 1);

903  
NGX_MAIL_PARSE_INVALID_COMMAND
;

906 ià(
¬g
[0].
Ën
 == 8) {

908 ià(
s
->
¬gs
.
ÃÉs
 != 1) {

909  
NGX_MAIL_PARSE_INVALID_COMMAND
;

912 ià(
	`ngx_¡ºÿ£cmp
(
¬g
[0].
d©a
, (
u_ch¬
 *) "CRAM-MD5", 8) == 0) {

913  
NGX_MAIL_AUTH_CRAM_MD5
;

917  
NGX_MAIL_PARSE_INVALID_COMMAND
;

918 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_pop3_handler.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

12 
	~<ngx_maž_pÝ3_moduË.h
>

15 
ngx_št_t
 
ngx_maž_pÝ3_u£r
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

16 
ngx_št_t
 
ngx_maž_pÝ3_·ss
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

17 
ngx_št_t
 
ngx_maž_pÝ3_ÿ·
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

18 
ngx_št_t
 
¡ls
);

19 
ngx_št_t
 
ngx_maž_pÝ3_¡ls
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

20 
ngx_št_t
 
ngx_maž_pÝ3_­Ý
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

21 
ngx_št_t
 
ngx_maž_pÝ3_auth
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

24 
u_ch¬
 
	gpÝ3_g»‘šg
[] = "+OK POP3„—dy" 
CRLF
;

25 
u_ch¬
 
	gpÝ3_ok
[] = "+OK" 
CRLF
;

26 
u_ch¬
 
	gpÝ3_Ãxt
[] = "+ " 
CRLF
;

27 
u_ch¬
 
	gpÝ3_u£ºame
[] = "+ VXNlcm5hbWU6" 
CRLF
;

28 
u_ch¬
 
	gpÝ3_·sswÜd
[] = "+ UGFzc3dvcmQ6" 
CRLF
;

29 
u_ch¬
 
	gpÝ3_šv®id_commªd
[] = "-ERR inv®id commªd" 
CRLF
;

33 
	$ngx_maž_pÝ3_š™_£ssiÚ
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

35 
u_ch¬
 *
p
;

36 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

37 
ngx_maž_pÝ3_¤v_cÚf_t
 *
pscf
;

39 
pscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_pÝ3_moduË
);

40 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

42 ià(
pscf
->
auth_m‘hods


43 & (
NGX_MAIL_AUTH_APOP_ENABLED
|
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
))

45 ià(
	`ngx_maž_§É
(
s
, 
c
, 
cscf
è!ð
NGX_OK
) {

46 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

50 
s
->
out
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, (
pÝ3_g»‘šg
è+ s->
§É
.
Ën
);

51 ià(
s
->
out
.
d©a
 =ð
NULL
) {

52 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

56 
p
 = 
	`ngx_ýymem
(
s
->
out
.
d©a
, 
pÝ3_g»‘šg
, (pop3_greeting) - 3);

57 *
p
++ = ' ';

58 
p
 = 
	`ngx_ýymem
Õ, 
s
->
§É
.
d©a
, s->§É.
Ën
);

60 
s
->
out
.
Ën
 = 
p
 - s->out.
d©a
;

63 
	`ngx_¡r_£t
(&
s
->
out
, 
pÝ3_g»‘šg
);

66 
c
->
»ad
->
hªdËr
 = 
ngx_maž_pÝ3_š™_´ÙocÞ
;

68 
	`ngx_add_tim”
(
c
->
»ad
, 
cscf
->
timeout
);

70 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

71 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

74 
	`ngx_maž_£nd
(
c
->
wr™e
);

75 
	}
}

79 
	$ngx_maž_pÝ3_š™_´ÙocÞ
(
ngx_ev’t_t
 *
»v
)

81 
ngx_cÚÃùiÚ_t
 *
c
;

82 
ngx_maž_£ssiÚ_t
 *
s
;

84 
c
 = 
»v
->
d©a
;

86 
c
->
log
->
aùiÚ
 = "in‡uth state";

88 ià(
»v
->
timedout
) {

89 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

90 
c
->
timedout
 = 1;

91 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

95 
s
 = 
c
->
d©a
;

97 ià(
s
->
bufãr
 =ð
NULL
) {

98 ià(
	`ngx_¬¿y_š™
(&
s
->
¬gs
, 
c
->
poÞ
, 2, (
ngx_¡r_t
))

99 =ð
NGX_ERROR
)

101 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

105 
s
->
bufãr
 = 
	`ngx_ü—‹_‹mp_buf
(
c
->
poÞ
, 128);

106 ià(
s
->
bufãr
 =ð
NULL
) {

107 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

112 
s
->
maž_¡©e
 = 
ngx_pÝ3_¡¬t
;

113 
c
->
»ad
->
hªdËr
 = 
ngx_maž_pÝ3_auth_¡©e
;

115 
	`ngx_maž_pÝ3_auth_¡©e
(
»v
);

116 
	}
}

120 
	$ngx_maž_pÝ3_auth_¡©e
(
ngx_ev’t_t
 *
»v
)

122 
ngx_št_t
 
rc
;

123 
ngx_cÚÃùiÚ_t
 *
c
;

124 
ngx_maž_£ssiÚ_t
 *
s
;

126 
c
 = 
»v
->
d©a
;

127 
s
 = 
c
->
d©a
;

129 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "pop3‡uth state");

131 ià(
»v
->
timedout
) {

132 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

133 
c
->
timedout
 = 1;

134 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

138 ià(
s
->
out
.
Ën
) {

139 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "pop3 send handler busy");

140 
s
->
blocked
 = 1;

144 
s
->
blocked
 = 0;

146 
rc
 = 
	`ngx_maž_»ad_commªd
(
s
, 
c
);

148 ià(
rc
 =ð
NGX_AGAIN
 ||„ø=ð
NGX_ERROR
) {

152 
	`ngx_¡r_£t
(&
s
->
out
, 
pÝ3_ok
);

154 ià(
rc
 =ð
NGX_OK
) {

155 
s
->
maž_¡©e
) {

157 
ngx_pÝ3_¡¬t
:

159 
s
->
commªd
) {

161 
NGX_POP3_USER
:

162 
rc
 = 
	`ngx_maž_pÝ3_u£r
(
s
, 
c
);

165 
NGX_POP3_CAPA
:

166 
rc
 = 
	`ngx_maž_pÝ3_ÿ·
(
s
, 
c
, 1);

169 
NGX_POP3_APOP
:

170 
rc
 = 
	`ngx_maž_pÝ3_­Ý
(
s
, 
c
);

173 
NGX_POP3_AUTH
:

174 
rc
 = 
	`ngx_maž_pÝ3_auth
(
s
, 
c
);

177 
NGX_POP3_QUIT
:

178 
s
->
qu™
 = 1;

181 
NGX_POP3_NOOP
:

184 
NGX_POP3_STLS
:

185 
rc
 = 
	`ngx_maž_pÝ3_¡ls
(
s
, 
c
);

189 
rc
 = 
NGX_MAIL_PARSE_INVALID_COMMAND
;

195 
ngx_pÝ3_u£r
:

197 
s
->
commªd
) {

199 
NGX_POP3_PASS
:

200 
rc
 = 
	`ngx_maž_pÝ3_·ss
(
s
, 
c
);

203 
NGX_POP3_CAPA
:

204 
rc
 = 
	`ngx_maž_pÝ3_ÿ·
(
s
, 
c
, 0);

207 
NGX_POP3_QUIT
:

208 
s
->
qu™
 = 1;

211 
NGX_POP3_NOOP
:

215 
rc
 = 
NGX_MAIL_PARSE_INVALID_COMMAND
;

222 
ngx_pÝ3_·sswd
:

225 
ngx_pÝ3_auth_logš_u£ºame
:

226 
rc
 = 
	`ngx_maž_auth_logš_u£ºame
(
s
, 
c
, 0);

228 
	`ngx_¡r_£t
(&
s
->
out
, 
pÝ3_·sswÜd
);

229 
s
->
maž_¡©e
 = 
ngx_pÝ3_auth_logš_·sswÜd
;

232 
ngx_pÝ3_auth_logš_·sswÜd
:

233 
rc
 = 
	`ngx_maž_auth_logš_·sswÜd
(
s
, 
c
);

236 
ngx_pÝ3_auth_¶aš
:

237 
rc
 = 
	`ngx_maž_auth_¶aš
(
s
, 
c
, 0);

240 
ngx_pÝ3_auth_üam_md5
:

241 
rc
 = 
	`ngx_maž_auth_üam_md5
(
s
, 
c
);

246 
rc
) {

248 
NGX_DONE
:

249 
	`ngx_maž_auth
(
s
, 
c
);

252 
NGX_ERROR
:

253 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

256 
NGX_MAIL_PARSE_INVALID_COMMAND
:

257 
s
->
maž_¡©e
 = 
ngx_pÝ3_¡¬t
;

258 
s
->
¡©e
 = 0;

260 
	`ngx_¡r_£t
(&
s
->
out
, 
pÝ3_šv®id_commªd
);

264 
NGX_OK
:

266 
s
->
¬gs
.
ÃÉs
 = 0;

267 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

268 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

270 ià(
s
->
¡©e
) {

271 
s
->
¬g_¡¬t
 = s->
bufãr
->
¡¬t
;

274 
	`ngx_maž_£nd
(
c
->
wr™e
);

276 
	}
}

278 
ngx_št_t


279 
	$ngx_maž_pÝ3_u£r
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

281 
ngx_¡r_t
 *
¬g
;

283 #ià(
NGX_MAIL_SSL
)

284 ià(
	`ngx_maž_¡¬‰ls_Úly
(
s
, 
c
)) {

285  
NGX_MAIL_PARSE_INVALID_COMMAND
;

289 ià(
s
->
¬gs
.
ÃÉs
 != 1) {

290  
NGX_MAIL_PARSE_INVALID_COMMAND
;

293 
¬g
 = 
s
->
¬gs
.
–ts
;

294 
s
->
logš
.
Ën
 = 
¬g
[0].len;

295 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, s->logš.
Ën
);

296 ià(
s
->
logš
.
d©a
 =ð
NULL
) {

297  
NGX_ERROR
;

300 
	`ngx_memýy
(
s
->
logš
.
d©a
, 
¬g
[0].d©a, s->logš.
Ën
);

302 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

303 "pÝ3†ogš: \"%V\"", &
s
->
logš
);

305 
s
->
maž_¡©e
 = 
ngx_pÝ3_u£r
;

307  
NGX_OK
;

308 
	}
}

311 
ngx_št_t


312 
	$ngx_maž_pÝ3_·ss
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

314 
ngx_¡r_t
 *
¬g
;

316 ià(
s
->
¬gs
.
ÃÉs
 != 1) {

317  
NGX_MAIL_PARSE_INVALID_COMMAND
;

320 
¬g
 = 
s
->
¬gs
.
–ts
;

321 
s
->
·sswd
.
Ën
 = 
¬g
[0].len;

322 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, s->·sswd.
Ën
);

323 ià(
s
->
·sswd
.
d©a
 =ð
NULL
) {

324  
NGX_ERROR
;

327 
	`ngx_memýy
(
s
->
·sswd
.
d©a
, 
¬g
[0].d©a, s->·sswd.
Ën
);

329 #ià(
NGX_DEBUG_MAIL_PASSWD
)

330 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

331 "pÝ3…asswd: \"%V\"", &
s
->
·sswd
);

334  
NGX_DONE
;

335 
	}
}

338 
ngx_št_t


339 
	$ngx_maž_pÝ3_ÿ·
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_št_t
 
¡ls
)

341 
ngx_maž_pÝ3_¤v_cÚf_t
 *
pscf
;

343 
pscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_pÝ3_moduË
);

345 #ià(
NGX_MAIL_SSL
)

347 ià(
¡ls
 && 
c
->
s¦
 =ð
NULL
) {

348 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

350 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

352 ià(
s¦cf
->
¡¬‰ls
 =ð
NGX_MAIL_STARTTLS_ON
) {

353 
s
->
out
 = 
pscf
->
¡¬‰ls_ÿ·bž™y
;

354  
NGX_OK
;

357 ià(
s¦cf
->
¡¬‰ls
 =ð
NGX_MAIL_STARTTLS_ONLY
) {

358 
s
->
out
 = 
pscf
->
¡¬‰ls_Úly_ÿ·bž™y
;

359  
NGX_OK
;

365 
s
->
out
 = 
pscf
->
ÿ·bž™y
;

366  
NGX_OK
;

367 
	}
}

370 
ngx_št_t


371 
	$ngx_maž_pÝ3_¡ls
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

373 #ià(
NGX_MAIL_SSL
)

374 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

376 ià(
c
->
s¦
 =ð
NULL
) {

377 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

378 ià(
s¦cf
->
¡¬‰ls
) {

379 
c
->
»ad
->
hªdËr
 = 
ngx_maž_¡¬‰ls_hªdËr
;

380  
NGX_OK
;

386  
NGX_MAIL_PARSE_INVALID_COMMAND
;

387 
	}
}

390 
ngx_št_t


391 
	$ngx_maž_pÝ3_­Ý
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

393 
ngx_¡r_t
 *
¬g
;

394 
ngx_maž_pÝ3_¤v_cÚf_t
 *
pscf
;

396 #ià(
NGX_MAIL_SSL
)

397 ià(
	`ngx_maž_¡¬‰ls_Úly
(
s
, 
c
)) {

398  
NGX_MAIL_PARSE_INVALID_COMMAND
;

402 ià(
s
->
¬gs
.
ÃÉs
 != 2) {

403  
NGX_MAIL_PARSE_INVALID_COMMAND
;

406 
pscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_pÝ3_moduË
);

408 ià(!(
pscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_APOP_ENABLED
)) {

409  
NGX_MAIL_PARSE_INVALID_COMMAND
;

412 
¬g
 = 
s
->
¬gs
.
–ts
;

414 
s
->
logš
.
Ën
 = 
¬g
[0].len;

415 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, s->logš.
Ën
);

416 ià(
s
->
logš
.
d©a
 =ð
NULL
) {

417  
NGX_ERROR
;

420 
	`ngx_memýy
(
s
->
logš
.
d©a
, 
¬g
[0].d©a, s->logš.
Ën
);

422 
s
->
·sswd
.
Ën
 = 
¬g
[1].len;

423 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, s->·sswd.
Ën
);

424 ià(
s
->
·sswd
.
d©a
 =ð
NULL
) {

425  
NGX_ERROR
;

428 
	`ngx_memýy
(
s
->
·sswd
.
d©a
, 
¬g
[1].d©a, s->·sswd.
Ën
);

430 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

431 "pÝ3‡pÝ: \"%V\" \"%V\"", &
s
->
logš
, &s->
·sswd
);

433 
s
->
auth_m‘hod
 = 
NGX_MAIL_AUTH_APOP
;

435  
NGX_DONE
;

436 
	}
}

439 
ngx_št_t


440 
	$ngx_maž_pÝ3_auth
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

442 
ngx_št_t
 
rc
;

443 
ngx_maž_pÝ3_¤v_cÚf_t
 *
pscf
;

445 #ià(
NGX_MAIL_SSL
)

446 ià(
	`ngx_maž_¡¬‰ls_Úly
(
s
, 
c
)) {

447  
NGX_MAIL_PARSE_INVALID_COMMAND
;

451 
pscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_pÝ3_moduË
);

453 ià(
s
->
¬gs
.
ÃÉs
 == 0) {

454 
s
->
out
 = 
pscf
->
auth_ÿ·bž™y
;

455 
s
->
¡©e
 = 0;

457  
NGX_OK
;

460 
rc
 = 
	`ngx_maž_auth_·r£
(
s
, 
c
);

462 
rc
) {

464 
NGX_MAIL_AUTH_LOGIN
:

466 
	`ngx_¡r_£t
(&
s
->
out
, 
pÝ3_u£ºame
);

467 
s
->
maž_¡©e
 = 
ngx_pÝ3_auth_logš_u£ºame
;

469  
NGX_OK
;

471 
NGX_MAIL_AUTH_LOGIN_USERNAME
:

473 
	`ngx_¡r_£t
(&
s
->
out
, 
pÝ3_·sswÜd
);

474 
s
->
maž_¡©e
 = 
ngx_pÝ3_auth_logš_·sswÜd
;

476  
	`ngx_maž_auth_logš_u£ºame
(
s
, 
c
, 1);

478 
NGX_MAIL_AUTH_PLAIN
:

480 
	`ngx_¡r_£t
(&
s
->
out
, 
pÝ3_Ãxt
);

481 
s
->
maž_¡©e
 = 
ngx_pÝ3_auth_¶aš
;

483  
NGX_OK
;

485 
NGX_MAIL_AUTH_CRAM_MD5
:

487 ià(!(
pscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
)) {

488  
NGX_MAIL_PARSE_INVALID_COMMAND
;

491 ià(
	`ngx_maž_auth_üam_md5_§É
(
s
, 
c
, "+ ", 2è=ð
NGX_OK
) {

492 
s
->
maž_¡©e
 = 
ngx_pÝ3_auth_üam_md5
;

493  
NGX_OK
;

496  
NGX_ERROR
;

499  
rc
;

500 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_pop3_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

12 
	~<ngx_maž_pÝ3_moduË.h
>

15 *
ngx_maž_pÝ3_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

16 *
ngx_maž_pÝ3_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

17 *
chžd
);

20 
ngx_¡r_t
 
	gngx_maž_pÝ3_deçuÉ_ÿ·bž™›s
[] = {

21 
ngx_¡ršg
("TOP"),

22 
ngx_¡ršg
("USER"),

23 
ngx_¡ršg
("UIDL"),

24 
ngx_nuÎ_¡ršg


28 
ngx_cÚf_b™mask_t
 
	gngx_maž_pÝ3_auth_m‘hods
[] = {

29 { 
ngx_¡ršg
("¶aš"), 
NGX_MAIL_AUTH_PLAIN_ENABLED
 },

30 { 
ngx_¡ršg
("­Ý"), 
NGX_MAIL_AUTH_APOP_ENABLED
 },

31 { 
ngx_¡ršg
("üam-md5"), 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
 },

32 { 
ngx_nuÎ_¡ršg
, 0 }

36 
ngx_¡r_t
 
	gngx_maž_pÝ3_auth_¶aš_ÿ·bž™y
 =

37 
ngx_¡ršg
("+OK m‘hod suµÜ‹d:" 
CRLF


38 "LOGIN" 
CRLF


39 "PLAIN" 
CRLF


40 "." 
CRLF
);

43 
ngx_¡r_t
 
	gngx_maž_pÝ3_auth_üam_md5_ÿ·bž™y
 =

44 
ngx_¡ršg
("+OK m‘hod suµÜ‹d:" 
CRLF


45 "LOGIN" 
CRLF


46 "PLAIN" 
CRLF


47 "CRAM-MD5" 
CRLF


48 "." 
CRLF
);

51 
ngx_maž_´ÙocÞ_t
 
	gngx_maž_pÝ3_´ÙocÞ
 = {

52 
ngx_¡ršg
("pop3"),

54 
NGX_MAIL_POP3_PROTOCOL
,

56 
ngx_maž_pÝ3_š™_£ssiÚ
,

57 
ngx_maž_pÝ3_š™_´ÙocÞ
,

58 
ngx_maž_pÝ3_·r£_commªd
,

59 
ngx_maž_pÝ3_auth_¡©e
,

61 
ngx_¡ršg
("-ERR iÁ”ÇÈ£rv”ƒ¼Ü" 
CRLF
)

65 
ngx_commªd_t
 
	gngx_maž_pÝ3_commªds
[] = {

67 { 
ngx_¡ršg
("pop3_capabilities"),

68 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

69 
ngx_maž_ÿ·bž™›s
,

70 
NGX_MAIL_SRV_CONF_OFFSET
,

71 
off£tof
(
ngx_maž_pÝ3_¤v_cÚf_t
, 
ÿ·bž™›s
),

72 
NULL
 },

74 { 
ngx_¡ršg
("pop3_auth"),

75 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

76 
ngx_cÚf_£t_b™mask_¦Ù
,

77 
NGX_MAIL_SRV_CONF_OFFSET
,

78 
off£tof
(
ngx_maž_pÝ3_¤v_cÚf_t
, 
auth_m‘hods
),

79 &
ngx_maž_pÝ3_auth_m‘hods
 },

81 
ngx_nuÎ_commªd


85 
ngx_maž_moduË_t
 
	gngx_maž_pÝ3_moduË_ùx
 = {

86 &
ngx_maž_pÝ3_´ÙocÞ
,

88 
NULL
,

89 
NULL
,

91 
ngx_maž_pÝ3_ü—‹_¤v_cÚf
,

92 
ngx_maž_pÝ3_m”ge_¤v_cÚf


96 
ngx_moduË_t
 
	gngx_maž_pÝ3_moduË
 = {

97 
NGX_MODULE_V1
,

98 &
ngx_maž_pÝ3_moduË_ùx
,

99 
ngx_maž_pÝ3_commªds
,

100 
NGX_MAIL_MODULE
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NGX_MODULE_V1_PADDING


113 
	$ngx_maž_pÝ3_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

115 
ngx_maž_pÝ3_¤v_cÚf_t
 *
pscf
;

117 
pscf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_pÝ3_¤v_cÚf_t
));

118 ià(
pscf
 =ð
NULL
) {

119  
NULL
;

122 ià(
	`ngx_¬¿y_š™
(&
pscf
->
ÿ·bž™›s
, 
cf
->
poÞ
, 4, (
ngx_¡r_t
))

123 !ð
NGX_OK
)

125  
NULL
;

128  
pscf
;

129 
	}
}

133 
	$ngx_maž_pÝ3_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

135 
ngx_maž_pÝ3_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

136 
ngx_maž_pÝ3_¤v_cÚf_t
 *
cÚf
 = 
chžd
;

138 
u_ch¬
 *
p
;

139 
size_t
 
size
, 
¡ls_Úly_size
;

140 
ngx_¡r_t
 *
c
, *
d
;

141 
ngx_ušt_t
 
i
;

143 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
auth_m‘hods
,

144 
´ev
->
auth_m‘hods
,

145 (
NGX_CONF_BITMASK_SET


146 |
NGX_MAIL_AUTH_PLAIN_ENABLED
));

148 ià(
cÚf
->
ÿ·bž™›s
.
ÃÉs
 == 0) {

149 
cÚf
->
ÿ·bž™›s
 = 
´ev
->capabilities;

152 ià(
cÚf
->
ÿ·bž™›s
.
ÃÉs
 == 0) {

154 
d
 = 
ngx_maž_pÝ3_deçuÉ_ÿ·bž™›s
; d->
Ën
; d++) {

155 
c
 = 
	`ngx_¬¿y_push
(&
cÚf
->
ÿ·bž™›s
);

156 ià(
c
 =ð
NULL
) {

157  
NGX_CONF_ERROR
;

160 *
c
 = *
d
;

164 
size
 = ("+OK C­abž™y†i¡ fÞlows" 
CRLF
) - 1

165 + ("." 
CRLF
) - 1;

167 
¡ls_Úly_size
 = 
size
 + ("STLS" 
CRLF
) - 1;

169 
c
 = 
cÚf
->
ÿ·bž™›s
.
–ts
;

170 
i
 = 0; i < 
cÚf
->
ÿ·bž™›s
.
ÃÉs
; i++) {

171 
size
 +ð
c
[
i
].
Ën
 + (
CRLF
) - 1;

173 ià(
	`ngx_¡rÿ£cmp
(
c
[
i
].
d©a
, (
u_ch¬
 *) "USER") == 0) {

177 
¡ls_Úly_size
 +ð
c
[
i
].
Ën
 + (
CRLF
) - 1;

180 ià(
cÚf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
) {

181 
size
 +ð("SASL LOGIN PLAIN CRAM-MD5" 
CRLF
) - 1;

184 
size
 +ð("SASL LOGIN PLAIN" 
CRLF
) - 1;

187 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

188 ià(
p
 =ð
NULL
) {

189  
NGX_CONF_ERROR
;

192 
cÚf
->
ÿ·bž™y
.
Ën
 = 
size
;

193 
cÚf
->
ÿ·bž™y
.
d©a
 = 
p
;

195 
p
 = 
	`ngx_ýymem
Õ, "+OK C­abž™y†i¡ fÞlows" 
CRLF
,

196 ("+OK C­abž™y†i¡ fÞlows" 
CRLF
) - 1);

198 
i
 = 0; i < 
cÚf
->
ÿ·bž™›s
.
ÃÉs
; i++) {

199 
p
 = 
	`ngx_ýymem
Õ, 
c
[
i
].
d©a
, c[i].
Ën
);

200 *
p
++ = 
CR
; *p++ = 
LF
;

203 ià(
cÚf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
) {

204 
p
 = 
	`ngx_ýymem
Õ, "SASL LOGIN PLAIN CRAM-MD5" 
CRLF
,

205 ("SASL LOGIN PLAIN CRAM-MD5" 
CRLF
) - 1);

208 
p
 = 
	`ngx_ýymem
Õ, "SASL LOGIN PLAIN" 
CRLF
,

209 ("SASL LOGIN PLAIN" 
CRLF
) - 1);

212 *
p
++ = '.'; *p++ = 
CR
; *°ð
LF
;

215 
size
 +ð("STLS" 
CRLF
) - 1;

217 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

218 ià(
p
 =ð
NULL
) {

219  
NGX_CONF_ERROR
;

222 
cÚf
->
¡¬‰ls_ÿ·bž™y
.
Ën
 = 
size
;

223 
cÚf
->
¡¬‰ls_ÿ·bž™y
.
d©a
 = 
p
;

225 
p
 = 
	`ngx_ýymem
Õ, 
cÚf
->
ÿ·bž™y
.
d©a
,

226 
cÚf
->
ÿ·bž™y
.
Ën
 - (("." 
CRLF
) - 1));

228 
p
 = 
	`ngx_ýymem
Õ, "STLS" 
CRLF
, ("STLS" CRLF) - 1);

229 *
p
++ = '.'; *p++ = 
CR
; *°ð
LF
;

232 ià(
cÚf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
) {

233 
cÚf
->
auth_ÿ·bž™y
 = 
ngx_maž_pÝ3_auth_üam_md5_ÿ·bž™y
;

236 
cÚf
->
auth_ÿ·bž™y
 = 
ngx_maž_pÝ3_auth_¶aš_ÿ·bž™y
;

240 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
¡ls_Úly_size
);

241 ià(
p
 =ð
NULL
) {

242  
NGX_CONF_ERROR
;

245 
cÚf
->
¡¬‰ls_Úly_ÿ·bž™y
.
Ën
 = 
¡ls_Úly_size
;

246 
cÚf
->
¡¬‰ls_Úly_ÿ·bž™y
.
d©a
 = 
p
;

248 
p
 = 
	`ngx_ýymem
Õ, "+OK C­abž™y†i¡ fÞlows" 
CRLF
,

249 ("+OK C­abž™y†i¡ fÞlows" 
CRLF
) - 1);

251 
i
 = 0; i < 
cÚf
->
ÿ·bž™›s
.
ÃÉs
; i++) {

252 ià(
	`ngx_¡rÿ£cmp
(
c
[
i
].
d©a
, (
u_ch¬
 *) "USER") == 0) {

256 
p
 = 
	`ngx_ýymem
Õ, 
c
[
i
].
d©a
, c[i].
Ën
);

257 *
p
++ = 
CR
; *p++ = 
LF
;

260 
p
 = 
	`ngx_ýymem
Õ, "STLS" 
CRLF
, ("STLS" CRLF) - 1);

261 *
p
++ = '.'; *p++ = 
CR
; *°ð
LF
;

263  
NGX_CONF_OK
;

264 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_proxy_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ev’t_cÚÃù.h
>

12 
	~<ngx_maž.h
>

16 
ngx_æag_t
 
	m’abË
;

17 
ngx_æag_t
 
	m·ss_”rÜ_mes§ge
;

18 
ngx_æag_t
 
	mxþ›Á
;

19 
size_t
 
	mbufãr_size
;

20 
ngx_m£c_t
 
	mtimeout
;

21 } 
	tngx_maž_´oxy_cÚf_t
;

24 
ngx_maž_´oxy_block_»ad
(
ngx_ev’t_t
 *
»v
);

25 
ngx_maž_´oxy_pÝ3_hªdËr
(
ngx_ev’t_t
 *
»v
);

26 
ngx_maž_´oxy_im­_hªdËr
(
ngx_ev’t_t
 *
»v
);

27 
ngx_maž_´oxy_sm_hªdËr
(
ngx_ev’t_t
 *
»v
);

28 
ngx_maž_´oxy_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
);

29 
ngx_št_t
 
ngx_maž_´oxy_»ad_»¥Ú£
(
ngx_maž_£ssiÚ_t
 *
s
,

30 
ngx_ušt_t
 
¡©e
);

31 
ngx_maž_´oxy_hªdËr
(
ngx_ev’t_t
 *
ev
);

32 
ngx_maž_´oxy_up¡»am_”rÜ
(
ngx_maž_£ssiÚ_t
 *
s
);

33 
ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
ngx_maž_£ssiÚ_t
 *
s
);

34 
ngx_maž_´oxy_þo£_£ssiÚ
(
ngx_maž_£ssiÚ_t
 *
s
);

35 *
ngx_maž_´oxy_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

36 *
ngx_maž_´oxy_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

37 *
chžd
);

40 
ngx_commªd_t
 
	gngx_maž_´oxy_commªds
[] = {

42 { 
ngx_¡ršg
("proxy"),

43 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

44 
ngx_cÚf_£t_æag_¦Ù
,

45 
NGX_MAIL_SRV_CONF_OFFSET
,

46 
off£tof
(
ngx_maž_´oxy_cÚf_t
, 
’abË
),

47 
NULL
 },

49 { 
ngx_¡ršg
("proxy_buffer"),

50 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

51 
ngx_cÚf_£t_size_¦Ù
,

52 
NGX_MAIL_SRV_CONF_OFFSET
,

53 
off£tof
(
ngx_maž_´oxy_cÚf_t
, 
bufãr_size
),

54 
NULL
 },

56 { 
ngx_¡ršg
("proxy_timeout"),

57 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

58 
ngx_cÚf_£t_m£c_¦Ù
,

59 
NGX_MAIL_SRV_CONF_OFFSET
,

60 
off£tof
(
ngx_maž_´oxy_cÚf_t
, 
timeout
),

61 
NULL
 },

63 { 
ngx_¡ršg
("proxy_pass_error_message"),

64 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

65 
ngx_cÚf_£t_æag_¦Ù
,

66 
NGX_MAIL_SRV_CONF_OFFSET
,

67 
off£tof
(
ngx_maž_´oxy_cÚf_t
, 
·ss_”rÜ_mes§ge
),

68 
NULL
 },

70 { 
ngx_¡ršg
("xclient"),

71 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

72 
ngx_cÚf_£t_æag_¦Ù
,

73 
NGX_MAIL_SRV_CONF_OFFSET
,

74 
off£tof
(
ngx_maž_´oxy_cÚf_t
, 
xþ›Á
),

75 
NULL
 },

77 
ngx_nuÎ_commªd


81 
ngx_maž_moduË_t
 
	gngx_maž_´oxy_moduË_ùx
 = {

82 
NULL
,

84 
NULL
,

85 
NULL
,

87 
ngx_maž_´oxy_ü—‹_cÚf
,

88 
ngx_maž_´oxy_m”ge_cÚf


92 
ngx_moduË_t
 
	gngx_maž_´oxy_moduË
 = {

93 
NGX_MODULE_V1
,

94 &
ngx_maž_´oxy_moduË_ùx
,

95 
ngx_maž_´oxy_commªds
,

96 
NGX_MAIL_MODULE
,

97 
NULL
,

98 
NULL
,

99 
NULL
,

100 
NULL
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NGX_MODULE_V1_PADDING


108 
u_ch¬
 
	gsm_auth_ok
[] = "235 2.0.0 OK" 
CRLF
;

112 
	$ngx_maž_´oxy_š™
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_addr_t
 *
³”
)

114 
k“·live
;

115 
ngx_št_t
 
rc
;

116 
ngx_maž_´oxy_ùx_t
 *
p
;

117 
ngx_maž_´oxy_cÚf_t
 *
pcf
;

118 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

120 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "connectingo upstream";

122 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

124 ià(
cscf
->
so_k“·live
) {

125 
k“·live
 = 1;

127 ià(
	`£tsockÝt
(
s
->
cÚÃùiÚ
->
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
,

128 (cÚ¡ *è&
k“·live
, ())

131 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
s
->
cÚÃùiÚ
->
log
, 
ngx_sock‘_”ºo
,

136 
p
 = 
	`ngx_pÿÎoc
(
s
->
cÚÃùiÚ
->
poÞ
, (
ngx_maž_´oxy_ùx_t
));

137 ià(
p
 =ð
NULL
) {

138 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

142 
s
->
´oxy
 = 
p
;

144 
p
->
up¡»am
.
sockaddr
 = 
³”
->sockaddr;

145 
p
->
up¡»am
.
sockËn
 = 
³”
->socklen;

146 
p
->
up¡»am
.
Çme
 = &
³”
->name;

147 
p
->
up¡»am
.
g‘
 = 
ngx_ev’t_g‘_³”
;

148 
p
->
up¡»am
.
log
 = 
s
->
cÚÃùiÚ
->log;

149 
p
->
up¡»am
.
log_”rÜ
 = 
NGX_ERROR_ERR
;

151 
rc
 = 
	`ngx_ev’t_cÚÃù_³”
(&
p
->
up¡»am
);

153 ià(
rc
 =ð
NGX_ERROR
 ||„ø=ð
NGX_BUSY
 ||„ø=ð
NGX_DECLINED
) {

154 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

158 
	`ngx_add_tim”
(
p
->
up¡»am
.
cÚÃùiÚ
->
»ad
, 
cscf
->
timeout
);

160 
p
->
up¡»am
.
cÚÃùiÚ
->
d©a
 = 
s
;

161 
p
->
up¡»am
.
cÚÃùiÚ
->
poÞ
 = 
s
->connection->pool;

163 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_´oxy_block_»ad
;

164 
p
->
up¡»am
.
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_maž_´oxy_dummy_hªdËr
;

166 
pcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_´oxy_moduË
);

168 
s
->
´oxy
->
bufãr
 = 
	`ngx_ü—‹_‹mp_buf
(s->
cÚÃùiÚ
->
poÞ
,

169 
pcf
->
bufãr_size
);

170 ià(
s
->
´oxy
->
bufãr
 =ð
NULL
) {

171 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

175 
s
->
out
.
Ën
 = 0;

177 
s
->
´ÙocÞ
) {

179 
NGX_MAIL_POP3_PROTOCOL
:

180 
p
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_´oxy_pÝ3_hªdËr
;

181 
s
->
maž_¡©e
 = 
ngx_pÝ3_¡¬t
;

184 
NGX_MAIL_IMAP_PROTOCOL
:

185 
p
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_´oxy_im­_hªdËr
;

186 
s
->
maž_¡©e
 = 
ngx_im­_¡¬t
;

190 
p
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_´oxy_sm_hªdËr
;

191 
s
->
maž_¡©e
 = 
ngx_sm_¡¬t
;

194 
	}
}

198 
	$ngx_maž_´oxy_block_»ad
(
ngx_ev’t_t
 *
»v
)

200 
ngx_cÚÃùiÚ_t
 *
c
;

201 
ngx_maž_£ssiÚ_t
 *
s
;

203 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy block„ead");

205 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ð
NGX_OK
) {

206 
c
 = 
»v
->
d©a
;

207 
s
 = 
c
->
d©a
;

209 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

211 
	}
}

215 
	$ngx_maž_´oxy_pÝ3_hªdËr
(
ngx_ev’t_t
 *
»v
)

217 
u_ch¬
 *
p
;

218 
ngx_št_t
 
rc
;

219 
ngx_¡r_t
 
lše
;

220 
ngx_cÚÃùiÚ_t
 *
c
;

221 
ngx_maž_£ssiÚ_t
 *
s
;

222 
ngx_maž_´oxy_cÚf_t
 *
pcf
;

224 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

227 
c
 = 
»v
->
d©a
;

228 
s
 = 
c
->
d©a
;

230 ià(
»v
->
timedout
) {

231 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

233 
c
->
timedout
 = 1;

234 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

238 
rc
 = 
	`ngx_maž_´oxy_»ad_»¥Ú£
(
s
, 0);

240 ià(
rc
 =ð
NGX_AGAIN
) {

244 ià(
rc
 =ð
NGX_ERROR
) {

245 
	`ngx_maž_´oxy_up¡»am_”rÜ
(
s
);

249 
s
->
maž_¡©e
) {

251 
ngx_pÝ3_¡¬t
:

252 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy send user");

254 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending user‚ameo upstream";

256 
lše
.
Ën
 = ("USER "è- 1 + 
s
->
logš
.len + 2;

257 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

258 ià(
lše
.
d©a
 =ð
NULL
) {

259 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

263 
p
 = 
	`ngx_ýymem
(
lše
.
d©a
, "USER ", ("USER ") - 1);

264 
p
 = 
	`ngx_ýymem
Õ, 
s
->
logš
.
d©a
, s->logš.
Ën
);

265 *
p
++ = 
CR
; *°ð
LF
;

267 
s
->
maž_¡©e
 = 
ngx_pÝ3_u£r
;

270 
ngx_pÝ3_u£r
:

271 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy send…ass");

273 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending…asswordo upstream";

275 
lše
.
Ën
 = ("PASS "è- 1 + 
s
->
·sswd
.len + 2;

276 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

277 ià(
lše
.
d©a
 =ð
NULL
) {

278 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

282 
p
 = 
	`ngx_ýymem
(
lše
.
d©a
, "PASS ", ("PASS ") - 1);

283 
p
 = 
	`ngx_ýymem
Õ, 
s
->
·sswd
.
d©a
, s->·sswd.
Ën
);

284 *
p
++ = 
CR
; *°ð
LF
;

286 
s
->
maž_¡©e
 = 
ngx_pÝ3_·sswd
;

289 
ngx_pÝ3_·sswd
:

290 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

291 
s
->
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

292 
»v
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

293 
c
->
wr™e
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

295 
pcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_´oxy_moduË
);

296 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, 
pcf
->
timeout
);

297 
	`ngx_d–_tim”
(
c
->
»ad
);

299 
c
->
log
->
aùiÚ
 = 
NULL
;

300 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "client†ogged in");

302 
	`ngx_maž_´oxy_hªdËr
(
s
->
cÚÃùiÚ
->
wr™e
);

307 #ià(
NGX_SUPPRESS_WARN
)

308 
	`ngx_¡r_nuÎ
(&
lše
);

313 ià(
c
->
	`£nd
(c, 
lše
.
d©a
,†še.
Ën
è< (
ssize_t
)†ine.len) {

318 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

322 
s
->
´oxy
->
bufãr
->
pos
 = s->´oxy->bufãr->
¡¬t
;

323 
s
->
´oxy
->
bufãr
->
Ï¡
 = s->´oxy->bufãr->
¡¬t
;

324 
	}
}

328 
	$ngx_maž_´oxy_im­_hªdËr
(
ngx_ev’t_t
 *
»v
)

330 
u_ch¬
 *
p
;

331 
ngx_št_t
 
rc
;

332 
ngx_¡r_t
 
lše
;

333 
ngx_cÚÃùiÚ_t
 *
c
;

334 
ngx_maž_£ssiÚ_t
 *
s
;

335 
ngx_maž_´oxy_cÚf_t
 *
pcf
;

337 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

340 
c
 = 
»v
->
d©a
;

341 
s
 = 
c
->
d©a
;

343 ià(
»v
->
timedout
) {

344 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

346 
c
->
timedout
 = 1;

347 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

351 
rc
 = 
	`ngx_maž_´oxy_»ad_»¥Ú£
(
s
, s->
maž_¡©e
);

353 ià(
rc
 =ð
NGX_AGAIN
) {

357 ià(
rc
 =ð
NGX_ERROR
) {

358 
	`ngx_maž_´oxy_up¡»am_”rÜ
(
s
);

362 
s
->
maž_¡©e
) {

364 
ngx_im­_¡¬t
:

365 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

368 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending LOGIN commando upstream";

370 
lše
.
Ën
 = 
s
->
g
.len + ("LOGIN ") - 1

371 + 1 + 
NGX_SIZE_T_LEN
 + 1 + 2;

372 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

373 ià(
lše
.
d©a
 =ð
NULL
) {

374 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

378 
lše
.
Ën
 = 
	`ngx_¥rštf
Öše.
d©a
, "%VLOGIN {%uz}" 
CRLF
,

379 &
s
->
g
, s->
logš
.
Ën
)

380 - 
lše
.
d©a
;

382 
s
->
maž_¡©e
 = 
ngx_im­_logš
;

385 
ngx_im­_logš
:

386 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy send user");

388 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending user‚ameo upstream";

390 
lše
.
Ën
 = 
s
->
logš
.ËÀ+ 1 + 1 + 
NGX_SIZE_T_LEN
 + 1 + 2;

391 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

392 ià(
lše
.
d©a
 =ð
NULL
) {

393 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

397 
lše
.
Ën
 = 
	`ngx_¥rštf
Öše.
d©a
, "%V {%uz}" 
CRLF
,

398 &
s
->
logš
, s->
·sswd
.
Ën
)

399 - 
lše
.
d©a
;

401 
s
->
maž_¡©e
 = 
ngx_im­_u£r
;

404 
ngx_im­_u£r
:

405 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

408 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending…asswordo upstream";

410 
lše
.
Ën
 = 
s
->
·sswd
.len + 2;

411 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

412 ià(
lše
.
d©a
 =ð
NULL
) {

413 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

417 
p
 = 
	`ngx_ýymem
(
lše
.
d©a
, 
s
->
·sswd
.d©a, s->·sswd.
Ën
);

418 *
p
++ = 
CR
; *°ð
LF
;

420 
s
->
maž_¡©e
 = 
ngx_im­_·sswd
;

423 
ngx_im­_·sswd
:

424 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

425 
s
->
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

426 
»v
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

427 
c
->
wr™e
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

429 
pcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_´oxy_moduË
);

430 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, 
pcf
->
timeout
);

431 
	`ngx_d–_tim”
(
c
->
»ad
);

433 
c
->
log
->
aùiÚ
 = 
NULL
;

434 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "client†ogged in");

436 
	`ngx_maž_´oxy_hªdËr
(
s
->
cÚÃùiÚ
->
wr™e
);

441 #ià(
NGX_SUPPRESS_WARN
)

442 
	`ngx_¡r_nuÎ
(&
lše
);

447 ià(
c
->
	`£nd
(c, 
lše
.
d©a
,†še.
Ën
è< (
ssize_t
)†ine.len) {

452 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

456 
s
->
´oxy
->
bufãr
->
pos
 = s->´oxy->bufãr->
¡¬t
;

457 
s
->
´oxy
->
bufãr
->
Ï¡
 = s->´oxy->bufãr->
¡¬t
;

458 
	}
}

462 
	$ngx_maž_´oxy_sm_hªdËr
(
ngx_ev’t_t
 *
»v
)

464 
u_ch¬
 *
p
;

465 
ngx_št_t
 
rc
;

466 
ngx_¡r_t
 
lše
;

467 
ngx_buf_t
 *
b
;

468 
ngx_cÚÃùiÚ_t
 *
c
;

469 
ngx_maž_£ssiÚ_t
 *
s
;

470 
ngx_maž_´oxy_cÚf_t
 *
pcf
;

471 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

473 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

476 
c
 = 
»v
->
d©a
;

477 
s
 = 
c
->
d©a
;

479 ià(
»v
->
timedout
) {

480 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

482 
c
->
timedout
 = 1;

483 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

487 
rc
 = 
	`ngx_maž_´oxy_»ad_»¥Ú£
(
s
, s->
maž_¡©e
);

489 ià(
rc
 =ð
NGX_AGAIN
) {

493 ià(
rc
 =ð
NGX_ERROR
) {

494 
	`ngx_maž_´oxy_up¡»am_”rÜ
(
s
);

498 
s
->
maž_¡©e
) {

500 
ngx_sm_¡¬t
:

501 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy sendƒhlo");

503 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending HELO/EHLOo upstream";

505 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

507 
lše
.
Ën
 = ("HELO "è- 1 + 
cscf
->
£rv”_Çme
.len + 2;

508 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

509 ià(
lše
.
d©a
 =ð
NULL
) {

510 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

514 
pcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_´oxy_moduË
);

516 
p
 = 
	`ngx_ýymem
(
lše
.
d©a
,

517 ((
s
->
esm
 || 
pcf
->
xþ›Á
) ? "EHLO " : "HELO "),

520 
p
 = 
	`ngx_ýymem
Õ, 
cscf
->
£rv”_Çme
.
d©a
, cscf->£rv”_Çme.
Ën
);

521 *
p
++ = 
CR
; *°ð
LF
;

523 ià(
pcf
->
xþ›Á
) {

524 
s
->
maž_¡©e
 = 
ngx_sm_h–o_xþ›Á
;

526 } ià(
s
->
auth_m‘hod
 =ð
NGX_MAIL_AUTH_NONE
) {

527 
s
->
maž_¡©e
 = 
ngx_sm_h–o_äom
;

530 
s
->
maž_¡©e
 = 
ngx_sm_h–o
;

535 
ngx_sm_h–o_xþ›Á
:

536 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

539 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending XCLIENTo upstream";

541 
lše
.
Ën
 = ("XCLIENT ADDR= LOGIN= NAME="

542 
CRLF
) - 1

543 + 
s
->
cÚÃùiÚ
->
addr_‹xt
.
Ën
 + s->
logš
.ËÀ+ s->
ho¡
.len;

545 #ià(
NGX_HAVE_INET6
)

546 ià(
s
->
cÚÃùiÚ
->
sockaddr
->
§_çmžy
 =ð
AF_INET6
) {

547 
lše
.
Ën
 += ("IPV6:") - 1;

551 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

552 ià(
lše
.
d©a
 =ð
NULL
) {

553 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

557 
p
 = 
	`ngx_ýymem
(
lše
.
d©a
, "XCLIENT ADDR=", ("XCLIENT ADDR=") - 1);

559 #ià(
NGX_HAVE_INET6
)

560 ià(
s
->
cÚÃùiÚ
->
sockaddr
->
§_çmžy
 =ð
AF_INET6
) {

561 
p
 = 
	`ngx_ýymem
(p, "IPV6:", ("IPV6:") - 1);

565 
p
 = 
	`ngx_cÝy
Õ, 
s
->
cÚÃùiÚ
->
addr_‹xt
.
d©a
,

566 
s
->
cÚÃùiÚ
->
addr_‹xt
.
Ën
);

568 ià(
s
->
logš
.
Ën
) {

569 
p
 = 
	`ngx_ýymem
(p, " LOGIN=", (" LOGIN=") - 1);

570 
p
 = 
	`ngx_cÝy
Õ, 
s
->
logš
.
d©a
, s->logš.
Ën
);

573 
p
 = 
	`ngx_ýymem
(p, " NAME=", (" NAME=") - 1);

574 
p
 = 
	`ngx_cÝy
Õ, 
s
->
ho¡
.
d©a
, s->ho¡.
Ën
);

576 *
p
++ = 
CR
; *p++ = 
LF
;

578 
lše
.
Ën
 = 
p
 -†še.
d©a
;

580 ià(
s
->
sm_h–o
.
Ën
) {

581 
s
->
maž_¡©e
 = 
ngx_sm_xþ›Á_h–o
;

583 } ià(
s
->
auth_m‘hod
 =ð
NGX_MAIL_AUTH_NONE
) {

584 
s
->
maž_¡©e
 = 
ngx_sm_xþ›Á_äom
;

587 
s
->
maž_¡©e
 = 
ngx_sm_xþ›Á
;

592 
ngx_sm_xþ›Á_h–o
:

593 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

596 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending client HELO/EHLOo upstream";

598 
lše
.
Ën
 = ("HELO " 
CRLF
è- 1 + 
s
->
sm_h–o
.len;

600 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

601 ià(
lše
.
d©a
 =ð
NULL
) {

602 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

606 
lše
.
Ën
 = 
	`ngx_¥rštf
Öše.
d©a
,

607 ((
s
->
esm
è? "EHLO %V" 
CRLF
 : "HELO %V" CRLF),

608 &
s
->
sm_h–o
)

609 - 
lše
.
d©a
;

611 
s
->
maž_¡©e
 = (s->
auth_m‘hod
 =ð
NGX_MAIL_AUTH_NONE
) ?

612 
ngx_sm_h–o_äom
 : 
ngx_sm_h–o
;

616 
ngx_sm_h–o_äom
:

617 
ngx_sm_xþ›Á_äom
:

618 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

621 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending MAIL FROMo upstream";

623 
lše
.
Ën
 = 
s
->
sm_äom
.ËÀ+ (
CRLF
) - 1;

624 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

625 ià(
lše
.
d©a
 =ð
NULL
) {

626 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

630 
p
 = 
	`ngx_ýymem
(
lše
.
d©a
, 
s
->
sm_äom
.d©a, s->sm_äom.
Ën
);

631 *
p
++ = 
CR
; *°ð
LF
;

633 
s
->
maž_¡©e
 = 
ngx_sm_äom
;

637 
ngx_sm_äom
:

638 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

641 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending RCPT TOo upstream";

643 
lše
.
Ën
 = 
s
->
sm_to
.ËÀ+ (
CRLF
) - 1;

644 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
,†še.
Ën
);

645 ià(
lše
.
d©a
 =ð
NULL
) {

646 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

650 
p
 = 
	`ngx_ýymem
(
lše
.
d©a
, 
s
->
sm_to
.d©a, s->sm_to.
Ën
);

651 *
p
++ = 
CR
; *°ð
LF
;

653 
s
->
maž_¡©e
 = 
ngx_sm_to
;

657 
ngx_sm_h–o
:

658 
ngx_sm_xþ›Á
:

659 
ngx_sm_to
:

661 
b
 = 
s
->
´oxy
->
bufãr
;

663 ià(
s
->
auth_m‘hod
 =ð
NGX_MAIL_AUTH_NONE
) {

664 
b
->
pos
 = b->
¡¬t
;

667 
	`ngx_memýy
(
b
->
¡¬t
, 
sm_auth_ok
, (smtp_auth_ok) - 1);

668 
b
->
Ï¡
 = b->
¡¬t
 + (
sm_auth_ok
) - 1;

671 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

672 
s
->
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

673 
»v
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

674 
c
->
wr™e
->
hªdËr
 = 
ngx_maž_´oxy_hªdËr
;

676 
pcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_´oxy_moduË
);

677 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, 
pcf
->
timeout
);

678 
	`ngx_d–_tim”
(
c
->
»ad
);

680 
c
->
log
->
aùiÚ
 = 
NULL
;

681 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "client†ogged in");

683 ià(
s
->
bufãr
->
pos
 =ðs->bufãr->
Ï¡
) {

684 
	`ngx_maž_´oxy_hªdËr
(
s
->
cÚÃùiÚ
->
wr™e
);

687 
	`ngx_maž_´oxy_hªdËr
(
c
->
wr™e
);

693 #ià(
NGX_SUPPRESS_WARN
)

694 
	`ngx_¡r_nuÎ
(&
lše
);

699 ià(
c
->
	`£nd
(c, 
lše
.
d©a
,†še.
Ën
è< (
ssize_t
)†ine.len) {

704 
	`ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
s
);

708 
s
->
´oxy
->
bufãr
->
pos
 = s->´oxy->bufãr->
¡¬t
;

709 
s
->
´oxy
->
bufãr
->
Ï¡
 = s->´oxy->bufãr->
¡¬t
;

710 
	}
}

714 
	$ngx_maž_´oxy_dummy_hªdËr
(
ngx_ev’t_t
 *
wev
)

716 
ngx_cÚÃùiÚ_t
 *
c
;

717 
ngx_maž_£ssiÚ_t
 *
s
;

719 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
wev
->
log
, 0, "mail…roxy dummy handler");

721 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 0è!ð
NGX_OK
) {

722 
c
 = 
wev
->
d©a
;

723 
s
 = 
c
->
d©a
;

725 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

727 
	}
}

730 
ngx_št_t


731 
	$ngx_maž_´oxy_»ad_»¥Ú£
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_ušt_t
 
¡©e
)

733 
u_ch¬
 *
p
, *
m
;

734 
ssize_t
 
n
;

735 
ngx_buf_t
 *
b
;

736 
ngx_maž_´oxy_cÚf_t
 *
pcf
;

738 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "reading„esponse from upstream";

740 
b
 = 
s
->
´oxy
->
bufãr
;

742 
n
 = 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
	`»cv
(s->proxy->upstream.connection,

743 
b
->
Ï¡
, b->
’d
 - b->last);

745 ià(
n
 =ð
NGX_ERROR
 ||‚ == 0) {

746  
NGX_ERROR
;

749 ià(
n
 =ð
NGX_AGAIN
) {

750  
NGX_AGAIN
;

753 
b
->
Ï¡
 +ð
n
;

755 ià(
b
->
Ï¡
 - b->
pos
 < 4) {

756  
NGX_AGAIN
;

759 ià(*(
b
->
Ï¡
 - 2è!ð
CR
 || *(b->Ï¡ - 1è!ð
LF
) {

760 ià(
b
->
Ï¡
 =ðb->
’d
) {

761 *(
b
->
Ï¡
 - 1) = '\0';

762 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

764 
b
->
pos
);

765  
NGX_ERROR
;

768  
NGX_AGAIN
;

771 
p
 = 
b
->
pos
;

773 
s
->
´ÙocÞ
) {

775 
NGX_MAIL_POP3_PROTOCOL
:

776 ià(
p
[0] == '+' &&…[1] == 'O' &&…[2] == 'K') {

777  
NGX_OK
;

781 
NGX_MAIL_IMAP_PROTOCOL
:

782 
¡©e
) {

784 
ngx_im­_¡¬t
:

785 ià(
p
[0] == '*' &&…[1] == ' ' &&…[2] == 'O' &&…[3] == 'K') {

786  
NGX_OK
;

790 
ngx_im­_logš
:

791 
ngx_im­_u£r
:

792 ià(
p
[0] == '+') {

793  
NGX_OK
;

797 
ngx_im­_·sswd
:

798 ià(
	`ngx_¡ºcmp
(
p
, 
s
->
g
.
d©a
, s->g.
Ën
) == 0) {

799 
p
 +ð
s
->
g
.
Ën
;

800 ià(
p
[0] == 'O' &&…[1] == 'K') {

801  
NGX_OK
;

811 ià(
p
[3] == '-') {

814 
m
 = 
b
->
Ï¡
 - ((
CRLF
 "200" CRLF) - 1);

816 
m
 > 
p
) {

817 ià(
m
[0] =ð
CR
 && m[1] =ð
LF
) {

821 
m
--;

824 ià(
m
 <ð
p
 || m[5] == '-') {

825  
NGX_AGAIN
;

829 
¡©e
) {

831 
ngx_sm_¡¬t
:

832 ià(
p
[0] == '2' &&…[1] == '2' &&…[2] == '0') {

833  
NGX_OK
;

837 
ngx_sm_h–o
:

838 
ngx_sm_h–o_xþ›Á
:

839 
ngx_sm_h–o_äom
:

840 
ngx_sm_äom
:

841 ià(
p
[0] == '2' &&…[1] == '5' &&…[2] == '0') {

842  
NGX_OK
;

846 
ngx_sm_xþ›Á
:

847 
ngx_sm_xþ›Á_äom
:

848 
ngx_sm_xþ›Á_h–o
:

849 ià(
p
[0] == '2' && (p[1] == '2' ||…[1] == '5') &&…[2] == '0') {

850  
NGX_OK
;

854 
ngx_sm_to
:

855  
NGX_OK
;

861 
pcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_´oxy_moduË
);

863 ià(
pcf
->
·ss_”rÜ_mes§ge
 == 0) {

864 *(
b
->
Ï¡
 - 2) = '\0';

865 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

866 "up¡»am s’ˆšv®id„e¥Ú£: \"%s\"", 
p
);

867  
NGX_ERROR
;

870 
s
->
out
.
Ën
 = 
b
->
Ï¡
 - 
p
 - 2;

871 
s
->
out
.
d©a
 = 
p
;

873 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
s
->
cÚÃùiÚ
->
log
, 0,

874 "up¡»am s’ˆšv®id„e¥Ú£: \"%V\"", &
s
->
out
);

876 
s
->
out
.
Ën
 = 
b
->
Ï¡
 - b->
pos
;

877 
s
->
out
.
d©a
 = 
b
->
pos
;

879  
NGX_ERROR
;

880 
	}
}

884 
	$ngx_maž_´oxy_hªdËr
(
ngx_ev’t_t
 *
ev
)

886 *
aùiÚ
, *
»cv_aùiÚ
, *
£nd_aùiÚ
;

887 
size_t
 
size
;

888 
ssize_t
 
n
;

889 
ngx_buf_t
 *
b
;

890 
ngx_ušt_t
 
do_wr™e
;

891 
ngx_cÚÃùiÚ_t
 *
c
, *
¤c
, *
d¡
;

892 
ngx_maž_£ssiÚ_t
 *
s
;

893 
ngx_maž_´oxy_cÚf_t
 *
pcf
;

895 
c
 = 
ev
->
d©a
;

896 
s
 = 
c
->
d©a
;

898 ià(
ev
->
timedout
) {

899 
c
->
log
->
aùiÚ
 = "proxying";

901 ià(
c
 =ð
s
->
cÚÃùiÚ
) {

902 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

904 
c
->
timedout
 = 1;

907 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

911 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

915 ià(
c
 =ð
s
->
cÚÃùiÚ
) {

916 ià(
ev
->
wr™e
) {

917 
»cv_aùiÚ
 = "proxying‡nd„eading from upstream";

918 
£nd_aùiÚ
 = "proxying‡nd sendingo client";

919 
¤c
 = 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
;

920 
d¡
 = 
c
;

921 
b
 = 
s
->
´oxy
->
bufãr
;

924 
»cv_aùiÚ
 = "proxying‡nd„eading from client";

925 
£nd_aùiÚ
 = "proxying‡nd sendingo upstream";

926 
¤c
 = 
c
;

927 
d¡
 = 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
;

928 
b
 = 
s
->
bufãr
;

932 ià(
ev
->
wr™e
) {

933 
»cv_aùiÚ
 = "proxying‡nd„eading from client";

934 
£nd_aùiÚ
 = "proxying‡nd sendingo upstream";

935 
¤c
 = 
s
->
cÚÃùiÚ
;

936 
d¡
 = 
c
;

937 
b
 = 
s
->
bufãr
;

940 
»cv_aùiÚ
 = "proxying‡nd„eading from upstream";

941 
£nd_aùiÚ
 = "proxying‡nd sendingo client";

942 
¤c
 = 
c
;

943 
d¡
 = 
s
->
cÚÃùiÚ
;

944 
b
 = 
s
->
´oxy
->
bufãr
;

948 
do_wr™e
 = 
ev
->
wr™e
 ? 1 : 0;

950 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_MAIL
, 
ev
->
log
, 0,

952 
do_wr™e
, 
¤c
->
fd
, 
d¡
->fd);

956 ià(
do_wr™e
) {

958 
size
 = 
b
->
Ï¡
 - b->
pos
;

960 ià(
size
 && 
d¡
->
wr™e
->
»ady
) {

961 
c
->
log
->
aùiÚ
 = 
£nd_aùiÚ
;

963 
n
 = 
d¡
->
	`£nd
(d¡, 
b
->
pos
, 
size
);

965 ià(
n
 =ð
NGX_ERROR
) {

966 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

970 ià(
n
 > 0) {

971 
b
->
pos
 +ð
n
;

973 ià(
b
->
pos
 =ðb->
Ï¡
) {

974 
b
->
pos
 = b->
¡¬t
;

975 
b
->
Ï¡
 = b->
¡¬t
;

981 
size
 = 
b
->
’d
 - b->
Ï¡
;

983 ià(
size
 && 
¤c
->
»ad
->
»ady
) {

984 
c
->
log
->
aùiÚ
 = 
»cv_aùiÚ
;

986 
n
 = 
¤c
->
	`»cv
(¤c, 
b
->
Ï¡
, 
size
);

988 ià(
n
 =ð
NGX_AGAIN
 ||‚ == 0) {

992 ià(
n
 > 0) {

993 
do_wr™e
 = 1;

994 
b
->
Ï¡
 +ð
n
;

999 ià(
n
 =ð
NGX_ERROR
) {

1000 
¤c
->
»ad
->
eof
 = 1;

1007 
c
->
log
->
aùiÚ
 = "proxying";

1009 ià((
s
->
cÚÃùiÚ
->
»ad
->
eof
 && s->
bufãr
->
pos
 =ðs->bufãr->
Ï¡
)

1010 || (
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
eof


1011 && 
s
->
´oxy
->
bufãr
->
pos
 =ðs->´oxy->bufãr->
Ï¡
)

1012 || (
s
->
cÚÃùiÚ
->
»ad
->
eof


1013 && 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
eof
))

1015 
aùiÚ
 = 
c
->
log
->action;

1016 
c
->
log
->
aùiÚ
 = 
NULL
;

1017 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "proxied session done");

1018 
c
->
log
->
aùiÚ
 =‡ction;

1020 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

1024 ià(
	`ngx_hªdË_wr™e_ev’t
(
d¡
->
wr™e
, 0è!ð
NGX_OK
) {

1025 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

1029 ià(
	`ngx_hªdË_»ad_ev’t
(
d¡
->
»ad
, 0è!ð
NGX_OK
) {

1030 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

1034 ià(
	`ngx_hªdË_wr™e_ev’t
(
¤c
->
wr™e
, 0è!ð
NGX_OK
) {

1035 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

1039 ià(
	`ngx_hªdË_»ad_ev’t
(
¤c
->
»ad
, 0è!ð
NGX_OK
) {

1040 
	`ngx_maž_´oxy_þo£_£ssiÚ
(
s
);

1044 ià(
c
 =ð
s
->
cÚÃùiÚ
) {

1045 
pcf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_´oxy_moduË
);

1046 
	`ngx_add_tim”
(
c
->
»ad
, 
pcf
->
timeout
);

1048 
	}
}

1052 
	$ngx_maž_´oxy_up¡»am_”rÜ
(
ngx_maž_£ssiÚ_t
 *
s
)

1054 ià(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
) {

1055 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

1057 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
fd
);

1059 
	`ngx_þo£_cÚÃùiÚ
(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
);

1062 ià(
s
->
out
.
Ën
 == 0) {

1063 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

1067 
s
->
qu™
 = 1;

1068 
	`ngx_maž_£nd
(
s
->
cÚÃùiÚ
->
wr™e
);

1069 
	}
}

1073 
	$ngx_maž_´oxy_š‹º®_£rv”_”rÜ
(
ngx_maž_£ssiÚ_t
 *
s
)

1075 ià(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
) {

1076 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

1078 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
fd
);

1080 
	`ngx_þo£_cÚÃùiÚ
(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
);

1083 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

1084 
	}
}

1088 
	$ngx_maž_´oxy_þo£_£ssiÚ
(
ngx_maž_£ssiÚ_t
 *
s
)

1090 ià(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
) {

1091 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

1093 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
fd
);

1095 
	`ngx_þo£_cÚÃùiÚ
(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
);

1098 
	`ngx_maž_þo£_cÚÃùiÚ
(
s
->
cÚÃùiÚ
);

1099 
	}
}

1103 
	$ngx_maž_´oxy_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

1105 
ngx_maž_´oxy_cÚf_t
 *
pcf
;

1107 
pcf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_´oxy_cÚf_t
));

1108 ià(
pcf
 =ð
NULL
) {

1109  
NULL
;

1112 
pcf
->
’abË
 = 
NGX_CONF_UNSET
;

1113 
pcf
->
·ss_”rÜ_mes§ge
 = 
NGX_CONF_UNSET
;

1114 
pcf
->
xþ›Á
 = 
NGX_CONF_UNSET
;

1115 
pcf
->
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

1116 
pcf
->
timeout
 = 
NGX_CONF_UNSET_MSEC
;

1118  
pcf
;

1119 
	}
}

1123 
	$ngx_maž_´oxy_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

1125 
ngx_maž_´oxy_cÚf_t
 *
´ev
 = 
·»Á
;

1126 
ngx_maž_´oxy_cÚf_t
 *
cÚf
 = 
chžd
;

1128 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

1129 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
·ss_”rÜ_mes§ge
, 
´ev
->pass_error_message, 0);

1130 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
xþ›Á
, 
´ev
->xclient, 1);

1131 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
bufãr_size
, 
´ev
->buffer_size,

1132 (
size_t
è
ngx_·gesize
);

1133 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
timeout
, 
´ev
->timeout, 24 * 60 * 60000);

1135  
NGX_CONF_OK
;

1136 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_smtp_handler.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

12 
	~<ngx_maž_sm_moduË.h
>

15 
ngx_maž_sm_»sÞve_addr_hªdËr
(
ngx_»sÞv”_ùx_t
 *
ùx
);

16 
ngx_maž_sm_»sÞve_Çme
(
ngx_ev’t_t
 *
»v
);

17 
ngx_maž_sm_»sÞve_Çme_hªdËr
(
ngx_»sÞv”_ùx_t
 *
ùx
);

18 
ngx_maž_sm_g»‘šg
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

19 
ngx_maž_sm_šv®id_p–ššg
(
ngx_ev’t_t
 *
»v
);

20 
ngx_št_t
 
ngx_maž_sm_ü—‹_bufãr
(
ngx_maž_£ssiÚ_t
 *
s
,

21 
ngx_cÚÃùiÚ_t
 *
c
);

23 
ngx_št_t
 
ngx_maž_sm_h–o
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

24 
ngx_št_t
 
ngx_maž_sm_auth
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

25 
ngx_št_t
 
ngx_maž_sm_maž
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

26 
ngx_št_t
 
ngx_maž_sm_¡¬‰ls
(
ngx_maž_£ssiÚ_t
 *
s
,

27 
ngx_cÚÃùiÚ_t
 *
c
);

28 
ngx_št_t
 
ngx_maž_sm_r£t
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

29 
ngx_št_t
 
ngx_maž_sm_rýt
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

31 
ngx_št_t
 
ngx_maž_sm_disÿrd_commªd
(
ngx_maž_£ssiÚ_t
 *
s
,

32 
ngx_cÚÃùiÚ_t
 *
c
, *
”r
);

33 
ngx_maž_sm_log_»jeùed_commªd
(
ngx_maž_£ssiÚ_t
 *
s
,

34 
ngx_cÚÃùiÚ_t
 *
c
, *
”r
);

37 
u_ch¬
 
	gsm_ok
[] = "250 2.0.0 OK" 
CRLF
;

38 
u_ch¬
 
	gsm_bye
[] = "221 2.0.0 Bye" 
CRLF
;

39 
u_ch¬
 
	gsm_¡¬‰ls
[] = "220 2.0.0 S¹ TLS" 
CRLF
;

40 
u_ch¬
 
	gsm_Ãxt
[] = "334 " 
CRLF
;

41 
u_ch¬
 
	gsm_u£ºame
[] = "334 VXNlcm5hbWU6" 
CRLF
;

42 
u_ch¬
 
	gsm_·sswÜd
[] = "334 UGFzc3dvcmQ6" 
CRLF
;

43 
u_ch¬
 
	gsm_šv®id_commªd
[] = "500 5.5.1 Inv®id commªd" 
CRLF
;

44 
u_ch¬
 
	gsm_šv®id_p–ššg
[] =

45 "503 5.5.0 Im´Ý” u£ oàSMTP commªd…–ššg" 
CRLF
;

46 
u_ch¬
 
	gsm_šv®id_¬gum’t
[] = "501 5.5.4 Inv®id‡rgum’t" 
CRLF
;

47 
u_ch¬
 
	gsm_auth_»quœed
[] = "530 5.7.1 Auth’tiÿtiÚ„equœed" 
CRLF
;

48 
u_ch¬
 
	gsm_bad_£qu’û
[] = "503 5.5.1 Bad sequ’û oàcommªds" 
CRLF
;

51 
ngx_¡r_t
 
	gsm_uÇvažabË
 = 
ngx_¡ršg
("[UNAVAILABLE]");

52 
ngx_¡r_t
 
	gsm_‹mpuÇvaž
 = 
ngx_¡ršg
("[TEMPUNAVAIL]");

56 
	$ngx_maž_sm_š™_£ssiÚ
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

58 
ngx_»sÞv”_ùx_t
 *
ùx
;

59 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

61 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

63 ià(
cscf
->
»sÞv”
 =ð
NULL
) {

64 
s
->
ho¡
 = 
sm_uÇvažabË
;

65 
	`ngx_maž_sm_g»‘šg
(
s
, 
c
);

69 #ià(
NGX_HAVE_UNIX_DOMAIN
)

70 ià(
c
->
sockaddr
->
§_çmžy
 =ð
AF_UNIX
) {

71 
s
->
ho¡
 = 
sm_‹mpuÇvaž
;

72 
	`ngx_maž_sm_g»‘šg
(
s
, 
c
);

77 
c
->
log
->
aùiÚ
 = "in„esolving client‡ddress";

79 
ùx
 = 
	`ngx_»sÞve_¡¬t
(
cscf
->
»sÞv”
, 
NULL
);

80 ià(
ùx
 =ð
NULL
) {

81 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

85 
ùx
->
addr
.
sockaddr
 = 
c
->sockaddr;

86 
ùx
->
addr
.
sockËn
 = 
c
->socklen;

87 
ùx
->
hªdËr
 = 
ngx_maž_sm_»sÞve_addr_hªdËr
;

88 
ùx
->
d©a
 = 
s
;

89 
ùx
->
timeout
 = 
cscf
->
»sÞv”_timeout
;

91 ià(
	`ngx_»sÞve_addr
(
ùx
è!ð
NGX_OK
) {

92 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

94 
	}
}

98 
	$ngx_maž_sm_»sÞve_addr_hªdËr
(
ngx_»sÞv”_ùx_t
 *
ùx
)

100 
ngx_cÚÃùiÚ_t
 *
c
;

101 
ngx_maž_£ssiÚ_t
 *
s
;

103 
s
 = 
ùx
->
d©a
;

104 
c
 = 
s
->
cÚÃùiÚ
;

106 ià(
ùx
->
¡©e
) {

107 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

109 &
c
->
addr_‹xt
, 
ùx
->
¡©e
,

110 
	`ngx_»sÞv”_¡»¼Ü
(
ùx
->
¡©e
));

112 ià(
ùx
->
¡©e
 =ð
NGX_RESOLVE_NXDOMAIN
) {

113 
s
->
ho¡
 = 
sm_uÇvažabË
;

116 
s
->
ho¡
 = 
sm_‹mpuÇvaž
;

119 
	`ngx_»sÞve_addr_dÚe
(
ùx
);

121 
	`ngx_maž_sm_g»‘šg
(
s
, s->
cÚÃùiÚ
);

126 
c
->
log
->
aùiÚ
 = "in„esolving client hostname";

128 
s
->
ho¡
.
d©a
 = 
	`ngx_p¡rdup
(
c
->
poÞ
, &
ùx
->
Çme
);

129 ià(
s
->
ho¡
.
d©a
 =ð
NULL
) {

130 
	`ngx_»sÞve_addr_dÚe
(
ùx
);

131 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

135 
s
->
ho¡
.
Ën
 = 
ùx
->
Çme
.len;

137 
	`ngx_»sÞve_addr_dÚe
(
ùx
);

139 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

140 "add»s »sÞved: %V", &
s
->
ho¡
);

142 
c
->
»ad
->
hªdËr
 = 
ngx_maž_sm_»sÞve_Çme
;

144 
	`ngx_po¡_ev’t
(
c
->
»ad
, &
ngx_po¡ed_ev’ts
);

145 
	}
}

149 
	$ngx_maž_sm_»sÞve_Çme
(
ngx_ev’t_t
 *
»v
)

151 
ngx_cÚÃùiÚ_t
 *
c
;

152 
ngx_maž_£ssiÚ_t
 *
s
;

153 
ngx_»sÞv”_ùx_t
 *
ùx
;

154 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

156 
c
 = 
»v
->
d©a
;

157 
s
 = 
c
->
d©a
;

159 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

161 
ùx
 = 
	`ngx_»sÞve_¡¬t
(
cscf
->
»sÞv”
, 
NULL
);

162 ià(
ùx
 =ð
NULL
) {

163 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

167 
ùx
->
Çme
 = 
s
->
ho¡
;

168 
ùx
->
hªdËr
 = 
ngx_maž_sm_»sÞve_Çme_hªdËr
;

169 
ùx
->
d©a
 = 
s
;

170 
ùx
->
timeout
 = 
cscf
->
»sÞv”_timeout
;

172 ià(
	`ngx_»sÞve_Çme
(
ùx
è!ð
NGX_OK
) {

173 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

175 
	}
}

179 
	$ngx_maž_sm_»sÞve_Çme_hªdËr
(
ngx_»sÞv”_ùx_t
 *
ùx
)

181 
ngx_ušt_t
 
i
;

182 
ngx_cÚÃùiÚ_t
 *
c
;

183 
ngx_maž_£ssiÚ_t
 *
s
;

185 
s
 = 
ùx
->
d©a
;

186 
c
 = 
s
->
cÚÃùiÚ
;

188 ià(
ùx
->
¡©e
) {

189 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

191 &
ùx
->
Çme
, ctx->
¡©e
,

192 
	`ngx_»sÞv”_¡»¼Ü
(
ùx
->
¡©e
));

194 ià(
ùx
->
¡©e
 =ð
NGX_RESOLVE_NXDOMAIN
) {

195 
s
->
ho¡
 = 
sm_uÇvažabË
;

198 
s
->
ho¡
 = 
sm_‹mpuÇvaž
;

203 #ià(
NGX_DEBUG
)

205 
u_ch¬
 
‹xt
[
NGX_SOCKADDR_STRLEN
];

206 
ngx_¡r_t
 
addr
;

208 
addr
.
d©a
 = 
‹xt
;

210 
i
 = 0; i < 
ùx
->
Çddrs
; i++) {

211 
addr
.
Ën
 = 
	`ngx_sock_ÁÝ
(
ùx
->
addrs
[
i
].
sockaddr
,

212 
ùx
->
addrs
[
i
].
sockËn
,

213 
‹xt
, 
NGX_SOCKADDR_STRLEN
, 0);

215 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

216 "Çmwa »sÞvedØ%V", &
addr
);

221 
i
 = 0; i < 
ùx
->
Çddrs
; i++) {

222 ià(
	`ngx_cmp_sockaddr
(
ùx
->
addrs
[
i
].
sockaddr
, ctx->addrs[i].
sockËn
,

223 
c
->
sockaddr
, c->
sockËn
, 0)

224 =ð
NGX_OK
)

226 
found
;

230 
s
->
ho¡
 = 
sm_uÇvažabË
;

233 
found
:

235 
	`ngx_»sÞve_Çme_dÚe
(
ùx
);

237 
	`ngx_maž_sm_g»‘šg
(
s
, 
c
);

238 
	}
}

242 
	$ngx_maž_sm_g»‘šg
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

244 
ngx_m£c_t
 
timeout
;

245 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

246 
ngx_maž_sm_¤v_cÚf_t
 *
sscf
;

248 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

249 "sm g»‘šg fÜ \"%V\"", &
s
->
ho¡
);

251 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

252 
sscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_sm_moduË
);

254 
timeout
 = 
sscf
->
g»‘šg_d–ay
 ? sscf->g»‘šg_d–ay : 
cscf
->timeout;

255 
	`ngx_add_tim”
(
c
->
»ad
, 
timeout
);

257 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

258 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

261 ià(
sscf
->
g»‘šg_d–ay
) {

262 
c
->
»ad
->
hªdËr
 = 
ngx_maž_sm_šv®id_p–ššg
;

266 
c
->
»ad
->
hªdËr
 = 
ngx_maž_sm_š™_´ÙocÞ
;

268 
s
->
out
 = 
sscf
->
g»‘šg
;

270 
	`ngx_maž_£nd
(
c
->
wr™e
);

271 
	}
}

275 
	$ngx_maž_sm_šv®id_p–ššg
(
ngx_ev’t_t
 *
»v
)

277 
ngx_cÚÃùiÚ_t
 *
c
;

278 
ngx_maž_£ssiÚ_t
 *
s
;

279 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

280 
ngx_maž_sm_¤v_cÚf_t
 *
sscf
;

282 
c
 = 
»v
->
d©a
;

283 
s
 = 
c
->
d©a
;

285 
c
->
log
->
aùiÚ
 = "in delay…ipelining state";

287 ià(
»v
->
timedout
) {

289 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "delay greeting");

291 
»v
->
timedout
 = 0;

293 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

295 
c
->
»ad
->
hªdËr
 = 
ngx_maž_sm_š™_´ÙocÞ
;

297 
	`ngx_add_tim”
(
c
->
»ad
, 
cscf
->
timeout
);

299 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

300 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

304 
sscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_sm_moduË
);

306 
s
->
out
 = 
sscf
->
g»‘šg
;

310 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "invalid…ipelining");

312 ià(
s
->
bufãr
 =ð
NULL
) {

313 ià(
	`ngx_maž_sm_ü—‹_bufãr
(
s
, 
c
è!ð
NGX_OK
) {

318 ià(
	`ngx_maž_sm_disÿrd_commªd
(
s
, 
c
,

320 !ð
NGX_OK
)

325 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_p–ššg
);

326 
s
->
qu™
 = 1;

329 
	`ngx_maž_£nd
(
c
->
wr™e
);

330 
	}
}

334 
	$ngx_maž_sm_š™_´ÙocÞ
(
ngx_ev’t_t
 *
»v
)

336 
ngx_cÚÃùiÚ_t
 *
c
;

337 
ngx_maž_£ssiÚ_t
 *
s
;

339 
c
 = 
»v
->
d©a
;

341 
c
->
log
->
aùiÚ
 = "in‡uth state";

343 ià(
»v
->
timedout
) {

344 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

345 
c
->
timedout
 = 1;

346 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

350 
s
 = 
c
->
d©a
;

352 ià(
s
->
bufãr
 =ð
NULL
) {

353 ià(
	`ngx_maž_sm_ü—‹_bufãr
(
s
, 
c
è!ð
NGX_OK
) {

358 
s
->
maž_¡©e
 = 
ngx_sm_¡¬t
;

359 
c
->
»ad
->
hªdËr
 = 
ngx_maž_sm_auth_¡©e
;

361 
	`ngx_maž_sm_auth_¡©e
(
»v
);

362 
	}
}

365 
ngx_št_t


366 
	$ngx_maž_sm_ü—‹_bufãr
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

368 
ngx_maž_sm_¤v_cÚf_t
 *
sscf
;

370 ià(
	`ngx_¬¿y_š™
(&
s
->
¬gs
, 
c
->
poÞ
, 2, (
ngx_¡r_t
)è=ð
NGX_ERROR
) {

371 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

372  
NGX_ERROR
;

375 
sscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_sm_moduË
);

377 
s
->
bufãr
 = 
	`ngx_ü—‹_‹mp_buf
(
c
->
poÞ
, 
sscf
->
þ›Á_bufãr_size
);

378 ià(
s
->
bufãr
 =ð
NULL
) {

379 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

380  
NGX_ERROR
;

383  
NGX_OK
;

384 
	}
}

388 
	$ngx_maž_sm_auth_¡©e
(
ngx_ev’t_t
 *
»v
)

390 
ngx_št_t
 
rc
;

391 
ngx_cÚÃùiÚ_t
 *
c
;

392 
ngx_maž_£ssiÚ_t
 *
s
;

394 
c
 = 
»v
->
d©a
;

395 
s
 = 
c
->
d©a
;

397 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "smtp‡uth state");

399 ià(
»v
->
timedout
) {

400 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

401 
c
->
timedout
 = 1;

402 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

406 ià(
s
->
out
.
Ën
) {

407 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "smtp send handler busy");

408 
s
->
blocked
 = 1;

412 
s
->
blocked
 = 0;

414 
rc
 = 
	`ngx_maž_»ad_commªd
(
s
, 
c
);

416 ià(
rc
 =ð
NGX_AGAIN
 ||„ø=ð
NGX_ERROR
) {

420 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_ok
);

422 ià(
rc
 =ð
NGX_OK
) {

423 
s
->
maž_¡©e
) {

425 
ngx_sm_¡¬t
:

427 
s
->
commªd
) {

429 
NGX_SMTP_HELO
:

430 
NGX_SMTP_EHLO
:

431 
rc
 = 
	`ngx_maž_sm_h–o
(
s
, 
c
);

434 
NGX_SMTP_AUTH
:

435 
rc
 = 
	`ngx_maž_sm_auth
(
s
, 
c
);

438 
NGX_SMTP_QUIT
:

439 
s
->
qu™
 = 1;

440 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_bye
);

443 
NGX_SMTP_MAIL
:

444 
rc
 = 
	`ngx_maž_sm_maž
(
s
, 
c
);

447 
NGX_SMTP_RCPT
:

448 
rc
 = 
	`ngx_maž_sm_rýt
(
s
, 
c
);

451 
NGX_SMTP_RSET
:

452 
rc
 = 
	`ngx_maž_sm_r£t
(
s
, 
c
);

455 
NGX_SMTP_NOOP
:

458 
NGX_SMTP_STARTTLS
:

459 
rc
 = 
	`ngx_maž_sm_¡¬‰ls
(
s
, 
c
);

460 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_¡¬‰ls
);

464 
rc
 = 
NGX_MAIL_PARSE_INVALID_COMMAND
;

470 
ngx_sm_auth_logš_u£ºame
:

471 
rc
 = 
	`ngx_maž_auth_logš_u£ºame
(
s
, 
c
, 0);

473 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_·sswÜd
);

474 
s
->
maž_¡©e
 = 
ngx_sm_auth_logš_·sswÜd
;

477 
ngx_sm_auth_logš_·sswÜd
:

478 
rc
 = 
	`ngx_maž_auth_logš_·sswÜd
(
s
, 
c
);

481 
ngx_sm_auth_¶aš
:

482 
rc
 = 
	`ngx_maž_auth_¶aš
(
s
, 
c
, 0);

485 
ngx_sm_auth_üam_md5
:

486 
rc
 = 
	`ngx_maž_auth_üam_md5
(
s
, 
c
);

491 ià(
s
->
bufãr
->
pos
 < s->bufãr->
Ï¡
) {

492 
s
->
blocked
 = 1;

495 
rc
) {

497 
NGX_DONE
:

498 
	`ngx_maž_auth
(
s
, 
c
);

501 
NGX_ERROR
:

502 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

505 
NGX_MAIL_PARSE_INVALID_COMMAND
:

506 
s
->
maž_¡©e
 = 
ngx_sm_¡¬t
;

507 
s
->
¡©e
 = 0;

508 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_commªd
);

512 
NGX_OK
:

513 
s
->
¬gs
.
ÃÉs
 = 0;

515 ià(
s
->
bufãr
->
pos
 =ðs->bufãr->
Ï¡
) {

516 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

517 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

520 ià(
s
->
¡©e
) {

521 
s
->
¬g_¡¬t
 = s->
bufãr
->
pos
;

524 
	`ngx_maž_£nd
(
c
->
wr™e
);

526 
	}
}

529 
ngx_št_t


530 
	$ngx_maž_sm_h–o
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

532 
ngx_¡r_t
 *
¬g
;

533 
ngx_maž_sm_¤v_cÚf_t
 *
sscf
;

535 ià(
s
->
¬gs
.
ÃÉs
 != 1) {

536 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_¬gum’t
);

537 
s
->
¡©e
 = 0;

538  
NGX_OK
;

541 
¬g
 = 
s
->
¬gs
.
–ts
;

543 
s
->
sm_h–o
.
Ën
 = 
¬g
[0].len;

545 
s
->
sm_h–o
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, 
¬g
[0].
Ën
);

546 ià(
s
->
sm_h–o
.
d©a
 =ð
NULL
) {

547  
NGX_ERROR
;

550 
	`ngx_memýy
(
s
->
sm_h–o
.
d©a
, 
¬g
[0].d©a,‡rg[0].
Ën
);

552 
	`ngx_¡r_nuÎ
(&
s
->
sm_äom
);

553 
	`ngx_¡r_nuÎ
(&
s
->
sm_to
);

555 
sscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_sm_moduË
);

557 ià(
s
->
commªd
 =ð
NGX_SMTP_HELO
) {

558 
s
->
out
 = 
sscf
->
£rv”_Çme
;

561 
s
->
esm
 = 1;

563 #ià(
NGX_MAIL_SSL
)

565 ià(
c
->
s¦
 =ð
NULL
) {

566 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

568 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

570 ià(
s¦cf
->
¡¬‰ls
 =ð
NGX_MAIL_STARTTLS_ON
) {

571 
s
->
out
 = 
sscf
->
¡¬‰ls_ÿ·bž™y
;

572  
NGX_OK
;

575 ià(
s¦cf
->
¡¬‰ls
 =ð
NGX_MAIL_STARTTLS_ONLY
) {

576 
s
->
out
 = 
sscf
->
¡¬‰ls_Úly_ÿ·bž™y
;

577  
NGX_OK
;

582 
s
->
out
 = 
sscf
->
ÿ·bž™y
;

585  
NGX_OK
;

586 
	}
}

589 
ngx_št_t


590 
	$ngx_maž_sm_auth
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

592 
ngx_št_t
 
rc
;

593 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

594 
ngx_maž_sm_¤v_cÚf_t
 *
sscf
;

596 #ià(
NGX_MAIL_SSL
)

597 ià(
	`ngx_maž_¡¬‰ls_Úly
(
s
, 
c
)) {

598  
NGX_MAIL_PARSE_INVALID_COMMAND
;

602 ià(
s
->
¬gs
.
ÃÉs
 == 0) {

603 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_¬gum’t
);

604 
s
->
¡©e
 = 0;

605  
NGX_OK
;

608 
rc
 = 
	`ngx_maž_auth_·r£
(
s
, 
c
);

610 
rc
) {

612 
NGX_MAIL_AUTH_LOGIN
:

614 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_u£ºame
);

615 
s
->
maž_¡©e
 = 
ngx_sm_auth_logš_u£ºame
;

617  
NGX_OK
;

619 
NGX_MAIL_AUTH_LOGIN_USERNAME
:

621 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_·sswÜd
);

622 
s
->
maž_¡©e
 = 
ngx_sm_auth_logš_·sswÜd
;

624  
	`ngx_maž_auth_logš_u£ºame
(
s
, 
c
, 1);

626 
NGX_MAIL_AUTH_PLAIN
:

628 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_Ãxt
);

629 
s
->
maž_¡©e
 = 
ngx_sm_auth_¶aš
;

631  
NGX_OK
;

633 
NGX_MAIL_AUTH_CRAM_MD5
:

635 
sscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_sm_moduË
);

637 ià(!(
sscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
)) {

638  
NGX_MAIL_PARSE_INVALID_COMMAND
;

641 ià(
s
->
§É
.
d©a
 =ð
NULL
) {

642 
cscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_cÜe_moduË
);

644 ià(
	`ngx_maž_§É
(
s
, 
c
, 
cscf
è!ð
NGX_OK
) {

645  
NGX_ERROR
;

649 ià(
	`ngx_maž_auth_üam_md5_§É
(
s
, 
c
, "334 ", 4è=ð
NGX_OK
) {

650 
s
->
maž_¡©e
 = 
ngx_sm_auth_üam_md5
;

651  
NGX_OK
;

654  
NGX_ERROR
;

657  
rc
;

658 
	}
}

661 
ngx_št_t


662 
	$ngx_maž_sm_maž
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

664 
ngx_¡r_t
 *
¬g
, 
cmd
;

665 
ngx_maž_sm_¤v_cÚf_t
 *
sscf
;

667 
sscf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_sm_moduË
);

669 ià(!(
sscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_NONE_ENABLED
)) {

670 
	`ngx_maž_sm_log_»jeùed_commªd
(
s
, 
c
, "client was„ejected: \"%V\"");

671 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_auth_»quœed
);

672  
NGX_OK
;

677 ià(
s
->
sm_äom
.
Ën
) {

678 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_bad_£qu’û
);

679  
NGX_OK
;

682 ià(
s
->
¬gs
.
ÃÉs
 == 0) {

683 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_¬gum’t
);

684  
NGX_OK
;

687 
¬g
 = 
s
->
¬gs
.
–ts
;

688 
¬g
 +ð
s
->
¬gs
.
ÃÉs
 - 1;

690 
cmd
.
Ën
 = 
¬g
->
d©a
 +‡rg->ËÀ- 
s
->cmd.data;

691 
cmd
.
d©a
 = 
s
->cmd.data;

693 
s
->
sm_äom
.
Ën
 = 
cmd
.len;

695 
s
->
sm_äom
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, 
cmd
.
Ën
);

696 ià(
s
->
sm_äom
.
d©a
 =ð
NULL
) {

697  
NGX_ERROR
;

700 
	`ngx_memýy
(
s
->
sm_äom
.
d©a
, 
cmd
.d©a, cmd.
Ën
);

702 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

703 "sm maž from:\"%V\"", &
s
->
sm_äom
);

705 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_ok
);

707  
NGX_OK
;

708 
	}
}

711 
ngx_št_t


712 
	$ngx_maž_sm_rýt
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

714 
ngx_¡r_t
 *
¬g
, 
cmd
;

716 ià(
s
->
sm_äom
.
Ën
 == 0) {

717 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_bad_£qu’û
);

718  
NGX_OK
;

721 ià(
s
->
¬gs
.
ÃÉs
 == 0) {

722 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_¬gum’t
);

723  
NGX_OK
;

726 
¬g
 = 
s
->
¬gs
.
–ts
;

727 
¬g
 +ð
s
->
¬gs
.
ÃÉs
 - 1;

729 
cmd
.
Ën
 = 
¬g
->
d©a
 +‡rg->ËÀ- 
s
->cmd.data;

730 
cmd
.
d©a
 = 
s
->cmd.data;

732 
s
->
sm_to
.
Ën
 = 
cmd
.len;

734 
s
->
sm_to
.
d©a
 = 
	`ngx_²®loc
(
c
->
poÞ
, 
cmd
.
Ën
);

735 ià(
s
->
sm_to
.
d©a
 =ð
NULL
) {

736  
NGX_ERROR
;

739 
	`ngx_memýy
(
s
->
sm_to
.
d©a
, 
cmd
.d©a, cmd.
Ën
);

741 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

742 "sm„ýˆto:\"%V\"", &
s
->
sm_to
);

744 
s
->
auth_m‘hod
 = 
NGX_MAIL_AUTH_NONE
;

746  
NGX_DONE
;

747 
	}
}

750 
ngx_št_t


751 
	$ngx_maž_sm_r£t
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

753 
	`ngx_¡r_nuÎ
(&
s
->
sm_äom
);

754 
	`ngx_¡r_nuÎ
(&
s
->
sm_to
);

755 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_ok
);

757  
NGX_OK
;

758 
	}
}

761 
ngx_št_t


762 
	$ngx_maž_sm_¡¬‰ls
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

764 #ià(
NGX_MAIL_SSL
)

765 
ngx_maž_s¦_cÚf_t
 *
s¦cf
;

767 ià(
c
->
s¦
 =ð
NULL
) {

768 
s¦cf
 = 
	`ngx_maž_g‘_moduË_¤v_cÚf
(
s
, 
ngx_maž_s¦_moduË
);

769 ià(
s¦cf
->
¡¬‰ls
) {

776 
	`ngx_¡r_nuÎ
(&
s
->
sm_h–o
);

777 
	`ngx_¡r_nuÎ
(&
s
->
sm_äom
);

778 
	`ngx_¡r_nuÎ
(&
s
->
sm_to
);

780 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

781 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

783 
c
->
»ad
->
hªdËr
 = 
ngx_maž_¡¬‰ls_hªdËr
;

784  
NGX_OK
;

790  
NGX_MAIL_PARSE_INVALID_COMMAND
;

791 
	}
}

794 
ngx_št_t


795 
	$ngx_maž_sm_disÿrd_commªd
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

796 *
”r
)

798 
ssize_t
 
n
;

800 
n
 = 
c
->
	`»cv
(c, 
s
->
bufãr
->
Ï¡
, s->bufãr->
’d
 - s->buffer->last);

802 ià(
n
 =ð
NGX_ERROR
 ||‚ == 0) {

803 
	`ngx_maž_þo£_cÚÃùiÚ
(
c
);

804  
NGX_ERROR
;

807 ià(
n
 > 0) {

808 
s
->
bufãr
->
Ï¡
 +ð
n
;

811 ià(
n
 =ð
NGX_AGAIN
) {

812 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ð
NGX_OK
) {

813 
	`ngx_maž_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

814  
NGX_ERROR
;

817  
NGX_AGAIN
;

820 
	`ngx_maž_sm_log_»jeùed_commªd
(
s
, 
c
, 
”r
);

822 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

823 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

825  
NGX_OK
;

826 
	}
}

830 
	$ngx_maž_sm_log_»jeùed_commªd
(
ngx_maž_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

831 *
”r
)

833 
u_ch¬
 
ch
;

834 
ngx_¡r_t
 
cmd
;

835 
ngx_ušt_t
 
i
;

837 ià(
c
->
log
->
log_Ëv–
 < 
NGX_LOG_INFO
) {

841 
cmd
.
Ën
 = 
s
->
bufãr
->
Ï¡
 - s->bufãr->
¡¬t
;

842 
cmd
.
d©a
 = 
s
->
bufãr
->
¡¬t
;

844 
i
 = 0; i < 
cmd
.
Ën
; i++) {

845 
ch
 = 
cmd
.
d©a
[
i
];

847 ià(
ch
 !ð
CR
 && ch !ð
LF
) {

851 
cmd
.
d©a
[
i
] = '_';

854 
cmd
.
Ën
 = 
i
;

856 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, 
”r
, &
cmd
);

857 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_smtp_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_maž.h
>

12 
	~<ngx_maž_sm_moduË.h
>

15 *
ngx_maž_sm_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

16 *
ngx_maž_sm_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

17 *
chžd
);

20 
ngx_cÚf_b™mask_t
 
	gngx_maž_sm_auth_m‘hods
[] = {

21 { 
ngx_¡ršg
("¶aš"), 
NGX_MAIL_AUTH_PLAIN_ENABLED
 },

22 { 
ngx_¡ršg
("logš"), 
NGX_MAIL_AUTH_LOGIN_ENABLED
 },

23 { 
ngx_¡ršg
("üam-md5"), 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
 },

24 { 
ngx_¡ršg
("nÚe"), 
NGX_MAIL_AUTH_NONE_ENABLED
 },

25 { 
ngx_nuÎ_¡ršg
, 0 }

29 
ngx_¡r_t
 
	gngx_maž_sm_auth_m‘hods_Çmes
[] = {

30 
ngx_¡ršg
("PLAIN"),

31 
ngx_¡ršg
("LOGIN"),

32 
ngx_nuÎ_¡ršg
,

33 
ngx_¡ršg
("CRAM-MD5"),

34 
ngx_nuÎ_¡ršg


38 
ngx_maž_´ÙocÞ_t
 
	gngx_maž_sm_´ÙocÞ
 = {

39 
ngx_¡ršg
("smtp"),

41 
NGX_MAIL_SMTP_PROTOCOL
,

43 
ngx_maž_sm_š™_£ssiÚ
,

44 
ngx_maž_sm_š™_´ÙocÞ
,

45 
ngx_maž_sm_·r£_commªd
,

46 
ngx_maž_sm_auth_¡©e
,

48 
ngx_¡ršg
("451 4.3.2 IÁ”ÇÈ£rv”ƒ¼Ü" 
CRLF
)

52 
ngx_commªd_t
 
	gngx_maž_sm_commªds
[] = {

54 { 
ngx_¡ršg
("smtp_client_buffer"),

55 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

56 
ngx_cÚf_£t_size_¦Ù
,

57 
NGX_MAIL_SRV_CONF_OFFSET
,

58 
off£tof
(
ngx_maž_sm_¤v_cÚf_t
, 
þ›Á_bufãr_size
),

59 
NULL
 },

61 { 
ngx_¡ršg
("smtp_greeting_delay"),

62 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

63 
ngx_cÚf_£t_m£c_¦Ù
,

64 
NGX_MAIL_SRV_CONF_OFFSET
,

65 
off£tof
(
ngx_maž_sm_¤v_cÚf_t
, 
g»‘šg_d–ay
),

66 
NULL
 },

68 { 
ngx_¡ršg
("smtp_capabilities"),

69 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

70 
ngx_maž_ÿ·bž™›s
,

71 
NGX_MAIL_SRV_CONF_OFFSET
,

72 
off£tof
(
ngx_maž_sm_¤v_cÚf_t
, 
ÿ·bž™›s
),

73 
NULL
 },

75 { 
ngx_¡ršg
("smtp_auth"),

76 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

77 
ngx_cÚf_£t_b™mask_¦Ù
,

78 
NGX_MAIL_SRV_CONF_OFFSET
,

79 
off£tof
(
ngx_maž_sm_¤v_cÚf_t
, 
auth_m‘hods
),

80 &
ngx_maž_sm_auth_m‘hods
 },

82 
ngx_nuÎ_commªd


86 
ngx_maž_moduË_t
 
	gngx_maž_sm_moduË_ùx
 = {

87 &
ngx_maž_sm_´ÙocÞ
,

89 
NULL
,

90 
NULL
,

92 
ngx_maž_sm_ü—‹_¤v_cÚf
,

93 
ngx_maž_sm_m”ge_¤v_cÚf


97 
ngx_moduË_t
 
	gngx_maž_sm_moduË
 = {

98 
NGX_MODULE_V1
,

99 &
ngx_maž_sm_moduË_ùx
,

100 
ngx_maž_sm_commªds
,

101 
NGX_MAIL_MODULE
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NGX_MODULE_V1_PADDING


114 
	$ngx_maž_sm_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

116 
ngx_maž_sm_¤v_cÚf_t
 *
sscf
;

118 
sscf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_sm_¤v_cÚf_t
));

119 ià(
sscf
 =ð
NULL
) {

120  
NULL
;

123 
sscf
->
þ›Á_bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

124 
sscf
->
g»‘šg_d–ay
 = 
NGX_CONF_UNSET_MSEC
;

126 ià(
	`ngx_¬¿y_š™
(&
sscf
->
ÿ·bž™›s
, 
cf
->
poÞ
, 4, (
ngx_¡r_t
))

127 !ð
NGX_OK
)

129  
NULL
;

132  
sscf
;

133 
	}
}

137 
	$ngx_maž_sm_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

139 
ngx_maž_sm_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

140 
ngx_maž_sm_¤v_cÚf_t
 *
cÚf
 = 
chžd
;

142 
u_ch¬
 *
p
, *
auth
, *
Ï¡
;

143 
size_t
 
size
;

144 
ngx_¡r_t
 *
c
;

145 
ngx_ušt_t
 
i
, 
m
, 
auth_’abËd
;

146 
ngx_maž_cÜe_¤v_cÚf_t
 *
cscf
;

148 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
þ›Á_bufãr_size
,

149 
´ev
->
þ›Á_bufãr_size
,

150 (
size_t
è
ngx_·gesize
);

152 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
g»‘šg_d–ay
,

153 
´ev
->
g»‘šg_d–ay
, 0);

155 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
auth_m‘hods
,

156 
´ev
->
auth_m‘hods
,

157 (
NGX_CONF_BITMASK_SET


158 |
NGX_MAIL_AUTH_PLAIN_ENABLED


159 |
NGX_MAIL_AUTH_LOGIN_ENABLED
));

162 
cscf
 = 
	`ngx_maž_cÚf_g‘_moduË_¤v_cÚf
(
cf
, 
ngx_maž_cÜe_moduË
);

164 
size
 = ("220 ESMTP„—dy" 
CRLF
è- 1 + 
cscf
->
£rv”_Çme
.
Ën
;

166 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

167 ià(
p
 =ð
NULL
) {

168  
NGX_CONF_ERROR
;

171 
cÚf
->
g»‘šg
.
Ën
 = 
size
;

172 
cÚf
->
g»‘šg
.
d©a
 = 
p
;

174 *
p
++ = '2'; *p++ = '2'; *p++ = '0'; *p++ = ' ';

175 
p
 = 
	`ngx_ýymem
Õ, 
cscf
->
£rv”_Çme
.
d©a
, cscf->£rv”_Çme.
Ën
);

176 
	`ngx_memýy
(
p
, " ESMTP„—dy" 
CRLF
, (" ESMTP„eady" CRLF) - 1);

179 
size
 = ("250 " 
CRLF
è- 1 + 
cscf
->
£rv”_Çme
.
Ën
;

181 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

182 ià(
p
 =ð
NULL
) {

183  
NGX_CONF_ERROR
;

186 
cÚf
->
£rv”_Çme
.
Ën
 = 
size
;

187 
cÚf
->
£rv”_Çme
.
d©a
 = 
p
;

189 *
p
++ = '2'; *p++ = '5'; *p++ = '0'; *p++ = ' ';

190 
p
 = 
	`ngx_ýymem
Õ, 
cscf
->
£rv”_Çme
.
d©a
, cscf->£rv”_Çme.
Ën
);

191 *
p
++ = 
CR
; *°ð
LF
;

194 ià(
cÚf
->
ÿ·bž™›s
.
ÃÉs
 == 0) {

195 
cÚf
->
ÿ·bž™›s
 = 
´ev
->capabilities;

198 
size
 = ("250-"è- 1 + 
cscf
->
£rv”_Çme
.
Ën
 + (
CRLF
) - 1;

200 
c
 = 
cÚf
->
ÿ·bž™›s
.
–ts
;

201 
i
 = 0; i < 
cÚf
->
ÿ·bž™›s
.
ÃÉs
; i++) {

202 
size
 +ð("250 "è- 1 + 
c
[
i
].
Ën
 + (
CRLF
) - 1;

205 
auth_’abËd
 = 0;

207 
m
 = 
NGX_MAIL_AUTH_PLAIN_ENABLED
, 
i
 = 0;

208 
m
 <ð
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
;

209 
m
 <<ð1, 
i
++)

211 ià(
m
 & 
cÚf
->
auth_m‘hods
) {

212 
size
 +ð1 + 
ngx_maž_sm_auth_m‘hods_Çmes
[
i
].
Ën
;

213 
auth_’abËd
 = 1;

217 ià(
auth_’abËd
) {

218 
size
 +ð("250 AUTH"è- 1 + (
CRLF
) - 1;

221 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

222 ià(
p
 =ð
NULL
) {

223  
NGX_CONF_ERROR
;

226 
cÚf
->
ÿ·bž™y
.
Ën
 = 
size
;

227 
cÚf
->
ÿ·bž™y
.
d©a
 = 
p
;

229 
Ï¡
 = 
p
;

231 *
p
++ = '2'; *p++ = '5'; *p++ = '0'; *p++ = '-';

232 
p
 = 
	`ngx_ýymem
Õ, 
cscf
->
£rv”_Çme
.
d©a
, cscf->£rv”_Çme.
Ën
);

233 *
p
++ = 
CR
; *p++ = 
LF
;

235 
i
 = 0; i < 
cÚf
->
ÿ·bž™›s
.
ÃÉs
; i++) {

236 
Ï¡
 = 
p
;

237 *
p
++ = '2'; *p++ = '5'; *p++ = '0'; *p++ = '-';

238 
p
 = 
	`ngx_ýymem
Õ, 
c
[
i
].
d©a
, c[i].
Ën
);

239 *
p
++ = 
CR
; *p++ = 
LF
;

242 
auth
 = 
p
;

244 ià(
auth_’abËd
) {

245 
Ï¡
 = 
p
;

247 *
p
++ = '2'; *p++ = '5'; *p++ = '0'; *p++ = ' ';

248 *
p
++ = 'A'; *p++ = 'U'; *p++ = 'T'; *p++ = 'H';

250 
m
 = 
NGX_MAIL_AUTH_PLAIN_ENABLED
, 
i
 = 0;

251 
m
 <ð
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
;

252 
m
 <<ð1, 
i
++)

254 ià(
m
 & 
cÚf
->
auth_m‘hods
) {

255 *
p
++ = ' ';

256 
p
 = 
	`ngx_ýymem
Õ, 
ngx_maž_sm_auth_m‘hods_Çmes
[
i
].
d©a
,

257 
ngx_maž_sm_auth_m‘hods_Çmes
[
i
].
Ën
);

261 *
p
++ = 
CR
; *°ð
LF
;

264 
Ï¡
[3] = ' ';

267 
size
 +ð("250 STARTTLS" 
CRLF
) - 1;

269 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

270 ià(
p
 =ð
NULL
) {

271  
NGX_CONF_ERROR
;

274 
cÚf
->
¡¬‰ls_ÿ·bž™y
.
Ën
 = 
size
;

275 
cÚf
->
¡¬‰ls_ÿ·bž™y
.
d©a
 = 
p
;

277 
p
 = 
	`ngx_ýymem
Õ, 
cÚf
->
ÿ·bž™y
.
d©a
, cÚf->ÿ·bž™y.
Ën
);

279 
p
 = 
	`ngx_ýymem
Õ, "250 STARTTLS" 
CRLF
, ("250 STARTTLS" CRLF) - 1);

281 
p
 = 
cÚf
->
¡¬‰ls_ÿ·bž™y
.
d©a


282 + (
Ï¡
 - 
cÚf
->
ÿ·bž™y
.
d©a
) + 3;

283 *
p
 = '-';

285 
size
 = (
auth
 - 
cÚf
->
ÿ·bž™y
.
d©a
)

286 + ("250 STARTTLS" 
CRLF
) - 1;

288 
p
 = 
	`ngx_²®loc
(
cf
->
poÞ
, 
size
);

289 ià(
p
 =ð
NULL
) {

290  
NGX_CONF_ERROR
;

293 
cÚf
->
¡¬‰ls_Úly_ÿ·bž™y
.
Ën
 = 
size
;

294 
cÚf
->
¡¬‰ls_Úly_ÿ·bž™y
.
d©a
 = 
p
;

296 
p
 = 
	`ngx_ýymem
Õ, 
cÚf
->
ÿ·bž™y
.
d©a
, 
auth
 - conf->capability.data);

298 
	`ngx_memýy
(
p
, "250 STARTTLS" 
CRLF
, ("250 STARTTLS" CRLF) - 1);

300 ià(
Ï¡
 < 
auth
) {

301 
p
 = 
cÚf
->
¡¬‰ls_Úly_ÿ·bž™y
.
d©a


302 + (
Ï¡
 - 
cÚf
->
ÿ·bž™y
.
d©a
) + 3;

303 *
p
 = '-';

306  
NGX_CONF_OK
;

307 
	}
}

	@/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_ssl_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_maž.h
>

13 
	#NGX_DEFAULT_CIPHERS
 "HIGH:!aNULL:!MD5"

	)

14 
	#NGX_DEFAULT_ECDH_CURVE
 "´ime256v1"

	)

17 *
ngx_maž_s¦_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

18 *
ngx_maž_s¦_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
);

20 *
ngx_maž_s¦_’abË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

21 *
cÚf
);

22 *
ngx_maž_s¦_¡¬‰ls
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

23 *
cÚf
);

24 *
ngx_maž_s¦_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

25 *
cÚf
);

26 *
ngx_maž_s¦_£ssiÚ_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

27 *
cÚf
);

30 
ngx_cÚf_’um_t
 
	gngx_maž_¡¬‰ls_¡©e
[] = {

31 { 
ngx_¡ršg
("off"), 
NGX_MAIL_STARTTLS_OFF
 },

32 { 
ngx_¡ršg
("Ú"), 
NGX_MAIL_STARTTLS_ON
 },

33 { 
ngx_¡ršg
("Úly"), 
NGX_MAIL_STARTTLS_ONLY
 },

34 { 
ngx_nuÎ_¡ršg
, 0 }

39 
ngx_cÚf_b™mask_t
 
	gngx_maž_s¦_´ÙocÞs
[] = {

40 { 
ngx_¡ršg
("SSLv2"), 
NGX_SSL_SSLv2
 },

41 { 
ngx_¡ršg
("SSLv3"), 
NGX_SSL_SSLv3
 },

42 { 
ngx_¡ršg
("TLSv1"), 
NGX_SSL_TLSv1
 },

43 { 
ngx_¡ršg
("TLSv1.1"), 
NGX_SSL_TLSv1_1
 },

44 { 
ngx_¡ršg
("TLSv1.2"), 
NGX_SSL_TLSv1_2
 },

45 { 
ngx_nuÎ_¡ršg
, 0 }

49 
ngx_commªd_t
 
	gngx_maž_s¦_commªds
[] = {

51 { 
ngx_¡ršg
("ssl"),

52 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

53 
ngx_maž_s¦_’abË
,

54 
NGX_MAIL_SRV_CONF_OFFSET
,

55 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
’abË
),

56 
NULL
 },

58 { 
ngx_¡ršg
("starttls"),

59 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

60 
ngx_maž_s¦_¡¬‰ls
,

61 
NGX_MAIL_SRV_CONF_OFFSET
,

62 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
¡¬‰ls
),

63 
ngx_maž_¡¬‰ls_¡©e
 },

65 { 
ngx_¡ršg
("ssl_certificate"),

66 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

67 
ngx_cÚf_£t_¡r_¦Ù
,

68 
NGX_MAIL_SRV_CONF_OFFSET
,

69 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
û¹ifiÿ‹
),

70 
NULL
 },

72 { 
ngx_¡ršg
("ssl_certificate_key"),

73 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

74 
ngx_cÚf_£t_¡r_¦Ù
,

75 
NGX_MAIL_SRV_CONF_OFFSET
,

76 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
û¹ifiÿ‹_key
),

77 
NULL
 },

79 { 
ngx_¡ršg
("ssl_password_file"),

80 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

81 
ngx_maž_s¦_·sswÜd_fže
,

82 
NGX_MAIL_SRV_CONF_OFFSET
,

84 
NULL
 },

86 { 
ngx_¡ršg
("ssl_dhparam"),

87 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

88 
ngx_cÚf_£t_¡r_¦Ù
,

89 
NGX_MAIL_SRV_CONF_OFFSET
,

90 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
dh·¿m
),

91 
NULL
 },

93 { 
ngx_¡ršg
("ssl_ecdh_curve"),

94 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

95 
ngx_cÚf_£t_¡r_¦Ù
,

96 
NGX_MAIL_SRV_CONF_OFFSET
,

97 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
ecdh_curve
),

98 
NULL
 },

100 { 
ngx_¡ršg
("ssl_protocols"),

101 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

102 
ngx_cÚf_£t_b™mask_¦Ù
,

103 
NGX_MAIL_SRV_CONF_OFFSET
,

104 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
´ÙocÞs
),

105 &
ngx_maž_s¦_´ÙocÞs
 },

107 { 
ngx_¡ršg
("ssl_ciphers"),

108 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

109 
ngx_cÚf_£t_¡r_¦Ù
,

110 
NGX_MAIL_SRV_CONF_OFFSET
,

111 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
ch”s
),

112 
NULL
 },

114 { 
ngx_¡ršg
("ssl_prefer_server_ciphers"),

115 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

116 
ngx_cÚf_£t_æag_¦Ù
,

117 
NGX_MAIL_SRV_CONF_OFFSET
,

118 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
´eãr_£rv”_ch”s
),

119 
NULL
 },

121 { 
ngx_¡ršg
("ssl_session_cache"),

122 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE12
,

123 
ngx_maž_s¦_£ssiÚ_ÿche
,

124 
NGX_MAIL_SRV_CONF_OFFSET
,

126 
NULL
 },

128 { 
ngx_¡ršg
("ssl_session_tickets"),

129 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

130 
ngx_cÚf_£t_æag_¦Ù
,

131 
NGX_MAIL_SRV_CONF_OFFSET
,

132 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
£ssiÚ_tick‘s
),

133 
NULL
 },

135 { 
ngx_¡ršg
("ssl_session_ticket_key"),

136 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

137 
ngx_cÚf_£t_¡r_¬¿y_¦Ù
,

138 
NGX_MAIL_SRV_CONF_OFFSET
,

139 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
£ssiÚ_tick‘_keys
),

140 
NULL
 },

142 { 
ngx_¡ršg
("ssl_session_timeout"),

143 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

144 
ngx_cÚf_£t_£c_¦Ù
,

145 
NGX_MAIL_SRV_CONF_OFFSET
,

146 
off£tof
(
ngx_maž_s¦_cÚf_t
, 
£ssiÚ_timeout
),

147 
NULL
 },

149 
ngx_nuÎ_commªd


153 
ngx_maž_moduË_t
 
	gngx_maž_s¦_moduË_ùx
 = {

154 
NULL
,

156 
NULL
,

157 
NULL
,

159 
ngx_maž_s¦_ü—‹_cÚf
,

160 
ngx_maž_s¦_m”ge_cÚf


164 
ngx_moduË_t
 
	gngx_maž_s¦_moduË
 = {

165 
NGX_MODULE_V1
,

166 &
ngx_maž_s¦_moduË_ùx
,

167 
ngx_maž_s¦_commªds
,

168 
NGX_MAIL_MODULE
,

169 
NULL
,

170 
NULL
,

171 
NULL
,

172 
NULL
,

173 
NULL
,

174 
NULL
,

175 
NULL
,

176 
NGX_MODULE_V1_PADDING


180 
ngx_¡r_t
 
	gngx_maž_s¦_£ss_id_ùx
 = 
ngx_¡ršg
("MAIL");

184 
	$ngx_maž_s¦_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

186 
ngx_maž_s¦_cÚf_t
 *
scf
;

188 
scf
 = 
	`ngx_pÿÎoc
(
cf
->
poÞ
, (
ngx_maž_s¦_cÚf_t
));

189 ià(
scf
 =ð
NULL
) {

190  
NULL
;

205 
scf
->
’abË
 = 
NGX_CONF_UNSET
;

206 
scf
->
¡¬‰ls
 = 
NGX_CONF_UNSET_UINT
;

207 
scf
->
·sswÜds
 = 
NGX_CONF_UNSET_PTR
;

208 
scf
->
´eãr_£rv”_ch”s
 = 
NGX_CONF_UNSET
;

209 
scf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_CONF_UNSET
;

210 
scf
->
£ssiÚ_timeout
 = 
NGX_CONF_UNSET
;

211 
scf
->
£ssiÚ_tick‘s
 = 
NGX_CONF_UNSET
;

212 
scf
->
£ssiÚ_tick‘_keys
 = 
NGX_CONF_UNSET_PTR
;

214  
scf
;

215 
	}
}

219 
	$ngx_maž_s¦_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

221 
ngx_maž_s¦_cÚf_t
 *
´ev
 = 
·»Á
;

222 
ngx_maž_s¦_cÚf_t
 *
cÚf
 = 
chžd
;

224 *
mode
;

225 
ngx_poÞ_þ—nup_t
 *
þn
;

227 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

228 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
¡¬‰ls
, 
´ev
->starttls,

229 
NGX_MAIL_STARTTLS_OFF
);

231 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£ssiÚ_timeout
,

232 
´ev
->
£ssiÚ_timeout
, 300);

234 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
´eãr_£rv”_ch”s
,

235 
´ev
->
´eãr_£rv”_ch”s
, 0);

237 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
´ÙocÞs
, 
´ev
->protocols,

238 (
NGX_CONF_BITMASK_SET
|
NGX_SSL_SSLv3
|
NGX_SSL_TLSv1


239 |
NGX_SSL_TLSv1_1
|
NGX_SSL_TLSv1_2
));

241 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
û¹ifiÿ‹
, 
´ev
->certificate, "");

242 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
û¹ifiÿ‹_key
, 
´ev
->certificate_key, "");

244 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
·sswÜds
, 
´ev
->·sswÜds, 
NULL
);

246 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
dh·¿m
, 
´ev
->dhparam, "");

248 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
ecdh_curve
, 
´ev
->ecdh_curve,

249 
NGX_DEFAULT_ECDH_CURVE
);

251 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
ch”s
, 
´ev
->ch”s, 
NGX_DEFAULT_CIPHERS
);

254 
cÚf
->
s¦
.
log
 = 
cf
->log;

256 ià(
cÚf
->
’abË
) {

257 
mode
 = "ssl";

259 } ià(
cÚf
->
¡¬‰ls
 !ð
NGX_MAIL_STARTTLS_OFF
) {

260 
mode
 = "starttls";

263 
mode
 = "";

266 ià(
cÚf
->
fže
 =ð
NULL
) {

267 
cÚf
->
fže
 = 
´ev
->file;

268 
cÚf
->
lše
 = 
´ev
->line;

271 ià(*
mode
) {

273 ià(
cÚf
->
û¹ifiÿ‹
.
Ën
 == 0) {

274 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

277 
mode
, 
cÚf
->
fže
, cÚf->
lše
);

278  
NGX_CONF_ERROR
;

281 ià(
cÚf
->
û¹ifiÿ‹_key
.
Ën
 == 0) {

282 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

285 
mode
, 
cÚf
->
fže
, cÚf->
lše
);

286  
NGX_CONF_ERROR
;

291 ià(
cÚf
->
û¹ifiÿ‹
.
Ën
 == 0) {

292  
NGX_CONF_OK
;

295 ià(
cÚf
->
û¹ifiÿ‹_key
.
Ën
 == 0) {

296 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

299 &
cÚf
->
û¹ifiÿ‹
);

300  
NGX_CONF_ERROR
;

304 ià(
	`ngx_s¦_ü—‹
(&
cÚf
->
s¦
, cÚf->
´ÙocÞs
, 
NULL
è!ð
NGX_OK
) {

305  
NGX_CONF_ERROR
;

308 
þn
 = 
	`ngx_poÞ_þ—nup_add
(
cf
->
poÞ
, 0);

309 ià(
þn
 =ð
NULL
) {

310  
NGX_CONF_ERROR
;

313 
þn
->
hªdËr
 = 
ngx_s¦_þ—nup_ùx
;

314 
þn
->
d©a
 = &
cÚf
->
s¦
;

316 ià(
	`ngx_s¦_û¹ifiÿ‹
(
cf
, &
cÚf
->
s¦
, &cÚf->
û¹ifiÿ‹
,

317 &
cÚf
->
û¹ifiÿ‹_key
, cÚf->
·sswÜds
)

318 !ð
NGX_OK
)

320  
NGX_CONF_ERROR
;

323 ià(
	`SSL_CTX_£t_ch”_li¡
(
cÚf
->
s¦
.
ùx
,

324 (cÚ¡ *è
cÚf
->
ch”s
.
d©a
)

327 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

329 &
cÚf
->
ch”s
);

330  
NGX_CONF_ERROR
;

333 ià(
cÚf
->
´eãr_£rv”_ch”s
) {

334 
	`SSL_CTX_£t_ÝtiÚs
(
cÚf
->
s¦
.
ùx
, 
SSL_OP_CIPHER_SERVER_PREFERENCE
);

337 
	`SSL_CTX_£t_tmp_r§_ÿÎback
(
cÚf
->
s¦
.
ùx
, 
ngx_s¦_r§512_key_ÿÎback
);

339 ià(
	`ngx_s¦_dh·¿m
(
cf
, &
cÚf
->
s¦
, &cÚf->
dh·¿m
è!ð
NGX_OK
) {

340  
NGX_CONF_ERROR
;

343 ià(
	`ngx_s¦_ecdh_curve
(
cf
, &
cÚf
->
s¦
, &cÚf->
ecdh_curve
è!ð
NGX_OK
) {

344  
NGX_CONF_ERROR
;

347 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
bužtš_£ssiÚ_ÿche
,

348 
´ev
->
bužtš_£ssiÚ_ÿche
, 
NGX_SSL_NONE_SCACHE
);

350 ià(
cÚf
->
shm_zÚe
 =ð
NULL
) {

351 
cÚf
->
shm_zÚe
 = 
´ev
->shm_zone;

354 ià(
	`ngx_s¦_£ssiÚ_ÿche
(&
cÚf
->
s¦
, &
ngx_maž_s¦_£ss_id_ùx
,

355 
cÚf
->
bužtš_£ssiÚ_ÿche
,

356 
cÚf
->
shm_zÚe
, cÚf->
£ssiÚ_timeout
)

357 !ð
NGX_OK
)

359  
NGX_CONF_ERROR
;

362 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£ssiÚ_tick‘s
,

363 
´ev
->
£ssiÚ_tick‘s
, 1);

365 #ifdeà
SSL_OP_NO_TICKET


366 ià(!
cÚf
->
£ssiÚ_tick‘s
) {

367 
	`SSL_CTX_£t_ÝtiÚs
(
cÚf
->
s¦
.
ùx
, 
SSL_OP_NO_TICKET
);

371 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
£ssiÚ_tick‘_keys
,

372 
´ev
->
£ssiÚ_tick‘_keys
, 
NULL
);

374 ià(
	`ngx_s¦_£ssiÚ_tick‘_keys
(
cf
, &
cÚf
->
s¦
, cÚf->
£ssiÚ_tick‘_keys
)

375 !ð
NGX_OK
)

377  
NGX_CONF_ERROR
;

380  
NGX_CONF_OK
;

381 
	}
}

385 
	$ngx_maž_s¦_’abË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

387 
ngx_maž_s¦_cÚf_t
 *
scf
 = 
cÚf
;

389 *
rv
;

391 
rv
 = 
	`ngx_cÚf_£t_æag_¦Ù
(
cf
, 
cmd
, 
cÚf
);

393 ià(
rv
 !ð
NGX_CONF_OK
) {

394  
rv
;

397 ià(
scf
->
’abË
 && (
ngx_št_t
èscf->
¡¬‰ls
 > 
NGX_MAIL_STARTTLS_OFF
) {

398 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

400  
NGX_CONF_ERROR
;

403 
scf
->
fže
 = 
cf
->
cÚf_fže
->fže.
Çme
.
d©a
;

404 
scf
->
lše
 = 
cf
->
cÚf_fže
->line;

406  
NGX_CONF_OK
;

407 
	}
}

411 
	$ngx_maž_s¦_¡¬‰ls
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

413 
ngx_maž_s¦_cÚf_t
 *
scf
 = 
cÚf
;

415 *
rv
;

417 
rv
 = 
	`ngx_cÚf_£t_’um_¦Ù
(
cf
, 
cmd
, 
cÚf
);

419 ià(
rv
 !ð
NGX_CONF_OK
) {

420  
rv
;

423 ià(
scf
->
’abË
 =ð1 && (
ngx_št_t
èscf->
¡¬‰ls
 > 
NGX_MAIL_STARTTLS_OFF
) {

424 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

426  
NGX_CONF_ERROR
;

429 
scf
->
fže
 = 
cf
->
cÚf_fže
->fže.
Çme
.
d©a
;

430 
scf
->
lše
 = 
cf
->
cÚf_fže
->line;

432  
NGX_CONF_OK
;

433 
	}
}

437 
	$ngx_maž_s¦_·sswÜd_fže
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

439 
ngx_maž_s¦_cÚf_t
 *
scf
 = 
cÚf
;

441 
ngx_¡r_t
 *
v®ue
;

443 ià(
scf
->
·sswÜds
 !ð
NGX_CONF_UNSET_PTR
) {

447 
v®ue
 = 
cf
->
¬gs
->
–ts
;

449 
scf
->
·sswÜds
 = 
	`ngx_s¦_»ad_·sswÜd_fže
(
cf
, &
v®ue
[1]);

451 ià(
scf
->
·sswÜds
 =ð
NULL
) {

452  
NGX_CONF_ERROR
;

455  
NGX_CONF_OK
;

456 
	}
}

460 
	$ngx_maž_s¦_£ssiÚ_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

462 
ngx_maž_s¦_cÚf_t
 *
scf
 = 
cÚf
;

464 
size_t
 
Ën
;

465 
ngx_¡r_t
 *
v®ue
, 
Çme
, 
size
;

466 
ngx_št_t
 
n
;

467 
ngx_ušt_t
 
i
, 
j
;

469 
v®ue
 = 
cf
->
¬gs
->
–ts
;

471 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

473 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "off") == 0) {

474 
scf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_SSL_NO_SCACHE
;

478 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "none") == 0) {

479 
scf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_SSL_NONE_SCACHE
;

483 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "builtin") == 0) {

484 
scf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_SSL_DFLT_BUILTIN_SCACHE
;

488 ià(
v®ue
[
i
].
Ën
 > ("builtin:") - 1

489 && 
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "builtin:", ("builtin:") - 1)

492 
n
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + ("builtin:") - 1,

493 
v®ue
[
i
].
Ën
 - (("builtin:") - 1));

495 ià(
n
 =ð
NGX_ERROR
) {

496 
šv®id
;

499 
scf
->
bužtš_£ssiÚ_ÿche
 = 
n
;

504 ià(
v®ue
[
i
].
Ën
 > ("shared:") - 1

505 && 
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "shared:", ("shared:") - 1)

508 
Ën
 = 0;

510 
j
 = ("sh¬ed:"è- 1; j < 
v®ue
[
i
].
Ën
; j++) {

511 ià(
v®ue
[
i
].
d©a
[
j
] == ':') {

515 
Ën
++;

518 ià(
Ën
 == 0) {

519 
šv®id
;

522 
Çme
.
Ën
 =†en;

523 
Çme
.
d©a
 = 
v®ue
[
i
].data + ("shared:") - 1;

525 
size
.
Ën
 = 
v®ue
[
i
].ËÀ- 
j
 - 1;

526 
size
.
d©a
 = 
Çme
.d©¨+ 
Ën
 + 1;

528 
n
 = 
	`ngx_·r£_size
(&
size
);

530 ià(
n
 =ð
NGX_ERROR
) {

531 
šv®id
;

534 ià(
n
 < (
ngx_št_t
è(8 * 
ngx_·gesize
)) {

535 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

537 &
v®ue
[
i
]);

539  
NGX_CONF_ERROR
;

542 
scf
->
shm_zÚe
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
Çme
, 
n
,

543 &
ngx_maž_s¦_moduË
);

544 ià(
scf
->
shm_zÚe
 =ð
NULL
) {

545  
NGX_CONF_ERROR
;

548 
scf
->
shm_zÚe
->
š™
 = 
ngx_s¦_£ssiÚ_ÿche_š™
;

553 
šv®id
;

556 ià(
scf
->
shm_zÚe
 && scf->
bužtš_£ssiÚ_ÿche
 =ð
NGX_CONF_UNSET
) {

557 
scf
->
bužtš_£ssiÚ_ÿche
 = 
NGX_SSL_NO_BUILTIN_SCACHE
;

560  
NGX_CONF_OK
;

562 
šv®id
:

564 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

565 "šv®id sessiÚ cach\"%V\"", &
v®ue
[
i
]);

567  
NGX_CONF_ERROR
;

568 
	}
}

	@/home/wuhong/github/google/ngx_google/src/misc/ngx_google_perftools_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

16 
Profž”S¹
(
u_ch¬
* 
âame
);

17 
Profž”StÝ
();

18 
Profž”Regi¡”Th»ad
();

21 *
ngx_googË_³ráoÞs_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
);

22 
ngx_št_t
 
ngx_googË_³ráoÞs_wÜk”
(
ngx_cyþe_t
 *
cyþe
);

26 
ngx_¡r_t
 
	m´ofžes
;

27 } 
	tngx_googË_³ráoÞs_cÚf_t
;

30 
ngx_commªd_t
 
	gngx_googË_³ráoÞs_commªds
[] = {

32 { 
ngx_¡ršg
("google_perftools_profiles"),

33 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

34 
ngx_cÚf_£t_¡r_¦Ù
,

36 
off£tof
(
ngx_googË_³ráoÞs_cÚf_t
, 
´ofžes
),

37 
NULL
 },

39 
ngx_nuÎ_commªd


43 
ngx_cÜe_moduË_t
 
	gngx_googË_³ráoÞs_moduË_ùx
 = {

44 
ngx_¡ršg
("google_perftools"),

45 
ngx_googË_³ráoÞs_ü—‹_cÚf
,

46 
NULL


50 
ngx_moduË_t
 
	gngx_googË_³ráoÞs_moduË
 = {

51 
NGX_MODULE_V1
,

52 &
ngx_googË_³ráoÞs_moduË_ùx
,

53 
ngx_googË_³ráoÞs_commªds
,

54 
NGX_CORE_MODULE
,

55 
NULL
,

56 
NULL
,

57 
ngx_googË_³ráoÞs_wÜk”
,

58 
NULL
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NGX_MODULE_V1_PADDING


67 
	$ngx_googË_³ráoÞs_ü—‹_cÚf
(
ngx_cyþe_t
 *
cyþe
)

69 
ngx_googË_³ráoÞs_cÚf_t
 *
g±cf
;

71 
g±cf
 = 
	`ngx_pÿÎoc
(
cyþe
->
poÞ
, (
ngx_googË_³ráoÞs_cÚf_t
));

72 ià(
g±cf
 =ð
NULL
) {

73  
NULL
;

82  
g±cf
;

83 
	}
}

86 
ngx_št_t


87 
	$ngx_googË_³ráoÞs_wÜk”
(
ngx_cyþe_t
 *
cyþe
)

89 
u_ch¬
 *
´ofže
;

90 
ngx_googË_³ráoÞs_cÚf_t
 *
g±cf
;

92 
g±cf
 = (
ngx_googË_³ráoÞs_cÚf_t
 *)

93 
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_googË_³ráoÞs_moduË
);

95 ià(
g±cf
->
´ofžes
.
Ën
 == 0) {

96  
NGX_OK
;

99 
´ofže
 = 
	`ngx_®loc
(
g±cf
->
´ofžes
.
Ën
 + 
NGX_INT_T_LEN
 + 2, 
cyþe
->
log
);

100 ià(
´ofže
 =ð
NULL
) {

101  
NGX_OK
;

104 ià(
	`g‘’v
("CPUPROFILE")) {

106 
	`Profž”StÝ
();

109 
	`ngx_¥rštf
(
´ofže
, "%V.%d%Z", &
g±cf
->
´ofžes
, 
ngx_pid
);

111 ià(
	`Profž”S¹
(
´ofže
)) {

113 
	`Profž”Regi¡”Th»ad
();

116 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
cyþe
->
log
, 
ngx_”ºo
,

117 "Profž”S¹(%sèçžed", 
´ofže
);

120 
	`ngx_ä“
(
´ofže
);

122  
NGX_OK
;

123 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_aio_read.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_kqueue
;

16 
ssize_t


17 
	$ngx_aio_»ad
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, 
size_t
 
size
)

19 
n
;

20 
ngx_ev’t_t
 *
»v
;

22 
»v
 = 
c
->
»ad
;

24 ià(!
»v
->
»ady
) {

25 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "second‡io…ost");

26  
NGX_AGAIN
;

29 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

30 "»v->com¶‘e: %d", 
»v
->
com¶‘e
);

31 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

32 "aiØsize: %d", 
size
);

34 ià(!
»v
->
com¶‘e
) {

35 
	`ngx_memz”o
(&
»v
->
aiocb
, (aiocb));

37 
»v
->
aiocb
.
aio_fždes
 = 
c
->
fd
;

38 
»v
->
aiocb
.
aio_buf
 = 
buf
;

39 
»v
->
aiocb
.
aio_nby‹s
 = 
size
;

41 #ià(
NGX_HAVE_KQUEUE
)

42 
»v
->
aiocb
.
aio_sigev’t
.
sigev_nÙify_kqueue
 = 
ngx_kqueue
;

43 
»v
->
aiocb
.
aio_sigev’t
.
sigev_nÙify
 = 
SIGEV_KEVENT
;

44 
»v
->
aiocb
.
aio_sigev’t
.
sigev_v®ue
.
sigv®_±r
 =„ev;

47 ià(
	`aio_»ad
(&
»v
->
aiocb
) == -1) {

48 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
»v
->
log
, 
ngx_”ºo
,

50 
»v
->
”rÜ
 = 1;

51  
NGX_ERROR
;

54 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

55 "aio_»ad: #%d OK", 
c
->
fd
);

57 
»v
->
aùive
 = 1;

58 
»v
->
»ady
 = 0;

61 
»v
->
com¶‘e
 = 0;

63 
n
 = 
	`aio_”rÜ
(&
»v
->
aiocb
);

64 ià(
n
 == -1) {

65 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
, "aio_error() failed");

66 
»v
->
”rÜ
 = 1;

67  
NGX_ERROR
;

70 ià(
n
 != 0) {

71 ià(
n
 =ð
NGX_EINPROGRESS
) {

72 ià(
»v
->
»ady
) {

73 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
n
,

75 
»v
->
»ady
 = 0;

77  
NGX_AGAIN
;

80 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
c
->
log
, 
n
, "aio_read() failed");

81 
»v
->
”rÜ
 = 1;

82 
»v
->
»ady
 = 0;

83  
NGX_ERROR
;

86 
n
 = 
	`aio_»tuº
(&
»v
->
aiocb
);

87 ià(
n
 == -1) {

88 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_”ºo
,

91 
»v
->
”rÜ
 = 1;

92 
»v
->
»ady
 = 0;

93  
NGX_ERROR
;

96 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
»v
->
log
, 0,

97 "aio_»ad: #%d %d", 
c
->
fd
, 
n
);

99 ià(
n
 == 0) {

100 
»v
->
eof
 = 1;

101 
»v
->
»ady
 = 0;

103 
»v
->
»ady
 = 1;

106 
»v
->
aùive
 = 0;

108  
n
;

109 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_aio_read_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ssize_t


14 
	$ngx_aio_»ad_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
þ
, 
off_t
 
lim™
)

16 
n
;

17 
u_ch¬
 *
buf
, *
´ev
;

18 
size_t
 
size
;

19 
ssize_t
 
tÙ®
;

21 ià(
c
->
»ad
->
³ndšg_eof
) {

22 
c
->
»ad
->
»ady
 = 0;

26 
tÙ®
 = 0;

28 
þ
) {

32 ià(!
c
->
»ad
->
»ady
) {

33  
tÙ®
 ?Ù® : 
NGX_AGAIN
;

36 
buf
 = 
þ
->buf->
Ï¡
;

37 
´ev
 = 
þ
->
buf
->
Ï¡
;

38 
size
 = 0;

42 
þ
 && 
´ev
 =ðþ->
buf
->
Ï¡
) {

43 
size
 +ð
þ
->
buf
->
’d
 - cl->buf->
Ï¡
;

44 
´ev
 = 
þ
->
buf
->
’d
;

45 
þ
 = cl->
Ãxt
;

48 
n
 = 
	`ngx_aio_»ad
(
c
, 
buf
, 
size
);

50 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "aio_»ad: %d", 
n
);

52 ià(
n
 =ð
NGX_AGAIN
) {

53  
tÙ®
 ?Ù® : 
NGX_AGAIN
;

56 ià(
n
 =ð
NGX_ERROR
) {

57  
NGX_ERROR
;

60 ià(
n
 == 0) {

61 
c
->
»ad
->
³ndšg_eof
 = 1;

62 ià(
tÙ®
) {

63 
c
->
»ad
->
eof
 = 0;

64 
c
->
»ad
->
»ady
 = 1;

66  
tÙ®
;

69 ià(
n
 > 0) {

70 
tÙ®
 +ð
n
;

73 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

74 "aio_»adÙ®: %d", 
tÙ®
);

77  
tÙ®
 ?Ù® : 
NGX_AGAIN
;

78 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_aio_write.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_kqueue
;

16 
ssize_t


17 
	$ngx_aio_wr™e
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, 
size_t
 
size
)

19 
n
;

20 
ngx_ev’t_t
 *
wev
;

22 
wev
 = 
c
->
wr™e
;

24 ià(!
wev
->
»ady
) {

25  
NGX_AGAIN
;

28 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
wev
->
log
, 0,

29 "aio: wev->com¶‘e: %d", 
wev
->
com¶‘e
);

31 ià(!
wev
->
com¶‘e
) {

32 
	`ngx_memz”o
(&
wev
->
aiocb
, (aiocb));

34 
wev
->
aiocb
.
aio_fždes
 = 
c
->
fd
;

35 
wev
->
aiocb
.
aio_buf
 = 
buf
;

36 
wev
->
aiocb
.
aio_nby‹s
 = 
size
;

38 #ià(
NGX_HAVE_KQUEUE
)

39 
wev
->
aiocb
.
aio_sigev’t
.
sigev_nÙify_kqueue
 = 
ngx_kqueue
;

40 
wev
->
aiocb
.
aio_sigev’t
.
sigev_nÙify
 = 
SIGEV_KEVENT
;

41 
wev
->
aiocb
.
aio_sigev’t
.
sigev_v®ue
.
sigv®_±r
 = wev;

44 ià(
	`aio_wr™e
(&
wev
->
aiocb
) == -1) {

45 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
wev
->
log
, 
ngx_”ºo
,

47  
NGX_ERROR
;

50 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
wev
->
log
, 0, "aio_write: OK");

52 
wev
->
aùive
 = 1;

53 
wev
->
»ady
 = 0;

56 
wev
->
com¶‘e
 = 0;

58 
n
 = 
	`aio_”rÜ
(&
wev
->
aiocb
);

59 ià(
n
 == -1) {

60 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
wev
->
log
, 
ngx_”ºo
, "aio_error() failed");

61 
wev
->
”rÜ
 = 1;

62  
NGX_ERROR
;

65 ià(
n
 != 0) {

66 ià(
n
 =ð
NGX_EINPROGRESS
) {

67 ià(
wev
->
»ady
) {

68 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
wev
->
log
, 
n
,

70 
wev
->
»ady
 = 0;

72  
NGX_AGAIN
;

75 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
wev
->
log
, 
n
, "aio_write() failed");

76 
wev
->
”rÜ
 = 1;

77 
wev
->
»ady
 = 0;

80 
n
 = 
	`aio_»tuº
(&
wev
->
aiocb
);

81 ià(
n
 == -1) {

82 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
wev
->
log
, 
ngx_”ºo
,

86 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
wev
->
log
, 
n
, "aio_return() %d",‚);

89  
NGX_ERROR
;

92 
n
 = 
	`aio_»tuº
(&
wev
->
aiocb
);

93 ià(
n
 == -1) {

94 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
wev
->
log
, 
ngx_”ºo
,

97 
wev
->
”rÜ
 = 1;

98 
wev
->
»ady
 = 0;

99  
NGX_ERROR
;

103 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
wev
->
log
, 0, "aio_wr™e: %d", 
n
);

105 
wev
->
aùive
 = 0;

106 
wev
->
»ady
 = 1;

108  
n
;

109 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_aio_write_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_chaš_t
 *

14 
	$ngx_aio_wr™e_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
)

16 
u_ch¬
 *
buf
, *
´ev
;

17 
off_t
 
£nd
, 
£Á
;

18 
size_t
 
Ën
;

19 
ssize_t
 
n
, 
size
;

20 
ngx_chaš_t
 *
þ
;

24 ià(
lim™
 =ð0 ||†im™ > (
off_t
è(
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
)) {

25 
lim™
 = 
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
;

28 
£nd
 = 0;

29 
£Á
 = 0;

30 
þ
 = 
š
;

32 
þ
) {

34 ià(
þ
->
buf
->
pos
 =ðþ->buf->
Ï¡
) {

35 
þ
 = cl->
Ãxt
;

41 ià(!
c
->
wr™e
->
»ady
) {

42  
þ
;

45 
buf
 = 
þ
->buf->
pos
;

46 
´ev
 = 
buf
;

47 
Ën
 = 0;

51 
þ
 && 
´ev
 =ðþ->
buf
->
pos
 && 
£nd
 < 
lim™
) {

52 ià(
	`ngx_buf_¥ecŸl
(
þ
->
buf
)) {

56 
size
 = 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

58 ià(
£nd
 + 
size
 > 
lim™
) {

59 
size
 = 
lim™
 - 
£nd
;

62 
Ën
 +ð
size
;

63 
´ev
 = 
þ
->
buf
->
pos
 + 
size
;

64 
£nd
 +ð
size
;

65 
þ
 = cl->
Ãxt
;

68 
n
 = 
	`ngx_aio_wr™e
(
c
, 
buf
, 
Ën
);

70 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0, "aio_wr™e: %z", 
n
);

72 ià(
n
 =ð
NGX_ERROR
) {

73  
NGX_CHAIN_ERROR
;

76 ià(
n
 > 0) {

77 
£Á
 +ð
n
;

78 
c
->
£Á
 +ð
n
;

81 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

82 "aio_wr™£Á: %O", 
c
->
£Á
);

84 
þ
 = 
š
; cl; cÈðþ->
Ãxt
) {

86 ià(
£Á
 >ð
þ
->
buf
->
Ï¡
 - cl->buf->
pos
) {

87 
£Á
 -ð
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

88 
þ
->
buf
->
pos
 = cl->buf->
Ï¡
;

93 
þ
->
buf
->
pos
 +ð
£Á
;

99  
þ
;

100 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_alloc.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_ušt_t
 
	gngx_·gesize
;

13 
ngx_ušt_t
 
	gngx_·gesize_shiá
;

14 
ngx_ušt_t
 
	gngx_ÿch–še_size
;

18 
	$ngx_®loc
(
size_t
 
size
, 
ngx_log_t
 *
log
)

20 *
p
;

22 
p
 = 
	`m®loc
(
size
);

23 ià(
p
 =ð
NULL
) {

24 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

25 "m®loc(%uzèçžed", 
size
);

28 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_ALLOC
, 
log
, 0, "m®loc: %p:%uz", 
p
, 
size
);

30  
p
;

31 
	}
}

35 
	$ngx_ÿÎoc
(
size_t
 
size
, 
ngx_log_t
 *
log
)

37 *
p
;

39 
p
 = 
	`ngx_®loc
(
size
, 
log
);

41 ià(
p
) {

42 
	`ngx_memz”o
(
p
, 
size
);

45  
p
;

46 
	}
}

49 #ià(
NGX_HAVE_POSIX_MEMALIGN
)

52 
	$ngx_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
, 
ngx_log_t
 *
log
)

54 *
p
;

55 
”r
;

57 
”r
 = 
	`posix_mem®ign
(&
p
, 
®ignm’t
, 
size
);

59 ià(
”r
) {

60 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
”r
,

61 "posix_mem®ign(%uz, %uzèçžed", 
®ignm’t
, 
size
);

62 
p
 = 
NULL
;

65 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_ALLOC
, 
log
, 0,

66 "posix_mem®ign: %p:%uz @%uz", 
p
, 
size
, 
®ignm’t
);

68  
p
;

69 
	}
}

71 #–ià(
NGX_HAVE_MEMALIGN
)

74 
	$ngx_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
, 
ngx_log_t
 *
log
)

76 *
p
;

78 
p
 = 
	`mem®ign
(
®ignm’t
, 
size
);

79 ià(
p
 =ð
NULL
) {

80 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

81 "mem®ign(%uz, %uzèçžed", 
®ignm’t
, 
size
);

84 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_ALLOC
, 
log
, 0,

85 "mem®ign: %p:%uz @%uz", 
p
, 
size
, 
®ignm’t
);

87  
p
;

88 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_channel.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_chªÃl.h
>

13 
ngx_št_t


14 
	$ngx_wr™e_chªÃl
(
ngx_sock‘_t
 
s
, 
ngx_chªÃl_t
 *
ch
, 
size_t
 
size
,

15 
ngx_log_t
 *
log
)

17 
ssize_t
 
n
;

18 
ngx_”r_t
 
”r
;

19 
iovec
 
iov
[1];

20 
msghdr
 
msg
;

22 #ià(
NGX_HAVE_MSGHDR_MSG_CONTROL
)

25 
cmsghdr
 
cm
;

26 
¥aû
[
	`CMSG_SPACE
(())];

27 } 
cmsg
;

29 ià(
ch
->
fd
 == -1) {

30 
msg
.
msg_cÚŒÞ
 = 
NULL
;

31 
msg
.
msg_cÚŒÞËn
 = 0;

34 
msg
.
msg_cÚŒÞ
 = (
ÿddr_t
è&
cmsg
;

35 
msg
.
msg_cÚŒÞËn
 = (
cmsg
);

37 
	`ngx_memz”o
(&
cmsg
, (cmsg));

39 
cmsg
.
cm
.
cmsg_Ën
 = 
	`CMSG_LEN
(());

40 
cmsg
.
cm
.
cmsg_Ëv–
 = 
SOL_SOCKET
;

41 
cmsg
.
cm
.
cmsg_ty³
 = 
SCM_RIGHTS
;

53 
	`ngx_memýy
(
	`CMSG_DATA
(&
cmsg
.
cm
), &
ch
->
fd
, ());

56 
msg
.
msg_æags
 = 0;

60 ià(
ch
->
fd
 == -1) {

61 
msg
.
msg_acüights
 = 
NULL
;

62 
msg
.
msg_acüight¦’
 = 0;

65 
msg
.
msg_acüights
 = (
ÿddr_t
è&
ch
->
fd
;

66 
msg
.
msg_acüight¦’
 = ();

71 
iov
[0].
iov_ba£
 = (*è
ch
;

72 
iov
[0].
iov_Ën
 = 
size
;

74 
msg
.
msg_Çme
 = 
NULL
;

75 
msg
.
msg_Çm–’
 = 0;

76 
msg
.
msg_iov
 = 
iov
;

77 
msg
.
msg_iovËn
 = 1;

79 
n
 = 
	`£ndmsg
(
s
, &
msg
, 0);

81 ià(
n
 == -1) {

82 
”r
 = 
ngx_”ºo
;

83 ià(
”r
 =ð
NGX_EAGAIN
) {

84  
NGX_AGAIN
;

87 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
, "sendmsg() failed");

88  
NGX_ERROR
;

91  
NGX_OK
;

92 
	}
}

95 
ngx_št_t


96 
	$ngx_»ad_chªÃl
(
ngx_sock‘_t
 
s
, 
ngx_chªÃl_t
 *
ch
, 
size_t
 
size
, 
ngx_log_t
 *
log
)

98 
ssize_t
 
n
;

99 
ngx_”r_t
 
”r
;

100 
iovec
 
iov
[1];

101 
msghdr
 
msg
;

103 #ià(
NGX_HAVE_MSGHDR_MSG_CONTROL
)

105 
cmsghdr
 
cm
;

106 
¥aû
[
	`CMSG_SPACE
(())];

107 } 
cmsg
;

109 
fd
;

112 
iov
[0].
iov_ba£
 = (*è
ch
;

113 
iov
[0].
iov_Ën
 = 
size
;

115 
msg
.
msg_Çme
 = 
NULL
;

116 
msg
.
msg_Çm–’
 = 0;

117 
msg
.
msg_iov
 = 
iov
;

118 
msg
.
msg_iovËn
 = 1;

120 #ià(
NGX_HAVE_MSGHDR_MSG_CONTROL
)

121 
msg
.
msg_cÚŒÞ
 = (
ÿddr_t
è&
cmsg
;

122 
msg
.
msg_cÚŒÞËn
 = (
cmsg
);

124 
msg
.
msg_acüights
 = (
ÿddr_t
è&
fd
;

125 
msg
.
msg_acüight¦’
 = ();

128 
n
 = 
	`»cvmsg
(
s
, &
msg
, 0);

130 ià(
n
 == -1) {

131 
”r
 = 
ngx_”ºo
;

132 ià(
”r
 =ð
NGX_EAGAIN
) {

133  
NGX_AGAIN
;

136 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
, "recvmsg() failed");

137  
NGX_ERROR
;

140 ià(
n
 == 0) {

141 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "recvmsg()„eturned zero");

142  
NGX_ERROR
;

145 ià((
size_t
è
n
 < (
ngx_chªÃl_t
)) {

146 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

147 "»cvmsg(è»tuºed‚Ùƒnough d©a: %z", 
n
);

148  
NGX_ERROR
;

151 #ià(
NGX_HAVE_MSGHDR_MSG_CONTROL
)

153 ià(
ch
->
commªd
 =ð
NGX_CMD_OPEN_CHANNEL
) {

155 ià(
cmsg
.
cm
.
cmsg_Ën
 < (
sockËn_t
è
	`CMSG_LEN
(())) {

156 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

158  
NGX_ERROR
;

161 ià(
cmsg
.
cm
.
cmsg_Ëv–
 !ð
SOL_SOCKET
 || cmsg.cm.
cmsg_ty³
 !ð
SCM_RIGHTS
)

163 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

166 
cmsg
.
cm
.
cmsg_Ëv–
, cmsg.cm.
cmsg_ty³
);

167  
NGX_ERROR
;

172 
	`ngx_memýy
(&
ch
->
fd
, 
	`CMSG_DATA
(&
cmsg
.
cm
), ());

175 ià(
msg
.
msg_æags
 & (
MSG_TRUNC
|
MSG_CTRUNC
)) {

176 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

182 ià(
ch
->
commªd
 =ð
NGX_CMD_OPEN_CHANNEL
) {

183 ià(
msg
.
msg_acüight¦’
 != ()) {

184 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

186  
NGX_ERROR
;

189 
ch
->
fd
 = fd;

194  
n
;

195 
	}
}

198 
ngx_št_t


199 
	$ngx_add_chªÃl_ev’t
(
ngx_cyþe_t
 *
cyþe
, 
ngx_fd_t
 
fd
, 
ngx_št_t
 
ev’t
,

200 
ngx_ev’t_hªdËr_±
 
hªdËr
)

202 
ngx_ev’t_t
 *
ev
, *
»v
, *
wev
;

203 
ngx_cÚÃùiÚ_t
 *
c
;

205 
c
 = 
	`ngx_g‘_cÚÃùiÚ
(
fd
, 
cyþe
->
log
);

207 ià(
c
 =ð
NULL
) {

208  
NGX_ERROR
;

211 
c
->
poÞ
 = 
cyþe
->pool;

213 
»v
 = 
c
->
»ad
;

214 
wev
 = 
c
->
wr™e
;

216 
»v
->
log
 = 
cyþe
->log;

217 
wev
->
log
 = 
cyþe
->log;

219 
»v
->
chªÃl
 = 1;

220 
wev
->
chªÃl
 = 1;

222 
ev
 = (
ev’t
 =ð
NGX_READ_EVENT
è? 
»v
 : 
wev
;

224 
ev
->
hªdËr
 = handler;

226 ià(
ngx_add_cÚn
 && (
ngx_ev’t_æags
 & 
NGX_USE_EPOLL_EVENT
) == 0) {

227 ià(
	`ngx_add_cÚn
(
c
è=ð
NGX_ERROR
) {

228 
	`ngx_ä“_cÚÃùiÚ
(
c
);

229  
NGX_ERROR
;

233 ià(
	`ngx_add_ev’t
(
ev
, 
ev’t
, 0è=ð
NGX_ERROR
) {

234 
	`ngx_ä“_cÚÃùiÚ
(
c
);

235  
NGX_ERROR
;

239  
NGX_OK
;

240 
	}
}

244 
	$ngx_þo£_chªÃl
(
ngx_fd_t
 *
fd
, 
ngx_log_t
 *
log
)

246 ià(
	`þo£
(
fd
[0]) == -1) {

247 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
, "close() channel failed");

250 ià(
	`þo£
(
fd
[1]) == -1) {

251 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
, "close() channel failed");

253 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_daemon.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_št_t


13 
	$ngx_d«mÚ
(
ngx_log_t
 *
log
)

15 
fd
;

17 
	`fÜk
()) {

19 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
, "fork() failed");

20  
NGX_ERROR
;

26 
	`ex™
(0);

29 
ngx_pid
 = 
	`ngx_g‘pid
();

31 ià(
	`£tsid
() == -1) {

32 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
, "setsid() failed");

33  
NGX_ERROR
;

36 
	`umask
(0);

38 
fd
 = 
	`Ý’
("/dev/nuÎ", 
O_RDWR
);

39 ià(
fd
 == -1) {

40 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

42  
NGX_ERROR
;

45 ià(
	`dup2
(
fd
, 
STDIN_FILENO
) == -1) {

46 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
, "dup2(STDIN) failed");

47  
NGX_ERROR
;

50 ià(
	`dup2
(
fd
, 
STDOUT_FILENO
) == -1) {

51 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
, "dup2(STDOUT) failed");

52  
NGX_ERROR
;

56 ià(
	`dup2
(
fd
, 
STDERR_FILENO
) == -1) {

57 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
, "dup2(STDERR) failed");

58  
NGX_ERROR
;

62 ià(
fd
 > 
STDERR_FILENO
) {

63 ià(
	`þo£
(
fd
) == -1) {

64 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
, "close() failed");

65  
NGX_ERROR
;

69  
NGX_OK
;

70 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_darwin_init.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
	gngx_d¬wš_k”n_o¡y³
[16];

13 
	gngx_d¬wš_k”n_o¤–—£
[128];

14 
	gngx_d¬wš_hw_nýu
;

15 
	gngx_d¬wš_k”n_c_somaxcÚn
;

16 
u_lÚg
 
	gngx_d¬wš_Ãt_š‘_tý_£nd¥aû
;

18 
ngx_ušt_t
 
	gngx_debug_m®loc
;

21 
ngx_os_io_t
 
	gngx_d¬wš_io
 = {

22 
ngx_unix_»cv
,

23 
ngx_»adv_chaš
,

24 
ngx_udp_unix_»cv
,

25 
ngx_unix_£nd
,

26 #ià(
NGX_HAVE_SENDFILE
)

27 
ngx_d¬wš_£ndfže_chaš
,

28 
NGX_IO_SENDFILE


30 
ngx_wr™ev_chaš
,

37 *
	mÇme
;

38 *
	mv®ue
;

39 
size_t
 
	msize
;

40 
ngx_ušt_t
 
	mexi¡s
;

41 } 
	tsysùl_t
;

44 
sysùl_t
 
	gsysùls
[] = {

46 &
ngx_d¬wš_hw_nýu
,

47 (
ngx_d¬wš_hw_nýu
), 0 },

50 &
ngx_d¬wš_Ãt_š‘_tý_£nd¥aû
,

51 (
ngx_d¬wš_Ãt_š‘_tý_£nd¥aû
), 0 },

54 &
ngx_d¬wš_k”n_c_somaxcÚn
,

55 (
ngx_d¬wš_k”n_c_somaxcÚn
), 0 },

57 { 
NULL
, NULL, 0, 0 }

62 
	$ngx_debug_š™
()

64 #ià(
NGX_DEBUG_MALLOC
)

75 
	`£‹nv
("MallocScribble", "1", 0);

77 
ngx_debug_m®loc
 = 1;

81 ià(
	`g‘’v
("MallocScribble")) {

82 
ngx_debug_m®loc
 = 1;

86 
	}
}

89 
ngx_št_t


90 
	$ngx_os_¥ecific_š™
(
ngx_log_t
 *
log
)

92 
size_t
 
size
;

93 
ngx_”r_t
 
”r
;

94 
ngx_ušt_t
 
i
;

96 
size
 = (
ngx_d¬wš_k”n_o¡y³
);

97 ià(
	`sysùlbyÇme
("k”n.o¡y³", 
ngx_d¬wš_k”n_o¡y³
, &
size
, 
NULL
, 0)

100 
”r
 = 
ngx_”ºo
;

102 ià(
”r
 !ð
NGX_ENOENT
) {

104 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
,

107 ià(
”r
 !ð
NGX_ENOMEM
) {

108  
NGX_ERROR
;

111 
ngx_d¬wš_k”n_o¡y³
[
size
 - 1] = '\0';

115 
size
 = (
ngx_d¬wš_k”n_o¤–—£
);

116 ià(
	`sysùlbyÇme
("k”n.o¤–—£", 
ngx_d¬wš_k”n_o¤–—£
, &
size
,

117 
NULL
, 0)

120 
”r
 = 
ngx_”ºo
;

122 ià(
”r
 !ð
NGX_ENOENT
) {

124 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
,

127 ià(
”r
 !ð
NGX_ENOMEM
) {

128  
NGX_ERROR
;

131 
ngx_d¬wš_k”n_o¤–—£
[
size
 - 1] = '\0';

135 
i
 = 0; 
sysùls
[i].
Çme
; i++) {

136 
size
 = 
sysùls
[
i
].size;

138 ià(
	`sysùlbyÇme
(
sysùls
[
i
].
Çme
, sysùls[i].
v®ue
, &
size
, 
NULL
, 0)

141 
sysùls
[
i
].
exi¡s
 = 1;

145 
”r
 = 
ngx_”ºo
;

147 ià(
”r
 =ð
NGX_ENOENT
) {

151 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
,

152 "sysùlbyÇme(%sèçžed", 
sysùls
[
i
].
Çme
);

153  
NGX_ERROR
;

156 
ngx_nýu
 = 
ngx_d¬wš_hw_nýu
;

158 ià(
ngx_d¬wš_k”n_c_somaxcÚn
 > 32767) {

159 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

161  
NGX_ERROR
;

164 
ngx_tý_nod–ay_ªd_tý_nÝush
 = 1;

166 
ngx_os_io
 = 
ngx_d¬wš_io
;

168  
NGX_OK
;

169 
	}
}

173 
	$ngx_os_¥ecific_¡©us
(
ngx_log_t
 *
log
)

175 
u_lÚg
 
v®ue
;

176 
ngx_ušt_t
 
i
;

178 ià(
ngx_d¬wš_k”n_o¡y³
[0]) {

179 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "OS: %s %s",

180 
ngx_d¬wš_k”n_o¡y³
, 
ngx_d¬wš_k”n_o¤–—£
);

183 
i
 = 0; 
sysùls
[i].
Çme
; i++) {

184 ià(
sysùls
[
i
].
exi¡s
) {

185 ià(
sysùls
[
i
].
size
 == ()) {

186 
v®ue
 = *(*è
sysùls
[
i
].value;

189 
v®ue
 = *(*è
sysùls
[
i
].value;

192 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "%s: %l",

193 
sysùls
[
i
].
Çme
, 
v®ue
);

196 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_darwin_sendfile_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

30 
ngx_chaš_t
 *

31 
	$ngx_d¬wš_£ndfže_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
)

33 
rc
;

34 
off_t
 
£nd
, 
´ev_£nd
, 
£Á
;

35 
off_t
 
fže_size
;

36 
ssize_t
 
n
;

37 
ngx_ušt_t
 
ešŒ
;

38 
ngx_”r_t
 
”r
;

39 
ngx_buf_t
 *
fže
;

40 
ngx_ev’t_t
 *
wev
;

41 
ngx_chaš_t
 *
þ
;

42 
ngx_iovec_t
 
h—d”
, 
Œaž”
;

43 
sf_hdŒ
 
hdŒ
;

44 
iovec
 
h—d”s
[
NGX_IOVS_PREALLOCATE
];

45 
iovec
 
Œaž”s
[
NGX_IOVS_PREALLOCATE
];

47 
wev
 = 
c
->
wr™e
;

49 ià(!
wev
->
»ady
) {

50  
š
;

53 #ià(
NGX_HAVE_KQUEUE
)

55 ià((
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
è&& 
wev
->
³ndšg_eof
) {

56 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
wev
->
kq_”ºo
,

58 
wev
->
”rÜ
 = 1;

59  
NGX_CHAIN_ERROR
;

66 ià(
lim™
 =ð0 ||†im™ > (
off_t
è(
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
)) {

67 
lim™
 = 
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
;

70 
£nd
 = 0;

72 
h—d”
.
iovs
 = 
h—d”s
;

73 
h—d”
.
ÇÎoc
 = 
NGX_IOVS_PREALLOCATE
;

75 
Œaž”
.
iovs
 = 
Œaž”s
;

76 
Œaž”
.
ÇÎoc
 = 
NGX_IOVS_PREALLOCATE
;

79 
ešŒ
 = 0;

80 
´ev_£nd
 = 
£nd
;

84 
þ
 = 
	`ngx_ouut_chaš_to_iovec
(&
h—d”
, 
š
, 
lim™
 - 
£nd
, 
c
->
log
);

86 ià(
þ
 =ð
NGX_CHAIN_ERROR
) {

87  
NGX_CHAIN_ERROR
;

90 
£nd
 +ð
h—d”
.
size
;

92 ià(
þ
 && cl->
buf
->
š_fže
 && 
£nd
 < 
lim™
) {

93 
fže
 = 
þ
->
buf
;

97 
fže_size
 = 
	`ngx_chaš_cßËsû_fže
(&
þ
, 
lim™
 - 
£nd
);

99 
£nd
 +ð
fže_size
;

101 ià(
h—d”
.
couÁ
 == 0) {

107 
þ
 = 
	`ngx_ouut_chaš_to_iovec
(&
Œaž”
, cl, 
lim™
 - 
£nd
,

108 
c
->
log
);

109 ià(
þ
 =ð
NGX_CHAIN_ERROR
) {

110  
NGX_CHAIN_ERROR
;

113 
£nd
 +ð
Œaž”
.
size
;

121 
hdŒ
.
h—d”s
 = 
h—d”
.
couÁ
 ? h—d”.
iovs
 : 
NULL
;

122 
hdŒ
.
hdr_út
 = 
h—d”
.
couÁ
;

123 
hdŒ
.
Œaž”s
 = 
Œaž”
.
couÁ
 ?¿ž”.
iovs
 : 
NULL
;

124 
hdŒ
.
Œl_út
 = 
Œaž”
.
couÁ
;

126 
£Á
 = 
h—d”
.
size
 + 
fže_size
;

128 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

130 
fže
->
fže_pos
, 
£Á
, 
h—d”
.
size
);

132 
rc
 = 
	`£ndfže
(
fže
->fže->
fd
, 
c
->fd, fže->
fže_pos
,

133 &
£Á
, &
hdŒ
, 0);

135 ià(
rc
 == -1) {

136 
”r
 = 
ngx_”ºo
;

138 
”r
) {

139 
NGX_EAGAIN
:

142 
NGX_EINTR
:

143 
ešŒ
 = 1;

147 
wev
->
”rÜ
 = 1;

148 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "sendfile() failed");

149  
NGX_CHAIN_ERROR
;

152 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

153 "£ndfže(è£Á oÆy %O by‹s", 
£Á
);

156 ià(
rc
 =ð0 && 
£Á
 == 0) {

164 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

166 
fže
->fže->
Çme
.
d©a
);

168  
NGX_CHAIN_ERROR
;

171 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

173 
rc
, 
fže
->
fže_pos
, 
£Á
, 
fže_size
 + 
h—d”
.
size
);

176 
n
 = 
	`ngx_wr™ev
(
c
, &
h—d”
);

178 ià(
n
 =ð
NGX_ERROR
) {

179  
NGX_CHAIN_ERROR
;

182 
£Á
 = (
n
 =ð
NGX_AGAIN
) ? 0 :‚;

185 
c
->
£Á
 += sent;

187 
š
 = 
	`ngx_chaš_upd©e_£Á
(š, 
£Á
);

189 ià(
ešŒ
) {

190 
£nd
 = 
´ev_£nd
 + 
£Á
;

194 ià(
£nd
 - 
´ev_£nd
 !ð
£Á
) {

195 
wev
->
»ady
 = 0;

196  
š
;

199 ià(
£nd
 >ð
lim™
 || 
š
 =ð
NULL
) {

200  
š
;

203 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_errno.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

28 
ngx_¡r_t
 *
	gngx_sys_”¾i¡
;

29 
ngx_¡r_t
 
	gngx_unknown_”rÜ
 = 
ngx_¡ršg
("Unknownƒrror");

32 
u_ch¬
 *

33 
	$ngx_¡»¼Ü
(
ngx_”r_t
 
”r
, 
u_ch¬
 *
”r¡r
, 
size_t
 
size
)

35 
ngx_¡r_t
 *
msg
;

37 
msg
 = ((
ngx_ušt_t
è
”r
 < 
NGX_SYS_NERR
è? &
ngx_sys_”¾i¡
[err]:

38 &
ngx_unknown_”rÜ
;

39 
size
 = 
	`ngx_mš
(size, 
msg
->
Ën
);

41  
	`ngx_ýymem
(
”r¡r
, 
msg
->
d©a
, 
size
);

42 
	}
}

45 
ngx_št_t


46 
	$ngx_¡»¼Ü_š™
()

48 *
msg
;

49 
u_ch¬
 *
p
;

50 
size_t
 
Ën
;

51 
ngx_”r_t
 
”r
;

58 
Ën
 = 
NGX_SYS_NERR
 * (
ngx_¡r_t
);

60 
ngx_sys_”¾i¡
 = 
	`m®loc
(
Ën
);

61 ià(
ngx_sys_”¾i¡
 =ð
NULL
) {

62 
çžed
;

65 
”r
 = 0;ƒ¼ < 
NGX_SYS_NERR
;ƒrr++) {

66 
msg
 = 
	`¡»¼Ü
(
”r
);

67 
Ën
 = 
	`ngx_¡¾’
(
msg
);

69 
p
 = 
	`m®loc
(
Ën
);

70 ià(
p
 =ð
NULL
) {

71 
çžed
;

74 
	`ngx_memýy
(
p
, 
msg
, 
Ën
);

75 
ngx_sys_”¾i¡
[
”r
].
Ën
 =†en;

76 
ngx_sys_”¾i¡
[
”r
].
d©a
 = 
p
;

79  
NGX_OK
;

81 
çžed
:

83 
”r
 = 
”ºo
;

84 
	`ngx_log_¡d”r
(0, "m®loc(%uzèçžed (%d: %s)", 
Ën
, 
”r
, 
	`¡»¼Ü
(err));

86  
NGX_ERROR
;

87 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_file_aio_read.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

31 
ngx_kqueue
;

34 
ssize_t
 
ngx_fže_aio_»suÉ
(
ngx_fže_t
 *
fže
, 
ngx_ev’t_aio_t
 *
aio
,

35 
ngx_ev’t_t
 *
ev
);

36 
ngx_fže_aio_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
);

39 
ssize_t


40 
	$ngx_fže_aio_»ad
(
ngx_fže_t
 *
fže
, 
u_ch¬
 *
buf
, 
size_t
 
size
, 
off_t
 
off£t
,

41 
ngx_poÞ_t
 *
poÞ
)

43 
n
;

44 
ngx_ev’t_t
 *
ev
;

45 
ngx_ev’t_aio_t
 *
aio
;

47 ià(!
ngx_fže_aio
) {

48  
	`ngx_»ad_fže
(
fže
, 
buf
, 
size
, 
off£t
);

51 
aio
 = 
fže
->aio;

53 ià(
aio
 =ð
NULL
) {

54 
aio
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_ev’t_aio_t
));

55 ià(
aio
 =ð
NULL
) {

56  
NGX_ERROR
;

59 
aio
->
fže
 = file;

60 
aio
->
fd
 = 
fže
->fd;

61 
aio
->
ev’t
.
d©a
 =‡io;

62 
aio
->
ev’t
.
»ady
 = 1;

63 
aio
->
ev’t
.
log
 = 
fže
->log;

64 #ià(
NGX_HAVE_AIO_SENDFILE
)

65 
aio
->
Ï¡_off£t
 = -1;

67 
fže
->
aio
 =‡io;

70 
ev
 = &
aio
->
ev’t
;

72 ià(!
ev
->
»ady
) {

73 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
fže
->
log
, 0,

74 "£cÚd‡iØpo¡ fÜ \"%V\"", &
fže
->
Çme
);

75  
NGX_AGAIN
;

78 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

80 
ev
->
com¶‘e
, 
off£t
, 
size
, &
fže
->
Çme
);

82 ià(
ev
->
com¶‘e
) {

83 
ev
->
com¶‘e
 = 0;

84 
	`ngx_£t_”ºo
(
aio
->
”r
);

86 ià(
aio
->
”r
 == 0) {

87  
aio
->
nby‹s
;

90 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

91 "aiØ»ad \"%s\" fažed", 
fže
->
Çme
.
d©a
);

93  
NGX_ERROR
;

96 
	`ngx_memz”o
(&
aio
->
aiocb
, (aiocb));

98 
aio
->
aiocb
.
aio_fždes
 = 
fže
->
fd
;

99 
aio
->
aiocb
.
aio_off£t
 = 
off£t
;

100 
aio
->
aiocb
.
aio_buf
 = 
buf
;

101 
aio
->
aiocb
.
aio_nby‹s
 = 
size
;

102 #ià(
NGX_HAVE_KQUEUE
)

103 
aio
->
aiocb
.
aio_sigev’t
.
sigev_nÙify_kqueue
 = 
ngx_kqueue
;

104 
aio
->
aiocb
.
aio_sigev’t
.
sigev_nÙify
 = 
SIGEV_KEVENT
;

105 
aio
->
aiocb
.
aio_sigev’t
.
sigev_v®ue
.
sigv®_±r
 = 
ev
;

107 
ev
->
hªdËr
 = 
ngx_fže_aio_ev’t_hªdËr
;

109 
n
 = 
	`aio_»ad
(&
aio
->
aiocb
);

111 ià(
n
 == -1) {

112 
n
 = 
ngx_”ºo
;

114 ià(
n
 =ð
NGX_EAGAIN
) {

115  
	`ngx_»ad_fže
(
fže
, 
buf
, 
size
, 
off£t
);

118 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
n
,

119 "aio_»ad(\"%V\"èçžed", &
fže
->
Çme
);

121 ià(
n
 =ð
NGX_ENOSYS
) {

122 
ngx_fže_aio
 = 0;

123  
	`ngx_»ad_fže
(
fže
, 
buf
, 
size
, 
off£t
);

126  
NGX_ERROR
;

129 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

130 "aio_»ad: fd:%d %d", 
fže
->
fd
, 
n
);

132 
ev
->
aùive
 = 1;

133 
ev
->
»ady
 = 0;

134 
ev
->
com¶‘e
 = 0;

136  
	`ngx_fže_aio_»suÉ
(
aio
->
fže
,‡io, 
ev
);

137 
	}
}

140 
ssize_t


141 
	$ngx_fže_aio_»suÉ
(
ngx_fže_t
 *
fže
, 
ngx_ev’t_aio_t
 *
aio
, 
ngx_ev’t_t
 *
ev
)

143 
n
;

144 
ngx_”r_t
 
”r
;

146 
n
 = 
	`aio_”rÜ
(&
aio
->
aiocb
);

148 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

149 "aio_”rÜ: fd:%d %d", 
fže
->
fd
, 
n
);

151 ià(
n
 == -1) {

152 
”r
 = 
ngx_”ºo
;

153 
aio
->
”r
 =ƒrr;

155 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
fže
->
log
, 
”r
,

156 "aio_”rÜ(\"%V\"èçžed", &
fže
->
Çme
);

157  
NGX_ERROR
;

160 ià(
n
 =ð
NGX_EINPROGRESS
) {

161 ià(
ev
->
»ady
) {

162 
ev
->
»ady
 = 0;

163 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
fže
->
log
, 
n
,

165 &
fže
->
Çme
);

168  
NGX_AGAIN
;

171 
n
 = 
	`aio_»tuº
(&
aio
->
aiocb
);

173 ià(
n
 == -1) {

174 
”r
 = 
ngx_”ºo
;

175 
aio
->
”r
 =ƒrr;

176 
ev
->
»ady
 = 1;

178 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
”r
,

179 "aio_»tuº(\"%V\"èçžed", &
fže
->
Çme
);

180  
NGX_ERROR
;

183 
aio
->
”r
 = 0;

184 
aio
->
nby‹s
 = 
n
;

185 
ev
->
»ady
 = 1;

186 
ev
->
aùive
 = 0;

188 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

189 "aio_»tuº: fd:%d %d", 
fže
->
fd
, 
n
);

191  
n
;

192 
	}
}

196 
	$ngx_fže_aio_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
)

198 
ngx_ev’t_aio_t
 *
aio
;

200 
aio
 = 
ev
->
d©a
;

202 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
ev
->
log
, 0,

203 "aiØev’ˆhªdË¸fd:%d %V", 
aio
->
fd
, &aio->
fže
->
Çme
);

205 ià(
	`ngx_fže_aio_»suÉ
(
aio
->
fže
,‡io, 
ev
è!ð
NGX_AGAIN
) {

206 
aio
->
	`hªdËr
(
ev
);

208 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_files.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 #ià(
NGX_HAVE_FILE_AIO
)

14 
ngx_ušt_t
 
	gngx_fže_aio
 = 1;

19 
ssize_t


20 
	$ngx_»ad_fže
(
ngx_fže_t
 *
fže
, 
u_ch¬
 *
buf
, 
size_t
 
size
, 
off_t
 
off£t
)

22 
ssize_t
 
n
;

24 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

25 "»ad: %d, %p, %uz, %O", 
fže
->
fd
, 
buf
, 
size
, 
off£t
);

27 #ià(
NGX_HAVE_PREAD
)

29 
n
 = 
	`´—d
(
fže
->
fd
, 
buf
, 
size
, 
off£t
);

31 ià(
n
 == -1) {

32 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

33 "´—d(è\"%s\" fažed", 
fže
->
Çme
.
d©a
);

34  
NGX_ERROR
;

39 ià(
fže
->
sys_off£t
 !ð
off£t
) {

40 ià(
	`l£ek
(
fže
->
fd
, 
off£t
, 
SEEK_SET
) == -1) {

41 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

42 "l£ek(è\"%s\" fažed", 
fže
->
Çme
.
d©a
);

43  
NGX_ERROR
;

46 
fže
->
sys_off£t
 = 
off£t
;

49 
n
 = 
	`»ad
(
fže
->
fd
, 
buf
, 
size
);

51 ià(
n
 == -1) {

52 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

53 "»ad(è\"%s\" fažed", 
fže
->
Çme
.
d©a
);

54  
NGX_ERROR
;

57 
fže
->
sys_off£t
 +ð
n
;

61 
fže
->
off£t
 +ð
n
;

63  
n
;

64 
	}
}

67 
ssize_t


68 
	$ngx_wr™e_fže
(
ngx_fže_t
 *
fže
, 
u_ch¬
 *
buf
, 
size_t
 
size
, 
off_t
 
off£t
)

70 
ssize_t
 
n
, 
wr™‹n
;

72 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

73 "wr™e: %d, %p, %uz, %O", 
fže
->
fd
, 
buf
, 
size
, 
off£t
);

75 
wr™‹n
 = 0;

77 #ià(
NGX_HAVE_PWRITE
)

80 
n
 = 
	`pwr™e
(
fže
->
fd
, 
buf
 + 
wr™‹n
, 
size
, 
off£t
);

82 ià(
n
 == -1) {

83 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

84 "pwr™e(è\"%s\" fažed", 
fže
->
Çme
.
d©a
);

85  
NGX_ERROR
;

88 
fže
->
off£t
 +ð
n
;

89 
wr™‹n
 +ð
n
;

91 ià((
size_t
è
n
 =ð
size
) {

92  
wr™‹n
;

95 
off£t
 +ð
n
;

96 
size
 -ð
n
;

101 ià(
fže
->
sys_off£t
 !ð
off£t
) {

102 ià(
	`l£ek
(
fže
->
fd
, 
off£t
, 
SEEK_SET
) == -1) {

103 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

104 "l£ek(è\"%s\" fažed", 
fže
->
Çme
.
d©a
);

105  
NGX_ERROR
;

108 
fže
->
sys_off£t
 = 
off£t
;

112 
n
 = 
	`wr™e
(
fže
->
fd
, 
buf
 + 
wr™‹n
, 
size
);

114 ià(
n
 == -1) {

115 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

116 "wr™e(è\"%s\" fažed", 
fže
->
Çme
.
d©a
);

117  
NGX_ERROR
;

120 
fže
->
off£t
 +ð
n
;

121 
wr™‹n
 +ð
n
;

123 ià((
size_t
è
n
 =ð
size
) {

124  
wr™‹n
;

127 
size
 -ð
n
;

130 
	}
}

133 
ngx_fd_t


134 
	$ngx_Ý’_‹mpfže
(
u_ch¬
 *
Çme
, 
ngx_ušt_t
 
³rsi¡’t
,‚gx_ušt_ˆ
acûss
)

136 
ngx_fd_t
 
fd
;

138 
fd
 = 
	`Ý’
((cÚ¡ *è
Çme
, 
O_CREAT
|
O_EXCL
|
O_RDWR
,

139 
acûss
 ?‡ccess : 0600);

141 ià(
fd
 !ð-1 && !
³rsi¡’t
) {

142 (è
	`uÆšk
((cÚ¡ *è
Çme
);

145  
fd
;

146 
	}
}

149 
	#NGX_IOVS
 8

	)

151 
ssize_t


152 
	$ngx_wr™e_chaš_to_fže
(
ngx_fže_t
 *
fže
, 
ngx_chaš_t
 *
þ
, 
off_t
 
off£t
,

153 
ngx_poÞ_t
 *
poÞ
)

155 
u_ch¬
 *
´ev
;

156 
size_t
 
size
;

157 
ssize_t
 
tÙ®
, 
n
;

158 
ngx_¬¿y_t
 
vec
;

159 
iovec
 *
iov
, 
iovs
[
NGX_IOVS
];

163 ià(
þ
->
Ãxt
 =ð
NULL
) {

164  
	`ngx_wr™e_fže
(
fže
, 
þ
->
buf
->
pos
,

165 (
size_t
è(
þ
->
buf
->
Ï¡
 - cl->buf->
pos
),

166 
off£t
);

169 
tÙ®
 = 0;

171 
vec
.
–ts
 = 
iovs
;

172 
vec
.
size
 = (
iovec
);

173 
vec
.
ÇÎoc
 = 
NGX_IOVS
;

174 
vec
.
poÞ
 =…ool;

177 
´ev
 = 
NULL
;

178 
iov
 = 
NULL
;

179 
size
 = 0;

181 
vec
.
ÃÉs
 = 0;

185 
þ
 && 
vec
.
ÃÉs
 < 
IOV_MAX
) {

186 ià(
´ev
 =ð
þ
->
buf
->
pos
) {

187 
iov
->
iov_Ën
 +ð
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

190 
iov
 = 
	`ngx_¬¿y_push
(&
vec
);

191 ià(
iov
 =ð
NULL
) {

192  
NGX_ERROR
;

195 
iov
->
iov_ba£
 = (*è
þ
->
buf
->
pos
;

196 
iov
->
iov_Ën
 = 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

199 
size
 +ð
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

200 
´ev
 = 
þ
->
buf
->
Ï¡
;

201 
þ
 = cl->
Ãxt
;

206 ià(
vec
.
ÃÉs
 == 1) {

207 
iov
 = 
vec
.
–ts
;

209 
n
 = 
	`ngx_wr™e_fže
(
fže
, (
u_ch¬
 *è
iov
[0].
iov_ba£
,

210 
iov
[0].
iov_Ën
, 
off£t
);

212 ià(
n
 =ð
NGX_ERROR
) {

213  
n
;

216  
tÙ®
 + 
n
;

219 ià(
fže
->
sys_off£t
 !ð
off£t
) {

220 ià(
	`l£ek
(
fže
->
fd
, 
off£t
, 
SEEK_SET
) == -1) {

221 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

222 "l£ek(è\"%s\" fažed", 
fže
->
Çme
.
d©a
);

223  
NGX_ERROR
;

226 
fže
->
sys_off£t
 = 
off£t
;

229 
n
 = 
	`wr™ev
(
fže
->
fd
, 
vec
.
–ts
, vec.
ÃÉs
);

231 ià(
n
 == -1) {

232 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

233 "wr™ev(è\"%s\" fažed", 
fže
->
Çme
.
d©a
);

234  
NGX_ERROR
;

237 ià((
size_t
è
n
 !ð
size
) {

238 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 0,

240 
fže
->
Çme
.
d©a
, 
n
, 
size
);

241  
NGX_ERROR
;

244 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

245 "wr™ev: %d, %z", 
fže
->
fd
, 
n
);

247 
fže
->
sys_off£t
 +ð
n
;

248 
fže
->
off£t
 +ð
n
;

249 
off£t
 +ð
n
;

250 
tÙ®
 +ð
n
;

252 } 
þ
);

254  
tÙ®
;

255 
	}
}

258 
ngx_št_t


259 
	$ngx_£t_fže_time
(
u_ch¬
 *
Çme
, 
ngx_fd_t
 
fd
, 
time_t
 
s
)

261 
timev®
 
tv
[2];

263 
tv
[0].
tv_£c
 = 
	`ngx_time
();

264 
tv
[0].
tv_u£c
 = 0;

265 
tv
[1].
tv_£c
 = 
s
;

266 
tv
[1].
tv_u£c
 = 0;

268 ià(
	`utimes
((*è
Çme
, 
tv
) != -1) {

269  
NGX_OK
;

272  
NGX_ERROR
;

273 
	}
}

276 
ngx_št_t


277 
	$ngx_ü—‹_fže_m­pšg
(
ngx_fže_m­pšg_t
 *
fm
)

279 
fm
->
fd
 = 
	`ngx_Ý’_fže
(fm->
Çme
, 
NGX_FILE_RDWR
, 
NGX_FILE_TRUNCATE
,

280 
NGX_FILE_DEFAULT_ACCESS
);

281 ià(
fm
->
fd
 =ð
NGX_INVALID_FILE
) {

282 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fm
->
log
, 
ngx_”ºo
,

283 
ngx_Ý’_fže_n
 " \"%s\" fažed", 
fm
->
Çme
);

284  
NGX_ERROR
;

287 ià(
	`árunÿ‹
(
fm
->
fd
, fm->
size
) == -1) {

288 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fm
->
log
, 
ngx_”ºo
,

289 "árunÿ‹(è\"%s\" fažed", 
fm
->
Çme
);

290 
çžed
;

293 
fm
->
addr
 = 
	`mm­
(
NULL
, fm->
size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
,

294 
fm
->
fd
, 0);

295 ià(
fm
->
addr
 !ð
MAP_FAILED
) {

296  
NGX_OK
;

299 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fm
->
log
, 
ngx_”ºo
,

300 "mm­(%uzè\"%s\" fažed", 
fm
->
size
, fm->
Çme
);

302 
çžed
:

304 ià(
	`ngx_þo£_fže
(
fm
->
fd
è=ð
NGX_FILE_ERROR
) {

305 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
fm
->
log
, 
ngx_”ºo
,

306 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fm
->
Çme
);

309  
NGX_ERROR
;

310 
	}
}

314 
	$ngx_þo£_fže_m­pšg
(
ngx_fže_m­pšg_t
 *
fm
)

316 ià(
	`munm­
(
fm
->
addr
, fm->
size
) == -1) {

317 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fm
->
log
, 
ngx_”ºo
,

318 "munm­(%uzè\"%s\" fažed", 
fm
->
size
, fm->
Çme
);

321 ià(
	`ngx_þo£_fže
(
fm
->
fd
è=ð
NGX_FILE_ERROR
) {

322 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
fm
->
log
, 
ngx_”ºo
,

323 
ngx_þo£_fže_n
 " \"%s\" fažed", 
fm
->
Çme
);

325 
	}
}

328 
ngx_št_t


329 
	$ngx_Ý’_dœ
(
ngx_¡r_t
 *
Çme
, 
ngx_dœ_t
 *
dœ
)

331 
dœ
->dœ = 
	`Ý’dœ
((cÚ¡ *è
Çme
->
d©a
);

333 ià(
dœ
->dœ =ð
NULL
) {

334  
NGX_ERROR
;

337 
dœ
->
v®id_šfo
 = 0;

339  
NGX_OK
;

340 
	}
}

343 
ngx_št_t


344 
	$ngx_»ad_dœ
(
ngx_dœ_t
 *
dœ
)

346 
dœ
->
de
 = 
	`»addœ
(dir->dir);

348 ià(
dœ
->
de
) {

349 #ià(
NGX_HAVE_D_TYPE
)

350 
dœ
->
ty³
 = dœ->
de
->
d_ty³
;

352 
dœ
->
ty³
 = 0;

354  
NGX_OK
;

357  
NGX_ERROR
;

358 
	}
}

361 
ngx_št_t


362 
	$ngx_Ý’_glob
(
ngx_glob_t
 *
gl
)

364 
n
;

366 
n
 = 
	`glob
((*è
gl
->
·‰”n
, 0, 
NULL
, &gl->
pglob
);

368 ià(
n
 == 0) {

369  
NGX_OK
;

372 #ifdeà
GLOB_NOMATCH


374 ià(
n
 =ð
GLOB_NOMATCH
 && 
gl
->
‹¡
) {

375  
NGX_OK
;

380  
NGX_ERROR
;

381 
	}
}

384 
ngx_št_t


385 
	$ngx_»ad_glob
(
ngx_glob_t
 *
gl
, 
ngx_¡r_t
 *
Çme
)

387 
size_t
 
couÁ
;

389 #ifdeà
GLOB_NOMATCH


390 
couÁ
 = (
size_t
è
gl
->
pglob
.
gl_·thc
;

392 
couÁ
 = (
size_t
è
gl
->
pglob
.
gl_m©chc
;

395 ià(
gl
->
n
 < 
couÁ
) {

397 
Çme
->
Ën
 = (
size_t
è
	`ngx_¡¾’
(
gl
->
pglob
.
gl_·thv
[gl->
n
]);

398 
Çme
->
d©a
 = (
u_ch¬
 *è
gl
->
pglob
.
gl_·thv
[gl->
n
];

399 
gl
->
n
++;

401  
NGX_OK
;

404  
NGX_DONE
;

405 
	}
}

409 
	$ngx_þo£_glob
(
ngx_glob_t
 *
gl
)

411 
	`globä“
(&
gl
->
pglob
);

412 
	}
}

415 
ngx_”r_t


416 
	$ngx_Œylock_fd
(
ngx_fd_t
 
fd
)

418 
æock
 
æ
;

420 
	`ngx_memz”o
(&
æ
, (
æock
));

421 
æ
.
l_ty³
 = 
F_WRLCK
;

422 
æ
.
l_wh’û
 = 
SEEK_SET
;

424 ià(
	`fúŽ
(
fd
, 
F_SETLK
, &
æ
) == -1) {

425  
ngx_”ºo
;

429 
	}
}

432 
ngx_”r_t


433 
	$ngx_lock_fd
(
ngx_fd_t
 
fd
)

435 
æock
 
æ
;

437 
	`ngx_memz”o
(&
æ
, (
æock
));

438 
æ
.
l_ty³
 = 
F_WRLCK
;

439 
æ
.
l_wh’û
 = 
SEEK_SET
;

441 ià(
	`fúŽ
(
fd
, 
F_SETLKW
, &
æ
) == -1) {

442  
ngx_”ºo
;

446 
	}
}

449 
ngx_”r_t


450 
	$ngx_uÆock_fd
(
ngx_fd_t
 
fd
)

452 
æock
 
æ
;

454 
	`ngx_memz”o
(&
æ
, (
æock
));

455 
æ
.
l_ty³
 = 
F_UNLCK
;

456 
æ
.
l_wh’û
 = 
SEEK_SET
;

458 ià(
	`fúŽ
(
fd
, 
F_SETLK
, &
æ
) == -1) {

459  
ngx_”ºo
;

463 
	}
}

466 #ià(
NGX_HAVE_POSIX_FADVISE
è&& !(
NGX_HAVE_F_READAHEAD
)

468 
ngx_št_t


469 
	$ngx_»ad_ah—d
(
ngx_fd_t
 
fd
, 
size_t
 
n
)

471 
”r
;

473 
”r
 = 
	`posix_çdvi£
(
fd
, 0, 0, 
POSIX_FADV_SEQUENTIAL
);

475 ià(
”r
 == 0) {

479 
	`ngx_£t_”ºo
(
”r
);

480  
NGX_FILE_ERROR
;

481 
	}
}

486 #ià(
NGX_HAVE_O_DIRECT
)

488 
ngx_št_t


489 
	$ngx_dœeùio_Ú
(
ngx_fd_t
 
fd
)

491 
æags
;

493 
æags
 = 
	`fúŽ
(
fd
, 
F_GETFL
);

495 ià(
æags
 == -1) {

496  
NGX_FILE_ERROR
;

499  
	`fúŽ
(
fd
, 
F_SETFL
, 
æags
 | 
O_DIRECT
);

500 
	}
}

503 
ngx_št_t


504 
	$ngx_dœeùio_off
(
ngx_fd_t
 
fd
)

506 
æags
;

508 
æags
 = 
	`fúŽ
(
fd
, 
F_GETFL
);

510 ià(
æags
 == -1) {

511  
NGX_FILE_ERROR
;

514  
	`fúŽ
(
fd
, 
F_SETFL
, 
æags
 & ~
O_DIRECT
);

515 
	}
}

520 #ià(
NGX_HAVE_STATFS
)

522 
size_t


523 
	$ngx_fs_bsize
(
u_ch¬
 *
Çme
)

525 
¡©fs
 
fs
;

527 ià(
	`¡©fs
((*è
Çme
, &
fs
) == -1) {

531 ià((
fs
.
f_bsize
 % 512) != 0) {

535  (
size_t
è
fs
.
f_bsize
;

536 
	}
}

538 #–ià(
NGX_HAVE_STATVFS
)

540 
size_t


541 
	$ngx_fs_bsize
(
u_ch¬
 *
Çme
)

543 
¡©vfs
 
fs
;

545 ià(
	`¡©vfs
((*è
Çme
, &
fs
) == -1) {

549 ià((
fs
.
f_äsize
 % 512) != 0) {

553  (
size_t
è
fs
.
f_äsize
;

554 
	}
}

558 
size_t


559 
	$ngx_fs_bsize
(
u_ch¬
 *
Çme
)

562 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_freebsd_init.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

13 
	gngx_ä“bsd_k”n_o¡y³
[16];

14 
	gngx_ä“bsd_k”n_o¤–—£
[128];

15 
	gngx_ä“bsd_k”n_o¤–d©e
;

16 
	gngx_ä“bsd_hw_nýu
;

17 
	gngx_ä“bsd_k”n_c_somaxcÚn
;

18 
u_lÚg
 
	gngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
;

21 
	gngx_ä“bsd_machd•_hÉ_logiÿl_ýus
;

24 
ngx_ušt_t
 
	gngx_ä“bsd_£ndfže_nby‹s_bug
;

25 
ngx_ušt_t
 
	gngx_ä“bsd_u£_tý_nÝush
;

27 
ngx_ušt_t
 
	gngx_debug_m®loc
;

30 
ngx_os_io_t
 
	gngx_ä“bsd_io
 = {

31 
ngx_unix_»cv
,

32 
ngx_»adv_chaš
,

33 
ngx_udp_unix_»cv
,

34 
ngx_unix_£nd
,

35 #ià(
NGX_HAVE_SENDFILE
)

36 
ngx_ä“bsd_£ndfže_chaš
,

37 
NGX_IO_SENDFILE


39 
ngx_wr™ev_chaš
,

46 *
	mÇme
;

47 *
	mv®ue
;

48 
size_t
 
	msize
;

49 
ngx_ušt_t
 
	mexi¡s
;

50 } 
	tsysùl_t
;

53 
sysùl_t
 
	gsysùls
[] = {

55 &
ngx_ä“bsd_hw_nýu
,

56 (
ngx_ä“bsd_hw_nýu
), 0 },

59 &
ngx_ä“bsd_machd•_hÉ_logiÿl_ýus
,

60 (
ngx_ä“bsd_machd•_hÉ_logiÿl_ýus
), 0 },

63 &
ngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
,

64 (
ngx_ä“bsd_Ãt_š‘_tý_£nd¥aû
), 0 },

67 &
ngx_ä“bsd_k”n_c_somaxcÚn
,

68 (
ngx_ä“bsd_k”n_c_somaxcÚn
), 0 },

70 { 
NULL
, NULL, 0, 0 }

75 
	$ngx_debug_š™
()

77 #ià(
NGX_DEBUG_MALLOC
)

79 #ià
__F»eBSD_v”siÚ
 >= 500014 && __FreeBSD_version < 1000011

80 
_m®loc_ÝtiÚs
 = "J";

81 #–ià
__F»eBSD_v”siÚ
 < 500014

82 
m®loc_ÝtiÚs
 = "J";

85 
ngx_debug_m®loc
 = 1;

88 *
mo
;

90 
mo
 = 
	`g‘’v
("MALLOC_OPTIONS");

92 ià(
mo
 && 
	`ngx_¡rchr
(mo, 'J')) {

93 
ngx_debug_m®loc
 = 1;

96 
	}
}

99 
ngx_št_t


100 
	$ngx_os_¥ecific_š™
(
ngx_log_t
 *
log
)

102 
v”siÚ
;

103 
size_t
 
size
;

104 
ngx_”r_t
 
”r
;

105 
ngx_ušt_t
 
i
;

107 
size
 = (
ngx_ä“bsd_k”n_o¡y³
);

108 ià(
	`sysùlbyÇme
("kern.ostype",

109 
ngx_ä“bsd_k”n_o¡y³
, &
size
, 
NULL
, 0) == -1) {

110 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

113 ià(
ngx_”ºo
 !ð
NGX_ENOMEM
) {

114  
NGX_ERROR
;

117 
ngx_ä“bsd_k”n_o¡y³
[
size
 - 1] = '\0';

120 
size
 = (
ngx_ä“bsd_k”n_o¤–—£
);

121 ià(
	`sysùlbyÇme
("kern.osrelease",

122 
ngx_ä“bsd_k”n_o¤–—£
, &
size
, 
NULL
, 0) == -1) {

123 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

126 ià(
ngx_”ºo
 !ð
NGX_ENOMEM
) {

127  
NGX_ERROR
;

130 
ngx_ä“bsd_k”n_o¤–—£
[
size
 - 1] = '\0';

134 
size
 = ();

135 ià(
	`sysùlbyÇme
("kern.osreldate",

136 &
ngx_ä“bsd_k”n_o¤–d©e
, &
size
, 
NULL
, 0) == -1) {

137 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

139  
NGX_ERROR
;

142 
v”siÚ
 = 
ngx_ä“bsd_k”n_o¤–d©e
;

145 #ià(
NGX_HAVE_SENDFILE
)

163 #ià(
__F»eBSD__
 =ð4 && 
__F»eBSD_v”siÚ
 >= 460102) \

164 || 
__F»eBSD_v”siÚ
 == 460002 || __FreeBSD_version >= 500039

168 
ngx_ä“bsd_£ndfže_nby‹s_bug
 = 0;

174 
ngx_ä“bsd_£ndfže_nby‹s_bug
 = 1;

181 ià((
v”siÚ
 < 500000 && version >= 440003) || version >= 500017) {

182 
ngx_ä“bsd_u£_tý_nÝush
 = 1;

186 
i
 = 0; 
sysùls
[i].
Çme
; i++) {

187 
size
 = 
sysùls
[
i
].size;

189 ià(
	`sysùlbyÇme
(
sysùls
[
i
].
Çme
, sysùls[i].
v®ue
, &
size
, 
NULL
, 0)

192 
sysùls
[
i
].
exi¡s
 = 1;

196 
”r
 = 
ngx_”ºo
;

198 ià(
”r
 =ð
NGX_ENOENT
) {

202 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
,

203 "sysùlbyÇme(%sèçžed", 
sysùls
[
i
].
Çme
);

204  
NGX_ERROR
;

207 ià(
ngx_ä“bsd_machd•_hÉ_logiÿl_ýus
) {

208 
ngx_nýu
 = 
ngx_ä“bsd_hw_nýu
 / 2;

211 
ngx_nýu
 = 
ngx_ä“bsd_hw_nýu
;

214 ià(
v”siÚ
 < 600008 && 
ngx_ä“bsd_k”n_c_somaxcÚn
 > 32767) {

215 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

217  
NGX_ERROR
;

220 
ngx_tý_nod–ay_ªd_tý_nÝush
 = 1;

222 
ngx_os_io
 = 
ngx_ä“bsd_io
;

224  
NGX_OK
;

225 
	}
}

229 
	$ngx_os_¥ecific_¡©us
(
ngx_log_t
 *
log
)

231 
u_lÚg
 
v®ue
;

232 
ngx_ušt_t
 
i
;

234 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "OS: %s %s",

235 
ngx_ä“bsd_k”n_o¡y³
, 
ngx_ä“bsd_k”n_o¤–—£
);

237 #ifdeà
__D¿gÚFly_v”siÚ


238 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0,

240 
ngx_ä“bsd_k”n_o¤–d©e
, 
__D¿gÚFly_v”siÚ
);

242 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0,

244 
ngx_ä“bsd_k”n_o¤–d©e
, 
__F»eBSD_v”siÚ
);

247 
i
 = 0; 
sysùls
[i].
Çme
; i++) {

248 ià(
sysùls
[
i
].
exi¡s
) {

249 ià(
sysùls
[
i
].
size
 == ()) {

250 
v®ue
 = *(*è
sysùls
[
i
].value;

253 
v®ue
 = *(*è
sysùls
[
i
].value;

256 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "%s: %l",

257 
sysùls
[
i
].
Çme
, 
v®ue
);

260 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_freebsd_rfork_thread.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

35 *
	gngx_ä“bsd_k”n_u¤¡ack
;

36 
size_t
 
	gngx_th»ad_¡ack_size
;

39 
size_t
 
	grz_size
;

40 
size_t
 
	gu§bË_¡ack_size
;

41 *
	gÏ¡_¡ack
;

43 
ngx_ušt_t
 
	gÁh»ads
;

44 
ngx_ušt_t
 
	gmax_th»ads
;

46 
ngx_ušt_t
 
	gnkeys
;

47 
ngx_tid_t
 *
	gtids
;

48 **
	gngx_Žs
;

52 
	g”ºo0
;

53 *
	g”ºos
;

56 
	$__”rÜ
()

58 
tid
;

60 
tid
 = 
	`ngx_g‘tid
();

62  
tid
 ? &
”ºos
[tid - 1] : &
”ºo0
;

63 
	}
}

75 
__i¡h»aded
;

78 
	$_¥šlock
(
ngx_©omic_t
 *
lock
)

80 
ngx_št_t
 
Œ›s
;

82 
Œ›s
 = 0;

86 ià(*
lock
) {

87 ià(
ngx_nýu
 > 1 && 
Œ›s
++ < 1000) {

91 
	`sched_y›ld
();

92 
Œ›s
 = 0;

95 ià(
	`ngx_©omic_cmp_£t
(
lock
, 0, 1)) {

100 
	}
}

111 #iâdeà
_¥šuÆock


114 
	$_¥šuÆock
(
ngx_©omic_t
 *
lock
)

116 *
lock
 = 0;

117 
	}
}

122 
ngx_”r_t


123 
ngx_ü—‹_th»ad
(
ngx_tid_t
 *
tid
, 
	$ngx_th»ad_v®ue_t
 (*
func
)(*
¬g
),

124 *
¬g
, 
ngx_log_t
 *
log
)

126 
ngx_pid_t
 
id
;

127 
ngx_”r_t
 
”r
;

128 *
¡ack
, *
¡ack_tÝ
;

130 ià(
Áh»ads
 >ð
max_th»ads
) {

131 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
log
, 0,

132 "nØmÜthª %u˜th»ad ÿÀbü—‹d", 
max_th»ads
);

133  
NGX_ERROR
;

136 
Ï¡_¡ack
 -ð
ngx_th»ad_¡ack_size
;

138 
¡ack
 = 
	`mm­
(
Ï¡_¡ack
, 
u§bË_¡ack_size
, 
PROT_READ
|
PROT_WRITE
,

139 
MAP_STACK
, -1, 0);

141 ià(
¡ack
 =ð
MAP_FAILED
) {

142 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

144 
Ï¡_¡ack
, 
u§bË_¡ack_size
);

145  
NGX_ERROR
;

148 ià(
¡ack
 !ð
Ï¡_¡ack
) {

149 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

150 "¡ack %°add»s wa chªgedØ%p", 
Ï¡_¡ack
, 
¡ack
);

151  
NGX_ERROR
;

154 
¡ack_tÝ
 = 
¡ack
 + 
u§bË_¡ack_size
;

156 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

157 "th»ad sck: %p-%p", 
¡ack
, 
¡ack_tÝ
);

159 
	`ngx_£t_”ºo
(0);

161 
id
 = 
	`rfÜk_th»ad
(
RFPROC
|
RFTHREAD
|
RFMEM
, 
¡ack_tÝ
,

162 (
ngx_rfÜk_th»ad_func_±
è
func
, 
¬g
);

164 
”r
 = 
ngx_”ºo
;

166 ià(
id
 == -1) {

167 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
, "rfork() failed");

170 *
tid
 = 
id
;

171 
Áh»ads
 = (
ngx_ä“bsd_k”n_u¤¡ack
 - 
¡ack_tÝ
)

172 / 
ngx_th»ad_¡ack_size
;

173 
tids
[
Áh»ads
] = 
id
;

175 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "rfÜk(ëdh»ad: %P", 
id
);

178  
”r
;

179 
	}
}

182 
ngx_št_t


183 
	$ngx_š™_th»ads
(
n
, 
size_t
 
size
, 
ngx_cyþe_t
 *
cyþe
)

185 *
»d_zÚe
, *
zÚe
;

186 
size_t
 
Ën
;

187 
ngx_št_t
 
i
;

188 
sigaùiÚ
 
§
;

190 
max_th»ads
 = 
n
 + 1;

192 
i
 = 0; i < 
n
; i++) {

193 
	`ngx_memz”o
(&
§
, (
sigaùiÚ
));

194 
§
.
§_hªdËr
 = 
SIG_IGN
;

195 
	`sigem±y£t
(&
§
.
§_mask
);

196 ià(
	`sigaùiÚ
(
NGX_CV_SIGNAL
, &
§
, 
NULL
) == -1) {

197 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

198 "sigaùiÚ(%d, SIG_IGNèçžed", 
NGX_CV_SIGNAL
);

199  
NGX_ERROR
;

203 
Ën
 = (
ngx_ä“bsd_k”n_u¤¡ack
);

204 ià(
	`sysùlbyÇme
("k”n.u¤¡ack", &
ngx_ä“bsd_k”n_u¤¡ack
, &
Ën
,

205 
NULL
, 0) == -1)

207 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

209  
NGX_ERROR
;

213 
rz_size
 = 
ngx_·gesize
;

214 
»d_zÚe
 = 
ngx_ä“bsd_k”n_u¤¡ack
 - (
size
 + 
rz_size
);

216 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

218 
ngx_ä“bsd_k”n_u¤¡ack
, 
»d_zÚe
);

220 
zÚe
 = 
	`mm­
(
»d_zÚe
, 
rz_size
, 
PROT_NONE
, 
MAP_ANON
, -1, 0);

221 ià(
zÚe
 =ð
MAP_FAILED
) {

222 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

224 
»d_zÚe
, 
rz_size
);

225  
NGX_ERROR
;

228 ià(
zÚe
 !ð
»d_zÚe
) {

229 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

230 "»d zÚ%°add»s wa chªgedØ%p", 
»d_zÚe
, 
zÚe
);

231  
NGX_ERROR
;

236 
”ºos
 = 
	`ngx_ÿÎoc
(
n
 * (), 
cyþe
->
log
);

237 ià(
”ºos
 =ð
NULL
) {

238  
NGX_ERROR
;

243 
tids
 = 
	`ngx_ÿÎoc
((
n
 + 1è* (
ngx_tid_t
), 
cyþe
->
log
);

244 ià(
tids
 =ð
NULL
) {

245  
NGX_ERROR
;

248 
tids
[0] = 
ngx_pid
;

252 
ngx_Žs
 = 
	`ngx_ÿÎoc
(
NGX_THREAD_KEYS_MAX
 * (
n
 + 1) * (*),

253 
cyþe
->
log
);

254 ià(
ngx_Žs
 =ð
NULL
) {

255  
NGX_ERROR
;

258 
Áh»ads
 = 1;

260 
Ï¡_¡ack
 = 
zÚe
 + 
rz_size
;

261 
u§bË_¡ack_size
 = 
size
;

262 
ngx_th»ad_¡ack_size
 = 
size
 + 
rz_size
;

265 
__i¡h»aded
 = 1;

267 
ngx_th»aded
 = 1;

269  
NGX_OK
;

270 
	}
}

273 
ngx_tid_t


274 
	$ngx_th»ad_£lf
()

276 
ngx_št_t
 
tid
;

278 
tid
 = 
	`ngx_g‘tid
();

280 ià(
tids
 =ð
NULL
) {

281  
ngx_pid
;

284  
tids
[
tid
];

285 
	}
}

288 
ngx_”r_t


289 
	$ngx_th»ad_key_ü—‹
(
ngx_Žs_key_t
 *
key
)

291 ià(
nkeys
 >ð
NGX_THREAD_KEYS_MAX
) {

292  
NGX_ENOMEM
;

295 *
key
 = 
nkeys
++;

298 
	}
}

301 
ngx_”r_t


302 
	$ngx_th»ad_£t_Žs
(
ngx_Žs_key_t
 
key
, *
v®ue
)

304 ià(
key
 >ð
NGX_THREAD_KEYS_MAX
) {

305  
NGX_EINVAL
;

308 
ngx_Žs
[
key
 * 
NGX_THREAD_KEYS_MAX
 + 
	`ngx_g‘tid
()] = 
v®ue
;

310 
	}
}

313 
ngx_mu‹x_t
 *

314 
	$ngx_mu‹x_š™
(
ngx_log_t
 *
log
, 
ngx_ušt_t
 
æags
)

316 
ngx_mu‹x_t
 *
m
;

317 
£mun
 
Ý
;

319 
m
 = 
	`ngx_®loc
((
ngx_mu‹x_t
), 
log
);

320 ià(
m
 =ð
NULL
) {

321  
NULL
;

324 
m
->
lock
 = 0;

325 
m
->
log
 =†og;

327 ià(
æags
 & 
NGX_MUTEX_LIGHT
) {

328 
m
->
£mid
 = -1;

329  
m
;

332 
m
->
£mid
 = 
	`£mg‘
(
IPC_PRIVATE
, 1, 
SEM_R
|
SEM_A
);

333 ià(
m
->
£mid
 == -1) {

334 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
, "semget() failed");

335  
NULL
;

338 
Ý
.
v®
 = 0;

340 ià(
	`£mùl
(
m
->
£mid
, 0, 
SETVAL
, 
Ý
) == -1) {

341 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
, "semctl(SETVAL) failed");

343 ià(
	`£mùl
(
m
->
£mid
, 0, 
IPC_RMID
) == -1) {

344 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

348  
NULL
;

351  
m
;

352 
	}
}

356 
	$ngx_mu‹x_de¡roy
(
ngx_mu‹x_t
 *
m
)

358 ià(
	`£mùl
(
m
->
£mid
, 0, 
IPC_RMID
) == -1) {

359 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
ngx_”ºo
,

363 
	`ngx_ä“
((*è
m
);

364 
	}
}

367 
ngx_št_t


368 
	$ngx_mu‹x_dÞock
(
ngx_mu‹x_t
 *
m
, 
ngx_št_t
 
Œy
)

370 
ušt32_t
 
lock
, 
Þd
;

371 
ngx_ušt_t
 
Œ›s
;

372 
£mbuf
 
Ý
;

374 ià(!
ngx_th»aded
) {

375  
NGX_OK
;

378 #ià(
NGX_DEBUG
)

379 ià(
Œy
) {

380 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

381 "Œy†ock mu‹x %°lock:%XD", 
m
, m->
lock
);

383 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

384 "lock mu‹x %°lock:%XD", 
m
, m->
lock
);

388 
Þd
 = 
m
->
lock
;

389 
Œ›s
 = 0;

392 ià(
Þd
 & 
NGX_MUTEX_LOCK_BUSY
) {

394 ià(
Œy
) {

395  
NGX_AGAIN
;

398 ià(
ngx_nýu
 > 1 && 
Œ›s
++ < 1000) {

402 
Þd
 = 
m
->
lock
;

406 ià(
m
->
£mid
 == -1) {

407 
	`sched_y›ld
();

409 
Œ›s
 = 0;

410 
Þd
 = 
m
->
lock
;

414 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

415 "mu‹x %°lock:%XD", 
m
, m->
lock
);

422 
lock
 = 
Þd
 + 1;

424 ià((
lock
 & ~
NGX_MUTEX_LOCK_BUSY
è> 
Áh»ads
) {

425 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
ngx_”ºo
,

428 
lock
 & ~
NGX_MUTEX_LOCK_BUSY
, 
m
, 
Áh»ads
);

429 
	`ngx_abÜt
();

432 ià(
	`ngx_©omic_cmp_£t
(&
m
->
lock
, 
Þd
,†ock)) {

434 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

435 "wa™ mu‹x %°lock:%XD", 
m
, m->
lock
);

444 
Ý
.
£m_num
 = 0;

445 
Ý
.
£m_Ý
 = -1;

446 
Ý
.
£m_æg
 = 0;

448 ià(
	`£mÝ
(
m
->
£mid
, &
Ý
, 1) == -1) {

449 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
ngx_”ºo
,

450 "£mÝ(èçžed whžwa™šg oÀmu‹x %p", 
m
);

451 
	`ngx_abÜt
();

454 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

455 "mu‹x waked u°%°lock:%XD", 
m
, m->
lock
);

457 
Œ›s
 = 0;

458 
Þd
 = 
m
->
lock
;

462 
Þd
 = 
m
->
lock
;

465 
lock
 = 
Þd
 | 
NGX_MUTEX_LOCK_BUSY
;

467 ià(
	`ngx_©omic_cmp_£t
(&
m
->
lock
, 
Þd
,†ock)) {

474 
Þd
 = 
m
->
lock
;

477 ià(
Œ›s
++ > 1000) {

479 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

480 "mu‹x %°i cÚ‹¡ed", 
m
);

484 
	`sched_y›ld
();

486 
Œ›s
 = 0;

487 
Þd
 = 
m
->
lock
;

491 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

492 "mu‹x %°i locked,†ock:%XD", 
m
, m->
lock
);

494  
NGX_OK
;

495 
	}
}

499 
	$ngx_mu‹x_uÆock
(
ngx_mu‹x_t
 *
m
)

501 
ušt32_t
 
lock
, 
Þd
;

502 
£mbuf
 
Ý
;

504 ià(!
ngx_th»aded
) {

508 
Þd
 = 
m
->
lock
;

510 ià(!(
Þd
 & 
NGX_MUTEX_LOCK_BUSY
)) {

511 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 0,

512 "ŒyšgØuÆockhä“ mu‹x %p", 
m
);

513 
	`ngx_abÜt
();

519 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

520 "uÆock mu‹x %°lock:%XD", 
m
, 
Þd
);

524 
lock
 = 
Þd
 & ~
NGX_MUTEX_LOCK_BUSY
;

526 ià(
	`ngx_©omic_cmp_£t
(&
m
->
lock
, 
Þd
,†ock)) {

530 
Þd
 = 
m
->
lock
;

533 ià(
m
->
£mid
 == -1) {

534 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

535 "mu‹x %°i uÆocked", 
m
);

542 
Þd
 = 
m
->
lock
;

545 ià(
Þd
 & 
NGX_MUTEX_LOCK_BUSY
) {

552 ià(
Þd
 == 0) {

558 
lock
 = 
Þd
 - 1;

560 ià(
	`ngx_©omic_cmp_£t
(&
m
->
lock
, 
Þd
,†ock)) {

564 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

565 "waku°mu‹x %p", 
m
);

567 
Ý
.
£m_num
 = 0;

568 
Ý
.
£m_Ý
 = 1;

569 
Ý
.
£m_æg
 = 0;

571 ià(
	`£mÝ
(
m
->
£mid
, &
Ý
, 1) == -1) {

572 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
ngx_”ºo
,

573 "£mÝ(èçžed whžwakšg u°Ú mu‹x %p", 
m
);

574 
	`ngx_abÜt
();

580 
Þd
 = 
m
->
lock
;

583 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0,

584 "mu‹x %°i uÆocked", 
m
);

587 
	}
}

590 
ngx_cÚd_t
 *

591 
	$ngx_cÚd_š™
(
ngx_log_t
 *
log
)

593 
ngx_cÚd_t
 *
cv
;

595 
cv
 = 
	`ngx_®loc
((
ngx_cÚd_t
), 
log
);

596 ià(
cv
 =ð
NULL
) {

597  
NULL
;

600 
cv
->
signo
 = 
NGX_CV_SIGNAL
;

601 
cv
->
tid
 = -1;

602 
cv
->
log
 =†og;

603 
cv
->
kq
 = -1;

605  
cv
;

606 
	}
}

610 
	$ngx_cÚd_de¡roy
(
ngx_cÚd_t
 *
cv
)

612 ià(
	`þo£
(
cv
->
kq
) == -1) {

613 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 
ngx_”ºo
,

617 
	`ngx_ä“
(
cv
);

618 
	}
}

621 
ngx_št_t


622 
	$ngx_cÚd_wa™
(
ngx_cÚd_t
 *
cv
, 
ngx_mu‹x_t
 *
m
)

624 
n
;

625 
ngx_”r_t
 
”r
;

626 
kev’t
 
kev
;

627 
time¥ec
 
ts
;

629 ià(
cv
->
kq
 == -1) {

639 
cv
->
kq
 = 
	`kqueue
();

640 ià(
cv
->
kq
 == -1) {

641 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 
ngx_”ºo
, "kqueue() failed");

642  
NGX_ERROR
;

645 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0,

646 "cv kq:%d signo:%d", 
cv
->
kq
, cv->
signo
);

648 
kev
.
id’t
 = 
cv
->
signo
;

649 
kev
.
fž‹r
 = 
EVFILT_SIGNAL
;

650 
kev
.
æags
 = 
EV_ADD
;

651 
kev
.
fæags
 = 0;

652 
kev
.
d©a
 = 0;

653 
kev
.
ud©a
 = 
NULL
;

655 
ts
.
tv_£c
 = 0;

656 
ts
.
tv_n£c
 = 0;

658 ià(
	`kev’t
(
cv
->
kq
, &
kev
, 1, 
NULL
, 0, &
ts
) == -1) {

659 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 
ngx_”ºo
, "kevent() failed");

660  
NGX_ERROR
;

663 
cv
->
tid
 = 
	`ngx_th»ad_£lf
();

666 
	`ngx_mu‹x_uÆock
(
m
);

668 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0,

669 "cv %°wa™, kq:%d, signo:%d", 
cv
, cv->
kq
, cv->
signo
);

672 
n
 = 
	`kev’t
(
cv
->
kq
, 
NULL
, 0, &
kev
, 1, NULL);

674 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0,

675 "cv %°kev’t: %d", 
cv
, 
n
);

677 ià(
n
 == -1) {

678 
”r
 = 
ngx_”ºo
;

679 
	`ngx_log_”rÜ
((
”r
 =ð
NGX_EINTR
è? 
NGX_LOG_INFO
 : 
NGX_LOG_ALERT
,

680 
cv
->
log
, 
ngx_”ºo
,

682 
cv
);

684 ià(
”r
 =ð
NGX_EINTR
) {

688  
NGX_ERROR
;

691 ià(
n
 == 0) {

692 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 0,

695 
cv
);

699 ià(
kev
.
fž‹r
 !ð
EVFILT_SIGNAL
) {

700 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 0,

703 
kev
.
fž‹r
, 
cv
);

707 ià(
kev
.
id’t
 !ð(
ušŒ_t
è
cv
->
signo
) {

708 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 0,

711 
kev
.
id’t
, 
cv
);

718 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0, "cv %p is waked up", cv);

720 
	`ngx_mu‹x_lock
(
m
);

722  
NGX_OK
;

723 
	}
}

726 
ngx_št_t


727 
	$ngx_cÚd_sigÇl
(
ngx_cÚd_t
 *
cv
)

729 
ngx_”r_t
 
”r
;

731 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0,

733 
cv
, cv->
tid
, cv->
signo
);

735 ià(
cv
->
tid
 == -1) {

736  
NGX_OK
;

739 ià(
	`kžl
(
cv
->
tid
, cv->
signo
) == -1) {

741 
”r
 = 
ngx_”ºo
;

743 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 
”r
,

744 "kžl(èçžed whžsigÇlšg cÚd™iÚ v¬ŸbË %p", 
cv
);

746 ià(
”r
 =ð
NGX_ESRCH
) {

747 
cv
->
tid
 = -1;

750  
NGX_ERROR
;

753 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0, "cv %p is signaled", cv);

755  
NGX_OK
;

756 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_freebsd_sendfile_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

32 
ngx_chaš_t
 *

33 
	$ngx_ä“bsd_£ndfže_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
)

35 
rc
, 
æags
;

36 
off_t
 
£nd
, 
´ev_£nd
, 
£Á
;

37 
size_t
 
fže_size
;

38 
ssize_t
 
n
;

39 
ngx_ušt_t
 
ešŒ
, 
—gaš
;

40 
ngx_”r_t
 
”r
;

41 
ngx_buf_t
 *
fže
;

42 
ngx_ev’t_t
 *
wev
;

43 
ngx_chaš_t
 *
þ
;

44 
ngx_iovec_t
 
h—d”
, 
Œaž”
;

45 
sf_hdŒ
 
hdŒ
;

46 
iovec
 
h—d”s
[
NGX_IOVS_PREALLOCATE
];

47 
iovec
 
Œaž”s
[
NGX_IOVS_PREALLOCATE
];

49 
wev
 = 
c
->
wr™e
;

51 ià(!
wev
->
»ady
) {

52  
š
;

55 #ià(
NGX_HAVE_KQUEUE
)

57 ià((
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
è&& 
wev
->
³ndšg_eof
) {

58 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
wev
->
kq_”ºo
,

60 
wev
->
”rÜ
 = 1;

61  
NGX_CHAIN_ERROR
;

68 ià(
lim™
 =ð0 ||†im™ > (
off_t
è(
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
)) {

69 
lim™
 = 
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
;

72 
£nd
 = 0;

73 
—gaš
 = 0;

74 
æags
 = 0;

76 
h—d”
.
iovs
 = 
h—d”s
;

77 
h—d”
.
ÇÎoc
 = 
NGX_IOVS_PREALLOCATE
;

79 
Œaž”
.
iovs
 = 
Œaž”s
;

80 
Œaž”
.
ÇÎoc
 = 
NGX_IOVS_PREALLOCATE
;

83 
ešŒ
 = 0;

84 
´ev_£nd
 = 
£nd
;

88 
þ
 = 
	`ngx_ouut_chaš_to_iovec
(&
h—d”
, 
š
, 
lim™
 - 
£nd
, 
c
->
log
);

90 ià(
þ
 =ð
NGX_CHAIN_ERROR
) {

91  
NGX_CHAIN_ERROR
;

94 
£nd
 +ð
h—d”
.
size
;

96 ià(
þ
 && cl->
buf
->
š_fže
 && 
£nd
 < 
lim™
) {

97 
fže
 = 
þ
->
buf
;

101 
fže_size
 = (
size_t
è
	`ngx_chaš_cßËsû_fže
(&
þ
, 
lim™
 - 
£nd
);

103 
£nd
 +ð
fže_size
;

107 
þ
 = 
	`ngx_ouut_chaš_to_iovec
(&
Œaž”
, cl, 
lim™
 - 
£nd
, 
c
->
log
);

109 ià(
þ
 =ð
NGX_CHAIN_ERROR
) {

110  
NGX_CHAIN_ERROR
;

113 
£nd
 +ð
Œaž”
.
size
;

115 ià(
ngx_ä“bsd_u£_tý_nÝush


116 && 
c
->
tý_nÝush
 =ð
NGX_TCP_NOPUSH_UNSET
)

118 ià(
	`ngx_tý_nÝush
(
c
->
fd
è=ð
NGX_ERROR
) {

119 
”r
 = 
ngx_sock‘_”ºo
;

126 ià(
”r
 !ð
NGX_EINTR
) {

127 
wev
->
”rÜ
 = 1;

128 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
,

129 
ngx_tý_nÝush_n
 " failed");

130  
NGX_CHAIN_ERROR
;

134 
c
->
tý_nÝush
 = 
NGX_TCP_NOPUSH_SET
;

136 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

146 
hdŒ
.
h—d”s
 = 
h—d”
.
couÁ
 ? h—d”.
iovs
 : 
NULL
;

147 
hdŒ
.
hdr_út
 = 
h—d”
.
couÁ
;

148 
hdŒ
.
Œaž”s
 = 
Œaž”
.
couÁ
 ?¿ž”.
iovs
 : 
NULL
;

149 
hdŒ
.
Œl_út
 = 
Œaž”
.
couÁ
;

156 ià(!
ngx_ä“bsd_£ndfže_nby‹s_bug
) {

157 
h—d”
.
size
 = 0;

160 
£Á
 = 0;

162 #ià(
NGX_HAVE_AIO_SENDFILE
)

163 
æags
 = 
c
->
aio_£ndfže
 ? 
SF_NODISKIO
 : 0;

166 
rc
 = 
	`£ndfže
(
fže
->fže->
fd
, 
c
->fd, fže->
fže_pos
,

167 
fže_size
 + 
h—d”
.
size
, &
hdŒ
, &
£Á
, 
æags
);

169 ià(
rc
 == -1) {

170 
”r
 = 
ngx_”ºo
;

172 
”r
) {

173 
NGX_EAGAIN
:

174 
—gaš
 = 1;

177 
NGX_EINTR
:

178 
ešŒ
 = 1;

181 #ià(
NGX_HAVE_AIO_SENDFILE
)

182 
NGX_EBUSY
:

183 
c
->
busy_£ndfže
 = 
fže
;

188 
wev
->
”rÜ
 = 1;

189 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "sendfile() failed");

190  
NGX_CHAIN_ERROR
;

193 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

194 "£ndfže(è£Á oÆy %O by‹s", 
£Á
);

201 } ià(
rc
 >ð0 && 
£Á
 == 0) {

209 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

211 
fže
->fže->
Çme
.
d©a
, fže->
fže_pos
);

213  
NGX_CHAIN_ERROR
;

216 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

218 
rc
, 
fže
->
fže_pos
, 
£Á
, 
fže_size
 + 
h—d”
.
size
);

221 
n
 = 
	`ngx_wr™ev
(
c
, &
h—d”
);

223 ià(
n
 =ð
NGX_ERROR
) {

224  
NGX_CHAIN_ERROR
;

227 
£Á
 = (
n
 =ð
NGX_AGAIN
) ? 0 :‚;

230 
c
->
£Á
 += sent;

232 
š
 = 
	`ngx_chaš_upd©e_£Á
(š, 
£Á
);

234 #ià(
NGX_HAVE_AIO_SENDFILE
)

235 ià(
c
->
busy_£ndfže
) {

236  
š
;

240 ià(
—gaš
) {

249 
wev
->
»ady
 = 0;

250  
š
;

253 ià(
ešŒ
) {

254 
£nd
 = 
´ev_£nd
 + 
£Á
;

258 ià(
£nd
 - 
´ev_£nd
 !ð
£Á
) {

259 
wev
->
»ady
 = 0;

260  
š
;

263 ià(
£nd
 >ð
lim™
 || 
š
 =ð
NULL
) {

264  
š
;

267 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_linux_aio_read.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_ev’tfd
;

14 
aio_cÚ‹xt_t
 
ngx_aio_ùx
;

17 
ngx_fže_aio_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
);

21 
	$io_subm™
(
aio_cÚ‹xt_t
 
ùx
, 
n
, 
iocb
 **
·iocb
)

23  
	`sysÿÎ
(
SYS_io_subm™
, 
ùx
, 
n
, 
·iocb
);

24 
	}
}

27 
ssize_t


28 
	$ngx_fže_aio_»ad
(
ngx_fže_t
 *
fže
, 
u_ch¬
 *
buf
, 
size_t
 
size
, 
off_t
 
off£t
,

29 
ngx_poÞ_t
 *
poÞ
)

31 
ngx_”r_t
 
”r
;

32 
iocb
 *
piocb
[1];

33 
ngx_ev’t_t
 *
ev
;

34 
ngx_ev’t_aio_t
 *
aio
;

36 ià(!
ngx_fže_aio
) {

37  
	`ngx_»ad_fže
(
fže
, 
buf
, 
size
, 
off£t
);

40 
aio
 = 
fže
->aio;

42 ià(
aio
 =ð
NULL
) {

43 
aio
 = 
	`ngx_pÿÎoc
(
poÞ
, (
ngx_ev’t_aio_t
));

44 ià(
aio
 =ð
NULL
) {

45  
NGX_ERROR
;

48 
aio
->
fže
 = file;

49 
aio
->
fd
 = 
fže
->fd;

50 
aio
->
ev’t
.
d©a
 =‡io;

51 
aio
->
ev’t
.
»ady
 = 1;

52 
aio
->
ev’t
.
log
 = 
fže
->log;

53 
fže
->
aio
 =‡io;

56 
ev
 = &
aio
->
ev’t
;

58 ià(!
ev
->
»ady
) {

59 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
fže
->
log
, 0,

60 "£cÚd‡iØpo¡ fÜ \"%V\"", &
fže
->
Çme
);

61  
NGX_AGAIN
;

64 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_CORE
, 
fže
->
log
, 0,

66 
ev
->
com¶‘e
, 
off£t
, 
size
, &
fže
->
Çme
);

68 ià(
ev
->
com¶‘e
) {

69 
ev
->
aùive
 = 0;

70 
ev
->
com¶‘e
 = 0;

72 ià(
aio
->
»s
 >= 0) {

73 
	`ngx_£t_”ºo
(0);

74  
aio
->
»s
;

77 
	`ngx_£t_”ºo
(-
aio
->
»s
);

79 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
ngx_”ºo
,

80 "aiØ»ad \"%s\" fažed", 
fže
->
Çme
.
d©a
);

82  
NGX_ERROR
;

85 
	`ngx_memz”o
(&
aio
->
aiocb
, (
iocb
));

87 
aio
->
aiocb
.
aio_d©a
 = (
ušt64_t
è(
ušŒ_t
è
ev
;

88 
aio
->
aiocb
.
aio_lio_Ýcode
 = 
IOCB_CMD_PREAD
;

89 
aio
->
aiocb
.
aio_fždes
 = 
fže
->
fd
;

90 
aio
->
aiocb
.
aio_buf
 = (
ušt64_t
è(
ušŒ_t
è
buf
;

91 
aio
->
aiocb
.
aio_nby‹s
 = 
size
;

92 
aio
->
aiocb
.
aio_off£t
 = 
off£t
;

93 
aio
->
aiocb
.
aio_æags
 = 
IOCB_FLAG_RESFD
;

94 
aio
->
aiocb
.
aio_»sfd
 = 
ngx_ev’tfd
;

96 
ev
->
hªdËr
 = 
ngx_fže_aio_ev’t_hªdËr
;

98 
piocb
[0] = &
aio
->
aiocb
;

100 ià(
	`io_subm™
(
ngx_aio_ùx
, 1, 
piocb
) == 1) {

101 
ev
->
aùive
 = 1;

102 
ev
->
»ady
 = 0;

103 
ev
->
com¶‘e
 = 0;

105  
NGX_AGAIN
;

108 
”r
 = 
ngx_”ºo
;

110 ià(
”r
 =ð
NGX_EAGAIN
) {

111  
	`ngx_»ad_fže
(
fže
, 
buf
, 
size
, 
off£t
);

114 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
fže
->
log
, 
”r
,

115 "io_subm™(\"%V\"èçžed", &
fže
->
Çme
);

117 ià(
”r
 =ð
NGX_ENOSYS
) {

118 
ngx_fže_aio
 = 0;

119  
	`ngx_»ad_fže
(
fže
, 
buf
, 
size
, 
off£t
);

122  
NGX_ERROR
;

123 
	}
}

127 
	$ngx_fže_aio_ev’t_hªdËr
(
ngx_ev’t_t
 *
ev
)

129 
ngx_ev’t_aio_t
 *
aio
;

131 
aio
 = 
ev
->
d©a
;

133 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
ev
->
log
, 0,

134 "aiØev’ˆhªdË¸fd:%d %V", 
aio
->
fd
, &aio->
fže
->
Çme
);

136 
aio
->
	`hªdËr
(
ev
);

137 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_linux_init.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
u_ch¬
 
	gngx_lšux_k”n_o¡y³
[50];

13 
u_ch¬
 
	gngx_lšux_k”n_o¤–—£
[50];

15 
	gngx_lšux_¹sig_max
;

18 
ngx_os_io_t
 
	gngx_lšux_io
 = {

19 
ngx_unix_»cv
,

20 
ngx_»adv_chaš
,

21 
ngx_udp_unix_»cv
,

22 
ngx_unix_£nd
,

23 #ià(
NGX_HAVE_SENDFILE
)

24 
ngx_lšux_£ndfže_chaš
,

25 
NGX_IO_SENDFILE


27 
ngx_wr™ev_chaš
,

33 
ngx_št_t


34 
	$ngx_os_¥ecific_š™
(
ngx_log_t
 *
log
)

36 
ut¢ame
 
u
;

38 ià(
	`uÇme
(&
u
) == -1) {

39 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
, "uname() failed");

40  
NGX_ERROR
;

43 (è
	`ngx_ýy¡º
(
ngx_lšux_k”n_o¡y³
, (
u_ch¬
 *è
u
.
sy¢ame
,

44 (
ngx_lšux_k”n_o¡y³
));

46 (è
	`ngx_ýy¡º
(
ngx_lšux_k”n_o¤–—£
, (
u_ch¬
 *è
u
.
»Ëa£
,

47 (
ngx_lšux_k”n_o¤–—£
));

49 #ià(
NGX_HAVE_RTSIG
)

51 
Çme
[2];

52 
size_t
 
Ën
;

53 
ngx_”r_t
 
”r
;

55 
Çme
[0] = 
CTL_KERN
;

56 
Çme
[1] = 
KERN_RTSIGMAX
;

57 
Ën
 = (
ngx_lšux_¹sig_max
);

59 ià(
	`sysùl
(
Çme
, 2, &
ngx_lšux_¹sig_max
, &
Ën
, 
NULL
, 0) == -1) {

60 
”r
 = 
ngx_”ºo
;

62 ià(
”r
 !ð
NGX_ENOTDIR
 &&ƒ¼ !ð
NGX_ENOSYS
) {

63 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
,

66  
NGX_ERROR
;

69 
ngx_lšux_¹sig_max
 = 0;

75 
ngx_os_io
 = 
ngx_lšux_io
;

77  
NGX_OK
;

78 
	}
}

82 
	$ngx_os_¥ecific_¡©us
(
ngx_log_t
 *
log
)

84 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "OS: %s %s",

85 
ngx_lšux_k”n_o¡y³
, 
ngx_lšux_k”n_o¤–—£
);

87 #ià(
NGX_HAVE_RTSIG
)

88 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "sysctl(KERN_RTSIGMAX): %d",

89 
ngx_lšux_¹sig_max
);

91 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_linux_sendfile_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

27 
	#NGX_SENDFILE_MAXSIZE
 2147483647L

	)

30 
ngx_chaš_t
 *

31 
	$ngx_lšux_£ndfže_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
)

33 
tý_nod–ay
;

34 
off_t
 
£nd
, 
´ev_£nd
, 
£Á
;

35 
size_t
 
fže_size
;

36 
ssize_t
 
n
;

37 
ngx_”r_t
 
”r
;

38 
ngx_buf_t
 *
fže
;

39 
ngx_ušt_t
 
ešŒ
;

40 
ngx_ev’t_t
 *
wev
;

41 
ngx_chaš_t
 *
þ
;

42 
ngx_iovec_t
 
h—d”
;

43 
iovec
 
h—d”s
[
NGX_IOVS_PREALLOCATE
];

44 #ià(
NGX_HAVE_SENDFILE64
)

45 
off_t
 
off£t
;

47 
št32_t
 
off£t
;

50 
wev
 = 
c
->
wr™e
;

52 ià(!
wev
->
»ady
) {

53  
š
;

59 ià(
lim™
 =ð0 ||†im™ > (
off_t
è(
NGX_SENDFILE_MAXSIZE
 - 
ngx_·gesize
)) {

60 
lim™
 = 
NGX_SENDFILE_MAXSIZE
 - 
ngx_·gesize
;

64 
£nd
 = 0;

66 
h—d”
.
iovs
 = 
h—d”s
;

67 
h—d”
.
ÇÎoc
 = 
NGX_IOVS_PREALLOCATE
;

70 
ešŒ
 = 0;

71 
´ev_£nd
 = 
£nd
;

75 
þ
 = 
	`ngx_ouut_chaš_to_iovec
(&
h—d”
, 
š
, 
lim™
 - 
£nd
, 
c
->
log
);

77 ià(
þ
 =ð
NGX_CHAIN_ERROR
) {

78  
NGX_CHAIN_ERROR
;

81 
£nd
 +ð
h—d”
.
size
;

85 ià(
c
->
tý_nÝush
 =ð
NGX_TCP_NOPUSH_UNSET


86 && 
h—d”
.
couÁ
 != 0

87 && 
þ


88 && 
þ
->
buf
->
š_fže
)

92 ià(
c
->
tý_nod–ay
 =ð
NGX_TCP_NODELAY_SET
) {

94 
tý_nod–ay
 = 0;

96 ià(
	`£tsockÝt
(
c
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

97 (cÚ¡ *è&
tý_nod–ay
, ()) == -1)

99 
”r
 = 
ngx_sock‘_”ºo
;

107 ià(
”r
 !ð
NGX_EINTR
) {

108 
wev
->
”rÜ
 = 1;

109 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
,

111  
NGX_CHAIN_ERROR
;

115 
c
->
tý_nod–ay
 = 
NGX_TCP_NODELAY_UNSET
;

117 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

122 ià(
c
->
tý_nod–ay
 =ð
NGX_TCP_NODELAY_UNSET
) {

124 ià(
	`ngx_tý_nÝush
(
c
->
fd
è=ð
NGX_ERROR
) {

125 
”r
 = 
ngx_sock‘_”ºo
;

132 ià(
”r
 !ð
NGX_EINTR
) {

133 
wev
->
”rÜ
 = 1;

134 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
,

135 
ngx_tý_nÝush_n
 " failed");

136  
NGX_CHAIN_ERROR
;

140 
c
->
tý_nÝush
 = 
NGX_TCP_NOPUSH_SET
;

142 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

150 ià(
h—d”
.
couÁ
 =ð0 && 
þ
 && cl->
buf
->
š_fže
 && 
£nd
 < 
lim™
) {

151 
fže
 = 
þ
->
buf
;

155 
fže_size
 = (
size_t
è
	`ngx_chaš_cßËsû_fže
(&
þ
, 
lim™
 - 
£nd
);

157 
£nd
 +ð
fže_size
;

159 ià(
fže_size
 == 0) {

160 
	`ngx_debug_pošt
();

161  
NGX_CHAIN_ERROR
;

164 #ià(
NGX_HAVE_SENDFILE64
)

165 
off£t
 = 
fže
->
fže_pos
;

167 
off£t
 = (
št32_t
è
fže
->
fže_pos
;

170 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

171 "£ndfže: @%O %uz", 
fže
->
fže_pos
, 
fže_size
);

173 
n
 = 
	`£ndfže
(
c
->
fd
, 
fže
->fže->fd, &
off£t
, 
fže_size
);

175 ià(
n
 == -1) {

176 
”r
 = 
ngx_”ºo
;

178 
”r
) {

179 
NGX_EAGAIN
:

182 
NGX_EINTR
:

183 
ešŒ
 = 1;

187 
wev
->
”rÜ
 = 1;

188 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "sendfile() failed");

189  
NGX_CHAIN_ERROR
;

192 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

196 
£Á
 = 
n
 > 0 ?‚ : 0;

198 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

200 
n
, 
fže
->
fže_pos
, 
£Á
, 
fže_size
);

203 
n
 = 
	`ngx_wr™ev
(
c
, &
h—d”
);

205 ià(
n
 =ð
NGX_ERROR
) {

206  
NGX_CHAIN_ERROR
;

209 
£Á
 = (
n
 =ð
NGX_AGAIN
) ? 0 :‚;

212 
c
->
£Á
 += sent;

214 
š
 = 
	`ngx_chaš_upd©e_£Á
(š, 
£Á
);

216 ià(
ešŒ
) {

217 
£nd
 = 
´ev_£nd
;

221 ià(
£nd
 - 
´ev_£nd
 !ð
£Á
) {

222 
wev
->
»ady
 = 0;

223  
š
;

226 ià(
£nd
 >ð
lim™
 || 
š
 =ð
NULL
) {

227  
š
;

230 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_posix_init.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngšx.h
>

13 
ngx_št_t
 
	gngx_nýu
;

14 
ngx_št_t
 
	gngx_max_sock‘s
;

15 
ngx_ušt_t
 
	gngx_šh”™ed_nÚblockšg
;

16 
ngx_ušt_t
 
	gngx_tý_nod–ay_ªd_tý_nÝush
;

19 
¾im™
 
	g¾mt
;

22 
ngx_os_io_t
 
	gngx_os_io
 = {

23 
ngx_unix_»cv
,

24 
ngx_»adv_chaš
,

25 
ngx_udp_unix_»cv
,

26 
ngx_unix_£nd
,

27 
ngx_wr™ev_chaš
,

32 
ngx_št_t


33 
	$ngx_os_š™
(
ngx_log_t
 *
log
)

35 
ngx_ušt_t
 
n
;

37 #ià(
NGX_HAVE_OS_SPECIFIC_INIT
)

38 ià(
	`ngx_os_¥ecific_š™
(
log
è!ð
NGX_OK
) {

39  
NGX_ERROR
;

43 ià(
	`ngx_š™_£roù™Ë
(
log
è!ð
NGX_OK
) {

44  
NGX_ERROR
;

47 
ngx_·gesize
 = 
	`g‘·gesize
();

48 
ngx_ÿch–še_size
 = 
NGX_CPU_CACHE_LINE
;

50 
n
 = 
ngx_·gesize
;‚ >>ð1; 
ngx_·gesize_shiá
++) { }

52 #ià(
NGX_HAVE_SC_NPROCESSORS_ONLN
)

53 ià(
ngx_nýu
 == 0) {

54 
ngx_nýu
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

58 ià(
ngx_nýu
 < 1) {

59 
ngx_nýu
 = 1;

62 
	`ngx_ýušfo
();

64 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾mt
) == -1) {

65 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”ºo
,

67  
NGX_ERROR
;

70 
ngx_max_sock‘s
 = (
ngx_št_t
è
¾mt
.
¾im_cur
;

72 #ià(
NGX_HAVE_INHERITED_NONBLOCK
 || 
NGX_HAVE_ACCEPT4
)

73 
ngx_šh”™ed_nÚblockšg
 = 1;

75 
ngx_šh”™ed_nÚblockšg
 = 0;

78 
	`¤ªdom
(
	`ngx_time
());

80  
NGX_OK
;

81 
	}
}

85 
	$ngx_os_¡©us
(
ngx_log_t
 *
log
)

87 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, 
NGINX_VER_BUILD
);

89 #ifdeà
NGX_COMPILER


90 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "bužˆby " 
NGX_COMPILER
);

93 #ià(
NGX_HAVE_OS_SPECIFIC_INIT
)

94 
	`ngx_os_¥ecific_¡©us
(
log
);

97 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0,

99 
¾mt
.
¾im_cur
,„lmt.
¾im_max
);

100 
	}
}

105 
ngx_št_t


106 
	$ngx_posix_po¡_cÚf_š™
(
ngx_log_t
 *
log
)

108 
ngx_fd_t
 
µ
[2];

110 ià(
	`pe
(
µ
) == -1) {

111 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
, "pipe() failed");

112  
NGX_ERROR
;

115 ià(
	`dup2
(
µ
[1], 
STDERR_FILENO
) == -1) {

116 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
”ºo
, "dup2(STDERR) failed");

117  
NGX_ERROR
;

120 ià(
µ
[1] > 
STDERR_FILENO
) {

121 ià(
	`þo£
(
µ
[1]) == -1) {

122 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
”ºo
, "close() failed");

123  
NGX_ERROR
;

127  
NGX_OK
;

128 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_process.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_chªÃl.h
>

15 
	msigno
;

16 *
	msigÇme
;

17 *
	mÇme
;

18 (*
	mhªdËr
)(
	msigno
);

19 } 
	tngx_sigÇl_t
;

23 
ngx_execu‹_´oc
(
ngx_cyþe_t
 *
cyþe
, *
d©a
);

24 
ngx_sigÇl_hªdËr
(
signo
);

25 
ngx_´oûss_g‘_¡©us
();

26 
ngx_uÆock_mu‹xes
(
ngx_pid_t
 
pid
);

29 
	gngx_¬gc
;

30 **
	gngx_¬gv
;

31 **
	gngx_os_¬gv
;

33 
ngx_št_t
 
	gngx_´oûss_¦Ù
;

34 
ngx_sock‘_t
 
	gngx_chªÃl
;

35 
ngx_št_t
 
	gngx_Ï¡_´oûss
;

36 
ngx_´oûss_t
 
	gngx_´oûs£s
[
NGX_MAX_PROCESSES
];

39 
ngx_sigÇl_t
 
	gsigÇls
[] = {

40 { 
ngx_sigÇl_v®ue
(
NGX_RECONFIGURE_SIGNAL
),

41 "SIG" 
ngx_v®ue
(
NGX_RECONFIGURE_SIGNAL
),

43 
ngx_sigÇl_hªdËr
 },

45 { 
ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
),

46 "SIG" 
ngx_v®ue
(
NGX_REOPEN_SIGNAL
),

48 
ngx_sigÇl_hªdËr
 },

50 { 
ngx_sigÇl_v®ue
(
NGX_NOACCEPT_SIGNAL
),

51 "SIG" 
ngx_v®ue
(
NGX_NOACCEPT_SIGNAL
),

53 
ngx_sigÇl_hªdËr
 },

55 { 
ngx_sigÇl_v®ue
(
NGX_TERMINATE_SIGNAL
),

56 "SIG" 
ngx_v®ue
(
NGX_TERMINATE_SIGNAL
),

58 
ngx_sigÇl_hªdËr
 },

60 { 
ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
),

61 "SIG" 
ngx_v®ue
(
NGX_SHUTDOWN_SIGNAL
),

63 
ngx_sigÇl_hªdËr
 },

65 { 
ngx_sigÇl_v®ue
(
NGX_CHANGEBIN_SIGNAL
),

66 "SIG" 
ngx_v®ue
(
NGX_CHANGEBIN_SIGNAL
),

68 
ngx_sigÇl_hªdËr
 },

70 { 
SIGALRM
, "SIGALRM", "", 
ngx_sigÇl_hªdËr
 },

72 { 
SIGINT
, "SIGINT", "", 
ngx_sigÇl_hªdËr
 },

74 { 
SIGIO
, "SIGIO", "", 
ngx_sigÇl_hªdËr
 },

76 { 
SIGCHLD
, "SIGCHLD", "", 
ngx_sigÇl_hªdËr
 },

78 { 
SIGSYS
, "SIGSYS, SIG_IGN", "", 
SIG_IGN
 },

80 { 
SIGPIPE
, "SIGPIPE, SIG_IGN", "", 
SIG_IGN
 },

82 { 0, 
NULL
, "", NULL }

86 
ngx_pid_t


87 
	$ngx_¥awn_´oûss
(
ngx_cyþe_t
 *
cyþe
, 
ngx_¥awn_´oc_±
 
´oc
, *
d©a
,

88 *
Çme
, 
ngx_št_t
 
»¥awn
)

90 
u_lÚg
 
Ú
;

91 
ngx_pid_t
 
pid
;

92 
ngx_št_t
 
s
;

94 ià(
»¥awn
 >= 0) {

95 
s
 = 
»¥awn
;

98 
s
 = 0; s < 
ngx_Ï¡_´oûss
; s++) {

99 ià(
ngx_´oûs£s
[
s
].
pid
 == -1) {

104 ià(
s
 =ð
NGX_MAX_PROCESSES
) {

105 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

107 
NGX_MAX_PROCESSES
);

108  
NGX_INVALID_PID
;

113 ià(
»¥awn
 !ð
NGX_PROCESS_DETACHED
) {

117 ià(
	`sock‘·œ
(
AF_UNIX
, 
SOCK_STREAM
, 0, 
ngx_´oûs£s
[
s
].
chªÃl
) == -1)

119 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

120 "sock‘·œ(èçžed whž¥awnšg \"%s\"", 
Çme
);

121  
NGX_INVALID_PID
;

124 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

126 
ngx_´oûs£s
[
s
].
chªÃl
[0],

127 
ngx_´oûs£s
[
s
].
chªÃl
[1]);

129 ià(
	`ngx_nÚblockšg
(
ngx_´oûs£s
[
s
].
chªÃl
[0]) == -1) {

130 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

131 
ngx_nÚblockšg_n
 " failed while spawning \"%s\"",

132 
Çme
);

133 
	`ngx_þo£_chªÃl
(
ngx_´oûs£s
[
s
].
chªÃl
, 
cyþe
->
log
);

134  
NGX_INVALID_PID
;

137 ià(
	`ngx_nÚblockšg
(
ngx_´oûs£s
[
s
].
chªÃl
[1]) == -1) {

138 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

139 
ngx_nÚblockšg_n
 " failed while spawning \"%s\"",

140 
Çme
);

141 
	`ngx_þo£_chªÃl
(
ngx_´oûs£s
[
s
].
chªÃl
, 
cyþe
->
log
);

142  
NGX_INVALID_PID
;

145 
Ú
 = 1;

146 ià(
	`ioùl
(
ngx_´oûs£s
[
s
].
chªÃl
[0], 
FIOASYNC
, &
Ú
) == -1) {

147 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

148 "ioùl(FIOASYNCèçžed whž¥awnšg \"%s\"", 
Çme
);

149 
	`ngx_þo£_chªÃl
(
ngx_´oûs£s
[
s
].
chªÃl
, 
cyþe
->
log
);

150  
NGX_INVALID_PID
;

153 ià(
	`fúŽ
(
ngx_´oûs£s
[
s
].
chªÃl
[0], 
F_SETOWN
, 
ngx_pid
) == -1) {

154 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

155 "fúŽ(F_SETOWNèçžed whž¥awnšg \"%s\"", 
Çme
);

156 
	`ngx_þo£_chªÃl
(
ngx_´oûs£s
[
s
].
chªÃl
, 
cyþe
->
log
);

157  
NGX_INVALID_PID
;

160 ià(
	`fúŽ
(
ngx_´oûs£s
[
s
].
chªÃl
[0], 
F_SETFD
, 
FD_CLOEXEC
) == -1) {

161 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

163 
Çme
);

164 
	`ngx_þo£_chªÃl
(
ngx_´oûs£s
[
s
].
chªÃl
, 
cyþe
->
log
);

165  
NGX_INVALID_PID
;

168 ià(
	`fúŽ
(
ngx_´oûs£s
[
s
].
chªÃl
[1], 
F_SETFD
, 
FD_CLOEXEC
) == -1) {

169 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

171 
Çme
);

172 
	`ngx_þo£_chªÃl
(
ngx_´oûs£s
[
s
].
chªÃl
, 
cyþe
->
log
);

173  
NGX_INVALID_PID
;

176 
ngx_chªÃl
 = 
ngx_´oûs£s
[
s
].
chªÃl
[1];

179 
ngx_´oûs£s
[
s
].
chªÃl
[0] = -1;

180 
ngx_´oûs£s
[
s
].
chªÃl
[1] = -1;

183 
ngx_´oûss_¦Ù
 = 
s
;

186 
pid
 = 
	`fÜk
();

188 
pid
) {

191 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

192 "fÜk(èçžed whž¥awnšg \"%s\"", 
Çme
);

193 
	`ngx_þo£_chªÃl
(
ngx_´oûs£s
[
s
].
chªÃl
, 
cyþe
->
log
);

194  
NGX_INVALID_PID
;

197 
ngx_pid
 = 
	`ngx_g‘pid
();

198 
	`´oc
(
cyþe
, 
d©a
);

205 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "¡¬ˆ% %P", 
Çme
, 
pid
);

207 
ngx_´oûs£s
[
s
].
pid
 =…id;

208 
ngx_´oûs£s
[
s
].
ex™ed
 = 0;

210 ià(
»¥awn
 >= 0) {

211  
pid
;

214 
ngx_´oûs£s
[
s
].
´oc
 =…roc;

215 
ngx_´oûs£s
[
s
].
d©a
 = data;

216 
ngx_´oûs£s
[
s
].
Çme
 =‚ame;

217 
ngx_´oûs£s
[
s
].
ex™šg
 = 0;

219 
»¥awn
) {

221 
NGX_PROCESS_NORESPAWN
:

222 
ngx_´oûs£s
[
s
].
»¥awn
 = 0;

223 
ngx_´oûs£s
[
s
].
ju¡_¥awn
 = 0;

224 
ngx_´oûs£s
[
s
].
d‘ached
 = 0;

227 
NGX_PROCESS_JUST_SPAWN
:

228 
ngx_´oûs£s
[
s
].
»¥awn
 = 0;

229 
ngx_´oûs£s
[
s
].
ju¡_¥awn
 = 1;

230 
ngx_´oûs£s
[
s
].
d‘ached
 = 0;

233 
NGX_PROCESS_RESPAWN
:

234 
ngx_´oûs£s
[
s
].
»¥awn
 = 1;

235 
ngx_´oûs£s
[
s
].
ju¡_¥awn
 = 0;

236 
ngx_´oûs£s
[
s
].
d‘ached
 = 0;

239 
NGX_PROCESS_JUST_RESPAWN
:

240 
ngx_´oûs£s
[
s
].
»¥awn
 = 1;

241 
ngx_´oûs£s
[
s
].
ju¡_¥awn
 = 1;

242 
ngx_´oûs£s
[
s
].
d‘ached
 = 0;

245 
NGX_PROCESS_DETACHED
:

246 
ngx_´oûs£s
[
s
].
»¥awn
 = 0;

247 
ngx_´oûs£s
[
s
].
ju¡_¥awn
 = 0;

248 
ngx_´oûs£s
[
s
].
d‘ached
 = 1;

252 ià(
s
 =ð
ngx_Ï¡_´oûss
) {

253 
ngx_Ï¡_´oûss
++;

256  
pid
;

257 
	}
}

260 
ngx_pid_t


261 
	$ngx_execu‹
(
ngx_cyþe_t
 *
cyþe
, 
ngx_exec_ùx_t
 *
ùx
)

263  
	`ngx_¥awn_´oûss
(
cyþe
, 
ngx_execu‹_´oc
, 
ùx
, ctx->
Çme
,

264 
NGX_PROCESS_DETACHED
);

265 
	}
}

269 
	$ngx_execu‹_´oc
(
ngx_cyþe_t
 *
cyþe
, *
d©a
)

271 
ngx_exec_ùx_t
 *
ùx
 = 
d©a
;

273 ià(
	`execve
(
ùx
->
·th
, ctx->
¬gv
, ctx->
’vp
) == -1) {

274 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

276 
ùx
->
Çme
, ctx->
·th
);

279 
	`ex™
(1);

280 
	}
}

283 
ngx_št_t


284 
	$ngx_š™_sigÇls
(
ngx_log_t
 *
log
)

286 
ngx_sigÇl_t
 *
sig
;

287 
sigaùiÚ
 
§
;

289 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

290 
	`ngx_memz”o
(&
§
, (
sigaùiÚ
));

291 
§
.
§_hªdËr
 = 
sig
->
hªdËr
;

292 
	`sigem±y£t
(&
§
.
§_mask
);

293 ià(
	`sigaùiÚ
(
sig
->
signo
, &
§
, 
NULL
) == -1) {

294 #ià(
NGX_VALGRIND
)

295 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

296 "sigaùiÚ(%sèçžed, ignÜed", 
sig
->
sigÇme
);

298 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
log
, 
ngx_”ºo
,

299 "sigaùiÚ(%sèçžed", 
sig
->
sigÇme
);

300  
NGX_ERROR
;

305  
NGX_OK
;

306 
	}
}

310 
	$ngx_sigÇl_hªdËr
(
signo
)

312 *
aùiÚ
;

313 
ngx_št_t
 
ignÜe
;

314 
ngx_”r_t
 
”r
;

315 
ngx_sigÇl_t
 *
sig
;

317 
ignÜe
 = 0;

319 
”r
 = 
ngx_”ºo
;

321 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

322 ià(
sig
->
signo
 == signo) {

327 
	`ngx_time_sig§ã_upd©e
();

329 
aùiÚ
 = "";

331 
ngx_´oûss
) {

333 
NGX_PROCESS_MASTER
:

334 
NGX_PROCESS_SINGLE
:

335 
signo
) {

337 
	`ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
):

338 
ngx_qu™
 = 1;

339 
aùiÚ
 = ", shutting down";

342 
	`ngx_sigÇl_v®ue
(
NGX_TERMINATE_SIGNAL
):

343 
SIGINT
:

344 
ngx_‹rmš©e
 = 1;

345 
aùiÚ
 = ",ƒxiting";

348 
	`ngx_sigÇl_v®ue
(
NGX_NOACCEPT_SIGNAL
):

349 ià(
ngx_d«mÚized
) {

350 
ngx_nßcû±
 = 1;

351 
aùiÚ
 = ", stop‡ccepting connections";

355 
	`ngx_sigÇl_v®ue
(
NGX_RECONFIGURE_SIGNAL
):

356 
ngx_»cÚfigu»
 = 1;

357 
aùiÚ
 = ",„econfiguring";

360 
	`ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
):

361 
ngx_»Ý’
 = 1;

362 
aùiÚ
 = ",„eopening†ogs";

365 
	`ngx_sigÇl_v®ue
(
NGX_CHANGEBIN_SIGNAL
):

366 ià(
	`g‘µid
(è> 1 || 
ngx_Ãw_bš¬y
 > 0) {

375 
aùiÚ
 = ", ignoring";

376 
ignÜe
 = 1;

380 
ngx_chªge_bš¬y
 = 1;

381 
aùiÚ
 = ", changing binary";

384 
SIGALRM
:

385 
ngx_sig®rm
 = 1;

388 
SIGIO
:

389 
ngx_sigio
 = 1;

392 
SIGCHLD
:

393 
ngx_»­
 = 1;

399 
NGX_PROCESS_WORKER
:

400 
NGX_PROCESS_HELPER
:

401 
signo
) {

403 
	`ngx_sigÇl_v®ue
(
NGX_NOACCEPT_SIGNAL
):

404 ià(!
ngx_d«mÚized
) {

407 
ngx_debug_qu™
 = 1;

408 
	`ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
):

409 
ngx_qu™
 = 1;

410 
aùiÚ
 = ", shutting down";

413 
	`ngx_sigÇl_v®ue
(
NGX_TERMINATE_SIGNAL
):

414 
SIGINT
:

415 
ngx_‹rmš©e
 = 1;

416 
aùiÚ
 = ",ƒxiting";

419 
	`ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
):

420 
ngx_»Ý’
 = 1;

421 
aùiÚ
 = ",„eopening†ogs";

424 
	`ngx_sigÇl_v®ue
(
NGX_RECONFIGURE_SIGNAL
):

425 
	`ngx_sigÇl_v®ue
(
NGX_CHANGEBIN_SIGNAL
):

426 
SIGIO
:

427 
aùiÚ
 = ", ignoring";

434 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
ngx_cyþe
->
log
, 0,

435 "sigÇÈ%d (%sè»ûived%s", 
signo
, 
sig
->
sigÇme
, 
aùiÚ
);

437 ià(
ignÜe
) {

438 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
ngx_cyþe
->
log
, 0,

444 ià(
signo
 =ð
SIGCHLD
) {

445 
	`ngx_´oûss_g‘_¡©us
();

448 
	`ngx_£t_”ºo
(
”r
);

449 
	}
}

453 
	$ngx_´oûss_g‘_¡©us
()

455 
¡©us
;

456 *
´oûss
;

457 
ngx_pid_t
 
pid
;

458 
ngx_”r_t
 
”r
;

459 
ngx_št_t
 
i
;

460 
ngx_ušt_t
 
Úe
;

462 
Úe
 = 0;

465 
pid
 = 
	`wa™pid
(-1, &
¡©us
, 
WNOHANG
);

467 ià(
pid
 == 0) {

471 ià(
pid
 == -1) {

472 
”r
 = 
ngx_”ºo
;

474 ià(
”r
 =ð
NGX_EINTR
) {

478 ià(
”r
 =ð
NGX_ECHILD
 && 
Úe
) {

491 ià(
”r
 =ð
NGX_ECHILD
) {

492 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
ngx_cyþe
->
log
, 
”r
,

497 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 
”r
,

503 
Úe
 = 1;

504 
´oûss
 = "unknown…rocess";

506 
i
 = 0; i < 
ngx_Ï¡_´oûss
; i++) {

507 ià(
ngx_´oûs£s
[
i
].
pid
 ==…id) {

508 
ngx_´oûs£s
[
i
].
¡©us
 = status;

509 
ngx_´oûs£s
[
i
].
ex™ed
 = 1;

510 
´oûss
 = 
ngx_´oûs£s
[
i
].
Çme
;

515 ià(
	`WTERMSIG
(
¡©us
)) {

516 #ifdeà
WCOREDUMP


517 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

519 
´oûss
, 
pid
, 
	`WTERMSIG
(
¡©us
),

520 
	`WCOREDUMP
(
¡©us
) ? " (core dumped)" : "");

522 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

524 
´oûss
, 
pid
, 
	`WTERMSIG
(
¡©us
));

528 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
ngx_cyþe
->
log
, 0,

530 
´oûss
, 
pid
, 
	`WEXITSTATUS
(
¡©us
));

533 ià(
	`WEXITSTATUS
(
¡©us
è=ð2 && 
ngx_´oûs£s
[
i
].
»¥awn
) {

534 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

537 
´oûss
, 
pid
, 
	`WEXITSTATUS
(
¡©us
));

538 
ngx_´oûs£s
[
i
].
»¥awn
 = 0;

541 
	`ngx_uÆock_mu‹xes
(
pid
);

543 
	}
}

547 
	$ngx_uÆock_mu‹xes
(
ngx_pid_t
 
pid
)

549 
ngx_ušt_t
 
i
;

550 
ngx_shm_zÚe_t
 *
shm_zÚe
;

551 
ngx_li¡_·¹_t
 *
·¹
;

552 
ngx_¦ab_poÞ_t
 *
¥
;

559 ià(
ngx_acû±_mu‹x_±r
) {

560 (è
	`ngx_shmtx_fÜû_uÆock
(&
ngx_acû±_mu‹x
, 
pid
);

568 
·¹
 = (
ngx_li¡_·¹_t
 *è&
ngx_cyþe
->
sh¬ed_memÜy
.part;

569 
shm_zÚe
 = 
·¹
->
–ts
;

571 
i
 = 0; ; i++) {

573 ià(
i
 >ð
·¹
->
ÃÉs
) {

574 ià(
·¹
->
Ãxt
 =ð
NULL
) {

577 
·¹
 =…¬t->
Ãxt
;

578 
shm_zÚe
 = 
·¹
->
–ts
;

579 
i
 = 0;

582 
¥
 = (
ngx_¦ab_poÞ_t
 *è
shm_zÚe
[
i
].
shm
.
addr
;

584 ià(
	`ngx_shmtx_fÜû_uÆock
(&
¥
->
mu‹x
, 
pid
)) {

585 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ngx_cyþe
->
log
, 0,

587 &
shm_zÚe
[
i
].
shm
.
Çme
, 
pid
);

590 
	}
}

594 
	$ngx_debug_pošt
()

596 
ngx_cÜe_cÚf_t
 *
ccf
;

598 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
ngx_cyþe
->
cÚf_ùx
,

599 
ngx_cÜe_moduË
);

601 
ccf
->
debug_pošts
) {

603 
NGX_DEBUG_POINTS_STOP
:

604 
	`¿i£
(
SIGSTOP
);

607 
NGX_DEBUG_POINTS_ABORT
:

608 
	`ngx_abÜt
();

610 
	}
}

613 
ngx_št_t


614 
	$ngx_os_sigÇl_´oûss
(
ngx_cyþe_t
 *
cyþe
, *
Çme
, 
ngx_št_t
 
pid
)

616 
ngx_sigÇl_t
 *
sig
;

618 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

619 ià(
	`ngx_¡rcmp
(
Çme
, 
sig
->name) == 0) {

620 ià(
	`kžl
(
pid
, 
sig
->
signo
) != -1) {

624 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

625 "kžl(%P, %dèçžed", 
pid
, 
sig
->
signo
);

630 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_process_cycle.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_chªÃl.h
>

14 
ngx_¡¬t_wÜk”_´oûs£s
(
ngx_cyþe_t
 *
cyþe
, 
ngx_št_t
 
n
,

15 
ngx_št_t
 
ty³
);

16 
ngx_¡¬t_ÿche_mªag”_´oûs£s
(
ngx_cyþe_t
 *
cyþe
,

17 
ngx_ušt_t
 
»¥awn
);

18 
ngx_·ss_Ý’_chªÃl
(
ngx_cyþe_t
 *
cyþe
, 
ngx_chªÃl_t
 *
ch
);

19 
ngx_sigÇl_wÜk”_´oûs£s
(
ngx_cyþe_t
 *
cyþe
, 
signo
);

20 
ngx_ušt_t
 
ngx_»­_chžd»n
(
ngx_cyþe_t
 *
cyþe
);

21 
ngx_ma¡”_´oûss_ex™
(
ngx_cyþe_t
 *
cyþe
);

22 
ngx_wÜk”_´oûss_cyþe
(
ngx_cyþe_t
 *
cyþe
, *
d©a
);

23 
ngx_wÜk”_´oûss_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_št_t
 
wÜk”
);

24 
ngx_wÜk”_´oûss_ex™
(
ngx_cyþe_t
 *
cyþe
);

25 
ngx_chªÃl_hªdËr
(
ngx_ev’t_t
 *
ev
);

26 #ià(
NGX_THREADS
)

27 
ngx_wakeup_wÜk”_th»ads
(
ngx_cyþe_t
 *
cyþe
);

28 
ngx_th»ad_v®ue_t
 
ngx_wÜk”_th»ad_cyþe
(*
d©a
);

30 
ngx_ÿche_mªag”_´oûss_cyþe
(
ngx_cyþe_t
 *
cyþe
, *
d©a
);

31 
ngx_ÿche_mªag”_´oûss_hªdËr
(
ngx_ev’t_t
 *
ev
);

32 
ngx_ÿche_lßd”_´oûss_hªdËr
(
ngx_ev’t_t
 *
ev
);

35 
ngx_ušt_t
 
	gngx_´oûss
;

36 
ngx_pid_t
 
	gngx_pid
;

37 
ngx_ušt_t
 
	gngx_th»aded
;

39 
sig_©omic_t
 
	gngx_»­
;

40 
sig_©omic_t
 
	gngx_sigio
;

41 
sig_©omic_t
 
	gngx_sig®rm
;

42 
sig_©omic_t
 
	gngx_‹rmš©e
;

43 
sig_©omic_t
 
	gngx_qu™
;

44 
sig_©omic_t
 
	gngx_debug_qu™
;

45 
ngx_ušt_t
 
	gngx_ex™šg
;

46 
sig_©omic_t
 
	gngx_»cÚfigu»
;

47 
sig_©omic_t
 
	gngx_»Ý’
;

49 
sig_©omic_t
 
	gngx_chªge_bš¬y
;

50 
ngx_pid_t
 
	gngx_Ãw_bš¬y
;

51 
ngx_ušt_t
 
	gngx_šh”™ed
;

52 
ngx_ušt_t
 
	gngx_d«mÚized
;

54 
sig_©omic_t
 
	gngx_nßcû±
;

55 
ngx_ušt_t
 
	gngx_nßcû±šg
;

56 
ngx_ušt_t
 
	gngx_»¡¬t
;

59 #ià(
NGX_THREADS
)

60 vÞ©ž
ngx_th»ad_t
 
	gngx_th»ads
[
NGX_MAX_THREADS
];

61 
ngx_št_t
 
	gngx_th»ads_n
;

65 
u_ch¬
 
	gma¡”_´oûss
[] = "master…rocess";

68 
ngx_ÿche_mªag”_ùx_t
 
	gngx_ÿche_mªag”_ùx
 = {

69 
ngx_ÿche_mªag”_´oûss_hªdËr
, "cache manager…rocess", 0

72 
ngx_ÿche_mªag”_ùx_t
 
	gngx_ÿche_lßd”_ùx
 = {

73 
ngx_ÿche_lßd”_´oûss_hªdËr
, "cache†oader…rocess", 60000

77 
ngx_cyþe_t
 
	gngx_ex™_cyþe
;

78 
ngx_log_t
 
	gngx_ex™_log
;

79 
ngx_Ý’_fže_t
 
	gngx_ex™_log_fže
;

83 
	$ngx_ma¡”_´oûss_cyþe
(
ngx_cyþe_t
 *
cyþe
)

85 *
t™Ë
;

86 
u_ch¬
 *
p
;

87 
size_t
 
size
;

88 
ngx_št_t
 
i
;

89 
ngx_ušt_t
 
n
, 
sigio
;

90 
sig£t_t
 
£t
;

91 
™im”v®
 
™v
;

92 
ngx_ušt_t
 
live
;

93 
ngx_m£c_t
 
d–ay
;

94 
ngx_li¡’šg_t
 *
ls
;

95 
ngx_cÜe_cÚf_t
 *
ccf
;

97 
	`sigem±y£t
(&
£t
);

98 
	`sigadd£t
(&
£t
, 
SIGCHLD
);

99 
	`sigadd£t
(&
£t
, 
SIGALRM
);

100 
	`sigadd£t
(&
£t
, 
SIGIO
);

101 
	`sigadd£t
(&
£t
, 
SIGINT
);

102 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_RECONFIGURE_SIGNAL
));

103 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
));

104 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_NOACCEPT_SIGNAL
));

105 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_TERMINATE_SIGNAL
));

106 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
));

107 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_CHANGEBIN_SIGNAL
));

109 ià(
	`sig´ocmask
(
SIG_BLOCK
, &
£t
, 
NULL
) == -1) {

110 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

114 
	`sigem±y£t
(&
£t
);

117 
size
 = (
ma¡”_´oûss
);

119 
i
 = 0; i < 
ngx_¬gc
; i++) {

120 
size
 +ð
	`ngx_¡¾’
(
ngx_¬gv
[
i
]) + 1;

123 
t™Ë
 = 
	`ngx_²®loc
(
cyþe
->
poÞ
, 
size
);

124 ià(
t™Ë
 =ð
NULL
) {

126 
	`ex™
(2);

129 
p
 = 
	`ngx_ýymem
(
t™Ë
, 
ma¡”_´oûss
, (master_process) - 1);

130 
i
 = 0; i < 
ngx_¬gc
; i++) {

131 *
p
++ = ' ';

132 
p
 = 
	`ngx_ýy¡º
Õ, (
u_ch¬
 *è
ngx_¬gv
[
i
], 
size
);

135 
	`ngx_£roù™Ë
(
t™Ë
);

138 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

140 
	`ngx_¡¬t_wÜk”_´oûs£s
(
cyþe
, 
ccf
->
wÜk”_´oûs£s
,

141 
NGX_PROCESS_RESPAWN
);

142 
	`ngx_¡¬t_ÿche_mªag”_´oûs£s
(
cyþe
, 0);

144 
ngx_Ãw_bš¬y
 = 0;

145 
d–ay
 = 0;

146 
sigio
 = 0;

147 
live
 = 1;

150 ià(
d–ay
) {

151 ià(
ngx_sig®rm
) {

152 
sigio
 = 0;

153 
d–ay
 *= 2;

154 
ngx_sig®rm
 = 0;

157 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

158 "‹rmš©iÚ cyþe: %d", 
d–ay
);

160 
™v
.
™_š‹rv®
.
tv_£c
 = 0;

161 
™v
.
™_š‹rv®
.
tv_u£c
 = 0;

162 
™v
.
™_v®ue
.
tv_£c
 = 
d–ay
 / 1000;

163 
™v
.
™_v®ue
.
tv_u£c
 = (
d–ay
 % 1000 ) * 1000;

165 ià(
	`£t™im”
(
ITIMER_REAL
, &
™v
, 
NULL
) == -1) {

166 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

171 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0, "sigsuspend");

173 
	`sigsu¥’d
(&
£t
);

175 
	`ngx_time_upd©e
();

177 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

178 "wakup, sigiØ%i", 
sigio
);

180 ià(
ngx_»­
) {

181 
ngx_»­
 = 0;

182 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0, "reap children");

184 
live
 = 
	`ngx_»­_chžd»n
(
cyþe
);

187 ià(!
live
 && (
ngx_‹rmš©e
 || 
ngx_qu™
)) {

188 
	`ngx_ma¡”_´oûss_ex™
(
cyþe
);

191 ià(
ngx_‹rmš©e
) {

192 ià(
d–ay
 == 0) {

193 
d–ay
 = 50;

196 ià(
sigio
) {

197 
sigio
--;

201 
sigio
 = 
ccf
->
wÜk”_´oûs£s
 + 2 ;

203 ià(
d–ay
 > 1000) {

204 
	`ngx_sigÇl_wÜk”_´oûs£s
(
cyþe
, 
SIGKILL
);

206 
	`ngx_sigÇl_wÜk”_´oûs£s
(
cyþe
,

207 
	`ngx_sigÇl_v®ue
(
NGX_TERMINATE_SIGNAL
));

213 ià(
ngx_qu™
) {

214 
	`ngx_sigÇl_wÜk”_´oûs£s
(
cyþe
,

215 
	`ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
));

217 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

218 
n
 = 0;‚ < 
cyþe
->
li¡’šg
.
ÃÉs
;‚++) {

219 ià(
	`ngx_þo£_sock‘
(
ls
[
n
].
fd
) == -1) {

220 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_sock‘_”ºo
,

221 
ngx_þo£_sock‘_n
 " %V failed",

222 &
ls
[
n
].
addr_‹xt
);

225 
cyþe
->
li¡’šg
.
ÃÉs
 = 0;

230 ià(
ngx_»cÚfigu»
) {

231 
ngx_»cÚfigu»
 = 0;

233 ià(
ngx_Ãw_bš¬y
) {

234 
	`ngx_¡¬t_wÜk”_´oûs£s
(
cyþe
, 
ccf
->
wÜk”_´oûs£s
,

235 
NGX_PROCESS_RESPAWN
);

236 
	`ngx_¡¬t_ÿche_mªag”_´oûs£s
(
cyþe
, 0);

237 
ngx_nßcû±šg
 = 0;

242 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "reconfiguring");

244 
cyþe
 = 
	`ngx_š™_cyþe
(cycle);

245 ià(
cyþe
 =ð
NULL
) {

246 
cyþe
 = (
ngx_cyþe_t
 *è
ngx_cyþe
;

250 
ngx_cyþe
 = 
cyþe
;

251 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
,

252 
ngx_cÜe_moduË
);

253 
	`ngx_¡¬t_wÜk”_´oûs£s
(
cyþe
, 
ccf
->
wÜk”_´oûs£s
,

254 
NGX_PROCESS_JUST_RESPAWN
);

255 
	`ngx_¡¬t_ÿche_mªag”_´oûs£s
(
cyþe
, 1);

258 
	`ngx_m¦“p
(100);

260 
live
 = 1;

261 
	`ngx_sigÇl_wÜk”_´oûs£s
(
cyþe
,

262 
	`ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
));

265 ià(
ngx_»¡¬t
) {

266 
ngx_»¡¬t
 = 0;

267 
	`ngx_¡¬t_wÜk”_´oûs£s
(
cyþe
, 
ccf
->
wÜk”_´oûs£s
,

268 
NGX_PROCESS_RESPAWN
);

269 
	`ngx_¡¬t_ÿche_mªag”_´oûs£s
(
cyþe
, 0);

270 
live
 = 1;

273 ià(
ngx_»Ý’
) {

274 
ngx_»Ý’
 = 0;

275 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "reopening†ogs");

276 
	`ngx_»Ý’_fžes
(
cyþe
, 
ccf
->
u£r
);

277 
	`ngx_sigÇl_wÜk”_´oûs£s
(
cyþe
,

278 
	`ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
));

281 ià(
ngx_chªge_bš¬y
) {

282 
ngx_chªge_bš¬y
 = 0;

283 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "changing binary");

284 
ngx_Ãw_bš¬y
 = 
	`ngx_exec_Ãw_bš¬y
(
cyþe
, 
ngx_¬gv
);

287 ià(
ngx_nßcû±
) {

288 
ngx_nßcû±
 = 0;

289 
ngx_nßcû±šg
 = 1;

290 
	`ngx_sigÇl_wÜk”_´oûs£s
(
cyþe
,

291 
	`ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
));

294 
	}
}

298 
	$ngx_sšgË_´oûss_cyþe
(
ngx_cyþe_t
 *
cyþe
)

300 
ngx_ušt_t
 
i
;

302 ià(
	`ngx_£t_’vœÚm’t
(
cyþe
, 
NULL
) == NULL) {

304 
	`ex™
(2);

307 
i
 = 0; 
ngx_moduËs
[i]; i++) {

308 ià(
ngx_moduËs
[
i
]->
š™_´oûss
) {

309 ià(
ngx_moduËs
[
i
]->
	`š™_´oûss
(
cyþe
è=ð
NGX_ERROR
) {

311 
	`ex™
(2);

317 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0, "worker cycle");

319 
	`ngx_´oûss_ev’ts_ªd_tim”s
(
cyþe
);

321 ià(
ngx_‹rmš©e
 || 
ngx_qu™
) {

323 
i
 = 0; 
ngx_moduËs
[i]; i++) {

324 ià(
ngx_moduËs
[
i
]->
ex™_´oûss
) {

325 
ngx_moduËs
[
i
]->
	`ex™_´oûss
(
cyþe
);

329 
	`ngx_ma¡”_´oûss_ex™
(
cyþe
);

332 ià(
ngx_»cÚfigu»
) {

333 
ngx_»cÚfigu»
 = 0;

334 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "reconfiguring");

336 
cyþe
 = 
	`ngx_š™_cyþe
(cycle);

337 ià(
cyþe
 =ð
NULL
) {

338 
cyþe
 = (
ngx_cyþe_t
 *è
ngx_cyþe
;

342 
ngx_cyþe
 = 
cyþe
;

345 ià(
ngx_»Ý’
) {

346 
ngx_»Ý’
 = 0;

347 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "reopening†ogs");

348 
	`ngx_»Ý’_fžes
(
cyþe
, (
ngx_uid_t
) -1);

351 
	}
}

355 
	$ngx_¡¬t_wÜk”_´oûs£s
(
ngx_cyþe_t
 *
cyþe
, 
ngx_št_t
 
n
,‚gx_št_ˆ
ty³
)

357 
ngx_št_t
 
i
;

358 
ngx_chªÃl_t
 
ch
;

360 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "start worker…rocesses");

362 
	`ngx_memz”o
(&
ch
, (
ngx_chªÃl_t
));

364 
ch
.
commªd
 = 
NGX_CMD_OPEN_CHANNEL
;

366 
i
 = 0; i < 
n
; i++) {

368 
	`ngx_¥awn_´oûss
(
cyþe
, 
ngx_wÜk”_´oûss_cyþe
,

369 (*è(
šŒ_t
è
i
, "wÜk”…roûss", 
ty³
);

371 
ch
.
pid
 = 
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].pid;

372 
ch
.
¦Ù
 = 
ngx_´oûss_¦Ù
;

373 
ch
.
fd
 = 
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].
chªÃl
[0];

375 
	`ngx_·ss_Ý’_chªÃl
(
cyþe
, &
ch
);

377 
	}
}

381 
	$ngx_¡¬t_ÿche_mªag”_´oûs£s
(
ngx_cyþe_t
 *
cyþe
, 
ngx_ušt_t
 
»¥awn
)

383 
ngx_ušt_t
 
i
, 
mªag”
, 
lßd”
;

384 
ngx_·th_t
 **
·th
;

385 
ngx_chªÃl_t
 
ch
;

387 
mªag”
 = 0;

388 
lßd”
 = 0;

390 
·th
 = 
ngx_cyþe
->
·ths
.
–ts
;

391 
i
 = 0; i < 
ngx_cyþe
->
·ths
.
ÃÉs
; i++) {

393 ià(
·th
[
i
]->
mªag”
) {

394 
mªag”
 = 1;

397 ià(
·th
[
i
]->
lßd”
) {

398 
lßd”
 = 1;

402 ià(
mªag”
 == 0) {

406 
	`ngx_¥awn_´oûss
(
cyþe
, 
ngx_ÿche_mªag”_´oûss_cyþe
,

407 &
ngx_ÿche_mªag”_ùx
, "cache manager…rocess",

408 
»¥awn
 ? 
NGX_PROCESS_JUST_RESPAWN
 : 
NGX_PROCESS_RESPAWN
);

410 
	`ngx_memz”o
(&
ch
, (
ngx_chªÃl_t
));

412 
ch
.
commªd
 = 
NGX_CMD_OPEN_CHANNEL
;

413 
ch
.
pid
 = 
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].pid;

414 
ch
.
¦Ù
 = 
ngx_´oûss_¦Ù
;

415 
ch
.
fd
 = 
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].
chªÃl
[0];

417 
	`ngx_·ss_Ý’_chªÃl
(
cyþe
, &
ch
);

419 ià(
lßd”
 == 0) {

423 
	`ngx_¥awn_´oûss
(
cyþe
, 
ngx_ÿche_mªag”_´oûss_cyþe
,

424 &
ngx_ÿche_lßd”_ùx
, "cache†oader…rocess",

425 
»¥awn
 ? 
NGX_PROCESS_JUST_SPAWN
 : 
NGX_PROCESS_NORESPAWN
);

427 
ch
.
commªd
 = 
NGX_CMD_OPEN_CHANNEL
;

428 
ch
.
pid
 = 
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].pid;

429 
ch
.
¦Ù
 = 
ngx_´oûss_¦Ù
;

430 
ch
.
fd
 = 
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].
chªÃl
[0];

432 
	`ngx_·ss_Ý’_chªÃl
(
cyþe
, &
ch
);

433 
	}
}

437 
	$ngx_·ss_Ý’_chªÃl
(
ngx_cyþe_t
 *
cyþe
, 
ngx_chªÃl_t
 *
ch
)

439 
ngx_št_t
 
i
;

441 
i
 = 0; i < 
ngx_Ï¡_´oûss
; i++) {

443 ià(
i
 =ð
ngx_´oûss_¦Ù


444 || 
ngx_´oûs£s
[
i
].
pid
 == -1

445 || 
ngx_´oûs£s
[
i
].
chªÃl
[0] == -1)

450 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

452 
ch
->
¦Ù
, ch->
pid
, ch->
fd
,

453 
i
, 
ngx_´oûs£s
[i].
pid
,

454 
ngx_´oûs£s
[
i
].
chªÃl
[0]);

458 
	`ngx_wr™e_chªÃl
(
ngx_´oûs£s
[
i
].
chªÃl
[0],

459 
ch
, (
ngx_chªÃl_t
), 
cyþe
->
log
);

461 
	}
}

465 
	$ngx_sigÇl_wÜk”_´oûs£s
(
ngx_cyþe_t
 *
cyþe
, 
signo
)

467 
ngx_št_t
 
i
;

468 
ngx_”r_t
 
”r
;

469 
ngx_chªÃl_t
 
ch
;

471 
	`ngx_memz”o
(&
ch
, (
ngx_chªÃl_t
));

473 #ià(
NGX_BROKEN_SCM_RIGHTS
)

475 
ch
.
commªd
 = 0;

479 
signo
) {

481 
	`ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
):

482 
ch
.
commªd
 = 
NGX_CMD_QUIT
;

485 
	`ngx_sigÇl_v®ue
(
NGX_TERMINATE_SIGNAL
):

486 
ch
.
commªd
 = 
NGX_CMD_TERMINATE
;

489 
	`ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
):

490 
ch
.
commªd
 = 
NGX_CMD_REOPEN
;

494 
ch
.
commªd
 = 0;

499 
ch
.
fd
 = -1;

502 
i
 = 0; i < 
ngx_Ï¡_´oûss
; i++) {

504 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

506 
i
,

507 
ngx_´oûs£s
[
i
].
pid
,

508 
ngx_´oûs£s
[
i
].
ex™šg
,

509 
ngx_´oûs£s
[
i
].
ex™ed
,

510 
ngx_´oûs£s
[
i
].
d‘ached
,

511 
ngx_´oûs£s
[
i
].
»¥awn
,

512 
ngx_´oûs£s
[
i
].
ju¡_¥awn
);

514 ià(
ngx_´oûs£s
[
i
].
d‘ached
 ||‚gx_´oûs£s[i].
pid
 == -1) {

518 ià(
ngx_´oûs£s
[
i
].
ju¡_¥awn
) {

519 
ngx_´oûs£s
[
i
].
ju¡_¥awn
 = 0;

523 ià(
ngx_´oûs£s
[
i
].
ex™šg


524 && 
signo
 =ð
	`ngx_sigÇl_v®ue
(
NGX_SHUTDOWN_SIGNAL
))

529 ià(
ch
.
commªd
) {

530 ià(
	`ngx_wr™e_chªÃl
(
ngx_´oûs£s
[
i
].
chªÃl
[0],

531 &
ch
, (
ngx_chªÃl_t
), 
cyþe
->
log
)

532 =ð
NGX_OK
)

534 ià(
signo
 !ð
	`ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
)) {

535 
ngx_´oûs£s
[
i
].
ex™šg
 = 1;

542 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

543 "kžÈ(%P, %d)", 
ngx_´oûs£s
[
i
].
pid
, 
signo
);

545 ià(
	`kžl
(
ngx_´oûs£s
[
i
].
pid
, 
signo
) == -1) {

546 
”r
 = 
ngx_”ºo
;

547 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

548 "kžl(%P, %dèçžed", 
ngx_´oûs£s
[
i
].
pid
, 
signo
);

550 ià(
”r
 =ð
NGX_ESRCH
) {

551 
ngx_´oûs£s
[
i
].
ex™ed
 = 1;

552 
ngx_´oûs£s
[
i
].
ex™šg
 = 0;

553 
ngx_»­
 = 1;

559 ià(
signo
 !ð
	`ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
)) {

560 
ngx_´oûs£s
[
i
].
ex™šg
 = 1;

563 
	}
}

566 
ngx_ušt_t


567 
	$ngx_»­_chžd»n
(
ngx_cyþe_t
 *
cyþe
)

569 
ngx_št_t
 
i
, 
n
;

570 
ngx_ušt_t
 
live
;

571 
ngx_chªÃl_t
 
ch
;

572 
ngx_cÜe_cÚf_t
 *
ccf
;

574 
	`ngx_memz”o
(&
ch
, (
ngx_chªÃl_t
));

576 
ch
.
commªd
 = 
NGX_CMD_CLOSE_CHANNEL
;

577 
ch
.
fd
 = -1;

579 
live
 = 0;

580 
i
 = 0; i < 
ngx_Ï¡_´oûss
; i++) {

582 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0,

584 
i
,

585 
ngx_´oûs£s
[
i
].
pid
,

586 
ngx_´oûs£s
[
i
].
ex™šg
,

587 
ngx_´oûs£s
[
i
].
ex™ed
,

588 
ngx_´oûs£s
[
i
].
d‘ached
,

589 
ngx_´oûs£s
[
i
].
»¥awn
,

590 
ngx_´oûs£s
[
i
].
ju¡_¥awn
);

592 ià(
ngx_´oûs£s
[
i
].
pid
 == -1) {

596 ià(
ngx_´oûs£s
[
i
].
ex™ed
) {

598 ià(!
ngx_´oûs£s
[
i
].
d‘ached
) {

599 
	`ngx_þo£_chªÃl
(
ngx_´oûs£s
[
i
].
chªÃl
, 
cyþe
->
log
);

601 
ngx_´oûs£s
[
i
].
chªÃl
[0] = -1;

602 
ngx_´oûs£s
[
i
].
chªÃl
[1] = -1;

604 
ch
.
pid
 = 
ngx_´oûs£s
[
i
].pid;

605 
ch
.
¦Ù
 = 
i
;

607 
n
 = 0;‚ < 
ngx_Ï¡_´oûss
;‚++) {

608 ià(
ngx_´oûs£s
[
n
].
ex™ed


609 || 
ngx_´oûs£s
[
n
].
pid
 == -1

610 || 
ngx_´oûs£s
[
n
].
chªÃl
[0] == -1)

615 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

617 
ch
.
¦Ù
, ch.
pid
, 
ngx_´oûs£s
[
n
].pid);

621 
	`ngx_wr™e_chªÃl
(
ngx_´oûs£s
[
n
].
chªÃl
[0],

622 &
ch
, (
ngx_chªÃl_t
), 
cyþe
->
log
);

626 ià(
ngx_´oûs£s
[
i
].
»¥awn


627 && !
ngx_´oûs£s
[
i
].
ex™šg


628 && !
ngx_‹rmš©e


629 && !
ngx_qu™
)

631 ià(
	`ngx_¥awn_´oûss
(
cyþe
, 
ngx_´oûs£s
[
i
].
´oc
,

632 
ngx_´oûs£s
[
i
].
d©a
,

633 
ngx_´oûs£s
[
i
].
Çme
, i)

634 =ð
NGX_INVALID_PID
)

636 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

638 
ngx_´oûs£s
[
i
].
Çme
);

643 
ch
.
commªd
 = 
NGX_CMD_OPEN_CHANNEL
;

644 
ch
.
pid
 = 
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].pid;

645 
ch
.
¦Ù
 = 
ngx_´oûss_¦Ù
;

646 
ch
.
fd
 = 
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].
chªÃl
[0];

648 
	`ngx_·ss_Ý’_chªÃl
(
cyþe
, &
ch
);

650 
live
 = 1;

655 ià(
ngx_´oûs£s
[
i
].
pid
 =ð
ngx_Ãw_bš¬y
) {

657 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
,

658 
ngx_cÜe_moduË
);

660 ià(
	`ngx_»Çme_fže
((*è
ccf
->
Þdpid
.
d©a
,

661 (*è
ccf
->
pid
.
d©a
)

662 =ð
NGX_FILE_ERROR
)

664 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

665 
ngx_»Çme_fže_n
 " %s backo %s failed "

667 
ccf
->
Þdpid
.
d©a
, ccf->
pid
.d©a, 
ngx_¬gv
[0]);

670 
ngx_Ãw_bš¬y
 = 0;

671 ià(
ngx_nßcû±šg
) {

672 
ngx_»¡¬t
 = 1;

673 
ngx_nßcû±šg
 = 0;

677 ià(
i
 =ð
ngx_Ï¡_´oûss
 - 1) {

678 
ngx_Ï¡_´oûss
--;

681 
ngx_´oûs£s
[
i
].
pid
 = -1;

684 } ià(
ngx_´oûs£s
[
i
].
ex™šg
 || !ngx_´oûs£s[i].
d‘ached
) {

685 
live
 = 1;

689  
live
;

690 
	}
}

694 
	$ngx_ma¡”_´oûss_ex™
(
ngx_cyþe_t
 *
cyþe
)

696 
ngx_ušt_t
 
i
;

698 
	`ngx_d–‘e_pidfže
(
cyþe
);

700 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "exit");

702 
i
 = 0; 
ngx_moduËs
[i]; i++) {

703 ià(
ngx_moduËs
[
i
]->
ex™_ma¡”
) {

704 
ngx_moduËs
[
i
]->
	`ex™_ma¡”
(
cyþe
);

708 
	`ngx_þo£_li¡’šg_sock‘s
(
cyþe
);

718 
ngx_ex™_log
 = *
	`ngx_log_g‘_fže_log
(
ngx_cyþe
->
log
);

720 
ngx_ex™_log_fže
.
fd
 = 
ngx_ex™_log
.
fže
->fd;

721 
ngx_ex™_log
.
fže
 = &
ngx_ex™_log_fže
;

722 
ngx_ex™_log
.
Ãxt
 = 
NULL
;

723 
ngx_ex™_log
.
wr™”
 = 
NULL
;

725 
ngx_ex™_cyþe
.
log
 = &
ngx_ex™_log
;

726 
ngx_ex™_cyþe
.
fžes
 = 
ngx_cyþe
->files;

727 
ngx_ex™_cyþe
.
fžes_n
 = 
ngx_cyþe
->files_n;

728 
ngx_cyþe
 = &
ngx_ex™_cyþe
;

730 
	`ngx_de¡roy_poÞ
(
cyþe
->
poÞ
);

732 
	`ex™
(0);

733 
	}
}

737 
	$ngx_wÜk”_´oûss_cyþe
(
ngx_cyþe_t
 *
cyþe
, *
d©a
)

739 
ngx_št_t
 
wÜk”
 = (
šŒ_t
è
d©a
;

741 
ngx_ušt_t
 
i
;

742 
ngx_cÚÃùiÚ_t
 *
c
;

744 
ngx_´oûss
 = 
NGX_PROCESS_WORKER
;

746 
	`ngx_wÜk”_´oûss_š™
(
cyþe
, 
wÜk”
);

748 
	`ngx_£roù™Ë
("worker…rocess");

750 #ià(
NGX_THREADS
)

752 
ngx_št_t
 
n
;

753 
ngx_”r_t
 
”r
;

754 
ngx_cÜe_cÚf_t
 *
ccf
;

756 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

758 ià(
ngx_th»ads_n
) {

759 ià(
	`ngx_š™_th»ads
(
ngx_th»ads_n
, 
ccf
->
th»ad_¡ack_size
, 
cyþe
)

760 =ð
NGX_ERROR
)

763 
	`ex™
(2);

766 
”r
 = 
	`ngx_th»ad_key_ü—‹
(&
ngx_cÜe_Žs_key
);

767 ià(
”r
 != 0) {

768 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

769 
ngx_th»ad_key_ü—‹_n
 " failed");

771 
	`ex™
(2);

774 
n
 = 0;‚ < 
ngx_th»ads_n
;‚++) {

776 
ngx_th»ads
[
n
].
cv
 = 
	`ngx_cÚd_š™
(
cyþe
->
log
);

778 ià(
ngx_th»ads
[
n
].
cv
 =ð
NULL
) {

780 
	`ex™
(2);

783 ià(
	`ngx_ü—‹_th»ad
((
ngx_tid_t
 *è&
ngx_th»ads
[
n
].
tid
,

784 
ngx_wÜk”_th»ad_cyþe
,

785 (*è&
ngx_th»ads
[
n
], 
cyþe
->
log
)

789 
	`ex™
(2);

798 ià(
ngx_ex™šg
) {

800 
c
 = 
cyþe
->
cÚÃùiÚs
;

802 
i
 = 0; i < 
cyþe
->
cÚÃùiÚ_n
; i++) {

806 ià(
c
[
i
].
fd
 !ð-1 && c[i].
idË
) {

807 
c
[
i
].
þo£
 = 1;

808 
c
[
i
].
»ad
->
	`hªdËr
(c[i].read);

812 
	`ngx_ev’t_ÿnûl_tim”s
();

814 ià(
ngx_ev’t_tim”_rbŒ“
.
roÙ
 =ðngx_ev’t_tim”_rbŒ“.
£Áš–
)

816 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "exiting");

818 
	`ngx_wÜk”_´oûss_ex™
(
cyþe
);

822 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
cyþe
->
log
, 0, "worker cycle");

824 
	`ngx_´oûss_ev’ts_ªd_tim”s
(
cyþe
);

826 ià(
ngx_‹rmš©e
) {

827 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "exiting");

829 
	`ngx_wÜk”_´oûss_ex™
(
cyþe
);

832 ià(
ngx_qu™
) {

833 
ngx_qu™
 = 0;

834 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0,

836 
	`ngx_£roù™Ë
("worker…rocess is shutting down");

838 ià(!
ngx_ex™šg
) {

839 
	`ngx_þo£_li¡’šg_sock‘s
(
cyþe
);

840 
ngx_ex™šg
 = 1;

844 ià(
ngx_»Ý’
) {

845 
ngx_»Ý’
 = 0;

846 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "reopening†ogs");

847 
	`ngx_»Ý’_fžes
(
cyþe
, -1);

850 
	}
}

854 
	$ngx_wÜk”_´oûss_š™
(
ngx_cyþe_t
 *
cyþe
, 
ngx_št_t
 
wÜk”
)

856 
sig£t_t
 
£t
;

857 
ušt64_t
 
ýu_affš™y
;

858 
ngx_št_t
 
n
;

859 
ngx_ušt_t
 
i
;

860 
¾im™
 
¾mt
;

861 
ngx_cÜe_cÚf_t
 *
ccf
;

862 
ngx_li¡’šg_t
 *
ls
;

864 ià(
	`ngx_£t_’vœÚm’t
(
cyþe
, 
NULL
) == NULL) {

866 
	`ex™
(2);

869 
ccf
 = (
ngx_cÜe_cÚf_t
 *è
	`ngx_g‘_cÚf
(
cyþe
->
cÚf_ùx
, 
ngx_cÜe_moduË
);

871 ià(
wÜk”
 >ð0 && 
ccf
->
´iÜ™y
 != 0) {

872 ià(
	`£riÜ™y
(
PRIO_PROCESS
, 0, 
ccf
->
´iÜ™y
) == -1) {

873 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

874 "£riÜ™y(%dèçžed", 
ccf
->
´iÜ™y
);

878 ià(
ccf
->
¾im™_nofže
 !ð
NGX_CONF_UNSET
) {

879 
¾mt
.
¾im_cur
 = (
¾im_t
è
ccf
->
¾im™_nofže
;

880 
¾mt
.
¾im_max
 = (
¾im_t
è
ccf
->
¾im™_nofže
;

882 ià(
	`£Œlim™
(
RLIMIT_NOFILE
, &
¾mt
) == -1) {

883 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

885 
ccf
->
¾im™_nofže
);

889 ià(
ccf
->
¾im™_cÜe
 !ð
NGX_CONF_UNSET
) {

890 
¾mt
.
¾im_cur
 = (
¾im_t
è
ccf
->
¾im™_cÜe
;

891 
¾mt
.
¾im_max
 = (
¾im_t
è
ccf
->
¾im™_cÜe
;

893 ià(
	`£Œlim™
(
RLIMIT_CORE
, &
¾mt
) == -1) {

894 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

896 
ccf
->
¾im™_cÜe
);

900 #ifdeà
RLIMIT_SIGPENDING


901 ià(
ccf
->
¾im™_sig³ndšg
 !ð
NGX_CONF_UNSET
) {

902 
¾mt
.
¾im_cur
 = (
¾im_t
è
ccf
->
¾im™_sig³ndšg
;

903 
¾mt
.
¾im_max
 = (
¾im_t
è
ccf
->
¾im™_sig³ndšg
;

905 ià(
	`£Œlim™
(
RLIMIT_SIGPENDING
, &
¾mt
) == -1) {

906 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

908 
ccf
->
¾im™_sig³ndšg
);

913 ià(
	`g‘euid
() == 0) {

914 ià(
	`£tgid
(
ccf
->
group
) == -1) {

915 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

916 "£tgid(%dèçžed", 
ccf
->
group
);

918 
	`ex™
(2);

921 ià(
	`š™groups
(
ccf
->
u£ºame
, ccf->
group
) == -1) {

922 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

924 
ccf
->
u£ºame
, ccf->
group
);

927 ià(
	`£tuid
(
ccf
->
u£r
) == -1) {

928 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cyþe
->
log
, 
ngx_”ºo
,

929 "£tuid(%dèçžed", 
ccf
->
u£r
);

931 
	`ex™
(2);

935 ià(
wÜk”
 >= 0) {

936 
ýu_affš™y
 = 
	`ngx_g‘_ýu_affš™y
(
wÜk”
);

938 ià(
ýu_affš™y
) {

939 
	`ngx_£ffš™y
(
ýu_affš™y
, 
cyþe
->
log
);

943 #ià(
NGX_HAVE_PR_SET_DUMPABLE
)

947 ià(
	`´ùl
(
PR_SET_DUMPABLE
, 1, 0, 0, 0) == -1) {

948 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

954 ià(
ccf
->
wÜkšg_dœeùÜy
.
Ën
) {

955 ià(
	`chdœ
((*è
ccf
->
wÜkšg_dœeùÜy
.
d©a
) == -1) {

956 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

957 "chdœ(\"%s\"èçžed", 
ccf
->
wÜkšg_dœeùÜy
.
d©a
);

959 
	`ex™
(2);

963 
	`sigem±y£t
(&
£t
);

965 ià(
	`sig´ocmask
(
SIG_SETMASK
, &
£t
, 
NULL
) == -1) {

966 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

970 
	`¤ªdom
((
ngx_pid
 << 16è^ 
	`ngx_time
());

976 
ls
 = 
cyþe
->
li¡’šg
.
–ts
;

977 
i
 = 0; i < 
cyþe
->
li¡’šg
.
ÃÉs
; i++) {

978 
ls
[
i
].
´evious
 = 
NULL
;

981 
i
 = 0; 
ngx_moduËs
[i]; i++) {

982 ià(
ngx_moduËs
[
i
]->
š™_´oûss
) {

983 ià(
ngx_moduËs
[
i
]->
	`š™_´oûss
(
cyþe
è=ð
NGX_ERROR
) {

985 
	`ex™
(2);

990 
n
 = 0;‚ < 
ngx_Ï¡_´oûss
;‚++) {

992 ià(
ngx_´oûs£s
[
n
].
pid
 == -1) {

996 ià(
n
 =ð
ngx_´oûss_¦Ù
) {

1000 ià(
ngx_´oûs£s
[
n
].
chªÃl
[1] == -1) {

1004 ià(
	`þo£
(
ngx_´oûs£s
[
n
].
chªÃl
[1]) == -1) {

1005 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

1010 ià(
	`þo£
(
ngx_´oûs£s
[
ngx_´oûss_¦Ù
].
chªÃl
[0]) == -1) {

1011 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
ngx_”ºo
,

1016 
ngx_Ï¡_´oûss
 = 0;

1019 ià(
	`ngx_add_chªÃl_ev’t
(
cyþe
, 
ngx_chªÃl
, 
NGX_READ_EVENT
,

1020 
ngx_chªÃl_hªdËr
)

1021 =ð
NGX_ERROR
)

1024 
	`ex™
(2);

1026 
	}
}

1030 
	$ngx_wÜk”_´oûss_ex™
(
ngx_cyþe_t
 *
cyþe
)

1032 
ngx_ušt_t
 
i
;

1033 
ngx_cÚÃùiÚ_t
 *
c
;

1035 #ià(
NGX_THREADS
)

1036 
ngx_‹rmš©e
 = 1;

1038 
	`ngx_wakeup_wÜk”_th»ads
(
cyþe
);

1041 
i
 = 0; 
ngx_moduËs
[i]; i++) {

1042 ià(
ngx_moduËs
[
i
]->
ex™_´oûss
) {

1043 
ngx_moduËs
[
i
]->
	`ex™_´oûss
(
cyþe
);

1047 ià(
ngx_ex™šg
) {

1048 
c
 = 
cyþe
->
cÚÃùiÚs
;

1049 
i
 = 0; i < 
cyþe
->
cÚÃùiÚ_n
; i++) {

1050 ià(
c
[
i
].
fd
 != -1

1051 && 
c
[
i
].
»ad


1052 && !
c
[
i
].
»ad
->
acû±


1053 && !
c
[
i
].
»ad
->
chªÃl


1054 && !
c
[
i
].
»ad
->
»sÞv”
)

1056 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0,

1058 
c
[
i
].
numb”
, c[i].
fd
, i);

1059 
ngx_debug_qu™
 = 1;

1063 ià(
ngx_debug_qu™
) {

1064 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 0, "aborting");

1065 
	`ngx_debug_pošt
();

1076 
ngx_ex™_log
 = *
	`ngx_log_g‘_fže_log
(
ngx_cyþe
->
log
);

1078 
ngx_ex™_log_fže
.
fd
 = 
ngx_ex™_log
.
fže
->fd;

1079 
ngx_ex™_log
.
fže
 = &
ngx_ex™_log_fže
;

1080 
ngx_ex™_log
.
Ãxt
 = 
NULL
;

1081 
ngx_ex™_log
.
wr™”
 = 
NULL
;

1083 
ngx_ex™_cyþe
.
log
 = &
ngx_ex™_log
;

1084 
ngx_ex™_cyþe
.
fžes
 = 
ngx_cyþe
->files;

1085 
ngx_ex™_cyþe
.
fžes_n
 = 
ngx_cyþe
->files_n;

1086 
ngx_cyþe
 = &
ngx_ex™_cyþe
;

1088 
	`ngx_de¡roy_poÞ
(
cyþe
->
poÞ
);

1090 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
ngx_cyþe
->
log
, 0, "exit");

1092 
	`ex™
(0);

1093 
	}
}

1097 
	$ngx_chªÃl_hªdËr
(
ngx_ev’t_t
 *
ev
)

1099 
ngx_št_t
 
n
;

1100 
ngx_chªÃl_t
 
ch
;

1101 
ngx_cÚÃùiÚ_t
 *
c
;

1103 ià(
ev
->
timedout
) {

1104 
ev
->
timedout
 = 0;

1108 
c
 = 
ev
->
d©a
;

1110 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ev
->
log
, 0, "channel handler");

1114 
n
 = 
	`ngx_»ad_chªÃl
(
c
->
fd
, &
ch
, (
ngx_chªÃl_t
), 
ev
->
log
);

1116 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ev
->
log
, 0, "chªÃl: %i", 
n
);

1118 ià(
n
 =ð
NGX_ERROR
) {

1120 ià(
ngx_ev’t_æags
 & 
NGX_USE_EPOLL_EVENT
) {

1121 
	`ngx_d–_cÚn
(
c
, 0);

1124 
	`ngx_þo£_cÚÃùiÚ
(
c
);

1128 ià(
ngx_ev’t_æags
 & 
NGX_USE_EVENTPORT_EVENT
) {

1129 ià(
	`ngx_add_ev’t
(
ev
, 
NGX_READ_EVENT
, 0è=ð
NGX_ERROR
) {

1134 ià(
n
 =ð
NGX_AGAIN
) {

1138 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ev
->
log
, 0,

1139 "chªÃÈcommªd: %d", 
ch
.
commªd
);

1141 
ch
.
commªd
) {

1143 
NGX_CMD_QUIT
:

1144 
ngx_qu™
 = 1;

1147 
NGX_CMD_TERMINATE
:

1148 
ngx_‹rmš©e
 = 1;

1151 
NGX_CMD_REOPEN
:

1152 
ngx_»Ý’
 = 1;

1155 
NGX_CMD_OPEN_CHANNEL
:

1157 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
ev
->
log
, 0,

1159 
ch
.
¦Ù
, ch.
pid
, ch.
fd
);

1161 
ngx_´oûs£s
[
ch
.
¦Ù
].
pid
 = ch.pid;

1162 
ngx_´oûs£s
[
ch
.
¦Ù
].
chªÃl
[0] = ch.
fd
;

1165 
NGX_CMD_CLOSE_CHANNEL
:

1167 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_CORE
, 
ev
->
log
, 0,

1169 
ch
.
¦Ù
, ch.
pid
, 
ngx_´oûs£s
[ch.slot].pid,

1170 
ngx_´oûs£s
[
ch
.
¦Ù
].
chªÃl
[0]);

1172 ià(
	`þo£
(
ngx_´oûs£s
[
ch
.
¦Ù
].
chªÃl
[0]) == -1) {

1173 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
ev
->
log
, 
ngx_”ºo
,

1177 
ngx_´oûs£s
[
ch
.
¦Ù
].
chªÃl
[0] = -1;

1181 
	}
}

1184 #ià(
NGX_THREADS
)

1187 
	$ngx_wakeup_wÜk”_th»ads
(
ngx_cyþe_t
 *
cyþe
)

1189 
ngx_št_t
 
i
;

1190 
ngx_ušt_t
 
live
;

1194 
live
 = 0;

1196 
i
 = 0; i < 
ngx_th»ads_n
; i++) {

1197 ià(
ngx_th»ads
[
i
].
¡©e
 < 
NGX_THREAD_EXIT
) {

1198 ià(
	`ngx_cÚd_sigÇl
(
ngx_th»ads
[
i
].
cv
è=ð
NGX_ERROR
) {

1199 
ngx_th»ads
[
i
].
¡©e
 = 
NGX_THREAD_DONE
;

1202 
live
 = 1;

1206 ià(
ngx_th»ads
[
i
].
¡©e
 =ð
NGX_THREAD_EXIT
) {

1207 
	`ngx_th»ad_još
(
ngx_th»ads
[
i
].
tid
, 
NULL
);

1208 
ngx_th»ads
[
i
].
¡©e
 = 
NGX_THREAD_DONE
;

1212 ià(
live
 == 0) {

1213 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

1217 
	`ngx_dÚe_ev’ts
(
cyþe
);

1222 
	`ngx_sched_y›ld
();

1224 
	}
}

1227 
ngx_th»ad_v®ue_t


1228 
	$ngx_wÜk”_th»ad_cyþe
(*
d©a
)

1230 
ngx_th»ad_t
 *
thr
 = 
d©a
;

1232 
sig£t_t
 
£t
;

1233 
ngx_”r_t
 
”r
;

1234 
ngx_cÜe_Žs_t
 *
Žs
;

1235 
ngx_cyþe_t
 *
cyþe
;

1237 
cyþe
 = (
ngx_cyþe_t
 *è
ngx_cyþe
;

1239 
	`sigem±y£t
(&
£t
);

1240 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_RECONFIGURE_SIGNAL
));

1241 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_REOPEN_SIGNAL
));

1242 
	`sigadd£t
(&
£t
, 
	`ngx_sigÇl_v®ue
(
NGX_CHANGEBIN_SIGNAL
));

1244 
”r
 = 
	`ngx_th»ad_sigmask
(
SIG_BLOCK
, &
£t
, 
NULL
);

1245 ià(
”r
) {

1246 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

1247 
ngx_th»ad_sigmask_n
 " failed");

1248  (
ngx_th»ad_v®ue_t
) 1;

1251 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

1252 "th»ad " 
NGX_TID_T_FMT
 " s¹ed", 
	`ngx_th»ad_£lf
());

1254 
	`ngx_£‰h¹™Ë
("workerhread");

1256 
Žs
 = 
	`ngx_ÿÎoc
((
ngx_cÜe_Žs_t
), 
cyþe
->
log
);

1257 ià(
Žs
 =ð
NULL
) {

1258  (
ngx_th»ad_v®ue_t
) 1;

1261 
”r
 = 
	`ngx_th»ad_£t_Žs
(
ngx_cÜe_Žs_key
, 
Žs
);

1262 ià(
”r
 != 0) {

1263 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

1264 
ngx_th»ad_£t_Žs_n
 " failed");

1265  (
ngx_th»ad_v®ue_t
) 1;

1269 
thr
->
¡©e
 = 
NGX_THREAD_FREE
;

1272 ià(
	`ngx_cÚd_wa™
(
thr
->
cv
, 
ngx_po¡ed_ev’ts_mu‹x
è=ð
NGX_ERROR
) {

1273  (
ngx_th»ad_v®ue_t
) 1;

1277 ià(
ngx_‹rmš©e
) {

1278 
thr
->
¡©e
 = 
NGX_THREAD_EXIT
;

1280 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cyþe
->
log
, 0,

1281 "th»ad " 
NGX_TID_T_FMT
 " is done",

1282 
	`ngx_th»ad_£lf
());

1284  (
ngx_th»ad_v®ue_t
) 0;

1287 
thr
->
¡©e
 = 
NGX_THREAD_BUSY
;

1290 ià(
	`ngx_ev’t_th»ad_´oûss_po¡ed
(
cyþe
è=ð
NGX_ERROR
) {

1291  (
ngx_th»ad_v®ue_t
) 1;

1294 ià(
	`ngx_ev’t_th»ad_´oûss_po¡ed
(
cyþe
è=ð
NGX_ERROR
) {

1295  (
ngx_th»ad_v®ue_t
) 1;

1299 ià(
ngx_´oûss_chªges
) {

1300 ià(
	`ngx_´oûss_chªges
(
cyþe
, 1è=ð
NGX_ERROR
) {

1301  (
ngx_th»ad_v®ue_t
) 1;

1305 
	}
}

1311 
	$ngx_ÿche_mªag”_´oûss_cyþe
(
ngx_cyþe_t
 *
cyþe
, *
d©a
)

1313 
ngx_ÿche_mªag”_ùx_t
 *
ùx
 = 
d©a
;

1315 *
id’t
[4];

1316 
ngx_ev’t_t
 
ev
;

1322 
ngx_´oûss
 = 
NGX_PROCESS_HELPER
;

1324 
	`ngx_þo£_li¡’šg_sock‘s
(
cyþe
);

1327 
cyþe
->
cÚÃùiÚ_n
 = 512;

1329 
	`ngx_wÜk”_´oûss_š™
(
cyþe
, -1);

1331 
	`ngx_memz”o
(&
ev
, (
ngx_ev’t_t
));

1332 
ev
.
hªdËr
 = 
ùx
->handler;

1333 
ev
.
d©a
 = 
id’t
;

1334 
ev
.
log
 = 
cyþe
->log;

1335 
id’t
[3] = (*) -1;

1337 
ngx_u£_acû±_mu‹x
 = 0;

1339 
	`ngx_£roù™Ë
(
ùx
->
Çme
);

1341 
	`ngx_add_tim”
(&
ev
, 
ùx
->
d–ay
);

1345 ià(
ngx_‹rmš©e
 || 
ngx_qu™
) {

1346 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "exiting");

1347 
	`ex™
(0);

1350 ià(
ngx_»Ý’
) {

1351 
ngx_»Ý’
 = 0;

1352 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
cyþe
->
log
, 0, "reopening†ogs");

1353 
	`ngx_»Ý’_fžes
(
cyþe
, -1);

1356 
	`ngx_´oûss_ev’ts_ªd_tim”s
(
cyþe
);

1358 
	}
}

1362 
	$ngx_ÿche_mªag”_´oûss_hªdËr
(
ngx_ev’t_t
 *
ev
)

1364 
time_t
 
Ãxt
, 
n
;

1365 
ngx_ušt_t
 
i
;

1366 
ngx_·th_t
 **
·th
;

1368 
Ãxt
 = 60 * 60;

1370 
·th
 = 
ngx_cyþe
->
·ths
.
–ts
;

1371 
i
 = 0; i < 
ngx_cyþe
->
·ths
.
ÃÉs
; i++) {

1373 ià(
·th
[
i
]->
mªag”
) {

1374 
n
 = 
·th
[
i
]->
	`mªag”
Õ©h[i]->
d©a
);

1376 
Ãxt
 = (
n
 <=‚ext) ?‚ :‚ext;

1378 
	`ngx_time_upd©e
();

1382 ià(
Ãxt
 == 0) {

1383 
Ãxt
 = 1;

1386 
	`ngx_add_tim”
(
ev
, 
Ãxt
 * 1000);

1387 
	}
}

1391 
	$ngx_ÿche_lßd”_´oûss_hªdËr
(
ngx_ev’t_t
 *
ev
)

1393 
ngx_ušt_t
 
i
;

1394 
ngx_·th_t
 **
·th
;

1395 
ngx_cyþe_t
 *
cyþe
;

1397 
cyþe
 = (
ngx_cyþe_t
 *è
ngx_cyþe
;

1399 
·th
 = 
cyþe
->
·ths
.
–ts
;

1400 
i
 = 0; i < 
cyþe
->
·ths
.
ÃÉs
; i++) {

1402 ià(
ngx_‹rmš©e
 || 
ngx_qu™
) {

1406 ià(
·th
[
i
]->
lßd”
) {

1407 
·th
[
i
]->
	`lßd”
Õ©h[i]->
d©a
);

1408 
	`ngx_time_upd©e
();

1412 
	`ex™
(0);

1413 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_pthread_thread.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
ngx_ušt_t
 
	gÁh»ads
;

13 
ngx_ušt_t
 
	gmax_th»ads
;

16 
±h»ad_©Œ_t
 
	gthr_©Œ
;

19 
ngx_”r_t


20 
ngx_ü—‹_th»ad
(
ngx_tid_t
 *
tid
, 
	$ngx_th»ad_v®ue_t
 (*
func
)(*
¬g
),

21 *
¬g
, 
ngx_log_t
 *
log
)

23 
”r
;

25 ià(
Áh»ads
 >ð
max_th»ads
) {

26 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
log
, 0,

27 "nØmÜthª %u˜th»ad ÿÀbü—‹d", 
max_th»ads
);

28  
NGX_ERROR
;

31 
”r
 = 
	`±h»ad_ü—‹
(
tid
, &
thr_©Œ
, 
func
, 
¬g
);

33 ià(
”r
 != 0) {

34 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
”r
, "pthread_create() failed");

35  
”r
;

38 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

39 "th»ad i ü—‹d: " 
NGX_TID_T_FMT
, *
tid
);

41 
Áh»ads
++;

43  
”r
;

44 
	}
}

47 
ngx_št_t


48 
	$ngx_š™_th»ads
(
n
, 
size_t
 
size
, 
ngx_cyþe_t
 *
cyþe
)

50 
”r
;

52 
max_th»ads
 = 
n
;

54 
”r
 = 
	`±h»ad_©Œ_š™
(&
thr_©Œ
);

56 ià(
”r
 != 0) {

57 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

59  
NGX_ERROR
;

62 
”r
 = 
	`±h»ad_©Œ_£t¡acksize
(&
thr_©Œ
, 
size
);

64 ià(
”r
 != 0) {

65 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cyþe
->
log
, 
”r
,

67  
NGX_ERROR
;

70 
ngx_th»aded
 = 1;

72  
NGX_OK
;

73 
	}
}

76 
ngx_mu‹x_t
 *

77 
	$ngx_mu‹x_š™
(
ngx_log_t
 *
log
, 
ngx_ušt_t
 
æags
)

79 
”r
;

80 
ngx_mu‹x_t
 *
m
;

82 
m
 = 
	`ngx_®loc
((
ngx_mu‹x_t
), 
log
);

83 ià(
m
 =ð
NULL
) {

84  
NULL
;

87 
m
->
log
 =†og;

89 
”r
 = 
	`±h»ad_mu‹x_š™
(&
m
->
mu‹x
, 
NULL
);

91 ià(
”r
 != 0) {

92 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
”r
,

94  
NULL
;

97  
m
;

98 
	}
}

102 
	$ngx_mu‹x_de¡roy
(
ngx_mu‹x_t
 *
m
)

104 
”r
;

106 
”r
 = 
	`±h»ad_mu‹x_de¡roy
(&
m
->
mu‹x
);

108 ià(
”r
 != 0) {

109 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
”r
,

110 "±h»ad_mu‹x_de¡roy(%pèçžed", 
m
);

113 
	`ngx_ä“
(
m
);

114 
	}
}

118 
	$ngx_mu‹x_lock
(
ngx_mu‹x_t
 *
m
)

120 
”r
;

122 ià(!
ngx_th»aded
) {

126 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0, "lock mutex %p", m);

128 
”r
 = 
	`±h»ad_mu‹x_lock
(&
m
->
mu‹x
);

130 ià(
”r
 != 0) {

131 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
”r
,

132 "±h»ad_mu‹x_lock(%pèçžed", 
m
);

133 
	`ngx_abÜt
();

136 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0, "mutex %p is†ocked", m);

139 
	}
}

142 
ngx_št_t


143 
	$ngx_mu‹x_Œylock
(
ngx_mu‹x_t
 *
m
)

145 
”r
;

147 ià(!
ngx_th»aded
) {

148  
NGX_OK
;

151 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0, "try†ock mutex %p", m);

153 
”r
 = 
	`±h»ad_mu‹x_Œylock
(&
m
->
mu‹x
);

155 ià(
”r
 =ð
NGX_EBUSY
) {

156  
NGX_AGAIN
;

159 ià(
”r
 != 0) {

160 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
”r
,

161 "±h»ad_mu‹x_Œylock(%pèçžed", 
m
);

162 
	`ngx_abÜt
();

165 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0, "mutex %p is†ocked", m);

167  
NGX_OK
;

168 
	}
}

172 
	$ngx_mu‹x_uÆock
(
ngx_mu‹x_t
 *
m
)

174 
”r
;

176 ià(!
ngx_th»aded
) {

180 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0, "unlock mutex %p", m);

182 
”r
 = 
	`±h»ad_mu‹x_uÆock
(&
m
->
mu‹x
);

184 ià(
”r
 != 0) {

185 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
m
->
log
, 
”r
,

186 "±h»ad_mu‹x_uÆock(%pèçžed", 
m
);

187 
	`ngx_abÜt
();

190 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0, "mutex %p is unlocked", m);

193 
	}
}

196 
ngx_cÚd_t
 *

197 
	$ngx_cÚd_š™
(
ngx_log_t
 *
log
)

199 
”r
;

200 
ngx_cÚd_t
 *
cv
;

202 
cv
 = 
	`ngx_®loc
((
ngx_cÚd_t
), 
log
);

203 ià(
cv
 =ð
NULL
) {

204  
NULL
;

207 
cv
->
log
 =†og;

209 
”r
 = 
	`±h»ad_cÚd_š™
(&
cv
->
cÚd
, 
NULL
);

211 ià(
”r
 != 0) {

212 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 
”r
,

214  
NULL
;

217  
cv
;

218 
	}
}

222 
	$ngx_cÚd_de¡roy
(
ngx_cÚd_t
 *
cv
)

224 
”r
;

226 
”r
 = 
	`±h»ad_cÚd_de¡roy
(&
cv
->
cÚd
);

228 ià(
”r
 != 0) {

229 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 
”r
,

230 "±h»ad_cÚd_de¡roy(%pèçžed", 
cv
);

233 
	`ngx_ä“
(
cv
);

234 
	}
}

237 
ngx_št_t


238 
	$ngx_cÚd_wa™
(
ngx_cÚd_t
 *
cv
, 
ngx_mu‹x_t
 *
m
)

240 
”r
;

242 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0, "cv %p wait", cv);

244 
”r
 = 
	`±h»ad_cÚd_wa™
(&
cv
->
cÚd
, &
m
->
mu‹x
);

246 ià(
”r
 != 0) {

247 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 
”r
,

248 "±h»ad_cÚd_wa™(%pèçžed", 
cv
);

249  
NGX_ERROR
;

252 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0, "cv %p is waked up", cv);

254 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MUTEX
, 
m
->
log
, 0, "mutex %p is†ocked", m);

256  
NGX_OK
;

257 
	}
}

260 
ngx_št_t


261 
	$ngx_cÚd_sigÇl
(
ngx_cÚd_t
 *
cv
)

263 
”r
;

265 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0, "cv %po signal", cv);

267 
”r
 = 
	`±h»ad_cÚd_sigÇl
(&
cv
->
cÚd
);

269 ià(
”r
 != 0) {

270 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
cv
->
log
, 
”r
,

271 "±h»ad_cÚd_sigÇl(%pèçžed", 
cv
);

272  
NGX_ERROR
;

275 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cv
->
log
, 0, "cv %p is signaled", cv);

277  
NGX_OK
;

278 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_readv_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ssize_t


14 
	$ngx_»adv_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
chaš
, 
off_t
 
lim™
)

16 
u_ch¬
 *
´ev
;

17 
ssize_t
 
n
, 
size
;

18 
ngx_”r_t
 
”r
;

19 
ngx_¬¿y_t
 
vec
;

20 
ngx_ev’t_t
 *
»v
;

21 
iovec
 *
iov
, 
iovs
[
NGX_IOVS_PREALLOCATE
];

23 
»v
 = 
c
->
»ad
;

25 #ià(
NGX_HAVE_KQUEUE
)

27 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

28 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

30 
»v
->
³ndšg_eof
,„ev->
avažabË
,„ev->
kq_”ºo
);

32 ià(
»v
->
avažabË
 == 0) {

33 ià(
»v
->
³ndšg_eof
) {

34 
»v
->
»ady
 = 0;

35 
»v
->
eof
 = 1;

37 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
»v
->
kq_”ºo
,

40 ià(
»v
->
kq_”ºo
) {

41 
»v
->
”rÜ
 = 1;

42 
	`ngx_£t_sock‘_”ºo
(
»v
->
kq_”ºo
);

43  
NGX_ERROR
;

49  
NGX_AGAIN
;

56 
´ev
 = 
NULL
;

57 
iov
 = 
NULL
;

58 
size
 = 0;

60 
vec
.
–ts
 = 
iovs
;

61 
vec
.
ÃÉs
 = 0;

62 
vec
.
size
 = (
iovec
);

63 
vec
.
ÇÎoc
 = 
NGX_IOVS_PREALLOCATE
;

64 
vec
.
poÞ
 = 
c
->pool;

68 
chaš
) {

69 
n
 = 
chaš
->
buf
->
’d
 - chaš->buf->
Ï¡
;

71 ià(
lim™
) {

72 ià(
size
 >ð
lim™
) {

76 ià(
size
 + 
n
 > 
lim™
) {

77 
n
 = (
ssize_t
è(
lim™
 - 
size
);

81 ià(
´ev
 =ð
chaš
->
buf
->
Ï¡
) {

82 
iov
->
iov_Ën
 +ð
n
;

85 ià(
vec
.
ÃÉs
 >ð
IOV_MAX
) {

89 
iov
 = 
	`ngx_¬¿y_push
(&
vec
);

90 ià(
iov
 =ð
NULL
) {

91  
NGX_ERROR
;

94 
iov
->
iov_ba£
 = (*è
chaš
->
buf
->
Ï¡
;

95 
iov
->
iov_Ën
 = 
n
;

98 
size
 +ð
n
;

99 
´ev
 = 
chaš
->
buf
->
’d
;

100 
chaš
 = chaš->
Ãxt
;

103 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

104 "»adv: %d,†a¡:%d", 
vec
.
ÃÉs
, 
iov
->
iov_Ën
);

107 
n
 = 
	`»adv
(
c
->
fd
, (
iovec
 *è
vec
.
–ts
, vec.
ÃÉs
);

109 ià(
n
 >= 0) {

111 #ià(
NGX_HAVE_KQUEUE
)

113 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

114 
»v
->
avažabË
 -ð
n
;

121 ià(
»v
->
avažabË
 <= 0) {

122 ià(!
»v
->
³ndšg_eof
) {

123 
»v
->
»ady
 = 0;

126 ià(
»v
->
avažabË
 < 0) {

127 
»v
->
avažabË
 = 0;

131 ià(
n
 == 0) {

139 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

141 "%d‡važabË by‹s", 
»v
->
avažabË
);

144 
»v
->
»ady
 = 0;

145 
»v
->
eof
 = 1;

146 
»v
->
avažabË
 = 0;

149  
n
;

154 ià(
n
 < 
size
 && !(
ngx_ev’t_æags
 & 
NGX_USE_GREEDY_EVENT
)) {

155 
»v
->
»ady
 = 0;

158 ià(
n
 == 0) {

159 
»v
->
eof
 = 1;

162  
n
;

165 
”r
 = 
ngx_sock‘_”ºo
;

167 ià(
”r
 =ð
NGX_EAGAIN
 ||ƒ¼ =ð
NGX_EINTR
) {

168 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

170 
n
 = 
NGX_AGAIN
;

173 
n
 = 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "readv() failed");

177 } 
”r
 =ð
NGX_EINTR
);

179 
»v
->
»ady
 = 0;

181 ià(
n
 =ð
NGX_ERROR
) {

182 
c
->
»ad
->
”rÜ
 = 1;

185  
n
;

186 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_recv.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 #ià(
NGX_HAVE_KQUEUE
)

15 
ssize_t


16 
	$ngx_unix_»cv
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, 
size_t
 
size
)

18 
ssize_t
 
n
;

19 
ngx_”r_t
 
”r
;

20 
ngx_ev’t_t
 *
»v
;

22 
»v
 = 
c
->
»ad
;

24 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

25 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

27 
»v
->
³ndšg_eof
,„ev->
avažabË
,„ev->
kq_”ºo
);

29 ià(
»v
->
avažabË
 == 0) {

30 ià(
»v
->
³ndšg_eof
) {

31 
»v
->
»ady
 = 0;

32 
»v
->
eof
 = 1;

34 ià(
»v
->
kq_”ºo
) {

35 
»v
->
”rÜ
 = 1;

36 
	`ngx_£t_sock‘_”ºo
(
»v
->
kq_”ºo
);

38  
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
»v
->
kq_”ºo
,

45 
»v
->
»ady
 = 0;

46  
NGX_AGAIN
;

52 
n
 = 
	`»cv
(
c
->
fd
, 
buf
, 
size
, 0);

54 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

55 "»cv: fd:%d %d oà%d", 
c
->
fd
, 
n
, 
size
);

57 ià(
n
 >= 0) {

58 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

59 
»v
->
avažabË
 -ð
n
;

66 ià(
»v
->
avažabË
 <= 0) {

67 ià(!
»v
->
³ndšg_eof
) {

68 
»v
->
»ady
 = 0;

71 ià(
»v
->
avažabË
 < 0) {

72 
»v
->
avažabË
 = 0;

76 ià(
n
 == 0) {

83 
»v
->
»ady
 = 0;

84 
»v
->
eof
 = 1;

85 
»v
->
avažabË
 = 0;

88  
n
;

91 ià((
size_t
è
n
 < 
size


92 && !(
ngx_ev’t_æags
 & 
NGX_USE_GREEDY_EVENT
))

94 
»v
->
»ady
 = 0;

97 ià(
n
 == 0) {

98 
»v
->
eof
 = 1;

101  
n
;

104 
”r
 = 
ngx_sock‘_”ºo
;

106 ià(
”r
 =ð
NGX_EAGAIN
 ||ƒ¼ =ð
NGX_EINTR
) {

107 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

109 
n
 = 
NGX_AGAIN
;

112 
n
 = 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "recv() failed");

116 } 
”r
 =ð
NGX_EINTR
);

118 
»v
->
»ady
 = 0;

120 ià(
n
 =ð
NGX_ERROR
) {

121 
»v
->
”rÜ
 = 1;

124  
n
;

125 
	}
}

129 
ssize_t


130 
	$ngx_unix_»cv
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, 
size_t
 
size
)

132 
ssize_t
 
n
;

133 
ngx_”r_t
 
”r
;

134 
ngx_ev’t_t
 *
»v
;

136 
»v
 = 
c
->
»ad
;

139 
n
 = 
	`»cv
(
c
->
fd
, 
buf
, 
size
, 0);

141 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

142 "»cv: fd:%d %d oà%d", 
c
->
fd
, 
n
, 
size
);

144 ià(
n
 == 0) {

145 
»v
->
»ady
 = 0;

146 
»v
->
eof
 = 1;

147  
n
;

149 } ià(
n
 > 0) {

151 ià((
size_t
è
n
 < 
size


152 && !(
ngx_ev’t_æags
 & 
NGX_USE_GREEDY_EVENT
))

154 
»v
->
»ady
 = 0;

157  
n
;

160 
”r
 = 
ngx_sock‘_”ºo
;

162 ià(
”r
 =ð
NGX_EAGAIN
 ||ƒ¼ =ð
NGX_EINTR
) {

163 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

165 
n
 = 
NGX_AGAIN
;

168 
n
 = 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "recv() failed");

172 } 
”r
 =ð
NGX_EINTR
);

174 
»v
->
»ady
 = 0;

176 ià(
n
 =ð
NGX_ERROR
) {

177 
»v
->
”rÜ
 = 1;

180  
n
;

181 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_send.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ssize_t


14 
	$ngx_unix_£nd
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, 
size_t
 
size
)

16 
ssize_t
 
n
;

17 
ngx_”r_t
 
”r
;

18 
ngx_ev’t_t
 *
wev
;

20 
wev
 = 
c
->
wr™e
;

22 #ià(
NGX_HAVE_KQUEUE
)

24 ià((
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
è&& 
wev
->
³ndšg_eof
) {

25 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
wev
->
kq_”ºo
,

27 
wev
->
”rÜ
 = 1;

28  
NGX_ERROR
;

34 
n
 = 
	`£nd
(
c
->
fd
, 
buf
, 
size
, 0);

36 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

37 "£nd: fd:%d %d oà%d", 
c
->
fd
, 
n
, 
size
);

39 ià(
n
 > 0) {

40 ià(
n
 < (
ssize_t
è
size
) {

41 
wev
->
»ady
 = 0;

44 
c
->
£Á
 +ð
n
;

46  
n
;

49 
”r
 = 
ngx_sock‘_”ºo
;

51 ià(
n
 == 0) {

52 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 
”r
, "send()„eturned zero");

53 
wev
->
»ady
 = 0;

54  
n
;

57 ià(
”r
 =ð
NGX_EAGAIN
 ||ƒ¼ =ð
NGX_EINTR
) {

58 
wev
->
»ady
 = 0;

60 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

63 ià(
”r
 =ð
NGX_EAGAIN
) {

64  
NGX_AGAIN
;

68 
wev
->
”rÜ
 = 1;

69 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "send() failed");

70  
NGX_ERROR
;

73 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_setaffinity.c

7 
	~<ngx_cÚfig.h
>

8 
	~<ngx_cÜe.h
>

11 #ià(
NGX_HAVE_CPUSET_SETAFFINITY
)

13 
	~<sys/ýu£t.h
>

16 
	$ngx_£ffš™y
(
ušt64_t
 
ýu_affš™y
, 
ngx_log_t
 *
log
)

18 
ýu£t_t
 
mask
;

19 
ngx_ušt_t
 
i
;

21 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0,

22 "ýu£t_£ffš™y(0x%08Xl)", 
ýu_affš™y
);

24 
	`CPU_ZERO
(&
mask
);

25 
i
 = 0;

27 ià(
ýu_affš™y
 & 1) {

28 
	`CPU_SET
(
i
, &
mask
);

30 
i
++;

31 
ýu_affš™y
 >>= 1;

32 } 
ýu_affš™y
);

34 ià(
	`ýu£t_£ffš™y
(
CPU_LEVEL_WHICH
, 
CPU_WHICH_PID
, -1,

35 (
ýu£t_t
), &
mask
) == -1)

37 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

40 
	}
}

42 #–ià(
NGX_HAVE_SCHED_SETAFFINITY
)

45 
	$ngx_£ffš™y
(
ušt64_t
 
ýu_affš™y
, 
ngx_log_t
 *
log
)

47 
ýu_£t_t
 
mask
;

48 
ngx_ušt_t
 
i
;

50 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0,

51 "sched_£ffš™y(0x%08Xl)", 
ýu_affš™y
);

53 
	`CPU_ZERO
(&
mask
);

54 
i
 = 0;

56 ià(
ýu_affš™y
 & 1) {

57 
	`CPU_SET
(
i
, &
mask
);

59 
i
++;

60 
ýu_affš™y
 >>= 1;

61 } 
ýu_affš™y
);

63 ià(
	`sched_£ffš™y
(0, (
ýu_£t_t
), &
mask
) == -1) {

64 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

67 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_setproctitle.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 #ià(
NGX_SETPROCTITLE_USES_ENV
)

30 **
’vœÚ
;

32 *
	gngx_os_¬gv_Ï¡
;

34 
ngx_št_t


35 
	$ngx_š™_£roù™Ë
(
ngx_log_t
 *
log
)

37 
u_ch¬
 *
p
;

38 
size_t
 
size
;

39 
ngx_ušt_t
 
i
;

41 
size
 = 0;

43 
i
 = 0; 
’vœÚ
[i]; i++) {

44 
size
 +ð
	`ngx_¡¾’
(
’vœÚ
[
i
]) + 1;

47 
p
 = 
	`ngx_®loc
(
size
, 
log
);

48 ià(
p
 =ð
NULL
) {

49  
NGX_ERROR
;

52 
ngx_os_¬gv_Ï¡
 = 
ngx_os_¬gv
[0];

54 
i
 = 0; 
ngx_os_¬gv
[i]; i++) {

55 ià(
ngx_os_¬gv_Ï¡
 =ð
ngx_os_¬gv
[
i
]) {

56 
ngx_os_¬gv_Ï¡
 = 
ngx_os_¬gv
[
i
] + 
	`ngx_¡¾’
(ngx_os_argv[i]) + 1;

60 
i
 = 0; 
’vœÚ
[i]; i++) {

61 ià(
ngx_os_¬gv_Ï¡
 =ð
’vœÚ
[
i
]) {

63 
size
 = 
	`ngx_¡¾’
(
’vœÚ
[
i
]) + 1;

64 
ngx_os_¬gv_Ï¡
 = 
’vœÚ
[
i
] + 
size
;

66 
	`ngx_ýy¡º
(
p
, (
u_ch¬
 *è
’vœÚ
[
i
], 
size
);

67 
’vœÚ
[
i
] = (*è
p
;

68 
p
 +ð
size
;

72 
ngx_os_¬gv_Ï¡
--;

74  
NGX_OK
;

75 
	}
}

79 
	$ngx_£roù™Ë
(*
t™Ë
)

81 
u_ch¬
 *
p
;

83 #ià(
NGX_SOLARIS
)

85 
ngx_št_t
 
i
;

86 
size_t
 
size
;

90 
ngx_os_¬gv
[1] = 
NULL
;

92 
p
 = 
	`ngx_ýy¡º
((
u_ch¬
 *è
ngx_os_¬gv
[0], (u_char *) "nginx: ",

93 
ngx_os_¬gv_Ï¡
 - 
ngx_os_¬gv
[0]);

95 
p
 = 
	`ngx_ýy¡º
Õ, (
u_ch¬
 *è
t™Ë
, 
ngx_os_¬gv_Ï¡
 - (*)…);

97 #ià(
NGX_SOLARIS
)

99 
size
 = 0;

101 
i
 = 0; i < 
ngx_¬gc
; i++) {

102 
size
 +ð
	`ngx_¡¾’
(
ngx_¬gv
[
i
]) + 1;

105 ià(
size
 > (
size_t
è((*è
p
 - 
ngx_os_¬gv
[0])) {

112 
p
 = 
	`ngx_ýy¡º
Õ, (
u_ch¬
 *è" (", 
ngx_os_¬gv_Ï¡
 - (*)…);

114 
i
 = 0; i < 
ngx_¬gc
; i++) {

115 
p
 = 
	`ngx_ýy¡º
Õ, (
u_ch¬
 *è
ngx_¬gv
[
i
],

116 
ngx_os_¬gv_Ï¡
 - (*è
p
);

117 
p
 = 
	`ngx_ýy¡º
Õ, (
u_ch¬
 *è" ", 
ngx_os_¬gv_Ï¡
 - (*)…);

120 ià(*(
p
 - 1) == ' ') {

121 *(
p
 - 1) = ')';

127 ià(
ngx_os_¬gv_Ï¡
 - (*è
p
) {

128 
	`ngx_mem£t
(
p
, 
NGX_SETPROCTITLE_PAD
, 
ngx_os_¬gv_Ï¡
 - (*)…);

131 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ngx_cyþe
->
log
, 0,

132 "£roù™Ë: \"%s\"", 
ngx_os_¬gv
[0]);

133 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_shmem.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 #ià(
NGX_HAVE_MAP_ANON
)

14 
ngx_št_t


15 
	$ngx_shm_®loc
(
ngx_shm_t
 *
shm
)

17 
shm
->
addr
 = (
u_ch¬
 *è
	`mm­
(
NULL
, shm->
size
,

18 
PROT_READ
|
PROT_WRITE
,

19 
MAP_ANON
|
MAP_SHARED
, -1, 0);

21 ià(
shm
->
addr
 =ð
MAP_FAILED
) {

22 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

23 "mm­(MAP_ANON|MAP_SHARED, %uzèçžed", 
shm
->
size
);

24  
NGX_ERROR
;

27  
NGX_OK
;

28 
	}
}

32 
	$ngx_shm_ä“
(
ngx_shm_t
 *
shm
)

34 ià(
	`munm­
((*è
shm
->
addr
, shm->
size
) == -1) {

35 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

36 "munm­(%p, %uzèçžed", 
shm
->
addr
, shm->
size
);

38 
	}
}

40 #–ià(
NGX_HAVE_MAP_DEVZERO
)

42 
ngx_št_t


43 
	$ngx_shm_®loc
(
ngx_shm_t
 *
shm
)

45 
ngx_fd_t
 
fd
;

47 
fd
 = 
	`Ý’
("/dev/z”o", 
O_RDWR
);

49 ià(
fd
 == -1) {

50 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

52  
NGX_ERROR
;

55 
shm
->
addr
 = (
u_ch¬
 *è
	`mm­
(
NULL
, shm->
size
, 
PROT_READ
|
PROT_WRITE
,

56 
MAP_SHARED
, 
fd
, 0);

58 ià(
shm
->
addr
 =ð
MAP_FAILED
) {

59 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

60 "mm­(/dev/z”o, MAP_SHARED, %uzèçžed", 
shm
->
size
);

63 ià(
	`þo£
(
fd
) == -1) {

64 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

68  (
shm
->
addr
 =ð
MAP_FAILED
è? 
NGX_ERROR
 : 
NGX_OK
;

69 
	}
}

73 
	$ngx_shm_ä“
(
ngx_shm_t
 *
shm
)

75 ià(
	`munm­
((*è
shm
->
addr
, shm->
size
) == -1) {

76 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

77 "munm­(%p, %uzèçžed", 
shm
->
addr
, shm->
size
);

79 
	}
}

81 #–ià(
NGX_HAVE_SYSVSHM
)

83 
	~<sys/c.h
>

84 
	~<sys/shm.h
>

87 
ngx_št_t


88 
	$ngx_shm_®loc
(
ngx_shm_t
 *
shm
)

90 
id
;

92 
id
 = 
	`shmg‘
(
IPC_PRIVATE
, 
shm
->
size
, (
SHM_R
|
SHM_W
|
IPC_CREAT
));

94 ià(
id
 == -1) {

95 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

96 "shmg‘(%uzèçžed", 
shm
->
size
);

97  
NGX_ERROR
;

100 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
shm
->
log
, 0, "shmg‘ id: %d", 
id
);

102 
shm
->
addr
 = 
	`shm©
(
id
, 
NULL
, 0);

104 ià(
shm
->
addr
 == (*) -1) {

105 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
, "shmat() failed");

108 ià(
	`shmùl
(
id
, 
IPC_RMID
, 
NULL
) == -1) {

109 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

113  (
shm
->
addr
 =ð(*è-1è? 
NGX_ERROR
 : 
NGX_OK
;

114 
	}
}

118 
	$ngx_shm_ä“
(
ngx_shm_t
 *
shm
)

120 ià(
	`shmdt
(
shm
->
addr
) == -1) {

121 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
shm
->
log
, 
ngx_”ºo
,

122 "shmdt(%pèçžed", 
shm
->
addr
);

124 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_socket.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

24 #ià(
NGX_HAVE_FIONBIO
)

27 
	$ngx_nÚblockšg
(
ngx_sock‘_t
 
s
)

29 
nb
;

31 
nb
 = 1;

33  
	`ioùl
(
s
, 
FIONBIO
, &
nb
);

34 
	}
}

38 
	$ngx_blockšg
(
ngx_sock‘_t
 
s
)

40 
nb
;

42 
nb
 = 0;

44  
	`ioùl
(
s
, 
FIONBIO
, &
nb
);

45 
	}
}

50 #ià(
NGX_FREEBSD
)

53 
	$ngx_tý_nÝush
(
ngx_sock‘_t
 
s
)

55 
tý_nÝush
;

57 
tý_nÝush
 = 1;

59  
	`£tsockÝt
(
s
, 
IPPROTO_TCP
, 
TCP_NOPUSH
,

60 (cÚ¡ *è&
tý_nÝush
, ());

61 
	}
}

65 
	$ngx_tý_push
(
ngx_sock‘_t
 
s
)

67 
tý_nÝush
;

69 
tý_nÝush
 = 0;

71  
	`£tsockÝt
(
s
, 
IPPROTO_TCP
, 
TCP_NOPUSH
,

72 (cÚ¡ *è&
tý_nÝush
, ());

73 
	}
}

75 #–ià(
NGX_LINUX
)

79 
	$ngx_tý_nÝush
(
ngx_sock‘_t
 
s
)

81 
cÜk
;

83 
cÜk
 = 1;

85  
	`£tsockÝt
(
s
, 
IPPROTO_TCP
, 
TCP_CORK
,

86 (cÚ¡ *è&
cÜk
, ());

87 
	}
}

91 
	$ngx_tý_push
(
ngx_sock‘_t
 
s
)

93 
cÜk
;

95 
cÜk
 = 0;

97  
	`£tsockÝt
(
s
, 
IPPROTO_TCP
, 
TCP_CORK
,

98 (cÚ¡ *è&
cÜk
, ());

99 
	}
}

104 
	$ngx_tý_nÝush
(
ngx_sock‘_t
 
s
)

107 
	}
}

111 
	$ngx_tý_push
(
ngx_sock‘_t
 
s
)

114 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_solaris_init.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

12 
	gngx_sÞ¬is_sy¢ame
[20];

13 
	gngx_sÞ¬is_»Ëa£
[10];

14 
	gngx_sÞ¬is_v”siÚ
[50];

17 
ngx_os_io_t
 
	gngx_sÞ¬is_io
 = {

18 
ngx_unix_»cv
,

19 
ngx_»adv_chaš
,

20 
ngx_udp_unix_»cv
,

21 
ngx_unix_£nd
,

22 #ià(
NGX_HAVE_SENDFILE
)

23 
ngx_sÞ¬is_£ndfžev_chaš
,

24 
NGX_IO_SENDFILE


26 
ngx_wr™ev_chaš
,

32 
ngx_št_t


33 
	$ngx_os_¥ecific_š™
(
ngx_log_t
 *
log
)

35 ià(
	`sysšfo
(
SI_SYSNAME
, 
ngx_sÞ¬is_sy¢ame
, (ngx_solaris_sysname))

38 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

40  
NGX_ERROR
;

43 ià(
	`sysšfo
(
SI_RELEASE
, 
ngx_sÞ¬is_»Ëa£
, (ngx_solaris_release))

46 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

48  
NGX_ERROR
;

51 ià(
	`sysšfo
(
SI_VERSION
, 
ngx_sÞ¬is_v”siÚ
, (ngx_solaris_version))

54 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 
ngx_”ºo
,

56  
NGX_ERROR
;

60 
ngx_os_io
 = 
ngx_sÞ¬is_io
;

62  
NGX_OK
;

63 
	}
}

67 
	$ngx_os_¥ecific_¡©us
(
ngx_log_t
 *
log
)

70 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "OS: %s %s",

71 
ngx_sÞ¬is_sy¢ame
, 
ngx_sÞ¬is_»Ëa£
);

73 
	`ngx_log_”rÜ
(
NGX_LOG_NOTICE
, 
log
, 0, "version: %s",

74 
ngx_sÞ¬is_v”siÚ
);

75 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_solaris_sendfilev_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 #ià(
NGX_TEST_BUILD_SOLARIS_SENDFILEV
)

17 
	s£ndfževec
 {

18 
	msfv_fd
;

19 
u_št
 
	msfv_æag
;

20 
off_t
 
	msfv_off
;

21 
size_t
 
	msfv_Ën
;

22 } 
	t£ndfževec_t
;

24 
	#SFV_FD_SELF
 -2

	)

26 
ssize_t
 
	$£ndfžev
(
fd
, cÚ¡ 
£ndfževec
 *
vec
,

27 
sfvút
, 
size_t
 *
xã¼ed
)

30 
	}
}

32 
ngx_chaš_t
 *
ngx_sÞ¬is_£ndfžev_chaš
(
ngx_cÚÃùiÚ_t
 *
c
,‚gx_chaš_ˆ*
š
,

33 
off_t
 
lim™
);

38 
	#NGX_SENDFILEVECS
 
NGX_IOVS_PREALLOCATE


	)

41 
ngx_chaš_t
 *

42 
	$ngx_sÞ¬is_£ndfžev_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
)

44 
fd
;

45 
u_ch¬
 *
´ev
;

46 
off_t
 
size
, 
£nd
, 
´ev_£nd
, 
®igÃd
, 
å»v
;

47 
size_t
 
£Á
;

48 
ssize_t
 
n
;

49 
ngx_št_t
 
ešŒ
;

50 
ngx_”r_t
 
”r
;

51 
ngx_ušt_t
 
nsfv
;

52 
£ndfževec_t
 *
sfv
, 
sfvs
[
NGX_SENDFILEVECS
];

53 
ngx_ev’t_t
 *
wev
;

54 
ngx_chaš_t
 *
þ
;

56 
wev
 = 
c
->
wr™e
;

58 ià(!
wev
->
»ady
) {

59  
š
;

62 ià(!
c
->
£ndfže
) {

63  
	`ngx_wr™ev_chaš
(
c
, 
š
, 
lim™
);

69 ià(
lim™
 =ð0 ||†im™ > (
off_t
è(
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
)) {

70 
lim™
 = 
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
;

74 
£nd
 = 0;

77 
fd
 = 
SFV_FD_SELF
;

78 
´ev
 = 
NULL
;

79 
å»v
 = 0;

80 
sfv
 = 
NULL
;

81 
ešŒ
 = 0;

82 
£Á
 = 0;

83 
´ev_£nd
 = 
£nd
;

85 
nsfv
 = 0;

89 
þ
 = 
š
; cÈ&& 
£nd
 < 
lim™
; cÈðþ->
Ãxt
) {

91 ià(
	`ngx_buf_¥ecŸl
(
þ
->
buf
)) {

95 ià(
	`ngx_buf_š_memÜy_Úly
(
þ
->
buf
)) {

96 
fd
 = 
SFV_FD_SELF
;

98 
size
 = 
þ
->
buf
->
Ï¡
 - cl->buf->
pos
;

100 ià(
£nd
 + 
size
 > 
lim™
) {

101 
size
 = 
lim™
 - 
£nd
;

104 ià(
´ev
 =ð
þ
->
buf
->
pos
) {

105 
sfv
->
sfv_Ën
 +ð(
size_t
è
size
;

108 ià(
nsfv
 =ð
NGX_SENDFILEVECS
) {

112 
sfv
 = &
sfvs
[
nsfv
++];

114 
sfv
->
sfv_fd
 = 
SFV_FD_SELF
;

115 
sfv
->
sfv_æag
 = 0;

116 
sfv
->
sfv_off
 = (
off_t
è(
ušŒ_t
è
þ
->
buf
->
pos
;

117 
sfv
->
sfv_Ën
 = (
size_t
è
size
;

120 
´ev
 = 
þ
->
buf
->
pos
 + (
size_t
è
size
;

121 
£nd
 +ð
size
;

124 
´ev
 = 
NULL
;

126 
size
 = 
þ
->
buf
->
fže_Ï¡
 - cl->buf->
fže_pos
;

128 ià(
£nd
 + 
size
 > 
lim™
) {

129 
size
 = 
lim™
 - 
£nd
;

131 
®igÃd
 = (
þ
->
buf
->
fže_pos
 + 
size
 + 
ngx_·gesize
 - 1)

132 & ~((
off_t
è
ngx_·gesize
 - 1);

134 ià(
®igÃd
 <ð
þ
->
buf
->
fže_Ï¡
) {

135 
size
 = 
®igÃd
 - 
þ
->
buf
->
fže_pos
;

139 ià(
fd
 =ð
þ
->
buf
->
fže
->fd && 
å»v
 =ðþ->buf->
fže_pos
) {

140 
sfv
->
sfv_Ën
 +ð(
size_t
è
size
;

143 ià(
nsfv
 =ð
NGX_SENDFILEVECS
) {

147 
sfv
 = &
sfvs
[
nsfv
++];

149 
fd
 = 
þ
->
buf
->
fže
->fd;

150 
sfv
->
sfv_fd
 = 
fd
;

151 
sfv
->
sfv_æag
 = 0;

152 
sfv
->
sfv_off
 = 
þ
->
buf
->
fže_pos
;

153 
sfv
->
sfv_Ën
 = (
size_t
è
size
;

156 
å»v
 = 
þ
->
buf
->
fže_pos
 + 
size
;

157 
£nd
 +ð
size
;

161 
n
 = 
	`£ndfžev
(
c
->
fd
, 
sfvs
, 
nsfv
, &
£Á
);

163 ià(
n
 == -1) {

164 
”r
 = 
ngx_”ºo
;

166 
”r
) {

167 
NGX_EAGAIN
:

170 
NGX_EINTR
:

171 
ešŒ
 = 1;

175 
wev
->
”rÜ
 = 1;

176 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "sendfilev() failed");

177  
NGX_CHAIN_ERROR
;

180 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

181 "£ndfžev(è£Á oÆy %uz by‹s", 
£Á
);

184 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

185 "£ndfžev: %z %z", 
n
, 
£Á
);

187 
c
->
£Á
 += sent;

189 
š
 = 
	`ngx_chaš_upd©e_£Á
(š, 
£Á
);

191 ià(
ešŒ
) {

192 
£nd
 = 
´ev_£nd
 + 
£Á
;

196 ià(
£nd
 - 
´ev_£nd
 !ð(
off_t
è
£Á
) {

197 
wev
->
»ady
 = 0;

198  
š
;

201 ià(
£nd
 >ð
lim™
 || 
š
 =ð
NULL
) {

202  
š
;

205 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_time.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

25 
	$ngx_timezÚe_upd©e
()

27 #ià(
NGX_FREEBSD
)

29 ià(
	`g‘’v
("TZ")) {

33 
	`pu‹nv
("TZ=UTC");

35 
	`tz£t
();

37 
	`un£‹nv
("TZ");

39 
	`tz£t
();

41 #–ià(
NGX_LINUX
)

42 
time_t
 
s
;

43 
tm
 *
t
;

44 
buf
[4];

46 
s
 = 
	`time
(0);

48 
t
 = 
	`loÿÉime
(&
s
);

50 
	`¡ráime
(
buf
, 4, "%H", 
t
);

53 
	}
}

57 
	$ngx_loÿÉime
(
time_t
 
s
, 
ngx_tm_t
 *
tm
)

59 #ià(
NGX_HAVE_LOCALTIME_R
)

60 (è
	`loÿÉime_r
(&
s
, 
tm
);

63 
ngx_tm_t
 *
t
;

65 
t
 = 
	`loÿÉime
(&
s
);

66 *
tm
 = *
t
;

70 
tm
->
ngx_tm_mÚ
++;

71 
tm
->
ngx_tm_y—r
 += 1900;

72 
	}
}

76 
	$ngx_libc_loÿÉime
(
time_t
 
s
, 
tm
 *tm)

78 #ià(
NGX_HAVE_LOCALTIME_R
)

79 (è
	`loÿÉime_r
(&
s
, 
tm
);

82 
tm
 *
t
;

84 
t
 = 
	`loÿÉime
(&
s
);

85 *
tm
 = *
t
;

88 
	}
}

92 
	$ngx_libc_gmtime
(
time_t
 
s
, 
tm
 *tm)

94 #ià(
NGX_HAVE_LOCALTIME_R
)

95 (è
	`gmtime_r
(&
s
, 
tm
);

98 
tm
 *
t
;

100 
t
 = 
	`gmtime
(&
s
);

101 *
tm
 = *
t
;

104 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_udp_recv.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 #ià(
NGX_HAVE_KQUEUE
)

15 
ssize_t


16 
	$ngx_udp_unix_»cv
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, 
size_t
 
size
)

18 
ssize_t
 
n
;

19 
ngx_”r_t
 
”r
;

20 
ngx_ev’t_t
 *
»v
;

22 
»v
 = 
c
->
»ad
;

25 
n
 = 
	`»cv
(
c
->
fd
, 
buf
, 
size
, 0);

27 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

28 "»cv: fd:%d %d oà%d", 
c
->
fd
, 
n
, 
size
);

30 ià(
n
 >= 0) {

31 ià(
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
) {

32 
»v
->
avažabË
 -ð
n
;

39 ià(
»v
->
avažabË
 <= 0) {

40 
»v
->
»ady
 = 0;

41 
»v
->
avažabË
 = 0;

45  
n
;

48 
”r
 = 
ngx_sock‘_”ºo
;

50 ià(
”r
 =ð
NGX_EAGAIN
 ||ƒ¼ =ð
NGX_EINTR
) {

51 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

53 
n
 = 
NGX_AGAIN
;

56 
n
 = 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "recv() failed");

60 } 
”r
 =ð
NGX_EINTR
);

62 
»v
->
»ady
 = 0;

64 ià(
n
 =ð
NGX_ERROR
) {

65 
»v
->
”rÜ
 = 1;

68  
n
;

69 
	}
}

73 
ssize_t


74 
	$ngx_udp_unix_»cv
(
ngx_cÚÃùiÚ_t
 *
c
, 
u_ch¬
 *
buf
, 
size_t
 
size
)

76 
ssize_t
 
n
;

77 
ngx_”r_t
 
”r
;

78 
ngx_ev’t_t
 *
»v
;

80 
»v
 = 
c
->
»ad
;

83 
n
 = 
	`»cv
(
c
->
fd
, 
buf
, 
size
, 0);

85 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

86 "»cv: fd:%d %d oà%d", 
c
->
fd
, 
n
, 
size
);

88 ià(
n
 >= 0) {

89  
n
;

92 
”r
 = 
ngx_sock‘_”ºo
;

94 ià(
”r
 =ð
NGX_EAGAIN
 ||ƒ¼ =ð
NGX_EINTR
) {

95 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

97 
n
 = 
NGX_AGAIN
;

100 
n
 = 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "recv() failed");

104 } 
”r
 =ð
NGX_EINTR
);

106 
»v
->
»ady
 = 0;

108 ià(
n
 =ð
NGX_ERROR
) {

109 
»v
->
”rÜ
 = 1;

112  
n
;

113 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_user.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

22 #ià(
NGX_CRYPT
)

24 #ià(
NGX_HAVE_GNU_CRYPT_R
)

26 
ngx_št_t


27 
	$ngx_libc_üy±
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
, u_ch¬ **
’üy±ed
)

29 *
v®ue
;

30 
size_t
 
Ën
;

31 
üy±_d©a
 
cd
;

33 
cd
.
š™Ÿlized
 = 0;

35 
cd
.
cu¼’t_§É
[0] = ~
§É
[0];

37 
v®ue
 = 
	`üy±_r
((*è
key
, (*è
§É
, &
cd
);

39 ià(
v®ue
) {

40 
Ën
 = 
	`ngx_¡¾’
(
v®ue
) + 1;

42 *
’üy±ed
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

43 ià(*
’üy±ed
 =ð
NULL
) {

44  
NGX_ERROR
;

47 
	`ngx_memýy
(*
’üy±ed
, 
v®ue
, 
Ën
);

48  
NGX_OK
;

51 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
poÞ
->
log
, 
ngx_”ºo
, "crypt_r() failed");

53  
NGX_ERROR
;

54 
	}
}

58 
ngx_št_t


59 
	$ngx_libc_üy±
(
ngx_poÞ_t
 *
poÞ
, 
u_ch¬
 *
key
, u_ch¬ *
§É
, u_ch¬ **
’üy±ed
)

61 *
v®ue
;

62 
size_t
 
Ën
;

63 
ngx_”r_t
 
”r
;

65 #ià(
NGX_THREADS
 && 
NGX_NONREENTRANT_CRYPT
)

69 ià(
	`ngx_mu‹x_Œylock
(
ngx_üy±_mu‹x
è!ð
NGX_OK
) {

70  
NGX_AGAIN
;

75 
v®ue
 = 
	`üy±
((*è
key
, (*è
§É
);

77 ià(
v®ue
) {

78 
Ën
 = 
	`ngx_¡¾’
(
v®ue
) + 1;

80 *
’üy±ed
 = 
	`ngx_²®loc
(
poÞ
, 
Ën
);

81 ià(*
’üy±ed
 =ð
NULL
) {

82 #ià(
NGX_THREADS
 && 
NGX_NONREENTRANT_CRYPT
)

83 
	`ngx_mu‹x_uÆock
(
ngx_üy±_mu‹x
);

85  
NGX_ERROR
;

88 
	`ngx_memýy
(*
’üy±ed
, 
v®ue
, 
Ën
);

89 #ià(
NGX_THREADS
 && 
NGX_NONREENTRANT_CRYPT
)

90 
	`ngx_mu‹x_uÆock
(
ngx_üy±_mu‹x
);

92  
NGX_OK
;

95 
”r
 = 
ngx_”ºo
;

97 #ià(
NGX_THREADS
 && 
NGX_NONREENTRANT_CRYPT
)

98 
	`ngx_mu‹x_uÆock
(
ngx_üy±_mu‹x
);

101 
	`ngx_log_”rÜ
(
NGX_LOG_CRIT
, 
poÞ
->
log
, 
”r
, "crypt() failed");

103  
NGX_ERROR
;

104 
	}
}

	@/home/wuhong/github/google/ngx_google/src/os/unix/ngx_writev_chain.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

13 
ngx_chaš_t
 *

14 
	$ngx_wr™ev_chaš
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_chaš_t
 *
š
, 
off_t
 
lim™
)

16 
ssize_t
 
n
, 
£Á
;

17 
off_t
 
£nd
, 
´ev_£nd
;

18 
ngx_chaš_t
 *
þ
;

19 
ngx_ev’t_t
 *
wev
;

20 
ngx_iovec_t
 
vec
;

21 
iovec
 
iovs
[
NGX_IOVS_PREALLOCATE
];

23 
wev
 = 
c
->
wr™e
;

25 ià(!
wev
->
»ady
) {

26  
š
;

29 #ià(
NGX_HAVE_KQUEUE
)

31 ià((
ngx_ev’t_æags
 & 
NGX_USE_KQUEUE_EVENT
è&& 
wev
->
³ndšg_eof
) {

32 (è
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
wev
->
kq_”ºo
,

34 
wev
->
”rÜ
 = 1;

35  
NGX_CHAIN_ERROR
;

42 ià(
lim™
 =ð0 ||†im™ > (
off_t
è(
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
)) {

43 
lim™
 = 
NGX_MAX_SIZE_T_VALUE
 - 
ngx_·gesize
;

46 
£nd
 = 0;

48 
vec
.
iovs
 = iovs;

49 
vec
.
ÇÎoc
 = 
NGX_IOVS_PREALLOCATE
;

52 
´ev_£nd
 = 
£nd
;

56 
þ
 = 
	`ngx_ouut_chaš_to_iovec
(&
vec
, 
š
, 
lim™
 - 
£nd
, 
c
->
log
);

58 ià(
þ
 =ð
NGX_CHAIN_ERROR
) {

59  
NGX_CHAIN_ERROR
;

62 ià(
þ
 && cl->
buf
->
š_fže
) {

63 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
c
->
log
, 0,

66 
þ
->
buf
->
‹mpÜ¬y
,

67 
þ
->
buf
->
»cyþed
,

68 
þ
->
buf
->
š_fže
,

69 
þ
->
buf
->
¡¬t
,

70 
þ
->
buf
->
pos
,

71 
þ
->
buf
->
Ï¡
,

72 
þ
->
buf
->
fže
,

73 
þ
->
buf
->
fže_pos
,

74 
þ
->
buf
->
fže_Ï¡
);

76 
	`ngx_debug_pošt
();

78  
NGX_CHAIN_ERROR
;

81 
£nd
 +ð
vec
.
size
;

83 
n
 = 
	`ngx_wr™ev
(
c
, &
vec
);

85 ià(
n
 =ð
NGX_ERROR
) {

86  
NGX_CHAIN_ERROR
;

89 
£Á
 = (
n
 =ð
NGX_AGAIN
) ? 0 :‚;

91 
c
->
£Á
 += sent;

93 
š
 = 
	`ngx_chaš_upd©e_£Á
(š, 
£Á
);

95 ià(
£nd
 - 
´ev_£nd
 !ð
£Á
) {

96 
wev
->
»ady
 = 0;

97  
š
;

100 ià(
£nd
 >ð
lim™
 || 
š
 =ð
NULL
) {

101  
š
;

104 
	}
}

107 
ngx_chaš_t
 *

108 
	$ngx_ouut_chaš_to_iovec
(
ngx_iovec_t
 *
vec
, 
ngx_chaš_t
 *
š
, 
size_t
 
lim™
,

109 
ngx_log_t
 *
log
)

111 
size_t
 
tÙ®
, 
size
;

112 
u_ch¬
 *
´ev
;

113 
ngx_ušt_t
 
n
;

114 
iovec
 *
iov
;

116 
iov
 = 
NULL
;

117 
´ev
 = 
NULL
;

118 
tÙ®
 = 0;

119 
n
 = 0;

121  ; 
š
 && 
tÙ®
 < 
lim™
; iÀðš->
Ãxt
) {

123 ià(
	`ngx_buf_¥ecŸl
(
š
->
buf
)) {

127 ià(
š
->
buf
->
š_fže
) {

131 ià(!
	`ngx_buf_š_memÜy
(
š
->
buf
)) {

132 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
log
, 0,

135 
š
->
buf
->
‹mpÜ¬y
,

136 
š
->
buf
->
»cyþed
,

137 
š
->
buf
->
š_fže
,

138 
š
->
buf
->
¡¬t
,

139 
š
->
buf
->
pos
,

140 
š
->
buf
->
Ï¡
,

141 
š
->
buf
->
fže
,

142 
š
->
buf
->
fže_pos
,

143 
š
->
buf
->
fže_Ï¡
);

145 
	`ngx_debug_pošt
();

147  
NGX_CHAIN_ERROR
;

150 
size
 = 
š
->
buf
->
Ï¡
 - in->buf->
pos
;

152 ià(
size
 > 
lim™
 - 
tÙ®
) {

153 
size
 = 
lim™
 - 
tÙ®
;

156 ià(
´ev
 =ð
š
->
buf
->
pos
) {

157 
iov
->
iov_Ën
 +ð
size
;

160 ià(
n
 =ð
vec
->
ÇÎoc
) {

164 
iov
 = &
vec
->
iovs
[
n
++];

166 
iov
->
iov_ba£
 = (*è
š
->
buf
->
pos
;

167 
iov
->
iov_Ën
 = 
size
;

170 
´ev
 = 
š
->
buf
->
pos
 + 
size
;

171 
tÙ®
 +ð
size
;

174 
vec
->
couÁ
 = 
n
;

175 
vec
->
size
 = 
tÙ®
;

177  
š
;

178 
	}
}

181 
ssize_t


182 
	$ngx_wr™ev
(
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_iovec_t
 *
vec
)

184 
ssize_t
 
n
;

185 
ngx_”r_t
 
”r
;

187 
ešŒ
:

189 
n
 = 
	`wr™ev
(
c
->
fd
, 
vec
->
iovs
, vec->
couÁ
);

191 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 0,

192 "wr™ev: %z oà%uz", 
n
, 
vec
->
size
);

194 ià(
n
 == -1) {

195 
”r
 = 
ngx_”ºo
;

197 
”r
) {

198 
NGX_EAGAIN
:

199 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

201  
NGX_AGAIN
;

203 
NGX_EINTR
:

204 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_EVENT
, 
c
->
log
, 
”r
,

206 
ešŒ
;

209 
c
->
wr™e
->
”rÜ
 = 1;

210 
	`ngx_cÚÃùiÚ_”rÜ
(
c
, 
”r
, "writev() failed");

211  
NGX_ERROR
;

215  
n
;

216 
	}
}

	@
1
.
0
175
12714
/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_filter_module.c
/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_inject.c
/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_request.c
/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_response.c
/home/wuhong/github/google/ngx_google/ngx_http_google_filter_module/src/ngx_http_google_util.c
/home/wuhong/github/google/ngx_google/src/core/nginx.c
/home/wuhong/github/google/ngx_google/src/core/ngx_array.c
/home/wuhong/github/google/ngx_google/src/core/ngx_buf.c
/home/wuhong/github/google/ngx_google/src/core/ngx_conf_file.c
/home/wuhong/github/google/ngx_google/src/core/ngx_connection.c
/home/wuhong/github/google/ngx_google/src/core/ngx_cpuinfo.c
/home/wuhong/github/google/ngx_google/src/core/ngx_crc32.c
/home/wuhong/github/google/ngx_google/src/core/ngx_crypt.c
/home/wuhong/github/google/ngx_google/src/core/ngx_cycle.c
/home/wuhong/github/google/ngx_google/src/core/ngx_file.c
/home/wuhong/github/google/ngx_google/src/core/ngx_hash.c
/home/wuhong/github/google/ngx_google/src/core/ngx_inet.c
/home/wuhong/github/google/ngx_google/src/core/ngx_list.c
/home/wuhong/github/google/ngx_google/src/core/ngx_log.c
/home/wuhong/github/google/ngx_google/src/core/ngx_md5.c
/home/wuhong/github/google/ngx_google/src/core/ngx_murmurhash.c
/home/wuhong/github/google/ngx_google/src/core/ngx_open_file_cache.c
/home/wuhong/github/google/ngx_google/src/core/ngx_output_chain.c
/home/wuhong/github/google/ngx_google/src/core/ngx_palloc.c
/home/wuhong/github/google/ngx_google/src/core/ngx_parse.c
/home/wuhong/github/google/ngx_google/src/core/ngx_proxy_protocol.c
/home/wuhong/github/google/ngx_google/src/core/ngx_queue.c
/home/wuhong/github/google/ngx_google/src/core/ngx_radix_tree.c
/home/wuhong/github/google/ngx_google/src/core/ngx_rbtree.c
/home/wuhong/github/google/ngx_google/src/core/ngx_regex.c
/home/wuhong/github/google/ngx_google/src/core/ngx_resolver.c
/home/wuhong/github/google/ngx_google/src/core/ngx_shmtx.c
/home/wuhong/github/google/ngx_google/src/core/ngx_slab.c
/home/wuhong/github/google/ngx_google/src/core/ngx_spinlock.c
/home/wuhong/github/google/ngx_google/src/core/ngx_string.c
/home/wuhong/github/google/ngx_google/src/core/ngx_syslog.c
/home/wuhong/github/google/ngx_google/src/core/ngx_times.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_aio_module.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_devpoll_module.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_epoll_module.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_eventport_module.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_kqueue_module.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_poll_module.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_rtsig_module.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_select_module.c
/home/wuhong/github/google/ngx_google/src/event/modules/ngx_win32_select_module.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_accept.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_busy_lock.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_connect.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_mutex.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_openssl.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_openssl_stapling.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_pipe.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_posted.c
/home/wuhong/github/google/ngx_google/src/event/ngx_event_timer.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_access_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_addition_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_auth_basic_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_auth_request_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_autoindex_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_browser_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_charset_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_chunked_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_dav_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_degradation_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_empty_gif_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_fastcgi_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_flv_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_geo_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_geoip_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_gunzip_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_gzip_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_gzip_static_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_headers_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_image_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_index_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_limit_conn_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_limit_req_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_log_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_map_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_memcached_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_mp4_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_not_modified_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_proxy_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_random_index_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_range_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_realip_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_referer_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_rewrite_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_scgi_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_secure_link_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_split_clients_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_ssi_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_ssl_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_static_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_stub_status_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_sub_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_upstream_hash_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_upstream_ip_hash_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_upstream_keepalive_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_upstream_least_conn_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_userid_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_uwsgi_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/ngx_http_xslt_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/modules/perl/ngx_http_perl_module.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_busy_lock.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_copy_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_core_module.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_file_cache.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_header_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_parse.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_parse_time.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_postpone_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_request.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_request_body.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_script.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_spdy.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_spdy_filter_module.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_spdy_module.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_special_response.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_upstream.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_upstream_round_robin.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_variables.c
/home/wuhong/github/google/ngx_google/src/http/ngx_http_write_filter_module.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_auth_http_module.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_core_module.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_handler.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_imap_handler.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_imap_module.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_parse.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_pop3_handler.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_pop3_module.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_proxy_module.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_smtp_handler.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_smtp_module.c
/home/wuhong/github/google/ngx_google/src/mail/ngx_mail_ssl_module.c
/home/wuhong/github/google/ngx_google/src/misc/ngx_google_perftools_module.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_aio_read.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_aio_read_chain.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_aio_write.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_aio_write_chain.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_alloc.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_channel.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_daemon.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_darwin_init.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_darwin_sendfile_chain.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_errno.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_file_aio_read.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_files.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_freebsd_init.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_freebsd_rfork_thread.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_freebsd_sendfile_chain.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_linux_aio_read.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_linux_init.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_linux_sendfile_chain.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_posix_init.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_process.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_process_cycle.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_pthread_thread.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_readv_chain.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_recv.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_send.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_setaffinity.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_setproctitle.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_shmem.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_socket.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_solaris_init.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_solaris_sendfilev_chain.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_time.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_udp_recv.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_user.c
/home/wuhong/github/google/ngx_google/src/os/unix/ngx_writev_chain.c
